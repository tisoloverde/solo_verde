//Recarga
if(window.location.href == '#/home'){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
}
$(window).on("load",function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $('body').on('show.bs.modal', function() {
    $('.modal-body').overlayScrollbars({
  	  className: "os-theme-round-dark",
      autoUpdate: true,
      overflowBehavior: {
        x: 'hidden'
      },
      resize: "none",
      scrollbars: {
        autoHide: "never"
      }
  	});
    if($("#modalCaratulaObras").is(':visible') == false){
      setTimeout(function(){
        $(".os-viewport.os-viewport-native-scrollbars-invisible").scrollTop(0,0);
      },200);
    }
  });
  $('body').on('hidden.bs.modal',function(){
    $('#contenido').overlayScrollbars({
      className: "os-theme-round-dark",
      autoUpdate: true,
      nativeScrollbarsOverlaid : {
        showNativeScrollbars   : false,
        initialize             : true
      },
      overflowBehavior: {
        x: 'hidden',
        y : "scroll"
      },
      resize: "none",
      scrollbars: {
        autoHide: "never",
        touchSupport: true,
      }
    });
  });
  $(document).bind("click keydown keyup mousemove", function() {
    tiempo2 = moment(new Date());
    if(tiempo2.diff(moment(localStorage['tokenTime']), 'seconds') > 20){
      // console.log("vuelta");
      // console.log(localStorage['tokenTime']);
      // console.log(tiempo2);
      localStorage['tokenTime'] = tiempo2;
    }
	});
  document.addEventListener('touchstart', function(event){
  //Comprobamos si hay varios eventos del mismo tipo
    if (event.targetTouches.length == 1) {
    var touch = event.targetTouches[0];
    // con esto solo se procesa UN evento touch
      tiempo2 = moment(new Date());
      if(tiempo2.diff(moment(localStorage['tokenTime']), 'seconds') > 20){
        //console.log("vuelta");
        // console.log(localStorage['tokenTime']);
        // console.log(tiempo2);
        localStorage['tokenTime'] = tiempo2;
      }
    }
  });
  $.ajax({
      url:   'controller/checkToken.php',
      type:  'post',
      success: function (response) {
        if(response === 'TOKEN_NO'){
          localStorage.clear();
          $(".contenedor-logos").css("display","none");
          $(".contenedor-logos").find('li').css("display","none");
          window.location.href = "#/home";
          $("#logoLinkWeb").hide();
          $("#logoMenu").hide();
          $("#lineaMenu").hide();
          $("#iconoLogoMenu").attr("class","imgMenu fas fas fa-bars");
          $("#menu-lateral").css("width","37px");
          $("#menu-lateral").css("background","rgba(30, 0, 0, 0.0)");
          $("#logoMenu").css("color","black");
          $("#iconoLogoMenu").css("border","1px solid #b5b5b5");
          $("#iconoLogoMenu").css("background","rgba(255, 255, 255, 1.0)");
          $("#DivPrincipalMenu").empty();
        }
        else{
          localStorage['tokenTime'] = moment(new Date());
          var path = window.location.href.split('#/')[1];
          var parametros = {
            "path": path
          }
          if(path !== "login"){
            $.ajax({
                url:   'controller/datosRefresh.php',
                type:  'post',
                success: async function (response) {
                  var p = jQuery.parseJSON(response);
                  var size = Object.size(p.aaData)/2;
                  if(size > 0){
                    if(p.aaData['ESTADO'] === 'Activo'){
                      if($("#DivPrincipalMenu").children().length <= 0){
                        await $.ajax({
                          url:   'controller/datosAreasComunesPadresSolo.php',
                          type:  'post',
                          success: function (response2) {
                            var p2 = jQuery.parseJSON(response2);
                            if(p2.aaData.length !== 0){
                              for(var i = 0; i < p2.aaData.length; i++){
                                var padre = "<div id='" + p2.aaData[i].PADRE + "' style='display:none;' class='contenedor-logos'><div class='logo'><span class='imgMenu " + p2.aaData[i].ICONOPADRE + "'></span></div><p class='title-menu'>" + p2.aaData[i].TEXTOPADRE + "</p></div>";

                                $("#DivPrincipalMenu").append(padre);

                                if(p2.aaData[i].PADRE === "liCuenta"){
                                  $("#" + p2.aaData[i].PADRE).append("<div class='sub-menu' style='display:none; color: white; font-size: 12px; margin-left: 15px; margin-bottom: 8px;'><div id='imgPerfil' class='div-sub-menu' style='margin-left: 5%; border: 2px solid black; width: 144px; min-width: 144px; max-width: 144px; 'margin-bottom: 10pt;'></div><div id='nombrePerfil' class='div-sub-menu' style='margin-left: 5%; font-weight: bold;'></div></div>");
                                  setTimeout(function(){
                                    $.ajax({
                                      url:   'controller/cargarImgPerfilSession.php',
                                      type:  'get',
                                      success: function (responseImg) {
                                        if(responseImg == "Sin datos"){
                                          $("#imgPerfil").append("<img style='width: 140px; min-width: 140px; max-width: 140px;' src='view/img/no_foto.jpg'>");
                                        }
                                        else{
                                          $("#imgPerfil").append("<img style='width: 140px; min-width: 140px; max-width: 140px;' src='controller/cargarImgPerfilSession.php'>");
                                        }
                                      }
                                    });
                                  },500);
                                }
                                // $('div[id $=' + p2.aaData[i].PADRE + ']').show();
                                // $('li[id $=' + p2.aaData[i].NOMBRE + ']').show();
                                // $('div[id $=' + p2.aaData[i].PADRE + ']').css("display","block");
                                // $('li[id $=' + p2.aaData[i].NOMBRE + ']').css("display","block");
                              }
                              var atras = "<div id='regresarMenu' style='display: none;' class='contenedor-logos'><div class='logo'><span class='imgMenu fas fa-arrow-circle-left'></span></div></div>";

                              $("#DivPrincipalMenu").append(atras);

                              $("#regresarMenu").hover(
                                function() {
                                  $("#regresarMenu").addClass("blink_me");
                                }, function() {
                                  $("#regresarMenu").removeClass("blink_me");
                                }
                              );
                            }
                          }
                        });
                        await $.ajax({
                          url:   'controller/datosAreasComunesPadres.php',
                          type:  'post',
                          success: function (response2) {
                            var p2 = jQuery.parseJSON(response2);
                            if(p2.aaData.length !== 0){
                              for(var i = 0; i < p2.aaData.length; i++){
                                var insert = 0;
                                if(p2.aaData[i].TEXTO === "Cambiar contraseña"){
                                    var hijo = "<div class='sub-menu' style='display: none; color: white;'><ul><li id='" + p2.aaData[i].NOMBRE + "' style='display: none;'><div class='div-sub-menu'><i class='imgMenu-sub " + p2.aaData[i].ICONO + "'></i><a href='" + p2.aaData[i].RUTA + "' class='title-menu-sub'>" + p2.aaData[i].TEXTO + "</a></div></li></ul></div>";
                                    insert = 1;
                                }
                                else if(p2.aaData[i].TEXTO === "Firma Documentos"){
                                  if(p.aaData['FIRMA_2FA'] === "1"){
                                      var hijo = "<div class='sub-menu' style='display: none; color: white;'><ul><li id='" + p2.aaData[i].NOMBRE + "' style='display: none;'><div class='div-sub-menu'><i class='imgMenu-sub " + p2.aaData[i].ICONO + "'></i><a href='" + p2.aaData[i].RUTA + "' class='title-menu-sub'>" + p2.aaData[i].TEXTO + "</a></div></li></ul></div>";
                                      insert = 1;
                                  }
                                  else{
                                    insert = 0;
                                  }
                                }
                                else{
                                  var hijo = "<div class='sub-menu' style='display: none; color: white;'><ul><li id='" + p2.aaData[i].NOMBRE + "' style='display: none;'><div class='div-sub-menu'><i class='imgMenu-sub " + p2.aaData[i].ICONO + "'></i><a href='" + p2.aaData[i].RUTA + "' class='title-menu-sub'>" + p2.aaData[i].TEXTO + "</a></div></li></ul></div>";
                                  insert = 1;
                                }

                                if(insert === 1){
                                  $("#" + p2.aaData[i].PADRE).append(hijo);
                                }
                              }
                              $(".contenedor-logos").css("display","none");
                              $(".contenedor-logos").find('li').css("display","none");
                              $("#sesionActiva").val("1");
                              $("#sesionActivaUso").val("0");
                              $("#logoMenu").show();
                              // window.location.href = "#/login";
                            }
                          }
                        });

                        n = p.aaData['NOMBRE'].split(" ");
                        if(n.length <= 3){
                          $("#nombrePerfil").html(p.aaData['NOMBRE']);
                        }
                        else{
                          $("#nombrePerfil").html(n[0] + ' ' + n[2] + ' ' + n[3]);
                        }

                        $("#menu-lateral").unbind('click').hover(function(){

                        },
                        function(){
                          $("div.sub-menu").parent().css("height", "45px");
                          $("div.sub-menu").parent().css("background","rgba(30, 0, 0, 0.0)");
                          $("div.sub-menu").hide();
                          $("div.sub-menu").parent().find("p").css("color", "white");
                        });

                        $(".title-menu-sub").unbind('click').hover(function(){
                          $(this).css("color", "yellow");
                        },
                        function(){
                          $(this).css("color", "white");
                        });

                        $(".contenedor-logos").unbind('click').hover(function(){
                          $(this).css({'cursor': 'pointer'});
                        });

                        $(".contenedor-logos").unbind('click').click(function(){
                          var a = $(this).find("p").css("color");

                          //Cierra todo
                          $("div.sub-menu").parent().css("height", "45px");
                          $("div.sub-menu").parent().css("background","rgba(30, 0, 0, 0.0)");
                          $("div.sub-menu").hide();
                          $("div.sub-menu").parent().find("p").css("color", "white");

                          $("#DivPrincipalMenu").children().css("display","none");

                          $(this).css("display","block");

                          $("#regresarMenu").css("display","block");

                          if(a !== "rgb(255, 255, 0)"){
                            //Abre el clickado
                            $(this).find("p").css("color", "yellow");
                            $(this).find("div.sub-menu").show();
                            var a = $(this).find('li[style*="block"]').length;
                            if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                              if($(this).attr("id") == 'liCuenta'){
                                a = (a+1)*28 + 30 + 150;
                              }
                              else{
                                a = a*28 + 30;
                              }
                            }
                            else{
                              if($(this).attr("id") == 'liCuenta'){
                                a = (a+1)*25 + 30 + 150;
                              }
                              else{
                                a = a*25 + 30;
                              }
                            }
                            $(this).css("height", a + "pt");
                            $(this).css("background-color","#004379");
                          }
                          else{
                            $("#DivPrincipalMenu").children().css("display","block");
                          }
                        });

                        $("#regresarMenu").unbind("click").click(function(){
                          $("div.sub-menu").parent().css("height", "45px");
                          $("div.sub-menu").parent().css("background","rgba(30, 0, 0, 0.0)");
                          $("div.sub-menu").hide();
                          $("div.sub-menu").parent().find("p").css("color", "white");
                          $("#DivPrincipalMenu").children().css("display","block");
                          $("#regresarMenu").css("display","none");
                        });

                        n = p.aaData['NOMBRE'].split(" ");
                        if(n.length <= 3){
                          $("#nombrePerfil").html(p.aaData['NOMBRE']);
                        }
                        else{
                          $("#nombrePerfil").html(n[0] + ' ' + n[2] + ' ' + n[3]);
                        }

                        $('#menu-lateral').show();
                        menuElegant();
                        $('#modalAlertasSplash').modal('hide');
                      }
                      else{
                        setTimeout(function(){
                          $('#menu-lateral').show();
                          menuElegant();
                          esconderMenu();
                          $('#modalAlertasSplash').modal('hide');
                        },5000);
                      }
                    }
                    else{
                      $(".contenedor-logos").css("display","none");
                      $(".contenedor-logos").find('li').css("display","none");
                      window.location.href = "#/home";
                      $("#logoLinkWeb").hide();
                      $("#logoMenu").hide();
                      $("#lineaMenu").hide();
                      $("#iconoLogoMenu").attr("class","imgMenu fas fas fa-bars");
                      $("#menu-lateral").css("width","37px");
                      $("#menu-lateral").css("background","rgba(30, 0, 0, 0.0)");
                      $("#logoMenu").css("color","black");
                      $("#iconoLogoMenu").css("border","1px solid #b5b5b5");
                      $("#iconoLogoMenu").css("background","rgba(255, 255, 255, 1.0)");
                      $("#DivPrincipalMenu").empty();
                    }
                  }
                  else{
                    $(".contenedor-logos").css("display","none");
                    $(".contenedor-logos").find('li').css("display","none");
                    window.location.href = "#/home";
                    $("#logoLinkWeb").hide();
                    $("#logoMenu").hide();
                    $("#lineaMenu").hide();
                    $("#iconoLogoMenu").attr("class","imgMenu fas fas fa-bars");
                    $("#menu-lateral").css("width","37px");
                    $("#menu-lateral").css("background","rgba(30, 0, 0, 0.0)");
                    $("#logoMenu").css("color","black");
                    $("#iconoLogoMenu").css("border","1px solid #b5b5b5");
                    $("#iconoLogoMenu").css("background","rgba(255, 255, 255, 1.0)");
                    $("#DivPrincipalMenu").empty();
                  }
                }
            });
          }
        }
      },
      complete: function(){
        // $('#contenido').show();
        // $('#footer').show();
        // $('#menu-lateral').show();
      }
  });
  setInterval(function(){
    $.ajax({
      url: 'controller/keepAlive.php',
      type: 'post',
      success: function (response){
      }
    });
  },600000);
  $.ajax({
    url:   'controller/datosRefresh.php',
    type:  'post',
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      var size = Object.size(p.aaData)/2;
      if(size > 0){
        if(p.aaData['ESTADO'] === 'Activo' && p.aaData['TIPO'] === 'COMUN'){
          setInterval(function(){
            // console.log("interval");
            tiempo2 = moment(new Date());
            if(tiempo2.diff(moment(localStorage['tokenTime']), 'seconds') > 300){
              // console.log("Desconectando Sistema");
              $.ajax({
                  url:   'controller/cerraSesion.php',
                  type:  'post',
                  success: function (response) {
                    clearInterval(lineaTiempo);
                    $(".modal").modal("hide");
                    $('.modal-backdrop').remove();
                    $(".contenedor-logos").css("display","none");
                    $(".contenedor-logos").find('li').css("display","none");
                    $("#sesionActiva").val("0");
                    $("#sesionActivaUso").val("0");
                    window.location.href = "#/home";
                    setTimeout(function(){
                      $("#cerradoInactivo").show();
                    },300);
                    $("#logoLinkWeb").hide();
                    $("#logoMenu").hide();
                    $("#lineaMenu").hide();
                    $("#iconoLogoMenu").attr("class","imgMenu fas fas fa-bars");
                    $("#menu-lateral").css("width","37px");
                    $("#menu-lateral").css("background","rgba(30, 0, 0, 0.0)");
                    $("#logoMenu").css("color","black");
                    $("#iconoLogoMenu").css("border","1px solid #b5b5b5");
                    $("#iconoLogoMenu").css("background","rgba(255, 255, 255, 1.0)");
                    $("#DivPrincipalMenu").empty();
                    localStorage.clear();
                    setTimeout(function(){
                      $("#modalAlertasSplash").modal("hide");
                    },5000);
                  }
              });
            }
            else{
              $.ajax({
                url:   'controller/cookie.php',
                type:  'post',
                success: function (response) {
                }
              });
            }
          },60000);
        }
      }
    }
  });

  setInterval(async function(){
    await $.ajax({
      url:   'controller/datosNotificacionesUsuario.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          for(var i = 0; i < p2.aaData.length; i++){
            var url = p2.aaData[i].URL;
            toastr.options = {
              "closeButton": true,
              "debug": false,
              "newestOnTop": false,
              "progressBar": true,
              "positionClass": "toast-top-right",
              "preventDuplicates": true,
              "onclick": false,
              // "onclick": function() {
              //   var random = Math.round(Math.random() * (1000000 - 1) + 1);
              //   window.location.href = "?idLog=" + random + url;
              // },
              "showDuration": "300",
              "hideDuration": "1000",
              "timeOut": "10000",
              "extendedTimeOut": "1000",
              "showEasing": "swing",
              "hideEasing": "linear",
              "showMethod": "slideDown",
              "hideMethod": "slideUp"
            }
            toastr["info"](p2.aaData[i].NOTIFICACION + "<br><br><i style='font-size: 8pt;'>Hora: " + p2.aaData[i].FECHA + " " + p2.aaData[i].HORA + "</i>");
          }
        }
      }
    });
  },300000);
});

//Login a sistema
$("#loginSystem-submit").unbind('click').click(function(e){
    e.preventDefault();
    e.stopImmediatePropagation();
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var URLactual = window.location;
    var gc = 0;
    if($("#recordarDatosLogin").prop("checked")){
      gc = 1;
    }
    var parametros = {
        "pass" : $("#loginSystem-pass").val(),
        "rut" : $("#loginSystem-rut").val().replace('.','').replace('.',''),
        "url" : URLactual.toString(),
        "gc": gc
    };
    $.ajax({
        data:  parametros,
        url:   'controller/datosUsuarioConectado.php',
        type:  'post',
        success: function (response) {
          var p = jQuery.parseJSON(response);
          if(p.aaData.length !== 0){
            if(p.aaData[0]['CHECK'] == 'NO'){
              $.ajax({
                  data:  parametros,
                  url:   'controller/datosPreLogin.php',
                  type:  'post',
                  success: async function (response) {
                    var p = jQuery.parseJSON(response);
                    var size = Object.size(p.aaData)/2;
                    if(size > 0){
                      if(p.aaData['ESTADO'] === 'Activo'){
                        if(p.aaData['LOGIN_2FA'] === '1'){
                          $("#secretLogin2fa").val(p.aaData['TOKEN_G_AT']);
                          $("#nombreLogin2fa").val(p.aaData['NOMBRE']);
                          $("#codigoLogin2fa").val('');
                          setTimeout(function(){
                            $('#modalAlertasSplash').modal('hide');
                            $("#modalLogin2fa").modal({backdrop: 'static', keyboard: false});
                            $("#modalLogin2fa").modal("show");
                          },500);
                        }
                        else{
                          var url = window.location.origin;

                          $.ajax({
                            url:   'controller/datosTestGA.php',
                            type:  'post',
                            data:  {
                              "url": url
                            },
                            success: function (response) {
                              if(response != 'Error'){
                                $("#qrGACrear2fa").attr("src",response);
                                setTimeout(function(){
                                  $('#modalAlertasSplash').modal('hide');
                                  $("#modalCrear2fa").modal({backdrop: 'static', keyboard: false});
                                  $("#modalCrear2fa").modal("show");
                                },4000);
                              }
                            }
                          });
                        }
                      }
                      else{
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El usuario ingresado no se encuentra activo en sistema");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                      }
                    }
                    else{
                      var random = Math.round(Math.random() * (1000000 - 1) + 1);
                      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Datos de acceso incorrectos o no registrados en sistema");
                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                      },500);
                    }
                  }
              });
            }
            else{


              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El usuario ingresado ya se encuentra conectado al sistema");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);

            }
          }
          else{


            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Datos de acceso incorrectos o no registrados en sistema");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);

          }
        }
    });
});

//Verificar input quita borde rojo
$("#loginSystem-rut").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#fechaFinAusencia").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#fechaFinAusencia").change(function(){
  $(this).removeClass("is-invalid");
});
//Verifica rut
function Rut()
{
  var texto = window.document.getElementById("loginSystem-rut").value;
  var tmpstr = "";
  for ( i=0; i < texto.length ; i++ )
    if ( texto.charAt(i) != ' ' && texto.charAt(i) != '.' && texto.charAt(i) != '-' )
      tmpstr = tmpstr + texto.charAt(i);
  texto = tmpstr;
  largo = texto.length;

  if(texto == ""){
    return false;
  }
  else if ( largo < 2 )
  {
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar el DNI completo");
    window.document.getElementById("loginSystem-rut").value = "";
    $("#loginSystem-rut").addClass("is-invalid");
    window.document.getElementById("loginSystem-rut").focus();
    window.document.getElementById("loginSystem-rut").select();
    return false;
  }

  for (i=0; i < largo ; i++ )
  {
    if ( texto.charAt(i) !="0" && texto.charAt(i) != "1" && texto.charAt(i) !="2" && texto.charAt(i) != "3" && texto.charAt(i) != "4" && texto.charAt(i) !="5" && texto.charAt(i) != "6" && texto.charAt(i) != "7" && texto.charAt(i) !="8" && texto.charAt(i) != "9" && texto.charAt(i) !="k" && texto.charAt(i) != "K" )
    {
      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Los datos ingresados no corresponden a un DNI válido");
      window.document.getElementById("loginSystem-rut").value = "";
      $("#loginSystem-rut").addClass("is-invalid");
      window.document.getElementById("loginSystem-rut").focus();
      window.document.getElementById("loginSystem-rut").select();
      return false;
    }
  }

  var invertido = "";
  for ( i=(largo-1),j=0; i>=0; i--,j++ )
    invertido = invertido + texto.charAt(i);
  var dtexto = "";
  dtexto = dtexto + invertido.charAt(0);
  dtexto = dtexto + '-';
  cnt = 0;

  for ( i=1,j=2; i<largo; i++,j++ )
  {
    //alert("i=[" + i + "] j=[" + j +"]" );
    if ( cnt == 3 )
    {
      dtexto = dtexto + '.';
      j++;
      dtexto = dtexto + invertido.charAt(i);
      cnt = 1;
    }
    else
    {
      dtexto = dtexto + invertido.charAt(i);
      cnt++;
    }
  }

  invertido = "";
  for ( i=(dtexto.length-1),j=0; i>=0; i--,j++ )
    invertido = invertido + dtexto.charAt(i);
  window.document.getElementById("loginSystem-rut").value = invertido.toUpperCase()
  if ( revisarDigito(texto) )
    return true;

  return false;
}

function revisarDigito2( dvr )
{
  dv = dvr + ""
  if ( dv != "" && dv != '0' && dv != '1' && dv != '2' && dv != '3' && dv != '4' && dv != '5' && dv != '6' && dv != '7' && dv != '8' && dv != '9' && dv != 'k'  && dv != 'K')
  {
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar un digito verificador válido");
    $("#loginSystem-rut").addClass("is-invalid");
    window.document.getElementById("loginSystem-rut").focus();
    window.document.getElementById("loginSystem-rut").select();
    return false;
  }
  return true;
}

function revisarDigito( crut )
{
  largo = crut.length;
  if(crut == ""){
    return false;
  }
  else if ( largo < 2)
  {
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar el DNI completo");
    window.document.getElementById("loginSystem-rut").value = "";
    $("#loginSystem-rut").addClass("is-invalid");
    window.document.getElementById("loginSystem-rut").focus();
    window.document.getElementById("loginSystem-rut").select();
    return false;
  }
  if ( largo > 2 )
    rut = crut.substring(0, largo - 1);
  else
    rut = crut.charAt(0);
  dv = crut.charAt(largo-1);
  revisarDigito2( dv );

  if ( rut == null || dv == null )
    return 0

  var dvr = '0'
  suma = 0
  mul  = 2

  for (i= rut.length -1 ; i >= 0; i--)
  {
    suma = suma + rut.charAt(i) * mul
    if (mul == 7)
      mul = 2
    else
      mul++
  }
  res = suma % 11
  if (res==1)
    dvr = 'k'
  else if (res==0)
    dvr = '0'
  else
  {
    dvi = 11-res
    dvr = dvi + ""
  }
  if ( dvr != dv.toLowerCase() )
  {
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Los datos ingresados no corresponden a un DNI válido");
    window.document.getElementById("loginSystem-rut").value = "";
    $("#loginSystem-rut").addClass("is-invalid");
    window.document.getElementById("loginSystem-rut").focus();
    window.document.getElementById("loginSystem-rut").select();
    return false
  }

  return true
}

Object.size = function(obj) {
    var size = 0, key;
    for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
    }
    return size;
};

function click_img_mi_equipo(){
  var table = $('#tablaPersonal').DataTable();
  setTimeout(function(){
    table.rows('.selected').deselect();
  },125);
}

// Interaccion con envio de wssp
$("#btnWssp").unbind("click").click(function(){
  if(parseFloat($('#btnWssp').css("opacity")) > parseFloat(0.2)){
    $("#mensajeWssp").hide();
    $('#btnWssp').css("opacity",0.2);
  }
  else{
    $("#bocadilloWssp").hide();
    $("#mensajeWssp").show();
    $('#btnWssp').css("opacity",1);
  }
});

$("#cierraTextoWssp").unbind("click").click(function(){
  $("#mensajeWssp").hide();
  $('#btnWssp').css("opacity",0.2);
});

$("#btnEnviarTextoWssp").unbind("click").click(function(){
  if($("#textoWssp").val() !== ''){
      window.open("https://api.whatsapp.com/send?phone=56968315567&text=" + $("#textoWssp").val(),'_blank');
      $("#textoWssp").val('');
      $("#mensajeWssp").hide();
  }
  else{
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Favor ingrese un mensaje a enviar");
  }
});

$("#manoPersonalInterno").unbind("click").change(function(){
  var table = $("#tablaPersonalInterno").DataTable();
  var mano = $("#manoPersonalInterno").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('18').search(mano).draw();
});

$("#cecoPersonalInterno").unbind("click").change(function(){
  var table = $("#tablaPersonalInterno").DataTable();
  var ceco = $("#cecoPersonalInterno").val();
  if(ceco == "Todos"){
    ceco = '';
  }
  table.rows('').deselect();
  table.columns('19').search(ceco).draw();
});

$("#estadoPersonalInterno").unbind("click").change(function(){
  var table = $("#tablaPersonalInterno").DataTable();
  var estado = $("#estadoPersonalInterno").val();
  if(estado == "Todos"){
    estado = '';
  }
  table.rows('').deselect();
  table.columns('33').search(estado).draw();
});

$("#controlPersonalInterno").unbind("click").change(function(){
  var table = $("#tablaPersonalInterno").DataTable();
  var estado = $("#controlPersonalInterno").val();
  if(estado == "Todos"){
    estado = '';
  }
  table.rows('').deselect();
  table.columns('31').search(estado).draw();
});

$("#agregarPersonalInterno").unbind("click").click(async function(){
  $("#modalIngresoPersonalInterno").find("input,textarea,select").val("");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/datosEstadoCivil.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDESTADO_CIVIL + '">' + p2.aaData[i].ESTADO_CIVIL + '</option>';
        }
        $("#estadoCivilIngresoPersonalInterno").html(cuerpoEC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#estadoCivilIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosNacionalidad.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoN = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoN += '<option value="' + p2.aaData[i].IDNACIONALIDAD + '">' + p2.aaData[i].NACIONALIDAD + '</option>';
        }
        $("#nacionalidadIngresoPersonalInterno").html(cuerpoN);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#sitMilitarIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#nacionalidadIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosAreaFuncional.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoC = '';
        var cuerpoP = '';
        var cuerpoR = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoC += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
          cuerpoP += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].PROVINCIA + '</option>';
          cuerpoR += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].REGION + '</option>';
        }
        $("#comunaIngresoPersonalInterno").html(cuerpoC);
        $("#provinciaIngresoPersonalInterno").html(cuerpoP);
        $("#regionIngresoPersonalInterno").html(cuerpoR);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#regionIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#provinciaIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosNivelEstudios.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoN = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoN += '<option value="' + p2.aaData[i].IDNIVEL_EDUCACIONAL + '">' + p2.aaData[i].NIVEL_EDUCACIONAL + '</option>';
        }
        $("#nivelEduIngresoPersonalInterno").html(cuerpoN);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#nivelEduIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#sexoIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosCeco.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoC += '<option value="' + p2.aaData[i].IDCENTRO_COSTO + '">' + p2.aaData[i].CENTRO_COSTO + '</option>';
        }
        $("#cecoIngresoPersonalInterno").html(cuerpoC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#cecoIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosContratoDepto.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCo = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoCo += '<option value="' + p2.aaData[i].IDSERVICIO + '">' + p2.aaData[i].SERVICIO + '</option>';
        }
        $("#contratoDeptoIngresoPersonalInterno").html(cuerpoCo);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#contratoDeptoIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosSucursal.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoS = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoS += '<option value="' + p2.aaData[i].IDSUCURSAL + '">' + p2.aaData[i].COMUNA + ' - ' + p2.aaData[i].SUCURSAL + '</option>';
        }
        $("#sucursalIngresoPersonalInterno").html(cuerpoS);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#sucursalIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosSindicato.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoS = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoS += '<option value="' + p2.aaData[i].IDSINDICATO + '">' + p2.aaData[i].SINDICATO + '</option>';
        }
        $("#sindicatoIngresoPersonalInterno").html(cuerpoS);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#sindicatoIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  var parametrosCliente = {
    "idcontratodepto": $("#contratoDeptoIngresoPersonalInterno").val()
  }
  await $.ajax({
    url:   'controller/datosCliente.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCl = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoCl += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + '</option>';
        }
        $("#clienteIngresoPersonalInterno").html(cuerpoCl);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#clienteIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  parametrosCliente['idcliente'] = $("#clienteIngresoPersonalInterno").val();
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadIngresoPersonalInterno").html(cuerpoAC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#actividadIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#clasificacionIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#fechaNacIngresoPersonalInterno").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#fechaIngIngresoPersonalInterno").datepicker({
    dateFormat: "dd-mm-yy",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  await $.ajax({
    url:   'controller/datosNivelFuncional.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoF = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoF += '<option value="' + p2.aaData[i].IDNIVELFUNCIONAL + '">(' + p2.aaData[i].NUMERO + ') ' + p2.aaData[i].NIVEL + '</option>';
        }
        $("#nivelFuncionalIngresoPersonalInterno").html(cuerpoF);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#nivelFuncionalIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosTipoContrato.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoT = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoT += '<option value="' + p2.aaData[i].IDTIPO_CONTRATO + '">' + p2.aaData[i].TIPO_CONTRATO + '</option>';
        }
        $("#tipoContratoIngresoPersonalInterno").html(cuerpoT);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoContratoIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#requiereUniformeIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosTipoLicencia.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoTi = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoTi += '<option value="' + p2.aaData[i].IDTIPO_LICENCIA + '">' + p2.aaData[i].TIPO_LICENCIA + ' - ' + p2.aaData[i].TIPO + '</option>';
        }
        $("#tipoLicenciaIngresoPersonalInterno").html(cuerpoTi);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#poseeLicenciaIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#tipoLicenciaIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosTipoJornada.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoTJ = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoTJ += '<option value="' + p2.aaData[i].IDTIPO_JORNADA + '">' + p2.aaData[i].TIPO_JORNADA + '</option>';
        }
        $("#tipoJornadaIngresoPersonalInterno").html(cuerpoTJ);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoJornadaIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosFormaPago.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoFP = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoFP += '<option value="' + p2.aaData[i].IDFORMA_PAGO + '">' + p2.aaData[i].FORMA_PAGO + '</option>';
        }
        $("#formaPagoIngresoPersonalInterno").html(cuerpoFP);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#formaPagoIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosBanco.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoB = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoB += '<option value="' + p2.aaData[i].IDBANCO + '">' + p2.aaData[i].BANCO + '</option>';
        }
        $("#bancoPagoIngresoPersonalInterno").html(cuerpoB);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#bancoPagoIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await $.ajax({
    url:   'controller/datosAFP.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAF = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAF += '<option value="' + p2.aaData[i].IDAFP + '">' + p2.aaData[i].AFP + '</option>';
        }
        $("#afpIngresoPersonalInterno").html(cuerpoAF);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#afpIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  var parametrosAFP = {
    "afp": $('select[id="afpIngresoPersonalInterno"] option:selected').text()
  }
  await $.ajax({
    url:   'controller/datosAFPPorcentaje.php',
    type:  'post',
    data: parametrosAFP,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        $("#afpPorcentajeIngresoPersonalInterno").val(parseFloat(p2.aaData[0].TASA.replace(',','.')).toFixed(2));
        $("#sisPorcentajeIngresoPersonalInterno").val(parseFloat(p2.aaData[0].SIS.replace(',','.')).toFixed(2));
      }
    }
  });
  if($('select[id="formaPagoIngresoPersonalInterno"] option:selected').text() !== "Transferencia"){
    $("#bancoPagoIngresoPersonalInterno").attr("disabled","disabled");
    $("#cuentaBancoIngresoPersonalInterno").attr("disabled","disabled");
  }
  else{
    $("#bancoPagoIngresoPersonalInterno").removeAttr("disabled");
    $("#cuentaBancoIngresoPersonalInterno").removeAttr("disabled");
  }
  await $.ajax({
    url:   'controller/datosSalud.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoSL = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoSL += '<option value="' + p2.aaData[i].IDSALUD + '">' + p2.aaData[i].SALUD + '</option>';
        }
        $("#saludIngresoPersonalInterno").html(cuerpoSL);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#saludIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#cargasIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  if($("#cargasIngresoPersonalInterno").val() === "NO"){
    $("#cantidadCargasIngresoPersonalInterno").attr("disabled","disabled");
    $("#cantidadCargasIngresoPersonalInterno").val(0);
  }
  else{
    $("#cantidadCargasIngresoPersonalInterno").removeAttr("disabled");
  }
  var parametrosAFP = {
    "afp": $('select[id="afpIngresoPersonalInterno"] option:selected').text()
  }
  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyIngresoPersonalInterno").css("height",h);
    $("#modalIngresoPersonalInterno").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoPersonalInterno').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#cargasIngresoPersonalInterno").unbind("click").change(function(){
  if($("#cargasIngresoPersonalInterno").val() === "NO"){
    $("#cantidadCargasIngresoPersonalInterno").attr("disabled","disabled");
    $("#cantidadCargasIngresoPersonalInterno").val(0);
  }
  else{
    $("#cantidadCargasIngresoPersonalInterno").removeAttr("disabled");
  }
});

$("#cantidadCargasIngresoPersonalInterno").unbind("click").change(function(){
  if($("#cantidadCargasIngresoPersonalInterno").val() < 0){
    $("#cantidadCargasIngresoPersonalInterno").val(0);
  }
});

$("#afpIngresoPersonalInterno").unbind("click").change(async function(){
  var parametrosAFP = {
    "afp": $('select[id="afpIngresoPersonalInterno"] option:selected').text()
  }
  await $.ajax({
    url:   'controller/datosAFPPorcentaje.php',
    type:  'post',
    data: parametrosAFP,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        $("#afpPorcentajeIngresoPersonalInterno").val(parseFloat(p2.aaData[0].TASA.replace(',','.')).toFixed(2));
        $("#sisPorcentajeIngresoPersonalInterno").val(parseFloat(p2.aaData[0].SIS.replace(',','.')).toFixed(2));
      }
    }
  });
});

$("#formaPagoIngresoPersonalInterno").unbind("click").change(function(){
  if($('select[id="formaPagoIngresoPersonalInterno"] option:selected').text() !== "Transferencia"){
    $("#bancoPagoIngresoPersonalInterno").attr("disabled","disabled");
    $("#cuentaBancoIngresoPersonalInterno").attr("disabled","disabled");
  }
  else{
    $("#bancoPagoIngresoPersonalInterno").removeAttr("disabled");
    $("#cuentaBancoIngresoPersonalInterno").removeAttr("disabled");
  }
});

$("#poseeLicenciaIngresoPersonalInterno").unbind("click").change(function(){
  if($("#poseeLicenciaIngresoPersonalInterno").val() === "NO"){
    $("#tipoLicenciaIngresoPersonalInterno").attr("disabled","disabled");
    $("#tipoLicenciaIngresoPersonalInterno").val('');
  }
  else{
    $("#tipoLicenciaIngresoPersonalInterno").removeAttr("disabled");
  }
});

$("#requiereUniformeIngresoPersonalInterno").unbind("click").change(function(){
  if($("#requiereUniformeIngresoPersonalInterno").val() === "NO"){
    $("#tallaIngresoPersonalInterno").attr("disabled","disabled");
    $("#tallaIngresoPersonalInterno").val('');
  }
  else{
    $("#tallaIngresoPersonalInterno").removeAttr("disabled");
  }
});

$("#tallaIngresoPersonalInterno").unbind("click").change(function(){
  if($("#tallaIngresoPersonalInterno").val() > 60){
    $("#tallaIngresoPersonalInterno").val(60);
  }
  if($("#tallaIngresoPersonalInterno").val() < 30){
    $("#tallaIngresoPersonalInterno").val(30);
  }
});

$("input#rutIngresoPersonalInterno").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutIngresoPersonalInterno").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutIngresoPersonalInterno").val("");
    $("#rutIngresoPersonalInterno").addClass("is-invalid");
  }
});

$('.input-number').on('input', function () {
    this.value = this.value.replace(/[^0-9]/g,'');
});

$('.input-money').on('input', function () {
    this.value = this.value.replace(/[^0-9]/g,'');
});

$('.input-money').unbind("click").change(function(){
  this.value = accounting.formatMoney(this.value, "$ ", 0);
});

$("#comunaIngresoPersonalInterno").unbind("click").change(function(){
  $("#provinciaIngresoPersonalInterno").val($("#comunaIngresoPersonalInterno").val());
  $("#regionIngresoPersonalInterno").val($("#comunaIngresoPersonalInterno").val());
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#regionIngresoPersonalInterno").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#provinciaIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#contratoDeptoIngresoPersonalInterno").unbind("click").change(async function(){
  var parametrosCliente = {
    "idcontratodepto": $("#contratoDeptoIngresoPersonalInterno").val()
  }
  await $.ajax({
    url:   'controller/datosCliente.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCl = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoCl += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + '</option>';
        }
        $("#clienteIngresoPersonalInterno").html(cuerpoCl);
      }
    }
  })
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#clienteIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  parametrosCliente['idcliente'] = $("#clienteIngresoPersonalInterno").val();
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadIngresoPersonalInterno").html(cuerpoAC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#actividadIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#clienteIngresoPersonalInterno").unbind("click").change(async function(){
  var parametrosCliente = {
    "idcontratodepto": $("#contratoDeptoIngresoPersonalInterno").val(),
    "idcliente": $("#clienteIngresoPersonalInterno").val()
  }
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadIngresoPersonalInterno").html(cuerpoAC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#actividadIngresoPersonalInterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#agregarUsuario").unbind("click").click(async function(){
  $("#modalIngresoUsuario").find("input,textarea,select").val("");
  $("#rutIngresoUsuario").removeClass("is-invalid");
  $("#apellidosIngresoUsuario").removeClass("is-invalid");
  $("#nombresIngresoUsuario").removeClass("is-invalid");
  $("#emailUsuario").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/datosPersonalUsuario.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var listaPersonalUsuario = [];
        for(var i = 0; i < p.aaData.length; i++) {
          listaPersonalUsuario.push(p.aaData[i].DNI);
        }
        $('#rutIngresoUsuario').autocomplete({
          // req will contain an object with a "term" property that contains the value
          // currently in the text input.  responseFn should be invoked with the options
          // to display to the user.
          source: function (req, responseFn) {
            // Escape any RegExp meaningful characters such as ".", or "^" from the
            // keyed term.
            var term = $.ui.autocomplete.escapeRegex(req.term),
              // '^' is the RegExp character to match at the beginning of the string.
              // 'i' tells the RegExp to do a case insensitive match.
              matcher = new RegExp(term, 'i'),
              // Loop over the options and selects only the ones that match the RegExp.
              matches = $.grep(listaPersonalUsuario, function (item) {
                return matcher.test(item);
              });
            // Return the matched options.
            responseFn(matches);
          }
        });
      }
    }
  });
  await $.ajax({
    url:   'controller/datosPerfilTipos.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDPERFIL + '">' + p2.aaData[i].NOMBRE + '</option>';
        }
        $("#perfilUsuario").html(cuerpoEC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#perfilUsuario").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    $("#modalIngresoUsuario").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoUsuario').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("input#rutIngresoUsuario").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutIngresoUsuario").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutIngresoUsuario").val("");
    $("#rutIngresoUsuario").addClass("is-invalid");
  }
});

$("#guardarIngresoUsuario").unbind('click').click(function(){
  if($("#rutIngresoUsuario").val().length == 0 || $("#apellidosIngresoUsuario").val().length == 0 || $("#nombresIngresoUsuario").val().length == 0 || $("#emailUsuario").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#rutIngresoUsuario").val().length == 0){
      $("#rutIngresoUsuario").addClass("is-invalid");
    }
    else if ($("#apellidosIngresoUsuario").val().length == 0){
      $("#apellidosIngresoUsuario").addClass("is-invalid");
    }
    else if ($("#nombresIngresoUsuario").val().length == 0){
      $("#nombresIngresoUsuario").addClass("is-invalid");
    }
    else if ($("#emailUsuario").val().length == 0){
      $("#emailUsuario").addClass("is-invalid");
    }
  }
  else {
    $("#modalIngresoUsuario").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    parametros = {
      "rutIngreso":   $.trim($("#rutIngresoUsuario").val().replace('.','').replace('.','')),
      "apellidos":  $("#apellidosIngresoUsuario").val(),
      "nombres": $("#nombresIngresoUsuario").val(),
      "email": $("#emailUsuario").val(),
      "perfilUsuario": $("#perfilUsuario").val(),
      "passUsuario": randomTexto()
    }
    //console.log(parametros);
    $.ajax({
        url:   'controller/datosChequeaUsuario.php',
        type:  'post',
        data:  parametros,
        success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El DNI del usuario ya existe");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $("#modalIngresoUsuario").modal("show");
              },500);
            }
          }
          else{
            $.ajax({
              url:   'controller/datosChequeaEmail.php',
              type:  'post',
              data:  parametros,
              success:  function (response) {
                var p = response.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                  if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Ya existe un usuario creado con ese email");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                      $("#modalIngresoUsuario").modal("show");
                    },500);
                  }
                }
                else {
                  $.ajax({
                    url: "controller/ingresaUsuario.php",
                    type: 'POST',
                    data: parametros,
                    success:  function (response) {
                      var p = response.split(",");
                      if(response.localeCompare("Sin datos")!= 0 && response != ""){
                        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                          var table = $('#tablaListadoUsuarios').DataTable();
                          //table.rows('.selected').remove().draw();
                          table.ajax.reload();
                          var random = Math.round(Math.random() * (1000000 - 1) + 1);
                          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Usuario creado correctamente");
                          $("#editarUsuario").attr("disabled","disabled");
                          $("#usuarioResetPass").attr("disabled","disabled");
                          setTimeout(function(){
                            $("#modalAlertasSplash").modal("hide");
                          },500);
                        }
                        else{
                          var random = Math.round(Math.random() * (1000000 - 1) + 1);
                          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear usuario, si el problema persiste favor comuniquese con soporte");
                        }
                      }
                      else{
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear usuario, si el problema persiste favor comuniquese con soporte");
                      }
                    }
                  });
                }
              }
            });
          }
        }
      });
  }
});

$("#rutIngresoUsuario").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#apellidosIngresoUsuario").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombresIngresoUsuario").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#emailUsuario").unbind('click').click(function(){
  $(this).removeClass("is-invalid");
});

$("#desactivarUsuario").unbind('click').click(function(){
  var table = $('#tablaListadoUsuarios').DataTable();
  var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT;
  });
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  $("#textoDesactivarUsuario").html(rutUsuario[0] + ' , ' +nombre[0]);
  $('#modalDesactivarUsuario').modal('show');
});

$("#guardarDesactivarUsuario").unbind('click').click(async function(){
  $("#modalDesactivarUsuario").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoUsuarios').DataTable();
  var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT;
  });

  parametros = {
    "rutUsuario": rutUsuario[0]
  }
  //console.log(parametros);
  await $.ajax({
    url:   'controller/desactivarUsuario.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoUsuarios').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload()
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Usuario desactivado correctamente");
          $("#editarUsuario").attr("disabled","disabled");
          $("#usuarioResetPass").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al desactivar al usuario, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al desactivar al usuario, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
  $('#modalDesactivarUsuario').modal('hide');
});

$("#editarUsuario").unbind('click').click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoUsuarios').DataTable();
  var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT;
  });
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  var email = $.map(table.rows('.selected').data(), function (item) {
      return item.EMAIL;
  });
  var perfil = $.map(table.rows('.selected').data(), function (item) {
      return item.PERFIL;
  });
  var estado = $.map(table.rows('.selected').data(), function (item) {
      return item.ESTADO;
  });
  await $.ajax({
    url:   'controller/datosPerfilTipos.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(perfil[0] === p2.aaData[i].NOMBRE){
            cuerpoEC += '<option selected value="' + p2.aaData[i].IDPERFIL + '">' + p2.aaData[i].NOMBRE + '</option>';
          }
          else{
            cuerpoEC += '<option value="' + p2.aaData[i].IDPERFIL + '">' + p2.aaData[i].NOMBRE + '</option>';
          }
        }
        $("#perfilEditarUsuario").html(cuerpoEC);
        setTimeout(function(){
          $('#modalEditarUsuario').modal('show');
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#perfilEditarUsuario").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#estadoEditarUsuario").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  $("#rutEditarUsuario").val(rutUsuario);
  $("#nombreEditarUsuario").val(nombre);
  $("#emailEditarUsuario").val(email);
  $("#estadoEditarUsuario").val(estado);
});
// Funcion para verificar RUT
$("input#rutEditarUsuario").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutIngresoUsuario").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
  }
});

$("#guardarEditarUsuario").unbind('click').click(async function(){
  $("#modalEditarUsuario").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  parametros = {
    "rutEditar":   $("#rutEditarUsuario").val(),
    "nombre":  $("#nombreEditarUsuario").val(),
    "email": $("#emailEditarUsuario").val(),
    "estado": $("#estadoEditarUsuario").val(),
    "perfilUsuario": $("#perfilEditarUsuario").val()
  }
  //console.log(parametros);
  await $.ajax({
    url: "controller/editarUsuario.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoUsuarios').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Usuario editado correctamente");
          $("#editarUsuario").attr("disabled","disabled");
          $("#usuarioResetPass").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar al usuario, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar al usuario, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$('#agregarComponenteRemuneracion').unbind('click').click(function(){
    ajaxDatosTipoComponenteRemuneracion();
    $("#conceptoIngresoConceptoRemuneracion").removeClass("is-invalid");
    $('#modalIngresoConceptoRemuneracion').modal('show');
});

$("#tipoIngresoConceptoRemuneracion").change(function(){
    var seleccionado = $(this).find(":selected");
    $("#liquidacionIngresoConceptoRemuneracion").val(seleccionado.attr("liquidacion"));
    $("#ordenIngresoConceptoRemuneracion").val(seleccionado.attr("orden"));
});

$("#conceptoIngresoConceptoRemuneracion").on('keyup', function(){
    if($(this).val() != ''){
        $("#conceptoIngresoConceptoRemuneracion").removeClass("is-invalid");
    }
});

$("#guardarIngresoConceptoRemuneracion").unbind('click').click(function(){
    var concepto = $("#conceptoIngresoConceptoRemuneracion").val();
    var tipo = $("#tipoIngresoConceptoRemuneracion").val();
    var liquidacion = $("#liquidacionIngresoConceptoRemuneracion").val();
    var orden = liquidacion == "NO APLICA" ? "-1" : $("#ordenIngresoConceptoRemuneracion").val();

    if(concepto == ''){
        $("#conceptoIngresoConceptoRemuneracion").addClass("is-invalid");
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El campo <b>Concepto</b> es obligatorio");
        return;
    }
    var parametros = {
        'concepto': concepto,
        'tipo': tipo,
        'liquidacion': liquidacion,
        'orden': orden
    }
    ajaxGuardarConceptoRemuneracion(parametros);
});

function ajaxGuardarConceptoRemuneracion(parametros){
    $('#modalIngresoConceptoRemuneracion').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
        url: "controller/ingresaComponenteRemuneracion.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  if(p[0].localeCompare("EXISTE") != 0){
                    var table = $('#tablaListadoComponenteRemuneracion').DataTable();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Concepto de remuneracion ingresado correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                  else{
                    $("#conceptoIngresoConceptoRemuneracion").addClass('is-invalid');
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El concepto <b>"+parametros.concepto+"</b> ya se encuentra registrado, por favor ingrese un concepto diferente");
                    setTimeout(function(){
                      $('#modalIngresoConceptoRemuneracion').modal('show');
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                }
                else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el concepto de remuneración, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
            }else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el concepto de remuneración, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
            }
        }
    });
}

$("#editarComponenteRemuneracion").unbind('click').click(async function(){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var table = $('#tablaListadoComponenteRemuneracion').DataTable();
    var idComponenteRemuneracion = '';
    var concepto = '';
    var tipo = '';
    var liquidacion = '';
    var orden = '';

    $.map(table.rows('.selected').data(), function (item) {
        idComponenteRemuneracion = item.IDCOMPONENTE_SUELDO;
        concepto = item.CONCEPTO;
        tipo = item.TIPO;
        liquidacion = item.LIQUIDACION;
        orden = item.ORDEN;
    });

    await ajaxDatosTipoComponenteRemuneracion();
    $("#conceptoEditarConceptoRemuneracion").removeClass("is-invalid");
    $("#idComponenteEditarConceptoRemuneracion").val(idComponenteRemuneracion);
    $("#conceptoEditarConceptoRemuneracion").val(concepto);
    $("#tipoEditarConceptoRemuneracion").val(tipo);
    $("#liquidacionEditarConceptoRemuneracion").val(liquidacion);
    setTimeout(function(){
      $('#modalEditarConceptoRemuneracion').modal('show');
      $('#modalAlertasSplash').modal('hide');
    },1000);
});

$("#tipoEditarConceptoRemuneracion").change(function(){
  var seleccionado = $(this).find(":selected");
  $("#liquidacionEditarConceptoRemuneracion").val(seleccionado.attr("liquidacion"));
  $("#ordenEditarConceptoRemuneracion").val(seleccionado.attr("orden"));
});

$("#conceptoEditarConceptoRemuneracion").on('keyup', function(){
    if($(this).val() != ''){
        $("#conceptoEditarConceptoRemuneracion").removeClass("is-invalid");
    }
});

$("#guardarEditarConceptoRemuneracion").unbind('click').click(function(){
    $("#modalEditarConceptoRemuneracion").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var idComponenteRemuneracion = $("#idComponenteEditarConceptoRemuneracion").val();
    var concepto = $("#conceptoEditarConceptoRemuneracion").val();
    var tipo = $("#tipoEditarConceptoRemuneracion").val();
    var liquidacion = $("#liquidacionEditarConceptoRemuneracion").val();
    var orden = liquidacion == "NO APLICA" ? "-1" : $("#ordenEditarConceptoRemuneracion").val();

    if(concepto == ''){
        $("#conceptoEditarConceptoRemuneracion").addClass("is-invalid");
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El campo <b>Concepto</b> es obligatorio");
        return;
    }
    var parametros = {
        'idComponenteRemuneracion': idComponenteRemuneracion,
        'concepto': concepto,
        'tipo': tipo,
        'liquidacion': liquidacion,
        'orden': orden
    }
    ajaxEditarConceptoRemuneracion(parametros);
});

function ajaxEditarConceptoRemuneracion(parametros){
    $.ajax({
        url: "controller/editarComponenteRemuneracion.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaListadoComponenteRemuneracion').DataTable();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Concepto de remuneracion editado correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
                else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar el concepto de remuneración, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
            }else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar el concepto de remuneración, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
            }
        }
    });
}

$("#eliminarComponenteRemuneracion").unbind('click').click(function(){
    var table = $('#tablaListadoComponenteRemuneracion').DataTable();
    var idComponenteRemuneracion = '';
    var concepto = '';

    $.map(table.rows('.selected').data(), function (item) {
        idComponenteRemuneracion = item.IDCOMPONENTE_SUELDO;
        concepto = item.CONCEPTO;
    });
    $("#idComponenteEliminarConceptoRemuneracion").val(idComponenteRemuneracion);
    $("#conceptoEliminar").html(concepto);
    $("#modalEliminarConceptoRemuneracion").modal('show');

});

$("#guardarEliminarConceptoRemuneracion").unbind('click').click(function(){
    $("#modalEliminarConceptoRemuneracion").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var idComponenteRemuneracion = $("#idComponenteEliminarConceptoRemuneracion").val();
    var parametros = {
        'idComponenteRemuneracion': idComponenteRemuneracion
    }
    ajaxEliminarConceptoRemuneracion(parametros)
});

function ajaxEliminarConceptoRemuneracion(parametros){
    $.ajax({
        url: "controller/eliminarComponenteRemuneracion.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaListadoComponenteRemuneracion').DataTable();
                    table.ajax.reload();
                    $('#modalEliminarConceptoRemuneracion').modal('hide');
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Concepto de remuneracion eliminado correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
                else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminado el concepto de remuneración, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
            }else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminado el concepto de remuneración, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
            }
        }
    });
}

$('#modalIngresoConceptoRemuneracion').on('show.bs.modal', function (event) {
    $("#modalIngresoConceptoRemuneracion input").val("").removeClass("is-invalid");
});

function ajaxDatosTipoComponenteRemuneracion(){
    $.ajax({
        url: "controller/datosTipoComponenteRemuneracion.php",
        type: 'POST',
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var datos = JSON.parse(response);
                    var selectorTipoIngreso = $('#tipoIngresoConceptoRemuneracion');
                    var selectorTipoEditar = $('#tipoEditarConceptoRemuneracion');
                    var inputLiquidacionIngreso = $("#liquidacionIngresoConceptoRemuneracion");
                    var inputLiquidacionEditar = $("#liquidacionEditarConceptoRemuneracion");
                    var inputOrdenIngreso = $("#ordenIngresoConceptoRemuneracion");
                    var inputOrdenEditar = $("#ordenEditarConceptoRemuneracion");

                    var tipoFormateados = datos.aaData.map(tipo => `<option liquidacion="${tipo.LIQUIDACION}" orden="${tipo.ORDEN}" value="${tipo.IDTIPO_COMPONENTE_SUELDO}">${tipo.TIPO_COMPONENTE_SUELDO}</option>`);
                    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                      selectorTipoIngreso.html(tipoFormateados).select2({
                          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                      });
                      selectorTipoEditar.html(tipoFormateados).select2({
                          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                      });
                    }
                    else{
                      selectorTipoIngreso.html(tipoFormateados);
                      selectorTipoEditar.html(tipoFormateados);
                    }

                    inputLiquidacionIngreso.val(selectorTipoIngreso.find(":selected").attr("liquidacion"));
                    inputLiquidacionEditar.val(selectorTipoEditar.find(":selected").attr("liquidacion"));
                    inputOrdenIngreso.val(selectorTipoIngreso.find(":selected").attr("orden"));
                    inputOrdenEditar.val(selectorTipoEditar.find(":selected").attr("orden"));
                }else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al consultar los tipos de concepto de remuneración, si el problema persiste favor comuniquese con soporte");
                }
            }else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al consultar los tipos de concepto de remuneración, si el problema persiste favor comuniquese con soporte");
            }
        }
    });
}

$("#usuarioResetPass").unbind('click').click(async function(){
  var table = $('#tablaListadoUsuarios').DataTable();
  var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT;
  });
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  $("#tituloDesvincular").html(rutUsuario[0] + ' , ' +nombre[0]);
  $('#modalResetPassUsuario').modal('show');
});

$("#guardarResetPassUsuario").unbind('click').click(async function(){
  $('#modalResetPassUsuario').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoUsuarios').DataTable();
  var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT;
  });
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  var email = $.map(table.rows('.selected').data(), function (item) {
      return item.EMAIL;
  });

  parametros = {
    "rutUsuario": rutUsuario[0],
    "nombreUsuario": nombre[0],
    "mailUsuario": email[0],
    "passUsuario": randomTexto()
  }
  await $.ajax({
    url:   'controller/resetPass.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoUsuarios').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload()
          $("#editarUsuario").attr("disabled","disabled");
          $("#usuarioResetPass").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Contraseña reseteada correctamente");
          },500);
        }
        else{
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al resetear contraseña, si el problema persiste favor comuniquese con soporte");
          },500);
        }
      }
      else{
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al resetear contraseña, si el problema persiste favor comuniquese con soporte");
        },500);
      }
    }
  });
});

function randomTexto(){
  var str = '';
  var ref = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRST0123456789';
  for (var i = 0; i < 8 ; i++)
  {
    str += ref.charAt(Math.floor(Math.random()*ref.length));
  }
  return str;
}

$("#agregarSindicato").unbind('click').click(function(){
    $("#sindicatoIngresoSindicato").removeClass('is-invalid')
    $("#modalIngresoSindicato").modal('show');
});

$('#modalIngresoSindicato').on('show.bs.modal', function (event) {
    $("#modalIngresoSindicato input").val("").removeClass("is-invalid");
});

$("#sindicatoIngresoSindicato").on('keyup', function(){
    if($(this).val() != ''){
        $("#sindicatoIngresoSindicato").removeClass('is-invalid')
    }
});

$("#guardarIngresoSindicato").unbind('click').click(function(){
    var sindicato = $("#sindicatoIngresoSindicato").val();
    var descripcion = $("#descripcionIngresoSindicato").val();
    if(sindicato == ''){
        $("#sindicatoIngresoSindicato").addClass('is-invalid')
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El campo <b>Sindicato</b> es obligatorio");
        return;
    }
    var parametros = {
        'sindicato': sindicato,
        'descripcion': descripcion
    }
    ajaxGuardarSindicato(parametros);
});

function ajaxGuardarSindicato(parametros){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $('#modalIngresoSindicato').modal('hide');
    $.ajax({
        url: "controller/ingresaSindicato.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    if(p[0].localeCompare("EXISTE") != 0){
                      var table = $('#tablaListadoSindicato').DataTable();
                      table.ajax.reload();
                      var random = Math.round(Math.random() * (1000000 - 1) + 1);
                      alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Sindicato ingresado correctamente");
                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                        $("#eliminarSindicato").attr("disabled","disabled");
                        $("#editarSindicato").attr("disabled","disabled");
                      },500);
                    }else{
                      $("#sindicatoIngresoSindicato").addClass('is-invalid');
                      var random = Math.round(Math.random() * (1000000 - 1) + 1);
                      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El sindicato <b>"+parametros.sindicato+"</b> ya se encuentra registrado, por favor ingrese un nombre diferente");
                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                      },500);
                    }
                }
                else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el sindicato, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
            }else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el sindicato, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
            }
        }
    });
}

$("#editarSindicato").unbind('click').click(function(){
    var table = $('#tablaListadoSindicato').DataTable();
    var idSindicato = '';
    var sindicato = '';
    var descripcion = '';

    $.map(table.rows('.selected').data(), function (item) {
        idSindicato = item.IDSINDICATO;
        sindicato = item.SINDICATO;
        descripcion = item.DESCRIPCION;
    });
    $("#sindicatoEditarSindicato").removeClass('is-invalid')
    $("#idSindicatoEditarSindicato").val(idSindicato);
    $("#sindicatoEditarSindicato").val(sindicato);
    $("#descripcionEditarSindicato").val(descripcion);
    $("#modalEditarSindicato").modal('show');
});

$("#sindicatoEditarSindicato").on('keyup', function(){
    if($(this).val() != ''){
        $("#sindicatoEditarSindicato").removeClass('is-invalid')
    }
})

$("#guardarEditarSindicato").unbind('click').click(function(){
    var idSindicato = $("#idSindicatoEditarSindicato").val();
    var sindicato = $("#sindicatoEditarSindicato").val();
    var descripcion = $("#descripcionEditarSindicato").val();

    if(sindicato == ''){
        $("#sindicatoEditarSindicato").addClass('is-invalid');
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El campo <b>Sindicato</b> es obligatorio");
        return;
    }
    var parametros = {
        'idSindicato' : idSindicato,
        'sindicato' : sindicato,
        'descripcion' : descripcion
    }
    ajaxEditarSindicato(parametros);
});

function ajaxEditarSindicato(parametros){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $('#modalEditarSindicato').modal('hide');
    $.ajax({
        url: "controller/editarSindicato.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaListadoSindicato').DataTable();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Sindicato editado correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                      $("#eliminarSindicato").attr("disabled","disabled");
                      $("#editarSindicato").attr("disabled","disabled");
                    },500);
                }
                else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar el sindicato, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
            }else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar el sindicato, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
            }
        }
    });
}

$("#eliminarSindicato").unbind('click').click(function(){
    var table = $('#tablaListadoSindicato').DataTable();
    var idSindicato = '';
    var sindicato = '';

    $.map(table.rows('.selected').data(), function (item) {
        idSindicato = item.IDSINDICATO;
        sindicato = item.SINDICATO;
    });
    $("#idSindicatoEliminarSindicato").val(idSindicato);
    $("#sindicatoEliminar").html(sindicato);
    $("#modalEliminarSindicato").modal('show');
});

$("#guardarEliminarSindicato").unbind('click').click(function(){
    var idSindicato = $("#idSindicatoEliminarSindicato").val();
    var parametros = {
        'idSindicato' : idSindicato
    }
    ajaxEliminarSindicato(parametros);
});

function ajaxEliminarSindicato(parametros){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $('#modalEliminarSindicato').modal('hide');
    $.ajax({
        url: "controller/eliminarSindicato.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaListadoSindicato').DataTable();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Sindicato eliminado correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                      $("#eliminarSindicato").attr("disabled","disabled");
                      $("#editarSindicato").attr("disabled","disabled");
                    },500);
                }
                else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminado sindicato, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
            }else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminado el sindicato, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
            }
        }
    });
}

$("#agregarPerfil").unbind('click').click(function(){
  $("#perfilInformeDisponibilidad").prop("checked", false);
  $("#perfilInformeMetas").prop("checked", false);
  $("#modalIngresoPerfil").find("input").val("");
  $("#nombreIngresoPerfil").removeClass("is-invalid");
  var h = $(window).height() - 200;
  $("#bodyIngresoPerfil").css("height",h);
  $("#modalIngresoPerfil").modal('show');
});

$("#guardarIngresoPerfil").unbind('click').click(async function(){
  var informeDisponibilidad = 0;
  var informeMetas = 0;
  var nombrePerfil = $("#nombreIngresoPerfil").val();
  if($("#nombreIngresoPerfil").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar los campos");
    $("#nombreIngresoPerfil").addClass("is-invalid");
  }
  else{
    $("#modalIngresoPerfil").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    if($("#perfilInformeDisponibilidad").prop("checked") == true && $("#perfilInformeMetas").prop("checked") == true){
      informeDisponibilidad = 1;
      informeMetas = 1;
    }
    else if ($("#perfilInformeDisponibilidad").prop("checked") == true && $("#perfilInformeMetas").prop("checked") == false){
      informeDisponibilidad = 1;
      informeMetas = 0;
    }
    else if ($("#perfilInformeDisponibilidad").prop("checked") == false && $("#perfilInformeMetas").prop("checked") == true){
      informeDisponibilidad = 0;
      informeMetas = 1;
    }
    else{
      informeDisponibilidad = 0;
      informeMetas = 0;
    }
    parametros = {
      "nombrePerfil": nombrePerfil,
      "descripcionPerfil": $("#descripcionIngresoPerfil").val(),
      "informeDisponibilidad": informeDisponibilidad,
      "informeMetas": informeMetas
    }
    await $.ajax({
        url:   'controller/datosChequeaPerfil.php',
        type:  'post',
        data:  parametros,
        success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El nombre del perfil ya existe");
              setTimeout(function(){
                $('#modalIngresoPerfil').modal('show');
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            $.ajax({
              url: "controller/ingresaPerfil.php",
              type: 'POST',
              data: parametros,
              success:  function (response) {
                var p = response.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                  if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaListadoPerfiles').DataTable();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Perfil ingresado correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                  else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el perfil, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el perfil, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
            });
          }
        }
    });
  }
});

$("#nombreIngresoPerfil").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#editarPerfil").unbind('click').click(function(){
  var table = $('#tablaListadoPerfiles').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  var idPerfil = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPERFIL;
  });
  var asignacion = $.map(table.rows('.selected').data(), function (item) {
      return item.ASIGNACION;
  });
  var descripcion = $.map(table.rows('.selected').data(), function (item) {
      return item.DESCRIPCION;
  });
  var informeDisponibilidad = $.map(table.rows('.selected').data(), function (item) {
      return item.INFOR_DISP;
  });
  var informeMetas = $.map(table.rows('.selected').data(), function (item) {
      return item.INFOR_META;
  });

  if(informeDisponibilidad == 1 &&  informeMetas == 1){
    $("#perfilEditInformeDisponibilidad").prop("checked", true);
    $("#perfilEditInformeMetas").prop("checked", true);
  }
  else if(informeDisponibilidad == 1 &&  informeMetas == 0){
    $("#perfilEditInformeDisponibilidad").prop("checked", true);
    $("#perfilEditInformeMetas").prop("checked", false);
  }
  else if(informeDisponibilidad == 0 &&  informeMetas == 1){
    $("#perfilEditInformeDisponibilidad").prop("checked", false);
    $("#perfilEditInformeMetas").prop("checked", true);
  }
  else{
    $("#perfilEditInformeDisponibilidad").prop("checked", false);
    $("#perfilEditInformeMetas").prop("checked", false);
  }

  $("#nombreEditarPerfil").val(nombre);
  $("#asignacionEditarPerfil").val(asignacion);
  $("#descripcionEditarPerfil").val(descripcion);
  var h = $(window).height() - 200;
  $("#bodyEditarPerfil").css("height",h);
  $('#modalEditarPerfil').modal('show');
});

$("#nombreEditarPerfil").on('keyup', function(){
    if($(this).val() != ''){
        $("#validacionEditarPerfil").addClass("d-none");
    }
});

$("#guardarEditarPerfil").unbind('click').click(async function(){
  var informeDisponibilidad = 0;
  var informeMetas = 1;
  var table = $('#tablaListadoPerfiles').DataTable();
  var idPerfil = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPERFIL;
  });
  if($("#nombreEditarPerfil").val() == ''){
      $("#validacionEditarPerfil").removeClass("d-none");
      return;
  }
  else{
    $("#modalEditarPerfil").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    if($("#perfilEditInformeDisponibilidad").prop("checked") == true && $("#perfilEditInformeMetas").prop("checked") == true){
      informeDisponibilidad = 1;
      informeMetas = 1;
    }
    else if ($("#perfilEditInformeDisponibilidad").prop("checked") == true && $("#perfilEditInformeMetas").prop("checked") == false){
      informeDisponibilidad = 1;
      informeMetas = 0;
    }
    else if ($("#perfilEditInformeDisponibilidad").prop("checked") == false && $("#perfilEditInformeMetas").prop("checked") == true){
      informeDisponibilidad = 0;
      informeMetas = 1;
    }
    else{
      informeDisponibilidad = 0;
      informeMetas = 0;
    }
    parametros = {
      "nombre":  $("#nombreEditarPerfil").val(),
      "idPerfil": idPerfil[0],
      "descripcion": $("#descripcionEditarPerfil").val(),
      "informeDisponibilidad": informeDisponibilidad,
      "informeMetas": informeMetas
    }

    await $.ajax({
      url: "controller/editarPerfil.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoPerfiles').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Perfil editado correctamente");
            $("#editarPerfil").attr("disabled","disabled");
            $("#asignarAreasPerfil").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar el perfil, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar el perfil, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

function addCambiaPass(){
    $("#guardarChangePass").unbind();
    $("#guardarChangePass").unbind('click').click(function(){
        var pass1 = $("#passNuevo").val();
        var pass2 = $("#passNuevoConfirmar").val();
        if(pass1 == "" && pass2 == "")
        {
            $("#passNuevo").addClass("is-invalid");
            $("#passNuevoConfirmar").addClass("is-invalid");
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Ingrese todos los campos");
        }
        else if(pass1 == ""){
            $("#passNuevo").addClass("is-invalid");
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Ingrese todos los campos");
        }
        else if(pass2 == ""){
            $("#passNuevoConfirmar").addClass("is-invalid");
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Ingrese todos los campos");
        }
        else if(pass1 == pass2){
            var parametros = {
                "pass" :  $("#passNuevo").val()
            };
            //Chequeo mismo pass
            $.ajax({
                data:  parametros,
                url:   'controller/checkPassIgual.php',
                type:  'post',
                success:  function (response) {
                    var p = response.split(",");
                    if(p != null){
                        if(p[0] != "Sin datos" && p[0] != "" && p[0] != 'Error'){
                            if(p[0] == "Igual"){
                                $("#passNuevo").addClass("is-invalid");
                                $("#passNuevoConfirmar").addClass("is-invalid");
                                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Contraseña igual a la actual");
                            }
                            else{
                                $.ajax({
                                  data:  parametros,
                                  url:   'controller/actualizaPass.php',
                                  type:  'post',
                                  beforeSend: function(){
                                      $("#modalChangePass").modal("hide");
                                      $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                                      $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                                      $('#modalAlertasSplash').modal('show');
                                  },
                                  success:  function (response) {
                                      var p = response.split(",");
                                      if(p != null){
                                          if(p[0] != "Sin datos" && p[0] != "" && p[0] != 'Error'){
                                              $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                                              var random = Math.round(Math.random() * (1000000 - 1) + 1);
                                              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Contraseña actualizada correctamente");
                                              $('#modalAlertasSplash').modal('show');
                                              $("#passNuevo").removeClass("is-invalid");
                                              $("#passNuevoConfirmar").removeClass("is-invalid");
                                              $("#passNuevo").val("");
                                              $("#passNuevoConfirmar").val("");
                                              $("#mensajeCambioPass").hide();
                                              $.ajax({
                                                  url:   'controller/cerraSesion.php',
                                                  type:  'post',
                                                  success: function (response) {
                                                    $(".modal").modal("hide");
                                                    $(".contenedor-logos").css("display","none");
                                                    $(".contenedor-logos").find('li').css("display","none");
                                                    $("#sesionActiva").val("0");
                                                    $("#sesionActivaUso").val("0");
                                                    $("#logoLinkWeb").hide();
                                                    $("#logoMenu").hide();
                                                    $("#lineaMenu").hide();
                                                    $("#iconoLogoMenu").attr("class","imgMenu fas fas fa-bars");
                                                    $("#menu-lateral").css("width","37px");
                                                    $("#menu-lateral").css("background","rgba(30, 0, 0, 0.0)");
                                                    $("#logoMenu").css("color","black");
                                                    $("#iconoLogoMenu").css("border","1px solid #b5b5b5");
                                                    $("#iconoLogoMenu").css("background","rgba(255, 255, 255, 1.0)");
                                                    $("#DivPrincipalMenu").empty();
                                                    localStorage.clear();
                                                    window.location.href = "#/home";
                                                    setTimeout(function(){
                                                      $('.modal-backdrop').remove();
                                                      $('#modalAlertasSplash').modal('hide');
                                                    },2000);
                                                  }
                                              });
                                          }
                                          else{
                                            $('#modalAlertasSplash').modal('hide');
                                            var random = Math.round(Math.random() * (1000000 - 1) + 1);
                                            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error en la actualización si el problema persiste<br/>favor comuniquese con soporte");
                                          }
                                      }
                                      else{
                                        $('#modalAlertasSplash').modal('show');
                                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                                        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error en la actualización si el problema persiste<br/>favor comuniquese con soporte");
                                      }
                                    }
                                  });
                            }
                        }
                    }
                }
            });
        }
        else{
            $("#passNuevo").addClass("is-invalid");
            $("#passNuevoConfirmar").addClass("is-invalid");
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Las contraseñas no coinciden");
        }
    });
}

$("#passNuevo").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#passNuevoConfirmar").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#agregarProyecto").unbind('click').click(async function(){
  $("#defProyectoIngresoProyecto").val("");
  $("#pepIngresoProyecto").val("");
  $("#crmIngresoProyecto").val("");
  $("#proyectoIngresoProyecto").val("");
  $("#denominacionIngresoProyecto").val("");
  $("#fechaIniContratoIngresoProyecto").val("");
  $("#fechaFinContratoIngresoProyecto").val("");
  $("#fechaIniProyectoIngresoProyecto").val("");
  $("#fechaFinProyectoIngresoProyecto").val("");

  $("#modalEditarPerfil").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url:   'controller/datosSubcontratistasVehiculoInterno.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoSub = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoSub += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
        }
        $("#sociedadIngresoProyecto").html(cuerpoSub);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosGerenciaProyecto.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoGer = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoGer += '<option value="' + p2.aaData[i].IDGERENCIA + '">' + p2.aaData[i].GERENCIA + ' - ' + p2.aaData[i].SUBGERENCIA +  '</option>';
        }
        $("#gerSubIngresoProyecto").html(cuerpoGer);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosPersonalParaAsignar.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoController = '';
      var cuerpoAdmin = '';
      for(var i = 0; i < p.aaData.length; i++){
        cuerpoController += '<option value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        cuerpoAdmin += '<option value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
      }
      $("#controllerIngresoProyecto").html(cuerpoController);
      $("#adminContratoIngresoProyecto").html(cuerpoAdmin);
    }
  });

  await $.ajax({
    url:   'controller/datosClientesProyectos.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCl = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoCl += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + ' - ' + p2.aaData[i].SUB_CLIENTE +  '</option>';
        }
        $("#clienteSubIngresoProyecto").html(cuerpoCl);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosEstadosProyectos.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEst = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEst += '<option value="' + p2.aaData[i].IDESTADO + '">' + p2.aaData[i].ESTADO + '</option>';
        }
        $("#estadoIngresoProyecto").html(cuerpoEst);
      }
    }
  });

  $("#fechaIniContratoIngresoProyecto").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#fechaFinContratoIngresoProyecto").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#fechaIniProyectoIngresoProyecto").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#fechaFinProyectoIngresoProyecto").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#estadoIngresoProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#clienteSubIngresoProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#sociedadIngresoProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#gerSubIngresoProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#controllerIngresoProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#adminContratoIngresoProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
  }

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyIngresoProyecto").css("height",h);
    $("#modalIngresoProyecto").modal("show");
    $('#modalAlertasSplash').modal('hide');
  },500);
});

function ingresaModificacionJefatura(p){
  var table2 = $('#tablaJefatura').DataTable();
  for(var k = 0; k < p.aaData.length; k++){
    table2.rows.add([{
      'S': p.aaData[k].S,
      'DNI': p.aaData[k].DNI,
      'RUTA_IMG_PERFIL': p.aaData[k].RUTA_IMG_PERFIL,
      'NOMBRES': p.aaData[k].NOMBRES,
      'APELLIDOS': p.aaData[k].APELLIDOS,
      'EMPRESA': p.aaData[k].EMPRESA,
      'CLASIFICACION': p.aaData[k].CLASIFICACION,
      'NIVEL': p.aaData[k].NIVEL,
      'GERENCIA': p.aaData[k].GERENCIA,
      'SUBGRENCIA': p.aaData[k].SUBGRENCIA,
      'CLIENTE': p.aaData[k].CLIENTE,
      'NOMENCLATURA': p.aaData[k].NOMENCLATURA,
      'DENOMINACION': p.aaData[k].DENOMINACION,
      'COMUNA': p.aaData[k].COMUNA,
      'REGION': p.aaData[k].REGION,
      'CARGO': p.aaData[k].CARGO,
      'PATENTE': p.aaData[k].PATENTE,
      'EMAIL': p.aaData[k].EMAIL,
      'TELEFONO': p.aaData[k].TELEFONO,
      'SOLICITUD': p.aaData[k].SOLICITUD,
      'JEFE': p.aaData[k].JEFE,
      'IDPERSONAL': p.aaData[k].IDPERSONAL,
      'EXTERNO': p.aaData[k].EXTERNO,
      'SUCURSAL': p.aaData[k].SUCURSAL
    }]).draw();
  }
}

function ingresaModificacionPersonal(p){
  var table2 = $('#tablaPersonal').DataTable();
  for(var k = 0; k < p.aaData.length; k++){
    table2.rows.add([{
      'S': p.aaData[k].S,
      'RUTA_IMG_PERFIL': p.aaData[k].RUTA_IMG_PERFIL,
      'ESTADO_CONTROL': p.aaData[k].ESTADO_CONTROL,
      'ESTADO_GEO': p.aaData[k].ESTADO_GEO,
      'ESTADO_GESTPER': p.aaData[k].ESTADO_GESTPER,
      'DNI': p.aaData[k].DNI,
      'NOMBRE': p.aaData[k].NOMBRE,
      'ASIGNACION': p.aaData[k].ASIGNACION,
      'NIVEL': p.aaData[k].NIVEL,
      'AREA': p.aaData[k].AREA,
      'TURNO': p.aaData[k].TURNO,
      'ENTRADA': p.aaData[k].ENTRADA,
      'SALIDA': p.aaData[k].SALIDA,
      'PERMISO': p.aaData[k].PERMISO,
      'CARGO': p.aaData[k].CARGO,
      'FECHA_INICIO_CONTRATO': p.aaData[k].FECHA_INICIO_CONTRATO,
      'CLASIFICACION': p.aaData[k].CLASIFICACION,
      'CENTRO_COSTO': p.aaData[k].CENTRO_COSTO,
      'GERENCIA': p.aaData[k].GERENCIA,
      'SUBGERENCIA': p.aaData[k].SUBGERENCIA,
      'CLIENTE': p.aaData[k].CLIENTE,
      'COMUNA': p.aaData[k].COMUNA,
      'REGION': p.aaData[k].REGION,
      'EMPRESA': p.aaData[k].EMPRESA,
      'NOMBREJEFE': p.aaData[k].NOMBREJEFE,
      'CELULAR': p.aaData[k].CELULAR,
      'PATENTE': p.aaData[k].PATENTE,
      'SALDOVAC': p.aaData[k].SALDOVAC,
      'FECHANAC': p.aaData[k].FECHANAC,
      'DNI2': p.aaData[k].DNI2,
      'ESTADO_CONTROL2': p.aaData[k].ESTADO_CONTROL2,
      'ESTADO_GEO2': p.aaData[k].ESTADO_GEO2,
      'ESTADO_GESTPER2': p.aaData[k].ESTADO_GESTPER2,
      'ASIGNACION2': p.aaData[k].ASIGNACION2,
      'EMAIL': p.aaData[k].EMAIL,
      'RUTJEFEDIRECTO': p.aaData[k].RUTJEFEDIRECTO,
      'IDPERSONAL': p.aaData[k].IDPERSONAL
    }]).draw();
  }
}

$("#servicioExistenteIngresoProyecto").change(function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  var idServicio = $("#servicioExistenteIngresoProyecto").val();
  var idCliente = $("#clienteExistenteIngresoProyecto").val();
  var idActividad = $("#actividadExistenteIngresoProyecto").val();
  var idSociedad = $("#subcontratoExistenteIngresoProyecto").val();
  if($(this).val() === "NO APLICA"){
    $("#servicioNuevoIngresoProyecto").removeAttr("disabled", "disabled").removeClass('is-invalid');
  }else{
    $("#servicioNuevoIngresoProyecto").attr("disabled","disabled").removeClass('is-invalid').val('');
  }
  let datos = {
    idServicio: idServicio,
    idCliente: idCliente,
    idActividad: idActividad,
    idSociedad: idSociedad
  }
  ajaxDatosNomenclaturaByServicioCliente(datos);
});

$("#clienteExistenteIngresoProyecto").change(function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  var idServicio = $("#servicioExistenteIngresoProyecto").val();
  var idCliente = $("#clienteExistenteIngresoProyecto").val();
  var idActividad = $("#actividadExistenteIngresoProyecto").val();
  var idSociedad = $("#subcontratoExistenteIngresoProyecto").val();
  if($(this).val() === "NO APLICA"){
    $("#clienteNuevoIngresoProyecto").removeAttr("disabled", "disabled").removeClass('is-invalid');
  }else{
    $("#clienteNuevoIngresoProyecto").attr("disabled","disabled").removeClass('is-invalid').val('');
  }
  let datos = {
    idServicio: idServicio,
    idCliente: idCliente,
    idActividad: idActividad,
    idSociedad: idSociedad
  }
  ajaxDatosNomenclaturaByServicioCliente(datos);
});

$("#actividadExistenteIngresoProyecto").change(function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  var idServicio = $("#servicioExistenteIngresoProyecto").val();
  var idCliente = $("#clienteExistenteIngresoProyecto").val();
  var idActividad = $("#actividadExistenteIngresoProyecto").val();
  var idSociedad = $("#subcontratoExistenteIngresoProyecto").val();
  if($(this).val() === "NO APLICA"){
    $("#actividadNuevoIngresoProyecto").removeAttr("disabled", "disabled").removeClass('is-invalid');
  }else{
    $("#actividadNuevoIngresoProyecto").attr("disabled","disabled").removeClass('is-invalid').val('');
  }
  let datos = {
    idServicio: idServicio,
    idCliente: idCliente,
    idActividad: idActividad,
    idSociedad: idSociedad
  }
  ajaxDatosNomenclaturaByServicioCliente(datos);
});

$("#subcontratoExistenteIngresoProyecto").change(function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  var idServicio = $("#servicioExistenteIngresoProyecto").val();
  var idCliente = $("#clienteExistenteIngresoProyecto").val();
  var idActividad = $("#actividadExistenteIngresoProyecto").val();
  var idSociedad = $("#subcontratoExistenteIngresoProyecto").val();
  // if($(this).val() === "NO APLICA"){
  //   $("#actividadNuevoIngresoProyecto").removeAttr("disabled", "disabled").removeClass('is-invalid');
  // }else{
  //   $("#actividadNuevoIngresoProyecto").attr("disabled","disabled").removeClass('is-invalid').val('');
  // }
  let datos = {
    idServicio: idServicio,
    idCliente: idCliente,
    idActividad: idActividad,
    idSociedad: idSociedad
  }
  ajaxDatosNomenclaturaByServicioCliente(datos);
});

function ajaxDatosNomenclaturaByServicioCliente(datos){
  $("#modalIngresoProyecto").modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
      data: datos,
      url: "controller/datosNomenclaturaByServicioCliente.php",
      type: 'POST',
      success:  function (response) {
        if(response !== 'Error'){
          let res = JSON.parse(response);
          if(res !== 'Sin datos'){
            if(res){
              $("#nomenclaturaIngresoProyecto").val(res.NOMENCLATURA).attr("disabled","disabled").removeClass("is-invalid");
              $("#nombreIngresoProyecto").val(res.NOMBRE).attr("disabled","disabled").removeClass("is-invalid");
            }else{
              $("#nomenclaturaIngresoProyecto").val("").removeAttr("disabled");
              $("#nombreIngresoProyecto").val("").removeAttr("disabled");
            }
          }else{
            $("#nomenclaturaIngresoProyecto").val("").removeAttr("disabled");
            $("#nombreIngresoProyecto").val("").removeAttr("disabled");
          }

          setTimeout(function(){
            var subcontratista = $("#subcontratoExistenteIngresoProyecto");
            var servicio = $("#servicioExistenteIngresoProyecto");
            var cliente = $("#clienteExistenteIngresoProyecto");
            var actividad = $("#actividadExistenteIngresoProyecto");
            var sociedad = $("#subcontratoExistenteIngresoProyecto");
            var area = $("#areaIngresoProyecto");

            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              subcontratista.select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              servicio.select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              cliente.select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              actividad.select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              area.select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              sociedad.select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
            }

            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalIngresoProyecto").modal('show');
            },1000);
          },1500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar los datos de nomenclatura, si el problema persiste<br/>favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
  });
}

$("#servicioNuevoIngresoProyecto").on('keyup', function(){
  if($(this).val() != ''){
    $("#servicioNuevoIngresoProyecto").removeClass("is-invalid");
  }
});

$("#clienteNuevoIngresoProyecto").on('keyup', function(){
  if($(this).val() != ''){
    $("#clienteNuevoIngresoProyecto").removeClass("is-invalid");
  }
});

$("#actividadNuevoIngresoProyecto").on('keyup', function(){
  if($(this).val() != ''){
    $("#actividadNuevoIngresoProyecto").removeClass("is-invalid");
  }
});

$("#nomenclaturaIngresoProyecto").on('keyup', function(){
  if($(this).val() != ''){
    $("#nomenclaturaIngresoProyecto").removeClass("is-invalid");
  }
});

function ajaxGuardarEstructuraOperacion(parametros){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $('#modalIngresoProyecto').modal('hide');
  $.ajax({
    url: "controller/ingresaEstructuraOperacion.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
        $("#modalIngresoProyecto input").removeClass("is-invalid");
        var p = response.split(",");
        if(response.localeCompare("OK") == 0){
            if(p[0].localeCompare("OK") == 0){
                var table = $('#tablaListadoProyecto').DataTable();
                table.ajax.reload();
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>proyecto ingresado correctamente");
                $("#eliminarProyecto").attr("disabled", "disabled");
                $("#editarProyecto").attr("disabled", "disabled");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
            }else if(p[0].localeCompare("EXISTE") == 0){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La combinatoria ingresada ya se encuentra registrada, favor ingresar una combinatoria diferente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalIngresoProyecto').modal('show');
              },500);
            }else if(p[0].localeCompare("EXISTESERVICIO") == 0){
              $("#servicioNuevoIngresoProyecto").addClass("is-invalid");
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El servicio <b>"+ parametros.servicioNuevo +"</b> ya se encuentra registrado, favor ingresar un servicio diferente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalIngresoProyecto').modal('show');
              },500);
            }else if(p[0].localeCompare("EXISTECLIENTE") == 0){
              $("#clienteNuevoIngresoProyecto").addClass("is-invalid");
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El cliente <b>"+ parametros.clienteNuevo +"</b> ya se encuentra registrado, favor ingresar un cliente diferente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalIngresoProyecto').modal('show');
              },500);
            }else if(p[0].localeCompare("EXISTEACTIVIDAD") == 0){
              $("#actividadNuevoIngresoProyecto").addClass("is-invalid");
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La actividad <b>"+ parametros.actividadNuevo +"</b> ya se encuentra registrada, favor ingresar una actividad diferente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalIngresoProyecto').modal('show');
              },500);
            }else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el proyecto, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
            }
        }else if(response.localeCompare("EXISTE") == 0){
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La combinatoria ingresada ya se encuentra registrada, favor ingresar una combinatoria diferente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalIngresoProyecto').modal('show');
          },500);
        }else if(response.localeCompare("EXISTESERVICIO") == 0){
          $("#servicioNuevoIngresoProyecto").addClass("is-invalid");
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El servicio <b>"+ parametros.servicioNuevo +"</b> ya se encuentra registrado, favor ingresar un servicio diferente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalIngresoProyecto').modal('show');
          },500);
        }else if(response.localeCompare("EXISTECLIENTE") == 0){
          $("#clienteNuevoIngresoProyecto").addClass("is-invalid");
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El cliente <b>"+ parametros.clienteNuevo +"</b> ya se encuentra registrado, favor ingresar un cliente diferente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalIngresoProyecto').modal('show');
          },500);
        }else if(response.localeCompare("EXISTEACTIVIDAD") == 0){
          $("#actividadNuevoIngresoProyecto").addClass("is-invalid");
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La actividad <b>"+ parametros.actividadNuevo +"</b> ya se encuentra registrada, favor ingresar una actividad diferente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalIngresoProyecto').modal('show');
          },500);
        }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el proyecto, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
    }
  });
}

function esconderMenu(){
  $("#logoLinkWeb").hide();
  $("#menu-lateral").css("width","37px");
  $("#menu-lateral").css("background","rgba(30, 0, 0, 0.0)");
  $("#logoMenu").css("color","white");
  $("#iconoLogoMenu").css("border","1px solid white");
  $("#iconoLogoMenu").css("background","rgba(0, 56, 101, 1.0)");
  if($("#sesionActiva").val() == 1){
    $("#lineaMenu").hide();
    $(".contenedor-logos").css("display","none");
    $(".contenedor-logos").find('li').css("display","none");
  }
  $("#iconoLogoMenu").attr("class","imgMenu fas fas fa-bars");
  $("#logoMenu").show();
  $(".logo").hide();
}

$("#manoPersonal").unbind("click").change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  var table = $('#infoInformePersonal').DataTable().clear().draw();

  var table = $("#tablaPersonal").DataTable();
  var mano = $("#manoPersonal").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('16').search(mano).draw();

  var vac = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Vacaciones' ? true : false;
  });
  var lic = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Licencia' ? true : false;
  });
  var des = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Desvinculado' ? true : false;
  });
  var pre = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente' ? true : false;
  });
  var pre_in = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción' ? true : false;
  });
  var pre_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Teletrabajo' ? true : false;
  });
  var pre_in_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción Teletrabajo' ? true : false;
  });
  var ren = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Renuncia' ? true : false;
  });
  var per = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Permiso' ? true : false;
  });
  var aus = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Ausente' ? true : false;
  });
  var sin = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Sin marca' ? true : false;
  });
  var total = table
      .column(30, {search: 'applied'})
      .data();
  var directos = table
      .column(24, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == $("#nombreUsuarioPersonal").val() ? true : false;
  });

  var tablaInf = $('#infoInformePersonal').DataTable( {
    "select": {
        style: 'single'
    },
    columnDefs: [
      {
          targets: 0,
          className: 'leftDataTableCant'
      },
      {
          targets: 1,
          className: 'centerDataTableCant'
      }
    ],
    "scrollX": true,
    "paging": false,
    "searching": false,
    "ordering": false,
    "scrollCollapse": true,
    "order": [[ 0, "asc" ]],
    "info": true,
    "dom": 'frtp',
    "destroy": true,
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      $(this.api().column(1).footer()).html(total.count());
    }
  });
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
  tablaInf.draw();

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#datoSubordinadosDirectos").css("margin-top","20pt");
  }
  else{
    $("#datoSubordinadosDirectos").css("margin-top","5pt");
  }

  $("#qDirectos").html(directos.count());
  $("#qOtros").html(total.count() - directos.count());

  menuElegant();
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#cecoPersonal").unbind("click").change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  var table = $('#infoInformePersonal').DataTable().clear().draw();

  var table = $("#tablaPersonal").DataTable();
  var mano = $("#cecoPersonal").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('17').search(mano).draw();

  var vac = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Vacaciones' ? true : false;
  });
  var lic = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Licencia' ? true : false;
  });
  var des = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Desvinculado' ? true : false;
  });
  var pre = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente' ? true : false;
  });
  var pre_in = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción' ? true : false;
  });
  var pre_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Teletrabajo' ? true : false;
  });
  var pre_in_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción Teletrabajo' ? true : false;
  });
  var ren = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Renuncia' ? true : false;
  });
  var per = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Permiso' ? true : false;
  });
  var aus = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Ausente' ? true : false;
  });
  var sin = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Sin marca' ? true : false;
  });
  var total = table
      .column(30, {search: 'applied'})
      .data();
  var directos = table
      .column(24, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == $("#nombreUsuarioPersonal").val() ? true : false;
  });

  var tablaInf = $('#infoInformePersonal').DataTable( {
    "select": {
        style: 'single'
    },
    columnDefs: [
      {
          targets: 0,
          className: 'leftDataTableCant'
      },
      {
          targets: 1,
          className: 'centerDataTableCant'
      }
    ],
    "scrollX": true,
    "paging": false,
    "searching": false,
    "ordering": false,
    "scrollCollapse": true,
    "order": [[ 0, "asc" ]],
    "info": true,
    "dom": 'frtp',
    "destroy": true,
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      $(this.api().column(1).footer()).html(total.count());
    }
  });
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
  tablaInf.draw();

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#datoSubordinadosDirectos").css("margin-top","20pt");
  }
  else{
    $("#datoSubordinadosDirectos").css("margin-top","5pt");
  }

  $("#qDirectos").html(directos.count());
  $("#qOtros").html(total.count() - directos.count());

  menuElegant();
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#estadoPersonal").unbind("click").change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  var table = $('#infoInformePersonal').DataTable().clear().draw();

  var table = $("#tablaPersonal").DataTable();
  var mano = $("#estadoPersonal").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('32').search(mano).draw();

  var vac = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Vacaciones' ? true : false;
  });
  var lic = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Licencia' ? true : false;
  });
  var des = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Desvinculado' ? true : false;
  });
  var pre = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente' ? true : false;
  });
  var pre_in = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción' ? true : false;
  });
  var pre_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Teletrabajo' ? true : false;
  });
  var pre_in_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción Teletrabajo' ? true : false;
  });
  var ren = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Renuncia' ? true : false;
  });
  var per = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Permiso' ? true : false;
  });
  var aus = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Ausente' ? true : false;
  });
  var sin = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Sin marca' ? true : false;
  });
  var total = table
      .column(30, {search: 'applied'})
      .data();
  var directos = table
      .column(24, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == $("#nombreUsuarioPersonal").val() ? true : false;
  });

  var tablaInf = $('#infoInformePersonal').DataTable( {
    "select": {
        style: 'single'
    },
    columnDefs: [
      {
          targets: 0,
          className: 'leftDataTableCant'
      },
      {
          targets: 1,
          className: 'centerDataTableCant'
      }
    ],
    "scrollX": true,
    "paging": false,
    "searching": false,
    "ordering": false,
    "scrollCollapse": true,
    "order": [[ 0, "asc" ]],
    "info": true,
    "dom": 'frtp',
    "destroy": true,
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      $(this.api().column(1).footer()).html(total.count());
    }
  });
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
  tablaInf.draw();

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#datoSubordinadosDirectos").css("margin-top","20pt");
  }
  else{
    $("#datoSubordinadosDirectos").css("margin-top","5pt");
  }

  $("#qDirectos").html(directos.count());
  $("#qOtros").html(total.count() - directos.count());

  menuElegant();
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#controlPersonal").unbind("click").change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  var table = $('#infoInformePersonal').DataTable().clear().draw();

  var table = $("#tablaPersonal").DataTable();
  var mano = $("#controlPersonal").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('30').search(mano).draw();

  var vac = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Vacaciones' ? true : false;
  });
  var lic = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Licencia' ? true : false;
  });
  var des = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Desvinculado' ? true : false;
  });
  var pre = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente' ? true : false;
  });
  var pre_in = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción' ? true : false;
  });
  var pre_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Teletrabajo' ? true : false;
  });
  var pre_in_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción Teletrabajo' ? true : false;
  });
  var ren = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Renuncia' ? true : false;
  });
  var per = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Permiso' ? true : false;
  });
  var aus = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Ausente' ? true : false;
  });
  var sin = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Sin marca' ? true : false;
  });
  var total = table
      .column(30, {search: 'applied'})
      .data();
  var directos = table
      .column(24, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == $("#nombreUsuarioPersonal").val() ? true : false;
  });

  var tablaInf = $('#infoInformePersonal').DataTable( {
    "select": {
        style: 'single'
    },
    columnDefs: [
      {
          targets: 0,
          className: 'leftDataTableCant'
      },
      {
          targets: 1,
          className: 'centerDataTableCant'
      }
    ],
    "scrollX": true,
    "paging": false,
    "searching": false,
    "ordering": false,
    "scrollCollapse": true,
    "order": [[ 0, "asc" ]],
    "info": true,
    "dom": 'frtp',
    "destroy": true,
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      $(this.api().column(1).footer()).html(total.count());
    }
  });
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
  tablaInf.draw();

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#datoSubordinadosDirectos").css("margin-top","20pt");
  }
  else{
    $("#datoSubordinadosDirectos").css("margin-top","5pt");
  }

  $("#qDirectos").html(directos.count());
  $("#qOtros").html(total.count() - directos.count());

  menuElegant();
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#disponiblePersonal").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaPersonal").DataTable()
  var datos = table.rows('.selected').data();
  var parametros = [];
  if(table.rows('.selected').data().length > 0){
    var continua = 'NO';
    for(var i = 0; i < datos.length; i++){
      if(datos[i].ESTADO_CONTROL2 === 'Sin marca'){
        parametros.push(datos[i].DNI);
        continua = 'SI';
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Ha seleccionado personal con disponibilidad ya indicada");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },2000);
        continua = 'NO';
        break;
      }
    }
    if(continua === 'SI'){
      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
        $("#modalDisponibilidad").modal("show");
      },500);
    }
  }
});

$("#guardarDisponibilidad").unbind("click").click(async function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $("#modalDisponibilidad").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  var table = $('#infoInformePersonal').DataTable().clear().draw();

  var induccion = 0;
  var teletrabajo = 0;
  if($("#induccionDisponibilidad").prop("checked") == true){
    induccion = 1;
  }
  else{
    induccion = 0;
  }
  if($("#teletrabajoDisponibilidad").prop("checked") == true){
    teletrabajo = 1;
  }
  else{
    teletrabajo = 0;
  }

  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();
  var parametros = [];
  parametros.push(induccion);
  parametros.push(teletrabajo);
  for(var i = 0; i < datos.length; i++){
      parametros.push(datos[i].DNI);
  }

  await $.ajax({
    url:   'controller/ingresaDisponibilidad.php',
    type:  'post',
    data:  {array : parametros},
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Disponibilidad ingresada correctamente");
        var table = $('#tablaPersonal').DataTable();
        var rows = table.rows( '.selected' ).remove().draw();
        await ingresaModificacionPersonal(p);
        var manoPersonal = '';
        manoPersonal += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(16).data().unique().length; i++){
          if(table.column(16).data().unique()[i] !== null){
            manoPersonal += '<option value="' + table.column(16).data().unique()[i] + '">' + table.column(16).data().unique()[i] + '</option>';
          }
        }
        $("#manoPersonal").html(manoPersonal);

        var cecoPersonal = '';
        cecoPersonal += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(17).data().unique().length; i++){
          if(table.column(17).data().unique()[i] !== null){
            cecoPersonal += '<option value="' + table.column(17).data().unique()[i] + '">' + table.column(17).data().unique()[i] + '</option>';
          }
        }
        $("#cecoPersonal").html(cecoPersonal);

        var estadoPersonal = '';
        estadoPersonal += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(32).data().unique().length; i++){
          if(table.column(32).data().unique()[i] !== null){
            estadoPersonal += '<option value="' + table.column(32).data().unique()[i] + '">' + table.column(32).data().unique()[i] + '</option>';
          }
        }
        $("#estadoPersonal").html(estadoPersonal);

        var controlPersonal = '';
        controlPersonal += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(30).data().unique().length; i++){
          if(table.column(30).data().unique()[i] !== null){
            controlPersonal += '<option value="' + table.column(30).data().unique()[i] + '">' + table.column(30).data().unique()[i] + '</option>';
          }
        }
        $("#controlPersonal").html(controlPersonal);
        $("#disponiblePersonal").attr("disabled","disabled");
        $("#ausentePersonal").attr("disabled","disabled");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },1000);
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar la disponibilidad, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },1000);
      }
    }
  });

  var table = $("#tablaPersonal").DataTable();
  var vac = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Vacaciones' ? true : false;
  });
  var lic = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Licencia' ? true : false;
  });
  var des = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Desvinculado' ? true : false;
  });
  var pre = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente' ? true : false;
  });
  var pre_in = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción' ? true : false;
  });
  var pre_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Teletrabajo' ? true : false;
  });
  var pre_in_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción Teletrabajo' ? true : false;
  });
  var ren = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Renuncia' ? true : false;
  });
  var per = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Permiso' ? true : false;
  });
  var aus = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Ausente' ? true : false;
  });
  var sin = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Sin marca' ? true : false;
  });
  var total = table
      .column(30, {search: 'applied'})
      .data();
  var directos = table
      .column(24, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == $("#nombreUsuarioPersonal").val() ? true : false;
  });

  var tablaInf = $('#infoInformePersonal').DataTable( {
    "select": {
        style: 'single'
    },
    columnDefs: [
      {
          targets: 0,
          className: 'leftDataTableCant'
      },
      {
          targets: 1,
          className: 'centerDataTableCant'
      }
    ],
    "scrollX": true,
    "paging": false,
    "searching": false,
    "ordering": false,
    "scrollCollapse": true,
    "order": [[ 0, "asc" ]],
    "info": true,
    "dom": 'frtp',
    "destroy": true,
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      $(this.api().column(1).footer()).html(total.count());
    }
  });
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
  tablaInf.draw();


  $("#qDirectos").html(directos.count());
  $("#qOtros").html(total.count() - directos.count());

  menuElegant();
});

$("#ausentePersonal").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaPersonal").DataTable()
  var datos = table.rows('.selected').data();
  var parametros = [];
  if(table.rows('.selected').data().length > 0){
    var continua = 'NO';
    for(var i = 0; i < datos.length; i++){
      if(datos[i].ESTADO_CONTROL2 === 'Sin marca'){
        parametros.push(datos[i].DNI);
        continua = 'SI';
      }
      else{
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Ha seleccionado personal con disponibilidad ya indicada");
        continua = 'NO';
        break;
      }
    }
    if(continua === 'SI'){
      setTimeout(async function(){
        var table = $('#tablaPersonal').DataTable();
        var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
            return item.DNI;
        });
        var nombre = $.map(table.rows('.selected').data(), function (item) {
            return item.NOMBRE;
        });
        $("#tituloAusencia").html(rutUsuario[0] + ' , ' +nombre[0]);

        var min = new Date();
        $("#fechaInicioAusencia").datepicker({
          dateFormat: "yy-mm-dd",
          changeMonth: true,
          changeYear: true,
          minDate: min,
          maxDate: min,
          yearRange: '1920:2040',
          firstDay: 1,
          changeMonth: true,
          changeYear: true,
          monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
          monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
          dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
          dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
          dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
        });

        $("#fechaFinAusencia").datepicker({
          dateFormat: "yy-mm-dd",
          changeMonth: true,
          changeYear: true,
          minDate: min,
          yearRange: '1920:2040',
          firstDay: 1,
          changeMonth: true,
          changeYear: true,
          monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
          monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
          dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
          dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
          dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
        });

        var y = moment().format('YYYY-MM-DD');
        $("#fechaInicioAusencia").attr("disabled","disabled");
        $("#fechaInicioAusencia").val(y.toString());

        await $.ajax({
          url:   'controller/datosEstadoOper.php',
          type:  'post',
          success: function (response2) {
            var p2 = jQuery.parseJSON(response2);
            if(p2.aaData.length !== 0){
              var cuerpoEstadoOper = '';
              for(var i = 0; i < p2.aaData.length; i++){
                cuerpoEstadoOper += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].ESTADO + '</option>';
              }
              $("#tipoAusencia").html(cuerpoEstadoOper);
              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#tipoAusencia").select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
              }
            }
          }
        });

        $("#observacionAusencia").val('');
        // $("#fechaInicioAusencia").val('');
        $("#fechaFinAusencia").val('');
        setTimeout(function(){
          $("#modalAusencia").modal("show");
          $('#modalAlertasSplash').modal('hide');
        },500);
      },500);
    }
  }
});

$("#tipoAusencia").unbind("click").change(function(){
  var valor = $(this).val(); // Capturamos el valor del select
  var texto = $(this).find('option:selected').text();
  if(texto === "Renuncia" || texto === "Desvinculado" || texto === "Presente" || texto === "Ausente"){
    $("#fechaFinAusencia").attr("disabled","disabled");
  }
  else{
    $("#fechaFinAusencia").removeAttr("disabled");
  }
});

$("#guardarAusencia").unbind("click").click(async function(){
  if($("#fechaFinAusencia").val() === '' && $("#tipoAusencia").find('option:selected').text() !== 'Desvinculado' && $("#tipoAusencia").find('option:selected').text() !== 'Renuncia' && $("#tipoAusencia").find('option:selected').text() !== 'Ausente'){
    $("#fechaFinAusencia").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Favor ingrese la fecha de termino de la ausencia.");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalAusencia").modal("hide");

    //initialize the plugin and get its instance
    var instance = OverlayScrollbars(document.getElementById('contenido'), { });

    //destroy the instance
    instance.destroy();

    var table = $('#infoInformePersonal').DataTable().clear().draw();

    var table = $('#tablaPersonal').DataTable();
    var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
        return item.DNI;
    });

    var valor = $("#tipoAusencia").val(); // Capturamos el valor del select
    var tipoTexto = $("#tipoAusencia").find('option:selected').text();

    var parametros = {
      "rut": rutUsuario[0],
      "tipo": $("#tipoAusencia").val(),
      "observacion": $("#observacionAusencia").val(),
      "ini": $("#fechaInicioAusencia").val(),
      "fin": $("#fechaFinAusencia").val(),
      "tipoTexto": tipoTexto
    }

    await $.ajax({
      url:   'controller/ingresaAusencia.php',
      type:  'post',
      data:  parametros,
      success: async function (response) {
        var p = jQuery.parseJSON(response);
        $('#modalAlertasSplash').modal('hide');
        if(p.aaData.length !== 0){
          var table = $('#tablaPersonal').DataTable();
          var rows = table.rows( '.selected' ).remove().draw();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Ausencia ingresada correctamente");
          $("#disponiblePersonal").attr("disabled","disabled");
          $("#ausentePersonal").attr("disabled","disabled");
          await ingresaModificacionPersonal(p);
          var manoPersonal = '';
          manoPersonal += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(16).data().unique().length; i++){
            if(table.column(16).data().unique()[i] !== null){
              manoPersonal += '<option value="' + table.column(16).data().unique()[i] + '">' + table.column(16).data().unique()[i] + '</option>';
            }
          }
          $("#manoPersonal").html(manoPersonal);

          var cecoPersonal = '';
          cecoPersonal += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(17).data().unique().length; i++){
            if(table.column(17).data().unique()[i] !== null){
              cecoPersonal += '<option value="' + table.column(17).data().unique()[i] + '">' + table.column(17).data().unique()[i] + '</option>';
            }
          }
          $("#cecoPersonal").html(cecoPersonal);

          var estadoPersonal = '';
          estadoPersonal += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(32).data().unique().length; i++){
            if(table.column(32).data().unique()[i] !== null){
              estadoPersonal += '<option value="' + table.column(32).data().unique()[i] + '">' + table.column(32).data().unique()[i] + '</option>';
            }
          }
          $("#estadoPersonal").html(estadoPersonal);

          var controlPersonal = '';
          controlPersonal += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(30).data().unique().length; i++){
            if(table.column(30).data().unique()[i] !== null){
              controlPersonal += '<option value="' + table.column(30).data().unique()[i] + '">' + table.column(30).data().unique()[i] + '</option>';
            }
          }
          $("#controlPersonal").html(controlPersonal);
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },1000);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar la ausencia, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },1000);
        }
      }
    });

    var table = $("#tablaPersonal").DataTable();
    var vac = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Vacaciones' ? true : false;
    });
    var lic = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Licencia' ? true : false;
    });
    var des = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Desvinculado' ? true : false;
    });
    var pre = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Presente' ? true : false;
    });
    var pre_in = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Presente Inducción' ? true : false;
    });
    var pre_tel = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Presente Teletrabajo' ? true : false;
    });
    var pre_in_tel = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Presente Inducción Teletrabajo' ? true : false;
    });
    var ren = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Renuncia' ? true : false;
    });
    var per = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Permiso' ? true : false;
    });
    var aus = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Ausente' ? true : false;
    });
    var sin = table
        .column(30, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == 'Sin marca' ? true : false;
    });
    var total = table
        .column(30, {search: 'applied'})
        .data();
    var directos = table
        .column(24, {search: 'applied'})
        .data()
        .filter( function ( value, index ) {
            return value == $("#nombreUsuarioPersonal").val() ? true : false;
    });

    var tablaInf = $('#infoInformePersonal').DataTable( {
      "select": {
          style: 'single'
      },
      columnDefs: [
        {
            targets: 0,
            className: 'leftDataTableCant'
        },
        {
            targets: 1,
            className: 'centerDataTableCant'
        }
      ],
      "scrollX": true,
      "paging": false,
      "searching": false,
      "ordering": false,
      "scrollCollapse": true,
      "order": [[ 0, "asc" ]],
      "info": true,
      "dom": 'frtp',
      "destroy": true,
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json){
        $(this.api().column(1).footer()).html(total.count());
      }
    });
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
    tablaInf.draw();


    $("#qDirectos").html(directos.count());
    $("#qOtros").html(total.count() - directos.count());

    menuElegant();
  }
});

$("#asignarAreasPerfil").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#asignarPermisosPerfil").attr("disabled","disabled");
  var table = $('#tablaListadoPerfiles').DataTable();
  var idPerfil = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPERFIL;
  });
  var nombrePerfil = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  $("#nombrePerfilAreas").val(nombrePerfil);
  var h = $(window).height() - 200;
  $("#bodyAreasPerfil").css("height",h);
  parametros = {
    "idPerfil": idPerfil[0]
  }
  //console.log(parametros);
  setTimeout(async function(){
    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/40);
    // console.log(largo);
    await $('#tablaListadoAreasPerfiles').DataTable( {
        ajax: {
            url: "controller/datosListaAreasPerfiles.php",
            type: 'POST',
            data: parametros,
        },
        columns: [
            { data: 'S'},
            { data: 'IDAREAWEB' },
            { data: 'TEXTOPADRE' },
            { data: 'TEXTO' },
            { data: 'TIPO_PERMISO' },
            { data: 'BASICO' },
            { data: 'FILTRO' }
        ],
        //responsive: true,
        buttons: [
          {
            extend: 'excel',
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          }
        ],
        "columnDefs": [
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "width": "5px",
            "targets": 0
          },
          {
            "visible": false,
            "searchable": false,
            "targets": [ 1 ]
          },
          {
            "visible": false,
            "searchable": false,
            "targets": [ 5 ]
          },
        ],
        "select": {
            style: 'single'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        // "order": [[ 3, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'Bfrtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
          $('#footer').show();
          setTimeout(function(){
            $("#modalAreasPerfil").modal('show');
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaListadoAreasPerfiles').DataTable().columns.adjust();
            },500);
          },200);
        }
    });
    if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      var h = $(window).height() - 300;
      $("#bodyAreasPerfil").css("height",h);
    }
    await esconderMenu();
  },100);
});

$("#asignarAreaPerfil").unbind('click').click(async function(){
  $("#modalAreasPerfil").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#selectArea").removeAttr("disabled");
  $("#dispoArea").removeAttr("disabled");
  $("#selectArea").val('');
  $("#dispoArea").val('');
  var table = $('#tablaListadoPerfiles').DataTable();
  var idPerfil = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPERFIL;
  });
  var nombrePerfil = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  $("#nombreAgregarAreaPerfil").val(nombrePerfil);
  parametros = {
    "idPerfil": idPerfil[0]
  }

  var table = $("#tablaListadoAreasPerfiles").DataTable();
  var datos = table.rows().data();

  await $.ajax({
    url:   'controller/datosAreas.php',
    type:  'post',
    data: parametros,
    success:  function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var cuerpoEpp = "";
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoEpp += "<option value=" + p.aaData[i].IDAREAWEB + ">&nbsp;&nbsp;" + p.aaData[i].AREA + "</option>";
        }
        $("#areaPerfil").html(cuerpoEpp);

        if(datos.length > 0){
          for(j = 0; j < datos.length; j++){
              // console.log(datos[j].IDAREAWEB);
              $("#areaPerfil option[value=" + datos[j].IDAREAWEB + "]").prop("selected", true);
          };
        }
        setTimeout(function(){
          $("#modalAgregarAreaPerfil").modal('show');
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });

  $("#areaPerfil").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
});

$("#guardarAgregarAreaPerfil").unbind('click').click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalAgregarAreaPerfil").modal('hide');
  var table = $('#tablaListadoPerfiles').DataTable();
  var idPerfil = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPERFIL;
  });

  var parametros = [];
  parametros.push(idPerfil[0]);
  parametros.push($("#areaPerfil").val());
  $.ajax({
    url:   'controller/ingresaMultiseleccionAreas.php',
    type:  'post',
    data:  {'parametros': JSON.stringify(parametros)},
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoAreasPerfiles').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Actualizado correctamente");
          if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            var h = $(window).height() - 300;
            $("#bodyAreasPerfil").css("height",h);
          }
          setTimeout(function(){
            $("#modalAgregarAreaPerfil").modal('hide');
            $("#modalAreasPerfil").modal('show');
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaListadoAreasPerfiles').DataTable().columns.adjust();
            },200);
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al agregar areas, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $("#modalAgregarAreaPerfil").modal('show');
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaListadoAreasPerfiles').DataTable().columns.adjust();
            },200);
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al agregar areas, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $("#modalAgregarAreaPerfil").modal('show');
          $('#modalAlertasSplash').modal('hide');
          setTimeout(function(){
            $('#tablaListadoAreasPerfiles').DataTable().columns.adjust();
          },200);
        },500);
      }
    }
  });
  $("#areaPerfil").multiSelect('deselect_all');
  $("#dispoArea").val('');
  $("#selectarea").val('');
});

$("#cancelarAgregarAreaPerfil").unbind("click").click(function(){
  $("#areaPerfil").multiSelect('deselect_all');
  $("#dispoArea").val('');
  $("#selectarea").val('');
  if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    var h = $(window).height() - 300;
    $("#bodyAreasPerfil").css("height",h);
  }
  $("#modalAreasPerfil").modal('show');
  setTimeout(function(){
    $('#tablaListadoAreasPerfiles').DataTable().columns.adjust();
  },200);
});

$("#asignarPermisosPerfil").unbind('click').click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalAreasPerfil").modal('hide');
  $("#divAccionesPerfil").html('');
  $("#divAccionesPerfil").hide();
  $("#checkJefaturaPermisos").prop("checked",false);
  $("#checkJefaturaPermisos").removeAttr("disabled");
  $("#checkTodosPermisos").prop("checked",false);
  $("#checkTodosPermisos").removeAttr("disabled");
  var table = $('#tablaListadoPerfiles').DataTable();
  var idPerfil = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPERFIL;
  });
  var nombrePerfil = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  var table = $('#tablaListadoAreasPerfiles').DataTable();
  var nombreArea = $.map(table.rows('.selected').data(), function (item) {
      return item.TEXTO;
  });
  var tipoPermiso = $.map(table.rows('.selected').data(), function (item) {
      return item.TIPO_PERMISO;
  });
  var idAreaWeb = $.map(table.rows('.selected').data(), function (item) {
      return item.IDAREAWEB;
  });
  var basico = $.map(table.rows('.selected').data(), function (item) {
      return item.BASICO;
  });
  var filtro = $.map(table.rows('.selected').data(), function (item) {
      return item.FILTRO;
  });

  $("#divProyecto").html('');
  $("#divAreaFuncional").html('');

  $("#divProyecto").append('<label style="font-weight: bold; color: gray; font-size: 14pt;">Proyectos</label><select multiple="multiple" id="proyectoPerfil" name="proyectoPerfil" class="form-control custom"></select>');
  $("#divAreaFuncional").append('<label style="font-weight: bold; color: gray; font-size: 14pt;">Areas Geográficas</label><select multiple="multiple" id="areaFuncionalPerfil" name="areaFuncionalPerfil" class="form-control custom"></select>');

  if(basico[0] === "jefatura"){
    $("#tituloPermisosPerfil").html("<br>Este módulo solo puede tener permiso \"JEFATURA\"");
    $("#tituloPermisosPerfil").css("color","red");
    $("#nombrePerfilPermiso").val(nombrePerfil);
    $("#nombreAreaPermiso").val(nombreArea);
    $("#filtroInformePermisos").val(filtro);
    $("#checkTodosPermisos").attr("disabled","disabled");
    $("#checkJefaturaPermisos").attr("disabled","disabled");

    $("#checkTodosPermisos").prop("checked",false);
    $("#checkJefaturaPermisos").prop("checked",true);
    var parametros = {
      "idPerfil": idPerfil[0],
      "idAreaWeb": idAreaWeb[0]
    }
    $("#proyectoPerfil").attr("disabled","disabled");
    $("#areaFuncionalPerfil").attr("disabled","disabled");
    await $.ajax({
      url:   'controller/datosProyecto.php',
      type:  'post',
      data: parametros,
      success:  function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
          var cuerpoEpp = "";
          for(var i = 0; i < p.aaData.length; i++){
            if(p.aaData[i].IDESTRUCTURA_OPERACION !== null){
              cuerpoEpp += "<option selected value=" + p.aaData[i].ID_ESTRUCTURA + ">&nbsp;&nbsp;" + p.aaData[i].PROYECTO + "</option>";
            }
            else{
              cuerpoEpp += "<option value=" + p.aaData[i].ID_ESTRUCTURA + ">&nbsp;&nbsp;" + p.aaData[i].PROYECTO + "</option>";
            }
          }
          $("#proyectoPerfil").html(cuerpoEpp);
          $("#proyectoPerfil").multiSelect({
            selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
            selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
            selectableHeader: "<input id='dispoProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
            selectionHeader: "<input id='selectProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
            afterInit: function(ms){
              var that = this,
                  $selectableSearch = that.$selectableUl.prev(),
                  $selectionSearch = that.$selectionUl.prev(),
                  selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                  selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

              that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
              .on('keydown', function(e){
                if (e.which === 40){
                  that.$selectableUl.focus();
                  return false;
                }
              });

              that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
              .on('keydown', function(e){
                if (e.which == 40){
                  that.$selectionUl.focus();
                  return false;
                }
              });
            },
            afterSelect: function(){
              this.qs1.cache();
              this.qs2.cache();
            },
            afterDeselect: function(){
              this.qs1.cache();
              this.qs2.cache();
            }
          });
        }
      }
    });
    await $.ajax({
      url:   'controller/datosAreaFuncionalPermisos.php',
      type:  'post',
      data: parametros,
      success:  function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
          var cuerpoEpp = "";
          for(var i = 0; i < p.aaData.length; i++){
            if(p.aaData[i].IDPERMISOS_AE !== null){
              cuerpoEpp += "<option selected value=" + p.aaData[i].IDAREAFUNCIONAL + ">&nbsp;&nbsp;" + p.aaData[i].COMUNA + "</option>";
            }
            else{
              cuerpoEpp += "<option value=" + p.aaData[i].IDAREAFUNCIONAL + ">&nbsp;&nbsp;" + p.aaData[i].COMUNA + "</option>";
            }
          }
          $("#areaFuncionalPerfil").html(cuerpoEpp);
          $("#areaFuncionalPerfil").multiSelect({
            selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
            selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
            selectableHeader: "<input id='dispoAreaFun' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
            selectionHeader: "<input id='selectAreaFun' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
            afterInit: function(ms){
              var that = this,
                  $selectableSearch = that.$selectableUl.prev(),
                  $selectionSearch = that.$selectionUl.prev(),
                  selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                  selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

              that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
              .on('keydown', function(e){
                if (e.which === 40){
                  that.$selectableUl.focus();
                  return false;
                }
              });

              that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
              .on('keydown', function(e){
                if (e.which == 40){
                  that.$selectionUl.focus();
                  return false;
                }
              });
            },
            afterSelect: function(){
              this.qs1.cache();
              this.qs2.cache();
            },
            afterDeselect: function(){
              this.qs1.cache();
              this.qs2.cache();
            }
          });
        }
      }
    });
    await $.ajax({
      url:   'controller/datosAccionesAreaWebPerfil.php',
      type:  'post',
      data:   parametros,
      success:  function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
          $("#divAccionesPerfil").append('<hr class="hr-separador"><div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="text-align: left;"><label style="font-weight: bold; color: gray; font-size: 14pt;">Tareas</label></div>');
          for(var i = 0; i < p.aaData.length; i++){
            if(p.aaData[i].VISIBLE == 1){
              $("#divAccionesPerfil").append('<div class="col-xl-3 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm"><label style="font-weight: bold;">' + p.aaData[i].TEXTO + '</label><br><label class="switch"><input id="id_' + p.aaData[i].IDBOTON + '" type="checkbox" checked="checked" title="' + p.aaData[i].TEXTO + '"><span class="slider round"></span></label></div>');
            }
            else{
              $("#divAccionesPerfil").append('<div class="col-xl-3 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm"><label style="font-weight: bold;">' + p.aaData[i].TEXTO + '</label><br><label class="switch"><input id="id_' + p.aaData[i].IDBOTON + '" type="checkbox" title="' + p.aaData[i].TEXTO + '"><span class="slider round"></span></label></div>');
            }
          }
          $("#divAccionesPerfil").show();
        }
        else{
          $("#divAccionesPerfil").html('');
          $("#divAccionesPerfil").hide();
        }
      }
    });
    var h = $(window).height() - 200;
    $("#bodyPermisosPerfil").css("height",h);
    $("#modalAreasPerfil").modal('hide');
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
      $("#modalPermisosPerfil").modal('show');
    },1500);
  }
  else if(basico[0] === "todos"){
    $("#tituloPermisosPerfil").html("<br>Este módulo solo puede tener permiso \"TODOS\"");
    $("#tituloPermisosPerfil").css("color","red");
    $("#nombrePerfilPermiso").val(nombrePerfil);
    $("#nombreAreaPermiso").val(nombreArea);
    $("#filtroInformePermisos").val(filtro);
    $("#checkTodosPermisos").attr("disabled","disabled");
    $("#checkJefaturaPermisos").attr("disabled","disabled");

    $("#checkTodosPermisos").prop("checked",true);
    $("#checkJefaturaPermisos").prop("checked",false);
    var parametros = {
      "idPerfil": idPerfil[0],
      "idAreaWeb": idAreaWeb[0]
    }
    $("#proyectoPerfil").attr("disabled","disabled");
    $("#areaFuncionalPerfil").attr("disabled","disabled");
    await $.ajax({
      url:   'controller/datosAreaFuncionalPermisos.php',
      type:  'post',
      data: parametros,
      success:  function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
          var cuerpoEpp = "";
          for(var i = 0; i < p.aaData.length; i++){
            if(p.aaData[i].IDPERMISOS_AE !== null){
              cuerpoEpp += "<option selected value=" + p.aaData[i].IDAREAFUNCIONAL + ">&nbsp;&nbsp;" + p.aaData[i].COMUNA + "</option>";
            }
            else{
              cuerpoEpp += "<option value=" + p.aaData[i].IDAREAFUNCIONAL + ">&nbsp;&nbsp;" + p.aaData[i].COMUNA + "</option>";
            }
          }
          $("#areaFuncionalPerfil").html(cuerpoEpp);
          $("#areaFuncionalPerfil").multiSelect({
            selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
            selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
            selectableHeader: "<input id='dispoAreaFun' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
            selectionHeader: "<input id='selectAreaFun' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
            afterInit: function(ms){
              var that = this,
                  $selectableSearch = that.$selectableUl.prev(),
                  $selectionSearch = that.$selectionUl.prev(),
                  selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                  selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

              that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
              .on('keydown', function(e){
                if (e.which === 40){
                  that.$selectableUl.focus();
                  return false;
                }
              });

              that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
              .on('keydown', function(e){
                if (e.which == 40){
                  that.$selectionUl.focus();
                  return false;
                }
              });
            },
            afterSelect: function(){
              this.qs1.cache();
              this.qs2.cache();
            },
            afterDeselect: function(){
              this.qs1.cache();
              this.qs2.cache();
            }
          });
        }
      }
    });
    await $.ajax({
      url:   'controller/datosAccionesAreaWebPerfil.php',
      type:  'post',
      data:   parametros,
      success:  function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
          $("#divAccionesPerfil").append('<hr class="hr-separador"><div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="text-align: left;"><label style="font-weight: bold; color: gray; font-size: 14pt;">Tareas</label></div>');
          for(var i = 0; i < p.aaData.length; i++){
            if(p.aaData[i].VISIBLE == 1){
              $("#divAccionesPerfil").append('<div class="col-xl-3 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm"><label style="font-weight: bold;">' + p.aaData[i].TEXTO + '</label><br><label class="switch"><input id="id_' + p.aaData[i].IDBOTON + '" type="checkbox" checked="checked" title="' + p.aaData[i].TEXTO + '"><span class="slider round"></span></label></div>');
            }
            else{
              $("#divAccionesPerfil").append('<div class="col-xl-3 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm"><label style="font-weight: bold;">' + p.aaData[i].TEXTO + '</label><br><label class="switch"><input id="id_' + p.aaData[i].IDBOTON + '" type="checkbox" title="' + p.aaData[i].TEXTO + '"><span class="slider round"></span></label></div>');
            }
          }
          $("#divAccionesPerfil").show();
        }
        else{
          $("#divAccionesPerfil").html('');
          $("#divAccionesPerfil").hide();
        }
      }
    });
    await $.ajax({
      url:   'controller/datosProyecto.php',
      type:  'post',
      data: parametros,
      success:  function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
          var cuerpoEpp = "";
          for(var i = 0; i < p.aaData.length; i++){
            if(p.aaData[i].IDESTRUCTURA_OPERACION !== null){
              cuerpoEpp += "<option selected value=" + p.aaData[i].ID_ESTRUCTURA + ">&nbsp;&nbsp;" + p.aaData[i].PROYECTO + "</option>";
            }
            else{
              cuerpoEpp += "<option value=" + p.aaData[i].ID_ESTRUCTURA + ">&nbsp;&nbsp;" + p.aaData[i].PROYECTO + "</option>";
            }
          }
          $("#proyectoPerfil").html(cuerpoEpp);
          $("#proyectoPerfil").multiSelect({
            selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
            selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
            selectableHeader: "<input id='dispoProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
            selectionHeader: "<input id='selectProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
            afterInit: function(ms){
              var that = this,
                  $selectableSearch = that.$selectableUl.prev(),
                  $selectionSearch = that.$selectionUl.prev(),
                  selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                  selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

              that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
              .on('keydown', function(e){
                if (e.which === 40){
                  that.$selectableUl.focus();
                  return false;
                }
              });

              that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
              .on('keydown', function(e){
                if (e.which == 40){
                  that.$selectionUl.focus();
                  return false;
                }
              });
            },
            afterSelect: function(){
              this.qs1.cache();
              this.qs2.cache();
            },
            afterDeselect: function(){
              this.qs1.cache();
              this.qs2.cache();
            }
          });
        }
      }
    });

    var h = $(window).height() - 200;
    $("#bodyPermisosPerfil").css("height",h);
    $("#modalAreasPerfil").modal('hide');
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
      $("#modalPermisosPerfil").modal('show');
    },1500);
  }
  else{
    $("#tituloPermisosPerfil").html('');
    $("#checkTodosPermisos").removeAttr("disabled");
    $("#checkJefaturaPermisos").removeAttr("disabled");
    $("#nombrePerfilPermiso").val(nombrePerfil);
    $("#nombreAreaPermiso").val(nombreArea);
    $("#filtroInformePermisos").val(filtro);
    setTimeout(async function(){
      if (tipoPermiso[0] === 'JEFATURA'){
        $("#checkJefaturaPermisos").prop("checked",true);
        $("#checkTodosPermisos").prop("checked",false);
        var parametros = {
          "idPerfil": idPerfil[0],
          "idAreaWeb": idAreaWeb[0]
        }
        $("#proyectoPerfil").attr("disabled","disabled");
        $("#areaFuncionalPerfil").attr("disabled","disabled");
        await $.ajax({
          url:   'controller/datosProyecto.php',
          type:  'post',
          data: parametros,
          success:  function (response) {
            var p = jQuery.parseJSON(response);
            if(p.aaData.length !== 0){
              var cuerpoEpp = "";
              for(var i = 0; i < p.aaData.length; i++){
                if(p.aaData[i].IDESTRUCTURA_OPERACION !== null){
                  cuerpoEpp += "<option selected value=" + p.aaData[i].ID_ESTRUCTURA + ">&nbsp;&nbsp;" + p.aaData[i].PROYECTO + "</option>";
                }
                else{
                  cuerpoEpp += "<option value=" + p.aaData[i].ID_ESTRUCTURA + ">&nbsp;&nbsp;" + p.aaData[i].PROYECTO + "</option>";
                }
              }
              $("#proyectoPerfil").html(cuerpoEpp);
              $("#proyectoPerfil").multiSelect({
                selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
                selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
                selectableHeader: "<input id='dispoProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                selectionHeader: "<input id='selectProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                afterInit: function(ms){
                  var that = this,
                      $selectableSearch = that.$selectableUl.prev(),
                      $selectionSearch = that.$selectionUl.prev(),
                      selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                      selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

                  that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
                  .on('keydown', function(e){
                    if (e.which === 40){
                      that.$selectableUl.focus();
                      return false;
                    }
                  });

                  that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
                  .on('keydown', function(e){
                    if (e.which == 40){
                      that.$selectionUl.focus();
                      return false;
                    }
                  });
                },
                afterSelect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                },
                afterDeselect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                }
              });
            }
          }
        });
        await $.ajax({
          url:   'controller/datosAreaFuncionalPermisos.php',
          type:  'post',
          data: parametros,
          success:  function (response) {
            var p = jQuery.parseJSON(response);
            if(p.aaData.length !== 0){
              var cuerpoEpp = "";
              for(var i = 0; i < p.aaData.length; i++){
                if(p.aaData[i].IDPERMISOS_AE !== null){
                  cuerpoEpp += "<option selected value=" + p.aaData[i].IDAREAFUNCIONAL + ">&nbsp;&nbsp;" + p.aaData[i].COMUNA + "</option>";
                }
                else{
                  cuerpoEpp += "<option value=" + p.aaData[i].IDAREAFUNCIONAL + ">&nbsp;&nbsp;" + p.aaData[i].COMUNA + "</option>";
                }
              }
              $("#areaFuncionalPerfil").html(cuerpoEpp);
              $("#areaFuncionalPerfil").multiSelect({
                selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
                selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
                selectableHeader: "<input id='dispoAreaFun' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                selectionHeader: "<input id='selectAreaFun' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                afterInit: function(ms){
                  var that = this,
                      $selectableSearch = that.$selectableUl.prev(),
                      $selectionSearch = that.$selectionUl.prev(),
                      selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                      selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

                  that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
                  .on('keydown', function(e){
                    if (e.which === 40){
                      that.$selectableUl.focus();
                      return false;
                    }
                  });

                  that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
                  .on('keydown', function(e){
                    if (e.which == 40){
                      that.$selectionUl.focus();
                      return false;
                    }
                  });
                },
                afterSelect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                },
                afterDeselect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                }
              });
            }
          }
        });
        await $.ajax({
          url:   'controller/datosAccionesAreaWebPerfil.php',
          type:  'post',
          data:   parametros,
          success:  function (response) {
            var p = jQuery.parseJSON(response);
            if(p.aaData.length !== 0){
              $("#divAccionesPerfil").append('<hr class="hr-separador"><div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="text-align: left;"><label style="font-weight: bold; color: gray; font-size: 14pt;">Tareas</label></div>');
              for(var i = 0; i < p.aaData.length; i++){
                if(p.aaData[i].VISIBLE == 1){
                  $("#divAccionesPerfil").append('<div class="col-xl-3 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm"><label style="font-weight: bold;">' + p.aaData[i].TEXTO + '</label><br><label class="switch"><input id="id_' + p.aaData[i].IDBOTON + '" type="checkbox" checked="checked" title="' + p.aaData[i].TEXTO + '"><span class="slider round"></span></label></div>');
                }
                else{
                  $("#divAccionesPerfil").append('<div class="col-xl-3 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm"><label style="font-weight: bold;">' + p.aaData[i].TEXTO + '</label><br><label class="switch"><input id="id_' + p.aaData[i].IDBOTON + '" type="checkbox" title="' + p.aaData[i].TEXTO + '"><span class="slider round"></span></label></div>');
                }
              }
              $("#divAccionesPerfil").show();
            }
            else{
              $("#divAccionesPerfil").html('');
              $("#divAccionesPerfil").hide();
            }
          }
        });

        var h = $(window).height() - 200;
        $("#bodyPermisosPerfil").css("height",h);
        $("#modalAreasPerfil").modal('hide');
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalPermisosPerfil").modal('show');
        },1500);
      }
      else if (tipoPermiso[0] === 'TODOS'){
        $("#checkTodosPermisos").prop("checked",true);
        $("#checkJefaturaPermisos").prop("checked",false);
        var parametros = {
          "idPerfil": idPerfil[0],
          "idAreaWeb": idAreaWeb[0]
        }
        $("#proyectoPerfil").attr("disabled","disabled");
        $("#areaFuncionalPerfil").attr("disabled","disabled");
        await $.ajax({
          url:   'controller/datosProyecto.php',
          type:  'post',
          data: parametros,
          success:  function (response) {
            var p = jQuery.parseJSON(response);
            if(p.aaData.length !== 0){
              var cuerpoEpp = "";
              for(var i = 0; i < p.aaData.length; i++){
                if(p.aaData[i].IDESTRUCTURA_OPERACION !== null){
                  cuerpoEpp += "<option selected value=" + p.aaData[i].ID_ESTRUCTURA + ">&nbsp;&nbsp;" + p.aaData[i].PROYECTO + "</option>";
                }
                else{
                  cuerpoEpp += "<option value=" + p.aaData[i].ID_ESTRUCTURA + ">&nbsp;&nbsp;" + p.aaData[i].PROYECTO + "</option>";
                }
              }
              $("#proyectoPerfil").html(cuerpoEpp);
              $("#proyectoPerfil").multiSelect({
                selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
                selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
                selectableHeader: "<input id='dispoProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                selectionHeader: "<input id='selectProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                afterInit: function(ms){
                  var that = this,
                      $selectableSearch = that.$selectableUl.prev(),
                      $selectionSearch = that.$selectionUl.prev(),
                      selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                      selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

                  that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
                  .on('keydown', function(e){
                    if (e.which === 40){
                      that.$selectableUl.focus();
                      return false;
                    }
                  });

                  that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
                  .on('keydown', function(e){
                    if (e.which == 40){
                      that.$selectionUl.focus();
                      return false;
                    }
                  });
                },
                afterSelect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                },
                afterDeselect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                }
              });
            }
          }
        });
        await $.ajax({
          url:   'controller/datosAreaFuncionalPermisos.php',
          type:  'post',
          data: parametros,
          success:  function (response) {
            var p = jQuery.parseJSON(response);
            if(p.aaData.length !== 0){
              var cuerpoEpp = "";
              for(var i = 0; i < p.aaData.length; i++){
                if(p.aaData[i].IDPERMISOS_AE !== null){
                  cuerpoEpp += "<option selected value=" + p.aaData[i].IDAREAFUNCIONAL + ">&nbsp;&nbsp;" + p.aaData[i].COMUNA + "</option>";
                }
                else{
                  cuerpoEpp += "<option value=" + p.aaData[i].IDAREAFUNCIONAL + ">&nbsp;&nbsp;" + p.aaData[i].COMUNA + "</option>";
                }
              }
              $("#areaFuncionalPerfil").html(cuerpoEpp);
              $("#areaFuncionalPerfil").multiSelect({
                selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
                selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
                selectableHeader: "<input id='dispoAreaFun' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                selectionHeader: "<input id='selectAreaFun' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                afterInit: function(ms){
                  var that = this,
                      $selectableSearch = that.$selectableUl.prev(),
                      $selectionSearch = that.$selectionUl.prev(),
                      selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                      selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

                  that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
                  .on('keydown', function(e){
                    if (e.which === 40){
                      that.$selectableUl.focus();
                      return false;
                    }
                  });

                  that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
                  .on('keydown', function(e){
                    if (e.which == 40){
                      that.$selectionUl.focus();
                      return false;
                    }
                  });
                },
                afterSelect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                },
                afterDeselect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                }
              });
            }
          }
        });
        await $.ajax({
          url:   'controller/datosAccionesAreaWebPerfil.php',
          type:  'post',
          data:   parametros,
          success:  function (response) {
            var p = jQuery.parseJSON(response);
            if(p.aaData.length !== 0){
              $("#divAccionesPerfil").append('<hr class="hr-separador"><div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="text-align: left;"><label style="font-weight: bold; color: gray; font-size: 14pt;">Tareas</label></div>');
              for(var i = 0; i < p.aaData.length; i++){
                if(p.aaData[i].VISIBLE == 1){
                  $("#divAccionesPerfil").append('<div class="col-xl-3 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm"><label style="font-weight: bold;">' + p.aaData[i].TEXTO + '</label><br><label class="switch"><input id="id_' + p.aaData[i].IDBOTON + '" type="checkbox" checked="checked" title="' + p.aaData[i].TEXTO + '"><span class="slider round"></span></label></div>');
                }
                else{
                  $("#divAccionesPerfil").append('<div class="col-xl-3 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm"><label style="font-weight: bold;">' + p.aaData[i].TEXTO + '</label><br><label class="switch"><input id="id_' + p.aaData[i].IDBOTON + '" type="checkbox" title="' + p.aaData[i].TEXTO + '"><span class="slider round"></span></label></div>');
                }
              }
              $("#divAccionesPerfil").show();
            }
            else{
              $("#divAccionesPerfil").html('');
              $("#divAccionesPerfil").hide();
            }
          }
        });

        var h = $(window).height() - 200;
        $("#bodyPermisosPerfil").css("height",h);
        $("#modalAreasPerfil").modal('hide');
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalPermisosPerfil").modal('show');
        },1500);
      }
      else{
        $("#checkTodosPermisos").prop("checked",false);
        $("#checkJefaturaPermisos").prop("checked",false);
        var parametros = {
          "idPerfil": idPerfil[0],
          "idAreaWeb": idAreaWeb[0]
        }

        await $.ajax({
          url:   'controller/datosProyecto.php',
          type:  'post',
          data: parametros,
          success:  function (response) {
            var p = jQuery.parseJSON(response);
            if(p.aaData.length !== 0){
              var cuerpoEpp = "";
              for(var i = 0; i < p.aaData.length; i++){
                if(p.aaData[i].IDESTRUCTURA_OPERACION !== null){
                  cuerpoEpp += "<option selected value=" + p.aaData[i].ID_ESTRUCTURA + ">&nbsp;&nbsp;" + p.aaData[i].PROYECTO + "</option>";
                }
                else{
                  cuerpoEpp += "<option value=" + p.aaData[i].ID_ESTRUCTURA + ">&nbsp;&nbsp;" + p.aaData[i].PROYECTO + "</option>";
                }
              }
              $("#proyectoPerfil").html(cuerpoEpp);
              $("#proyectoPerfil").multiSelect({
                selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
                selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
                selectableHeader: "<input id='dispoProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                selectionHeader: "<input id='selectProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                afterInit: function(ms){
                  var that = this,
                      $selectableSearch = that.$selectableUl.prev(),
                      $selectionSearch = that.$selectionUl.prev(),
                      selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                      selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

                  that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
                  .on('keydown', function(e){
                    if (e.which === 40){
                      that.$selectableUl.focus();
                      return false;
                    }
                  });

                  that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
                  .on('keydown', function(e){
                    if (e.which == 40){
                      that.$selectionUl.focus();
                      return false;
                    }
                  });
                },
                afterSelect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                },
                afterDeselect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                }
              });
            }
          }
        });
        await $.ajax({
          url:   'controller/datosAreaFuncionalPermisos.php',
          type:  'post',
          data: parametros,
          success:  function (response) {
            var p = jQuery.parseJSON(response);
            if(p.aaData.length !== 0){
              var cuerpoEpp = "";
              for(var i = 0; i < p.aaData.length; i++){
                if(p.aaData[i].IDPERMISOS_AE !== null){
                  cuerpoEpp += "<option selected value=" + p.aaData[i].IDAREAFUNCIONAL + ">&nbsp;&nbsp;" + p.aaData[i].COMUNA + "</option>";
                }
                else{
                  cuerpoEpp += "<option value=" + p.aaData[i].IDAREAFUNCIONAL + ">&nbsp;&nbsp;" + p.aaData[i].COMUNA + "</option>";
                }
              }
              $("#areaFuncionalPerfil").html(cuerpoEpp);
              $("#areaFuncionalPerfil").multiSelect({
                selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
                selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
                selectableHeader: "<input id='dispoAreaFun' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                selectionHeader: "<input id='selectAreaFun' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
                afterInit: function(ms){
                  var that = this,
                      $selectableSearch = that.$selectableUl.prev(),
                      $selectionSearch = that.$selectionUl.prev(),
                      selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                      selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

                  that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
                  .on('keydown', function(e){
                    if (e.which === 40){
                      that.$selectableUl.focus();
                      return false;
                    }
                  });

                  that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
                  .on('keydown', function(e){
                    if (e.which == 40){
                      that.$selectionUl.focus();
                      return false;
                    }
                  });
                },
                afterSelect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                },
                afterDeselect: function(){
                  this.qs1.cache();
                  this.qs2.cache();
                }
              });
            }
          }
        });
        await $.ajax({
          url:   'controller/datosAccionesAreaWebPerfil.php',
          type:  'post',
          data:   parametros,
          success:  function (response) {
            var p = jQuery.parseJSON(response);
            if(p.aaData.length !== 0){
              $("#divAccionesPerfil").append('<hr class="hr-separador"><div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="text-align: left;"><label style="font-weight: bold; color: gray; font-size: 14pt;">Tareas</label></div>');
              for(var i = 0; i < p.aaData.length; i++){
                if(p.aaData[i].VISIBLE == 1){
                  $("#divAccionesPerfil").append('<div class="col-xl-3 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm"><label style="font-weight: bold;">' + p.aaData[i].TEXTO + '</label><br><label class="switch"><input id="id_' + p.aaData[i].IDBOTON + '" type="checkbox" checked="checked" title="' + p.aaData[i].TEXTO + '"><span class="slider round"></span></label></div>');
                }
                else{
                  $("#divAccionesPerfil").append('<div class="col-xl-3 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm"><label style="font-weight: bold;">' + p.aaData[i].TEXTO + '</label><br><label class="switch"><input id="id_' + p.aaData[i].IDBOTON + '" type="checkbox" title="' + p.aaData[i].TEXTO + '"><span class="slider round"></span></label></div>');
                }
              }
              $("#divAccionesPerfil").show();
            }
            else{
              $("#divAccionesPerfil").html('');
              $("#divAccionesPerfil").hide();
            }
          }
        });

        var h = $(window).height() - 200;
        $("#bodyPermisosPerfil").css("height",h);
        $("#modalAreasPerfil").modal('hide');
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalPermisosPerfil").modal('show');
        },1500);
      }
    },100);
  }
});

$("#checkJefaturaPermisos").unbind('click').change(function(){
  if($("#checkJefaturaPermisos").prop("checked") == true){
    $("#proyectoPerfil").attr("disabled","disabled");
    $("#proyectoPerfil").multiSelect('refresh');
    //$("#checkTodosPermisos").multiSelect('refresh');
    setTimeout(function(){
      $(".search-input.form-control").attr("disabled","disabled");
    },100);
    $("#areaFuncionalPerfil").attr("disabled","disabled");
    $("#areaFuncionalPerfil").multiSelect('refresh');
    // $("#checkTodosPermisos").attr("disabled","disabled");
    $("#checkTodosPermisos").prop("checked",false);
  }
  else{
    $("#proyectoPerfil").removeAttr("disabled");
    $("#proyectoPerfil").multiSelect('refresh');
    $(".search-input.form-control").removeAttr("disabled");
    $("#areaFuncionalPerfil").removeAttr("disabled");
    $("#areaFuncionalPerfil").multiSelect('refresh');
    $("#checkTodosPermisos").removeAttr("disabled");
  }
});

$("#checkTodosPermisos").unbind('click').change(function(){
  if($("#checkTodosPermisos").prop("checked") == true){
    $("#proyectoPerfil").attr("disabled","disabled");
    $("#proyectoPerfil").multiSelect('refresh');
    //$("#checkTodosPermisos").multiSelect('refresh');
    setTimeout(function(){
      $(".search-input.form-control").attr("disabled","disabled");
    },100);
    $("#areaFuncionalPerfil").attr("disabled","disabled");
    $("#areaFuncionalPerfil").multiSelect('refresh');
    // $("#checkJefaturaPermisos").attr("disabled","disabled");
    $("#checkJefaturaPermisos").prop("checked",false);
  }
  else{
    $("#proyectoPerfil").removeAttr("disabled");
    $("#proyectoPerfil").multiSelect('refresh');
    $(".search-input.form-control").removeAttr("disabled");
    $("#areaFuncionalPerfil").removeAttr("disabled");
    $("#areaFuncionalPerfil").multiSelect('refresh');
    $("#checkJefaturaPermisos").removeAttr("disabled");
  }
});

$("#guardarPermisoPerfil").unbind('click').click(async function(){
  var table = $('#tablaListadoPerfiles').DataTable();
  var idPerfil = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPERFIL;
  });
  var table = $('#tablaListadoAreasPerfiles').DataTable();
  var idArea = $.map(table.rows('.selected').data(), function (item) {
      return item.IDAREAWEB;
  });
  var filtro = $("#filtroInformePermisos").val();
  var todos = 0;
  var jefatura = 0;

  if($("#checkJefaturaPermisos").prop('checked') == false && $("#checkTodosPermisos").prop('checked') == false && $("#proyectoPerfil").val().length === 0 &&
  $("#areaFuncionalPerfil").val().length === 0)
  {
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede guardar sin seleccionar ningún permiso");
  }
  else{
    $("#modalPermisosPerfil").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    if($("#checkJefaturaPermisos").prop('checked')){
      var parametros = {
        "idPerfil": idPerfil[0],
        "idArea": idArea[0],
        "jefatura": 1,
        "todos": 0,
        "filtro": filtro
      }

      $("input[id^='id_']").each(function(){
    	    if($(this).prop("checked") === true){
            parametros["accion_" + $(this).attr("id").split("_")[1]] = '1';
          }
          else{
            parametros["accion_" + $(this).attr("id").split("_")[1]] = '0';
          }
    	});

      console.log(parametros);
      $.ajax({
        url:   'controller/ingresaPermisosAreas.php',
        type:  'post',
        data:  parametros,
        success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var table = $('#tablaListadoAreasPerfiles').DataTable();
              table.ajax.reload();
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                var h = $(window).height() - 300;
                $("#bodyAreasPerfil").css("height",h);
              }

              $.ajax({
                url:   'controller/ingresarPermisoAccionesPerfil.php',
                type:  'post',
                data:  parametros,
                success:  function (response) {
                  setTimeout(function(){
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Asignado correctamente");
                    $("#modalAreasPerfil").modal('show');
                    $('#modalPermisosPerfil').modal('hide');
                    $('#modalAlertasSplash').modal('hide');
                    setTimeout(function(){
                      $('#tablaListadoAreasPerfiles').DataTable().columns.adjust();
                    },500);
                  },1500);
                }
              });
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar permisos, si el problema persiste favor comuniquese con soporte");
              setTimeout(function(){
                $("#modalAreasPerfil").modal('show');
                $('#modalPermisosPerfil').modal('hide');
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar permisos, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $("#modalAreasPerfil").modal('show');
              $('#modalPermisosPerfil').modal('hide');
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
      });
    }
    else if($("#checkTodosPermisos").prop('checked')){
      var parametros = {
        "idPerfil": idPerfil[0],
        "idArea": idArea[0],
        "jefatura": 0,
        "todos": 1,
        "filtro": filtro
      }

      $("input[id^='id_']").each(function(){
    	    if($(this).prop("checked") === true){
            parametros["accion_" + $(this).attr("id").split("_")[1]] = '1';
          }
          else{
            parametros["accion_" + $(this).attr("id").split("_")[1]] = '0';
          }
    	});

      // console.log(parametros);
      $.ajax({
        url:   'controller/ingresaPermisosAreas.php',
        type:  'post',
        data:  parametros,
        success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var table = $('#tablaListadoAreasPerfiles').DataTable();
              table.ajax.reload();
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                var h = $(window).height() - 300;
                $("#bodyAreasPerfil").css("height",h);
              }

              $.ajax({
                url:   'controller/ingresarPermisoAccionesPerfil.php',
                type:  'post',
                data:  parametros,
                success:  function (response) {
                  setTimeout(function(){
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Asignado correctamente");
                    $("#modalAreasPerfil").modal('show');
                    $('#modalPermisosPerfil').modal('hide');
                    $('#modalAlertasSplash').modal('hide');
                    setTimeout(function(){
                      $('#tablaListadoAreasPerfiles').DataTable().columns.adjust();
                    },500);
                  },1500);
                }
              });
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar permisos, si el problema persiste favor comuniquese con soporte");
              setTimeout(function(){
                $("#modalAreasPerfil").modal('show');
                $('#modalPermisosPerfil').modal('hide');
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar permisos, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $("#modalAreasPerfil").modal('show');
              $('#modalPermisosPerfil').modal('hide');
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
      });
    }
    else{
      var parametros = [];
      parametros.push(idPerfil[0]);
      parametros.push($("#areaFuncionalPerfil").val());
      parametros.push($("#proyectoPerfil").val());
      parametros.push(idArea[0]);
      $.ajax({
        url:   'controller/ingresaMultiseleccionPermisos.php',
        type:  'post',
        data:  {'parametros': JSON.stringify(parametros)},
        success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var table = $('#tablaListadoAreasPerfiles').DataTable();
              table.ajax.reload();
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                var h = $(window).height() - 300;
                $("#bodyAreasPerfil").css("height",h);
              }

              var parametros2 = {
                "idPerfil": idPerfil[0],
                "idArea": idArea[0]
              }

              $("input[id^='id_']").each(function(){
            	    if($(this).prop("checked") === true){
                    parametros2["accion_" + $(this).attr("id").split("_")[1]] = '1';
                  }
                  else{
                    parametros2["accion_" + $(this).attr("id").split("_")[1]] = '0';
                  }
            	});

              $.ajax({
                url:   'controller/ingresarPermisoAccionesPerfil.php',
                type:  'post',
                data:  parametros2,
                success:  function (response) {
                  setTimeout(function(){
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Permisos asignados correctamente");
                    $("#modalAreasPerfil").modal('show');
                    $('#modalPermisosPerfil').modal('hide');
                    $('#modalAlertasSplash').modal('hide');
                    setTimeout(function(){
                      $('#tablaListadoAreasPerfiles').DataTable().columns.adjust();
                    },500);
                  },1500);
                }
              });
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar permisos, si el problema persiste favor comuniquese con soporte");
              setTimeout(function(){
                $("#modalAreasPerfil").modal('show');
                $('#modalPermisosPerfil').modal('hide');
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el permisos, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $("#modalAreasPerfil").modal('show');
              $('#modalPermisosPerfil').modal('hide');
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
      });
    }
  }
});

$("#cancelarPermisoPerfil").unbind('click').click(function(){
  $("#proyectoPerfil").multiSelect('deselect_all');
  $("#areaFuncionalPerfil").multiSelect('deselect_all');
  $("#checkJefaturaPermisos").prop("checked",false);
  $("#checkJefaturaPermisos").removeAttr("disabled");
  $("#checkTodosPermisos").prop("checked",false);
  $("#checkTodosPermisos").removeAttr("disabled");
  if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    var h = $(window).height() - 300;
    $("#bodyAreasPerfil").css("height",h);
  }
  $("#modalAreasPerfil").modal('show');
  setTimeout(function(){
    $('#tablaListadoAreasPerfiles').DataTable().columns.adjust();
  },200);
});

$("#cambiarJefatura").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url:   'controller/datosJefes.php',
    type:  'get',
    success: function (jefes) {
      var jf = jQuery.parseJSON(jefes);
      if(jf.aaData.length !== 0){
        var cuerpoJF = '';
        for(var i = 0; i < jf.aaData.length; i++) {
          cuerpoJF += '<option id="' + jf.aaData[i].EMAIL + '" value="' + jf.aaData[i].RUTJEFEDIRECTO + '">' + jf.aaData[i].RUTJEFEDIRECTO + ' - ' + jf.aaData[i].JEFE + '</option>';
        }
        $("#selectJefes").html(cuerpoJF);
        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#selectJefes").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
      }
    }
  });

  setTimeout(function(){
    var h = $(window).height() - 200;
    // $("#bodyIngresoPersonalInterno").css("height",h);
    $("#modalCambiarJefatura").modal("show");
    $("#modalCambiarJefatura").css("z-index", "1050");
    $('#modalAlertasSplash').modal('hide');
    // setTimeout(function(){
    //  $('#bodyIngresoPersonalInterno').animate({ scrollTop: 0 }, 'fast');
    // }, 200);
  }, 500);
});

$("#guardarCambiarJefatura").unbind('click').click(async function() {
  $("#modalCambiarJefatura").modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaJefatura").DataTable();
  var datos = table.rows('.selected').data();

  var jsonExJefes = {};
  var strlstPersonal = { nombres: [], ids: [] };
  for(var i = 0; i < datos.length; i++) {
    if(datos[i].CONTACTO) jsonExJefes[datos[i].CONTACTO] = `${jsonExJefes[datos[i].CONTACTO] ?? ''} <br />${datos[i].NOMBRES}, ${datos[i].APELLIDOS}`;
    strlstPersonal['ids'] = `${strlstPersonal['ids']}, '${datos[i].IDPERSONAL}'`;
    strlstPersonal['nombres'] = `${strlstPersonal['nombres']} <br />${datos[i].NOMBRES}, ${datos[i].APELLIDOS}`;
  }
  strlstPersonal['ids'] = strlstPersonal['ids'].substring(1);
  strlstPersonal['nombres'] = strlstPersonal['nombres'].substring(1);

  var nombreNuevoJefe = $("#selectJefes option:selected").html().split(' - ')[1];
  var emailNuevoJefe = $("#selectJefes option:selected").attr("id");
  var rutNuevoJefe = $("#selectJefes option:selected").val();

  await $.ajax({
    url:   'controller/editarJefatura.php',
    type:  'POST',
    data:  {
      "rutNuevoJefe": rutNuevoJefe,
      "strlstPersonal": strlstPersonal
    },
    success: async function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaJefatura').DataTable();
          table.ajax.reload();
          setTimeout(function(){
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Jefaturas cambiadas correctamente");
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          setTimeout(function(){
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cambiar las jefaturas, si el problema persiste favor comuniquese con soporte");
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        setTimeout(function(){
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cambiar las jefaturas, si el problema persiste favor comuniquese con soporte");
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    },
  });

  await $.ajax({
    url:   'controller/editarJefaturaNotify.php',
    type:  'POST',
    data:  {
      "nombreNuevoJefe": nombreNuevoJefe,
      "emailNuevoJefe": emailNuevoJefe,
      "strlstPersonal": strlstPersonal,
      "lstExJefes": Object.entries(jsonExJefes)
    },
    complete: async function(){
    }
  });
});

$("#transferirJefatura").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/datosJefes.php',
    type:  'get',
    success: function (jefes) {
      var jf = jQuery.parseJSON(jefes);
      if(jf.aaData.length !== 0){
        var cuerpoJF = '<option value="0">Sin selección</option>';
        for(var i = 0; i < jf.aaData.length; i++) {
          cuerpoJF += '<option id="' + jf.aaData[i].EMAIL + '" value="' + jf.aaData[i].RUTJEFEDIRECTO + '">' + jf.aaData[i].RUTJEFEDIRECTO + ' - ' + jf.aaData[i].JEFE + '</option>';
        }
        $("#selectJefesTransfer").html(cuerpoJF);
        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#selectJefesTransfer").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
      }
    }
  });

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#modalTransferirJefatura").modal("show");
    $("#modalTransferirJefatura").css("z-index", "1050");
    $('#modalAlertasSplash').modal('hide');
  }, 500);
});

$('#selectJefesTransfer').change(function (e) {
  e.stopImmediatePropagation();
  e.preventDefault();

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectJefesTransfer").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();

  var jsonExJefes = {};
  var strlstPersonal = { nombres: [], dnis: [] };
  for(var i = 0; i < datos.length; i++) {
    if(datos[i].EMAIL) jsonExJefes[datos[i].EMAIL] = `${jsonExJefes[datos[i].EMAIL] ?? ''} <br />${datos[i].NOMBRE}`;
    strlstPersonal['dnis'] = `${strlstPersonal['dnis']},${datos[i].DNI}`;
    strlstPersonal['nombres'] = `${strlstPersonal['nombres']} <br />${datos[i].NOMBRE}`;
  }
  strlstPersonal['dnis'] = strlstPersonal['dnis'].substring(1);
  strlstPersonal['nombres'] = strlstPersonal['nombres'].substring(1);

  var nombreNuevoJefe = $("#selectJefesTransfer option:selected").html().split(' - ')[1];
  var emailNuevoJefe = $("#selectJefesTransfer option:selected").attr("id");
  var rutNuevoJefe = $("#selectJefesTransfer option:selected").val();

  // Advertencia Caso 1: No se puede transferir al mismo jefe
  if((Object.keys(jsonExJefes)).includes(emailNuevoJefe)) {
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede transferir personal a la jefatura que ya tiene asignada, una o más personas seleccionadas tienen esta condición");
    $('#guardarTransferirJefatura').attr("disabled","disabled");
  }
  else if((strlstPersonal['dnis'].split(',')).includes(rutNuevoJefe)) {
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede transferir personal a si mismo como jefatura, uno de los seleccionados tiene esta condición");
    $('#guardarTransferirJefatura').attr("disabled","disabled");
  }
  else {
    $('#guardarTransferirJefatura').removeAttr("disabled");
  }
})

$("#guardarTransferirJefatura").unbind('click').click(async function() {
  $("#modalTransferirJefatura").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  var table = $('#infoInformePersonal').DataTable().clear().draw();

  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();

  var jsonExJefes = {};
  var strlstPersonal = { nombres: [], dnis: [], ids: [] };
  for(var i = 0; i < datos.length; i++) {
    if(datos[i].EMAIL) jsonExJefes[datos[i].EMAIL] = `${jsonExJefes[datos[i].EMAIL] ?? ''} <br />${datos[i].NOMBRE}`;
    strlstPersonal['dnis'] = `${strlstPersonal['dnis']},'${datos[i].DNI}'`;
    strlstPersonal['nombres'] = `${strlstPersonal['nombres']} <br />${datos[i].NOMBRE}`;
    strlstPersonal['ids'] = `${strlstPersonal['ids']}, ${datos[i].IDPERSONAL}`;
  }
  strlstPersonal['dnis'] = strlstPersonal['dnis'].substring(1);
  strlstPersonal['nombres'] = strlstPersonal['nombres'].substring(1);
  strlstPersonal['ids'] = strlstPersonal['ids'].substring(1);

  var nombreNuevoJefe = $("#selectJefesTransfer option:selected").html().split(' - ')[1];
  var emailNuevoJefe = $("#selectJefesTransfer option:selected").attr("id");
  var rutNuevoJefe = $("#selectJefesTransfer option:selected").val();

  var response2;

  await $.ajax({
    url:   'controller/editarJefaturaTransfer.php',
    type:  'POST',
    data:  {
      "rutNuevoJefe": rutNuevoJefe,
      "strlstPersonal": strlstPersonal
    },
    success: function (response) {
      response2 = jQuery.parseJSON(response);
      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      setTimeout(async function(){
        if(response2.aaData.length >= 0){
          var table = $('#tablaPersonal').DataTable();
          table.rows( '.selected' ).remove().draw();
          $("#disponiblePersonal").attr("disabled","disabled");
          $("#ausentePersonal").attr("disabled","disabled");
          $("#transferirJefatura").attr("disabled","disabled");
          $("#transferirJefaturaRespuesta").attr("disabled","disabled");
          $("#solicitarJefaturaRespuesta").attr("disabled","disabled");
          $("#desasignarJefaturaRespuesta").attr("disabled","disabled");
          // ingresaModificacionPersonal(response2);
        }

        await $.ajax({
          url:   'controller/editarPersonalNotify.php',
          type:  'POST',
          data:  {
            "nombreNuevoJefe": nombreNuevoJefe,
            "emailNuevoJefe": emailNuevoJefe,
            "strlstPersonal": strlstPersonal,
            "lstExJefes": Object.entries(jsonExJefes)
          },
          complete: function(){
          }
        });

        var table = $("#tablaPersonal").DataTable();

        table.search( '' ).columns().search( '' ).draw();

        var vac = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Vacaciones' ? true : false;
        });
        var lic = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Licencia' ? true : false;
        });
        var des = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Desvinculado' ? true : false;
        });
        var pre = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Presente' ? true : false;
        });
        var pre_in = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Presente Inducción' ? true : false;
        });
        var pre_tel = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Presente Teletrabajo' ? true : false;
        });
        var pre_in_tel = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Presente Inducción Teletrabajo' ? true : false;
        });
        var ren = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Renuncia' ? true : false;
        });
        var per = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Permiso' ? true : false;
        });
        var aus = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Ausente' ? true : false;
        });
        var sin = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Sin marca' ? true : false;
        });
        var total = table
            .column(30, {search: 'applied'})
            .data();
        var directos = table
            .column(24, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == $("#nombreUsuarioPersonal").val() ? true : false;
        });

        var tablaInf = $('#infoInformePersonal').DataTable( {
          "select": {
              style: 'single'
          },
          columnDefs: [
            {
                targets: 0,
                className: 'leftDataTableCant'
            },
            {
                targets: 1,
                className: 'centerDataTableCant'
            }
          ],
          "scrollX": true,
          "paging": false,
          "searching": false,
          "ordering": false,
          "scrollCollapse": true,
          "order": [[ 0, "asc" ]],
          "info": true,
          "dom": 'frtp',
          "destroy": true,
          "language": {
            "zeroRecords": "No hay datos disponibles",
            "info": "Registro _START_ de _END_ de _TOTAL_",
            "infoEmpty": "No hay datos disponibles",
            "paginate": {
                "previous": "Anterior",
                "next": "Siguiente"
              },
              "search": "Buscar: ",
              "select": {
                  "rows": "- %d registros seleccionados"
              },
              "infoFiltered": "(Filtrado de _MAX_ registros)"
          },
          "destroy": true,
          "autoWidth": false,
          "initComplete": function( settings, json){
            $(this.api().column(1).footer()).html(total.count());
          }
        });
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
        tablaInf.draw();


        $("#qDirectos").html(directos.count());
        $("#qOtros").html(total.count() - directos.count());

        menuElegant();

        setTimeout(function(){
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Jefaturas transferidas correctamente");
          $('#modalAlertasSplash').modal('hide');
        },1000);
      },1000);
    },
  });
});

$("#transferirJefaturaRespuesta").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();

  $("#tituloTransferirJefaturaRespuesta").html(datos[0].NOMBRE);

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#modalTransferirJefaturaRespuesta").modal("show");
    $("#modalTransferirJefaturaRespuesta").css("z-index", "1050");
    $('#modalAlertasSplash').modal('hide');
  }, 500);
});

$("#aceptarTransferirJefaturaRespuesta").unbind("click").click(async function(){
  $('#modalTransferirJefaturaRespuesta').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();
  var dniPersonal = datos[0].DNI;

  var response2;

  await $.ajax({
    url:   'controller/editarJefaturaTransferOk.php',
    type:  'POST',
    data:  {
      "dniPersonal": dniPersonal
    },
    success: function (response) {
      response2 = jQuery.parseJSON(response);
      $('#transferirJefaturaRespuesta').attr("disabled","disabled");
      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      setTimeout(function(){
        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Jefaturas cambiadas correctamente");
        if(response2.aaData.length >= 0){
          var table = $('#tablaPersonal').DataTable();
          table.rows( '.selected' ).remove().draw();
          ingresaModificacionPersonal(response2);

          $("#disponiblePersonal").attr("disabled","disabled");
          $("#ausentePersonal").attr("disabled","disabled");
          $("#transferirJefatura").attr("disabled","disabled");
          $("#transferirJefaturaRespuesta").attr("disabled","disabled");
          $("#solicitarJefaturaRespuesta").attr("disabled","disabled");
          $("#desasignarJefaturaRespuesta").attr("disabled","disabled");
        }
        $('#modalAlertasSplash').modal('hide');
      },1000);
    }
  });

  var dataNotify = {
    "nombreNuevoJefe": response2.aaData2[0]['NUEVOJEFE'],
    "emailNuevoJefe": response2.aaData2[0]['EMAILNUEVOJEFE'],
    "strlstPersonal": {
      nombres: response2.aaData2[0]['PERSONAL'] ?? '',
      dnis: response2.aaData2[0]['DNI'] ?? ''
    },
    "lstExJefes": [ response2.aaData2[0]['EMAILANTIGUOJEFE'] ?? '' ]
  };
  // console.log(dataNotify);
  await $.ajax({
    url:   'controller/editarPersonalNotifyOk.php',
    type:  'POST',
    data:  dataNotify,
    complete: function(){
    }
  });
});

$("#rechazarTransferirJefaturaRespuesta").unbind("click").click(async function(){
  $('#modalTransferirJefaturaRespuesta').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();
  var dniPersonal = datos[0].DNI;

  var response2;

  await $.ajax({
    url:   'controller/editarJefaturaTransferNot.php',
    type:  'POST',
    data:  {
      "dniPersonal": dniPersonal
    },
    success: function (response) {
      response2 = jQuery.parseJSON(response);
      $('#transferirJefaturaRespuesta').attr("disabled","disabled");
      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      setTimeout(function(){
        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Jefaturas cambiadas correctamente");
        if(response2.aaData.length >= 0){
          var table = $('#tablaPersonal').DataTable();
          table.rows( '.selected' ).remove().draw();
          // ingresaModificacionPersonal(response2);

          $("#disponiblePersonal").attr("disabled","disabled");
          $("#ausentePersonal").attr("disabled","disabled");
          $("#transferirJefatura").attr("disabled","disabled");
          $("#transferirJefaturaRespuesta").attr("disabled","disabled");
          $("#solicitarJefaturaRespuesta").attr("disabled","disabled");
          $("#desasignarJefaturaRespuesta").attr("disabled","disabled");
        }
        $('#modalAlertasSplash').modal('hide');
      },1000);
    }
  });

  var dataNotify = {
    "nombreNuevoJefe": response2.aaData2[0]['NUEVOJEFE'],
    "emailNuevoJefe": response2.aaData2[0]['EMAILNUEVOJEFE'],
    "strlstPersonal": {
      nombres: response2.aaData2[0]['PERSONAL'] ?? '',
      dnis: response2.aaData2[0]['DNI'] ?? ''
    },
    "lstExJefes": [ response2.aaData2[0]['EMAILANTIGUOJEFE']??'' ]
  };
  // console.log(dataNotify);
  await $.ajax({
    url:   'controller/editarPersonalNotifyNot.php',
    type:  'POST',
    data:  dataNotify,
    complete: function(){
    }
  });
});

$("#solicitarJefatura").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#guardarSolicitarJefatura").attr("disabled", "disabled");

  var largo = Math.trunc(($(window).height() - ($(window).height()/70)*50)/30);
  await $('#tablaPersonalSolicitar').DataTable({
    ajax: {
        url: 'controller/datosPersonalSolicitud.php',
        type: 'POST'
    },
    columns: [
        { data: 'S'},
        { data: 'IDPERSONAL', className: "centerDataTable"},
        { data: 'RUT' } ,
        { data: 'NOMBRES' },
        { data: 'APELLIDOS' },
        { data: 'COLOR' },
        { data: 'RUTJEFEDIRECTO' },
        { data: 'JEFE' },
        { data: 'EMAIL' },
        { data: 'ESTADO' }
    ],
    //
    buttons: [
    ],
    // fixedColumns:   {
    //   leftColumns: 3
    // },
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 1 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 6 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 8 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 9 ]
      }
    ],
    "select": {
        style: 'multi',
        selector: 'td:not(:nth-child(2))'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "order": [[ 2, "asc" ]],
    "info": true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
        "zeroRecords": "No tiene personal bajo su cargo",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No tiene personal bajo su cargo",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)",
        "loadingRecords": "&nbsp;",
        "processing": "Loading..."
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      setTimeout(function(){
        $("#modalSolicitarJefatura").modal("show");
        $("#modalSolicitarJefatura").css("z-index", "1050");
        $('#modalAlertasSplash').modal('hide');
        setTimeout(function(){
          var table = $('#tablaPersonalSolicitar').DataTable();
          $('#tablaPersonalSolicitar').DataTable().columns.adjust();
        },500);
      }, 500);
    }
  });
});

$('#tablaPersonalSolicitar tbody').on( 'click', 'tr', function () {
  setTimeout(async function(){
    var table = $('#tablaPersonalSolicitar').DataTable();
    var datos = table.rows('.selected').data();
    if(datos.length) {
      $("#guardarSolicitarJefatura").removeAttr("disabled");
    } else {
      $("#guardarSolicitarJefatura").attr("disabled", "disabled");
    }
  }, 100);
});

$("#guardarSolicitarJefatura").unbind('click').click(async function() {
  $("#modalSolicitarJefatura").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  var table = $('#infoInformePersonal').DataTable().clear().draw();

  var table = $("#tablaPersonalSolicitar").DataTable();
  var datos = table.rows('.selected').data();

  var jsonExJefes = {};
  var strlstPersonalLibre = { nombresLibre: [], dnisLibre: [], idsLibre: [] };
  var strlstPersonal = { nombres: [], dnis: [], ids: [] };
  for(var i = 0; i < datos.length; i++) {
    if(datos[i].ESTADO === 'Libre'){
      strlstPersonalLibre['dnisLibre'] = `${strlstPersonalLibre['dnisLibre']},'${datos[i].RUT}'`;
      strlstPersonalLibre['nombresLibre'] = `${strlstPersonalLibre['nombresLibre']} <br />${datos[i].NOMBRES + ', ' + datos[i].APELLIDOS}`;
      strlstPersonalLibre['idsLibre'] = `${strlstPersonalLibre['idsLibre']}, ${datos[i].IDPERSONAL}`;
    }
    else{
      if(datos[i].EMAIL) jsonExJefes[datos[i].EMAIL] = `${jsonExJefes[datos[i].EMAIL] ?? ''} <br />${datos[i].NOMBRES + ', ' + datos[i].APELLIDOS}`;
      strlstPersonal['dnis'] = `${strlstPersonal['dnis']},'${datos[i].RUT}'`;
      strlstPersonal['nombres'] = `${strlstPersonal['nombres']} <br />${datos[i].NOMBRES + ', ' + datos[i].APELLIDOS}`;
      strlstPersonal['ids'] = `${strlstPersonal['ids']}, ${datos[i].IDPERSONAL}`;
    }
  }
  if(strlstPersonal['dnis'].length > 0){
    strlstPersonal['dnis'] = strlstPersonal['dnis'].substring(1);
    strlstPersonal['nombres'] = strlstPersonal['nombres'].substring(1);
    strlstPersonal['ids'] = strlstPersonal['ids'].substring(1);
  }
  if(strlstPersonalLibre['dnisLibre'].length > 0){
    strlstPersonalLibre['dnisLibre'] = strlstPersonalLibre['dnisLibre'].substring(1);
    strlstPersonalLibre['nombresLibre'] = strlstPersonalLibre['nombresLibre'].substring(1);
    strlstPersonalLibre['idsLibre'] = strlstPersonalLibre['idsLibre'].substring(1);
  }

  var response;

  if(strlstPersonalLibre['dnisLibre'].length > 0){
    setTimeout(async function(){
      await $.ajax({
        url:   'controller/editarJefaturaSolicitLibre.php',
        type:  'POST',
        data:  {
          "strlstPersonalLibre": strlstPersonalLibre
        },
        success: function (res1) {
          response = jQuery.parseJSON(res1);
          ingresaModificacionPersonal(response);
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Personal solicitado correctamente");
          setTimeout(function(){
            var table = $("#tablaPersonal").DataTable();
            var vac = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Vacaciones' ? true : false;
            });
            var lic = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Licencia' ? true : false;
            });
            var des = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Desvinculado' ? true : false;
            });
            var pre = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Presente' ? true : false;
            });
            var pre_in = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Presente Inducción' ? true : false;
            });
            var pre_tel = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Presente Teletrabajo' ? true : false;
            });
            var pre_in_tel = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Presente Inducción Teletrabajo' ? true : false;
            });
            var ren = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Renuncia' ? true : false;
            });
            var per = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Permiso' ? true : false;
            });
            var aus = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Ausente' ? true : false;
            });
            var sin = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Sin marca' ? true : false;
            });
            var total = table
                .column(30, {search: 'applied'})
                .data();
            var directos = table
                .column(24, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == $("#nombreUsuarioPersonal").val() ? true : false;
            });

            var tablaInf = $('#infoInformePersonal').DataTable( {
              "select": {
                  style: 'single'
              },
              columnDefs: [
                {
                    targets: 0,
                    className: 'leftDataTableCant'
                },
                {
                    targets: 1,
                    className: 'centerDataTableCant'
                }
              ],
              "scrollX": true,
              "paging": false,
              "searching": false,
              "ordering": false,
              "scrollCollapse": true,
              "order": [[ 0, "asc" ]],
              "info": true,
              "dom": 'frtp',
              "destroy": true,
              "language": {
                "zeroRecords": "No hay datos disponibles",
                "info": "Registro _START_ de _END_ de _TOTAL_",
                "infoEmpty": "No hay datos disponibles",
                "paginate": {
                    "previous": "Anterior",
                    "next": "Siguiente"
                  },
                  "search": "Buscar: ",
                  "select": {
                      "rows": "- %d registros seleccionados"
                  },
                  "infoFiltered": "(Filtrado de _MAX_ registros)"
              },
              "destroy": true,
              "autoWidth": false,
              "initComplete": function( settings, json){
                $(this.api().column(1).footer()).html(total.count());
              }
            });
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
            tablaInf.draw();


            $("#qDirectos").html(directos.count());
            $("#qOtros").html(total.count() - directos.count());

            menuElegant();

            $('#modalAlertasSplash').modal('hide');
          },500);

          $("#disponiblePersonal").attr("disabled","disabled");
          $("#ausentePersonal").attr("disabled","disabled");
          $("#transferirJefatura").attr("disabled","disabled");
          $("#transferirJefaturaRespuesta").attr("disabled","disabled");
          $("#solicitarJefaturaRespuesta").attr("disabled","disabled");
          $("#desasignarJefaturaRespuesta").attr("disabled","disabled");
        },
      });
    },100);
  }

  if(strlstPersonal['dnis'].length > 0){
    setTimeout(async function(){
      await $.ajax({
        url:   'controller/editarJefaturaSolicit.php',
        type:  'POST',
        data:  {
          "strlstPersonal": strlstPersonal
        },
        success: function (res2) {
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          $("#disponiblePersonal").attr("disabled","disabled");
          $("#ausentePersonal").attr("disabled","disabled");
          $("#transferirJefatura").attr("disabled","disabled");
          $("#transferirJefaturaRespuesta").attr("disabled","disabled");
          $("#solicitarJefaturaRespuesta").attr("disabled","disabled");
          $("#desasignarJefaturaRespuesta").attr("disabled","disabled");

          setTimeout(async function(){
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Personal solicitado correctamente");
            await $.ajax({
              url:   'controller/editarPersonalSolicNotify.php',
              type:  'POST',
              data:  {
                "strlstPersonal": strlstPersonal,
                "lstExJefes": Object.entries(jsonExJefes)
              },
              complete: function(){
              }
            });

            var table = $("#tablaPersonal").DataTable();
            var vac = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Vacaciones' ? true : false;
            });
            var lic = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Licencia' ? true : false;
            });
            var des = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Desvinculado' ? true : false;
            });
            var pre = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Presente' ? true : false;
            });
            var pre_in = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Presente Inducción' ? true : false;
            });
            var pre_tel = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Presente Teletrabajo' ? true : false;
            });
            var pre_in_tel = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Presente Inducción Teletrabajo' ? true : false;
            });
            var ren = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Renuncia' ? true : false;
            });
            var per = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Permiso' ? true : false;
            });
            var aus = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Ausente' ? true : false;
            });
            var sin = table
                .column(30, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == 'Sin marca' ? true : false;
            });
            var total = table
                .column(30, {search: 'applied'})
                .data();
            var directos = table
                .column(24, {search: 'applied'})
                .data()
                .filter( function ( value, index ) {
                    return value == $("#nombreUsuarioPersonal").val() ? true : false;
            });

            var tablaInf = $('#infoInformePersonal').DataTable( {
              "select": {
                  style: 'single'
              },
              columnDefs: [
                {
                    targets: 0,
                    className: 'leftDataTableCant'
                },
                {
                    targets: 1,
                    className: 'centerDataTableCant'
                }
              ],
              "scrollX": true,
              "paging": false,
              "searching": false,
              "ordering": false,
              "scrollCollapse": true,
              "order": [[ 0, "asc" ]],
              "info": true,
              "dom": 'frtp',
              "destroy": true,
              "language": {
                "zeroRecords": "No hay datos disponibles",
                "info": "Registro _START_ de _END_ de _TOTAL_",
                "infoEmpty": "No hay datos disponibles",
                "paginate": {
                    "previous": "Anterior",
                    "next": "Siguiente"
                  },
                  "search": "Buscar: ",
                  "select": {
                      "rows": "- %d registros seleccionados"
                  },
                  "infoFiltered": "(Filtrado de _MAX_ registros)"
              },
              "destroy": true,
              "autoWidth": false,
              "initComplete": function( settings, json){
                $(this.api().column(1).footer()).html(total.count());
              }
            });
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
            tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
            tablaInf.draw();


            $("#qDirectos").html(directos.count());
            $("#qOtros").html(total.count() - directos.count());

            menuElegant();

            $('#modalAlertasSplash').modal('hide');
          },1000);
        },
      });
    },100);
  }
});

$("#solicitarJefaturaRespuesta").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();

  $("#tituloSolicitarJefaturaRespuesta").html(datos[0].NOMBRE);

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#modalSolicitarJefaturaRespuesta").modal("show");
    $("#modalSolicitarJefaturaRespuesta").css("z-index", "1050");
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#aceptarSolicitarJefaturaRespuesta").unbind("click").click(async function(){
  $('#modalSolicitarJefaturaRespuesta').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  var table = $('#infoInformePersonal').DataTable().clear().draw();

  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();
  var dniPersonal = datos[0].DNI;

  var response2;

  await $.ajax({
    url:   'controller/editarJefaturaSolicitOk.php',
    type:  'POST',
    data:  {
      "dniPersonal": dniPersonal
    },
    success: function (response) {
      response2 = jQuery.parseJSON(response);
      $('#solicitarJefaturaRespuesta').attr("disabled","disabled");
      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      setTimeout(async function(){
        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Solicitud aceptada correctamente");
        if(response2.aaData.length >= 0){
          var table = $('#tablaPersonal').DataTable();
          table.rows( '.selected' ).remove().draw();
          // ingresaModificacionPersonal(response2);

          $("#disponiblePersonal").attr("disabled","disabled");
          $("#ausentePersonal").attr("disabled","disabled");
          $("#transferirJefatura").attr("disabled","disabled");
          $("#transferirJefaturaRespuesta").attr("disabled","disabled");
          $("#solicitarJefaturaRespuesta").attr("disabled","disabled");
          $("#desasignarJefaturaRespuesta").attr("disabled","disabled");
        }
        await $.ajax({
          url:   'controller/editarPersonalSolicNotifyOk.php',
          type:  'POST',
          data:  dataNotify,
          complete: function(){
          }
        });

        var table = $("#tablaPersonal").DataTable();
        var vac = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Vacaciones' ? true : false;
        });
        var lic = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Licencia' ? true : false;
        });
        var des = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Desvinculado' ? true : false;
        });
        var pre = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Presente' ? true : false;
        });
        var pre_in = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Presente Inducción' ? true : false;
        });
        var pre_tel = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Presente Teletrabajo' ? true : false;
        });
        var pre_in_tel = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Presente Inducción Teletrabajo' ? true : false;
        });
        var ren = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Renuncia' ? true : false;
        });
        var per = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Permiso' ? true : false;
        });
        var aus = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Ausente' ? true : false;
        });
        var sin = table
            .column(30, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Sin marca' ? true : false;
        });
        var total = table
            .column(30, {search: 'applied'})
            .data();
        var directos = table
            .column(24, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == $("#nombreUsuarioPersonal").val() ? true : false;
        });

        var tablaInf = $('#infoInformePersonal').DataTable( {
          "select": {
              style: 'single'
          },
          columnDefs: [
            {
                targets: 0,
                className: 'leftDataTableCant'
            },
            {
                targets: 1,
                className: 'centerDataTableCant'
            }
          ],
          "scrollX": true,
          "paging": false,
          "searching": false,
          "ordering": false,
          "scrollCollapse": true,
          "order": [[ 0, "asc" ]],
          "info": true,
          "dom": 'frtp',
          "destroy": true,
          "language": {
            "zeroRecords": "No hay datos disponibles",
            "info": "Registro _START_ de _END_ de _TOTAL_",
            "infoEmpty": "No hay datos disponibles",
            "paginate": {
                "previous": "Anterior",
                "next": "Siguiente"
              },
              "search": "Buscar: ",
              "select": {
                  "rows": "- %d registros seleccionados"
              },
              "infoFiltered": "(Filtrado de _MAX_ registros)"
          },
          "destroy": true,
          "autoWidth": false,
          "initComplete": function( settings, json){
            $(this.api().column(1).footer()).html(total.count());
          }
        });
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
        tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
        tablaInf.draw();


        $("#qDirectos").html(directos.count());
        $("#qOtros").html(total.count() - directos.count());

        menuElegant();
        $('#modalAlertasSplash').modal('hide');
      },1000);
    }
  });

  var dataNotify = {
    "nombreNuevoJefe": response2.aaData2[0]['NUEVOJEFE'],
    "emailNuevoJefe": response2.aaData2[0]['EMAILNUEVOJEFE'],
    "strlstPersonal": {
      nombres: response2.aaData2[0]['PERSONAL'] ?? '',
      dnis: response2.aaData2[0]['DNI'] ?? ''
    },
    "lstExJefes": [ response2.aaData2[0]['EMAILANTIGUOJEFE'] ?? '' ]
  };
});

$("#rechazarSolicitarJefaturaRespuesta").unbind("click").click(async function(){
  $('#modalSolicitarJefaturaRespuesta').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();
  var dniPersonal = datos[0].DNI;

  var response2;

  await $.ajax({
    url:   'controller/editarJefaturaSolicitNot.php',
    type:  'POST',
    data:  {
      "dniPersonal": dniPersonal
    },
    success: function (response) {
      response2 = jQuery.parseJSON(response);
      $('#solicitarJefaturaRespuesta').attr("disabled","disabled");
      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      setTimeout(function(){
        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Solicitud rechazada correctamente");
        if(response2.aaData.length >= 0){
          var table = $('#tablaPersonal').DataTable();
          table.rows( '.selected' ).remove().draw();
          ingresaModificacionPersonal(response2);

          $("#disponiblePersonal").attr("disabled","disabled");
          $("#ausentePersonal").attr("disabled","disabled");
          $("#transferirJefatura").attr("disabled","disabled");
          $("#transferirJefaturaRespuesta").attr("disabled","disabled");
          $("#solicitarJefaturaRespuesta").attr("disabled","disabled");
          $("#desasignarJefaturaRespuesta").attr("disabled","disabled");
        }
        $('#modalAlertasSplash').modal('hide');
      },1000);
    }
  });

  var dataNotify = {
    "nombreNuevoJefe": response2.aaData2[0]['NUEVOJEFE'],
    "emailNuevoJefe": response2.aaData2[0]['EMAILNUEVOJEFE'],
    "strlstPersonal": {
      nombres: response2.aaData2[0]['PERSONAL'] ?? '',
      dnis: response2.aaData2[0]['DNI'] ?? ''
    },
    "lstExJefes": [ response2.aaData2[0]['EMAILANTIGUOJEFE']??'' ]
  };
  // console.log(dataNotify);
  await $.ajax({
    url:   'controller/editarPersonalSolicNotifyNot.php',
    type:  'POST',
    data:  dataNotify,
    complete: function(){
    }
  });
});

$("#idNivelesOrganigrama").unbind("click").change(function(event){
  event.preventDefault();
  event.stopImmediatePropagation();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#idNivelesOrganigrama").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  dibujaOrgCorp();
});

async function dibujaOrgCorp(){
  // alert($(window).width());
  var data = [];
  var max = 0;

  var parametros = {
    "nivel": $("#idNivelesOrganigrama").val()
  }

  await $.ajax({
    url:   'controller/datosOrganigramas.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          if(max < p2.aaData[i].IDNIVELFUNCIONAL){
            max = p2.aaData[i].IDNIVELFUNCIONAL;
          }
          if(p2.aaData[i].JEFE !== null){
            data.push([p2.aaData[i].JEFE, p2.aaData[i].NOMBRE]);
          }
        }
      }
    }
  });

  var detalles;

  await $.ajax({
    url:   'controller/datosOrganigramasDetalles.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      detalles = jQuery.parseJSON(response2);
    }
  });

  await $("#divOrganigramaCorporativo").highcharts({
    chart: {
      width: $(window).width() - 80,
      // height: 13*(max+1)*(3.5/max),
      height: $(window).height()-200,
      inverted: true
    },
    title: {
      text: ''
    },
    accessibility: {
      point: {
        descriptionFormatter: function(point) {
          var nodeName = point.toNode.name,
            nodeId = point.toNode.id,
            nodeDesc = nodeName === nodeId ? nodeName : nodeName + ', ' + nodeId,
            parentDesc = point.fromNode.id;
          return point.index + '. ' + nodeDesc + ', reports to ' + parentDesc + '.';
        }
      }
    },
    series: [{
      getExtremesFromAll: true,
      type: 'organization',
      name: 'Datos:',
      keys: ['from', 'to'],
      data: data,
      levels: [{
        level: 0,
        color: '#00358d',
        dataLabels: {
          color: 'white'
        }
      }, {
        level: 1,
        color: '#8d0000',
        dataLabels: {
          color: 'white'
        }
      }, {
        level: 2,
        color: '#4c0063',
        dataLabels: {
          color: 'white'
        }
      }, {
        level: 3,
        color: '#004b11',
        dataLabels: {
          color: 'white'
        }
      }, {
        level: 4,
        color: '#009bb7',
        dataLabels: {
          color: 'white'
        }
      }],
      nodes: detalles,
      colorByPoint: false,
      color: '#007ad0',
      dataLabels: {
        style: {
          fontSize: '0.4em'
        }
      },
      colorByPoint: false,
      color: '#007ad0',
      borderColor: 'white',
      nodePadding: 2,
      nodeWidth: 120,
      height: 90,
      offset: '100%'
    }],
    tooltip: {
      outside: true,
      formatter: function() {
        //debugger;
        return this.point.info;
      }
    },
  });

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },500);
}

$("#eliminarProyecto").unbind("click").click(function(){
  var table = $("#tablaListadoProyecto").DataTable();
  var datos = table.rows('.selected').data();
  $("#tituloEliminarProyecto").html(datos[0].NOMENCLATURA);
  $("#modalEliminarProyecto").modal("show");
});

$("#eliminarEliminarProyecto").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEliminarProyecto").modal("hide");
  var table = $("#tablaListadoProyecto").DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    "idEstructura": datos[0].IDESTRUCTURA_OPERACION
  }

  $("#modalEliminarProyecto").modal("hide");
  $.ajax({
      url: "controller/eliminarProyecto.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaListadoProyecto').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Proyecto eliminado correctamente");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
              else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El proyecto no puede ser eliminado dado que posee Personal, Permisos o Flota asociada");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
          }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El proyecto no puede ser eliminado dado que posee Personal, Permisos o Flota asociada");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
      }
  });
});

$("#cargasPersonalInterno").unbind('click').click(function(){
  var table = $('#tablaPersonalInterno').DataTable();
  var rutPersonal = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI;
  });
  var nombrePersonal = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  $("#nombrePersonalCargas").val(rutPersonal+ ' , '+ nombrePersonal);
  var h = $(window).height() - 200;
  $("#bodyListadoCargas").css("height",h);
  parametros = {
    "rutPersonal": rutPersonal[0]
  }
  //console.log(parametros);
  setTimeout(async function(){
    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/40);
    await $('#tablaListadoCargas').DataTable( {
        ajax: {
            url: "controller/datosListaCargasPersonal.php",
            type: 'POST',
            data: parametros,
        },
        columns: [
            { data: 'S'},
            { data: 'DNI_CARGA' },
            { data: 'NOMBRE_CARGA' },
            { data: 'FECHA_NACIMIENTO_CARGA' },
            { data: 'PARENTESCO_CARGA' },
            { data: 'IDCARGAFAMILIAR' }
        ],
        //responsive: true,
        buttons: [
          {
            extend: 'excel',
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          }
        ],
        "columnDefs": [
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "width": "5px",
            "targets": 0
          },
          {
            "visible": false,
            "searchable": false,
            "targets": [ 5 ]
          },
        ],
        "select": {
            style: 'single'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        // "order": [[ 3, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'Bfrtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();
          setTimeout(function(){
            $('#tablaListadoCargas').DataTable().columns.adjust();
          },200);
        }
    });
    $("#modalListadoCargas").modal('show');
    await esconderMenu();
    $('#tablaListadoCargas').DataTable().on("draw", function(){
      $('#modalAlertasSplash').modal('hide');
    });
  },100);
});

$("#agregarCargaPersonal").unbind("click").click(async function(){
  $("#modalAgregarCargaFamiliar").find("input,textarea,select").val("");
  $("#rutAgregarCargaFamiliar").removeClass("is-invalid");
  $("#nombreAgregarCargaFamiliar").removeClass("is-invalid");
  $("#fechaNacimientoAgregarCargaFamiliar").removeClass("is-invalid");
  //$("#emailUsuario").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#perfilUsuario").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    $("#modalAgregarCargaFamiliar").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyAgregarCargaFamiliar').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("input#rutAgregarCargaFamiliar").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutAgregarCargaFamiliar").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutAgregarCargaFamiliar").val("");
    $("#rutAgregarCargaFamiliar").addClass("is-invalid");
  }
});

$("#rutAgregarCargaFamiliar").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombreAgregarCargaFamiliar").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#fechaNacimientoAgregarCargaFamiliar").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#fechaNacimientoAgregarCargaFamiliar").datepicker({
  dateFormat: "yy-mm-dd",
  changeMonth: true,
  changeYear: true,
  yearRange: '1920:2040',
  firstDay: 1,
  changeMonth: true,
  changeYear: true,
  monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
  monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
  dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
  dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
  dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
});

$("#fechaInstalacion").datepicker({
  dateFormat: "yy-mm-dd",
  changeMonth: true,
  changeYear: true,
  yearRange: '2020:2040',
  maxDate: moment().format('YYYY-MM-DD'),
  firstDay: 1,
  changeMonth: true,
  changeYear: true,
  monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
  monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
  dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
  dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
  dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
});

$("#guardarAgregarCargaFamiliar").unbind('click').click(function(){
  var table = $('#tablaPersonalInterno').DataTable();
  var rutPersonal = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI;
  });
  if($("#rutAgregarCargaFamiliar").val().length == 0 || $("#nombreAgregarCargaFamiliar").val().length == 0 || $("#fechaNacimientoAgregarCargaFamiliar").val().length == 0 || $("#parentescoAgregarCargaFamiliar").prop("selected") == false){


    alertasToast("Debe completar todos los campos");
    if ($("#rutIngresoUsuario").val().length == 0){
      $("#rutIngresoUsuario").addClass("is-invalid");
    }
    else if ($("#nombreAgregarCargaFamiliar").val().length == 0){
      $("#nombreAgregarCargaFamiliar").addClass("is-invalid");
    }
    else if ($("#fechaNacimientoAgregarCargaFamiliar").val().length == 0){
      $("#fechaNacimientoAgregarCargaFamiliar").addClass("is-invalid");
    }
    else if ($("#parentescoAgregarCargaFamiliar").prop("selected") == false){
      $("#parentescoAgregarCargaFamiliar").addClass("is-invalid");
    }
  }
  else {
  parametros = {
    "rutCarga":   $.trim($("#rutAgregarCargaFamiliar").val().replace('.','').replace('.','')),
    "rutPersonal": rutPersonal[0],
    "nombreCarga": $("#nombreAgregarCargaFamiliar").val(),
    "fechaNac": $("#fechaNacimientoAgregarCargaFamiliar").val(),
    "parentesco": $("#parentescoAgregarCargaFamiliar").val()
  }
  // console.log(parametros);
  $.ajax({
      url:   'controller/datosChequeaCargaFamiliar.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){

            alertasToast("Ya existe una carga familiar ingresada con ese RUT");


          }
        }
        else{
          $("#modalAgregarCargaFamiliar").modal("hide");
          $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
          $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
          $('#modalAlertasSplash').modal('show');
          $.ajax({
            url: "controller/ingresaCargaFamiliar.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
              var p = response.split(",");
              if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaListadoCargas').DataTable();
                  //table.rows('.selected').remove().draw();
                  table.ajax.reload();

                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Carga familiar asignada correctamente");



                }
                else{

                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear carga familiar, si el problema persiste favor comuniquese con soporte");


                }
              }
              else{

                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear carga familiar, si el problema persiste favor comuniquese con soporte");


              }
            }
          });
        }
      }
    });
  }
});

$("#desvincularCargaPersonal").unbind('click').click(async function(){
  var table = $('#tablaListadoCargas').DataTable();
  var rutCarga = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI_CARGA;
  });
  var nombreCarga = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE_CARGA;
  });
  $("#tituloDesvincularCargaFamiliar").html(rutCarga[0] + ' , ' +nombreCarga[0]);
  $('#modalEliminarCargaFamiliar').modal('show');
});

$("#guardarEliminarCargaFamiliar").unbind('click').click(async function(){
  var table = $('#tablaListadoCargas').DataTable();
  var idCarga = $.map(table.rows('.selected').data(), function (item) {
      return item.IDCARGAFAMILIAR;
  });
  parametros = {
    "idCarga": idCarga[0]
  }
  //console.log(parametros);
  await $.ajax({
    url: "controller/eliminarCargaFamiliar.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){

          var table = $('#tablaListadoCargas').DataTable();
          table.ajax.reload();
          $("#modalEliminarCargaFamiliar").modal("hide");

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Carga familiar eliminada correctamente");


        }
        else{

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar carga familiar, si el problema persiste favor comuniquese con soporte");


        }
      }
      else{

        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar carga familiar, si el problema persiste favor comuniquese con soporte");


      }
    }
  });
});

$('#selectTiposAuditorias').change(async function (e) {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').hide('show');
  e.preventDefault();
  e.stopImmediatePropagation();
  var idAuditoria = $("#selectTiposAuditorias option:selected").val();
  var parametros = {
    'id': $("#selectTiposAuditorias").val()
  }
  await $.ajax({
    url:   'controller/datosTiposServicios.php',
    type:  'post',
    data:  parametros,
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var cuerpo = '';
        for(var i = 0; i < p.aaData.length; i++) {
          cuerpo += '<option id="' + p.aaData[i].TITULO + '" value="' + p.aaData[i].id + '">' + p.aaData[i].TITULO + '</option>';
        }
        $("#selectTiposServicios").html(cuerpo);
        if($('select[id="selectTiposServicios"] option:selected').text() === "No Aplica"){
          $("#numTarea").val("No Aplica");
          $("#rutCliente").val("No Aplica");
          $("#numTarea").attr("disabled","disabled");
          $("#rutCliente").attr("disabled","disabled");
          $("#direccionCliente").val("No Aplica");
          $("#direccionCliente").attr("disabled","disabled");
          $("#fechaInstalacion").attr("disabled","disabled");
        }
        else{
          $("#numTarea").val("");
          $("#rutCliente").val("");
          $("#direccionCliente").val("");
          $("#direccionCliente").removeAttr("disabled");
          $("#numTarea").removeAttr("disabled");
          $("#rutCliente").removeAttr("disabled");
          $("#fechaInstalacion").removeAttr("disabled");
        }
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectTiposAuditorias").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectTiposServicios").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  await cargarFormulario(idAuditoria);
});

$('#selectTiposServicios').change(async function () {
  var idServicio = $("#selectTiposServicios option:selected").val();
});

async function cargarFormulario(idAuditoria) {
  $("#formulario").empty();
  await $.ajax({
    url: "controller/datosArbolPracticas.php",
    type: 'POST',
    data: { "idAuditoria": idAuditoria },
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      $("#formulario").empty();
      if(p.aaData.length !== 0) {
        var comp = "";
        p.aaData.forEach(({ id: idFamilia, name: nameFamilia, zCategorias }) => {
          comp += '<div class="row"><div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12"><hr class="hr-separador"></div></div>';
          comp += `<h4 style="font-weight: bold;" id="${idFamilia}">${nameFamilia}</h4>`;

          zCategorias.forEach(({ id: idCategoria, name: nameCategoria, zsubfamilia1 }) => {
            comp += `<h5 style="margin-top: 5pt; font-weight: bold; color: gray;" id="${idCategoria}">${nameCategoria}</h5>`;
            comp += `<div style="margin-top: 10pt;" class="accordion" id="${idCategoria}">`;

            zsubfamilia1.forEach(({ id: idSubfamilia1, name: nameSubfamilia1, tipo: tipoSubfamilia1, zsubfamilia2 }) => {

              switch(tipoSubfamilia1) {
                case 'options':
                  comp += `<div style="margin-bottom: -5pt;" class="form-check">`;
                  comp += `<input style="margin-top: 8pt;" class="form-check-input my-item" type="radio" id="${idSubfamilia1}" name="${idCategoria}" data-toggle="collapse" data-target="#acc${idSubfamilia1}">`;
                  comp += `<label style="padding-left: 5px;" class="form-check-label" for="${idSubfamilia1}" data-toggle="collapse" data-target="#acc${idSubfamilia1}">${nameSubfamilia1}</label>`;
                  comp += `<button style="margin-left: -5pt;" class="btn btn-link" type="button" data-toggle="collapse" data-target="#acc${idSubfamilia1}"><span class="fas fa-arrow-alt-circle-down"></span></button>`;
                  comp += `</div>`;

                  comp += `<div style="margin-top: -10pt;" id="acc${idSubfamilia1}" class="collapse">`;
                  comp += `<div style="background-color: #ececec; margin-left: 10pt; margin-top: 10pt; margin-bottom: 10pt; padding-top: 5pt; padding-left: 5pt; padding-bottom: 5pt;">`;

                  zsubfamilia2.forEach(({ id: idSubfamilia2, name: nameSubfamilia2, puntaje }) => {
                    comp += `<div class="form-check">`;
                    comp += `<input class="form-check-input my-option" type="checkbox" id="${idSubfamilia2}" name="${idSubfamilia1}" value="${puntaje}">`;
                    comp += `<label class="form-check-label" for="${idSubfamilia2}">${nameSubfamilia2}</label>`;
                    comp += `</div>`;
                  });

                  comp += `</div>`;
                  comp += `</div>`;

                  comp += `</div>`;
                  break;
                case 'ok':
                  comp += `<div class="form-check">`;
                  comp += `<input checked style="margin-top: 5pt;" class="form-check-input my-item no-children" type="radio" id="${idSubfamilia1}" name="${idCategoria}">`;
                  comp += `<label class="form-check-label" for="${idSubfamilia1}" style="padding-left: 5px;">${nameSubfamilia1}</label>`;
                  comp += `</div>`;
                  break;
                case 'ojnot':
                  comp += `<div class="form-check">`;
                  comp += `<input style="margin-top: 5pt;" class="form-check-input my-item no-children" type="radio" id="${idSubfamilia1}" name="${idCategoria}">`;
                  comp += `<label class="form-check-label" for="${idSubfamilia1}" style="padding-left: 5px;">${nameSubfamilia1}</label>`;
                  comp += `</div>`;
                  break;
                case 'notes':
                  comp += `<div>`;
                  comp += `<label style="margin-top: 5pt;" for="${idSubfamilia1}">${nameSubfamilia1}</label>`;
                  comp += `<textarea class="form-control my-opinion" name="${idCategoria}" id="${idSubfamilia1}" rows="3" style="margin-bottom: 5pt; resize: none;" maxlength="4000"></textarea>`;
                  comp += `</div>`;
                  break;
                case 'files':
                    comp += `<div class="input-group">
                        <label class="input-group-btn">
                            <span id="sintomasSpanFoto" class="form-control btn btn-default btn-file" style="text-align: left; color: grey; border: 1px solid #c8c8c8;">
                                <span class="fas fa-camera"></span>&nbsp;&nbsp;Foto 1<input type="file" id='fotoPractica${idSubfamilia1}' accept="image/*" style="display: none;">
                            </span>
                        </label>
                        <input disabled id='value${idSubfamilia1}' type="text" class="form-control" readonly>
                        </div>`;
                    comp += `<div class="input-group">
                        <label class="input-group-btn">
                            <span id="sintomasSpanFoto_2" class="form-control btn btn-default btn-file" style="text-align: left; color: grey; border: 1px solid #c8c8c8;">
                                <span class="fas fa-camera"></span>&nbsp;&nbsp;Foto 2<input type="file" id='fotoPractica${idSubfamilia1}_2' accept="image/*" style="display: none;">
                            </span>
                        </label>
                        <input disabled id='value${idSubfamilia1}_2' type="text" class="form-control" readonly>
                    </div>`
                  break;
                default:
                  break;
              }
            })

            comp += `</div>`;
            comp += `<br>`;
          })

        });

        $("#formulario").append(comp);
      }
      await $.ajax({
        url: 'controller/datosRefreshRut.php',
        type: 'POST',
        success: function(resp) {
          var user = jQuery.parseJSON(resp);
          var todayTime = new Date();
          var year = todayTime.getFullYear().toString();
          var month = (todayTime.getMonth() + 101).toString();
          var day = (todayTime.getDate() + 100).toString();
          var formatDate = `${year}-${month.substring(1)}-${day.substring(1)}`;
          if(user.aaData.length != 0) {
            $('#rutAuditor').val(user.aaData['RUT']);
            $('#nombreAuditor').val(user.aaData['NOMBRE']);
            $('#fechaInstalacion').val(formatDate);
          }
        }
      });
      setTimeout(function() {
        $('#modalAlertasSplash').modal('hide');
      }, 500);
    }
  })

  $("input[id*='fotoPractica']" ).on('change', function(e){
    var file = e.target.files[0].name;
    var id = $(this).attr("id").split("Practica")[1];
    $("#value" + id).val(file);
  });

  // // BEGIN - CAMBIOS PARA FORMULARIO
  $(document).on("change", 'input[type=radio]', function (e) {
    e.preventDefault();
    var clasePadre = $(this).attr('class');
    var namePadre = $(this).attr('name');
    var mishijos = Object.values($(`.my-option`))
      .filter((hijo) => hijo.name == `${namePadre}ConProblemas`)
      .map((hijo) => hijo.id);
    if(clasePadre.includes('no-children')) {
      mishijos.forEach((mihijo) => $(`#${mihijo}`).prop('checked',false));
    }
  });

  $(document).on("change", 'input[type=checkbox]', function (e) {
    e.preventDefault();
    var clasePadre = $(this).attr('class');
    var namePadre = $(this).attr('name');
    if(clasePadre.includes('my-option')) {
      $(`#${namePadre}`).prop('checked',true);
    }
  });
  // // END - CAMBIOS PARA FORMULARIO
  menuElegant();
}

$("#enviarFormulario").unbind("click").click(async function(){
  var [ puntajes, observaciones ] = contarPuntajeFormulario();
  var validaCheckboxes = true;
  var puntos = 0;
  var problem = 0;
  await Object.values(puntajes).forEach((punt) => {
    Object.keys(punt).forEach((aux) => {
      if(aux.includes('ConProblema')) {
        if(punt[aux]){
          if(punt['puntaje'] <= 0){
            validaCheckboxes = false;
          }
        }
      }
    });
  });

  if(!validaCheckboxes) {
    alertasToast("Favor revise los campos de formulario no pueden quedar elementos vacios o si selecciono una actividad con problema debe indicar cuales");
    $('#numTarea').addClass("is-invalid");
    $('#direccionCliente').addClass("is-invalid");
    $('#rutCliente').addClass("is-invalid");
    $('#selectPersonal').addClass("is-invalid");
    $('#selectMultiPersonal').addClass("is-invalid");
  } else {
    if(
      !(
        $('#numTarea').val().length &&
        $('#direccionCliente').val().length &&
        $('#rutCliente').val().length &&
        $('#fechaInstalacion').val().length &&
        $('#selectMultiPersonal').val().length // && $('#selectPersonal').val().length)) {
      )
    ) {
      alertasToast("Debe llenar todos los datos de la cabecera");
      $('#numTarea').addClass("is-invalid");
      $('#direccionCliente').addClass("is-invalid");
      $('#rutCliente').addClass("is-invalid");
      $('#selectPersonal').addClass("is-invalid");
      $('#selectMultiPersonal').addClass("is-invalid");
    } else {
      $('#errorFormulario').html('');
      $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
      $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
      $('#modalAlertasSplash').hide('show');
      $('#esperandoFormulario').show();

      var items = Object.values(puntajes).map((valores) => {
        var aux = '';
        Object.keys(valores).map((res) => {
          switch(typeof valores[res]) {
            case 'string':
              aux = res!='observaciones' ? `${aux},${valores[res]}` : aux;
              break;
            case 'boolean':
              aux = valores['items'] ? aux : valores[res] ? `${aux},'${res}'` : aux;
              break;
            case 'number':
              aux = aux;
              break;
            default:
              break;
          }
        });
        return aux.substring(1);
      }).reduce((total, item) => `${total},${item}`, '');
      var nota = Object.values(puntajes).map((item) => item.puntaje).reduce((total, num) => total+num, 0);

      await $.ajax({
        url: "controller/ingresaFormulario.php",
        type: 'POST',
        data: {
          "tipoauditoria": Number($("#selectTiposAuditorias option:selected").val()),
          "tiposervicio": Number($("#selectTiposServicios option:selected").val()),
          "ntarea": $("#numTarea").val(),
          "direccioncliente": $('#direccionCliente').val(),
          "rutcliente": $('#rutCliente').val(),
          "fechainstalacion": $('#fechaInstalacion').val()+' 00:00:00',
          "nota": nota,
          'rutPersonal': '', //$("#selectPersonal").val().split(' - ')[0],
          'nombrePersonal': '', // $("#selectPersonal").val().split(' - ')[1]
        },
        success: async function (response) {
          var p = jQuery.parseJSON(response);
          await ingresarFormularioPersonal(p[0]['LAST_INSERT_ID()']);
          await $.ajax({
            url: "controller/ingresaResultado.php",
            type: 'POST',
            data: {
              "idtipoauditoria": Number($("#selectTiposAuditorias option:selected").val()),
              "idformulario": Number(p[0]['LAST_INSERT_ID()']),
              "cadenas": items.substring(1)
            },
            success: async function (res1) {
              var textareas = [];
              Object.keys(observaciones).forEach((observacion) => {
                textareas.push(`${Number(p[0]['LAST_INSERT_ID()'])},'${observacion}','${observaciones[observacion]}'`);
              });
              await $.ajax({
                url: "controller/ingresaResultadoObs.php",
                type: 'POST',
                data: {
                  "cadenas": textareas,
                  "idformulario": Number(p[0]['LAST_INSERT_ID()']),
                  "url": window.location.toString().split("?")[0]
                },
                success: async function (res2) {
                  var inputs = (Object.values($("input[id*='fotoPractica']" ))).filter((inp) => inp.id && !inp.id.includes('_2'));
                  var y = 0;
                  await inputs.forEach((inp) => {
                    var formdata = new FormData();
                    var tam = 0;
                    formdata.append('id',p[0]['LAST_INSERT_ID()']);
                    formdata.append('url',window.location.toString().split("?")[0]);
                    var [ file ] = inp.files;
                    var [ file2 ] = Object.values($(`input[id='${inp.id}_2']`))[0].files;
                    formdata.append(`item${tam}[]`, file?.name ?? '');
                    formdata.append(`item${tam}[]`, p[0]['LAST_INSERT_ID()']);
                    formdata.append(`item${tam}[]`, `${inp.id.replace('fotoPractica', '')}`);
                    formdata.append(`item${tam}[]`, $("#selectTiposAuditorias option:selected").val());
                    formdata.append(`item${tam}[]`, window.location.toString().split("?")[0]);
                    formdata.append(`itemF1_${tam}`, file);
                    formdata.append(`itemF2_${tam}`, file2);
                    tam++;

                    formdata.append(`tam`, tam);

                    $.ajax({
                      url: "controller/ingresaResultadoFotos.php",
                      type: 'POST',
                      data: formdata,
                      cache: false,
                      contentType: false,
                      processData: false,
                      success: function (res3) {
                        y++;
                        // window.open(window.location.toString().split("?")[0] + '/controller/repositorio/practica' + res3, '_blank');
                      }
                    });
                  });

                  var parametrosPDF = {
                    'id': p[0]['LAST_INSERT_ID()'],
                    'url': window.location.toString().split("?")[0]
                  }

                  pdfAuditoria = setInterval(async function(){
                    if(y >= inputs.length){
                      clearInterval(pdfAuditoria);
                      await $.ajax({
                        url: "controller/generaPDF/practica1.php?idLoad=205",
                        type: 'POST',
                        data: parametrosPDF,
                        success: function (res3) {
                          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                            window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/practica' + res3, '_blank');
                          }
                          else{
                            // window.open('view/js/viewerjs/#../../../controller/repositorio/practica' + res3, '_blank');
                            $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                            $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                            $('#modalAlertasSplash').modal('show');
                            setTimeout(function(){
                              $("#loadPDFApp").remove();
                            },200);
                            setTimeout(function(){
                              $("#bodyModalPDFAPPMed").append('<object id="loadPDFApp" type="" data=""></object>');
                              $("#loadPDFApp").attr("data", window.location.toString().split("#/")[0].split('?')[0] +'view/js/viewerjs/#../../../controller/repositorio/practica' + res3);
                              $("#loadPDFApp").css("width","100%");
                              $("#loadPDFApp").css("height","100%");
                              $("#bodyModalPDFAPPMed").css("width","100%");
                              $("#bodyModalPDFAPPMed").css("height",$(window).height() - 50);
                              setTimeout(function(){
                                $('#modalAlertasSplash').modal('hide');
                                $("#modalPDFApp").modal("show");
                              },1000);
                            },1000);
                          }
                          setTimeout(async function() {
                            if($('select[id="selectTiposServicios"] option:selected').text() === "No Aplica"){
                              $("#numTarea").val("No Aplica");
                              $("#rutCliente").val("No Aplica");
                              $("#numTarea").attr("disabled","disabled");
                              $("#rutCliente").attr("disabled","disabled");
                              $("#direccionCliente").val("No Aplica");
                              $("#direccionCliente").attr("disabled","disabled");
                              $("#fechaInstalacion").attr("disabled","disabled");
                            }
                            else{
                              $("#numTarea").val("");
                              $("#direccionCliente").val("");
                              $("#rutCliente").val("");
                              $("#selectPersonal").val("");
                              $("#selectMultiPersonal").val(""); // <---- RODRIGO - FALTA LA FUNCION PARA LIMPIAR EL MULTISELECT PERSONAL
                              $("#numTarea").removeAttr("disabled");
                              $("#rutCliente").removeAttr("disabled");
                              $("#direccionCliente").removeAttr("disabled");
                              $("#fechaInstalacion").removeAttr("disabled");
                            }
                            var idAuditoria = $("#selectTiposAuditorias option:selected").val();
                            await cargarFormulario(idAuditoria);
                            var random = Math.round(Math.random() * (1000000 - 1) + 1);
                            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Formulario ingresado correctamente");
                            $("#selectMultiPersonal").multiSelect('deselect_all');
                            clearInterval(pdfAuditoria);
                            $('#modalAlertasSplash').modal('hide');
                          }, 500);
                        }
                      });
                    }
                  },1000);
                }
              });
            }
          });
        }
      });
    }
  }
});

async function ingresarFormularioPersonal(idFormulario) {
  var lstIdsPersonal = $('#selectMultiPersonal').val();
  await $.ajax({
    url: "controller/ingresaFormularioMultiPersonal.php",
    type: 'POST',
    data: {
      "idFormulario": idFormulario,
      "lstIdsPersonal": lstIdsPersonal,
    },
    success:  function (response) {
    }
  });
}

$("input#rutCliente").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutCliente").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutCliente").val("");
    $("#rutCliente").addClass("is-invalid");
  }
});

$("#rutCliente").on('input', function(){
  $(this).removeClass("is-invalid");
});

function contarPuntajeFormulario () {
  var radios = {};
  Object.values($('.my-item')).forEach((item) => {
    if(item.id) {
      radios[item.name] = radios[item.name] ?? {};
      radios[item.name][item.id] = $(`#${item.id}`).is(':checked');
    }
  });

  Object.keys(radios).forEach((item) => {
    var flag = false;
    var first;
    Object.keys(radios[item]).forEach((aux, index) => {
      if(index===0) first = aux;
      if(radios[item][aux]) flag = true;
    })
    if(!flag) radios[item][first] = true;
  });


  var puntajes = {};
  var auxiliares = {};
  Object.values($( ".my-option")).forEach((item) => {
    if(item.id) {
      puntajes[item.name] = $(`#${item.id}`).is(':checked') ?
        Number(puntajes[item.name]??0) + Number(item.value) :
        puntajes[item.name] = Number(puntajes[item.name]??0);
      auxiliares[item.name] = $(`#${item.id}`).is(':checked') ?
        `${auxiliares[item.name]??''},'${item.id}'`
        : auxiliares[item.name];
    }
  });

  var opiniones = {};
  Object.values($(".my-opinion")).forEach((item) => {
    if(item.name) opiniones[item.name] = item.value;
  });

  var total = {};
  Object.keys(radios).forEach((item) => {
    total[item] = radios[item];
    Object.keys(total[item]).forEach((aux) => {
      var sam = Object.keys(puntajes);
      var founded = sam.find((joan) => joan === aux);
      if(founded) {
        total[item]['puntaje'] = puntajes[founded];
        total[item]['items'] = auxiliares[founded]?.substring(1);
        total[item]['observaciones'] = opiniones[item];
      }
    });
  });

  return [ total, opiniones ];
}

async function pdf_Formulario(pdf){
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    window.open(window.location.toString().split("#/")[0].split('?')[0] + 'controller/repositorio/practica/' + pdf, '_blank');
  }
  else{
    // window.open('view/js/viewerjs/#../../../controller/repositorio/practica/' + pdf, '_blank');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    setTimeout(function(){
      $("#loadPDFApp").remove();
    },400);
    setTimeout(function(){
      $("#bodyModalPDFAPPMed").append('<object id="loadPDFApp" type="" data=""></object>');
      $("#loadPDFApp").attr("data", window.location.toString().split("#/")[0].split('?')[0] +'view/js/viewerjs/#../../../controller/repositorio/practica/' + pdf);
      $("#loadPDFApp").css("width","100%");
      $("#loadPDFApp").css("height","100%");
      $("#bodyModalPDFAPPMed").css("width","100%");
      $("#bodyModalPDFAPPMed").css("height",$(window).height() - 50);
    },1000);
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
      $("#modalPDFApp").modal("show");
    },3000);
  }
}

function notificacionModal(id, cuerpo){
  parametros = {
    "id": id
  }
  //console.log(parametros);
  $.ajax({
    url: "controller/actualizaNotificacionTabla.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaNotificacion').DataTable();
          table.ajax.reload();
        }
      }
    }
  });
  $("#buttonAceptarAlertaNotificacion").css("display","inline");
  $("#modalNotificacion").modal({backdrop: 'static', keyboard: false});
  $("#textoModalNotificacion").html(cuerpo);
  $("#modalNotificacion").modal("show");
}

function formatoRangoFecha(fecha) {
  var aux = fecha.split('-');
  var fecIni = '2020-01-01';
  var fecEnd = '2025-01-01';
  if(aux.length === 3) {
    var year = Number(aux[0]);
    var month = Number(aux[1]);
    if(month===12) {
      fecIni = `${year}-${month<10 ? '0'+month : month}-01`;
      fecEnd = `${year+1}-01-01`;
    } else {
      fecIni = `${year}-${month<10 ? '0'+month : month}-01`;
      fecEnd = `${year}-${month+1<10 ? '0'+(month+1) : (month+1)}-01`;
    }
  }
  return [ fecIni, fecEnd ]
}

function llenarFiltroFecha() {
  var years = ['2020','2021','2022','2022','2023','2024','2025','2026','2027'];
  var months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Setiembre','Octubre','Noviembre','Diciembre'];
  var cuerpoFiltroYear='';
  for(var i = 0; i < years.length; i++){
    cuerpoFiltroYear += `<option value='${i}'>${years[i]}</option>`;
  }
  var cuerpoFiltroMonth='';
  for(var i = 0; i < months.length; i++){
    cuerpoFiltroMonth += `<option value='${i}'>${months[i]}</option>`;
  }
  return [cuerpoFiltroYear, cuerpoFiltroMonth];
}

$("#cancelarCargaPersonal").unbind('click').click(async function(){
  $("#desvincularCargaPersonal").attr("disabled","disabled");
});

$("#guardarIngresoPersonalInterno").unbind('click').click(function(){
  if($("#rutIngresoPersonalInterno").val().length == 0 || $("#apellidosIngresoPersonalInterno").val().length == 0 || $("#nombresIngresoPersonalInterno").val().length == 0 || $("#fechaNacIngresoPersonalInterno").val().length == 0 ){
    alertasToast("Debe completar todos los campos obligatorios (*)");
    if ($("#rutIngresoPersonalInterno").val().length == 0){
      $("#rutIngresoUsuario").addClass("is-invalid");
    }
    else if ($("#apellidosIngresoPersonalInterno").val().length == 0){
      $("#apellidosIngresoPersonalInterno").addClass("is-invalid");
    }
    else if ($("#nombresIngresoPersonalInterno").val().length == 0){
      $("#nombresIngresoPersonalInterno").addClass("is-invalid");
    }
    else if ($("#fechaNacIngresoPersonalInterno").val().length == 0){
      $("#fechaNacIngresoPersonalInterno").addClass("is-invalid");
    }

  }
  else {
    parametros = {
      "rutPersonal":   $.trim($("#rutIngresoPersonalInterno").val().replace('.','').replace('.','')),
      "nombresPersonal": $("#nombresIngresoPersonalInterno").val(),
      "apellidosPersonal": $("#apellidosIngresoPersonalInterno").val(),
      "nivelFuncional": $("#nivelFuncionalIngresoPersonalInterno").val(),
      "cargo": $("#cargoIngresoPersonalInterno").val(),
      "clasificacion": $("#clasificacionIngresoPersonalInterno").val(),
      "telefono": $("#telefonoIngresoPersonalInterno").val(),
      "direccion": $("#direccionIngresoPersonalInterno").val(),
      "sindicalizado": $("#sindicatoIngresoPersonalInterno").val(),
      "fechaNac": $("#fechaNacIngresoPersonalInterno").val(),
      "idComuna": $("#comunaIngresoPersonalInterno").val(),
      "sitMilitar": $("#sitMilitarIngresoPersonalInterno").val(),
      "estadoCivil": $("#estadoCivilIngresoPersonalInterno").val(),
      "nacionalidad": $("#nacionalidadIngresoPersonalInterno").val(),
      "fonoEmergencia": $("#telefonoEmergenciaIngresoPersonalInterno").val(),
      "contactoEmergencia": $("#contactoIngresoPersonalInterno").val(),
      "nivelEducacional": $("#nivelEduIngresoPersonalInterno").val(),
      "profesion": $("#profesionIngresoPersonalInterno").val(),
      "especialidad": $("#especialidadIngresoPersonalInterno").val(),
      "tipoContrato": $("#tipoContratoIngresoPersonalInterno").val(),
      "reqUniforme": $("#requiereUniformeIngresoPersonalInterno").val(),
      "cargas": $("#cargasIngresoPersonalInterno").val(),
      "cantidadCargas": $("#cantidadCargasIngresoPersonalInterno").val(),
      "planAPV": $("#planAPVIngresoPersonalInterno").val(),
      "montoAPV": $("#montoAPVIngresoPersonalInterno").val(),
      "poseeLicencia": $("#poseeLicenciaIngresoPersonalInterno").val(),
      "tipoLicencia": $("#tipoLicenciaIngresoPersonalInterno").val(),
      "sexo": $("#sexoIngresoPersonalInterno").val(),
      "tallaUniforme": $("#tallaIngresoPersonalInterno").val(),
      "idSindicato": $("#sindicatoIngresoPersonalInterno").val(),
      "tipoJornada": $("#tipoJornadaIngresoPersonalInterno").val()
    }
    // console.log(parametros);
    $.ajax({
      url: "controller/ingresaPersonalInterno.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            //var table = $('#tablaPersonalInterno').DataTable();
            //table.ajax.reload();


            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Personal interno agregado correctamente");


            $("#modalIngresoPersonalInterno").modal('hide');
          }
          else{

            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el personal interno, si el problema persiste favor comuniquese con soporte");


          }
        }
        else{

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el personal interno, si el problema persiste favor comuniquese con soporte");


        }
      }
    });
  }
});

$("#rutIngresoPersonalInterno").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#fechaNacIngresoPersonalInterno").on('input', function(){
  $(this).removeClass("is-invalid");
});

// FUNCION PARA MODAL INGRESAR SUCURSAL
$("#agregarSucursal").unbind("click").click(async function(){
  $("#modalIngresoSucursal").find("input,textarea,select").val("");
  $("#sucursalIngresoSucursal").removeClass("is-invalid");
  $("#bodegaIngresoSucursal").html('<option value="SI">SI</option>,<option value="NO">NO</option>');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  // Funcion para desplegar selector de Comuna desde BD
  await $.ajax({
    url:   'controller/datosAreaFuncional.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
        }
        $("#comunaIngresoSucursal").html(cuerpoEC);
        setTimeout(function(){
          $("#modalIngresoSucursal").modal("show");
          $('#modalAlertasSplash').modal('hide');
          setTimeout(function(){
            $('#bodyIngresoSucursal').animate({ scrollTop: 0 }, 'fast');
          },200);
        },500);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#comunaIngresoSucursal").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#bodegaIngresoSucursal").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

// Funcion para el evento del boton guardaSucursal del modal
$("#guardarIngresoSucursal").unbind('click').click(function(){
  if($("#sucursalIngresoSucursal").val().length == 0){
    alertasToast("Debe completar todos los campos");
    if ($("#sucursalIngresoSucursal").val().length == 0){
      $("#sucursalIngresoSucursal").addClass("is-invalid");
    }
  }
  else {
  $("#modalIngresoSucursal").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  parametros = {
    "sucursalIngreso": $("#sucursalIngresoSucursal").val(),
    "comuna":  $("#comunaIngresoSucursal").val(),
    "bodega": $("#bodegaIngresoSucursal").val()
  }

  $.ajax({
    url:   'controller/datosChequeaSucursal.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          alertasToast("La Sucursal ya existe");
          $("#sucursalIngresoSucursal").addClass("is-invalid");
          setTimeout(function(){
            $('#modalIngresoSucursal').modal('show');
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      // Ingrasamos la sucursal despues de verificar
      else {
        $.ajax({
          url: "controller/ingresaSucursal.php",
          type: 'POST',
          data: parametros,
          success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                var table = $('#tablaListadoSucursal').DataTable();
                table.ajax.reload();
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Sucursal Creado correctamente");
                $("#editarSucursal").attr("disabled","disabled");
                $("#eliminarSucursal").attr("disabled","disabled");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Sucursal, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
            else{
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Sucursal, si el problema persiste favor comuniquese con soporte");
            }
          }
        });
      }
    }
  });
}
});

$("#sucursalIngresoSucursal").on('input', function(){   // Removemos el is-invalid que se activo por dejar campo en blanco
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL INGRESAR SUCURSAL

// FUNCION PARA MODAL EDITAR SUCURSAL
$("#editarSucursal").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoSucursal').DataTable();
  var sucursal = $.map(table.rows('.selected').data(), function (item) {
      return item.SUCURSAL;
  });
  var bodega = $.map(table.rows('.selected').data(), function (item) {
    return item.BODEGA;
  });
  var comuna = $.map(table.rows('.selected').data(), function (item) {
    return item.COMUNA;
  });

  await $.ajax({
    url:   'controller/datosAreaFuncional.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].COMUNA == comuna){
            cuerpoEC += '<option selected value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
            $("#comunaEditarSucursal").html(cuerpoEC);
          }
          else{
            cuerpoEC += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
          }
        }
        $("#comunaEditarSucursal").html(cuerpoEC);
      }
    }
  });
  $("#sucursalEditarSucursal").val(sucursal);
  if (bodega[0] == "SI"){
    $("#bodegaEditarSucursal").html('<option value="SI">SI</option>,<option value="NO">NO</option>');
  }
  else {
    $("#bodegaEditarSucursal").html('<option value="NO">NO</option>,<option value="SI">SI</option>');
  }
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#comunaEditarSucursal").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#bodegaEditarSucursal").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    $('#modalEditarSucursal').modal('show');
    $('#modalAlertasSplash').modal('hide');
  },500);
});

// Funcion para guardar editar Sucursal
$("#guardarEditarSucursal").unbind('click').click(function(){
  var table = $('#tablaListadoSucursal').DataTable();
  var idSucursal = $.map(table.rows('.selected').data(), function (item) {
    return item.IDSUCURSAL;
  });
  parametros = {
    "idSucursal": idSucursal[0],
    "sucursal":  $("#sucursalEditarSucursal").val(),
    "comuna": $("#comunaEditarSucursal").val(),
    "bodega": $("#bodegaEditarSucursal").val()
  }
  $("#modalEditarSucursal").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarSucursal.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoSucursal').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Sucursal Editado correctamente");
          $("#editarSucursal").attr("disabled","disabled");
          $("#eliminarSucursal").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Sucursal, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Sucursal, si el problema persiste favor comuniquese con soporte");
      }
    }
  });
});
// FIN FUNCION PARA MODAL EDITAR SUCURSAL

// FUNCION PARA MODAL DESACTIVAR SUCURSAL
$("#eliminarSucursal").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoSucursal').DataTable();
  var sucursal = $.map(table.rows('.selected').data(), function (item) {
      return item.SUCURSAL;
  });
  var estado = $.map(table.rows('.selected').data(), function (item) {
    return item.ESTADO;
  });
  var idSucursal = $.map(table.rows('.selected').data(), function (item) {
    return item.IDSUCURSAL;
  });
  // Verificamos que la sucursal no este siendo usada por un personal
  parametros = {
    "idSucursal": idSucursal[0]
  }
  $.ajax({
    url:   'controller/sucursalPersonal.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Sucursal no se puede eliminar ya que tiene datos asociados (personal, patente u otros)");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else {
        if ((estado[0] == "Desactivado")){
          $("#textoNewEstadoSucursal").html("Activar");
          $("#tituloDesactivarSucursal").html("Activar Sucursal");
        }
        else {
          $("#textoNewEstadoSucursal").html("Desactivar");
          $("#tituloDesactivarSucursal").html("Desactivar Sucursal");
        }
        $("#textoDesactivarSucursal").html(sucursal);
        setTimeout(function(){
          $('#modalDesactivarSucursal').modal('show');
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#guardarDesactivarSucursal").unbind('click').click(async function(){
  $("#modalDesactivarSucursal").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoSucursal').DataTable();
  var idSucursal = $.map(table.rows('.selected').data(), function (item) {
      return item.IDSUCURSAL;
  });
  var estado = $.map(table.rows('.selected').data(), function (item) {
    return item.ESTADO;
  });
  parametros = {
    "idSucursal": idSucursal[0],
    "estado": estado[0]
  }
  await $.ajax({
    url:   'controller/desactivarSucursal.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoSucursal').DataTable();
          table.ajax.reload()
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          if (estado[0] == "Activo"){
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Sucursal Desactivado correctamente");
          }
          else {
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Sucursal Activado correctamente");
          }
          $("#editarSucursal").attr("disabled","disabled");
          $("#eliminarSucursal").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al desactivar la Sucursal, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al desactivar la Sucursal, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL DESACTIVAR SUCURSAL

function tomarFoto() {
  Webcam.snap(function (data_uri) {
    $('#fotografias').html(`<img src='${data_uri}'/>`);
  });
  Webcam.reset();
}

$("#jefaturaTablaInformes").unbind("click").change(function(e){
  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#jefaturaTablaInformes").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  e.preventDefault();
  e.stopImmediatePropagation()
  var table = $("#tablaInformes").DataTable();
  var jefe = $("#jefaturaTablaInformes").val();
  if(jefe == "Todos"){
    jefe = '';
  }
  table.rows('').deselect();
  table.columns('3').search(jefe).draw();

  var table = $('#tablaInformes').DataTable();
  var sin_problemas = table.column(9, { search:'applied' }).data().sum();
  var con_problemas = table.column(11, { search:'applied' }).data().sum();
  var total = table.column(13, { search:'applied' }).data().sum()

  if(total == 0){
    sin_problemas = 1;
    total = 1;
  }

  // console.log(total);

  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawChart);

  var changeJefe = document.getElementById('jefaturaTablaInformes');

  function drawChart() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Estado');
    data.addColumn('number', 'Porcentaje');
    data.addRow(['Con problemas', con_problemas/total]);
    data.addRow(['Sin problemas', sin_problemas/total]);

    var options = {
      title: '',
      // is3D: true,
      // pieSliceText: 'label',
      legend: {
        position: "right"
      },
      chartArea: {
        'width': '100%',
        'height': '100%',
        'bottom': 10,
        'top': 10
      },
      slices: {
        0: { color: '#c44e4e' },
        1: { color: '#095700' }
      }
    };

    var chart = new google.visualization.PieChart(document.getElementById('graficaTablaInformes'));

    chart.draw(data, options);
  }
  menuElegant();
  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
    setTimeout(function(){
      $('#tablaInformes').DataTable().columns.adjust();
    },500);
  },500);
});

$("#periodoTablaFormularios").unbind("click").change(async function(e){
  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  e.preventDefault();
  e.stopImmediatePropagation();

  var pFecha = $('#periodoTablaFormularios').val()
  var [ fecIni, fecEnd ] = formatoRangoFecha(`${pFecha}-01`);

  setTimeout(async function(){
    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
    await $('#tablaFormulario').DataTable( {
      ajax: {
        url: "controller/datosFormulario.php",
        type: 'POST',
        data: {
          path: '/' + window.location.href.split('#/')[1],
          fecIni: fecIni,
          fecEnd: fecEnd
        }
      },
      columns: [
        { data: 'S'},
        { data: 'idFORMULARIO', className: "centerDataTable"},
        { data: 'AUDITORIA'},
        { data: 'SERVICIO'},
        { data: 'RUT'},
        { data: 'NOMBRE'},
        { data: 'FECHA'},
        { data: 'HORA'},
        { data: 'TAREA' },
        { data: 'DIRECCIONCLIENTE' },
        { data: 'RUTCLIENTE' },
        { data: 'FECHAINSTALACION' },
        { data: 'RUT_AUDITOR' },
        { data: 'NOMBRE_AUDITOR' },
        { data: 'NOTA', className: "centerDataTable" },
        { data: 'PDF', className: "centerDataTable" }
      ],
      buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        },
        {
          text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonFormulariosRealizados"></span>&nbsp;&nbsp;Filtros',
          action: function(){
            if($("#filtrosFormulariosRealizados").height() > 60){
              $("#filtrosFormulariosRealizados").css("height","0");
              $("#filtrosFormulariosRealizados").fadeOut();
              $("#spanButtonFormulariosRealizados").removeClass("fas fa-arrow-alt-circle-up");
              $("#spanButtonFormulariosRealizados").addClass("fas fa-arrow-alt-circle-down");
            }
            else{
              $("#filtrosFormulariosRealizados").css("height","90pt");
              $("#filtrosFormulariosRealizados").fadeIn();
              $("#spanButtonFormulariosRealizados").removeClass("fas fa-arrow-alt-circle-down");
              $("#spanButtonFormulariosRealizados").addClass("fas fa-arrow-alt-circle-up");
            }
          }
        }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        }
      ],
      "select": {
        style: 'multi',
        selector: 'td:not(:nth-child(14))'
      },
      fixedColumns:   {
        leftColumns: 2
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "order": [[ 1, "desc" ]],
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json) {
        var table = $('#tablaFormulario').DataTable();

        $('#contenido').show();
        $('#menu-lateral').show();
        $('#footer').parent().show();
$('#footer').show();

        var table = $('#tablaFormulario').DataTable();

        var cuerpoAuditoria = '';
        cuerpoAuditoria += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(2).data().unique().length; i++){
          if(table.column(2).data().unique()[i] !== null){
            cuerpoAuditoria += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
          }
        }
        $("#auditoriaTablaFormularios").html(cuerpoAuditoria);

        var cuerpoServicio = '';
        cuerpoServicio += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(3).data().unique().length; i++){
          if(table.column(3).data().unique()[i] !== null){
            cuerpoServicio += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
          }
        }
        $("#servicioTablaFormularios").html(cuerpoServicio);

        if($("#filtrosFormulariosRealizados").height() > 60){
          $("#spanButtonFormulariosRealizados").removeClass("fas fa-arrow-alt-circle-down");
          $("#spanButtonFormulariosRealizados").addClass("fas fa-arrow-alt-circle-up");
        }
        else{
          $("#spanButtonFormulariosRealizados").removeClass("fas fa-arrow-alt-circle-up");
          $("#spanButtonFormulariosRealizados").addClass("fas fa-arrow-alt-circle-down");
        }
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          setTimeout(function(){
            $('#tablaFormulario').DataTable().columns.adjust();
          },500);
        },500);
      }
    });

    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#periodoTablaFormularios").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#auditoriaTablaFormularios").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#servicioTablaFormularios").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
    menuElegant();
  },1500);

});

$("#auditoriaTablaFormularios").unbind("click").change(async function(e){
  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaFormulario").DataTable();
  var mano = $("#auditoriaTablaFormularios").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('2').search(mano).draw();

  menuElegant();
  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
  },500);
});

$("#servicioTablaFormularios").unbind("click").change(async function(e){
  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaFormulario").DataTable();
  var mano = $("#servicioTablaFormularios").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('3').search(mano).draw();

  menuElegant();
  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
  },500);
});

$("#periodoTablaInformes").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  e.preventDefault();
  e.stopImmediatePropagation();

  var parametrosSemana = {
    'periodo': $("#periodoTablaInformes").val()
  }

  await $.ajax({
    url:   'controller/datosInformePracticasGlobalSemana.php',
    type:  'post',
    data:  parametrosSemana,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoSemana = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoSemana += '<option value="' + p2.aaData[i].SEMANA + '">' + p2.aaData[i].SEMANA + '</option>';
        }
        $("#semanaTablaInformesComun").html(cuerpoSemana);
      }
    }
  });

  parametrosSemana.semana = $("#semanaTablaInformesComun").val();

  await $.ajax({
    url:   'controller/datosInformePracticasGlobalAuditoria.php',
    type:  'post',
    data:  parametrosSemana,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAuditoria= '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAuditoria += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].AUDITORIA + '</option>';
        }
        $("#auditoriaTablaInformesComun").html(cuerpoAuditoria);
      }
    }
  });

  parametrosSemana.auditoria = $("#auditoriaTablaInformesComun").val();

  await $.ajax({
    url:   'controller/datosInformePracticasGlobalServicio.php',
    type:  'post',
    data:  parametrosSemana,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoServicio = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoServicio += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].SERVICIO + '</option>';
        }
        $("#servicioTablaInformesComun").html(cuerpoServicio);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#periodoTablaInformes").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#semanaTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#auditoriaTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

  var fecha = new Date();

  var parametros = {
    "path": path,
    "mes": $("#periodoTablaInformes").val().split("-")[1],
    "ano": $("#periodoTablaInformes").val().split("-")[0],
    'semana': $("#semanaTablaInformesComun").val(),
    'auditoria': $("#auditoriaTablaInformesComun").val(),
    'servicio': $("#servicioTablaInformesComun").val()
  }

  await $('#tablaInformes').DataTable( {
    ajax: {
        url: "controller/datosInformePracticasGlobal.php",
        type: 'POST',
        data: parametros
    },
    columns: [
        { data: 'S'},
        { data: 'DNI' },
        { data: 'NOMBRE' },
        { data: 'JEFE' },
        { data: 'COMUNA' },
        { data: 'EMPRESA' },
        { data: 'SERVICIO' },
        { data: 'CLIENTE' },
        { data: 'ACTIVIDAD' },
        { data: 'BUENAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'BUENAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'MALAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'MALAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'TOTAL', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'CALIFICACION', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'BUENAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'BUENAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'MALAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'MALAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
    ],
    /*rowReorder: {
      selector: 'td:nth-child(2)'
    },*/
    buttons: [
      {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,15,16,17,18,13,14 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
      }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 15 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 16 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 17 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 18 ]
      }
    ],
    "select": {
        style: 'single'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "order": [[ 14, "desc" ]],
    "info":     true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){
          var table = $('#tablaInformes').DataTable();
          var sin_problemas = table.column(9, { search:'applied' }).data().sum();
          var con_problemas = table.column(11, { search:'applied' }).data().sum();
          var total = table.column(13, { search:'applied' }).data().sum()

          if(total == 0){
            sin_problemas = 1;
            total = 1;
          }

          google.charts.load('current', {'packages':['corechart']});
          google.charts.setOnLoadCallback(drawChart);

          var changeJefe = document.getElementById('jefaturaTablaInformes');

          function drawChart() {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Estado');
            data.addColumn('number', 'Porcentaje');
            data.addRow(['Con problemas', con_problemas/total]);
            data.addRow(['Sin problemas', sin_problemas/total]);

            var options = {
              title: '',
              // is3D: true,
              // pieSliceText: 'label',
              legend: {
                position: "right"
              },
              chartArea: {
                'width': '100%',
                'height': '100%',
                'bottom': 10,
                'top': 10
              },
              slices: {
                0: { color: '#c44e4e' },
                1: { color: '#095700' }
              }
            };

            var chart = new google.visualization.PieChart(document.getElementById('graficaTablaInformes'));

            chart.draw(data, options);
          }

          var jefaturaInformeGlobal = '';
          jefaturaInformeGlobal += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(3).data().unique().length; i++){
            if(table.column(3).data().unique()[i] !== null){
              jefaturaInformeGlobal += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
            }
          }
          $("#jefaturaTablaInformes").html(jefaturaInformeGlobal);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#jefaturaTablaInformes").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
          $('#footer').show();
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaInformes').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
});

$("#semanaTablaInformesComun").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  e.preventDefault();
  e.stopImmediatePropagation();

  var parametrosSemana = {
    'periodo': $("#periodoTablaInformes").val()
  }

  parametrosSemana.semana = $("#semanaTablaInformesComun").val();

  await $.ajax({
    url:   'controller/datosInformePracticasGlobalAuditoria.php',
    type:  'post',
    data:  parametrosSemana,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAuditoria= '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAuditoria += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].AUDITORIA + '</option>';
        }
        $("#auditoriaTablaInformesComun").html(cuerpoAuditoria);
      }
    }
  });

  parametrosSemana.auditoria = $("#auditoriaTablaInformesComun").val();

  await $.ajax({
    url:   'controller/datosInformePracticasGlobalServicio.php',
    type:  'post',
    data:  parametrosSemana,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoServicio = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoServicio += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].SERVICIO + '</option>';
        }
        $("#servicioTablaInformesComun").html(cuerpoServicio);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#periodoTablaInformes").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#semanaTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#auditoriaTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

  var fecha = new Date();

  var parametros = {
    "path": path,
    "mes": $("#periodoTablaInformes").val().split("-")[1],
    "ano": $("#periodoTablaInformes").val().split("-")[0],
    'semana': $("#semanaTablaInformesComun").val(),
    'auditoria': $("#auditoriaTablaInformesComun").val(),
    'servicio': $("#servicioTablaInformesComun").val()
  }

  await $('#tablaInformes').DataTable( {
    ajax: {
        url: "controller/datosInformePracticasGlobal.php",
        type: 'POST',
        data: parametros
    },
    columns: [
        { data: 'S'},
        { data: 'DNI' },
        { data: 'NOMBRE' },
        { data: 'JEFE' },
        { data: 'COMUNA' },
        { data: 'EMPRESA' },
        { data: 'SERVICIO' },
        { data: 'CLIENTE' },
        { data: 'ACTIVIDAD' },
        { data: 'BUENAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'BUENAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'MALAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'MALAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'TOTAL', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'CALIFICACION', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'BUENAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'BUENAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'MALAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'MALAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
    ],
    /*rowReorder: {
      selector: 'td:nth-child(2)'
    },*/
    buttons: [
      {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,15,16,17,18,13,14 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
      }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 15 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 16 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 17 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 18 ]
      }
    ],
    "select": {
        style: 'single'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "order": [[ 14, "desc" ]],
    "info":     true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){
          var table = $('#tablaInformes').DataTable();
          var sin_problemas = table.column(9, { search:'applied' }).data().sum();
          var con_problemas = table.column(11, { search:'applied' }).data().sum();
          var total = table.column(13, { search:'applied' }).data().sum()

          if(total == 0){
            sin_problemas = 1;
            total = 1;
          }

          google.charts.load('current', {'packages':['corechart']});
          google.charts.setOnLoadCallback(drawChart);

          var changeJefe = document.getElementById('jefaturaTablaInformes');

          function drawChart() {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Estado');
            data.addColumn('number', 'Porcentaje');
            data.addRow(['Con problemas', con_problemas/total]);
            data.addRow(['Sin problemas', sin_problemas/total]);

            var options = {
              title: '',
              // is3D: true,
              // pieSliceText: 'label',
              legend: {
                position: "right"
              },
              chartArea: {
                'width': '100%',
                'height': '100%',
                'bottom': 10,
                'top': 10
              },
              slices: {
                0: { color: '#c44e4e' },
                1: { color: '#095700' }
              }
            };

            var chart = new google.visualization.PieChart(document.getElementById('graficaTablaInformes'));

            chart.draw(data, options);
          }

          var jefaturaInformeGlobal = '';
          jefaturaInformeGlobal += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(3).data().unique().length; i++){
            if(table.column(3).data().unique()[i] !== null){
              jefaturaInformeGlobal += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
            }
          }
          $("#jefaturaTablaInformes").html(jefaturaInformeGlobal);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#jefaturaTablaInformes").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
          $('#footer').show();
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaInformes').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
});

$("#auditoriaTablaInformesComun").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  e.preventDefault();
  e.stopImmediatePropagation();

  var parametrosSemana = {
    'periodo': $("#periodoTablaInformes").val()
  }

  parametrosSemana.semana = $("#semanaTablaInformesComun").val();
  parametrosSemana.auditoria = $("#auditoriaTablaInformesComun").val();

  if($("#servicioTablaInformesComun").val() == 0){
    await $.ajax({
      url:   'controller/datosInformePracticasGlobalServicio.php',
      type:  'post',
      data:  parametrosSemana,
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoServicio = '<option selected value="0">Todas</option>';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoServicio += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].SERVICIO + '</option>';
          }
          $("#servicioTablaInformesComun").html(cuerpoServicio);
        }
      }
    });
  }
  else{
    var sel = $("#servicioTablaInformesComun").val();
    await $.ajax({
      url:   'controller/datosInformePracticasGlobalServicio.php',
      type:  'post',
      data:  parametrosSemana,
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoServicio = '<option selected value="0">Todas</option>';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoServicio += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].SERVICIO + '</option>';
          }
          $("#servicioTablaInformesComun").html(cuerpoServicio);
          $("#servicioTablaInformesComun").val(sel);
        }
      }
    });
  }

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#periodoTablaInformes").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#semanaTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#auditoriaTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }



  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

  var fecha = new Date();

  var parametros = {
    "path": path,
    "mes": $("#periodoTablaInformes").val().split("-")[1],
    "ano": $("#periodoTablaInformes").val().split("-")[0],
    'semana': $("#semanaTablaInformesComun").val(),
    'auditoria': $("#auditoriaTablaInformesComun").val(),
    'servicio': $("#servicioTablaInformesComun").val()
  }

  await $('#tablaInformes').DataTable( {
    ajax: {
        url: "controller/datosInformePracticasGlobal.php",
        type: 'POST',
        data: parametros
    },
    columns: [
        { data: 'S'},
        { data: 'DNI' },
        { data: 'NOMBRE' },
        { data: 'JEFE' },
        { data: 'COMUNA' },
        { data: 'EMPRESA' },
        { data: 'SERVICIO' },
        { data: 'CLIENTE' },
        { data: 'ACTIVIDAD' },
        { data: 'BUENAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'BUENAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'MALAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'MALAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'TOTAL', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'CALIFICACION', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'BUENAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'BUENAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'MALAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'MALAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
    ],
    /*rowReorder: {
      selector: 'td:nth-child(2)'
    },*/
    buttons: [
      {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,15,16,17,18,13,14 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
      }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 15 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 16 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 17 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 18 ]
      }
    ],
    "select": {
        style: 'single'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "order": [[ 14, "desc" ]],
    "info":     true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){
          var table = $('#tablaInformes').DataTable();
          var sin_problemas = table.column(9, { search:'applied' }).data().sum();
          var con_problemas = table.column(11, { search:'applied' }).data().sum();
          var total = table.column(13, { search:'applied' }).data().sum()

          if(total == 0){
            sin_problemas = 1;
            total = 1;
          }

          google.charts.load('current', {'packages':['corechart']});
          google.charts.setOnLoadCallback(drawChart);

          var changeJefe = document.getElementById('jefaturaTablaInformes');

          function drawChart() {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Estado');
            data.addColumn('number', 'Porcentaje');
            data.addRow(['Con problemas', con_problemas/total]);
            data.addRow(['Sin problemas', sin_problemas/total]);

            var options = {
              title: '',
              // is3D: true,
              // pieSliceText: 'label',
              legend: {
                position: "right"
              },
              chartArea: {
                'width': '100%',
                'height': '100%',
                'bottom': 10,
                'top': 10
              },
              slices: {
                0: { color: '#c44e4e' },
                1: { color: '#095700' }
              }
            };

            var chart = new google.visualization.PieChart(document.getElementById('graficaTablaInformes'));

            chart.draw(data, options);
          }

          var jefaturaInformeGlobal = '';
          jefaturaInformeGlobal += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(3).data().unique().length; i++){
            if(table.column(3).data().unique()[i] !== null){
              jefaturaInformeGlobal += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
            }
          }
          $("#jefaturaTablaInformes").html(jefaturaInformeGlobal);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#jefaturaTablaInformes").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaInformes').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
});

$("#servicioTablaInformesComun").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  e.preventDefault();
  e.stopImmediatePropagation();

  var parametrosSemana = {
    'periodo': $("#periodoTablaInformes").val()
  }

  parametrosSemana.semana = $("#semanaTablaInformesComun").val();
  parametrosSemana.servicio = $("#servicioTablaInformesComun").val();

  if($("#auditoriaTablaInformesComun").val() == 0){
    await $.ajax({
      url:   'controller/datosInformePracticasGlobalAuditoria.php',
      type:  'post',
      data:  parametrosSemana,
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoAuditoria= '<option selected value="0">Todas</option>';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoAuditoria += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].AUDITORIA + '</option>';
          }
          $("#auditoriaTablaInformesComun").html(cuerpoAuditoria);
        }
      }
    });
  }
  else{
    var sel = $("#auditoriaTablaInformesComun").val();
    await $.ajax({
      url:   'controller/datosInformePracticasGlobalAuditoria.php',
      type:  'post',
      data:  parametrosSemana,
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoAuditoria= '<option selected value="0">Todas</option>';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoAuditoria += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].AUDITORIA + '</option>';
          }
          $("#auditoriaTablaInformesComun").html(cuerpoAuditoria);
          $("#auditoriaTablaInformesComun").val(sel);
        }
      }
    });
  }

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#periodoTablaInformes").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#semanaTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#auditoriaTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioTablaInformesComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

  var fecha = new Date();

  var parametros = {
    "path": path,
    "mes": $("#periodoTablaInformes").val().split("-")[1],
    "ano": $("#periodoTablaInformes").val().split("-")[0],
    'semana': $("#semanaTablaInformesComun").val(),
    'auditoria': $("#auditoriaTablaInformesComun").val(),
    'servicio': $("#servicioTablaInformesComun").val()
  }

  await $('#tablaInformes').DataTable( {
    ajax: {
        url: "controller/datosInformePracticasGlobal.php",
        type: 'POST',
        data: parametros
    },
    columns: [
        { data: 'S'},
        { data: 'DNI' },
        { data: 'NOMBRE' },
        { data: 'JEFE' },
        { data: 'COMUNA' },
        { data: 'EMPRESA' },
        { data: 'SERVICIO' },
        { data: 'CLIENTE' },
        { data: 'ACTIVIDAD' },
        { data: 'BUENAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'BUENAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'MALAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'MALAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'TOTAL', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'CALIFICACION', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'BUENAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'BUENAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
        { data: 'MALAS', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 0, '' )},
        { data: 'MALAS_POR', className: "centerDataTable", render: $.fn.dataTable.render.number( '', '.', 2, '' )},
    ],
    /*rowReorder: {
      selector: 'td:nth-child(2)'
    },*/
    buttons: [
      {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,15,16,17,18,13,14 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
      }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 15 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 16 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 17 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 18 ]
      }
    ],
    "select": {
        style: 'single'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "order": [[ 14, "desc" ]],
    "info":     true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){
          var table = $('#tablaInformes').DataTable();
          var sin_problemas = table.column(9, { search:'applied' }).data().sum();
          var con_problemas = table.column(11, { search:'applied' }).data().sum();
          var total = table.column(13, { search:'applied' }).data().sum();

          if(total == 0){
            sin_problemas = 1;
            total = 1;
          }

          google.charts.load('current', {'packages':['corechart']});
          google.charts.setOnLoadCallback(drawChart);

          var changeJefe = document.getElementById('jefaturaTablaInformes');

          function drawChart() {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Estado');
            data.addColumn('number', 'Porcentaje');
            data.addRow(['Con problemas', con_problemas/total]);
            data.addRow(['Sin problemas', sin_problemas/total]);

            var options = {
              title: '',
              // is3D: true,
              // pieSliceText: 'label',
              legend: {
                position: "right"
              },
              chartArea: {
                'width': '100%',
                'height': '100%',
                'bottom': 10,
                'top': 10
              },
              slices: {
                0: { color: '#c44e4e' },
                1: { color: '#095700' }
              }
            };

            var chart = new google.visualization.PieChart(document.getElementById('graficaTablaInformes'));

            chart.draw(data, options);
          }

          var jefaturaInformeGlobal = '';
          jefaturaInformeGlobal += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(3).data().unique().length; i++){
            if(table.column(3).data().unique()[i] !== null){
              jefaturaInformeGlobal += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
            }
          }
          $("#jefaturaTablaInformes").html(jefaturaInformeGlobal);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#jefaturaTablaInformes").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaInformes').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
});

// FUNCION PARA MODAL INGRESAR TIPOVEHICULO
$("#agregarTipoVehiculo").unbind("click").click(async function(){
  $("#nombreIngresoTipoVehiculo").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#nombreIngresoTipoVehiculo").val("");
// Funcion para desplegar selector de TipoLicencia desde BD
  await $.ajax({
    url:   'controller/datosTipoLicencia.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].TIPO_LICENCIA + '">' + p2.aaData[i].TIPO_LICENCIA + '</option>';
        }
        $("#licenciaIngresoTipoVehiculo").html(cuerpoEC);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosCheckTipoVehiculo.php',
    type:  'post',
    success: function (resp) {
      var m = jQuery.parseJSON(resp);
      if(m.aaData.length !== 0){
        var cuerpoCT = '';
        for(var i = 0; i < m.aaData.length; i++){
          cuerpoCT += '<option value="' + m.aaData[i].NOMBRE + '">' + m.aaData[i].NOMBRE + '</option>';
        }
        $("#checktipoIngresoTipoVehiculo").html(cuerpoCT);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
  $("#licenciaIngresoTipoVehiculo").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
  });
  $("#checktipoIngresoTipoVehiculo").select2({
    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
  });
}
  setTimeout(function(){
    $("#modalIngresoTipoVehiculo").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoTipoVehiculo').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

// Funcion para el evento del boton guardaTipoVehiculo del modal
$("#guardarIngresoTipoVehiculo").unbind('click').click(function(){
  if($("#nombreIngresoTipoVehiculo").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#nombreIngresoTipoVehiculo").val().length == 0){
      $("#nombreIngresoTipoVehiculo").addClass("is-invalid");
    }
  }
  else {
    $("#modalIngresoTipoVehiculo").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    parametros = {
      "nombre": $("#nombreIngresoTipoVehiculo").val(),
      "checktipo": $("#checktipoIngresoTipoVehiculo").val(),
      "licencia":  $("#licenciaIngresoTipoVehiculo").val(),
    }
    $.ajax({
    url:   'controller/datosChequeaTipoVehiculo.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El Tipo de Vehiculo ya existe");
          $("#nombreIngresoTipoVehiculo").addClass("is-invalid");
          setTimeout(function(){
            $('#modalIngresoTipoVehiculo').modal('show');
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      // Ingrasamos TipoVehiculo despues de verificar
      else {
        $.ajax({
          url: "controller/ingresaTipoVehiculo.php",
          type: 'POST',
          data: parametros,
          success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                var table = $('#tablaListadoTipoVehiculo').DataTable();
                table.ajax.reload();
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Tipo de Vehículo Creado correctamente");
                $("#editarTipoVehiculo").attr("disabled","disabled");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Tipo de Vehículo, si el problema persiste favor comuniquese con soporte");
                etTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Tipo de Vehículo, si el problema persiste favor comuniquese con soporte");
              etTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
        });
      }
    }
  });
  }
});

$("#nombreIngresoTipoVehiculo").on('input', function(){   // Removemos el is-invalid que se activo por dejar campo en blanco
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL INGRESAR TIPOVEHICULO

// FUNCION PARA MODAL EDITAR TIPO VEHICULO
$("#editarTipoVehiculo").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoTipoVehiculo').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  var licencia = $.map(table.rows('.selected').data(), function (item) {
    return item.LICENCIA;
  });
  var checktipo = $.map(table.rows('.selected').data(), function (item) {
    return item.CHECKTIPO;
  });
  await $.ajax({
    url:   'controller/datosTipoLicencia.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].TIPO_LICENCIA == licencia[0]){
            cuerpoEC += '<option selected value="' + p2.aaData[i].TIPO_LICENCIA + '">' + p2.aaData[i].TIPO_LICENCIA + '</option>';
            $("#licenciaEditarTipoVehiculo").html(cuerpoEC);
          }
          else{
            cuerpoEC += '<option value="' + p2.aaData[i].TIPO_LICENCIA + '">' + p2.aaData[i].TIPO_LICENCIA + '</option>';
          }
        }
        $("#licenciaEditarTipoVehiculo").html(cuerpoEC);
        setTimeout(function(){
          $('#modalEditarTipoVehiculo').modal('show');
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosCheckTipoVehiculo.php',
    type:  'post',
    success: function (response) {
      var p21 = jQuery.parseJSON(response);
      if(p21.aaData.length !== 0){
        var cuerpoCH = '';
        for(var i = 0; i < p21.aaData.length; i++){
          if(p21.aaData[i].NOMBRE == checktipo[0]){
            cuerpoCH += '<option selected value="' + p21.aaData[i].NOMBRE + '">' + p21.aaData[i].NOMBRE + '</option>';
            $("#checkTipoEditarTipoVehiculo").html(cuerpoCH);
          }
          else{
            cuerpoCH += '<option value="' + p21.aaData[i].NOMBRE + '">' + p21.aaData[i].NOMBRE + '</option>';
          }
        }
        $("#checkTipoEditarTipoVehiculo").html(cuerpoCH);
      }
    }
  });
  $("#nombreEditarTipoVehiculo").val(nombre);
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#licenciaEditarTipoVehiculo").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#checkTipoEditarTipoVehiculo").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalEditarTipoVehiculo").modal("show");
    $('#modalAlertasSplash').modal('hide');
  },500);
});

// Funcion para guardar editar TipoVehiculo
$("#guardarEditarTipoVehiculo").unbind('click').click(function(){
  var table = $('#tablaListadoTipoVehiculo').DataTable();
  var idTipoVehiculo = $.map(table.rows('.selected').data(), function (item) {
    return item.IDPATENTE_TIPOVEHICULO;
  });
  parametros = {
    "idTipoVehiculo": idTipoVehiculo[0],
    "nombre":  $("#nombreEditarTipoVehiculo").val(),
    "licencia": $("#licenciaEditarTipoVehiculo").val(),
    "checktipo": $("#checkTipoEditarTipoVehiculo").val(),
  }
  $("#modalEditarTipoVehiculo").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarTipoVehiculo.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoTipoVehiculo').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Tipo de Vehiculo Editado correctamente");
          $("#editarTipoVehiculo").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Tipo de Vehiculo, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Tipo de Vehiculo, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL EDITAR TIPO VEHICULO

// FUNCION PARA MODAL INGRESAR MARCAMODELO
$("#agregarMarcaModelo").unbind("click").click(async function(){
  $("#modalIngresoMarcaModelo").find("input,textarea,select").val("");
  $("#marcaIngresoMarcaModelo").removeClass("is-invalid");
  $("#modeloIngresoMarcaModelo").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  setTimeout(function(){
    $("#modalIngresoMarcaModelo").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoMarcaModelo').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

// Funcion para el evento del boton guardaMarcaModelo del modal
$("#guardarIngresoMarcaModelo").unbind('click').click(function(){
  if($("#marcaIngresoMarcaModelo").val().length == 0 || $("#modeloIngresoMarcaModelo").val().length == 0 ){
    alertasToast("Debe completar todos los campos marcados");
    if ($("#marcaIngresoMarcaModelo").val().length == 0){
      $("#marcaIngresoMarcaModelo").addClass("is-invalid");
    }
    if ($("#modeloIngresoMarcaModelo").val().length == 0){
      $("#modeloIngresoMarcaModelo").addClass("is-invalid");
    }
  }
  else {
    $("#modalIngresoMarcaModelo").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    parametros = {
      "marca": $("#marcaIngresoMarcaModelo").val(),
      "modelo":  $("#modeloIngresoMarcaModelo").val(),
      "litros":  $("#litrosIngresoMarcaModelo").val(),
    }
    $.ajax({
      url:   'controller/datosChequeaMarcaModelo.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            alertasToast("La Marca y Modelo ya existen");
            $("#marcaIngresoMarcaModelo").addClass("is-invalid");
            $("#modeloIngresoMarcaModelo").addClass("is-invalid");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalIngresoMarcaModelo").modal("show");
            },500);
          }
        }
        // Ingresamos Marca Modelo despues de verificar
        else {
          $.ajax({
            url: "controller/ingresaMarcaModelo.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
              var p = response.split(",");
              if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaListadoMarcaModelo').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Marca Modelo Creado correctamente");
                  $("#editarMarcaModelo").attr("disabled","disabled");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Marca Modelo, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Marca Modelo, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
          });
        }
      }
    });
  }
});

$("#marcaIngresoMarcaModelo").on('input', function(){   // Removemos el is-invalid que se activo por dejar campo en blanco
  $(this).removeClass("is-invalid");
});

$("#modeloIngresoMarcaModelo").on('input', function(){   // Removemos el is-invalid que se activo por dejar campo en blanco
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL INGRESAR MARCAMODELO

// FUNCION PARA MODAL EDITAR MARCAMODELO
$("#editarMarcaModelo").unbind('click').click( async function(){
  var table = $('#tablaListadoMarcaModelo').DataTable();
  var marca = $.map(table.rows('.selected').data(), function (item) {
      return item.MARCA;
  });
  var modelo = $.map(table.rows('.selected').data(), function (item) {
    return item.MODELO;
  });
  var litros = $.map(table.rows('.selected').data(), function (item) {
    return item.LITROS_ESTANQUE;
  });
  $("#marcaEditarMarcaModelo").val(marca);
  $("#modeloEditarMarcaModelo").val(modelo);
  $("#litrosEditarMarcaModelo").val(litros);
  $('#modalEditarMarcaModelo').modal('show');
});

// Funcion para guardar editar MarcaModelo
$("#guardarEditarMarcaModelo").unbind('click').click(function(){
  $("#modalEditarMarcaModelo").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoMarcaModelo').DataTable();
  var idMarcaModelo = $.map(table.rows('.selected').data(), function (item) {
    return item.IDPATENTE_MARCAMODELO;
  });
  parametros = {
    "idTipoVehiculo": idMarcaModelo[0],
    "marca":  $("#marcaEditarMarcaModelo").val(),
    "modelo": $("#modeloEditarMarcaModelo").val(),
    "litros": $("#litrosEditarMarcaModelo").val(),
  }
  $("#modalEditarMarcaModelo").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarMarcaModelo.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoMarcaModelo').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Marca Modelo Editado correctamente");
          $("#editarMarcaModelo").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Marca Modelo, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Marca Modelo, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#marcaEditarMarcaModelo").on('input', function(){   // Removemos el is-invalid que se activo por dejar campo en blanco
  $(this).removeClass("is-invalid");
});
$("#modeloEditarMarcaModelo").on('input', function(){   // Removemos el is-invalid que se activo por dejar campo en blanco
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL EDITAR MARCAMODELO

// FUNCION PARA MODAL INGRESAR TALLER
$("#agregarTaller").unbind("click").click(async function(){
  $("#modalIngresoTaller").find("input,textarea,select").val("");
  $("#rutIngresoTaller").removeClass("is-invalid");
  $("#nombreIngresoTaller").removeClass("is-invalid");
  $("#monedaIngresoTaller").removeClass("is-invalid");
  $("#direccionIngresoTaller").removeClass("is-invalid");
  $("#comunaIngresoTaller").removeClass("is-invalid");
  $("#contactoIngresoTaller").removeClass("is-invalid");
  $("#emailIngresoTaller").removeClass("is-invalid");
  $("#telefonoIngresoTaller").removeClass("is-invalid");
  $("#monedaIngresoTaller").html('<option value="UF">UF</option>,<option value="Peso">Peso</option>');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  // Funcion para desplegar selector de Comuna desde BD
  await $.ajax({
    url:   'controller/datosAreaFuncional.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
        }
        $("#comunaIngresoTaller").html(cuerpoEC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#comunaIngresoTaller").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#monedaIngresoTaller").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      var h = $(window).height() - 200;
      $("#bodyIngresoTaller").css("height",h);
    }
    $("#modalIngresoTaller").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoTaller').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("input#rutIngresoTaller").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutIngresoTaller").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutIngresoTaller").val("");
    $("#rutIngresoTaller").addClass("is-invalid");
  }
});

// Funcion para el evento del boton guardaTaller del modal
$("#guardarIngresoTaller").unbind('click').click(function(){
  if($("#rutIngresoTaller").val().length == 0 || $("#nombreIngresoTaller").val().length == 0 || $("#monedaIngresoTaller").val().length == 0 || $("#direccionIngresoTaller").val().length == 0 || $("#comunaIngresoTaller").val().length == 0 ){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos marcados");
    if ($("#rutIngresoTaller").val().length == 0){
      $("#rutIngresoTaller").addClass("is-invalid");
    }
    if ($("#nombreIngresoTaller").val().length == 0){
      $("#nombreIngresoTaller").addClass("is-invalid");
    }
    if ($("#direccionIngresoTaller").val().length == 0){
      $("#direccionIngresoTaller").addClass("is-invalid");
    }
    if ($("#monedaIngresoTaller").val().length == 0){
      $("#monedaIngresoTaller").addClass("is-invalid");
    }
    if ($("#comunaIngresoTaller").val().length == 0){
      $("#comunaIngresoTaller").addClass("is-invalid");
    }
  }
  else {
    $("#modalIngresoTaller").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    parametros = {
      "rutIngreso": $.trim($("#rutIngresoTaller").val().replace('.','').replace('.','')),
      "nombreIngreso":  $("#nombreIngresoTaller").val(),
      "monedaIngreso": $("#monedaIngresoTaller").val(),
      "direccionIngreso": $("#direccionIngresoTaller").val(),
      "comunaIngreso": $("#comunaIngresoTaller").val(),
      "contactoIngreso": $("#contactoIngresoTaller").val(),
      "emailIngreso": $("#emailIngresoTaller").val(),
      "telefonoIngreso": $("#telefonoIngresoTaller").val()
    }
    $.ajax({
      url: "controller/ingresaTaller.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoTaller').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Taller Creado correctamente");
            $("#editarTaller").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Taller, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Taller, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#rutIngresoTaller").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombreIngresoTaller").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#direccionIngresoTaller").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#contactoIngresoTaller").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#emailIngresoTaller").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#telefonoIngresoTaller").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL INGRESAR TALLER

// FUNCION PARA MODAL EDITAR TALLER
$("#editarTaller").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoTaller').DataTable();
  var rut = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT;
  });
  var nombre = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBRE;
  });
  var direccion = $.map(table.rows('.selected').data(), function (item) {
    return item.DIRECCION;
  });
  var contacto = $.map(table.rows('.selected').data(), function (item) {
    return item.CONTACTO;
  });
  var email = $.map(table.rows('.selected').data(), function (item) {
    return item.EMAIL;
  });
  var telefono = $.map(table.rows('.selected').data(), function (item) {
    return item.TELEFONO;
  });
  var moneda = $.map(table.rows('.selected').data(), function (item) {
    return item.MONEDA;
  });
  var comuna = $.map(table.rows('.selected').data(), function (item) {
    return item.COMUNA;
  });

  await $.ajax({
    url:   'controller/datosAreaFuncional.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].COMUNA == comuna){
            cuerpoEC += '<option selected value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
            $("#comunaEditarTaller").html(cuerpoEC);
          }
          else{
            cuerpoEC += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
          }
        }
        $("#comunaEditarTaller").html(cuerpoEC);
      }
    }
  });
  $("#rutEditarTaller").val(rut);
  $("#rutEditarTaller").attr("disabled","disabled");
  $("#nombreEditarTaller").val(nombre);
  $("#direccionEditarTaller").val(direccion);
  $("#contactoEditarTaller").val(contacto);
  $("#emailEditarTaller").val(email);
  $("#telefonoEditarTaller").val(telefono);
  if (moneda[0] == "UF"){
    $("#monedaEditarTaller").html('<option value="UF">UF</option>,<option value="Peso">Peso</option>');
  }
  else {
    $("#monedaEditarTaller").html('<option value="Peso">Peso</option>,<option value="UF">UF</option>');
  }
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#monedaEditarTaller").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaEditarTaller").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    var h = $(window).height() - 200;
    $("#bodyEditarTaller").css("height",h);
  }
  setTimeout(function(){
    $('#modalEditarTaller').modal('show');
    $('#modalAlertasSplash').modal('hide');
  },500);
});

// Funcion para guardar editar Taller
$("#guardarEditarTaller").unbind('click').click(function(){
  var table = $('#tablaListadoTaller').DataTable();
  var idTaller = $.map(table.rows('.selected').data(), function (item) {
    return item.IDPATENTE_TALLER;
  });
  parametros = {
    "idTaller": idTaller[0],
    "rutTaller":  $.trim($("#rutEditarTaller").val().replace('.','').replace('.','')),
    "nombreTaller": $("#nombreEditarTaller").val(),
    "monedaTaller": $("#monedaEditarTaller").val(),
    "direccionTaller": $("#direccionEditarTaller").val(),
    "comunaTaller": $("#comunaEditarTaller").val(),
    "contactoTaller": $("#contactoEditarTaller").val(),
    "emailTaller": $("#emailEditarTaller").val(),
    "telefonoTaller": $("#telefonoEditarTaller").val()
  }
  $("#modalEditarTaller").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarTaller.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoTaller').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Taller Editado correctamente");
          $("#editarTaller").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Taller, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Taller, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL EDITAR TALLER

async function recargaGraficoEvolucion(){
  setTimeout(function(){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
  },100);
  var path = window.location.href.split('#/')[1];

  var parametros = {
    "path": path,
    "inicio": $('#rangoTablaEvolucion').val().split(" al ")[0],
    "fin": $('#rangoTablaEvolucion').val().split(" al ")[1],
    'auditoria': $("#auditoriaTablaEvolucionComun").val(),
    'servicio': $("#servicioTablaEvolucionComun").val(),
    'jefatura': $("#jefaturaTablaEvolucion").val(),
    'personal': $("#personalTablaEvolucion").val(),
    'comuna': $("#comunaProTablaEvolucion").val(),
    'servicioPro':$("#servicioProTablaEvolucion").val(),
    'clientePro': $("#clienteProTablaEvolucion").val(),
    'actividadPro': $("#actividadProTablaEvolucion").val(),
  }

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionAuditoria.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAuditoria= '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAuditoria += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].AUDITORIA + '</option>';
        }
        $("#auditoriaTablaEvolucionComun").html(cuerpoAuditoria);
      }
      else{
        var cuerpoAuditoria= '<option selected value="0">Todas</option>';
        $("#auditoriaTablaEvolucionComun").html(cuerpoAuditoria);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionServicio.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoServicio = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoServicio += '<option value="' + p2.aaData[i].SERVICIO + '">' + p2.aaData[i].SERVICIO + '</option>';
        }
        $("#servicioTablaEvolucionComun").html(cuerpoServicio);
      }
      else{
        var cuerpoServicio= '<option selected value="0">Todas</option>';
        $("#servicioTablaEvolucionComun").html(cuerpoServicio);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionJefatura.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoJefatura = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoJefatura += '<option value="' + p2.aaData[i].DNI + '">' + p2.aaData[i].DNI + ' - ' + p2.aaData[i].JEFE + '</option>';
        }
        $("#jefaturaTablaEvolucion").html(cuerpoJefatura);
      }
      else{
        var cuerpoJefatura= '<option selected value="0">Todas</option>';
        $("#jefaturaTablaEvolucion").html(cuerpoJefatura);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionPersonal.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPersonal = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoPersonal += '<option value="' + p2.aaData[i].RUTPERSONAL + '">' + p2.aaData[i].RUTPERSONAL + ' - ' + p2.aaData[i].NOMBREPERSONAL + '</option>';
        }
        $("#personalTablaEvolucion").html(cuerpoPersonal);
      }
      else{
        var cuerpoPersonal= '<option selected value="0">Todas</option>';
        $("#personalTablaEvolucion").html(cuerpoPersonal);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionComuna.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoComuna = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoComuna += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
        }
        $("#comunaProTablaEvolucion").html(cuerpoComuna);
      }
      else{
        var cuerpoComuna= '<option selected value="0">Todas</option>';
        $("#comunaProTablaEvolucion").html(cuerpoComuna);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionServicioPro.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoServicioPro= '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoServicioPro += '<option value="' + p2.aaData[i].IDSERVICIO + '">' + p2.aaData[i].SERVICIO + '</option>';
        }
        $("#servicioProTablaEvolucion").html(cuerpoServicioPro);
      }
      else{
        var cuerpoServicioPro= '<option selected value="0">Todas</option>';
        $("#servicioProTablaEvolucion").html(cuerpoServicioPro);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionClientePro.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoClientePro= '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoClientePro += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + '</option>';
        }
        $("#clienteProTablaEvolucion").html(cuerpoClientePro);
      }
      else{
        var cuerpoClientePro= '<option selected value="0">Todas</option>';
        $("#clienteProTablaEvolucion").html(cuerpoClientePro);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionActividadPro.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoActividadPro= '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoActividadPro += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadProTablaEvolucion").html(cuerpoActividadPro);
      }
      else{
        var cuerpoActividadPro= '<option selected value="0">Todas</option>';
        $("#actividadProTablaEvolucion").html(cuerpoActividadPro);
      }
    }
  });

  $("#auditoriaTablaEvolucionComun").val(parametros['auditoria']);
  $("#servicioTablaEvolucionComun").val(parametros['servicio']);
  $("#jefaturaTablaEvolucion").val(parametros['jefatura']);
  $("#personalTablaEvolucion").val(parametros['personal']);
  $("#comunaProTablaEvolucion").val(parametros['comuna']);
  $("#servicioProTablaEvolucion").val(parametros['servicioPro']);
  $("#clienteProTablaEvolucion").val(parametros['clientePro']);
  $("#actividadProTablaEvolucion").val(parametros['actividadPro']);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#auditoriaTablaEvolucionComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioTablaEvolucionComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#jefaturaTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#personalTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaProTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioProTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#clienteProTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#actividadProTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  function graficaEvolucionPracticaF(){
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawChartPracticaEvolutivo);

    async function drawChartPracticaEvolutivo() {
      var data = new google.visualization.DataTable();
      data.addColumn('string', 'Periodo');
      data.addColumn('number', 'Sin problemas');
      data.addColumn({type:'string', role:'annotation'});
      data.addColumn('number', 'Con problemas');
      data.addColumn({type:'string', role:'annotation'});
      data.addColumn('number', 'Total');
      data.addColumn({type:'string', role:'annotation'});

      await $.ajax({
        url:   'controller/datosInformePracticasEvolucion.php',
        type:  'post',
        data:  parametros,
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            for(var i = 0; i < p2.aaData.length; i++){
              data.addRow([p2.aaData[i].PERIODO, parseInt(p2.aaData[i].BUENAS), p2.aaData[i].BUENAS.toString(), parseInt(p2.aaData[i].MALAS), p2.aaData[i].MALAS.toString(), parseInt(p2.aaData[i].TOTAL), p2.aaData[i].TOTAL.toString()]);
            }
          }
        }
      });

      var options = {
        title: '',
        // curveType: 'function',
        legend: {
          position: "top"
        },
        annotations: {
             textStyle: {
                 color: 'black',
                 fontSize: 11,
             },
             alwaysOutside: true
        },
        hAxis : {
            textStyle : {
                fontSize: 12 // or the number you want
            }

        },
        vAxis : {
            textStyle : {
                fontSize: 12 // or the number you want
            }

        },
        chartArea: {
          'width': '100%',
          'height': '70%',
          'top': '50',
          'bottom': '20',
          'right': '15',
          'left': '22'
        },
        series: {
          2: { color: '#00219c' },
          1: { color: '#c44e4e' },
          0: { color: '#095700' }
        }
      };

      var chart = new google.visualization.LineChart(document.getElementById('graficaTablaEvolucion'));

      chart.draw(data, options);
    }
  }

  await graficaEvolucionPracticaF();

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },1000);
};

$("select[id*='TablaEvolucion']").unbind("click").change(async function(e){
  setTimeout(function(){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
  },100);
  e.preventDefault();
  e.stopImmediatePropagation();
  var path = window.location.href.split('#/')[1];

  var parametros = {
    "path": path,
    "inicio": $('#rangoTablaEvolucion').val().split(" al ")[0],
    "fin": $('#rangoTablaEvolucion').val().split(" al ")[1],
    'auditoria': $("#auditoriaTablaEvolucionComun").val(),
    'servicio': $("#servicioTablaEvolucionComun").val(),
    'jefatura': $("#jefaturaTablaEvolucion").val(),
    'personal': $("#personalTablaEvolucion").val(),
    'comuna': $("#comunaProTablaEvolucion").val(),
    'servicioPro':$("#servicioProTablaEvolucion").val(),
    'clientePro': $("#clienteProTablaEvolucion").val(),
    'actividadPro': $("#actividadProTablaEvolucion").val(),
  }

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionAuditoria.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAuditoria= '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAuditoria += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].AUDITORIA + '</option>';
        }
        $("#auditoriaTablaEvolucionComun").html(cuerpoAuditoria);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionServicio.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoServicio = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoServicio += '<option value="' + p2.aaData[i].SERVICIO + '">' + p2.aaData[i].SERVICIO + '</option>';
        }
        $("#servicioTablaEvolucionComun").html(cuerpoServicio);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionJefatura.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoJefatura = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoJefatura += '<option value="' + p2.aaData[i].DNI + '">' + p2.aaData[i].DNI + ' - ' + p2.aaData[i].JEFE + '</option>';
        }
        $("#jefaturaTablaEvolucion").html(cuerpoJefatura);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionPersonal.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPersonal = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoPersonal += '<option value="' + p2.aaData[i].RUTPERSONAL + '">' + p2.aaData[i].RUTPERSONAL + ' - ' + p2.aaData[i].NOMBREPERSONAL + '</option>';
        }
        $("#personalTablaEvolucion").html(cuerpoPersonal);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionComuna.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoComuna = '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoComuna += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
        }
        $("#comunaProTablaEvolucion").html(cuerpoComuna);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionServicioPro.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoServicioPro= '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoServicioPro += '<option value="' + p2.aaData[i].IDSERVICIO + '">' + p2.aaData[i].SERVICIO + '</option>';
        }
        $("#servicioProTablaEvolucion").html(cuerpoServicioPro);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionClientePro.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoClientePro= '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoClientePro += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + '</option>';
        }
        $("#clienteProTablaEvolucion").html(cuerpoClientePro);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosInformePracticasEvolucionActividadPro.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoActividadPro= '<option selected value="0">Todas</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoActividadPro += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadProTablaEvolucion").html(cuerpoActividadPro);
      }
    }
  });

  $("#auditoriaTablaEvolucionComun").val(parametros['auditoria']);
  $("#servicioTablaEvolucionComun").val(parametros['servicio']);
  $("#jefaturaTablaEvolucion").val(parametros['jefatura']);
  $("#personalTablaEvolucion").val(parametros['personal']);
  $("#comunaProTablaEvolucion").val(parametros['comuna']);
  $("#servicioProTablaEvolucion").val(parametros['servicioPro']);
  $("#clienteProTablaEvolucion").val(parametros['clientePro']);
  $("#actividadProTablaEvolucion").val(parametros['actividadPro']);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#auditoriaTablaEvolucionComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioTablaEvolucionComun").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#jefaturaTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#personalTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaProTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioProTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#clienteProTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#actividadProTablaEvolucion").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  function graficaEvolucionPracticaF(){
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawChartPracticaEvolutivo);

    async function drawChartPracticaEvolutivo() {
      var data = new google.visualization.DataTable();
      data.addColumn('string', 'Periodo');
      data.addColumn('number', 'Sin problemas');
      data.addColumn({type:'string', role:'annotation'});
      data.addColumn('number', 'Con problemas');
      data.addColumn({type:'string', role:'annotation'});
      data.addColumn('number', 'Total');
      data.addColumn({type:'string', role:'annotation'});

      await $.ajax({
        url:   'controller/datosInformePracticasEvolucion.php',
        type:  'post',
        data:  parametros,
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            for(var i = 0; i < p2.aaData.length; i++){
              data.addRow([p2.aaData[i].PERIODO, parseInt(p2.aaData[i].BUENAS), p2.aaData[i].BUENAS.toString(), parseInt(p2.aaData[i].MALAS), p2.aaData[i].MALAS.toString(), parseInt(p2.aaData[i].TOTAL), p2.aaData[i].TOTAL.toString()]);
            }
          }
        }
      });

      var options = {
        title: '',
        // curveType: 'function',
        legend: {
          position: "top"
        },
        annotations: {
             textStyle: {
                 color: 'black',
                 fontSize: 11,
             },
             alwaysOutside: true
        },
        hAxis : {
            textStyle : {
                fontSize: 12 // or the number you want
            }

        },
        vAxis : {
            textStyle : {
                fontSize: 12 // or the number you want
            }

        },
        chartArea: {
          'width': '100%',
          'height': '70%',
          'top': '50',
          'bottom': '20',
          'right': '15',
          'left': '22'
        },
        series: {
          2: { color: '#00219c' },
          1: { color: '#c44e4e' },
          0: { color: '#095700' }
        }
      };

      var chart = new google.visualization.LineChart(document.getElementById('graficaTablaEvolucion'));

      chart.draw(data, options);
    }
  }

  graficaEvolucionPracticaF();

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#buttonRecuperarContraseña").unbind("click").click(function(){
  $("#dniRecuperarContraseña").val('');
  $("#modalRecuperarContraseña").modal("show");
});

$("input#dniRecuperarContraseña").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#dniRecuperarContraseña").val() !== ''){


    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");

    $("#dniRecuperarContraseña").val("");
    $("#dniRecuperarContraseña").addClass("is-invalid");
  }
});

$("#dniRecuperarContraseña").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#solicitarRecuperarContraseña").unbind("click").click(async function(){
  setTimeout(function(){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
  },100);
  parametros = {
    "rutUsuario": $("#dniRecuperarContraseña").val().replace('.','').replace('.',''),
    "passUsuario": randomTexto()
  }
  $("#modalRecuperarContraseña").modal("hide");
  await $.ajax({
    url:   'controller/recuperarPass.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin_usuario") == 0){
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El DNI ingresado no posee una cuenta de usuario");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Su contraseña fue enviada a su correo electrónico registrado: " + response);
        }
        else{
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al recuperar su contraseña, si el problema persiste favor comuniquese con soporte");
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al recuperar su contraseña, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

// FUNCION PARA MODAL INGRESAR ASEGURADORA
$("#agregarAseguradora").unbind("click").click(async function(){
  $("#modalIngresoAseguradora").find("input,textarea,select").val("");
  $("#rutIngresoAseguradora").removeClass("is-invalid");
  $("#nombreIngresoAseguradora").removeClass("is-invalid");
  $("#monedaIngresoAseguradora").removeClass("is-invalid");
  $("#direccionIngresoAseguradora").removeClass("is-invalid");
  $("#comunaIngresoAseguradora").removeClass("is-invalid");
  $("#telefonoIngresoAseguradora").removeClass("is-invalid");
  $("#monedaIngresoAseguradora").html('<option value="UF">UF</option>,<option value="Peso">Peso</option>');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  // Funcion para desplegar selector de Comuna desde BD
  await $.ajax({
    url:   'controller/datosAreaFuncional.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
        }
        $("#comunaIngresoAseguradora").html(cuerpoEC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#comunaIngresoAseguradora").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#monedaIngresoAseguradora").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      var h = $(window).height() - 200;
      $("#modalIngresoAseguradora").css("height",h);
    }
    $("#modalIngresoAseguradora").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoTaller').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("input#rutIngresoAseguradora").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutIngresoAseguradora").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutIngresoAseguradora").val("");
    $("#rutIngresoAseguradora").addClass("is-invalid");
  }
});

// Funcion para el evento del boton guardaAseguradora del modal
$("#guardarIngresoAseguradora").unbind('click').click(function(){
  if($("#rutIngresoAseguradora").val().length == 0 || $("#nombreIngresoAseguradora").val().length == 0 || $("#monedaIngresoAseguradora").val().length == 0 || $("#direccionIngresoAseguradora").val().length == 0 || $("#comunaIngresoAseguradora").val().length == 0 || $("#telefonoIngresoAseguradora").val().length == 0 ){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#rutIngresoAseguradora").val().length == 0){
      $("#rutIngresoAseguradora").addClass("is-invalid");
    }
    if ($("#nombreIngresoAseguradora").val().length == 0){
      $("#nombreIngresoAseguradora").addClass("is-invalid");
    }
    if ($("#direccionIngresoAseguradora").val().length == 0){
      $("#direccionIngresoAseguradora").addClass("is-invalid");
    }
    if ($("#telefonoIngresoAseguradora").val().length == 0){
      $("#telefonoIngresoAseguradora").addClass("is-invalid");
    }
    if ($("#monedaIngresoAseguradora").val().length == 0){
      $("#monedaIngresoAseguradora").addClass("is-invalid");
    }
    if ($("#comunaIngresoAseguradora").val().length == 0){
      $("#comunaIngresoAseguradora").addClass("is-invalid");
    }
  }
  else {
    $("#modalIngresoAseguradora").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    parametros = {
      "rutIngreso": $.trim($("#rutIngresoAseguradora").val().replace('.','').replace('.','')),
      "nombreIngreso":  $("#nombreIngresoAseguradora").val(),
      "monedaIngreso": $("#monedaIngresoAseguradora").val(),
      "direccionIngreso": $("#direccionIngresoAseguradora").val(),
      "comunaIngreso": $("#comunaIngresoAseguradora").val(),
      "telefonoIngreso": $("#telefonoIngresoAseguradora").val()
    }
    $.ajax({
      url:   'controller/datosChequeaAseguradora.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El rut de la aseguradora ya existe");
            $("#rutIngresoAseguradora").addClass("is-invalid");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalIngresoAseguradora").modal("show");
            },500);
          }
        }
        else{
          $.ajax({
            url: "controller/ingresaAseguradora.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
              var p = response.split(",");
              if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaListadoAseguradora').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Aseguradora Creado correctamente");
                  $("#editarAseguradora").attr("disabled","disabled");
                  $("#eliminarAseguradora").attr("disabled","disabled");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Aseguradora, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Aseguradora, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
          });
        }
      }
    });
  }
});

$("#rutIngresoAseguradora").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#nombreIngresoAseguradora").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#direccionIngresoAseguradora").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#telefonoIngresoAseguradora").on('input', function(){
  $(this).removeClass("is-invalid");
});

// FIN FUNCION PARA MODAL INGRESAR ASEGURADORA

// FUNCION PARA MODAL EDITAR ASEGURADORA
$("#editarAseguradora").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoAseguradora').DataTable();
  var rut = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT;
  });
  var nombre = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBRE;
  });
  var direccion = $.map(table.rows('.selected').data(), function (item) {
    return item.DIRECCION;
  });
  var telefono = $.map(table.rows('.selected').data(), function (item) {
    return item.TELEFONO;
  });
  var moneda = $.map(table.rows('.selected').data(), function (item) {
    return item.MONEDA;
  });
  var comuna = $.map(table.rows('.selected').data(), function (item) {
    return item.COMUNA;
  });
  await $.ajax({
    url:   'controller/datosAreaFuncional.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].COMUNA == comuna){
            cuerpoEC += '<option selected value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
            $("#comunaEditarAseguradora").html(cuerpoEC);
          }
          else{
            cuerpoEC += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + '</option>';
          }
        }
        $("#comunaEditarAseguradora").html(cuerpoEC);
      }
    }
  });
  $("#rutEditarAseguradora").val(rut);
  $("#rutEditarAseguradora").attr("disabled","disabled");
  $("#nombreEditarAseguradora").val(nombre);
  $("#direccionEditarAseguradora").val(direccion);
  $("#telefonoEditarAseguradora").val(telefono);
  if (moneda[0] == "UF"){
    $("#monedaEditarAseguradora").html('<option value="UF">UF</option>,<option value="Peso">Peso</option>');
  }
  else {
    $("#monedaEditarAseguradora").html('<option value="Peso">Peso</option>,<option value="UF">UF</option>');
  }
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#monedaEditarAseguradora").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaEditarAseguradora").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    var h = $(window).height() - 200;
    $("#bodyEditarAseguradora").css("height",h);
  }
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEditarAseguradora").modal("show");
  },500);
});

// Funcion para guardar editar Aseguradora
$("#guardarEditarAseguradora").unbind('click').click(function(){
  var table = $('#tablaListadoAseguradora').DataTable();
  var idAseguradora = $.map(table.rows('.selected').data(), function (item) {
    return item.IDPATENTE_ASEGURADORA;
  });
  parametros = {
    "idAseguradora": idAseguradora[0],
    "rutAseguradora":  $.trim($("#rutEditarAseguradora").val().replace('.','').replace('.','')),
    "nombreAseguradora": $("#nombreEditarAseguradora").val(),
    "monedaAseguradora": $("#monedaEditarAseguradora").val(),
    "direccionAseguradora": $("#direccionEditarAseguradora").val(),
    "comunaAseguradora": $("#comunaEditarAseguradora").val(),
    "telefonoAseguradora": $("#telefonoEditarAseguradora").val()
  }
  $("#modalEditarAseguradora").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarAseguradora.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoAseguradora').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Aseguradora Editado correctamente");
          $("#editarAseguradora").attr("disabled","disabled");
          $("#eliminarAseguradora").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Aseguradora, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Aseguradora, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL EDITAR ASEGURADORA

// FUNCION PARA MODAL ELIMINAR ASEGURADORA
$("#eliminarAseguradora").unbind('click').click(function(){
  var table = $('#tablaListadoAseguradora').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  $("#textoEliminarAseguradora").html(nombre);
  $('#modalEliminarAseguradora').modal('show');
});

// funcion guardar eliminar aseguradora
$("#guardarEliminarAseguradora").unbind('click').click(async function(){
  var table = $('#tablaListadoAseguradora').DataTable();
  var idAseguradora = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_ASEGURADORA;
  });
  parametros = {
    "idAseguradora": idAseguradora[0],
  }
  $("#modalEliminarAseguradora").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarAseguradora.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoAseguradora').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Aseguradora Eliminada correctamente");
            $("#editarAseguradora").attr("disabled","disabled");
            $("#eliminarAseguradora").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No se puede eliminar la Aseguradora porque se encuentra asignada a una Patente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No se puede eliminar la Aseguradora porque se encuentra asignada a una Patente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
  $('#modalEliminarAseguradora').modal('hide');
});

$("#desasignarJefaturaRespuesta").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();
  var personas = '';
  for(var i = 0; i < datos.length; i++) {
    personas = `${personas} <br />${datos[i].NOMBRE}`;
  }
  $("#tituloDesasignarJefaturaRespuesta").html(personas);
  setTimeout(function(){
    $("#modalAlertasSplash").modal('hide');
    $("#modalDesasignarJefaturaRespuesta").modal("show");
  },500);
});

$("#cancelarDesasignarJefaturaRespuesta").unbind("click").click(function() {
  $("#modalAlertasSplash").modal('hide');
  $("#modalDesasignarJefaturaRespuesta").modal("show");
});

$("#aceptarDesasignarJefaturaRespuesta").unbind('click').click(async function() {
  $("#modalDesasignarJefaturaRespuesta").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  var table = $('#infoInformePersonal').DataTable().clear().draw();

  var table = $("#tablaPersonal").DataTable();
  var datos = table.rows('.selected').data();

  var strlstPersonalDni = '';
  for(var i = 0; i < datos.length; i++) {
    if(i === 0){
      strlstPersonalDni = `'${datos[i].DNI}'`;
    }
    else{
      strlstPersonalDni = `${strlstPersonalDni},'${datos[i].DNI}'`;
    }
  }

  // console.log(strlstPersonalDni);

  await $.ajax({
    url:   'controller/desasignarPersonalJefatura.php',
    type:  'POST',
    data:  {
      "strlstPersonalDni": strlstPersonalDni
    },
    success: async function (response) {
      var table = $('#tablaPersonal').DataTable();
      var rows = table.rows( '.selected' ).remove().draw();
      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Persoal desasignado correctamente");
      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
      },500);
    },
  });

  var table = $("#tablaPersonal").DataTable();
  var vac = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Vacaciones' ? true : false;
  });
  var lic = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Licencia' ? true : false;
  });
  var des = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Desvinculado' ? true : false;
  });
  var pre = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente' ? true : false;
  });
  var pre_in = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción' ? true : false;
  });
  var pre_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Teletrabajo' ? true : false;
  });
  var pre_in_tel = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción Teletrabajo' ? true : false;
  });
  var ren = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Renuncia' ? true : false;
  });
  var per = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Permiso' ? true : false;
  });
  var aus = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Ausente' ? true : false;
  });
  var sin = table
      .column(30, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Sin marca' ? true : false;
  });
  var total = table
      .column(30, {search: 'applied'})
      .data();
  var directos = table
      .column(24, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == $("#nombreUsuarioPersonal").val() ? true : false;
  });

  var tablaInf = $('#infoInformePersonal').DataTable( {
    "select": {
        style: 'single'
    },
    columnDefs: [
      {
          targets: 0,
          className: 'leftDataTableCant'
      },
      {
          targets: 1,
          className: 'centerDataTableCant'
      }
    ],
    "scrollX": true,
    "paging": false,
    "searching": false,
    "ordering": false,
    "scrollCollapse": true,
    "order": [[ 0, "asc" ]],
    "info": true,
    "dom": 'frtp',
    "destroy": true,
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      $(this.api().column(1).footer()).html(total.count());
    }
  });
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente Teletrabajo', pre_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción Teletrabajo', pre_in_tel.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
  tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
  tablaInf.draw();


  $("#qDirectos").html(directos.count());
  $("#qOtros").html(total.count() - directos.count());

  menuElegant();

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#disponiblePersonal").attr("disabled","disabled");
    $("#ausentePersonal").attr("disabled","disabled");
    $("#transferirJefatura").attr("disabled","disabled");
    $("#transferirJefaturaRespuesta").attr("disabled","disabled");
    $("#solicitarJefaturaRespuesta").attr("disabled","disabled");
    $("#desasignarJefaturaRespuesta").attr("disabled","disabled");
  },1500);
});

$("#estadoPersonalInternoB").unbind("click").click(async function(){
  $("#fechaFinEstadoRRHH").removeAttr("disabled");
    setTimeout(async function(){
      var table = $('#tablaPersonalInterno').DataTable();
      var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
          return item.DNI;
      });
      var nombre = $.map(table.rows('.selected').data(), function (item) {
          return item.NOMBRE;
      });
      $("#nombrePersonalInternoEstado").html( rutUsuario[0]+ ' , '+ nombre[0]);
      //console.log(nombre[0]);
      var min = new Date();
      $("#fechaInicioEstadoRRHH").datepicker({
        dateFormat: "yy-mm-dd",
        changeMonth: true,
        changeYear: true,
        //minDate: min,
        maxDate: min,
        yearRange: '1920:2040',
        firstDay: 1,
        changeMonth: true,
        changeYear: true,
        monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
        monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
        dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
        dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
        dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
      });

      $("#fechaFinEstadoRRHH").datepicker({
        dateFormat: "yy-mm-dd",
        changeMonth: true,
        changeYear: true,
        minDate: min,
        yearRange: '1920:2040',
        firstDay: 1,
        changeMonth: true,
        changeYear: true,
        monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
        monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
        dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
        dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
        dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
      });

      var y = moment().format('YYYY-MM-DD');
      //$("#fechaInicioEstadoRRHH").attr("disabled","disabled");
      $("#fechaFinEstadoRRHH").val(y.toString());
      $("#fechaInicioEstadoRRHH").val(y.toString());

      await $.ajax({
        url:   'controller/datosEstadoRRHH.php',
        type:  'post',
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            var cuerpoEstadoOper = '';
            for(var i = 0; i < p2.aaData.length; i++){
              cuerpoEstadoOper += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].ESTADO + '</option>';
            }
            $("#tipoEstadoRRHH").html(cuerpoEstadoOper);
            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              $("#tipoEstadoRRHH").select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
            }
          }
        }
      });
      $("#observacionEstadoRRHH").val('');
      $("#fechaFinEstadoRRHH").val('');
      $("#modalEstadoRRHHInterno").modal("show");
    },500);
});

$("#tipoEstadoRRHH").unbind("click").change(function(){
  var valor = $(this).val(); // Capturamos el valor del select
  var texto = $(this).find('option:selected').text();
  if(texto === "Renuncia" || texto === "Desvinculado" || texto === "Vigente"){
    $("#fechaFinEstadoRRHH").attr("disabled","disabled");
  }
  else{
    $("#fechaFinEstadoRRHH").removeAttr("disabled");
  }
});

$("#guardarEstadoRRHHInterno").unbind("click").click(async function(){
  if($("#fechaFinEstadoRRHH").val() === '' && $("#tipoEstadoRRHH").find('option:selected').text() !== 'Desvinculado' && $("#tipoEstadoRRHH").find('option:selected').text() !== 'Renuncia' && $("#tipoEstadoRRHH").find('option:selected').text() !== 'Vigente'){
    $("#fechaFinEstadoRRHH").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Favor ingrese la fecha de termino del estado");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEstadoRRHHInterno").modal("hide");
    var table = $('#tablaPersonalInterno').DataTable();
    var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
        return item.DNI;
    });

    var valor = $("#tipoEstadoRRHH").val(); // Capturamos el valor del select
    var tipoTexto = $("#tipoEstadoRRHH").find('option:selected').text();

    var parametros = {
      "rut": rutUsuario[0],
      "tipo": $("#tipoEstadoRRHH").val(),
      "observacion": $("#observacionEstadoRRHH").val(),
      "ini": $("#fechaInicioEstadoRRHH").val(),
      "fin": $("#fechaFinEstadoRRHH").val(),
      "tipoTexto": tipoTexto
    }

    await $.ajax({
      url:   'controller/ingresaEstadoRRHH.php',
      type:  'post',
      data:  parametros,
      success: function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaPersonalInterno').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Estado RRHH asignado correctamente");
            $("#estadoPersonalInternoB").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar estado RRHH, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar estado RRHH, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
 }
});

$("#activarExPersonal").unbind('click').click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalActivarDesvinculado").find("input").val("");
  var table = $('#tablaExPersonal').DataTable();
  var rutCarga = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI;
  });
  var nombreCarga = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  $("#datosActivarDesvinculado").html(rutCarga[0] + ' , ' +nombreCarga[0]);
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalActivarDesvinculado").modal("show");
  },500);
});

$("#guardarActivarDesvinculador").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalActivarDesvinculado").modal("hide");
  var table = $('#tablaExPersonal').DataTable();
  var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI;
  });
  var parametros = {
    "rut": rutUsuario[0],
    "observacion": $("#observacionActivarDesvinculado").val()
  }

  await $.ajax({
    url:   'controller/ingresaActivarDesvinculado.php',
    type:  'post',
    data:  parametros,
    success: function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaExPersonal').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Ex personal activado correctamente");
          $("#activarExPersonal").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al activar ex personal, si el problema persiste favor comuníquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al activar ex personal, si el problema persiste favor comuníquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#agregarSubcontratista").unbind("click").click(async function(){
  $("#modalIngresoSubcontratista").find("input,textarea,select").val("");
  $("#rutIngresoSubcontratista").removeClass("is-invalid");
  $("#nombreIngresoSubcontratista").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  setTimeout(function(){
    $("#modalIngresoSubcontratista").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#modalIngresoSubcontratista').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("input#rutIngresoSubcontratista").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutIngresoSubcontratista").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutIngresoSubcontratista").val("");
    $("#rutIngresoSubcontratista").addClass("is-invalid");
  }
});

$("#guardarIngresoSubcontratista").unbind('click').click(function(){
  if($("#rutIngresoSubcontratista").val().length == 0 || $("#nombreIngresoSubcontratista").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#rutIngresoSubcontratista").val().length == 0){
      $("#rutIngresoSubcontratista").addClass("is-invalid");
    }
    else if ($("#nombreIngresoSubcontratista").val().length == 0){
      $("#nombreIngresoSubcontratista").addClass("is-invalid");
    }
  }
  else {
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalIngresoSubcontratista").modal("hide");
    var interno = 0;
    if($("#esSubcontratoIngresoSubcontratista").prop("checked") === true){
      interno = 0;
    }
    else{
      interno  = 1;
    }
    parametros = {
      "rutIngreso":   $.trim($("#rutIngresoSubcontratista").val().replace('.','').replace('.','')),
      "nombre":  $("#nombreIngresoSubcontratista").val(),
      "interno": interno
    }
    //console.log(parametros);
    $.ajax({
      url:   'controller/datosChequeaSubcontratista.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El rut de la empresa ya existe");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalIngresoSubcontratista").modal("show");
            },500);
          }
        }
        else {
          $.ajax({
            url: "controller/ingresaSubcontratista.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
              var p = response.split(",");
              if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaSubcontratista').DataTable();
                  //table.rows('.selected').remove().draw();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Empresa creada correctamente");
                  $("#editarSubcontratista").attr("disabled","disabled");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear la empresa, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear la empresa, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
          });
        }
      }
    });
  }
});

$("#nombreIngresoSubcontratista").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#editarSubcontratista").unbind('click').click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaSubcontratista').DataTable();
  var rutSubcontratista = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT;
  });
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE_SUBCONTRATO;
  });
  var estado = $.map(table.rows('.selected').data(), function (item) {
      return item.ESTADO;
  });
  var tipo = $.map(table.rows('.selected').data(), function (item) {
      return item.TIPO;
  });
  $("#rutEditarSubcontratista").val(rutSubcontratista);
  $("#nombreEditarSubcontratista").val(nombre);
  $("#estadoEditarSubcontratista").val(estado);
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#estadoEditarSubcontratista").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  if(tipo[0] == 'Subcontratista'){
    $("#esSubcontratoEditarSubcontratista").prop("checked",true);
  }
  else{
    $("#esSubcontratoEditarSubcontratista").prop("checked",false);
  }
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $('#modalEditarSubcontratista').modal('show');
  },500);
});

$("#guardarEditarSubcontratista").unbind('click').click(async function(){
  $("#modalEditarSubcontratista").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var interno = 0;
  if($("#esSubcontratoEditarSubcontratista").prop("checked") == true){
    interno = 0;
  }
  else{
    interno = 1;
  }
  parametros = {
    "rutEditar":   $("#rutEditarSubcontratista").val(),
    "nombre":  $("#nombreEditarSubcontratista").val(),
    "estado": $("#estadoEditarSubcontratista").val(),
    "interno": interno
  }
  //console.log(parametros);
  await $.ajax({
    url: "controller/editarSubcontratista.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaSubcontratista').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Subcontratista editado correctamente");
          $("#editarSubcontratista").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar subcontratista, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar al subcontratista, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#tipoCapacitacion").unbind("click").change(async function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var parametros = {
    'tipo': $("#tipoCapacitacion").val()
  }
  await $.ajax({
    url:   'controller/datosCapCap.php',
    type:  'post',
    data: parametros,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var cuerpoCap = '';
        for(var i = 0; i < p.aaData.length; i++) {
          cuerpoCap += '<option value="' + p.aaData[i].URL + '">' + p.aaData[i].NOMBRE + '</option>';
        }
        $("#capCapacitacion").html(cuerpoCap);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoCapacitacion").select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#capCapacitacion").select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#videoCapacitacion").attr("src",$("#capCapacitacion").val());
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#capCapacitacion").unbind("click").change(async function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#capCapacitacion").select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    $("#videoCapacitacion").attr("src",$("#capCapacitacion").val());
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#estadoPersonalExterno2").unbind("click").click(async function(){
  $("#fechaFinEstadoRRHH2").removeAttr("disabled");
  setTimeout(async function(){
    var table = $('#tablaPersonalExterno').DataTable();
    var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
        return item.DNI;
    });
    var nombre = $.map(table.rows('.selected').data(), function (item) {
        return item.NOMBRE;
    });
    $("#nombrePersonalExternoEstado").html( rutUsuario[0]+ ' , '+ nombre[0]);
    var min = new Date();
    $("#fechaInicioEstadoRRHH2").datepicker({
      dateFormat: "yy-mm-dd",
      changeMonth: true,
      changeYear: true,
      //minDate: min,
      maxDate: min,
      yearRange: '1920:2040',
      firstDay: 1,
      changeMonth: true,
      changeYear: true,
      monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
      monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
      dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
      dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
      dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
    });

    $("#fechaFinEstadoRRHH2").datepicker({
      dateFormat: "yy-mm-dd",
      changeMonth: true,
      changeYear: true,
      minDate: min,
      yearRange: '1920:2040',
      firstDay: 1,
      changeMonth: true,
      changeYear: true,
      monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
      monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
      dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
      dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
      dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
    });

    var y = moment().format('YYYY-MM-DD');
    $("#fechaFinEstadoRRHH2").val(y.toString());
    $("#fechaInicioEstadoRRHH2").val(y.toString());

    await $.ajax({
      url:   'controller/datosEstadoRRHH.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoEstadoOper = '';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoEstadoOper += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].ESTADO + '</option>';
          }
          $("#tipoEstadoRRHH2").html(cuerpoEstadoOper);
          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#tipoEstadoRRHH2").select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
        }
      }
    });
    $("#observacionEstadoRRHH2").val('');
    $("#fechaFinEstadoRRHH2").val('');
    $("#modalEstadoRRHHExterno").modal("show");
  },500);
});

$("#tipoEstadoRRHH2").unbind("click").change(function(){
  var valor = $(this).val();
  var texto = $(this).find('option:selected').text();
  if(texto === "Renuncia" || texto === "Desvinculado" || texto === "Vigente"){
    $("#fechaFinEstadoRRHH2").attr("disabled","disabled");
  }
  else{
    $("#fechaFinEstadoRRHH2").removeAttr("disabled");
  }
});

$("#guardarEstadoRRHHExterno").unbind("click").click(async function(){
  if($("#fechaFinEstadoRRHH2").val() === '' && $("#tipoEstadoRRHH2").find('option:selected').text() !== 'Desvinculado' && $("#tipoEstadoRRHH2").find('option:selected').text() !== 'Renuncia' && $("#tipoEstadoRRHH2").find('option:selected').text() !== 'Vigente'){
    $("#fechaFinEstadoRRHH2").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Favor ingrese la fecha de termino del estado");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEstadoRRHHExterno").modal("hide");

    var table = $('#tablaPersonalExterno').DataTable();
    var rutUsuario = $.map(table.rows('.selected').data(), function (item) {
        return item.DNI;
    });

    var valor = $("#tipoEstadoRRHH2").val();
    var tipoTexto = $("#tipoEstadoRRHH2").find('option:selected').text();

    var parametros = {
      "rut": rutUsuario[0],
      "tipo": $("#tipoEstadoRRHH2").val(),
      "observacion": $("#observacionEstadoRRHH2").val(),
      "ini": $("#fechaInicioEstadoRRHH2").val(),
      "fin": $("#fechaFinEstadoRRHH2").val(),
      "tipoTexto": tipoTexto
    }

    await $.ajax({
      url:   'controller/ingresaEstadoRRHH.php',
      type:  'post',
      data:  parametros,
      success: function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaPersonalExterno').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Estado RRHH asignado correctamente");
            $("#estadoPersonalExterno2").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar estado RRHH, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar estado RRHH, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
 }
});

// FUNCION PARA MODAL INGRESAR PROVEEDORES
$("#agregarProveedores").unbind("click").click(async function(){
  $("#modalIngresoProveedores").find("input,textarea,select").val("");
  $("#nombreIngresoProveedores").removeClass("is-invalid");
  $("#rutIngresoProveedores").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url:   'controller/datosPropiedad.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].PROPIEDAD === "Arriendo" || p2.aaData[i].PROPIEDAD === "Leasing Operativo" || p2.aaData[i].PROPIEDAD === "Leasing Financiero" || p2.aaData[i].PROPIEDAD === "Propio Empresa"){
            cuerpoEC += '<option value="' + p2.aaData[i].IDPATENTE_PROPIEDAD + '">' + p2.aaData[i].PROPIEDAD + '</option>';
          }
        }
        $("#propiedadProveedores").html(cuerpoEC);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#propiedadProveedores").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalIngresoProveedores").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoProveedores').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("input#rutIngresoProveedores").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutIngresoProveedores").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutIngresoProveedores").val("");
    $("#rutIngresoProveedores").addClass("is-invalid");
  }
});

// Funcion para el evento del boton guardar Proveedores del modal
$("#guardarIngresoProveedores").unbind('click').click(function(){
  if($("#rutIngresoProveedores").val().length == 0 || $("#nombreIngresoProveedores").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#rutIngresoProveedores").val().length == 0){
      $("#rutIngresoProveedores").addClass("is-invalid");
    }
    if ($("#nombreIngresoProveedores").val().length == 0){
      $("#nombreIngresoProveedores").addClass("is-invalid");
    }
  }
  else {
    $("#modalIngresoProveedores").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    parametros = {
      "rutProveedores": $.trim($("#rutIngresoProveedores").val().replace('.','').replace('.','')),
      "nombre": $("#nombreIngresoProveedores").val(),
      "propiedad": $("#propiedadProveedores").val(),
      "contrato": $("#contratoProveedores").val()
    }
    $.ajax({
      url:   'controller/datosChequeaProveedores.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El proveedor ya existe");
            $("#rutIngresoProveedores").addClass("is-invalid");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalIngresoProveedores").modal("show");
            },500);
          }
        }
        // Ingresamos Proveedores despues de verificar
        else {
          $.ajax({
            url: "controller/ingresaProveedores.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
              var p = response.split(",");
              if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaListadoProveedores').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Proveedor Creado correctamente");
                  $("#editarProveedores").attr("disabled","disabled");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Proveedor, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Proveedor, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
          });
        }
      }
    });
  }
});

$("#nombreIngresoProveedores").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#rutIngresoProveedores").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL INGRESAR PROVEEDORES

// FUNCION PARA MODAL EDITAR PROVEEDORES
$("#editarProveedores").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoProveedores').DataTable();
  var rutProveedor = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT;
  });
  var nombre = $.map(table.rows('.selected').data(), function (item) {
    return item.PROVEEDOR;
  });
  var propiedad = $.map(table.rows('.selected').data(), function (item) {
    return item.PROPIEDAD;
  });
  var nro_contrato = $.map(table.rows('.selected').data(), function (item) {
    return item.NRO_CONTRATO;
  });
  $("#rutEditarProveedores").val(rutProveedor);
  $("#rutEditarProveedores").attr("disabled","disabled");
  $("#nombreEditarProveedores").val(nombre);
  $("#contratoEditarProveedores").val(nro_contrato);

  await $.ajax({
    url:   'controller/datosPropiedad.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPR = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].PROPIEDAD === "Arriendo" || p2.aaData[i].PROPIEDAD === "Leasing Operativo" || p2.aaData[i].PROPIEDAD === "Leasing Financiero" || p2.aaData[i].PROPIEDAD === "Propio Empresa"){
            if(propiedad == p2.aaData[i].PROPIEDAD){
              cuerpoPR += '<option selected value="' + p2.aaData[i].IDPATENTE_PROPIEDAD + '">' + p2.aaData[i].PROPIEDAD + '</option>';
            }
            else{
              cuerpoPR += '<option value="' + p2.aaData[i].IDPATENTE_PROPIEDAD + '">' + p2.aaData[i].PROPIEDAD + '</option>';
            }
          }
        }
        $("#propiedadEditarProveedores").html(cuerpoPR);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#propiedadEditarProveedores").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEditarProveedores").modal("show");
  },500);
});

// Funcion para guardar editar Proveedores
$("#guardarEditarProveedores").unbind('click').click(function(){
  if($("#rutEditarProveedores").val().length == 0 || $("#nombreEditarProveedores").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#rutEditarProveedores").val().length == 0){
      $("#rutEditarProveedores").addClass("is-invalid");
    }
    if ($("#nombreEditarProveedores").val().length == 0){
      $("#nombreEditarProveedores").addClass("is-invalid");
    }
  }
  else {
    var table = $('#tablaListadoProveedores').DataTable();
    var idProveedores = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_PROVEEDOR;
    });
    parametros = {
      "idProveedores": idProveedores[0],
      "rutProveedores":  $.trim($("#rutEditarProveedores").val().replace('.','').replace('.','')),
      "nombre":  $("#nombreEditarProveedores").val(),
      "propiedad":  $("#propiedadEditarProveedores").val(),
      "contrato":  $("#contratoEditarProveedores").val()
    }
    $("#modalEditarProveedores").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/editarProveedores.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoProveedores').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Proveedor Editado correctamente");
            $("#editarProveedores").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Proveedor, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Proveedor, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#rutEditarProveedores").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombreEditarProveedores").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL EDITAR PROVEEDORES

// FUNCION PARA MODAL INGRESAR VEHICULOS
$("#agregarVehiculo").unbind("click").click(async function(){
  $("#modalIngresoVehiculos").find("input,textarea,select").val("");
  $("#patenteIngresoVehiculos").removeClass("is-invalid");
  $("#kilometrajeIngresoVehiculos").removeClass("is-invalid");
  $("#anoIngresoVehiculos").removeClass("is-invalid");
  $("#montoIngresoVehiculos").removeClass("is-invalid");
  $("#montoAseguradoraIngresoVehiculos").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url:   'controller/datosPatenteReemplazo.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPA = '<option selected value="0">' + 'No Aplica' + '</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoPA += '<option value="' + p2.aaData[i].IDPATENTE + '">' + p2.aaData[i].CODIGO + '  ' + p2.aaData[i].ESTADO +'</option>';
        }
        $("#patenteOriginalVehiculos").html(cuerpoPA);
      }
      else{
        patenteVacia += '<option selected value="0">' + 'No Aplica' + '</option>';
        $("#patenteOriginalVehiculos").html(patenteVacia);
      }
    }
  });

  $("#patenteOriginalVehiculos").attr("disabled","disabled");

  await $.ajax({
    url:   'controller/datosTipoVehiculo.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDPATENTE_TIPOVEHICULO + '">' + p2.aaData[i].NOMBRE + '</option>';
        }
        $("#tipoIngresoVehiculos").html(cuerpoEC);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosPatenteColor.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDPATENTE_COLOR + '">' + p2.aaData[i].NOMBRE + '</option>';
        }
        $("#colorIngresoVehiculos").html(cuerpoEC);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosPropiedad.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDPATENTE_PROPIEDAD + '">' + p2.aaData[i].PROPIEDAD + '</option>';
        }
        $("#propiedadIngresoVehiculos").html(cuerpoEC);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosAseguradora.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAseg = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAseg += '<option value="' + p2.aaData[i].IDPATENTE_ASEGURADORA + '">' + p2.aaData[i].NOMBRE + '</option>';
        }
        $("#aseguradoraIngresoVehiculos").html(cuerpoAseg);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosMonedaAseg.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          idMonedaAseg = $("#aseguradoraIngresoVehiculos").val();
          if ( idMonedaAseg == p2.aaData[i].IDPATENTE_ASEGURADORA){
            $("#tipoMontoAseg").html("<font> / Peso</font>");
          }
          else{
            $("#tipoMontoAseg").html("<font> / UF</font>");
          }
        }
      }
      else{
        $("#tipoMontoAseg").html("<font> / UF</font>");
      }
    }
  });

  $("#aseguradoraIngresoVehiculos").unbind("click").change(async function(){
    await $.ajax({
      url:   'controller/datosMonedaAseg.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          for(var i = 0; i < p2.aaData.length; i++){
            idMonedaAseg = $("#aseguradoraIngresoVehiculos").val();
            if ( idMonedaAseg == p2.aaData[i].IDPATENTE_ASEGURADORA){
              $("#tipoMontoAseg").html("<font> / Peso</font>");
            }
            else{
              $("#tipoMontoAseg").html("<font> / UF</font>");
            }
          }
        }
        else{
          $("#tipoMontoAseg").html("<font> / UF</font>");
        }
      }
    });
  });

  await $.ajax({
    url:   'controller/datosBodegaSucursal.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoBodega = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoBodega += '<option value="' + p2.aaData[i].IDSUCURSAL + '">' + p2.aaData[i].SUCURSAL + '</option>';
        }
        $("#bodegaIngresoVehiculos").html(cuerpoBodega);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosAreaFuncionalChile.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '<option selected value="0">Sin asignar</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + ' - ' + p2.aaData[i].REGION + '</option>';
        }
        $("#comunaIngresoVehiculos").html(cuerpoEC);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosPatenteEstado.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEst = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].IDPATENTE_ESTADO == 2){
            cuerpoEst += '<option selected value="' + p2.aaData[i].IDPATENTE_ESTADO + '">' + p2.aaData[i].ESTADO + '    ' + p2.aaData[i].SUB_ESTADO1 + '    ' + p2.aaData[i].SUB_ESTADO2 + '</option>';
          }
          else if(p2.aaData[i].IDPATENTE_ESTADO == 22){
            cuerpoEst += '<option value="' + p2.aaData[i].IDPATENTE_ESTADO + '">' + p2.aaData[i].ESTADO + '    ' + p2.aaData[i].SUB_ESTADO1 + '    ' + p2.aaData[i].SUB_ESTADO2 + '</option>';
          }
        }
        $("#estadoIngresoVehiculos").html(cuerpoEst);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosMarcaPatente.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoMarca = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoMarca += '<option>' + p2.aaData[i].MARCA + '</option>';
        }
        $("#marcaIngresoVehiculos").html(cuerpoMarca);
      }
    }
  });

  var parametrosMarca = {
    "marca" : $('select[id="marcaIngresoVehiculos"] option:selected').text()
  }

  await $.ajax({
    url:   'controller/datosModeloPatente.php',
    type:  'post',
    data: parametrosMarca,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoModelo = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoModelo += '<option name="' + p2.aaData[i].LITROS_ESTANQUE + '">' + p2.aaData[i].MODELO + '</option>';
        }
        $("#modeloIngresoVehiculos").html(cuerpoModelo);
      }
    }
  });

  var litrosSel = $("#modeloIngresoVehiculos").find('option:selected').attr("name");
  if(litrosSel == -1){
    litrosSel = 0;
  }
  $("#litrosIngresoVehiculos").val(litrosSel);

  $("#marcaIngresoVehiculos").unbind("click").change(async function(){
    var parametrosMarca = {
      "marca" : $('select[id="marcaIngresoVehiculos"] option:selected').text()
    }
    await $.ajax({
      url:   'controller/datosModeloPatente.php',
      type:  'post',
      data: parametrosMarca,
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoModelo = '';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoModelo += '<option name="' + p2.aaData[i].LITROS_ESTANQUE + '">' + p2.aaData[i].MODELO + '</option>';
          }
          $("#modeloIngresoVehiculos").html(cuerpoModelo);
        }
      }
    });

    var litrosSel = $("#modeloIngresoVehiculos").find('option:selected').attr("name");
    if(litrosSel == -1){
      litrosSel = 0;
    }
    $("#litrosIngresoVehiculos").val(litrosSel);
  });

  $("#modeloIngresoVehiculos").unbind("click").change(async function(){
    var litrosSel = $("#modeloIngresoVehiculos").find('option:selected').attr("name");
    if(litrosSel == -1){
      litrosSel = 0;
    }
    $("#litrosIngresoVehiculos").val(litrosSel);
  });


  if($('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Propio Personal"){
    cuerpoEmpresa = '<option value="">' + 'No Aplica' + '</option>';
    $("#empresaIngresoVehiculos").html(cuerpoEmpresa);
    $("#empresaIngresoVehiculos").attr("disabled","disabled");
    $("#inicioIngresoVehiculos").attr("disabled","disabled");
    $("#terminoIngresoVehiculos").attr("disabled","disabled");
    $("#montoIngresoVehiculos").attr("disabled","disabled");
    $("#tipoMontoIngresoVehiculos").attr("disabled","disabled");
  }
  else if($('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Propio Empresa"){
    $("#empresaIngresoVehiculos").removeAttr("disabled");
    $("#inicioIngresoVehiculos").attr("disabled","disabled");
    $("#terminoIngresoVehiculos").attr("disabled","disabled");
    $("#montoIngresoVehiculos").attr("disabled","disabled");
    $("#tipoMontoIngresoVehiculos").attr("disabled","disabled");
    await $.ajax({
      url:   'controller/datosSubcontratistasVehiculoInterno.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoSub = '';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoSub += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
          }
          $("#empresaIngresoVehiculos").html(cuerpoSub);
        }
      }
    });
  }
  else if($('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Propio Subcontrata"){
    $("#empresaIngresoVehiculos").removeAttr("disabled");
    $("#inicioIngresoVehiculos").attr("disabled","disabled");
    $("#terminoIngresoVehiculos").attr("disabled","disabled");
    $("#montoIngresoVehiculos").attr("disabled","disabled");
    $("#tipoMontoIngresoVehiculos").attr("disabled","disabled");
    await $.ajax({
      url:   'controller/datosSubcontratistasVehiculo.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoSub = '';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoSub += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
          }
          $("#empresaIngresoVehiculos").html(cuerpoSub);
        }
      }
    });
  }
  else if($('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Arriendo" || $('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Leasing" ){
    $("#empresaIngresoVehiculos").removeAttr("disabled");
    $("#inicioIngresoVehiculos").removeAttr("disabled");
    $("#terminoIngresoVehiculos").removeAttr("disabled");
    $("#montoIngresoVehiculos").removeAttr("disabled");
    $("#montoIngresoVehiculos").val(0);
    $("#tipoMontoIngresoVehiculos").removeAttr("disabled");
    $("#tipoMontoIngresoVehiculos").html('<option value="Peso">Peso</option>,<option value="UF">UF</option>');
    await $.ajax({
      url:   'controller/datosProveedores.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoSub = '';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoSub += '<option value="' + p2.aaData[i].IDPATENTE_PROVEEDOR + '">' + p2.aaData[i].PROVEEDOR + '</option>';
          }
          $("#empresaIngresoVehiculos").html(cuerpoSub);
        }
      }
    });
  }

  $("#propiedadIngresoVehiculos").unbind("click").change(async function(){
    if($('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Propio Personal"){
      cuerpoEmpresa = '<option value="">' + 'No Aplica' + '</option>';
      limpiarCampo = '<option value="">' + '' + '</option>';
      $("#empresaIngresoVehiculos").html(cuerpoEmpresa);
      $("#inicioIngresoVehiculos").val("");
      $("#terminoIngresoVehiculos").val("");
      $("#tipoMontoIngresoVehiculos").html(limpiarCampo);
      $("#montoIngresoVehiculos").val("");
      $("#empresaIngresoVehiculos").attr("disabled","disabled");
      $("#inicioIngresoVehiculos").attr("disabled","disabled");
      $("#terminoIngresoVehiculos").attr("disabled","disabled");
      $("#montoIngresoVehiculos").attr("disabled","disabled");
      $("#tipoMontoIngresoVehiculos").attr("disabled","disabled");
    }
    else if($('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Propio Empresa"){
      limpiarCampo = '<option value="">' + '' + '</option>';
      $("#inicioIngresoVehiculos").val("");
      $("#terminoIngresoVehiculos").val("");
      $("#montoIngresoVehiculos").val("");
      $("#tipoMontoIngresoVehiculos").html(limpiarCampo);
      $("#empresaIngresoVehiculos").removeAttr("disabled");
      $("#inicioIngresoVehiculos").attr("disabled","disabled");
      $("#terminoIngresoVehiculos").attr("disabled","disabled");
      $("#montoIngresoVehiculos").attr("disabled","disabled");
      $("#tipoMontoIngresoVehiculos").attr("disabled","disabled");
      await $.ajax({
        url:   'controller/datosSubcontratistasVehiculoInterno.php',
        type:  'post',
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            var cuerpoSub = '';
            for(var i = 0; i < p2.aaData.length; i++){
              cuerpoSub += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
            $("#empresaIngresoVehiculos").html(cuerpoSub);
          }
          else{
            cuerpoSub += '<option value="">' + 'No Aplica' + '</option>';
            $("#empresaIngresoVehiculos").html(cuerpoSub);
          }
        }
      });
    }
    else if($('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Propio Subcontrata"){
      limpiarCampo = '<option value="">' + '' + '</option>';
      $("#inicioIngresoVehiculos").val("");
      $("#terminoIngresoVehiculos").val("");
      $("#montoIngresoVehiculos").val("");
      $("#tipoMontoIngresoVehiculos").html(limpiarCampo);
      $("#empresaIngresoVehiculos").removeAttr("disabled");
      $("#inicioIngresoVehiculos").attr("disabled","disabled");
      $("#terminoIngresoVehiculos").attr("disabled","disabled");
      $("#montoIngresoVehiculos").attr("disabled","disabled");
      $("#tipoMontoIngresoVehiculos").attr("disabled","disabled");
      await $.ajax({
        url:   'controller/datosSubcontratistasVehiculo.php',
        type:  'post',
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            var cuerpoSub = '';
            for(var i = 0; i < p2.aaData.length; i++){
              cuerpoSub += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
            $("#empresaIngresoVehiculos").html(cuerpoSub);
          }
          else{
            cuerpoSub += '<option value="">' + 'No Aplica' + '</option>';
            $("#empresaIngresoVehiculos").html(cuerpoSub);
          }
        }
      });
    }
    else if($('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Arriendo" || $('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Leasing Operativo" || $('select[id="propiedadIngresoVehiculos"] option:selected').text() === "Leasing Financiero"){
      $("#empresaIngresoVehiculos").removeAttr("disabled");
      $("#inicioIngresoVehiculos").removeAttr("disabled");
      $("#terminoIngresoVehiculos").removeAttr("disabled");
      $("#montoIngresoVehiculos").removeAttr("disabled");
      $("#montoIngresoVehiculos").val(0);
      $("#tipoMontoIngresoVehiculos").removeAttr("disabled");
      $("#tipoMontoIngresoVehiculos").html('<option value="Peso">Peso</option>,<option value="UF">UF</option>');
      await $.ajax({
        url:   'controller/datosProveedores.php',
        type:  'post',
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            var cuerpoSub = '';
            for(var i = 0; i < p2.aaData.length; i++){
              cuerpoSub += '<option value="' + p2.aaData[i].IDPATENTE_PROVEEDOR + '">' + p2.aaData[i].PROVEEDOR + '</option>';
            }
            $("#empresaIngresoVehiculos").html(cuerpoSub);
          }
          else{
            cuerpoSub += '<option value="">' + 'No Aplica' + '</option>';
            $("#empresaIngresoVehiculos").html(cuerpoSub);
          }
        }
      });
    }
  });

  $("#inicioIngresoVehiculos").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#terminoIngresoVehiculos").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#mantoIngresoVehiculos").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoIngresoVehiculos").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#propiedadIngresoVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#empresaIngresoVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#marcaIngresoVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#modeloIngresoVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#aseguradoraIngresoVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#estadoIngresoVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#bodegaIngresoVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaIngresoVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#colorIngresoVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#tipoMontoIngresoVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#patenteOriginalVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#kilometrajeIngresoVehiculos").val(0);
  $("#anoIngresoVehiculos").val(1980);
  $("#montoAseguradoraIngresoVehiculos").val(0);

  $("#kilometrajeIngresoVehiculos" ).focusout(function(){
    kilometro = $("#kilometrajeIngresoVehiculos").val();
    if(kilometro < 0){
      $("#kilometrajeIngresoVehiculos").val(0);
      $("#kilometrajeIngresoVehiculos").addClass("is-invalid");
      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
    }
    else{
      $("#kilometrajeIngresoVehiculos").val(kilometro);
    }
  });

  $("#anoIngresoVehiculos" ).focusout(function(){
    ano = $("#anoIngresoVehiculos").val();
    if(ano < 1980){
      $("#anoIngresoVehiculos").val(1980);
      $("#anoIngresoVehiculos").addClass("is-invalid");


      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 1980");
    }
    else{
      $("#anoIngresoVehiculos").val(ano);
    }
  });

  $("#montoAseguradoraIngresoVehiculos" ).focusout(function(){
    montoAseg = $("#montoAseguradoraIngresoVehiculos").val();
    if(montoAseg < 0){
      $("#montoAseguradoraIngresoVehiculos").val(0);
      $("#montoAseguradoraIngresoVehiculos").addClass("is-invalid");


      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
    }
    else{
      $("#montoAseguradoraIngresoVehiculos").val(montoAseg);
    }
  });

  $("#montoIngresoVehiculos" ).focusout(function(){
    monto = $("#montoIngresoVehiculos").val();
    if(monto < 0){
      $("#montoIngresoVehiculos").val(0);
      $("#montoIngresoVehiculos").addClass("is-invalid");


      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
    }
    else{
      $("#montoIngresoVehiculos").val(monto);
    }
  });

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyIngresoVehiculos").css("height",h);
    $("#modalIngresoVehiculos").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoVehiculos').animate({ scrollTop: 0 }, 'fast');
    },200);
  },1500);
});

// Funcion para el evento del boton guardar Vehiculos del modal
$("#guardarIngresoVehiculos").unbind('click').click(function(){
  if($("#patenteIngresoVehiculos").val().length == 0 || $("#kilometrajeIngresoVehiculos").val().length == 0 || $("#anoIngresoVehiculos").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#patenteIngresoVehiculos").val().length == 0){
      $("#patenteIngresoVehiculos").addClass("is-invalid");
    }
    if ($("#kilometrajeIngresoVehiculos").val().length == 0){
      $("#kilometrajeIngresoVehiculos").addClass("is-invalid");
    }
    if ($("#anoIngresoVehiculos").val().length == 0){
      $("#anoIngresoVehiculos").addClass("is-invalid");
    }
  }
  else {
    $("#modalIngresoVehiculos").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    parametros = {
      "patente": $("#patenteIngresoVehiculos").val(),
      "kilometraje": $("#kilometrajeIngresoVehiculos").val(),
      "marca": $("#marcaIngresoVehiculos").val(),
      "modelo": $("#modeloIngresoVehiculos").val(),
      "ano": $("#anoIngresoVehiculos").val(),
      "tipoVehiculo": $("#tipoIngresoVehiculos").val(),
      "vin": $("#vinIngresoVehiculos").val(),
      "color": $("#colorIngresoVehiculos").val(),
      "propiedad": $("#propiedadIngresoVehiculos").val(),
      "empresa": $("#empresaIngresoVehiculos").val(),
      "inicio": $("#inicioIngresoVehiculos").val(),
      "termino": $("#terminoIngresoVehiculos").val(),
      "monto": $("#montoIngresoVehiculos").val(),
      "bodega": $("#bodegaIngresoVehiculos").val(),
      "aseguradora": $("#aseguradoraIngresoVehiculos").val(),
      "montoAseguradora": $("#montoAseguradoraIngresoVehiculos").val(),
      "manto": $("#mantoIngresoVehiculos").val(),
      "estado": $("#estadoIngresoVehiculos").val(),
      "tipoMonto": $("#tipoMontoIngresoVehiculos").val(),
      "nMotor": $("#nMotorIngresoVehiculos").val(),
      "litros": $("#litrosIngresoVehiculos").val(),
      "comuna": $("#comunaIngresoVehiculos").val(),
    }
    $.ajax({
      url:   'controller/datosChequeaPatente.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La patente ya existe");
            $("#patenteIngresoVehiculos").addClass("is-invalid");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalIngresoVehiculos").modal("show");
            },500);
          }
        }
        // Ingresamos Patente despues de verificar
        else {
          if($("#estadoIngresoVehiculos").val() == 2){
            parametros["patenteOriginal"] = "";
            $.ajax({
              url: "controller/ingresaPatente.php",
              type: 'POST',
              data: parametros,
              success:  function (response) {
                var p = response.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                  if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaListadoVehiculo').DataTable();
                    table.ajax.reload();
                    var table2 = $('#informeListadoVehiculo').DataTable();
                    table2.ajax.reload(varGraficoPorFlota);

                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Patente Creado correctamente");
                    $("#editarVehiculo").attr("disabled","disabled");
                    $("#subirPdfVehiculo").attr("disabled","disabled");
                    $("#historialVehiculo").attr("disabled","disabled");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                  else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Patente, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Patente, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
            });
          }
          else{
            parametros["patenteOriginal"] = $("#patenteOriginalVehiculos").val();
            $.ajax({
              url: "controller/ingresaPatente.php",
              type: 'POST',
              data: parametros,
              success:  function (response) {
                var p = response.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                  if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaListadoVehiculo').DataTable();
                    table.ajax.reload();
                    var table2 = $('#informeListadoVehiculo').DataTable();
                    table2.ajax.reload(varGraficoPorFlota);

                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Patente Creado correctamente");
                    $("#editarVehiculo").attr("disabled","disabled");
                    $("#subirPdfVehiculo").attr("disabled","disabled");
                    $("#historialVehiculo").attr("disabled","disabled");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                  else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Patente, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Patente, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
            });
          }
        }
      }
    });
  }
});

$("#patenteIngresoVehiculos").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#kilometrajeIngresoVehiculos").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#anoIngresoVehiculos").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#montoIngresoVehiculos").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#montoAseguradoraIngresoVehiculos").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL INGRESAR VEHICULOS

$("#periodoMetaPractica").unbind("click").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var parametros = {
    'mes': $("#periodoMetaPractica").val().split('-')[1],
    'ano': $("#periodoMetaPractica").val().split('-')[0]
  }

  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  await $('#tablaMetaPractica').DataTable( {
      ajax: {
          url: "controller/datosMetaMesAno.php",
          type: 'POST',
          data: parametros,
      },
      columns: [
          { data: 'S'},
          { data: 'PERFIL' },
          { data: 'AUDITORIA' },
          { data: 'META', className: "centerDataTable" },
          { data: 'CICLO' },
          { data: 'TIPO' },
          { data: 'OBSERVACION' },
          { data: 'IDPERFIL' },
          { data: 'IDAUDITORIA' },
          { data: 'PERMANENTE' }
      ],
      buttons: [
          {
            extend: 'excel',
            exportOptions: {
              columns: [ 1, 2, 3, 4, 5, 6 ]
            },
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          },
          {
            text: '<span class="fas fa-arrow-alt-circle-up" id="spanButtonFiltrosMetaPractica"></span>&nbsp;&nbsp;Filtros',
            action: function(){
              if($("#filtrosMetaPractica").height() > 100){
                $("#filtrosMetaPractica").css("height","0");
                $("#filtrosMetaPractica").fadeOut();
                $("#spanButtonFiltrosMetaPractica").removeClass("fas fa-arrow-alt-circle-up");
                $("#spanButtonFiltrosMetaPractica").addClass("fas fa-arrow-alt-circle-down");
              }
              else{
                if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                  $("#filtrosMetaPractica").css("height","100pt");
                }
                else{
                  $("#filtrosMetaPractica").css("height","180pt");
                }
                $("#filtrosMetaPractica").fadeIn();
                $("#spanButtonFiltrosMetaPractica").removeClass("fas fa-arrow-alt-circle-down");
                $("#spanButtonFiltrosMetaPractica").addClass("fas fa-arrow-alt-circle-up");
              }
            }
          }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        },
        {
          "visible": false,
          "searchable": false,
          "targets": [ 7 ]
        },
        {
          "visible": false,
          "searchable": false,
          "targets": [ 8 ]
        },
        {
          "visible": false,
          "searchable": false,
          "targets": [ 9 ]
        }
      ],
      "select": {
          style: 'single'
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json){
        $('#contenido').show();
        $('#menu-lateral').show();
        $('#footer').parent().show();
        $('#footer').show();
        var table = $('#tablaMetaPractica').DataTable();

        var perfilMeta = '';
        perfilMeta += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(1).data().unique().length; i++){
          if(table.column(1).data().unique()[i] !== null){
            perfilMeta += '<option value="' + table.column(1).data().unique()[i] + '">' + table.column(1).data().unique()[i] + '</option>';
          }
        }
        $("#perfilMetaPractica").html(perfilMeta);

        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#periodoMetaPractica").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
          $("#perfilMetaPractica").select2('destroy').select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
      }
  });

  setTimeout(async function(){
    setTimeout(function(){
      var path = window.location.href.split('#/')[1];
      var parametros = {
        "path": path
      }

      setTimeout(async function(){
        await $.ajax({
          url:   'controller/datosAccionesVisibles.php',
          type:  'post',
          data: parametros,
          success: function (response) {
            var p = jQuery.parseJSON(response);
            if(p.aaData.length !== 0){
              for(var i = 0; i < p.aaData.length; i++) {
                if(p.aaData[i].VISIBLE == 1){
                  if(p.aaData[i].ENABLE == 1){
                    $("#accionesMetaPractica").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
                  }
                  else{
                    $("#accionesMetaPractica").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button disabled class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
                  }
                }
              }
            }
          }
        });

        setTimeout(function(){
          var js = document.createElement('script');
          js.src = 'view/js/funciones.js?idLoad=205';
          document.getElementsByTagName('head')[0].appendChild(js);
        },500);
      },100);
      $('#modalAlertasSplash').modal('hide');
      setTimeout(function(){
        $('#tablaMetaPractica').DataTable().columns.adjust();
      },500);
    },500);
  },500);
});

$("#perfilMetaPractica").unbind("click").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  var table = $("#tablaMetaPractica").DataTable();
  var mano = $("#perfilMetaPractica").val();
  if(mano == "Todos"){
    mano = '';
    table.rows('').deselect();
    table.columns('1').search(mano).draw();
  }
  else{
    table.rows('').deselect();
    table.columns('1').search("(^"+mano+"$)",true,false).draw();
  }

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#perfilMetaPractica").select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#agregarMetaPractica").unbind("click").click(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#periodoAgregarMeta").val('');
  $("#observacionAgregarMeta").val('');
  $("#metaAgregarMeta").val(1);

  var min = new Date();
  $("#periodoAgregarMeta").datepicker({
		dateFormat: 'yy-mm',
		changeMonth: true,
	  changeYear: true,
    showButtonPanel: true,
    minDate: min,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá'],
    closeText: 'Seleccionar',
    currentText: 'Mes actual',
    onClose: function(dateText, inst) {
        var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
        var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
        $(this).datepicker('setDate', new Date(year, month, 1));
        $(this).removeClass("is-invalid");
    }
	});

	$("#periodoAgregarMeta").focus(function () {
		$(".ui-datepicker-calendar").hide();
	});

  await $.ajax({
    url:   'controller/datosPerfilMeta.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPerfil = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoPerfil += '<option value="' + p2.aaData[i].IDPERFIL + '">' + p2.aaData[i].NOMBRE + '</option>';
        }
        $("#perfilAgregarMeta").html(cuerpoPerfil);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosAuditoriaMeta.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAuditoria = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAuditoria += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].TITULO + '</option>';
        }
        $("#auditoriaAgregarMeta").html(cuerpoAuditoria);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#perfilAgregarMeta").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#auditoriaAgregarMeta").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#permanenteAgregarMeta").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#cicloAgregarMeta").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var h = $(window).height() - 200;
  $("#bodyAgregarMeta").css("height",h);
  $("#modalAgregarMeta").modal("show");

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#guardarAgregarMeta").unbind("click").click(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  if($("#periodoAgregarMeta").val() === ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar el campo periodo");
    $("#periodoAgregarMeta").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalAgregarMeta").modal("hide");
    parametros = {
      "perfil": $("#perfilAgregarMeta").val(),
      "mes": $("#periodoAgregarMeta").val().split('-')[1],
      "ano": $("#periodoAgregarMeta").val().split('-')[0],
      "auditoria": $("#auditoriaAgregarMeta").val(),
      "meta": $("#metaAgregarMeta").val(),
      "observacion": $("#observacionAgregarMeta").val(),
      "permanente": $("#permanenteAgregarMeta").val(),
      "ciclo": $("#cicloAgregarMeta").val()
    }

    $.ajax({
      url: "controller/ingresaPracticaMeta.php",
      type: 'POST',
      data: parametros,
      success:  async function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMetaPractica').DataTable();
            //table.rows('.selected').remove().draw();
            table.ajax.reload();

            var per = $("#periodoMetaPractica").val();

            await $.ajax({
              url:   'controller/datosMetaPeriodo.php',
              type:  'post',
              success: function (response2) {
                var p2 = jQuery.parseJSON(response2);
                if(p2.aaData.length !== 0){
                  var cuerpoPeriodo = '';
                  for(var i = 0; i < p2.aaData.length; i++){
                    cuerpoPeriodo += '<option value="' + p2.aaData[i].PERIODO + '">' + p2.aaData[i].PERIODO + '</option>';
                  }
                  $("#periodoMetaPractica").html(cuerpoPeriodo);
                }
                else{
                  var cuerpoPeriodo = '<option value="' + moment().format('YYYY-MM').toString() + '">' + moment().format('YYYY-MM').toString() + '</option>';
                  $("#periodoMetaPractica").html(cuerpoPeriodo);
                }
              }
            });

            $("#periodoMetaPractica").val(per);

            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              $("#periodoMetaPractica").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
            }

            var table = $('#tablaMetaPractica').DataTable();

            var perfilMeta = '';
            perfilMeta += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(1).data().unique().length; i++){
              if(table.column(1).data().unique()[i] !== null){
                perfilMeta += '<option value="' + table.column(1).data().unique()[i] + '">' + table.column(1).data().unique()[i] + '</option>';
              }
            }
            $("#perfilMetaPractica").html(perfilMeta);

            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              $("#perfilMetaPractica").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
            }

            var mano = $("#perfilMetaPractica").val();
            if(mano == "Todos"){
              mano = '';
              table.rows('').deselect();
              table.columns('1').search(mano).draw();
            }
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Meta agregada correctamente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El periodo, auditoria y perfil seleccionados ya poseen una meta ingresada");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El periodo, auditoria y perfil seleccionados ya poseen una meta ingresada");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#editarMetaPractica").unbind("click").click(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#periodoEditarMeta").val('');
  $("#observacionEditarMeta").val('');
  $("#metaEditarMeta").val(1);

  var min = new Date();
  $("#periodoEditarMeta").datepicker({
		dateFormat: 'yy-mm',
		changeMonth: true,
	  changeYear: true,
    showButtonPanel: true,
    minDate: min,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá'],
    closeText: 'Seleccionar',
    currentText: 'Mes actual',
    onClose: function(dateText, inst) {
        var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
        var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
        $(this).datepicker('setDate', new Date(year, month, 1));
        $(this).removeClass("is-invalid");
    }
	});

	$("#periodoEditarMeta").focus(function () {
		$(".ui-datepicker-calendar").hide();
	});

  await $.ajax({
    url:   'controller/datosPerfilMeta.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPerfil = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoPerfil += '<option value="' + p2.aaData[i].IDPERFIL + '">' + p2.aaData[i].NOMBRE + '</option>';
        }
        $("#perfilEditarMeta").html(cuerpoPerfil);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosAuditoriaMeta.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAuditoria = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAuditoria += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].TITULO + '</option>';
        }
        $("#auditoriaEditarMeta").html(cuerpoAuditoria);
      }
    }
  });

  var table = $('#tablaMetaPractica').DataTable();
  var perfil = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPERFIL;
  });
  var auditoria = $.map(table.rows('.selected').data(), function (item) {
      return item.IDAUDITORIA;
  });
  var meta = $.map(table.rows('.selected').data(), function (item) {
      return item.META;
  });
  var observacion = $.map(table.rows('.selected').data(), function (item) {
      return item.OBSERVACION;
  });
  var tipo = $.map(table.rows('.selected').data(), function (item) {
      return item.PERMANENTE;
  });
  var ciclo = $.map(table.rows('.selected').data(), function (item) {
      return item.CICLO;
  });

  $("#perfilEditarMeta").val(perfil[0]);
  $("#auditoriaEditarMeta").val(auditoria[0]);
  $("#metaEditarMeta").val(meta[0]);
  $("#observacionEditarMeta").val(observacion[0]);
  $("#periodoEditarMeta").val($("#periodoMetaPractica").val());
  $("#permanenteEditarMeta").val(tipo[0]);
  $("#cicloEditarMeta").val(ciclo[0]);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#perfilEditarMeta").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#auditoriaEditarMeta").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#permanenteEditarMeta").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#cicloEditarMeta").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var h = $(window).height() - 200;
  $("#bodyEditarMeta").css("height",h);
  $("#modalEditarMeta").modal("show");

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#guardarEditarMeta").unbind("click").click(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  if($("#periodoEditarMeta").val() === ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar el campo periodo");
    $("#periodoEditarMeta").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEditarMeta").modal("hide");
    parametros = {
      "perfil": $("#perfilEditarMeta").val(),
      "mes": $("#periodoEditarMeta").val().split('-')[1],
      "ano": $("#periodoEditarMeta").val().split('-')[0],
      "auditoria": $("#auditoriaEditarMeta").val(),
      "meta": $("#metaEditarMeta").val(),
      "observacion": $("#observacionEditarMeta").val(),
      "permanente": $("#permanenteEditarMeta").val(),
      "ciclo": $("#cicloEditarMeta").val()
    }

    $.ajax({
      url: "controller/actualizarPracticaMeta.php",
      type: 'POST',
      data: parametros,
      success:  async function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMetaPractica').DataTable();
            //table.rows('.selected').remove().draw();
            table.ajax.reload();

            var per = $("#periodoMetaPractica").val();

            await $.ajax({
              url:   'controller/datosMetaPeriodo.php',
              type:  'post',
              success: function (response2) {
                var p2 = jQuery.parseJSON(response2);
                if(p2.aaData.length !== 0){
                  var cuerpoPeriodo = '';
                  for(var i = 0; i < p2.aaData.length; i++){
                    cuerpoPeriodo += '<option value="' + p2.aaData[i].PERIODO + '">' + p2.aaData[i].PERIODO + '</option>';
                  }
                  $("#periodoMetaPractica").html(cuerpoPeriodo);
                }
                else{
                  var cuerpoPeriodo = '<option value="' + moment().format('YYYY-MM').toString() + '">' + moment().format('YYYY-MM').toString() + '</option>';
                  $("#periodoMetaPractica").html(cuerpoPeriodo);
                }
              }
            });

            $("#periodoMetaPractica").val(per);

            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              $("#periodoMetaPractica").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
            }

            var table = $('#tablaMetaPractica').DataTable();

            var perfilMeta = '';
            perfilMeta += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(1).data().unique().length; i++){
              if(table.column(1).data().unique()[i] !== null){
                perfilMeta += '<option value="' + table.column(1).data().unique()[i] + '">' + table.column(1).data().unique()[i] + '</option>';
              }
            }
            $("#perfilMetaPractica").html(perfilMeta);

            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              $("#perfilMetaPractica").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
            }
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Meta actualizada correctamente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error actualizando la meta ingresada, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error actualizando la meta ingresada, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#eliminarrMetaPractica").unbind("click").click(function(){
  $("#modalEliminarMeta").modal("show");
});

$("#guardarEliminarMeta").unbind("click").click(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEliminarMeta").modal("hide");
  var table = $('#tablaMetaPractica').DataTable();
  var perfil = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPERFIL;
  });
  var auditoria = $.map(table.rows('.selected').data(), function (item) {
      return item.IDAUDITORIA;
  });

  var parametros = {
    "perfil": perfil[0],
    "auditoria": auditoria[0],
    "mes": $("#periodoMetaPractica").val().split('-')[1],
    "ano": $("#periodoMetaPractica").val().split('-')[0]
  }

  $.ajax({
    url: "controller/eliminarPracticaMeta.php",
    type: 'POST',
    data: parametros,
    success:  async function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaMetaPractica').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload();

          var per = $("#periodoMetaPractica").val();

          await $.ajax({
            url:   'controller/datosMetaPeriodo.php',
            type:  'post',
            success: function (response2) {
              var p2 = jQuery.parseJSON(response2);
              if(p2.aaData.length !== 0){
                var cuerpoPeriodo = '';
                for(var i = 0; i < p2.aaData.length; i++){
                  cuerpoPeriodo += '<option value="' + p2.aaData[i].PERIODO + '">' + p2.aaData[i].PERIODO + '</option>';
                }
                $("#periodoMetaPractica").html(cuerpoPeriodo);
              }
              else{
                var cuerpoPeriodo = '<option value="' + moment().format('YYYY-MM').toString() + '">' + moment().format('YYYY-MM').toString() + '</option>';
                $("#periodoMetaPractica").html(cuerpoPeriodo);
              }
            }
          });

          $("#periodoMetaPractica").val(per);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#periodoMetaPractica").select2('destroy').select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }

          var table = $('#tablaMetaPractica').DataTable();

          var perfilMeta = '';
          perfilMeta += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(1).data().unique().length; i++){
            if(table.column(1).data().unique()[i] !== null){
              perfilMeta += '<option value="' + table.column(1).data().unique()[i] + '">' + table.column(1).data().unique()[i] + '</option>';
            }
          }
          $("#perfilMetaPractica").html(perfilMeta);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#perfilMetaPractica").select2('destroy').select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }

          var mano = $("#perfilMetaPractica").val();
          if(mano == "Todos"){
            mano = '';
            table.rows('').deselect();
            table.columns('1').search(mano).draw();
          }
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Meta eliminada correctamente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error eliminando la meta seleccionada, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error eliminando la meta seleccionada, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#fechaInformeDisponibilidad").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#infoInformeDisponibilidad').DataTable().clear().draw();

  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  var parametros = {
    "path": path,
    "fecha":  $("#fechaInformeDisponibilidad").val()
  }

  await $('#InformeDisponibilidad').DataTable( {
      ajax: {
          url: "controller/datosInformeDisponibilidad.php",
          type: 'POST',
          data: parametros,
      },
      columns: [
          { data: 'S'},
          { data: 'DNI' },
          { data: 'NOMBRE' },
          { data: 'ESTADO_CONTROL'},
          { data: 'SERVICIO' },
          { data: 'CLIENTE' },
          { data: 'ACTIVIDAD' },
          { data: 'COMUNA' },
          { data: 'EMPRESA' },
          { data: 'FUNCION' },
          { data: 'NOMBREJEFE' },
          { data: 'ESTADO_CONTROL2' }
      ],
      buttons: [
          {
            extend: 'excel',
            exportOptions: {
              columns: [ 1, 2, 11, 4, 5, 6, 7 ,8, 9, 10 ]
            },
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        },
        {
          "visible": false,
          "searchable": false,
          "targets": [ 11 ]
        }
      ],
      "select": {
          style: 'single'
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json){
        var table = $('#InformeDisponibilidad').DataTable();
        var vac = table
            .column(11, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Vacaciones' ? true : false;
        });
        var lic = table
            .column(11, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Licencia' ? true : false;
        });
        var des = table
            .column(11, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Desvinculado' ? true : false;
        });
        var pre = table
            .column(11, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Presente' ? true : false;
        });
        var ren = table
            .column(11, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Renuncia' ? true : false;
        });
        var per = table
            .column(11, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Permiso' ? true : false;
        });
        var pre_in = table
            .column(11, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Presente Inducción' ? true : false;
        });
        var aus = table
            .column(11, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Ausente' ? true : false;
        });
        var sin = table
            .column(11, {search: 'applied'})
            .data()
            .filter( function ( value, index ) {
                return value == 'Sin marca' ? true : false;
        });
        var total = table
            .column(11, {search: 'applied'})
            .data();

        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
          var data = new google.visualization.DataTable();
          data.addColumn('string', 'Estado');
          data.addColumn('number', 'Porcentaje');
          data.addRow(['Vacaciones', vac.count()]);
          data.addRow(['Licencia', lic.count()]);
          data.addRow(['Desvinculado', des.count()]);
          data.addRow(['Presente', pre.count() + pre_in.count()]);
          data.addRow(['Renuncia', ren.count()]);
          data.addRow(['Permiso', per.count()]);
          data.addRow(['Ausente', aus.count()]);
          data.addRow(['Sin marca', sin.count()]);

          var options = {
            title: '',
            // is3D: true,
            // pieSliceText: 'label',
            legend: 'none',
            chartArea: {
              'width': '100%',
              'height': '100%',
              'bottom': 10,
              'top': 10
            },
            slices: {
              0: { color: '#8b00ff' },
              1: { color: '#0165ff' },
              2: { color: 'black' },
              3: { color: '#4bdc34' },
              4: { color: 'black' },
              5: { color: '#fff038' },
              6: { color: '#ffae20' },
              7: { color: '#dedede' }
            }
          };

          var chart = new google.visualization.PieChart(document.getElementById('graficaInformeDisponibilidad'));

          chart.draw(data, options);

          var tablaInf = $('#infoInformeDisponibilidad').DataTable( {
            "select": {
                style: 'single'
            },
            columnDefs: [
              {
                  targets: 0,
                  className: 'leftDataTableCant'
              },
              {
                  targets: 1,
                  className: 'centerDataTableCant'
              }
            ],
            "scrollX": true,
            "paging": false,
            "searching": false,
            "ordering": false,
            "scrollCollapse": true,
            "order": [[ 0, "asc" ]],
            "info": true,
            "dom": 'frtp',
            "destroy": true,
            "language": {
              "zeroRecords": "No hay datos disponibles",
              "info": "Registro _START_ de _END_ de _TOTAL_",
              "infoEmpty": "No hay datos disponibles",
              "paginate": {
                  "previous": "Anterior",
                  "next": "Siguiente"
                },
                "search": "Buscar: ",
                "select": {
                    "rows": "- %d registros seleccionados"
                },
                "infoFiltered": "(Filtrado de _MAX_ registros)"
            },
            "destroy": true,
            "autoWidth": false,
            "initComplete": function( settings, json){
              $(this.api().column(1).footer()).html(total.count());
            }
          });
          tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
          tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
          tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
          tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
          tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
          tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
          tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
          tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
          tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
          tablaInf.draw();
        }

        var cuerpoJefe = '';
        cuerpoJefe += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(10).data().unique().length; i++){
          if(table.column(10).data().unique()[i] !== null){
            cuerpoJefe += '<option value="' + table.column(10).data().unique()[i] + '">' + table.column(10).data().unique()[i] + '</option>';
          }
        }
        $("#jefaturaInformeDisponibilidad").html(cuerpoJefe);

        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#jefaturaInformeDisponibilidad").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }

        $('#contenido').show();
        $('#menu-lateral').show();
        $('#footer').parent().show();
$('#footer').show();

        setTimeout(async function(){
          $('#modalAlertasSplash').modal('hide');
          setTimeout(function(){
            $('#InformeDisponibilidad').DataTable().columns.adjust();
          },500);
          setTimeout(function(){
            $('#infoInformeDisponibilidad').DataTable().columns.adjust();
          },500);
        },1000);
      }
  });
});

$("#jefaturaInformeDisponibilidad").unbind("click").change(function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  e.stopImmediatePropagation();
  e.preventDefault();
  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#jefaturaInformeDisponibilidad").select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var table = $('#infoInformeDisponibilidad').DataTable().clear().draw();

  var table = $("#InformeDisponibilidad").DataTable();
  var mano = $("#jefaturaInformeDisponibilidad").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('10').search(mano).draw();

  var table = $('#InformeDisponibilidad').DataTable();
  var vac = table
      .column(11, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Vacaciones' ? true : false;
  });
  var lic = table
      .column(11, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Licencia' ? true : false;
  });
  var des = table
      .column(11, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Desvinculado' ? true : false;
  });
  var pre = table
      .column(11, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente' ? true : false;
  });
  var ren = table
      .column(11, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Renuncia' ? true : false;
  });
  var per = table
      .column(11, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Permiso' ? true : false;
  });
  var pre_in = table
      .column(11, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Presente Inducción' ? true : false;
  });
  var aus = table
      .column(11, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Ausente' ? true : false;
  });
  var sin = table
      .column(11, {search: 'applied'})
      .data()
      .filter( function ( value, index ) {
          return value == 'Sin marca' ? true : false;
  });
  var total = table
      .column(11, {search: 'applied'})
      .data();

  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawChart);

  function drawChart() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Estado');
    data.addColumn('number', 'Porcentaje');
    data.addRow(['Vacaciones', vac.count()]);
    data.addRow(['Licencia', lic.count()]);
    data.addRow(['Desvinculado', des.count()]);
    data.addRow(['Presente', pre.count() + pre_in.count()]);
    data.addRow(['Renuncia', ren.count()]);
    data.addRow(['Permiso', per.count()]);
    data.addRow(['Ausente', aus.count()]);
    data.addRow(['Sin marca', sin.count()]);

    var options = {
      title: '',
      // is3D: true,
      // pieSliceText: 'label',
      legend: 'none',
      chartArea: {
        'width': '100%',
        'height': '100%',
        'bottom': 10,
        'top': 10
      },
      slices: {
        0: { color: '#8b00ff' },
        1: { color: '#0165ff' },
        2: { color: 'black' },
        3: { color: '#4bdc34' },
        4: { color: 'black' },
        5: { color: '#fff038' },
        6: { color: '#ffae20' },
        7: { color: '#dedede' }
      }
    };

    var chart = new google.visualization.PieChart(document.getElementById('graficaInformeDisponibilidad'));

    chart.draw(data, options);

    var tablaInf = $('#infoInformeDisponibilidad').DataTable( {
      "select": {
          style: 'single'
      },
      columnDefs: [
        {
            targets: 0,
            className: 'leftDataTableCant'
        },
        {
            targets: 1,
            className: 'centerDataTableCant'
        }
      ],
      "scrollX": true,
      "paging": false,
      "searching": false,
      "ordering": false,
      "scrollCollapse": true,
      "order": [[ 0, "asc" ]],
      "info": true,
      "dom": 'frtp',
      "destroy": true,
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json){
        $(this.api().column(1).footer()).html(total.count());
      }
    });
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #8b00ff; font-size: 10pt;"></b>&nbsp;&nbsp;Vacaciones', vac.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #0165ff; font-size: 10pt;"></b>&nbsp;&nbsp;Licencia', lic.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Desvinculado', des.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente', pre.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #4bdc34; font-size: 10pt;"></b>&nbsp;&nbsp;Presente inducción', pre_in.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #black; font-size: 10pt;"></b>&nbsp;&nbsp;Renuncia', ren.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #fff038; font-size: 10pt;"></b>&nbsp;&nbsp;Permiso', per.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #ffae20; font-size: 10pt;"></b>&nbsp;&nbsp;Ausente', aus.count()]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #dedede; font-size: 10pt;"></b>&nbsp;&nbsp;Sin marca', sin.count()]);
    tablaInf.draw();
  }

  menuElegant();

  setTimeout(async function(){
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#InformeDisponibilidad').DataTable().columns.adjust();
    },500);
    setTimeout(function(){
      $('#infoInformeDisponibilidad').DataTable().columns.adjust();
    },500);
  },1000);
});

async function recargaGraficoDisponibilidadEvo(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

  var parametros = {
    "path": path,
    "inicio": $('#rangoEvoluInformeDisponibilidad').val().split(" al ")[0],
    "fin": $('#rangoEvoluInformeDisponibilidad').val().split(" al ")[1]
  }

  function graficaDispoEvolucion(){
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawChartPracticaEvolutivo);

    async function drawChartPracticaEvolutivo() {
      var data = new google.visualization.DataTable();
      data.addColumn('string', 'Fecha');
      data.addColumn('number', 'Vacaciones');
      data.addColumn('number', 'Licencia');
      data.addColumn('number', 'Desvinculado');
      data.addColumn('number', 'Presente');
      data.addColumn('number', 'Renuncia');
      data.addColumn('number', 'Permiso');
      data.addColumn('number', 'Ausente');
      data.addColumn('number', 'Sin marca');
      data.addColumn({type:'string', role:'annotation'});

      var max = 0;

      await $.ajax({
        url:   'controller/datosInformeDisponibilidadEvol.php',
        type:  'post',
        data:  parametros,
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            for(var i = 0; i < p2.aaData.length; i++){
              data.addRow([p2.aaData[i].FECHA,parseInt(p2.aaData[i].VACACIONES),parseInt(p2.aaData[i].LICENCIA),parseInt(p2.aaData[i].DESVINCULADO),parseInt(p2.aaData[i].PRESENTE),parseInt(p2.aaData[i].RENUNCIA),parseInt(p2.aaData[i].PERMISO),parseInt(p2.aaData[i].AUSENTE),parseInt(p2.aaData[i].SIN_MARCA),(parseInt(p2.aaData[i].VACACIONES) + parseInt(p2.aaData[i].LICENCIA) + parseInt(p2.aaData[i].PRESENTE) + parseInt(p2.aaData[i].PERMISO) + parseInt(p2.aaData[i].AUSENTE) + parseInt(p2.aaData[i].SIN_MARCA)).toString()]);

              if((parseInt(p2.aaData[i].VACACIONES) + parseInt(p2.aaData[i].LICENCIA) + parseInt(p2.aaData[i].PRESENTE) + parseInt(p2.aaData[i].PERMISO) + parseInt(p2.aaData[i].AUSENTE) + parseInt(p2.aaData[i].SIN_MARCA)) > max){
                max = (parseInt(p2.aaData[i].VACACIONES) + parseInt(p2.aaData[i].LICENCIA) + parseInt(p2.aaData[i].PRESENTE) + parseInt(p2.aaData[i].PERMISO) + parseInt(p2.aaData[i].AUSENTE) + parseInt(p2.aaData[i].SIN_MARCA));
              }
            }
          }
        }
      });

      var options = {
        title: '',
        // curveType: 'function',
        legend: {
          position: "top"
        },
        isStacked: true,
        annotations: {
             textStyle: {
                 color: 'black',
                 fontSize: 11,
             },
             alwaysOutside: true
        },
        hAxis : {
            textStyle : {
                fontSize: 12 // or the number you want
            }

        },
        vAxis : {
            textStyle : {
                fontSize: 12 // or the number you want
            },
            viewWindow: {
                min: 0,
                max: max+5,
            }
        },
        chartArea: {
          'width': '100%',
          'height': '90%',
          'top': '50',
          'bottom': '20',
          'right': '15',
          'left': '40'
        },
        series: {
          0: { color: '#8b00ff' },
          1: { color: '#0165ff' },
          2: { color: 'black' },
          3: { color: '#4bdc34' },
          4: { color: 'black' },
          5: { color: '#fff038' },
          6: { color: '#ffae20' },
          7: { color: '#dedede' }
        }
      };

      var chart = new google.visualization.ColumnChart(document.getElementById('evoluInformDisponibilidad'));

      chart.draw(data, options);

      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
      },1000);
    }
  }

  await graficaDispoEvolucion();
}

$("#fechaInformeDisponibilidadJefatura").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  var parametrosDispoJefe = {
    "path": path,
    "fecha":  $("#fechaInformeDisponibilidadJefatura").val()
  }

  await $('#InformeDisponibilidadJefatura').DataTable( {
      ajax: {
          url: "controller/datosInformeDisponibilidadJefatura.php",
          type: 'POST',
          data: parametrosDispoJefe,
      },
      columns: [
          { data: 'S'},
          { data: 'EMPRESA' },
          { data: 'NOMBRE' },
          { data: 'VACACIONES', className: "centerDataTable" },
          { data: 'LICENCIA' , className: "centerDataTable" },
          { data: 'DESVINCULADO', className: "centerDataTable" },
          { data: 'PRESENTE', className: "centerDataTable" },
          { data: 'RENUNCIA' , className: "centerDataTable" },
          { data: 'PERMISO' , className: "centerDataTable" },
          { data: 'AUSENTE' , className: "centerDataTable" },
          { data: 'SIN_MARCA', className: "centerDataTable" },
          { data: 'TOTAL' , className: "centerDataTable" }
      ],
      buttons: [
          {
            extend: 'excel',
            exportOptions: {
              columns: [ 1, 2, 3, 4, 5, 6, 7 ,8, 9, 10, 11 ]
            },
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        }
      ],
      "select": {
          style: 'single'
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json){
        setTimeout(async function(){
          $('#modalAlertasSplash').modal('hide');
          setTimeout(function(){
            $('#InformeDisponibilidadJefatura').DataTable().columns.adjust();
          },500);
        },1000);
      }
  });
});

function graficarCampiosMetaPractica(){
  var table = $('#tablaPracticaMetas').DataTable();
  var avance = table.column(9, { search:'applied' }).data().sum();
  var total = table.column(8, { search:'applied' }).data().sum()
  var pendiente = 0;

  if(total == 0){
    pendiente = 0;
  }
  else{
    var pendiente = total - avance;
    if(pendiente < 0){
      pendiente = 0;
    }
  }

  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawChartPM);

  function drawChartPM() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Estado');
    data.addColumn('number', 'Porcentaje');
    if(total == 0){
      data.addRow(['Pendiente', 0]);
      data.addRow(['Realizadas', avance/1]);
    }
    else{
      data.addRow(['Pendiente', pendiente/total]);
      data.addRow(['Realizadas', avance/total]);
    }

    var options = {
      title: '',
      // is3D: true,
      // pieSliceText: 'label',
      pieHole: 0.4,
      legend: 'none',
      chartArea: {
        'width': '100%',
        'height': '100%',
        'bottom': 10,
        'top': 10
      },
      slices: {
        0: { color: '#c44e4e' },
        1: { color: '#095700' }
      }
    };

    var chart = new google.visualization.PieChart(document.getElementById('graficaPracticaMetas'));

    $('#infoInformePracticaMetas').DataTable().clear().draw();
    var tablaInf = $('#infoInformePracticaMetas').DataTable( {
      "select": {
          style: 'single'
      },
      columnDefs: [
        {
            targets: 0,
            className: 'leftDataTableCant'
        },
        {
            targets: 1,
            className: 'centerDataTableCant'
        }
      ],
      "scrollX": true,
      "paging": false,
      "searching": false,
      "ordering": false,
      "scrollCollapse": true,
      "order": [[ 0, "asc" ]],
      "info": true,
      "dom": 'frtp',
      "destroy": true,
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json){
        $(this.api().column(1).footer()).html(total);
      }
    });
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #095700; font-size: 10pt;"></b>&nbsp;&nbsp;Realizadas', avance]);
    tablaInf.row.add(['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b class="fa fa-circle" style="color: #c44e4e; font-size: 10pt;"></b>&nbsp;&nbsp;Pendientes', pendiente]);
    tablaInf.draw();

    chart.draw(data, options);
  }
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#tablaPracticaMetas').DataTable().columns.adjust();
      $('#infoInformePracticaMetas').DataTable().columns.adjust();
    },500);
  },2000);
}

$("#periodoPracticaMetas").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#periodoPracticaMetas").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var path = window.location.href.split('#/')[1];

  var parametros = {
    'mes': $("#periodoPracticaMetas").val().split('-')[1],
    'ano': $("#periodoPracticaMetas").val().split('-')[0],
    'path': path
  }

  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

  var tablaPM = await $('#tablaPracticaMetas').DataTable( {
    ajax: {
        url: "controller/datosAvanceMetaPractica.php",
        type: 'POST',
        data: parametros
    },
    buttons: [
      {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,9 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
      },
      {
        text: '<span class="fas fa-arrow-alt-circle-up" id="spanButtonFiltrosOcultPracticaMeta"></span>&nbsp;&nbsp;Filtros',
        action: function(){
          if($("#filtrosOcultPracticaMeta").height() > 100){
            $("#filtrosOcultPracticaMeta").css("height","0");
            $("#filtrosOcultPracticaMeta").fadeOut();
            $("#spanButtonFiltrosOcultPracticaMeta").removeClass("fas fa-arrow-alt-circle-up");
            $("#spanButtonFiltrosOcultPracticaMeta").addClass("fas fa-arrow-alt-circle-down");
          }
          else{
            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              $("#filtrosOcultPracticaMeta").css("height","190pt");
            }
            else{
              $("#filtrosOcultPracticaMeta").css("height","350pt");
            }
            $("#filtrosOcultPracticaMeta").fadeIn();
            $("#spanButtonFiltrosOcultPracticaMeta").removeClass("fas fa-arrow-alt-circle-down");
            $("#spanButtonFiltrosOcultPracticaMeta").addClass("fas fa-arrow-alt-circle-up");
          }
        }
      }
    ],
    "columns": [
      {
        data: 'S',
        width: "5px",
        orderable: false,
        className: 'select-checkbox',
        targets: [ 0 ]
      },
      {
        data: 'RUT'
      },
      {
        data: 'NOMBRE'
      },
      {
        data: 'PERFIL'
      },
      {
        data: 'SERVICIO'
      },
      {
        data: 'CLIENTE'
      },
      {
        data: 'ACTIVIDAD'
      },
      {
        data: 'COMUNA'
      },
      {
        data: 'META_MENSUAL',
        className: "centerDataTable"
      },
      {
        data: 'AVANCE',
        className: "centerDataTable"
      },
      {
        orderable: true,
        width: '250px',
        data: 'POR_AVANCE',
        render: function(data, type, row, meta) {
            return '<div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" style="font-weight: bold; font-size: 8pt; width:' + row['POR_AVANCE'].toString() + '%;">' + row['POR_AVANCE'].toString() + ' %</div></div>';
        }
      }
    ],
    fixedColumns:   {
      leftColumns: 2
    },
    "select": {
        style: 'single'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "order": [[ 0, "desc" ]],
    "info":     true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();
        }
    });

    menuElegant();

    tablaPM.on( 'search.dt', function () {
      graficarCampiosMetaPractica();
    });
});

// FUNCION PARA MODAL EDITAR VEHICULO
$("#editarVehiculo").unbind('click').click( async function(){
  $("#patenteEditarVehiculos").removeClass("is-invalid");
  $("#kilometrajeEditarVehiculos").removeClass("is-invalid");
  $("#anoEditarVehiculos").removeClass("is-invalid");
  $("#montoEditarVehiculos").removeClass("is-invalid");
  $("#montoAseguradoraEditarVehiculos").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoVehiculo').DataTable();
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE;
  });
  var marca = $.map(table.rows('.selected').data(), function (item) {
      return item.MARCA;
  });
  var propiedad = $.map(table.rows('.selected').data(), function (item) {
    return item.PROPIEDAD;
  });
  var modelo = $.map(table.rows('.selected').data(), function (item) {
    return item.MODELO;
  });
  var tipo = $.map(table.rows('.selected').data(), function (item) {
    return item.TIPO;
  });
  var estado = $.map(table.rows('.selected').data(), function (item) {
    return item.ESTADO_SOLO;
  });

  $("#patenteEditarVehiculos").val(patente);
  $("#patenteEditarVehiculos").attr("disabled","disabled");

  var parametrosPatente = {
    "patente" : patente[0]
  }
  await $.ajax({
    url:   'controller/datosEditarVehiculo.php',
    type:  'post',
    data: parametrosPatente,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      $("#kilometrajeEditarVehiculos").val(p3.aaData[0].KILOMETRAJE);
      $("#anoEditarVehiculos").val(p3.aaData[0].AÑO);
      $("#vinEditarVehiculos").val(p3.aaData[0].VIN);
      $("#inicioEditarVehiculos").val(p3.aaData[0].FINICIO);
      $("#terminoEditarVehiculos").val(p3.aaData[0].FTERMINO);
      $("#nMotorEditarVehiculos").val(p3.aaData[0].NRO_MOTOR);
      $("#operacionEditarVehiculos").val(p3.aaData[0].OPERACION);
      $("#litrosEditarVehiculos").val(p3.aaData[0].LITROS_ESTANQUE);
      if(p3.aaData[0].MONTO == null){
        $("#montoEditarVehiculos").val(0);
      }
      else{
        $("#montoEditarVehiculos").val(p3.aaData[0].MONTO);
      }

      if(p3.aaData[0].MONTO_ASEGURADORA == null){
        $("#montoAseguradoraEditarVehiculos").val(0);
      }
      else{
        $("#montoAseguradoraEditarVehiculos").val(p3.aaData[0].MONTO_ASEGURADORA);
      }

      $("#mantoEditarVehiculos").val(p3.aaData[0].FMANTENIMIENTO);
      idSucur = p3.aaData[0].IDSUCURSAL;
      idAseg = p3.aaData[0].IDPATENTE_ASEGURADORA;
      idEstado = p3.aaData[0].IDPATENTE_ESTADO;
      idColor = p3.aaData[0].IDPATENTE_COLOR;
      idProveedor = p3.aaData[0].IDPATENTE_PROVEEDOR;
      idSubcontratistas = p3.aaData[0].IDSUBCONTRATISTAS;
      idTipoMonto = p3.aaData[0].TIPOMONTO;
      idComuna = p3.aaData[0].IDAREAFUNCIONAL;
    }
  });

  await $.ajax({
    url:   'controller/datosTipoVehiculo.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoTV = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(tipo == p2.aaData[i].NOMBRE){
            cuerpoTV += '<option selected value="' + p2.aaData[i].IDPATENTE_TIPOVEHICULO + '">' + p2.aaData[i].NOMBRE + '</option>';
          }
          else{
            cuerpoTV += '<option value="' + p2.aaData[i].IDPATENTE_TIPOVEHICULO + '">' + p2.aaData[i].NOMBRE + '</option>';
          }
        }
        $("#tipoEditarVehiculos").html(cuerpoTV);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosPatenteColor.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(idColor == p2.aaData[i].IDPATENTE_COLOR){
            cuerpoEC += '<option selected value="' + p2.aaData[i].IDPATENTE_COLOR + '">' + p2.aaData[i].NOMBRE + '</option>';
          }
          else{
            cuerpoEC += '<option value="' + p2.aaData[i].IDPATENTE_COLOR + '">' + p2.aaData[i].NOMBRE + '</option>';
          }
        }
        $("#colorEditarVehiculos").html(cuerpoEC);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosPropiedad.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPR = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(propiedad == p2.aaData[i].PROPIEDAD){
            cuerpoPR += '<option selected value="' + p2.aaData[i].IDPATENTE_PROPIEDAD + '">' + p2.aaData[i].PROPIEDAD + '</option>';
          }
          else{
            cuerpoPR += '<option value="' + p2.aaData[i].IDPATENTE_PROPIEDAD + '">' + p2.aaData[i].PROPIEDAD + '</option>';
          }
        }
        $("#propiedadEditarVehiculos").html(cuerpoPR);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosAseguradora.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAseg = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if (idAseg == p2.aaData[i].IDPATENTE_ASEGURADORA){
            cuerpoAseg += '<option selected value="' + p2.aaData[i].IDPATENTE_ASEGURADORA + '">' + p2.aaData[i].NOMBRE + '</option>';
          }
          else{
            cuerpoAseg += '<option value="' + p2.aaData[i].IDPATENTE_ASEGURADORA + '">' + p2.aaData[i].NOMBRE + '</option>';
          }
        }
        $("#aseguradoraEditarVehiculos").html(cuerpoAseg);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosMonedaAseg.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          idMonedaAseg = $("#aseguradoraEditarVehiculos").val();
          if ( idMonedaAseg == p2.aaData[i].IDPATENTE_ASEGURADORA){
            $("#tipoMontoEditarAseg").html("<font> / Peso</font>");
          }
          else{
            $("#tipoMontoEditarAseg").html("<font> / UF</font>");
          }
        }
      }
    }
  });

  $("#aseguradoraEditarVehiculos").unbind("click").change(async function(){
    await $.ajax({
      url:   'controller/datosMonedaAseg.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          for(var i = 0; i < p2.aaData.length; i++){
            idMonedaAseg = $("#aseguradoraEditarVehiculos").val();
            if ( idMonedaAseg == p2.aaData[i].IDPATENTE_ASEGURADORA){
              $("#tipoMontoEditarAseg").html("<font> / Peso</font>");
            }
            else{
              $("#tipoMontoEditarAseg").html("<font> / UF</font>");
            }
          }
        }
      }
    });
  });

  await $.ajax({
    url:   'controller/datosBodegaSucursal.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoBodega = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if (idSucur == p2.aaData[i].IDSUCURSAL){
            cuerpoBodega += '<option selected value="' + p2.aaData[i].IDSUCURSAL + '">' + p2.aaData[i].SUCURSAL + '</option>';
          }
          else{
            cuerpoBodega += '<option value="' + p2.aaData[i].IDSUCURSAL + '">' + p2.aaData[i].SUCURSAL + '</option>';
          }
        }
        $("#bodegaEditarVehiculos").html(cuerpoBodega);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosAreaFuncionalChile.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '<option selected value="0">Sin asignar</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          if (idComuna == p2.aaData[i].IDAREAFUNCIONAL){
            cuerpoEC += '<option selected value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + ' - ' + p2.aaData[i].REGION + '</option>';
          }
          else{
            cuerpoEC += '<option value="' + p2.aaData[i].IDAREAFUNCIONAL + '">' + p2.aaData[i].COMUNA + ' - ' + p2.aaData[i].REGION + '</option>';
          }
        }
        $("#comunaEditarVehiculos").html(cuerpoEC);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosPatenteEstadoEditar.php',
    type:  'post',
    data:  {
      "estado": estado[0]
    },
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEst = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(idEstado == 22){
            if(idEstado == p2.aaData[i].IDPATENTE_ESTADO){
              cuerpoEst += '<option selected value="' + p2.aaData[i].IDPATENTE_ESTADO + '">' + p2.aaData[i].ESTADO + '    ' + p2.aaData[i].SUB_ESTADO1 + '    ' + p2.aaData[i].SUB_ESTADO2 + '</option>';
            }
            else if(2 == p2.aaData[i].IDPATENTE_ESTADO){
              cuerpoEst += '<option value="' + p2.aaData[i].IDPATENTE_ESTADO + '">' + p2.aaData[i].ESTADO + '    ' + p2.aaData[i].SUB_ESTADO1 + '    ' + p2.aaData[i].SUB_ESTADO2 + '</option>';
            }
          }
          else{
            if(idEstado == p2.aaData[i].IDPATENTE_ESTADO){
              cuerpoEst += '<option selected value="' + p2.aaData[i].IDPATENTE_ESTADO + '">' + p2.aaData[i].ESTADO + '    ' + p2.aaData[i].SUB_ESTADO1 + '    ' + p2.aaData[i].SUB_ESTADO2 + '</option>';
            }
            else{
              cuerpoEst += '<option value="' + p2.aaData[i].IDPATENTE_ESTADO + '">' + p2.aaData[i].ESTADO + '    ' + p2.aaData[i].SUB_ESTADO1 + '    ' + p2.aaData[i].SUB_ESTADO2 + '</option>';
            }
          }
        }
        $("#estadoEditarVehiculos").html(cuerpoEst);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosMarcaPatente.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoMarca = '<option>' + marca + '</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          if (marca != p2.aaData[i].MARCA){
            cuerpoMarca += '<option>' + p2.aaData[i].MARCA + '</option>';
          }
        }
        $("#marcaEditarVehiculos").html(cuerpoMarca);
      }
    }
  });

  var parametrosMarca = {
    "marca" : marca[0]
  }
  await $.ajax({
    url:   'controller/datosModeloPatente.php',
    type:  'post',
    data: parametrosMarca,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoModelo = '<option>' + modelo + '</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          if (modelo != p2.aaData[i].MODELO){
            cuerpoModelo += '<option name="' + p2.aaData[i].LITROS_ESTANQUE + '">' + p2.aaData[i].MODELO + '</option>';
          }
        }
        $("#modeloEditarVehiculos").html(cuerpoModelo);
      }
    }
  });

  $("#marcaEditarVehiculos").unbind("click").change(async function(){
    var parametrosMarca = {
      "marca" : $('select[id="marcaEditarVehiculos"] option:selected').text()
    }
    await $.ajax({
      url:   'controller/datosModeloPatente.php',
      type:  'post',
      data: parametrosMarca,
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoModelo = '';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoModelo += '<option name="' + p2.aaData[i].LITROS_ESTANQUE + '">' + p2.aaData[i].MODELO + '</option>';
          }
          $("#modeloEditarVehiculos").html(cuerpoModelo);
        }
      }
    });

    var litrosSel = $("#modeloEditarVehiculos").find('option:selected').attr("name");
    if(litrosSel == -1){
      litrosSel = 0;
    }
    $("#litrosEditarVehiculos").val(litrosSel);
  });

  $("#modeloEditarVehiculos").unbind("click").change(async function(){
    var litrosSel = $("#modeloEditarVehiculos").find('option:selected').attr("name");
    if(litrosSel == -1){
      litrosSel = 0;
    }
    $("#litrosEditarVehiculos").val(litrosSel);
  });

  if($('select[id="propiedadEditarVehiculos"] option:selected').text() === "Propio Personal"){
    cuerpoEmpresa = '<option value="">' + 'No Aplica' + '</option>';
    cuerpoTipoMonto = '<option value="">' + '' + '</option>';
    $("#tipoMontoEditarVehiculos").html(cuerpoTipoMonto);
    $("#empresaEditarVehiculos").html(cuerpoEmpresa);
    $("#empresaEditarVehiculos").attr("disabled","disabled");
    $("#inicioEditarVehiculos").attr("disabled","disabled");
    $("#terminoEditarVehiculos").attr("disabled","disabled");
    $("#montoEditarVehiculos").val("");
    $("#montoEditarVehiculos").attr("disabled","disabled");
    $("#tipoMontoEditarVehiculos").attr("disabled","disabled");
  }
  else if($('select[id="propiedadEditarVehiculos"] option:selected').text() === "Propio Empresa"){
    cuerpoTipoMonto = '<option value="">' + '' + '</option>';
    $("#tipoMontoEditarVehiculos").html(cuerpoTipoMonto);
    $("#empresaEditarVehiculos").removeAttr("disabled");
    $("#inicioEditarVehiculos").attr("disabled","disabled");
    $("#terminoEditarVehiculos").attr("disabled","disabled");
    $("#montoEditarVehiculos").val("");
    $("#montoEditarVehiculos").attr("disabled","disabled");
    $("#tipoMontoEditarVehiculos").attr("disabled","disabled");
    await $.ajax({
      url:   'controller/datosSubcontratistasVehiculoInterno.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoSub = '';
          for(var i = 0; i < p2.aaData.length; i++){
            if(idSubcontratistas == p2.aaData[i].IDSUBCONTRATO){
              cuerpoSub += '<option selected value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
            else{
              cuerpoSub += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
          }
          $("#empresaEditarVehiculos").html(cuerpoSub);
        }
      }
    });
  }
  if($('select[id="propiedadEditarVehiculos"] option:selected').text() === "Propio Subcontrata"){
    cuerpoTipoMonto = '<option value="">' + '' + '</option>';
    $("#tipoMontoEditarVehiculos").html(cuerpoTipoMonto);
    $("#empresaEditarVehiculos").removeAttr("disabled");
    $("#inicioEditarVehiculos").attr("disabled","disabled");
    $("#terminoEditarVehiculos").attr("disabled","disabled");
    $("#montoEditarVehiculos").val("");
    $("#montoEditarVehiculos").attr("disabled","disabled");
    $("#tipoMontoEditarVehiculos").attr("disabled","disabled");
    await $.ajax({
      url:   'controller/datosSubcontratistasVehiculo.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoSub = '';
          for(var i = 0; i < p2.aaData.length; i++){
            if(idSubcontratistas == p2.aaData[i].IDSUBCONTRATO){
              cuerpoSub += '<option selected value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
            else{
              cuerpoSub += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
          }
          $("#empresaEditarVehiculos").html(cuerpoSub);
        }
      }
    });
  }
  else if($('select[id="propiedadEditarVehiculos"] option:selected').text() === "Arriendo" || $('select[id="propiedadEditarVehiculos"] option:selected').text() === "Leasing" ){
    $("#empresaEditarVehiculos").removeAttr("disabled");
    $("#inicioEditarVehiculos").removeAttr("disabled");
    $("#terminoEditarVehiculos").removeAttr("disabled");
    $("#montoEditarVehiculos").removeAttr("disabled");
    $("#tipoMontoEditarVehiculos").removeAttr("disabled");
    if (idTipoMonto == "Peso"){
      $("#tipoMontoEditarVehiculos").html('<option value="Peso">Peso</option>,<option value="UF">UF</option>');
    }
    else{
      $("#tipoMontoEditarVehiculos").html('<option value="UF">UF</option>,<option value="Peso">Peso</option>');
    }

    await $.ajax({
      url:   'controller/datosProveedores.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoSub = '';
          for(var i = 0; i < p2.aaData.length; i++){
            if(idProveedor == p2.aaData[i].IDPATENTE_PROVEEDOR){
              cuerpoSub += '<option selected value="' + p2.aaData[i].IDPATENTE_PROVEEDOR + '">' + p2.aaData[i].PROVEEDOR + '</option>';
            }
            else{
              cuerpoSub += '<option value="' + p2.aaData[i].IDPATENTE_PROVEEDOR + '">' + p2.aaData[i].PROVEEDOR + '</option>';
            }
          }
          $("#empresaEditarVehiculos").html(cuerpoSub);
        }
      }
    });
  }

  $("#propiedadEditarVehiculos").unbind("click").change(async function(){
    if($('select[id="propiedadEditarVehiculos"] option:selected').text() === "Propio Personal"){
      cuerpoEmpresa = '<option value="">' + 'No Aplica' + '</option>';
      cuerpoTipoMonto = '<option value="">' + '' + '</option>';
      $("#empresaEditarVehiculos").html(cuerpoEmpresa);
      $("#inicioEditarVehiculos").val("");
      $("#terminoEditarVehiculos").val("");
      $("#montoEditarVehiculos").val("");
      $("#tipoMontoEditarVehiculos").html(cuerpoTipoMonto);
      $("#empresaEditarVehiculos").attr("disabled","disabled");
      $("#inicioEditarVehiculos").attr("disabled","disabled");
      $("#terminoEditarVehiculos").attr("disabled","disabled");
      $("#montoEditarVehiculos").attr("disabled","disabled");
      $("#tipoMontoEditarVehiculos").attr("disabled","disabled");
    }
    else if($('select[id="propiedadEditarVehiculos"] option:selected').text() === "Propio Empresa"){
      cuerpoTipoMonto = '<option value="">' + '' + '</option>';
      $("#inicioEditarVehiculos").val("");
      $("#terminoEditarVehiculos").val("");
      $("#montoEditarVehiculos").val("");
      $("#tipoMontoEditarVehiculos").html(cuerpoTipoMonto);
      $("#empresaEditarVehiculos").removeAttr("disabled");
      $("#inicioEditarVehiculos").attr("disabled","disabled");
      $("#terminoEditarVehiculos").attr("disabled","disabled");
      $("#montoEditarVehiculos").attr("disabled","disabled");
      $("#tipoMontoEditarVehiculos").attr("disabled","disabled");
      await $.ajax({
        url:   'controller/datosSubcontratistasVehiculoInterno.php',
        type:  'post',
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            var cuerpoSub = '';
            for(var i = 0; i < p2.aaData.length; i++){
              cuerpoSub += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
            $("#empresaEditarVehiculos").html(cuerpoSub);
          }
        }
      });
    }
    else if($('select[id="propiedadEditarVehiculos"] option:selected').text() === "Propio Subcontrata"){
      cuerpoTipoMonto = '<option value="">' + '' + '</option>';
      $("#inicioEditarVehiculos").val("");
      $("#terminoEditarVehiculos").val("");
      $("#montoEditarVehiculos").val("");
      $("#tipoMontoEditarVehiculos").html(cuerpoTipoMonto);
      $("#empresaEditarVehiculos").removeAttr("disabled");
      $("#inicioEditarVehiculos").attr("disabled","disabled");
      $("#terminoEditarVehiculos").attr("disabled","disabled");
      $("#montoEditarVehiculos").attr("disabled","disabled");
      $("#tipoMontoEditarVehiculos").attr("disabled","disabled");
      await $.ajax({
        url:   'controller/datosSubcontratistasVehiculo.php',
        type:  'post',
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            var cuerpoSub = '';
            for(var i = 0; i < p2.aaData.length; i++){
              cuerpoSub += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
            $("#empresaEditarVehiculos").html(cuerpoSub);
          }
        }
      });
    }
    else if($('select[id="propiedadEditarVehiculos"] option:selected').text() === "Arriendo" || $('select[id="propiedadEditarVehiculos"] option:selected').text() === "Leasing Operativo"  || $('select[id="propiedadEditarVehiculos"] option:selected').text() === "Leasing Financiero"){
      $("#empresaEditarVehiculos").removeAttr("disabled");
      $("#inicioEditarVehiculos").removeAttr("disabled");
      $("#terminoEditarVehiculos").removeAttr("disabled");
      $("#montoEditarVehiculos").removeAttr("disabled");
      $("#montoEditarVehiculos").val(0);
      $("#tipoMontoEditarVehiculos").removeAttr("disabled");
      $("#tipoMontoEditarVehiculos").html('<option value="Peso">Peso</option>,<option value="UF">UF</option>');

      await $.ajax({
        url:   'controller/datosProveedores.php',
        type:  'post',
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            var cuerpoSub = '';
            for(var i = 0; i < p2.aaData.length; i++){
              cuerpoSub += '<option value="' + p2.aaData[i].IDPATENTE_PROVEEDOR + '">' + p2.aaData[i].PROVEEDOR + '</option>';
            }
            $("#empresaEditarVehiculos").html(cuerpoSub);
          }
        }
      });
    }
  });

  $("#inicioEditarVehiculos").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#terminoEditarVehiculos").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#mantoEditarVehiculos").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoEditarVehiculos").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#propiedadEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#marcaEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#estadoEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#bodegaEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#aseguradoraEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#modeloEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#empresaEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#colorEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#tipoMontoEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#operacionEditarVehiculos").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#kilometrajeEditarVehiculos" ).focusout(function(){
    kilometro = $("#kilometrajeEditarVehiculos").val();
    if(kilometro < 0){
      $("#kilometrajeEditarVehiculos").val(0);
      $("#kilometrajeEditarVehiculos").addClass("is-invalid");


      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
    }
    else{
      $("#kilometrajeEditarVehiculos").val(kilometro);
    }
  });

  $("#anoEditarVehiculos" ).focusout(function(){
    ano = $("#anoEditarVehiculos").val();
    if(ano < 1980){
      $("#anoEditarVehiculos").val(1980);
      $("#anoEditarVehiculos").addClass("is-invalid");


      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 1980");
    }
    else{
      $("#anoEditarVehiculos").val(ano);
    }
  });

  $("#montoAseguradoraEditarVehiculos" ).focusout(function(){
    montoAseg = $("#montoAseguradoraEditarVehiculos").val();
    if(montoAseg < 0){
      $("#montoAseguradoraEditarVehiculos").val(0);
      $("#montoAseguradoraEditarVehiculos").addClass("is-invalid");


      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
    }
    else{
      $("#montoAseguradoraEditarVehiculos").val(montoAseg);
    }
  });

  $("#montoEditarVehiculos" ).focusout(function(){
    monto = $("#montoEditarVehiculos").val();
    if(monto < 0){
      $("#montoEditarVehiculos").val(0);
      $("#montoEditarVehiculos").addClass("is-invalid");


      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
    }
    else{
      $("#montoEditarVehiculos").val(monto);
    }
  });

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyEditarVehiculos").css("height",h);
    $("#modalEditarVehiculos").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyEditarVehiculos').animate({ scrollTop: 0 }, 'fast');
    },200);
  },1000);
});

// Funcion para guardar editar Vehiculo
$("#guardarEditarVehiculos").unbind('click').click(function(){
  if($("#patenteEditarVehiculos").val().length == 0 || $("#kilometrajeEditarVehiculos").val().length == 0 || $("#anoEditarVehiculos").val().length == 0 ){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#patenteEditarVehiculos").val().length == 0){
      $("#patenteEditarVehiculos").addClass("is-invalid");
    }
    if ($("#kilometrajeEditarVehiculos").val().length == 0){
      $("#kilometrajeEditarVehiculos").addClass("is-invalid");
    }
    if ($("#anoEditarVehiculos").val().length == 0){
      $("#anoEditarVehiculos").addClass("is-invalid");
    }
  }
  else{
    var table = $('#tablaListadoVehiculo').DataTable();
    var idVehiculo = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE;
    });
    parametros = {
      "idVehiculo": idVehiculo[0],
      "patente": $("#patenteEditarVehiculos").val(),
      "kilometraje": $("#kilometrajeEditarVehiculos").val(),
      "marca": $("#marcaEditarVehiculos").val(),
      "modelo": $("#modeloEditarVehiculos").val(),
      "ano": $("#anoEditarVehiculos").val(),
      "tipoVehiculo": $("#tipoEditarVehiculos").val(),
      "vin": $("#vinEditarVehiculos").val(),
      "color": $("#colorEditarVehiculos").val(),
      "propiedad": $("#propiedadEditarVehiculos").val(),
      "empresa": $("#empresaEditarVehiculos").val(),
      "inicio": $("#inicioEditarVehiculos").val(),
      "termino": $("#terminoEditarVehiculos").val(),
      "monto": $("#montoEditarVehiculos").val(),
      "bodega": $("#bodegaEditarVehiculos").val(),
      "aseguradora": $("#aseguradoraEditarVehiculos").val(),
      "montoAseguradora": $("#montoAseguradoraEditarVehiculos").val(),
      "manto": $("#mantoEditarVehiculos").val(),
      "estado": $("#estadoEditarVehiculos").val(),
      "tipoMonto": $("#tipoMontoEditarVehiculos").val(),
      "nMotor": $("#nMotorEditarVehiculos").val(),
      "operacion": $("#operacionEditarVehiculos").val(),
      "litros": $("#litrosEditarVehiculos").val(),
      "comuna": $("#comunaEditarVehiculos").val(),
    }
    $("#modalEditarVehiculos").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/editarVehiculo.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoVehiculo').DataTable();
            table.ajax.reload();
            var table2 = $('#informeListadoVehiculo').DataTable();
            table2.ajax.reload(varGraficoPorFlota);

            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Vehículo Editado correctamente");
            $("#editarVehiculo").attr("disabled","disabled");
            $("#subirPdfVehiculo").attr("disabled","disabled");
            $("#historialVehiculo").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $('#tablaListadoVehiculo').DataTable().columns.adjust();
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Vehiculo, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Vehiculo, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#patenteEditarVehiculos").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#kilometrajeEditarVehiculos").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#anoEditarVehiculos").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#montoEditarVehiculos").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#montoAseguradoraEditarVehiculos").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL EDITAR VEHICULO

$("#detallePracticaMetas").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaPracticaMetas').DataTable();
  var rut = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT;
  });
  var perfil = $.map(table.rows('.selected').data(), function (item) {
      return item.PERFIL;
  });
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });

  $("#tituloPracticaMetaDetalle").html('&squf;&nbsp;&nbsp;' + nombre[0] + ' - ' + rut[0] + ' ' + '<br>&squf;&nbsp;&nbsp;' + perfil[0]);

  var parametros = {
    "rut": rut[0],
    "perfil": perfil[0],
    "ano": $("#periodoPracticaMetas").val().split('-')[0],
    "mes": $("#periodoPracticaMetas").val().split('-')[1]
  }

  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

  $('#tablaPracticaMetaDetalle').DataTable( {
    ajax: {
        url: "controller/datosAvanceMetaPracticaDetalle.php",
        type: 'POST',
        data: parametros
    },
    buttons: [
      {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,9,10 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
      }
    ],
    "columns": [
      {
        data: 'S',
        width: "5px",
        orderable: false,
        className: 'select-checkbox',
        targets: [ 0 ]
      },
      {
        data: 'AUDITORIA'
      },
      {
        data: 'CICLO'
      },
      {
        data: 'META',
        className: "centerDataTable"
      },
      {
        className: "centerDataTable",
        render: function(data, type, row, meta) {
            return '<span>' + row['1'] + ' de ' + row['Meta_1'] + '</span>';
        }
      },
      {
        className: "centerDataTable",
        render: function(data, type, row, meta) {
            return '<span>' + row['2'] + ' de ' + row['Meta_2'] + '</span>';
        }
      },
      {
        className: "centerDataTable",
        render: function(data, type, row, meta) {
            return '<span>' + row['3'] + ' de ' + row['Meta_3'] + '</span>';
        }
      },
      {
        className: "centerDataTable",
        render: function(data, type, row, meta) {
            return '<span>' + row['4'] + ' de ' + row['Meta_4'] + '</span>';
        }
      },
      {
        className: "centerDataTable",
        render: function(data, type, row, meta) {
            return '<span>' + row['5'] + ' de ' + row['Meta_5'] + '</span>';
        }
      },
      {
        className: "centerDataTable",
        render: function(data, type, row, meta) {
            return '<span>' + row['6'] + ' de ' + row['Meta_6'] + '</span>';
        }
      },
      {
        data: 'AVANCE',
        className: "centerDataTable"
      },
      {
        orderable: true,
        width: '250px',
        render: function(data, type, row, meta) {
            var mt = 0;
            var av = 0;
            var re = 0;
            for(var i = 1; i <= 6; i++){
              if(parseInt(row['Meta_' + i]) > 0){
                mt++;
              }
            }
            for(var i = 1; i <= 6; i++){
              if(parseInt(row[i]) > 0){
                re++;
              }
            }
            for(var i = 1; i <= 6; i++){
              if(parseInt(row['Meta_' + i]) > 0 && parseInt(row[i]) >= parseInt(row['Meta_' + i])){
                av++;
              }
            }
            var pr = 0;
            if(mt > 0){
              pr = 100*av/mt;
            }
            else if(re > 0){
              pr = 100;
            }
            return '<div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" style="font-weight: bold; font-size: 8pt; width:' + pr.toString() + '%;">' + pr.toString() + '% </div></div>';
        }
      }
    ],
    columnDefs: [
      {
        targets: [4],
        createdCell: function(td, cellData, rowData, row, col) {
            var color;
            if(parseInt(rowData['Meta_1'])  == 0 && parseInt(rowData['1'])  > 0 ){
              color = '#33832a';
            }
            else if(parseInt(rowData['Meta_1'])  == 0 && parseInt(rowData['1']) == 0 ){
              color = 'white';
            }
            else if(parseInt(rowData['Meta_1']) <= parseInt(rowData['1'])){
              color = '#33832a';
            }
            else{
              color = '#c47171';
            }
            $(td).css('background',color);
        },
      },
      {
        targets: [5],
        createdCell: function(td, cellData, rowData, row, col) {
            var color;
            if(parseInt(rowData['Meta_2'])  == 0 && parseInt(rowData['2'])  > 0 ){
              color = '#33832a';
            }
            else if(parseInt(rowData['Meta_2'])  == 0 && parseInt(rowData['2']) == 0 ){
              color = 'white';
            }
            else if(parseInt(rowData['Meta_2']) <= parseInt(rowData['2'])){
              color = '#33832a';
            }
            else{
              color = '#c47171';
            }
            $(td).css('background',color);
        },
      },
      {
        targets: [6],
        createdCell: function(td, cellData, rowData, row, col) {
            var color;
            if(parseInt(rowData['Meta_3'])  == 0 && parseInt(rowData['3'])  > 0 ){
              color = '#33832a';
            }
            else if(parseInt(rowData['Meta_3'])  == 0 && parseInt(rowData['3']) == 0 ){
              color = 'white';
            }
            else if(parseInt(rowData['Meta_3']) <= parseInt(rowData['3'])){
              color = '#33832a';
            }
            else{
              color = '#c47171';
            }
            $(td).css('background',color);
        },
      },
      {
        targets: [7],
        createdCell: function(td, cellData, rowData, row, col) {
            var color;
            if(parseInt(rowData['Meta_4'])  == 0 && parseInt(rowData['4'])  > 0 ){
              color = '#33832a';
            }
            else if(parseInt(rowData['Meta_4'])  == 0 && parseInt(rowData['4']) == 0 ){
              color = 'white';
            }
            else if(parseInt(rowData['Meta_4']) <= parseInt(rowData['4'])){
              color = '#33832a';
            }
            else{
              color = '#c47171';
            }
            $(td).css('background',color);
        },
      },
      {
        targets: [8],
        createdCell: function(td, cellData, rowData, row, col) {
            var color;
            if(parseInt(rowData['Meta_5'])  == 0 && parseInt(rowData['5'])  > 0 ){
              color = '#33832a';
            }
            else if(parseInt(rowData['Meta_5'])  == 0 && parseInt(rowData['5']) == 0 ){
              color = 'white';
            }
            else if(parseInt(rowData['Meta_5']) <= parseInt(rowData['5'])){
              color = '#33832a';
            }
            else{
              color = '#c47171';
            }
            $(td).css('background',color);
        },
      },
      {
        targets: [9],
        createdCell: function(td, cellData, rowData, row, col) {
            var color;
            if(parseInt(rowData['Meta_6'])  == 0 && parseInt(rowData['6'])  > 0 ){
              color = '#33832a';
            }
            else if(parseInt(rowData['Meta_6'])  == 0 && parseInt(rowData['6']) == 0 ){
              color = 'white';
            }
            else if(parseInt(rowData['Meta_6']) <= parseInt(rowData['6'])){
              color = '#33832a';
            }
            else{
              color = '#c47171';
            }
            $(td).css('background',color);
        },
      },
    ],
    "select": {
        style: 'single'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "order": [[ 0, "desc" ]],
    "info":     true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalPracticaMetaDetalle").modal("show");
            setTimeout(function(){
              $('#tablaPracticaMetaDetalle').DataTable().columns.adjust();
            },500);
          },2000);
        }
    });
});

$("#fotoCargarImgPersonal" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputFotoCargarImgPersonal").val(file);
  $("#inputFotoCargarImgPersonal").removeClass("is-invalid");
});

$("#imagenJefatura").unbind("click").click(function(){
  var table = $('#tablaJefatura').DataTable();
  var dni = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI;
  });
  var nombres = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRES;
  });
  var apellidos = $.map(table.rows('.selected').data(), function (item) {
      return item.APELLIDOS;
  });

  $("#tituloCargarImgPersonal").html('&squf;&nbsp;&nbsp;' + nombres + ' ' + apellidos + ' - ' + dni);

  $("#fotoCargarImgPersonal").val('');
  $("#inputFotoCargarImgPersonal").val('');
  $("#inputFotoCargarImgPersonal").removeClass("is-invalid");
  $("#modalCargaImgPersonal").modal("show");
});

$("#guardarCargarImgPersonal").unbind("click").click(function(){
  if($("#inputFotoCargarImgPersonal").val() === ''){
    $("#inputFotoCargarImgPersonal").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se ha cargado ninguna fotografia");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalCargaImgPersonal").modal("hide");
    var table = $('#tablaJefatura').DataTable();
    var dni = $.map(table.rows('.selected').data(), function (item) {
        return item.DNI;
    });
    var id = $.map(table.rows('.selected').data(), function (item) {
        return item.IDPERSONAL;
    });

    var formdata = new FormData();
    formdata.append('dni',dni);
    formdata.append('id',id);
    formdata.append('foto',$("#fotoCargarImgPersonal")[0].files[0]);

    $.ajax({
      url: "controller/ingresaPersonalFoto.php",
      type: 'POST',
      data: formdata,
      cache: false,
      contentType: false,
      processData: false,
      success: async function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaJefatura').DataTable();
            table.ajax.reload();
            // var rows = table.rows( '.selected' ).remove().draw();
            // var p2 = jQuery.parseJSON(response);
            // await ingresaModificacionJefatura(p2);
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },1000);
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Fotografia cargada correctamente");
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar la fotografia usuario, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },1000);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar la fotografia usuario, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },1000);
        }
      }
    });
  }
});

$("#rutIngresoUsuario").unbind("click").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  parametros = {
    "rut": $("#rutIngresoUsuario").val().replace(".","").replace(".","")
  }
  await $.ajax({
    url:   'controller/datosPersonalUsuarioSeleccionado.php',
    type:  'post',
    data: parametros,
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        $("#nombresIngresoUsuario").val(p.aaData[0].NOMBRES);
        $("#apellidosIngresoUsuario").val(p.aaData[0].APELLIDOS);
      }
    }
  });
});

// FUNCION PARA MODAL SUBIR PDF VEHICULO
// Primero cargamos los archivos
$("#pdfCargaRevisionTecnica" ).on('change', function(e){
  var file = e.target.files[0].name; // agarramos solo el nombre([0].name) del array que tiene tamaño, fecha y mas
  $("#inputPdfRevisionTecnica").val(file);
  $("#inputPdfRevisionTecnica").removeClass("is-invalid");
});

$("#pdfCargaPermisoCirculacion" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfPermisoCirculacion").val(file);
  $("#inputPdfPermisoCirculacion").removeClass("is-invalid");
});

$("#pdfCargaAseguradora" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfAseguradora").val(file);
  $("#inputPdfAseguradora").removeClass("is-invalid");
});

$("#pdfCargaOtros" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfOtros").val(file);
  $("#inputPdfOtros").removeClass("is-invalid");
});

$("#subirPdfVehiculo").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoVehiculo').DataTable();
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE;
  });
  $("#tituloSubirPdfVehiculo").html('Patente: ' + patente);

  $("#rTecFechaRealizadaVehiculo").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#rTecFechaCaducidadVehiculo").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#pCirFechaRealizadVehiculo").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#pCirFechaCaducidadVehiculo").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#emisionGasesFechaRealizadVehiculo").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#emisionGasesFechaCaducidadVehiculo").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  var parametrosPatente = {
    "patente" : patente[0]
  }
  await $.ajax({
    url:   'controller/datosEditarVehiculo.php',
    type:  'post',
    data: parametrosPatente,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      revTec = p3.aaData[0].PDFREVTEC;
      permCirc = p3.aaData[0].PDFPERMCIRC;
      aseg = p3.aaData[0].PDFASEG;
      otros = p3.aaData[0].PDFOTROS;
      realizRevTec = p3.aaData[0].FREALIZADAREVTEC;
      caducRevTec = p3.aaData[0].FCADUCIDADREVTEC;
      realizPermCirc = p3.aaData[0].FREALIZADAPERMCIRC;
      caducPermCirc = p3.aaData[0].FCADUCIDADPERMCIRC;
      emisionGases = p3.aaData[0].PDFEMISIONGASES;
      realizEmisionGases = p3.aaData[0].FREALIZADAEMISIONGASES;
      caducEmisionGases = p3.aaData[0].FCADUCIDADEMISIONGASES;
    }
  });

  if(revTec == null){
    $("#inputPdfRevisionTecnica").val(revTec);
    $("#spanRevTec").html("<font> </font>");
  }
  else{
    $("#spanRevTec").html("<font>  ¡Si desea reemplazarlo, cargue uno nuevo! </font>");
    $("#inputPdfRevisionTecnica").val(revTec);
  }

  if(permCirc == null){
    $("#inputPdfPermisoCirculacion").val(permCirc);
    $("#spanPermCirc").html("<font> </font>");
  }
  else{
    $("#spanPermCirc").html("<font>  ¡Si desea reemplazarlo, cargue uno nuevo! </font>");
    $("#inputPdfPermisoCirculacion").val(permCirc);
  }

  if(aseg == null){
    $("#inputPdfAseguradora").val(aseg);
    $("#spanAseg").html("<font> </font>");
  }
  else{
    $("#spanAseg").html("<font>  ¡Si desea reemplazarlo, cargue uno nuevo! </font>");
    $("#inputPdfAseguradora").val(aseg);
  }

  if(otros == null){
    $("#inputPdfOtros").val(otros);
    $("#spanOtros").html("<font> </font>");
  }
  else{
    $("#spanOtros").html("<font>  ¡Si desea reemplazarlo, cargue uno nuevo! </font>");
    $("#inputPdfOtros").val(otros);
  }

  if(emisionGases == null){
    $("#inputPdfEmisionGases").val(emisionGases);
    $("#spanEmisGases").html("<font> </font>");
  }
  else{
    $("#spanEmisGases").html("<font>  ¡Si desea reemplazarlo, cargue uno nuevo! </font>");
    $("#inputPdfEmisionGases").val(emisionGases);
  }

  $("#pdfCargaRevisionTecnica").val('');
  $("#inputPdfRevisionTecnica").removeClass("is-invalid");

  $("#pdfCargaPermisoCirculacion").val('');
  $("#inputPdfPermisoCirculacion").removeClass("is-invalid");

  $("#pdfCargaEmisionGases").val('');
  $("#inputPdfEmisionGases").removeClass("is-invalid");

  $("#pdfCargaAseguradora").val('');
  $("#inputPdfAseguradora").removeClass("is-invalid");

  $("#pdfCargaOtros").val('');
  $("#inputPdfOtros").removeClass("is-invalid");

  $("#rTecFechaRealizadaVehiculo").val(realizRevTec);
  $("#rTecFechaCaducidadVehiculo").val(caducRevTec);
  $("#pCirFechaRealizadVehiculo").val(realizPermCirc);
  $("#pCirFechaCaducidadVehiculo").val(caducPermCirc);
  $("#emisionGasesFechaRealizadVehiculo").val(realizEmisionGases);
  $("#emisionGasesFechaCaducidadVehiculo").val(caducEmisionGases);

  $("#rTecFechaRealizadaVehiculo").removeClass("is-invalid");
  $("#rTecFechaCaducidadVehiculo").removeClass("is-invalid");
  $("#pCirFechaRealizadVehiculo").removeClass("is-invalid");
  $("#pCirFechaCaducidadVehiculo").removeClass("is-invalid");
  $("#emisionGasesFechaRealizadVehiculo").removeClass("is-invalid");
  $("#emisionGasesFechaCaducidadVehiculo").removeClass("is-invalid");

  var h = $(window).height() - 200;
  $("#bodySubirPdfVehiculo").css("height",h);
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalSubirPdfVehiculo").modal("show");
  },500);
});

$("#guardarSubirPdfVehiculo").unbind("click").click(function(){
  if($("#inputPdfRevisionTecnica").val() != '' || $("#inputPdfPermisoCirculacion").val() != '' || $("#inputPdfAseguradora").val() != '' || $("#inputPdfOtros").val() != '' || $("#inputPdfEmisionGases").val() != ''){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalSubirPdfVehiculo").modal("hide");
    var table = $('#tablaListadoVehiculo').DataTable();
    var patente = $.map(table.rows('.selected').data(), function (item) {
        return item.PATENTE;
    });

    var formdata = new FormData();
    formdata.append('patente',patente);
    formdata.append('pdfRevTec',$("#pdfCargaRevisionTecnica")[0].files[0]);
    formdata.append('fRealizadaRevTec',$("#rTecFechaRealizadaVehiculo").val());
    formdata.append('fCaducidadRevTec',$("#rTecFechaCaducidadVehiculo").val());
    formdata.append('pdfPermCirc',$("#pdfCargaPermisoCirculacion")[0].files[0]);
    formdata.append('fRealizaPermCirc',$("#pCirFechaRealizadVehiculo").val());
    formdata.append('fCaducidadPermCirc',$("#pCirFechaCaducidadVehiculo").val());
    formdata.append('pdfEmisionGases',$("#pdfCargaEmisionGases")[0].files[0]);
    formdata.append('fRealizadaEmisionGases',$("#emisionGasesFechaRealizadVehiculo").val());
    formdata.append('fCaducidadEmisionGases',$("#emisionGasesFechaCaducidadVehiculo").val());
    formdata.append('pdfAseg',$("#pdfCargaAseguradora")[0].files[0]);
    formdata.append('pdfOtros',$("#pdfCargaOtros")[0].files[0]);

    $.ajax({
      url: "controller/ingresaPdfVehiculo.php",
      type: 'POST',
      data: formdata,
      cache: false,
      contentType: false,
      processData: false,
      success: function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){

            var table = $('#tablaListadoVehiculo').DataTable();
            table.ajax.reload();
            var table2 = $('#informeListadoVehiculo').DataTable();
            table2.ajax.reload(varGraficoPorFlota);

            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>PDF cargada correctamente");
            $("#editarVehiculo").attr("disabled","disabled");
            $("#subirPdfVehiculo").attr("disabled","disabled");
            $("#historialVehiculo").attr("disabled","disabled");

            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            $('#modalAlertasSplash').modal('hide');
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar el PDF, si el problema persiste favor comuniquese con soporte");
          }
        }
        else{
          $('#modalAlertasSplash').modal('hide');
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar el PDF, si el problema persiste favor comuniquese con soporte");
        }
      }
    });
  }
  else{
    $("#inputPdfRevisionTecnica").addClass("is-invalid");
    $("#inputPdfPermisoCirculacion").addClass("is-invalid");
    $("#inputPdfAseguradora").addClass("is-invalid");
    $("#inputPdfOtros").addClass("is-invalid");

    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se ha cargado ningun PDF");
  }
});

$("#rTecFechaRealizadaVehiculo").on('change', function(){
  $(this).removeClass("is-invalid");
});

$("#rTecFechaCaducidadVehiculo").on('change', function(){
  $(this).removeClass("is-invalid");
});

$("#pCirFechaRealizadVehiculo").on('change', function(){
  $(this).removeClass("is-invalid");
});

$("#pCirFechaCaducidadVehiculo").on('change', function(){
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL SUBIR PDF VEHICULO

// EVENTO PARA ABRIR PDF VEHICULO
async function pdf_Vehiculo(pdf){
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    window.open(window.location.toString().split("#/")[0].split('?')[0] + 'controller/repositorio/flota/' + pdf, '_blank');
  }
}
// FIN EVENTO PARA ABRIR PDF VEHICULO

$("#detallePracticaMetasTodosExcel").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'><span class='fas fa-file-excel'></span>&nbsp;&nbsp;Generando documento Excel</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaPracticaMetas').DataTable();
  var rut = $.map(table.rows().data(), function (item) {
      return item.RUT;
  });
  var strDni = '';
  for(var i = 0; i < rut.length; i++){
    if(i == rut.length - 1){
        strDni += "'"  + rut[i] + "'";
    }
    else{
        strDni += "'" + rut[i] + "',";
    }
  }
  var parametros = {
    "mes": $("#periodoPracticaMetas").val().split('-')[1],
    "ano": $("#periodoPracticaMetas").val().split('-')[0],
    "strDni": strDni
  }

  $.ajax({
    url:   'controller/generaExcelDetalleTodos.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      $('#modalAlertasSplash').modal('hide');
      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Documento generado correctamente<br><font style='font-size: 9pt;'>(Si el documento no es descargado, favor verifique no tener bloqueadas las ventanas emergentes)</font>");
      window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/temp/' + response, '_blank');
    }
  });
});

var estructuraIncidencia = {};
var estructuraOperacion = {};
var lstIncidenciaPersonal = [];
var lstIncidenciaPatente = [];

async function cargarIncidencia() {
  await $.ajax({
    url:   'controller/datosTecnicos.php',
    type:  'post',
    data: {
      "path": window.location.href.split('#/')[1]
    },
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++) {
          lstIncidenciaPersonal.push({
            id: parseInt(p.aaData[i].IDPERSONAL),
            value: p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES.split(" ")[0] + ' ' + p.aaData[i].APELLIDOS.split(" ")[0]
          });
        }
        $('#selectIncidenciaPersonal').autocomplete({
          source: function (req, responseFn) {
            var term = $.ui.autocomplete.escapeRegex(req.term),
              matcher = new RegExp(term, 'i'),
              matches = $.grep(lstIncidenciaPersonal, ({ value }) => matcher.test(value));
            responseFn(matches);
          }
        });
      }
    }
  });

  await $.ajax({
    url:   'controller/datosPatenteConEstado.php',
    type:  'post',
    data: {
      "path": window.location.href.split('#/')[1]
    },
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++) {
          lstIncidenciaPatente.push({
            id: parseInt(p.aaData[i].IDPATENTE),
            value: p.aaData[i].CODIGO + ' - ' + p.aaData[i].ESTADO
          });
        }
        $('#selectIncidenciaPatente').autocomplete({
          source: function (req, responseFn) {
            var term = $.ui.autocomplete.escapeRegex(req.term),
              matcher = new RegExp(term, 'i'),
              matches = $.grep(lstIncidenciaPatente, ({ value }) => matcher.test(value));
            responseFn(matches);
          }
        });
      }
    }
  });

  await $.ajax({
    url: "controller/datosEstructuraOperacion.php",
    type: 'POST',
    data: { },
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var jsonData = {};

        p.aaData.forEach(({
          IDESTRUCTURA_OPERACION,
          IDSERVICIO,
          SERVICIO,
          IDCLIENTE,
          CLIENTE,
          IDACTIVIDAD,
          ACTIVIDAD
        }) => {
          jsonData[`serv_${IDSERVICIO}`] = {
            title: SERVICIO,
            values: {}
          };
        });

        p.aaData.forEach(({ IDSERVICIO, IDCLIENTE, CLIENTE }) => {
          jsonData[`serv_${IDSERVICIO}`].values[`clie_${IDCLIENTE}`] = {
            title: CLIENTE,
            values: {}
          };
        });

        p.aaData.forEach(({ IDSERVICIO, IDCLIENTE, IDACTIVIDAD, ACTIVIDAD, IDESTRUCTURA_OPERACION }) => {
          jsonData[`serv_${IDSERVICIO}`].values[`clie_${IDCLIENTE}`].values[`act_${IDACTIVIDAD}`] = {
            title: ACTIVIDAD,
            struct: IDESTRUCTURA_OPERACION
          };
        });

        estructuraOperacion = jsonData;

        var cuerpo = '';
        Object.keys(jsonData).forEach((key) => {
          cuerpo += '<option value="' + key + '">' + jsonData[key].title + '</option>';
        });
        $("#selectIncidenciaServicio").html(cuerpo);

        var cuerpo = '';
        var keyChild = Object.keys(jsonData)[0];
        var jsonChild = jsonData[keyChild].values;
        Object.keys(jsonChild).forEach((key) => {
          cuerpo += '<option value="' + key + '">' + jsonChild[key].title + '</option>';
        });
        $("#selectIncidenciaCliente").html(cuerpo);

        var cuerpo = '';
        var keyChild = Object.keys(jsonChild)[0];
        var jsonChild = jsonChild[keyChild].values;
        Object.keys(jsonChild).forEach((key) => {
          cuerpo += '<option value="' + key + '">' + jsonChild[key].title + '</option>';
        });
        $("#selectIncidenciaActividad").html(cuerpo);
      }
    }
  });

  await $.ajax({
    url: "controller/datosIncidenciaEstructura.php",
    type: 'POST',
    data: { },
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      $("#incidencia").empty();
      if(p.aaData.length !== 0) {

        var jsonData = {};

        p.aaData.forEach(({
          IDINCIDENCIA_ESTRUCTURA,
          IDAREA,
          AREA,
          IDITEM,
          ITEM,
          IDELEME,
          ELEME,
          IDANOMA,
          ANOMA,
          IDDEPAR,
          DEPAR,
          IDALERT,
          ALERT,
          PRIORIDAD
        }) => {
          jsonData[`area_${IDAREA}`] = {
            title: AREA,
            values: {}
          };
        });

        p.aaData.forEach(({ IDAREA, IDITEM, ITEM }) => {
          jsonData[`area_${IDAREA}`].values[`item_${IDITEM}`] = {
            title: ITEM,
            values: {}
          };
        });

        p.aaData.forEach(({ IDAREA, IDITEM, IDELEME, ELEME }) => {
          jsonData[`area_${IDAREA}`].values[`item_${IDITEM}`].values[`elem_${IDELEME}`] = {
            title: ELEME,
            values: {}
          }
        });

        p.aaData.forEach(({ IDAREA, IDITEM, IDELEME, IDANOMA, ANOMA }) => {
          jsonData[`area_${IDAREA}`].values[`item_${IDITEM}`].values[`elem_${IDELEME}`].values[`anom_${IDANOMA}`] = {
            title: ANOMA,
            values: {}
          }
        });

        p.aaData.forEach(({ IDAREA, IDITEM, IDELEME, IDANOMA, IDDEPAR, DEPAR, IDALERT, ALERT, IDINCIDENCIA_ESTRUCTURA }) => {
          jsonData[`area_${IDAREA}`].values[`item_${IDITEM}`].values[`elem_${IDELEME}`].values[`anom_${IDANOMA}`].depa = {
            id: IDDEPAR,
            name: DEPAR
          };
          jsonData[`area_${IDAREA}`].values[`item_${IDITEM}`].values[`elem_${IDELEME}`].values[`anom_${IDANOMA}`].alert = {
            id: IDALERT,
            name: ALERT
          };
          jsonData[`area_${IDAREA}`].values[`item_${IDITEM}`].values[`elem_${IDELEME}`].values[`anom_${IDANOMA}`].struct = IDINCIDENCIA_ESTRUCTURA;
        });

        estructuraIncidencia = jsonData;

        var cuerpo = '';
        Object.keys(jsonData).forEach((key) => {
          cuerpo += '<option value="' + key + '">' + jsonData[key].title + '</option>';
        });
        $("#selectTiposAreas").html(cuerpo);

        var cuerpo = '';
        var keyChild = Object.keys(jsonData)[0];
        var jsonChild = jsonData[keyChild].values;
        Object.keys(jsonChild).forEach((key) => {
          cuerpo += '<option value="' + key + '">' + jsonChild[key].title + '</option>';
        });
        $("#selectIncidenciaItem").html(cuerpo);

        var cuerpo = '';
        var keyChild = Object.keys(jsonChild)[0];
        var jsonChild = jsonChild[keyChild].values;
        Object.keys(jsonChild).forEach((key) => {
          cuerpo += '<option value="' + key + '">' + jsonChild[key].title + '</option>';
        });
        $("#selectIncidenciaElemento").html(cuerpo);

        var cuerpo = '';
        var keyChild = Object.keys(jsonChild)[0];
        var jsonChild = jsonChild[keyChild].values;
        Object.keys(jsonChild).forEach((key) => {
          cuerpo += '<option value="' + key + '">' + jsonChild[key].title + '</option>';
        });
        $("#selectIncidenciaAnomalia").html(cuerpo);

        var keyChild = Object.keys(jsonChild)[0];
        var inputChild = jsonChild[keyChild];
        $("#inputIncidenciaDepartamento").val(inputChild.depa.name);
        $("#inputIncidenciaAlerta").val(inputChild.alert.name);
      }
    }
  });

  await $.ajax({
    url: "controller/datosSucursal.php",
    type: 'POST',
    data: { },
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0) {
        var cuerpo = '';
        p.aaData.forEach(({
          IDSUCURSAL,
          SUCURSAL,
          COMUNA
        }) => {
          cuerpo += '<option value="' + IDSUCURSAL + '">' + SUCURSAL + ' - ' + COMUNA + '</option>';
        });
        $("#selectIncidenciaSucursal").html(cuerpo);
      }
    }
  });

  setTimeout(function(){
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#selectTiposAreas").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#selectIncidenciaItem").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#selectIncidenciaElemento").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#selectIncidenciaAnomalia").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#selectIncidenciaServicio").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#selectIncidenciaCliente").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#selectIncidenciaActividad").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#selectIncidenciaSucursal").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  },500);
}

async function cargarIncidenciaTablaSinConfiguracion() {
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  await $('#tablaIncidenciaSinConfiguracion').DataTable({
    ajax: {
      url: "controller/datosIncidenciasSinConfiguracion.php",
      type: 'POST'
    },
    columns: [
      { data: 'S'},
      { data: 'AREA', className: "centerDataTable"},
      { data: 'ITEM'},
      { data: 'DEPARTAMENTO'},
      { data: 'SERVICIO'},
      { data: 'CLIENTE' },
      { data: 'ACTIVIDAD' },
      { data: 'SUCURSAL' },
      { data: 'COMUNA' },
      { data: 'SLA' },
      { data: 'DNI_RESOLUTOR' },
      { data: 'NOMBRE_RESOLUTOR' }
    ],
    buttons: [
      {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,9,10,11 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
      },
      {
        text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
        action: function ( e, dt, node, config ) {
          var table = $('#tablaIncidenciaSinConfiguracion').DataTable();
          $("#nuevaConfiguracion").attr("disabled","disabled");
          $("#eliminarConfiguracion").attr("disabled","disabled");
          table.rows().deselect();
        }
      }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      }
    ],
    "select": {
      style: 'multi',
      selector: 'td:not(:nth-child(16))'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "order": [[ 1, "desc" ]],
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": async function( settings, json) {
      setTimeout(function(){
        $('#contenido').show();
        $('#menu-lateral').show();
        $('#footer').parent().show();
$('#footer').show();

        var table = $('#tablaIncidenciaSinConfiguracion').DataTable();

        var itemIn = '';
        itemIn += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(2).data().unique().length; i++){
          if(table.column(2).data().unique()[i] !== null){
            itemIn += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
          }
        }
        $("#itemFiltroConfiguracion").html(itemIn);

        var deptoIn = '';
        deptoIn += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(3).data().unique().length; i++){
          if(table.column(3).data().unique()[i] !== null){
            deptoIn += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
          }
        }
        $("#departamentoFiltroConfiguracion").html(deptoIn);

        var servicioIn = '';
        servicioIn += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(4).data().unique().length; i++){
          if(table.column(4).data().unique()[i] !== null){
            servicioIn += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
          }
        }
        $("#servicioFiltroConfiguracion").html(servicioIn);

        var clienteIn = '';
        clienteIn += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(5).data().unique().length; i++){
          if(table.column(5).data().unique()[i] !== null){
            clienteIn += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
          }
        }
        $("#clienteFiltroConfiguracion").html(clienteIn);

        var actividadIn = '';
        actividadIn += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(6).data().unique().length; i++){
          if(table.column(6).data().unique()[i] !== null){
            actividadIn += '<option value="' + table.column(6).data().unique()[i] + '">' + table.column(6).data().unique()[i] + '</option>';
          }
        }
        $("#actividadFiltroConfiguracion").html(actividadIn);

        var sucursalIn = '';
        sucursalIn += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(7).data().unique().length; i++){
          if(table.column(7).data().unique()[i] !== null){
            sucursalIn += '<option value="' + table.column(7).data().unique()[i] + '">' + table.column(7).data().unique()[i] + '</option>';
          }
        }
        $("#sucursalFiltroConfiguracion").html(sucursalIn);

        var comunaIn = '';
        comunaIn += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(8).data().unique().length; i++){
          if(table.column(8).data().unique()[i] !== null){
            comunaIn += '<option value="' + table.column(8).data().unique()[i] + '">' + table.column(8).data().unique()[i] + '</option>';
          }
        }
        $("#comunaFiltroConfiguracion").html(comunaIn);

        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#itemFiltroConfiguracion").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
          $("#departamentoFiltroConfiguracion").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
          $("#servicioFiltroConfiguracion").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
          $("#clienteFiltroConfiguracion").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
          $("#actividadFiltroConfiguracion").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
          $("#sucursalFiltroConfiguracion").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
          $("#comunaFiltroConfiguracion").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }

        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          menuElegant();
          setTimeout(function(){
            $('#tablaIncidenciaSinConfiguracion').DataTable().columns.adjust();
          },500);
        },500);
      },1000);

      var path = window.location.href.split('#/')[1];
      var parametros = {
        "path": path
      }

      await $.ajax({
        url:   'controller/datosAccionesVisibles.php',
        type:  'post',
        data: parametros,
        success: function (response) {
          var p = jQuery.parseJSON(response);
          if(p.aaData.length !== 0){
            for(var i = 0; i < p.aaData.length; i++) {
              if(p.aaData[i].VISIBLE == 1){
                if(p.aaData[i].ENABLE == 1){
                  $("#accionesConfigIncidencias").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
                }
                else{
                  $("#accionesConfigIncidencias").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button disabled class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
                }
              }
            }
          }
        }
      });

      setTimeout(function(){
        var js = document.createElement('script');
        js.src = 'view/js/funciones.js?idLoad=205';
        document.getElementsByTagName('head')[0].appendChild(js);
      },500);
    }
  });
}

$("#selectIncidenciaServicio").unbind("click").change(async function(e){
  var servicio = $("#selectIncidenciaServicio").val();
  var jsonChild = estructuraOperacion[servicio].values;
  var cuerpo = '';
  Object.keys(jsonChild).forEach((key) => {
    cuerpo += '<option id="' + key + '" value="' + key + '">' + jsonChild[key].title + '</option>';
  });
  $("#selectIncidenciaCliente").html(cuerpo);
  var cuerpo = '';
  var keyChild = Object.keys(jsonChild)[0];
  var jsonChild = jsonChild[keyChild].values;
  Object.keys(jsonChild).forEach((key) => {
    cuerpo += '<option id="' + key + '" value="' + key + '">' + jsonChild[key].title + '</option>';
  });
  $("#selectIncidenciaActividad").html(cuerpo);
});

$("#selectIncidenciaCliente").unbind("click").change(async function(e){
  var servicio = $("#selectIncidenciaServicio").val();
  var cliente = $("#selectIncidenciaCliente").val();
  var jsonChild = estructuraOperacion[servicio].values[cliente].values;
  var cuerpo = '';
  Object.keys(jsonChild).forEach((key) => {
    cuerpo += '<option id="' + key + '" value="' + key + '">' + jsonChild[key].title + '</option>';
  });
  $("#selectIncidenciaActividad").html(cuerpo);
});

$("#selectTiposAreas").unbind("click").change(async function(e){
  var area = $("#selectTiposAreas").val();
  var jsonChild = estructuraIncidencia[area].values;
  var cuerpo = '';
  Object.keys(jsonChild).forEach((key) => {
    cuerpo += '<option id="' + key + '" value="' + key + '">' + jsonChild[key].title + '</option>';
  });
  $("#selectIncidenciaItem").html(cuerpo);

  var cuerpo = '';
  var keyChild = Object.keys(jsonChild)[0];
  var jsonChild = jsonChild[keyChild].values;
  Object.keys(jsonChild).forEach((key) => {
    cuerpo += '<option id="' + key + '" value="' + key + '">' + jsonChild[key].title + '</option>';
  });
  $("#selectIncidenciaElemento").html(cuerpo);

  var cuerpo = '';
  var keyChild = Object.keys(jsonChild)[0];
  var jsonChild = jsonChild[keyChild].values;
  Object.keys(jsonChild).forEach((key) => {
    cuerpo += '<option id="' + key + '" value="' + key + '">' + jsonChild[key].title + '</option>';
  });
  $("#selectIncidenciaAnomalia").html(cuerpo);

  var keyChild = Object.keys(jsonChild)[0];
  var inputChild = jsonChild[keyChild];
  $("#inputIncidenciaDepartamento").val(inputChild.depa.name);
  $("#inputIncidenciaAlerta").val(inputChild.alert.name);
});

$("#selectIncidenciaItem").unbind("click").change(async function(e){
  var area = $("#selectTiposAreas").val();
  var item = $("#selectIncidenciaItem").val();
  var jsonChild = estructuraIncidencia[area].values[item].values;
  var cuerpo = '';
  Object.keys(jsonChild).forEach((key) => {
    cuerpo += '<option id="' + key + '" value="' + key + '">' + jsonChild[key].title + '</option>';
  });
  $("#selectIncidenciaElemento").html(cuerpo);

  var cuerpo = '';
  var keyChild = Object.keys(jsonChild)[0];
  var jsonChild = jsonChild[keyChild].values;
  Object.keys(jsonChild).forEach((key) => {
    cuerpo += '<option id="' + key + '" value="' + key + '">' + jsonChild[key].title + '</option>';
  });
  $("#selectIncidenciaAnomalia").html(cuerpo);

  var keyChild = Object.keys(jsonChild)[0];
  var inputChild = jsonChild[keyChild];
  $("#inputIncidenciaDepartamento").val(inputChild.depa.name);
  $("#inputIncidenciaAlerta").val(inputChild.alert.name);
});

$("#selectIncidenciaElemento").unbind("click").change(async function(e){
  var area = $("#selectTiposAreas").val();
  var item = $("#selectIncidenciaItem").val();
  var elemento = $("#selectIncidenciaElemento").val();
  var jsonChild = estructuraIncidencia[area].values[item].values[elemento].values;
  var cuerpo = '';
  Object.keys(jsonChild).forEach((key) => {
    cuerpo += '<option id="' + key + '" value="' + key + '">' + jsonChild[key].title + '</option>';
  });
  $("#selectIncidenciaAnomalia").html(cuerpo);

  var keyChild = Object.keys(jsonChild)[0];
  var inputChild = jsonChild[keyChild];
  $("#inputIncidenciaDepartamento").val(inputChild.depa.name);
  $("#inputIncidenciaAlerta").val(inputChild.alert.name);
});

$("#selectIncidenciaAnomalia").unbind("click").change(async function(e){
  var area = $("#selectTiposAreas").val();
  var item = $("#selectIncidenciaItem").val();
  var elemento = $("#selectIncidenciaElemento").val();
  var anom = $("#selectIncidenciaAnomalia").val();

  var inputChild = estructuraIncidencia[area].values[item].values[elemento].values[anom];

  $("#inputIncidenciaDepartamento").val(inputChild.depa.name);
  $("#inputIncidenciaAlerta").val(inputChild.alert.name);
});

$("#selectTiposAreas").unbind("click").change(function(){
  /*$("#selectIncidenciaItem").val($("#selectTiposAreas").val());
  $("#selectIncidenciaElemento").val($("#selectTiposAreas").val());
  $("#selectIncidenciaElemento").val($("#selectTiposAreas").val());*/
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectIncidenciaItem").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectIncidenciaElemento").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectIncidenciaAnomalia").select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#selectIncidenciaItem").unbind("click").change(function(){
  /*$("#selectIncidenciaItem").val($("#selectTiposAreas").val());
  $("#selectIncidenciaElemento").val($("#selectTiposAreas").val());
  $("#selectIncidenciaElemento").val($("#selectTiposAreas").val());*/
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectIncidenciaElemento").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectIncidenciaAnomalia").select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#selectIncidenciaElemento").unbind("click").change(function(){
  /*$("#selectIncidenciaItem").val($("#selectTiposAreas").val());
  $("#selectIncidenciaElemento").val($("#selectTiposAreas").val());
  $("#selectIncidenciaElemento").val($("#selectTiposAreas").val());*/
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectIncidenciaAnomalia").select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#selectIncidenciaServicio").unbind("click").change(function(){
  /*$("#selectIncidenciaItem").val($("#selectTiposAreas").val());
  $("#selectIncidenciaElemento").val($("#selectTiposAreas").val());
  $("#selectIncidenciaElemento").val($("#selectTiposAreas").val());*/
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectIncidenciaCliente").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectIncidenciaActividad").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#selectIncidenciaCliente").unbind("click").change(function(){
  /*$("#selectIncidenciaItem").val($("#selectTiposAreas").val());
  $("#selectIncidenciaElemento").val($("#selectTiposAreas").val());
  $("#selectIncidenciaElemento").val($("#selectTiposAreas").val());*/
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectIncidenciaActividad").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#fotoIncidencia" ).on('change', function(e){
  var file = e.target.files[0].name;
  // var id = $(this).attr("id").split("Inciden")[1];
  // $("#value" + id).val(file);
  $("#valueFotoIncidencia").val(file);
});

$("#enviarIncidencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#errorIncidencia").css("display", "none");

  var area = $("#selectTiposAreas").val();
  var item = $("#selectIncidenciaItem").val();
  var elemento = $("#selectIncidenciaElemento").val();
  var anom = $("#selectIncidenciaAnomalia").val();

  var incidenciaSelected = estructuraIncidencia[area].values[item].values[elemento].values[anom].struct;

  var servicio = $("#selectIncidenciaServicio").val();
  var cliente = $("#selectIncidenciaCliente").val();
  var actividad = $("#selectIncidenciaActividad").val();

  var operacionSelected = estructuraOperacion[servicio].values[cliente].values[actividad].struct;

  var personalSelected = lstIncidenciaPersonal.find(({ value }) => value === $('#selectIncidenciaPersonal').val());
  var patenteSelected = lstIncidenciaPatente.find(({ value }) => value === $('#selectIncidenciaPatente').val());
  await $.ajax({
    url:   'controller/ingresarIncidencia.php',
    type:  'post',
    data: {
      idIncidencia: incidenciaSelected,
      idOperacion: operacionSelected,
      idSucursal: $("#selectIncidenciaSucursal").val(),
      idPersonal: personalSelected?.id,
      idPatente: patenteSelected?.id,
      observaciones: $("#notaIncidencia").val()
    },
    success: async function (response) {
      var p = jQuery.parseJSON(response);

      await cargarIncidencia();

      var inp = Object.values($("#fotoIncidencia"))[0];
      var [ file ] = inp.files;
      var formdata = new FormData();
      formdata.append('idIncidencia', p[0]['@idResultado']);
      formdata.append('url', window.location.toString().split("?")[0]);
      formdata.append('file', file);
      $.ajax({
        url: "controller/ingresarIncidenciaEvidencia.php",
        type: 'POST',
        data: formdata,
        cache: false,
        contentType: false,
        processData: false,
        success: function (res3) {

        }
      });

      $('#valueFotoIncidencia').val('');
      $("#selectTiposAreas").prop('selectedIndex', 0);
      $("#selectIncidenciaServicio").prop('selectedIndex', 0);
      $("#selectIncidenciaSucursal").prop('selectedIndex', 0);
      $("#selectIncidenciaPersonal").val("");
      $("#selectIncidenciaPatente").val("");
      $("#notaIncidencia").val("");
    }
  });

  setTimeout(function(){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Incidencia generada correctamente");
    $('#modalAlertasSplash').modal('hide');
  },500);
});

async function ingresarIncidenciaFoto (idIncidenciaResultado) {
  var inputs = Object.values($("input[id*='fotoIncidencia']" ));
  $.ajax({
    url: "controller/ingresaIncidenciaEvidencia.php",
    type: 'POST',
    data: formdata,
    cache: false,
    contentType: false,
    processData: false,
    success: function (res3) {
      y++;
    }
  });
}

$("#enviarIncidenciaConfiguracion").unbind("click").click(async function(){
  setTimeout(function(){
    $("#modalNuevaConfiguracion").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
  }, 100);

  var tableSinConfiguracion = $('#tablaIncidenciaSinConfiguracion').DataTable();
  var datos = tableSinConfiguracion.rows('.selected').data();
  var idIncidenciaEstructura = $("#selectIncidenciaEstructura").val();
  var idsIncidenciaZona = $("#selectIncidenciaZona").val();
  var idsIncidenciaOperacion = $("#selectIncidenciaOperacion").val();
  var RutIncidenciaUsuario = $("#selectIncidenciaUsuario").val();
  var idIncidenciaSLATipo = $("#selectIncidenciaSLATipo").val();
  var idIncidenciaSLAQuantity = $("#selectIncidenciaSLAQuantity").val();

  setTimeout(async function(){
    var idsArea = [];
    var idsItem = [];
    var idsDepartamento = [];
    var idsOperacion = [];
    var idsSucursal = [];
    for (var i = 0; i < datos.length; i++) {
      idsArea.push(datos[i].IDAREA);
      idsItem.push(datos[i].IDINCIDENCIA_ITEM);
      idsDepartamento.push(datos[i].IDINCIDENCIA_DEPARTAMENTO);
      idsOperacion.push(datos[i].IDESTRUCTURA_OPERACION);
      idsSucursal.push(datos[i].IDSUCURSAL);
    }

    await $.ajax({
      url:   'controller/ingresarIncidenciaConfiguracion.php',
      type:  'post',
      data: {
        idsArea: idsArea,
        idsItem: idsItem,
        idsDepartamento: idsDepartamento,
        idsOperacion: idsOperacion,
        idsSucursal: idsSucursal,
        rutUsuario: RutIncidenciaUsuario,
        slaType: idIncidenciaSLATipo,
        slaQ: parseInt(idIncidenciaSLAQuantity),
      },
      success: async function (response) {
        var p = jQuery.parseJSON(response);
        tableSinConfiguracion.rows('.selected').remove().draw();
        await ingresaNuevaConfiguracion(p);
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Configuración ingresada correctamente");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    });
  },500);
});

function ingresaNuevaConfiguracion(p){
  var table2 = $('#tablaIncidenciaSinConfiguracion').DataTable();
  for(var k = 0; k < p.aaData.length; k++){
    table2.rows.add([{
      'S': p.aaData[k].S,
      'AREA': p.aaData[k].AREA,
      'ITEM': p.aaData[k].ITEM,
      'DEPARTAMENTO': p.aaData[k].DEPARTAMENTO,
      'SERVICIO': p.aaData[k].SERVICIO,
      'CLIENTE': p.aaData[k].CLIENTE,
      'ACTIVIDAD': p.aaData[k].ACTIVIDAD,
      'SUCURSAL': p.aaData[k].SUCURSAL,
      'COMUNA': p.aaData[k].COMUNA,
      'SLA': p.aaData[k].SLA,
      'DNI_RESOLUTOR': p.aaData[k].DNI_RESOLUTOR,
      'NOMBRE_RESOLUTOR': p.aaData[k].NOMBRE_RESOLUTOR
    }]).draw();
  }
  $("#nuevaConfiguracion").attr("disabled","disabled");
  $("#eliminarConfiguracion").attr("disabled","disabled");
  $('#modalAlertasSplash').modal('hide');
}

$("#periodoTablaIncidencias").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  e.preventDefault();
  e.stopImmediatePropagation();

  var pFecha = $('#periodoTablaIncidencias').val()
  var [ fecIni, fecEnd ] = formatoRangoFecha(`${pFecha}-01`);

  setTimeout(async function(){
    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
    await $('#tablaIncidencia').DataTable({
      ajax: {
        url: "controller/datosIncidencias.php",
        type: 'POST',
        data: {
          fecIni: fecIni,
          fecEnd: fecEnd
        }
      },
      columns: [
        { data: 'S'},
        { data: 'IDINCIDENCIA_RESULTADO', className: "centerDataTable"},
        { data: 'ESTADO' },
        { data: 'FECHA' },
        { data: 'HORA' },
        { data: 'SLA' },
        { data: 'DIFF' },
        { data: 'AREA', className: "centerDataTable"},
        { data: 'ITEM'},
        { data: 'ELEME'},
        { data: 'ANOMA'},
        { data: 'DEPAR'},
        { data: 'ALERT'},
        { data: 'PRIORIDAD', className: "centerDataTable"},
        { data: 'SERV'},
        { data: 'CLIE' },
        { data: 'ACT' },
        { data: 'RUT_AUDITOR' },
        { data: 'RESOLUTOR' },
        { data: 'FILE', className: 'centerDataTable' }
      ],
      buttons: [
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        }
      ],
      "select": {
        style: 'multi',
        selector: 'td:not(:nth-child(20))'
      },
      fixedColumns:   {
        leftColumns: 2
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "order": [[ 1, "desc" ]],
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json) {
        var table = $('#tablaIncidencia').DataTable();

        var estadoInc = '';
        estadoInc += '<option selected value="Todos">Todos</option>';
        for(var i = 0; i < table.column(2).data().unique().length; i++){
          if(table.column(2).data().unique()[i] !== null){
            estadoInc += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
          }
        }
        $("#estadoTablaIncidencias").html(estadoInc);

        $('#contenido').show();
        $('#menu-lateral').show();
        $('#footer').parent().show();
$('#footer').show();

        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#estadoTablaIncidencias").select2('destroy').select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
        menuElegant();
        $('#tablaIncidencia').DataTable().on("draw", function(){
          $('#modalAlertasSplash').modal('hide');
          setTimeout(function(){
            $('#tablaIncidencia').DataTable().columns.adjust();
          },500);
        });
      }
    });
  },1500);
});

$("#estadoTablaIncidencias").unbind("click").change(function(){
  var table = $("#tablaIncidencia").DataTable();
  var item = $("#estadoTablaIncidencias").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('2').search(item).draw();
});

$("#cambiarEstadoIncidencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#comentarioIncidenciaEstados").val('');

  await $.ajax({
    url:   'controller/datosIncidenciaEstados.php',
    type:  'post',
    success: function (data) {
      var jf = jQuery.parseJSON(data);
      if(jf.aaData.length !== 0){
        var cuerpoJF = '';
        $("#selectIncidenciaEstados").html('');
        for(var i = 0; i < jf.aaData.length; i++) {
          if (jf.aaData[i].ESTADO==='Resuelta' || jf.aaData[i].ESTADO==='Rechazada') {
            cuerpoJF += '<option value="' + jf.aaData[i].IDINCIDENCIA_ESTADO + '">' + jf.aaData[i].ESTADO + '</option>';
          }
        }
        $("#selectIncidenciaEstados").html(cuerpoJF);
        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#selectIncidenciaEstados").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
      }
    }
  });

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#modalCambiarIncidenciaEstado").modal("show");
    $("#modalCambiarIncidenciaEstado").css("z-index", "1050");
    $('#modalAlertasSplash').modal('hide');
  }, 500);
});

$("#guardarCambiarEstadoIncidencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalCambiarIncidenciaEstado").modal("hide");
  var table = $('#tablaIncidencia').DataTable();
  var datos = table.rows('.selected').data();
  var idIncidencia = datos[0].IDINCIDENCIA_RESULTADO;
  var idEstado = $("#selectIncidenciaEstados").val();

  await $.ajax({
    url:   'controller/actualizarIncidenciaEstado.php',
    type:  'post',
    data: {
      idIncidencia: idIncidencia,
      idEstado: idEstado,
      idUsuarioDerivado: '',
      observaciones: $('#comentarioIncidenciaEstados').val(),
    },
    success: function (response) {
      setTimeout(function() {
        var p = jQuery.parseJSON(response);
        ingresarIncidenciaActualizada(p);
      }, 500);
    }
  });
});

function ingresarIncidenciaActualizada(p) {
  var table = $('#tablaIncidencia').DataTable();
  table.rows('.selected').remove().draw();

  table.rows.add([{
    'S': p.aaData[0].S,
    'IDINCIDENCIA_RESULTADO': p.aaData[0].IDINCIDENCIA_RESULTADO,
    'ESTADO': p.aaData[0].ESTADO,
    'FECHA': p.aaData[0].FECHA,
    'HORA': p.aaData[0].HORA,
    'SLA': p.aaData[0].SLA,
    'DIFF': p.aaData[0].DIFF,
    'AREA': p.aaData[0].AREA,
    'ITEM': p.aaData[0].ITEM,
    'ELEME': p.aaData[0].ELEME,
    'ANOMA': p.aaData[0].ANOMA,
    'DEPAR': p.aaData[0].DEPAR,
    'ALERT': p.aaData[0].ALERT,
    'PRIORIDAD': p.aaData[0].PRIORIDAD,
    'SERV': p.aaData[0].SERV,
    'CLIE': p.aaData[0].CLIE,
    'ACT': p.aaData[0].ACT,
    'RUT_AUDITOR': p.aaData[0].RUT_AUDITOR,
    'RESOLUTOR': p.aaData[0].RESOLUTOR,
    'FILE': p.aaData[0].FILE
  }]).draw();
  var random = Math.round(Math.random() * (1000000 - 1) + 1);
  setTimeout(function(){
    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Incidencia actualizada correctamente");
    $('#modalAlertasSplash').modal('hide');
  },500);
  $("#cambiarEstadoIncidencia").attr("disabled", "disabled");
  $("#derivarIncidencia").attr("disabled", "disabled");
  $("#confirmarIncidencia").attr("disabled", "disabled");
  $("#reactivarIncidencia").attr("disabled", "disabled");
  $("#historialIncidencia").attr("disabled", "disabled");
  table.rows().deselect();
}

$("#confirmarIncidencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#comentarioIncidenciaConfirmar").val('');

  await $.ajax({
    url:   'controller/datosIncidenciaEstados.php',
    type:  'post',
    success: function (data) {
      var jf = jQuery.parseJSON(data);
      if(jf.aaData.length !== 0){
        var cuerpoJF = '';
        $("#selectIncidenciaEstados2").html('');
        for(var i = 0; i < jf.aaData.length; i++) {
          if (jf.aaData[i].ESTADO==='Confirmada' || jf.aaData[i].ESTADO==='No confirmada') {
            cuerpoJF += '<option value="' + jf.aaData[i].IDINCIDENCIA_ESTADO + '">' + jf.aaData[i].ESTADO + '</option>';
          }
        }
        $("#selectIncidenciaEstados2").html(cuerpoJF);
        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#selectIncidenciaEstados2").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
      }
    }
  });

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#modalConfirmarIncidenciaEstado").modal("show");
    $("#modalConfirmarIncidenciaEstado").css("z-index", "1050");
    $('#modalAlertasSplash').modal('hide');
  }, 500);
});

$("#guardarConfirmarEstadoIncidencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalConfirmarIncidenciaEstado").modal("hide");

  var table = $('#tablaIncidencia').DataTable();
  var datos = table.rows('.selected').data();
  var idIncidencia = datos[0].IDINCIDENCIA_RESULTADO;
  var idEstado = $("#selectIncidenciaEstados2").val();

  await $.ajax({
    url:   'controller/actualizarIncidenciaEstado.php',
    type:  'post',
    data: {
      idIncidencia: idIncidencia,
      idEstado: idEstado,
      idUsuarioDerivado: '',
      observaciones: $('#comentarioIncidenciaConfirmar').val(),
    },
    success: function (response) {
      setTimeout(function() {
        var p = jQuery.parseJSON(response);
        ingresarIncidenciaActualizada(p);
      }, 500);
    }
  });
});

$("#reactivarIncidencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#comentarioIncidenciaReactivar").val('');

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#modalReactivarIncidenciaEstado").modal("show");
    $("#modalReactivarIncidenciaEstado").css("z-index", "1050");
    $('#modalAlertasSplash').modal('hide');
  }, 500);
});

$("#guardarReactivarEstadoIncidencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#modalReactivarIncidenciaEstado").modal("hide");

  await $.ajax({
    url:   'controller/datosIncidenciaEstados.php',
    type:  'post',
    success: async function (data) {
      var jf = jQuery.parseJSON(data);
      if(jf.aaData.length !== 0){
        var idEstadoReactivar = 0;
        for (var i=0; i < jf.aaData.length; i++) {
          idEstadoReactivar = jf.aaData[i].ESTADO === 'Generada' ? jf.aaData[i].IDINCIDENCIA_ESTADO : idEstadoReactivar;
        }

        var table = $('#tablaIncidencia').DataTable();
        var datos = table.rows('.selected').data();
        var idIncidencia = datos[0].IDINCIDENCIA_RESULTADO;
        var idEstado = idEstadoReactivar;

        await $.ajax({
          url:   'controller/actualizarIncidenciaEstado.php',
          type:  'post',
          data: {
            idIncidencia: idIncidencia,
            idEstado: idEstado,
            idUsuarioDerivado: '',
            observaciones: $('#comentarioIncidenciaReactivar').val(),
          },
          success: function (response) {
            setTimeout(function() {
              var p = jQuery.parseJSON(response);
              ingresarIncidenciaActualizada(p);
            }, 500);
          }
        });
      }
    }
  });
});

$("#derivarIncidencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#comentarioIncidenciaDerivar").val('');

  await $.ajax({
    url:   'controller/datosJefes.php',
    type:  'get',
    success: function (jefes) {
      var jf = jQuery.parseJSON(jefes);
      if(jf.aaData.length !== 0){
        var cuerpoJF = '';
        for(var i = 0; i < jf.aaData.length; i++) {
          cuerpoJF += '<option value="' + jf.aaData[i].IDUSUARIO + '">' + jf.aaData[i].RUTJEFEDIRECTO + ' - ' + jf.aaData[i].JEFE + '</option>';
        }
        $("#selectUsuarios").html(cuerpoJF);
        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#selectUsuarios").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
      }
    }
  });

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#modalDerivarIncidenciaEstado").modal("show");
    $("#modalDerivarIncidenciaEstado").css("z-index", "1050");
    $('#modalAlertasSplash').modal('hide');
  }, 500);
});

$("#guardarDerivarEstadoIncidencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#modalDerivarIncidenciaEstado").modal("hide");

  var table = $('#tablaIncidencia').DataTable();
  var datos = table.rows('.selected').data();
  var idIncidencia = datos[0].IDINCIDENCIA_RESULTADO;
  var idUsuarioDerivado = $("#selectUsuarios").val();

  await $.ajax({
    url:   'controller/actualizarIncidenciaEstado.php',
    type:  'post',
    data: {
      idIncidencia: idIncidencia,
      idEstado: '',
      idUsuarioDerivado: idUsuarioDerivado,
      observaciones: $('#comentarioIncidenciaDerivar').val(),
    },
    success: function (response) {
      setTimeout(function() {
        var p = jQuery.parseJSON(response);
        ingresarIncidenciaActualizada(p);
      }, 500);
    }
  });
});

$("#historialIncidencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $('#tablaIncidencia').DataTable();
  var datos = table.rows('.selected').data();
  var idIncidencia = datos[0].IDINCIDENCIA_RESULTADO;
  var area = datos[0].AREA;
  var item = datos[0].ITEM;
  var elemento = datos[0].ELEME;
  var anomalia = datos[0].ANOMA;
  var estado = datos[0].ESTADO;

  $("#tituloHistorialIncidencia").html('');

  $("#tituloHistorialIncidencia").html('Folio: ' + idIncidencia + '<br>Elemento: ' + elemento + '<br>Anomalia: ' + anomalia + '<br>Estado: ' + estado);

  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  await $('#tablaHistorialIncidencia').DataTable( {
    ajax: {
        url: "controller/datosIncidenciaHistorial.php",
        type: 'POST',
        data: {
          idIncidenciaResultado: idIncidencia,
        },
    },
    columns: [
        { data: 'S'},
        { data: 'IDINCIDENCIA_HISTORIAL' },
        { data: 'ESTADO'},
        { data: 'AREA' },
        { data: 'ITEM' },
        { data: 'ELEME' },
        { data: 'ANOMA' },
        { data: 'DEPAR' },
        { data: 'ALERT' },
        { data: 'PRIORIDAD' },
        { data: 'SERV' },
        { data: 'CLIE' },
        { data: 'ACT' },
        { data: 'RUT_AUDITOR' },
        { data: 'RESOLUTOR' },
        { data: 'FECHA' },
        { data: 'HORA' },
        { data: 'EJECUTOR' },
        { data: 'OBSERVACIONES' },
    ],
    buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1, 2, 11, 4, 5, 6, 7 ,8, 9, 10 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 11 ]
      }
    ],
    "select": {
        style: 'single'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "order": [[ 1, "desc" ]],
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      setTimeout(function(){
        var h = $(window).height() - 350;
        $("#bodyHistorialIncidencia").css("height",h);
        $("#modalHistorialIncidencia").modal("show");
        $("#modalHistorialIncidencia").css("z-index", "1050");
        $('#modalAlertasSplash').modal('hide');
        setTimeout(async function(){
          $('#tablaHistorialIncidencia').DataTable().columns.adjust();
        },500);
      }, 1000);
    }
  });
});

async function graficaInformeFalla(){
  $("#espacioCelHor").remove();
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    var largo = Math.trunc($(window).height() - 200);
  }
  else{
    var largo = 0;
    if($(window).width() > $(window).height()){
      $("#padreGrafico").append('<div id="espacioCelHor" style="text-align: right;" class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12">&nbsp;<br></div>')
      var largo = Math.trunc($(window).height());
    }
    else{
      var largo = Math.trunc($(window).height() - 300);
    }
  }
  var path = window.location.href.split('#/')[1];

  var au = $("#auditoriaInformeFallas").val();

  var strVal = '';
  for(var i = 0; i < au.length; i++){
    if(i == au.length - 1){
        strVal +=  au[i];
    }
    else{
        strVal += au[i] + ",";
    }
  }

  var parametros = {
    'mes': $("#periodoInformeFallas").val().split('-')[1],
    'ano': $("#periodoInformeFallas").val().split('-')[0],
    'path': path,
    "val": strVal,
    "rutJefe": "0"
  }

  await $.ajax({
    url:   'controller/datosProblemasPracticasJefes.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPeriodo = '';
        var cuerpoPeriodo = '<option selected value="0">Todos</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoPeriodo += '<option value="' + p2.aaData[i].DNI + '">' + p2.aaData[i].NOMBRE + '</option>';
        }
        $("#jefaturaInformeFallas").html(cuerpoPeriodo);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#jefaturaInformeFallas").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawChartInformeFalla);

  async function drawChartInformeFalla() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Falla');
    data.addColumn('number', 'Cantidad');

    await $.ajax({
      url:   'controller/datosProblemasPracticas.php',
      type:  'post',
      data: parametros,
      success: function (response) {
        var p = jQuery.parseJSON(response);
        if(p.length !== 0) {
          var max = 0;

          for(var i = 0; i < p.length; i++){
            data.addRow([p[i].FAMILIA + ' - ' + p[i].CATEGORIA, parseInt(p[i].CANTIDAD)]);
            if(parseInt(p[i].CANTIDAD) > max){
              max = p[i].CANTIDAD;
            }
          }

          var options = {
            title: '',
            // curveType: 'function',
            legend: {
              position: "top"
            },
            isStacked: false,
            annotations: {
                 textStyle: {
                     color: 'black',
                     fontSize: 11,
                 },
                 alwaysOutside: true
            },
            hAxis : {
                textStyle : {
                    fontSize: 12 // or the number you want
                },
                slantedText:true,
                slantedTextAngle:90
            },
            vAxis : {
                textStyle : {
                    fontSize: 12 // or the number you want
                },
                viewWindow: {
                    min: 0,
                }
            },
            chartArea: {
              'width': '100%',
              'height': '100%',
              'top': '50',
              'bottom': '5',
              'right': '15',
              'left': '40'
            }
          };

          var chart = new google.visualization.ColumnChart(document.getElementById('graficoInformeFallas'));

          chart.draw(data, options);

          $("#tablaInformeFallas").remove();
          $("#tablaInformeFallasPadre").append('<div id="tablaInformeFallas"></div>');

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {

          }
          else{
            $("#tablaInformeFallas").css("margin-top","20px");
          }

          FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];

          var grid = new FancyGrid({
              renderTo: 'tablaInformeFallas',
              scrollable: true,
              selModel: {
                type: 'rows'
              },
              theme: 'blue',
              height: largo,
              data: p,
              trackOver: true,
              defaults: {
                // resizable: true,
                sortable: true,
                align: 'left',
                cellAlign: 'left'
              },
              cellHeight: 45,
              columns: [
                {
                  type: 'tree',
                  title: 'Familia',
                  index: 'FAMILIA',
                  flex: 5,
                },
                {
                  title: 'Categoria',
                  index: 'CATEGORIA',
                  flex: 5,
                },
                {
                  type: 'number',
                  title: '# Fallas',
                  index: 'CANTIDAD',
                  flex: 1,
                  align: 'center',
                  cellAlign: 'center',
                },
                {
                  type: 'string',
                  title: 'Detalle TAC',
                  index: 'BOTON',
                  align: 'center',
                  cellAlign: 'center',
                  flex: 1,
                }
              ],
              events: [
                {
                  cellclick: function(grid, o){
                    if(o.columnIndex == 3 && !o.data.FAMILIA.includes('-')){
                      detallePracticasFallasPersonas(o.data.FAMILIA, o.data.CATEGORIA);
                    }
                  }
                }
              ],
              exporter: true,
              tbar: [
                {
                  type: 'search',
                  width: 590,
                  emptyText: 'Buscar'
                },
                {
                  text: 'Excel',
                  handler: function() {
                    this.expandAll();
                    this.exportToExcel();
                    this.collapseAll();
                  }
                },
                {
                  text: 'Expandir Todo',
                  handler: function() {
                    this.expandAll();
                  }
                },
                {
                  text: 'Colapsar Todo',
                  handler: function() {
                    this.collapseAll();
                  }
                }
              ]
          })

          setTimeout(function(){
            $("a[href|='http://www.fancygrid.com']").parent().remove();
          },2000);
        }
        else{
          var options = {
            title: '',
            // curveType: 'function',
            legend: {
              position: "top"
            },
            isStacked: false,
            annotations: {
                 textStyle: {
                     color: 'black',
                     fontSize: 11,
                 },
                 alwaysOutside: true
            },
            hAxis : {
                textStyle : {
                    fontSize: 12 // or the number you want
                },
                slantedText:true,
                slantedTextAngle:90
            },
            vAxis : {
                textStyle : {
                    fontSize: 12 // or the number you want
                },
                viewWindow: {
                    min: 0,
                }
            },
            chartArea: {
              'width': '100%',
              'height': '100%',
              'top': '50',
              'bottom': '5',
              'right': '15',
              'left': '40'
            }
          };

          var chart = new google.visualization.ColumnChart(document.getElementById('graficoInformeFallas'));

          chart.draw(data, options);

          $("#tablaInformeFallas").remove();
          $("#tablaInformeFallasPadre").append('<div id="tablaInformeFallas"></div>');

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {

          }
          else{
            $("#tablaInformeFallas").css("margin-top","20px");
          }

          FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];

          new FancyGrid({
              renderTo: 'tablaInformeFallas',
              scrollable: true,
              selModel: {
                type: 'rows'
              },
              theme: 'blue',
              height: largo,
              data: p,
              trackOver: true,
              defaults: {
                // resizable: true,
                sortable: true,
                align: 'left',
                cellAlign: 'left'
              },
              cellHeight: 45,
              columns: [
                {
                  type: 'tree',
                  title: 'Familia',
                  index: 'FAMILIA',
                  flex: 5,
                },
                {
                  title: 'Categoria',
                  index: 'CATEGORIA',
                  flex: 5,
                },
                {
                  type: 'number',
                  title: '# Fallas',
                  index: 'CANTIDAD',
                  flex: 1,
                  align: 'center',
                  cellAlign: 'center',
                },
                {
                  type: 'string',
                  title: 'Detalle TAC',
                  index: 'BOTON',
                  align: 'center',
                  cellAlign: 'center',
                  flex: 1,
                }
              ],
              events: [{
                cellclick: function(grid, o){
                  if(o.columnIndex == 3 && !o.data.FAMILIA.includes('-')){
                    detallePracticasFallasPersonas(o.data.FAMILIA, o.data.CATEGORIA);
                  }
                }
              }],
              tbar: [
                {
                  type: 'search',
                  width: 200,
                  emptyText: 'Buscar'
                }
              ]
          })

          setTimeout(function(){
            $("a[href|='http://www.fancygrid.com']").parent().remove();
          },2000);
        }
        setTimeout(function(){
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },2000);
          menuElegant();
        },6000);
      }
    });
  }
}

$("#filtrarInformeFallas").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await graficaInformeFalla();
});

async function detallePracticasFallasPersonas(familia, categoria){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var largo = Math.trunc($(window).height() - 300);
  var path = window.location.href.split('#/')[1];

  var parametros = {
    'mes': $("#periodoInformeFallas").val().split('-')[1],
    'ano': $("#periodoInformeFallas").val().split('-')[0],
    'path': path,
    "familia": familia,
    "categoria": categoria,
    "rutJefe": $("#jefaturaInformeFallas").val()
  }

  $("#tituloFallasPracticasPersonas").html('&squf;&nbsp;&nbsp;' + familia + '<br>&squf;&nbsp;&nbsp;' + categoria);

  $("#tablaFallasPracticasPersonas").remove();
  $("#tablaFallasPracticasPersonasPadre").append('<div id="tablaFallasPracticasPersonas"></div>');

  await $.ajax({
    url:   'controller/datosProblemasPracticasPersonas.php',
    type:  'post',
    data: parametros,
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.length !== 0) {
        FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];

        new FancyGrid({
            renderTo: 'tablaFallasPracticasPersonas',
            scrollable: true,
            selModel: {
              type: 'rows'
            },
            theme: 'blue',
            height: largo,
            data: p,
            trackOver: true,
            defaults: {
              // resizable: true,
              sortable: true,
              align: 'left',
              cellAlign: 'left'
            },
            exporter: true,
            tbar: [
              {
                text: 'Excel',
                handler: function() {
                  this.exportToExcel();
                }
              }
            ],
            cellHeight: 45,
            columns: [
              {
                type: 'tree',
                title: 'DNI',
                index: 'RUTPERSONAL',
                flex: 3,
              },
              {
                title: 'Nombre',
                index: 'NOMBREPERSONAL',
                flex: 5,
              },
              {
                title: 'Familia',
                index: 'FAMILIA',
                flex: 5,
              },
              {
                type: 'number',
                title: '# Fallas',
                index: 'CANTIDAD',
                flex: 1,
                align: 'center',
                cellAlign: 'center',
              }
            ],
            tbar: [
              {
                type: 'search',
                width: 200,
                emptyText: 'Buscar'
              }
            ]
          })

          $("#modalFallasPracticasPersonas").modal("show");

          setTimeout(function(){
            $("a[href|='http://www.fancygrid.com']").parent().remove();
            $('#modalAlertasSplash').modal('hide');
          },1000);
      }
    }
  });
}

$("#cerrarFallasPracticasPersonas").unbind("click").click(function(){
  $("#tablaFallasPracticasPersonas").remove();
});

$("#editarJefatura").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#rutEditaPersonalOperaciones").removeClass("is-invalid");
  $("#nombresEditaPersonalOperacionestPersonalOperaciones").removeClass("is-invalid");
  $("#apellidosEditaPersonalOperaciones").removeClass("is-invalid");
  var table = $('#tablaJefatura').DataTable();
  var rut = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI;
  });
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE;
  });
  var externo = $.map(table.rows('.selected').data(), function (item) {
      return item.EXTERNO;
  });
  var empresa = $.map(table.rows('.selected').data(), function (item) {
      return item.IDEMPRESA;
  });
  var idCeco = $.map(table.rows('.selected').data(), function (item) {
      return item.IDESTRUCTURA_OPERACION;
  });
  var nombres = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRES;
  });
  var apellidos = $.map(table.rows('.selected').data(), function (item) {
      return item.APELLIDOS;
  });
  var cargo = $.map(table.rows('.selected').data(), function (item) {
      return item.CARGO;
  });
  var email = $.map(table.rows('.selected').data(), function (item) {
      return item.EMAIL;
  });
  var telefono = $.map(table.rows('.selected').data(), function (item) {
      return item.TELEFONO;
  });
  var nomen = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMENCLATURA;
  });
  var sucursal = $.map(table.rows('.selected').data(), function (item) {
      return item.SUCURSAL;
  });
  var nivel = $.map(table.rows('.selected').data(), function (item) {
      return item.NIVEL;
  });
  var mano = $.map(table.rows('.selected').data(), function (item) {
      return item.CLASIFICACION;
  });
  var parametros = {
    "rut": rut[0]
  }

  $("#rutEditaPersonalOperaciones").val(rut[0]);
  $("#nombresEditaPersonalOperaciones").val(nombres[0]);
  $("#apellidosEditaPersonalOperaciones").val(apellidos[0]);
  $("#funcionEditaPersonalOperaciones").val(cargo[0]);
  $("#emailEditaPersonalOperaciones").val(email[0]);
  $("#fonoEditaPersonalOperaciones").val(telefono[0]);
  $("#moEditaPersonalOperaciones").val(mano[0]);

  await $.ajax({
    url:   'controller/datosNivelFuncional.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoF = '';
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          if(nivel[0] === p2.aaData[i].NUMERO){
            cuerpoF += '<option selected value="' + p2.aaData[i].IDNIVELFUNCIONAL + '">(' + p2.aaData[i].NUMERO + ') ' + p2.aaData[i].NIVEL + '</option>';
          }
          else{
            cuerpoF += '<option value="' + p2.aaData[i].IDNIVELFUNCIONAL + '">(' + p2.aaData[i].NUMERO + ') ' + p2.aaData[i].NIVEL + '</option>';
          }
        }
        $("#nivelEditaPersonalOperaciones").html(cuerpoF);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosSucursal.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoS = '';
      cuerpoS += '<option selected value="-1">Sin asignar</option>';
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].SUCURSAL === sucursal[0]){
            cuerpoS += '<option selected value="' + p2.aaData[i].IDSUCURSAL + '">' + p2.aaData[i].COMUNA + ' - ' + p2.aaData[i].SUCURSAL + '</option>';
          }
          else{
            cuerpoS += '<option value="' + p2.aaData[i].IDSUCURSAL + '">' + p2.aaData[i].COMUNA + ' - ' + p2.aaData[i].SUCURSAL + '</option>';
          }
        }
        $("#sucursalEditaPersonalOperaciones").html(cuerpoS);
      }
      else{
        $("#sucursalEditaPersonalOperaciones").html(cuerpoS);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosPatentesAsignar.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoP = '';
      cuerpoP += '<option selected value="-1">Sin asignar</option>';
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].PATENTE === patente[0]){
            cuerpoP += '<option selected value="' + p2.aaData[i].IDPATENTE + '">' + p2.aaData[i].PATENTE + ' - ' + p2.aaData[i].ESTADO + '</option>';
          }
          else{
            cuerpoP += '<option value="' + p2.aaData[i].IDPATENTE + '">' + p2.aaData[i].PATENTE + ' - ' + p2.aaData[i].ESTADO + '</option>';
          }
        }
        $("#patenteEditaPersonalOperaciones").html(cuerpoP);
      }
      else{
        $("#patenteEditaPersonalOperaciones").html(cuerpoP);
      }
    }
  });
  if(externo[0] == 1){
    $("#esSubcontratistaEditaPersonalOperaciones").prop("checked",true);
    await $.ajax({
      url:   'controller/datosSubcontratistasVehiculo.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoE = '';
          for(var i = 0; i < p2.aaData.length; i++){
            if(p2.aaData[i].IDSUBCONTRATO == empresa[0]){
              cuerpoE += '<option selected value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
            else{
              cuerpoE += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
          }
          $("#empresaEditaPersonalOperaciones").html(cuerpoE);
        }
      }
    });
  }
  else{
    $("#esSubcontratistaEditaPersonalOperaciones").prop("checked",false);
    await $.ajax({
      url:   'controller/datosSubcontratistasVehiculoInterno.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoE = '';
          for(var i = 0; i < p2.aaData.length; i++){
            if(p2.aaData[i].IDSUBCONTRATO == empresa[0]){
              cuerpoE += '<option selected value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
            else{
              cuerpoE += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
            }
          }
          $("#empresaEditaPersonalOperaciones").html(cuerpoE);
        }
      }
    });
  }

  parametros = {
    'idEmpresa': empresa[0]
  }

  await $.ajax({
    url:   'controller/datosCecoEmpresa.php',
    type:  'post',
    data: parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCeco = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].IDESTRUCTURA_OPERACION == idCeco[0]){
            cuerpoCeco += '<option selected value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].NOMENCLATURA + ' | ' + p2.aaData[i].NOMBRE + ' | ' + p2.aaData[i].AREA + '</option>';
          }
          else{
            cuerpoCeco += '<option value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].NOMENCLATURA + ' | ' + p2.aaData[i].NOMBRE + ' | ' + p2.aaData[i].AREA + '</option>';
          }
        }
        $("#cecoEditaPersonalOperaciones").html(cuerpoCeco);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#cecoEditaPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#sucursalEditaPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#patenteEditaPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#empresaEditaPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#nivelEditaPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#moEditaPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyEditaPersonalOperaciones").css("height",h);
    $('#modalAlertasSplash').modal('hide');
    $("#modalEditaPersonalOperaciones").modal("show");
  },500);
});

$("#servicioEditaPersonalOperaciones").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEditaPersonalOperaciones").modal("hide");
  e.stopImmediatePropagation();
  e.preventDefault();
  var parametrosCliente = {
    "idcontratodepto": $("#servicioEditaPersonalOperaciones").val(),
    "idsubcontrato": $("#empresaEditaPersonalOperaciones").val()
  }
  await $.ajax({
    url:   'controller/datosCliente.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCl = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoCl += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + '</option>';
        }
        $("#clienteEditaPersonalOperaciones").html(cuerpoCl);
      }
    }
  })
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#clienteEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  parametrosCliente['idcliente'] = $("#clienteEditaPersonalOperaciones").val();
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadEditaPersonalOperaciones").html(cuerpoAC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#actividadEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  $('#modalAlertasSplash').modal('hide');
  $("#modalEditaPersonalOperaciones").modal("show");
});

$("#clienteEditaPersonalOperaciones").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEditaPersonalOperaciones").modal("hide");
  e.stopImmediatePropagation();
  e.preventDefault();
  var parametrosCliente = {
    "idcontratodepto": $("#servicioEditaPersonalOperaciones").val(),
    "idcliente": $("#clienteEditaPersonalOperaciones").val(),
    "idsubcontrato": $("#empresaEditaPersonalOperaciones").val()
  }
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadEditaPersonalOperaciones").html(cuerpoAC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#actividadEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#clienteEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  $('#modalAlertasSplash').modal('hide');
  $("#modalEditaPersonalOperaciones").modal("show");
});

$("#empresaEditaPersonalOperaciones").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEditaPersonalOperaciones").modal("hide");
  e.stopImmediatePropagation();
  e.preventDefault();
  var table = $('#tablaJefatura').DataTable();
  var rut = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI;
  });
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE;
  });
  var externo = $.map(table.rows('.selected').data(), function (item) {
      return item.EXTERNO;
  });
  var idCeco = $.map(table.rows('.selected').data(), function (item) {
      return item.IDESTRUCTURA_OPERACION;
  });
  var empresa = $.map(table.rows('.selected').data(), function (item) {
      return item.EMPRESA;
  });
  var nombres = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRES;
  });
  var apellidos = $.map(table.rows('.selected').data(), function (item) {
      return item.APELLIDOS;
  });
  var cargo = $.map(table.rows('.selected').data(), function (item) {
      return item.CARGO;
  });
  var email = $.map(table.rows('.selected').data(), function (item) {
      return item.EMAIL;
  });
  var telefono = $.map(table.rows('.selected').data(), function (item) {
      return item.TELEFONO;
  });
  var nomen = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMENCLATURA;
  });
  var sucursal = $.map(table.rows('.selected').data(), function (item) {
      return item.SUCURSAL;
  });
  var nivel = $.map(table.rows('.selected').data(), function (item) {
      return item.NIVEL;
  });
  var mano = $.map(table.rows('.selected').data(), function (item) {
      return item.CLASIFICACION;
  });

  var parametros = {
    "idEmpresa": $("#empresaEditaPersonalOperaciones").val()
  }
  await $.ajax({
    url:   'controller/datosCecoEmpresa.php',
    type:  'post',
    data: parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCeco = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].IDESTRUCTURA_OPERACION == idCeco[0]){
            cuerpoCeco += '<option selected value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].NOMENCLATURA + ' | ' + p2.aaData[i].NOMBRE + ' | ' + p2.aaData[i].AREA + '</option>';
          }
          else{
            cuerpoCeco += '<option value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].NOMENCLATURA + ' | ' + p2.aaData[i].NOMBRE + ' | ' + p2.aaData[i].AREA + '</option>';
          }
        }
        $("#cecoEditaPersonalOperaciones").html(cuerpoCeco);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#cecoEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#sucursalEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#patenteEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#empresaEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#clienteEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#actividadEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#nivelEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#moEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEditaPersonalOperaciones").modal("show");
  },500);
});

$("#esSubcontratistaEditaPersonalOperaciones").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEditaPersonalOperaciones").modal("hide");
  e.stopImmediatePropagation();
  e.preventDefault();

  var table = $('#tablaJefatura').DataTable();
  var rut = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI;
  });
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE;
  });
  var externo = $.map(table.rows('.selected').data(), function (item) {
      return item.EXTERNO;
  });
  var empresa = $.map(table.rows('.selected').data(), function (item) {
      return item.EMPRESA;
  });
  var nombres = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRES;
  });
  var apellidos = $.map(table.rows('.selected').data(), function (item) {
      return item.APELLIDOS;
  });
  var cargo = $.map(table.rows('.selected').data(), function (item) {
      return item.CARGO;
  });
  var email = $.map(table.rows('.selected').data(), function (item) {
      return item.EMAIL;
  });
  var telefono = $.map(table.rows('.selected').data(), function (item) {
      return item.TELEFONO;
  });
  var servicio = $.map(table.rows('.selected').data(), function (item) {
      return item.SERVICIO;
  });
  var cliente = $.map(table.rows('.selected').data(), function (item) {
      return item.CLIENTE;
  });
  var actividad = $.map(table.rows('.selected').data(), function (item) {
      return item.ACTIVIDAD;
  });
  var nomen = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMENCLATURA;
  });
  var sucursal = $.map(table.rows('.selected').data(), function (item) {
      return item.SUCURSAL;
  });
  var nivel = $.map(table.rows('.selected').data(), function (item) {
      return item.NIVEL;
  });
  var mano = $.map(table.rows('.selected').data(), function (item) {
      return item.CLASIFICACION;
  });
  var parametros = {
    "rut": rut[0]
  }

  if($("#esSubcontratistaEditaPersonalOperaciones").prop("checked") == true){
    await $.ajax({
      url:   'controller/datosSubcontratistasVehiculo.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        var cuerpoE = '';
        if(p2.aaData.length !== 0){
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoE += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
          }
          $("#empresaEditaPersonalOperaciones").html(cuerpoE);
        }
        else{
          $("#empresaEditaPersonalOperaciones").html(cuerpoE);
        }
      }
    });
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#empresaEditaPersonalOperaciones").select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  }
  else{
    await $.ajax({
      url:   'controller/datosSubcontratistasVehiculoInterno.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        var cuerpoE = '';
        if(p2.aaData.length !== 0){
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoE += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
          }
          $("#empresaEditaPersonalOperaciones").html(cuerpoE);
        }
        else{
          $("#empresaEditaPersonalOperaciones").html(cuerpoE);
        }
      }
    });
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#empresaEditaPersonalOperaciones").select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  }

  var parametrosCliente = {
    "idsubcontrato": $("#empresaEditaPersonalOperaciones").val()
  }
  await $.ajax({
    url:   'controller/datosContratoDepto.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCo = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].SERVICIO == servicio[0]){
            cuerpoCo += '<option selected value="' + p2.aaData[i].IDSERVICIO + '">' + p2.aaData[i].SERVICIO + '</option>';
          }
          else{
            cuerpoCo += '<option value="' + p2.aaData[i].IDSERVICIO + '">' + p2.aaData[i].SERVICIO + '</option>';
          }
        }
        $("#servicioEditaPersonalOperaciones").html(cuerpoCo);
      }
    }
  });
  parametrosCliente['idcontratodepto'] = $("#servicioEditaPersonalOperaciones").val();
  await $.ajax({
    url:   'controller/datosCliente.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCl = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].CLIENTE == cliente[0]){
            cuerpoCl += '<option selected value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + '</option>';
          }
          else{
            cuerpoCl += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + '</option>';
          }
        }
        $("#clienteEditaPersonalOperaciones").html(cuerpoCl);
      }
    }
  });
  parametrosCliente['idcliente'] = $("#clienteEditaPersonalOperaciones").val();
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].ACTIVIDAD == (actividad[0] + " / " + nomen[0])){
            cuerpoAC += '<option selected value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
          }
          else{
            cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
          }
        }
        $("#actividadEditaPersonalOperaciones").html(cuerpoAC);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#sucursalEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#patenteEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#empresaEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#clienteEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#actividadEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#nivelEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#moEditaPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $('#modalAlertasSplash').modal('hide');
  $("#modalEditaPersonalOperaciones").modal("show");
});

$("#ingresarNuevoJefatura").unbind("click").click(async function(){
  $("#rutIngresarPersonalOperaciones").val('');
  $("#nombresIngresarPersonalOperaciones").val('');
  $("#apellidosIngresarPersonalOperaciones").val('');
  $("#funcionIngresarPersonalOperaciones").val('');
  $("#fonoIngresarPersonalOperaciones").val('');
  $("#emailIngresarPersonalOperaciones").val('');
  $("#esSubcontratistaIngresarPersonalOperaciones").prop("checked",false);
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#rutIngresarPersonalOperaciones").removeClass("is-invalid");
  $("#nombresIngresarPersonalOperaciones").removeClass("is-invalid");
  $("#apellidosIngresarPersonalOperaciones").removeClass("is-invalid");
  await $.ajax({
    url:   'controller/datosNivelFuncional.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoF = '';
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          if((i+1) == p2.aaData.length){
            cuerpoF += '<option selected value="' + p2.aaData[i].IDNIVELFUNCIONAL + '">(' + p2.aaData[i].NUMERO + ') ' + p2.aaData[i].NIVEL + '</option>';
          }
          else{
            cuerpoF += '<option value="' + p2.aaData[i].IDNIVELFUNCIONAL + '">(' + p2.aaData[i].NUMERO + ') ' + p2.aaData[i].NIVEL + '</option>';
          }
        }
        $("#nivelIngresarPersonalOperaciones").html(cuerpoF);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosSucursal.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoS = '';
      cuerpoS += '<option selected value="-1">Sin asignar</option>';
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoS += '<option value="' + p2.aaData[i].IDSUCURSAL + '">' + p2.aaData[i].COMUNA + ' - ' + p2.aaData[i].SUCURSAL + '</option>';
        }
        $("#sucursalIngresarPersonalOperaciones").html(cuerpoS);
      }
      else{
        $("#sucursalIngresarPersonalOperaciones").html(cuerpoS);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosPatentesAsignar.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoP = '';
      cuerpoP += '<option selected value="-1">Sin asignar</option>';
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoP += '<option value="' + p2.aaData[i].IDPATENTE + '">' + p2.aaData[i].PATENTE + ' - ' + p2.aaData[i].ESTADO + '</option>';
        }
        $("#patenteIngresarPersonalOperaciones").html(cuerpoP);
      }
      else{
        $("#patenteIngresarPersonalOperaciones").html(cuerpoP);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosSubcontratistasVehiculoInterno.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoE = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoE += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
        }
        $("#empresaIngresarPersonalOperaciones").html(cuerpoE);
      }
    }
  });

  parametros = {
    'idEmpresa': $("#empresaIngresarPersonalOperaciones").val()
  }

  await $.ajax({
    url:   'controller/datosCecoEmpresa.php',
    type:  'post',
    data: parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCeco = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoCeco += '<option value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].NOMENCLATURA + ' | ' + p2.aaData[i].NOMBRE + ' | ' + p2.aaData[i].AREA + '</option>';
        }
        $("#cecoIngresarPersonalOperaciones").html(cuerpoCeco);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#cecoIngresarPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#sucursalIngresarPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#patenteIngresarPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#empresaIngresarPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#nivelIngresarPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#moIngresarPersonalOperaciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyIngresarPersonalOperaciones").css("height",h);
    $('#modalAlertasSplash').modal('hide');
    $("#modalIngresarPersonalOperaciones").modal("show");
  },500);
});

$("input#rutIngresarPersonalOperaciones").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutIngresarPersonalOperaciones").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutIngresarPersonalOperaciones").val("");
    $("#rutIngresarPersonalOperaciones").addClass("is-invalid");
  }
});

$("#empresaIngresarPersonalOperaciones").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalIngresarPersonalOperaciones").modal("hide");
  e.stopImmediatePropagation();
  e.preventDefault();

  var parametros = {
    "idEmpresa": $("#empresaIngresarPersonalOperaciones").val()
  }
  await $.ajax({
    url:   'controller/datosCecoEmpresa.php',
    type:  'post',
    data: parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCeco = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoCeco += '<option value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].NOMENCLATURA + ' | ' + p2.aaData[i].NOMBRE + ' | ' + p2.aaData[i].AREA + '</option>';
        }
        $("#cecoIngresarPersonalOperaciones").html(cuerpoCeco);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#cecoIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#sucursalIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#patenteIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#empresaIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#nivelIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#moIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $('#modalAlertasSplash').modal('hide');
  $("#modalIngresarPersonalOperaciones").modal("show");
});

$("#servicioIngresarPersonalOperaciones").unbind("click").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  var parametrosCliente = {
    "idcontratodepto": $("#servicioIngresarPersonalOperaciones").val(),
    "idsubcontrato": $("#empresaIngresarPersonalOperaciones").val()
  }
  await $.ajax({
    url:   'controller/datosCliente.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCl = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoCl += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + '</option>';
        }
        $("#clienteIngresarPersonalOperaciones").html(cuerpoCl);
      }
    }
  })
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#clienteIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  parametrosCliente['idcliente'] = $("#clienteIngresarPersonalOperaciones").val();
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadIngresarPersonalOperaciones").html(cuerpoAC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#actividadIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#servicioIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#clienteIngresarPersonalOperaciones").unbind("click").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  var parametrosCliente = {
    "idcontratodepto": $("#servicioIngresarPersonalOperaciones").val(),
    "idcliente": $("#clienteIngresarPersonalOperaciones").val(),
    "idsubcontrato": $("#empresaIngresarPersonalOperaciones").val()
  }
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadIngresarPersonalOperaciones").html(cuerpoAC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#actividadIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#clienteIngresarPersonalOperaciones").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#esSubcontratistaIngresarPersonalOperaciones").unbind("click").change(async function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  if($("#esSubcontratistaIngresarPersonalOperaciones").prop("checked") == true){
    await $.ajax({
      url:   'controller/datosSubcontratistasVehiculo.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoE = '';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoE += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
          }
          $("#empresaIngresarPersonalOperaciones").html(cuerpoE);
        }
      }
    });
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#empresaIngresarPersonalOperaciones").select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  }
  else{
    await $.ajax({
      url:   'controller/datosSubcontratistasVehiculoInterno.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoE = '';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoE += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
          }
          $("#empresaIngresarPersonalOperaciones").html(cuerpoE);
        }
      }
    });
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#empresaIngresarPersonalOperaciones").select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  }
});

$("#jefaturaInformeFallas").unbind("click").change(function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    var largo = Math.trunc($(window).height() - 200);
  }
  else{
    var largo = 0;
    if($(window).width() > $(window).height()){
      var largo = Math.trunc($(window).height());
    }
    else{
      var largo = Math.trunc($(window).height() - 300);
    }
  }
  var path = window.location.href.split('#/')[1];

  var au = $("#auditoriaInformeFallas").val();

  var strVal = '';
  for(var i = 0; i < au.length; i++){
    if(i == au.length - 1){
        strVal +=  au[i];
    }
    else{
        strVal += au[i] + ",";
    }
  }

  var parametros = {
    'mes': $("#periodoInformeFallas").val().split('-')[1],
    'ano': $("#periodoInformeFallas").val().split('-')[0],
    'path': path,
    "val": strVal,
    "rutJefe": $("#jefaturaInformeFallas").val()
  }

  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawChartInformeFallaJefe);

  async function drawChartInformeFallaJefe() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Falla');
    data.addColumn('number', 'Cantidad');

    await $.ajax({
      url:   'controller/datosProblemasPracticas.php',
      type:  'post',
      data: parametros,
      success: function (response) {
        var p = jQuery.parseJSON(response);
        if(p.length !== 0) {
          var max = 0;

          for(var i = 0; i < p.length; i++){
            data.addRow([p[i].FAMILIA + ' - ' + p[i].CATEGORIA, parseInt(p[i].CANTIDAD)]);
            if(parseInt(p[i].CANTIDAD) > max){
              max = p[i].CANTIDAD;
            }
          }

          var options = {
            title: '',
            // curveType: 'function',
            legend: {
              position: "top"
            },
            isStacked: false,
            annotations: {
                 textStyle: {
                     color: 'black',
                     fontSize: 11,
                 },
                 alwaysOutside: true
            },
            hAxis : {
                textStyle : {
                    fontSize: 12 // or the number you want
                },
                slantedText:true,
                slantedTextAngle:90
            },
            vAxis : {
                textStyle : {
                    fontSize: 12 // or the number you want
                },
                viewWindow: {
                    min: 0,
                }
            },
            chartArea: {
              'width': '100%',
              'height': '100%',
              'top': '50',
              'bottom': '5',
              'right': '15',
              'left': '40'
            }
          };

          var chart = new google.visualization.ColumnChart(document.getElementById('graficoInformeFallas'));

          chart.draw(data, options);

          $("#tablaInformeFallas").remove();
          $("#tablaInformeFallasPadre").append('<div id="tablaInformeFallas"></div>');

          FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];

          new FancyGrid({
              renderTo: 'tablaInformeFallas',
              scrollable: true,
              selModel: {
                type: 'rows'
              },
              theme: 'blue',
              height: largo,
              data: p,
              trackOver: true,
              defaults: {
                // resizable: true,
                sortable: true,
                align: 'left',
                cellAlign: 'left'
              },
              cellHeight: 45,
              columns: [
                {
                  type: 'tree',
                  title: 'Familia',
                  index: 'FAMILIA',
                  flex: 5,
                },
                {
                  title: 'Categoria',
                  index: 'CATEGORIA',
                  flex: 5,
                },
                {
                  type: 'number',
                  title: '# Fallas',
                  index: 'CANTIDAD',
                  flex: 1,
                  align: 'center',
                  cellAlign: 'center',
                },
                {
                  type: 'string',
                  title: 'Detalle TAC',
                  index: 'BOTON',
                  align: 'center',
                  cellAlign: 'center',
                  flex: 1,
                }
              ],
              events: [
                {
                  cellclick: function(grid, o){
                    if(o.columnIndex == 3 && !o.data.FAMILIA.includes('-')){
                      detallePracticasFallasPersonas(o.data.FAMILIA, o.data.CATEGORIA);
                    }
                  }
                }
              ],
              exporter: true,
              tbar: [
                {
                  type: 'search',
                  width: 200,
                  emptyText: 'Buscar'
                },
                {
                  text: 'Excel',
                  handler: function() {
                    this.exportToExcel();
                  }
                }
              ]
          })

          setTimeout(function(){
            $("a[href|='http://www.fancygrid.com']").parent().remove();
            $('#modalAlertasSplash').modal('hide');
          },2000);
        }
        else{
          var options = {
            title: '',
            // curveType: 'function',
            legend: {
              position: "top"
            },
            isStacked: false,
            annotations: {
                 textStyle: {
                     color: 'black',
                     fontSize: 11,
                 },
                 alwaysOutside: true
            },
            hAxis : {
                textStyle : {
                    fontSize: 12 // or the number you want
                },
                slantedText:true,
                slantedTextAngle:90
            },
            vAxis : {
                textStyle : {
                    fontSize: 12 // or the number you want
                },
                viewWindow: {
                    min: 0,
                }
            },
            chartArea: {
              'width': '100%',
              'height': '100%',
              'top': '50',
              'bottom': '5',
              'right': '15',
              'left': '40'
            }
          };

          var chart = new google.visualization.ColumnChart(document.getElementById('graficoInformeFallas'));

          chart.draw(data, options);

          $("#tablaInformeFallas").remove();
          $("#tablaInformeFallasPadre").append('<div id="tablaInformeFallas"></div>');

          if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {

          }
          else{
            $("#tablaInformeFallas").css("margin-top","20px");
          }

          new FancyGrid({
              renderTo: 'tablaInformeFallas',
              scrollable: true,
              selModel: {
                type: 'rows'
              },
              theme: 'blue',
              height: largo,
              data: p,
              trackOver: true,
              defaults: {
                // resizable: true,
                sortable: true,
                align: 'left',
                cellAlign: 'left'
              },
              cellHeight: 45,
              columns: [
                {
                  type: 'tree',
                  title: 'Familia',
                  index: 'FAMILIA',
                  flex: 5,
                },
                {
                  title: 'Categoria',
                  index: 'CATEGORIA',
                  flex: 5,
                },
                {
                  type: 'number',
                  title: '# Fallas',
                  index: 'CANTIDAD',
                  flex: 1,
                  align: 'center',
                  cellAlign: 'center',
                },
                {
                  type: 'string',
                  title: 'Detalle TAC',
                  index: 'BOTON',
                  align: 'center',
                  cellAlign: 'center',
                  flex: 1,
                }
              ],
              events: [{
                cellclick: function(grid, o){
                  if(o.columnIndex == 3 && !o.data.FAMILIA.includes('-')){
                    detallePracticasFallasPersonas(o.data.FAMILIA, o.data.CATEGORIA);
                  }
                }
              }],
              tbar: [
                {
                  type: 'search',
                  width: 200,
                  emptyText: 'Buscar'
                }
              ]
          })

          setTimeout(function(){
            $("a[href|='http://www.fancygrid.com']").parent().remove();
            $('#modalAlertasSplash').modal('hide');
          },2000);
        }
        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#jefaturaInformeFallas").select2('destroy').select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
      }
    });
  }
});

// FUNCION PARA MODAL HISTORIAL VEHICULOS
$("#historialVehiculo").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoVehiculo').DataTable();
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE;
  });

  $("#tituloHistorialVehiculos").html('Patente: ' + patente);

  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  var parametros = {
    'patente': patente[0]
  }

  await $('#tablaHistorialVehiculos').DataTable({
      ajax: {
          url: "controller/datosHistorialVehiculo.php",
          type: 'POST',
          data: parametros
      },
      columns: [
          { data: 'S'},
          { data: 'ID'},
          { data: 'OBSERVACION'},
          { data: 'FECHA_HISTORIAL' },
          { data: 'HORA_HISTORIAL' },
          { data: 'USUARIO' },
          { data: 'ESTADO_VEHICULO' },
          { data: 'ESTADO_CONTROL' },
          { data: 'ESTADO_RRHH' },
          { data: 'TIPO_VEHICULO' },
          { data: 'PROPIEDAD' },
          { data: 'MARCA' },
          { data: 'MODELO' },
          { data: 'PROVEEDOR' },
          { data: 'PERSONAL_ASIGNADO' },
          { data: 'RUT_ASIGNADO' },
          { data: 'BODEGA' },
          { data: 'SERVICIO' },
          { data: 'CLIENTE' },
          { data: 'ACTIVIDAD' },
          { data: 'ASEGURADORA' },
          { data: 'SUBCONTRATISTA' },
          { data: 'KILOMETRAJE' },
          { data: 'AÑO' },
          { data: 'VIN' },
          { data: 'NRO_MOTOR' },
          { data: 'LITROS_ESTANQUE' },
          { data: 'COLOR' },
          { data: 'FINICIO' },
          { data: 'FTERMINO' },
          { data: 'TIPOMONTO' },
          { data: 'MONTO' },
          { data: 'MONTO_ASEGURADORA' },
          { data: 'FMANTENIMIENTO' },
          { data: 'PDFREVTEC' },
          { data: 'PDFPERMCIRC' },
          { data: 'PDFASEG' },
          { data: 'PDFOTROS' },


      ],
      buttons: [
          {
            extend: 'excel',
            exportOptions: {
              columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34 ]
            },
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        },
      ],
      "select": {
          style: 'single'
      },
      fixedColumns: {
        leftColumns: 2
      },
      "order": [ 1, "desc" ],
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": true,
      "initComplete": function( settings, json){
        $('#contenido').show();
        $('#menu-lateral').show();
        $('#footer').parent().show();
$('#footer').show();
        setTimeout(function(){
          var h = $(window).height() - 200;
          $("#bodyHistorialVehiculos").css("height",h);
          $("#modalHistorialVehiculos").modal("show");
            $('#modalAlertasSplash').modal('hide');
          setTimeout(function(){
            $('#tablaHistorialVehiculos').DataTable().columns.adjust();
          },500);
        },2000);
      }
  });
});
// FIN FUNCION PARA MODAL HISTORIAL VEHICULOS

$("#agregarPersonalExterno").unbind("click").click(async function(){
  $("#modalIngresoPersonalExterno").find("input,textarea,select").val("");
  $('input[id$=Externo]').each(function() {
    if($(this).val().trim() === ''){
      $(this).removeClass("is-invalid");
    }
  })
  $('select[id$=Externo]').each(function() {
    if($(this).val() === null){
      $(this).removeClass('is-invalid');
    }
  })
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#fechaNacIngresoPersonalExterno").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });
  await $.ajax({
    url:   'controller/datosEstadoCivil.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDESTADO_CIVIL + '">' + p2.aaData[i].ESTADO_CIVIL + '</option>';
        }
        $("#estadoCivilIngresoPersonalExterno").html(cuerpoEC);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#estadoCivilIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#nacionalidadIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#cecoIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#contratoDeptoIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#clienteIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#actividadIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#nivelFuncionalIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#tipoContratoIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#tipoLicenciaIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#sucursalIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#tipoJornadaIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#subcontratoIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#sitMilitarIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#sexoIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#clasificacionIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#requiereUniformeIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });

    $("#poseeLicenciaIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  await $.ajax({
    url:   'controller/datosNacionalidad.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoN = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoN += '<option value="' + p2.aaData[i].IDNACIONALIDAD + '">' + p2.aaData[i].NACIONALIDAD + '</option>';        }
        }
        $("#nacionalidadIngresoPersonalExterno").html(cuerpoN);
      }
  });

  await $.ajax({
    url:   'controller/datosCeco.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoC += '<option value="' + p2.aaData[i].IDCENTRO_COSTO + '">' + p2.aaData[i].CENTRO_COSTO + '</option>';
        }
        $("#cecoIngresoPersonalExterno").html(cuerpoC);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosContratoDepto.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCo = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoCo += '<option value="' + p2.aaData[i].IDSERVICIO + '">' + p2.aaData[i].SERVICIO + '</option>';
        }
        $("#contratoDeptoIngresoPersonalExterno").html(cuerpoCo);
      }
    }
  });
  var parametrosCliente = {
    "idcontratodepto": $("#contratoDeptoIngresoPersonalExterno").val()
  }
  await $.ajax({
    url:   'controller/datosCliente.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCl = '';
        for(var i = 0; i < p2.aaData.length; i++){

          cuerpoCl += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + '</option>';

        }
        $("#clienteIngresoPersonalExterno").html(cuerpoCl);
      }
    }
  });

  parametrosCliente['idcliente'] = $("#clienteIngresoPersonalExterno").val();
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadIngresoPersonalExterno").html(cuerpoAC);
      }
    }
  });

  $("#fechaIngIngresoPersonalExterno").datepicker({
    dateFormat: "dd-mm-yy",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  await $.ajax({
    url:   'controller/datosNivelFuncional.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoF = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoF += '<option value="' + p2.aaData[i].IDNIVELFUNCIONAL + '">(' + p2.aaData[i].NUMERO + ') ' + p2.aaData[i].NIVEL + '</option>';
        }
        $("#nivelFuncionalIngresoPersonalExterno").html(cuerpoF);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosTipoContrato.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoT = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoT += '<option value="' + p2.aaData[i].IDTIPO_CONTRATO + '">' + p2.aaData[i].TIPO_CONTRATO + '</option>';
        }
        $("#tipoContratoIngresoPersonalExterno").html(cuerpoT);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosTipoLicencia.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoTi = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoTi += '<option value="' + p2.aaData[i].IDTIPO_LICENCIA + '">' + p2.aaData[i].TIPO_LICENCIA + ' - ' + p2.aaData[i].TIPO + '</option>';
        }
        $("#tipoLicenciaIngresoPersonalExterno").html(cuerpoTi);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosSucursal.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoS = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoS += '<option value="' + p2.aaData[i].IDSUCURSAL + '">' + p2.aaData[i].COMUNA + ' - ' + p2.aaData[i].SUCURSAL + '</option>';
        }
        $("#sucursalIngresoPersonalExterno").html(cuerpoS);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosTipoJornada.php',
    type:  'post',

    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoTJ = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoTJ += '<option value="' + p2.aaData[i].IDTIPO_JORNADA + '">' + p2.aaData[i].TIPO_JORNADA + '</option>';
        }
        $("#tipoJornadaIngresoPersonalExterno").html(cuerpoTJ);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosTipoSubcontratista.php',
    type:  'post',

    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoTS = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoTS += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
          }
        }
        $("#subcontratoIngresoPersonalExterno").html(cuerpoTS);
      }
  });
  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyIngresoPersonalExterno").css("height",h);
    $("#modalIngresoPersonalExterno").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoPersonalExterno').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarIngresoPersonalExterno").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var count = 0;

  $('input[id$=Externo]').each(function() {
    if($(this).val().trim() === ''){
      count++;
      $(this).addClass('is-invalid');
    }
  })

  $('input[id$=Externo]').on('input', function(){
    $(this).removeClass("is-invalid");
  });
  // console.log($("#subcontratoIngresoPersonalExterno").val());

  $('select[id$=Externo]').each(function() {
    if($(this).val() === null){
      count++;
      $(this).addClass('is-invalid');
    }
  })

  $('select[id$=Externo]').on('change', function(){
    $(this).removeClass("is-invalid");
  });
  //console.log('contador input '+count);
  if(count > 0){


    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Favor completar los campos marcados con borde rojo");

  }
  else if (count == 0) {
    parametros = {
      "rutPExterno": $.trim($("#rutIngresoPersonalExterno").val().replace('.','').replace('.','')),
      "apellidosPExterno": $("#apellidosIngresoPersonalExterno").val(),
      "nombresPExterno": $("#nombresIngresoPersonalExterno").val(),
      "fechaNac": $("#fechaNacIngresoPersonalExterno").val(),
      "sexoIngreso": $("#sexoIngresoPersonalExterno").val(),
      "estadoCivil": $("#estadoCivilIngresoPersonalExterno").val(),
      "sitMilitar": $("#sitMilitarIngresoPersonalExterno").val(),
      "telefono": $("#telefonoIngresoPersonalExterno").val(),
      "telefonoEmergencia": $("#telefonoEmergenciaIngresoPersonalExterno").val(),
      "contacto": $("#contactoIngresoPersonalExterno").val(),
      "nacionalidad": $("#nacionalidadIngresoPersonalExterno").val(),
      "ceco": $("#cecoIngresoPersonalExterno").val(),
      "contrato": $("#contratoDeptoIngresoPersonalExterno").val(),
      "cliente": $("#clienteIngresoPersonalExterno").val(),
      "actividad": $("#actividadIngresoPersonalExterno").val(),
      "fechaIngreso": $("#fechaIngIngresoPersonalExterno").val(),
      "clasificacion": $("#clasificacionIngresoPersonalExterno").val(),
      "cargo": $("#cargoIngresoPersonalExterno").val(),
      "nivel": $("#nivelFuncionalIngresoPersonalExterno").val(),
      "tipoContrato": $("#tipoContratoIngresoPersonalExterno").val(),
      "requiereUniforme": $("#requiereUniformeIngresoPersonalExterno").val(),
      "tallaIngreso": $("#tallaIngresoPersonalExterno").val(),
      "poseeLicencia": $("#poseeLicenciaIngresoPersonalExterno").val(),
      "tipoLicencia": $("#tipoLicenciaIngresoPersonalExterno").val(),
      "sucursal": $("#sucursalIngresoPersonalExterno").val(),
      "tipoJornada": $("#tipoJornadaIngresoPersonalExterno").val(),
      "subcontrato": $("#subcontratoIngresoPersonalExterno").val(),
    }
    //console.log(parametros);
    $.ajax({
    url:   'controller/datosChequeaPExterno.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Ya existe una persona ingresada con ese DNI");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        $("#modalIngresoPersonalExterno").modal("hide");
        $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
        $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
        $('#modalAlertasSplash').modal('show');
        $.ajax({
          url: "controller/ingresaPersonalExterno.php",
          type: 'POST',
          data: parametros,
          success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                var table = $('#tablaPersonalExterno').DataTable();
                table.ajax.reload();
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Personal ingresado correctamente");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear carga familiar, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear carga familiar, si el problema persiste favor comuniquese con soporte");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
        });
      }
    }
  });
  }
});

$("input#rutIngresoPersonalExterno").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutIngresoPersonalExterno").val() !== ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutIngresoPersonalExterno").val("");
    $("#rutIngresoPersonalExterno").addClass("is-invalid");
  }
});

$("#contratoDeptoIngresoPersonalExterno").unbind("click").change(async function(){
  var parametrosCliente = {
    "idcontratodepto": $("#contratoDeptoIngresoPersonalExterno").val()
  }
  await $.ajax({
    url:   'controller/datosCliente.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCl = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoCl += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + '</option>';
        }
        $("#clienteIngresoPersonalExterno").html(cuerpoCl);
      }
    }
  })
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#clienteIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  parametrosCliente['idcliente'] = $("#clienteIngresoPersonalExterno").val();
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadIngresoPersonalExterno").html(cuerpoAC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#actividadIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#clienteIngresoPersonalExterno").unbind("click").change(async function(){
  var parametrosCliente = {
    "idcontratodepto": $("#contratoDeptoIngresoPersonalExterno").val(),
    "idcliente": $("#clienteIngresoPersonalExterno").val()
  }
  await $.ajax({
    url:   'controller/datosActividad.php',
    type:  'post',
    data: parametrosCliente,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoAC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoAC += '<option value="' + p2.aaData[i].IDACTIVIDAD + '">' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#actividadIngresoPersonalExterno").html(cuerpoAC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#actividadIngresoPersonalExterno").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#guardarIngresarPersonalOperaciones").unbind("click").click(function(){
  var rut = $("#rutIngresarPersonalOperaciones").val();
  var apellidos = $("#apellidosIngresarPersonalOperaciones").val();
  var nombres = $("#nombresIngresarPersonalOperaciones").val();
  if(rut == '' || apellidos == '' || nombres == ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los valores obligatorios (*)");

    if(rut == ''){
      $("#rutIngresarPersonalOperaciones").addClass("is-invalid");
    }
    if(apellidos == ''){
    $("#apellidosIngresarPersonalOperaciones").addClass("is-invalid");
    }
    if(nombres == ''){
      $("#nombresIngresarPersonalOperaciones").addClass("is-invalid");
    }
  }
  else{
    $('#modalIngresarPersonalOperaciones').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var sucursal = $("#sucursalIngresarPersonalOperaciones").val();
    var funcion = $("#funcionIngresarPersonalOperaciones").val();
    var externo = 0;
    if($("#esSubcontratistaIngresarPersonalOperaciones").prop("checked") == true){
      externo = 1;
    }
    else{
      externo = 0;
    }
    var patente = $("#patenteIngresarPersonalOperaciones").val();
    var fono = $("#fonoIngresarPersonalOperaciones").val();
    var mail = $("#emailIngresarPersonalOperaciones").val();
    var empresa = $("#empresaIngresarPersonalOperaciones").val();
    var nivel = $("#nivelIngresarPersonalOperaciones").val();
    var mano = $("#moIngresarPersonalOperaciones").val();
    var idCeco = $("#cecoIngresarPersonalOperaciones").val();
    var parametros = {
      "rut": rut.replace(".","").replace(".",""),
      "rutPExterno": rut.replace(".","").replace(".",""),
      "apellidos": apellidos,
      "nombres": nombres,
      "sucursal": sucursal,
      "funcion": funcion,
      "externo": externo,
      "patente": patente,
      "fono": fono,
      "mail": mail,
      "empresa": empresa,
      "nivel": nivel,
      "mano": mano,
      "idCeco": idCeco
    }

    $.ajax({
      url:   'controller/datosChequeaPExterno.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Ya existe una persona ingresada con ese DNI");
            setTimeout(function(){
              $('#modalIngresarPersonalOperaciones').modal('show');
              $('#modalAlertasSplash').modal('hide');
            },1000);
          }
        }
        else{
          $.ajax({
            url: "controller/ingresaPersonalGestOper.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
              var p = response.split(",");
              if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaJefatura').DataTable();
                  //table.rows('.selected').remove().draw();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Personal ingresado correctamente");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },1000);
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar personal, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalIngresarPersonalOperaciones').modal('show');
                    $('#modalAlertasSplash').modal('hide');
                  },1000);
                }
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar personal, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalIngresarPersonalOperaciones').modal('show');
                  $('#modalAlertasSplash').modal('hide');
                },1000);
              }
            }
          });
        }
      }
    });
  }
});

$("#rutIngresarPersonalOperaciones").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombresIngresarPersonalOperaciones").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#apellidosIngresarPersonalOperaciones").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#guardarEditaPersonalOperaciones").unbind("click").click(function(){
  var rut = $("#rutEditaPersonalOperaciones").val();
  var apellidos = $("#apellidosEditaPersonalOperaciones").val();
  var nombres = $("#nombresEditaPersonalOperaciones").val();
  if(rut == '' || apellidos == '' || nombres == ''){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los valores obligatorios (*)");

    if(rut == ''){
      $("#rutEditaPersonalOperaciones").addClass("is-invalid");
    }
    if(apellidos == ''){
      $("#apellidosEditaPersonalOperaciones").addClass("is-invalid");
    }
    if(nombres == ''){
      $("#nombresEditaPersonalOperaciones").addClass("is-invalid");
    }
  }
  else{
    $('#modalEditaPersonalOperaciones').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var sucursal = $("#sucursalEditaPersonalOperaciones").val();
    var funcion = $("#funcionEditaPersonalOperaciones").val();
    var externo = 0;
    if($("#esSubcontratistaEditaPersonalOperaciones").prop("checked") == true){
      externo = 1;
    }
    else{
      externo = 0;
    }
    var patente = $("#patenteEditaPersonalOperaciones").val();
    var fono = $("#fonoEditaPersonalOperaciones").val();
    var mail = $("#emailEditaPersonalOperaciones").val();
    var empresa = $("#empresaEditaPersonalOperaciones").val();
    var nivel = $("#nivelEditaPersonalOperaciones").val();
    var mano = $("#moEditaPersonalOperaciones").val();
    var idCeco = $("#cecoEditaPersonalOperaciones").val();

    var table = $('#tablaJefatura').DataTable();
    var patAnterior = $.map(table.rows('.selected').data(), function (item) {
        return item.PATENTE;
    });

    var parametros = {
      "rut": rut.replace(".","").replace(".",""),
      "rutPExterno": rut.replace(".","").replace(".",""),
      "apellidos": apellidos,
      "nombres": nombres,
      "sucursal": sucursal,
      "funcion": funcion,
      "externo": externo,
      "patente": patente,
      "fono": fono,
      "mail": mail,
      "empresa": empresa,
      "patAnterior": patAnterior[0],
      "nivel": nivel,
      "mano": mano,
      "idCeco": idCeco
    }

    $.ajax({
      url: "controller/editarPersonalGestOper.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaJefatura').DataTable();
            //table.rows('.selected').remove().draw();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Personal actualizado correctamente");
            $("#editarJefatura").attr("disabled","disabled");
            $("#imagenJefatura").attr("disabled","disabled");
            $("#cambiarJefatura").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },1000);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar personal, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },1000);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar personal, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },1000);
        }
      }
    });
  }
});

$("#nombresEditaPersonalOperaciones").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#apellidosEditaPersonalOperaciones").on('input', function(){
  $(this).removeClass("is-invalid");
});

// FUNCION PARA MODAL CREAR ASIGNACION VEHICULO
$("#agregarAsignacion").unbind("click").click(async function(e){
  e.preventDefault();
  $("#kilometrajeAsignacionVehiculo").removeClass("is-invalid");
  $("#guardarAsignacionVehiculo").attr("disabled","disabled");
  $("#rutAsignacionVehiculo").val("");
  $("#nombreAsignacionVehiculo").val("");
  $("#nombreAsignacionVehiculo").attr("disabled","disabled");
  $("#telefonoAsignacionVehiculo").val("");
  $("#observacionAsignacionVehiculo").val("");
  $("#negocioAsignacionVehiculo").val("");
  $("#negocioAsignacionVehiculo").attr("disabled","disabled");
  $("#proyectoAsignacionVehiculo").html("");
  $("#rutAsignacionVehiculo").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var path = window.location.href.split('#/')[1];
  var parametrosPersonal = {
    "path" : path
  }
  await $.ajax({
    url:   'controller/datosPersonalAsignacion.php',
    type:  'post',
    data: parametrosPersonal,
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var listaPersonalUsuario = [];
        for(var i = 0; i < p.aaData.length; i++) {
          listaPersonalUsuario.push(p.aaData[i].DNI + ' - ' + p.aaData[i].PERSONAL);
        }
        $('#rutAsignacionVehiculo').autocomplete({
          // req will contain an object with a "term" property that contains the value
          // currently in the text input.  responseFn should be invoked with the options
          // to display to the user.
          source: function (req, responseFn) {
            // Escape any RegExp meaningful characters such as ".", or "^" from the
            // keyed term.
            var term = $.ui.autocomplete.escapeRegex(req.term),
              // '^' is the RegExp character to match at the beginning of the string.
              // 'i' tells the RegExp to do a case insensitive match.
              matcher = new RegExp(term, 'i'),
              // Loop over the options and selects only the ones that match the RegExp.
              matches = $.grep(listaPersonalUsuario, function (item) {
                return matcher.test(item);
              });
            // Return the matched options.
            responseFn(matches);
          }
        });
      }
    }
  });

  await $.ajax({
    url:   'controller/datosPatenteAsignacion.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPA = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoPA += '<option value="' + p2.aaData[i].IDPATENTE + '">' + p2.aaData[i].CODIGO + '  ' + p2.aaData[i].ESTADO +'</option>';
        }
        $("#patenteAsignacionVehiculo").html(cuerpoPA);
      }
    }
  });

  patente = $("#patenteAsignacionVehiculo").val();
  var parametrosPatente = {
    "patente" : patente
  }
  await $.ajax({
    url:   'controller/datosPatenteSelectAsignacion.php',
    type:  'post',
    data: parametrosPatente,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      if(p3.aaData.length > 0){
        $("#anoAsignacionVehiculo").val(p3.aaData[0].AÑO);
        $("#anoAsignacionVehiculo").attr("disabled","disabled");
        $("#kilometrajeAsignacionVehiculo").val(p3.aaData[0].KILOMETRAJE);
        $("#marcaAsignacionVehiculo").val(p3.aaData[0].MARCA);
        $("#marcaAsignacionVehiculo").attr("disabled","disabled");
        $("#modeloAsignacionVehiculo").val(p3.aaData[0].MODELO);
        $("#modeloAsignacionVehiculo").attr("disabled","disabled");
        $("#licenciaAsignacionVehiculo").html(p3.aaData[0].LICENCIA);
        $("#bodegaAsignacionVehiculo").val(p3.aaData[0].BODEGA);
        $("#bodegaAsignacionVehiculo").attr("disabled","disabled");
        tipoVeh = p3.aaData[0].TIPO;
        var param = {
          "tipo" : tipoVeh
        }
        $.ajax({
          url:   'controller/datosCheckboxAsignacion.php',
          type:  'post',
          data: param,
          success: function (response2) {
            var p2 = jQuery.parseJSON(response2);
            if(p2.aaData.length !== 0){
              var cuerpoC = '';
              for(i = 0; i < p2.aaData.length; i++){
                cuerpoC += '<div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;">';
                cuerpoC += '<label class="switch"><input value="' + p2.aaData[i].IDPATENTE_ASIGNACION_CHECKS + '" type="checkbox" title="Proceso de inducción" checked="checked"><span class="slider round"></span></label>&nbsp;&nbsp;<label>' + p2.aaData[i].ITEM + '</label>';
                cuerpoC += '</div>';
              }
              $("#checkbox").html(cuerpoC);
              setTimeout(function(){
                var h = $(window).height() - 240;
                $("#bodyAsignacionVehiculo").css("height",h);
                $("#modalAsignacionVehiculo").modal("show");
                $('#modalAlertasSplash').modal('hide');
                setTimeout(function(){
                  $('#bodyAsignacionVehiculo').animate({ scrollTop: 0 }, 'fast');
                },200);
              },500);
            }
          }
        });
      }
      else{
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No tiene patentes disponibles para asignar");
        $('#modalAlertasSplash').modal('hide');
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#patenteAsignacionVehiculo").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#patenteAsignacionVehiculo").unbind("click").change(async function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $("#modalAsignacionVehiculo").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  patente = $("#patenteAsignacionVehiculo").val();
  var parametrosPatente = {
  "patente" : patente
  }
  await $.ajax({
    url:   'controller/datosPatenteSelectAsignacion.php',
    type:  'post',
    data: parametrosPatente,
    success: async function (response3) {
      var p3 = jQuery.parseJSON(response3);
      $("#anoAsignacionVehiculo").val(p3.aaData[0].AÑO);
      $("#anoAsignacionVehiculo").attr("disabled","disabled");
      $("#kilometrajeAsignacionVehiculo").val(p3.aaData[0].KILOMETRAJE);
      $("#marcaAsignacionVehiculo").val(p3.aaData[0].MARCA);
      $("#marcaAsignacionVehiculo").attr("disabled","disabled");
      $("#modeloAsignacionVehiculo").val(p3.aaData[0].MODELO);
      $("#modeloAsignacionVehiculo").attr("disabled","disabled");
      $("#licenciaAsignacionVehiculo").html(p3.aaData[0].LICENCIA);
      $("#bodegaAsignacionVehiculo").val(p3.aaData[0].BODEGA);
      $("#bodegaAsignacionVehiculo").attr("disabled","disabled");
      tipoVeh = p3.aaData[0].TIPO;
      var param = {
        "tipo" : tipoVeh
      }
      await $.ajax({
        url:   'controller/datosCheckboxAsignacion.php',
        type:  'post',
        data: param,
        success: function (response2) {
          var p2 = jQuery.parseJSON(response2);
          if(p2.aaData.length !== 0){
            var cuerpoC = '';
            for(i = 0; i < p2.aaData.length; i++){
              cuerpoC += '<div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;">';
              cuerpoC += '<label class="switch"><input value="' + p2.aaData[i].IDPATENTE_ASIGNACION_CHECKS + '" type="checkbox" title="Proceso de inducción" checked="checked"><span class="slider round"></span></label>&nbsp;&nbsp;<label>' + p2.aaData[i].ITEM + '</label>';
              cuerpoC += '</div>';
            }
            $("#checkbox").html(cuerpoC);
            setTimeout(function(){
              var h = $(window).height() - 240;
              $("#bodyAsignacionVehiculo").css("height",h);
              $("#modalAsignacionVehiculo").modal("show");
              $('#modalAlertasSplash').modal('hide');
              setTimeout(function(){
                $('#bodyAsignacionVehiculo').animate({ scrollTop: 0 }, 'fast');
              },200);
            },500);
          }
        }
      });

      if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        $("#patenteAsignacionVehiculo").select2('destroy').select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
      }
    }
  });
});

$("#kilometrajeAsignacionVehiculo").focusout(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  patente = $("#patenteAsignacionVehiculo").val();
  var parametrosPatente = {
    "patente" : patente
  }
  await $.ajax({
    url:   'controller/datosPatenteSelectAsignacion.php',
    type:  'post',
    data: parametrosPatente,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      var kil = p3.aaData[0].KILOMETRAJE;
      if(parseInt($("#kilometrajeAsignacionVehiculo").val()) < parseInt(kil) || $("#kilometrajeAsignacionVehiculo").val().length == 0){
        $("#kilometrajeAsignacionVehiculo").val(kil);
        $("#kilometrajeAsignacionVehiculo").addClass("is-invalid");
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un kilometraje menor al del sistema");
      }
    }
  });
});

$("#kilometrajeAsignacionVehiculo").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#rutAsignacionVehiculo").focusout(function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  vari = $("#rutAsignacionVehiculo").val().split(" - ")[0];
  var parametrosRut = {
    "rut": $.trim(vari.replace('.','').replace('.','')),
  }
  if(vari.length > 8){
    $('#modalAsignacionVehiculo').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url:   'controller/datosPersonalSelectAsignacion.php',
      type:  'post',
      data: parametrosRut,
      success: function (response3) {
        if(response3.localeCompare("Sin datos") != 0 && response3 != ""){
          var p3 = jQuery.parseJSON(response3);
          $("#rutAsignacionVehiculo").val(vari);
          $("#guardarAsignacionVehiculo").removeAttr("disabled");
          $("#nombreAsignacionVehiculo").val(p3.aaData[0].PERSONAL);
          $("#nombreAsignacionVehiculo").attr("disabled","disabled");
          $("#telefonoAsignacionVehiculo").val(p3.aaData[0].TELEFONO);
          $("#negocioAsignacionVehiculo").val(p3.aaData[0].ESTRUCTURA);
          $("#negocioAsignacionVehiculo").attr("disabled","disabled");
          $("#proyectoAsignacionVehiculo").html(p3.aaData[0].ESTRUCTURA+ ' - ' +p3.aaData[0].NOMENCLATURA);
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalAsignacionVehiculo').modal('show');
          },500);
        }
        else{
          $('#modalAlertasSplash').modal('hide');
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El DNI ingresado es inválido o no pertenece a la empresa");
          $("#rutAsignacionVehiculo").val("");
          $("#rutAsignacionVehiculo").addClass("is-invalid");
          setTimeout(function(){
            $('#modalAsignacionVehiculo').modal('show');
          },500);
        }
      }
    });
  }
});

$("#rutAsignacionVehiculo").on('input', function(){
  $(this).removeClass("is-invalid");
  $("#guardarAsignacionVehiculo").attr("disabled","disabled");
  $("#nombreAsignacionVehiculo").val("");
  $("#nombreAsignacionVehiculo").attr("disabled","disabled");
  $("#telefonoAsignacionVehiculo").val("");
  $("#negocioAsignacionVehiculo").val("");
  $("#negocioAsignacionVehiculo").attr("disabled","disabled");
  $("#proyectoAsignacionVehiculo").html("");
});

// Funcion para el evento del boton guardar Asignacion del modal
$("#guardarAsignacionVehiculo").unbind('click').click( async function(){
  var arrTodo = new Array();
  $('#checkbox input[type=checkbox]').each(function(){
    var item = {};
    item.id = this.value;
    item.status = this.checked;
    arrTodo.push(item);
  });

  var toPost = JSON.stringify(arrTodo);

  parametros = {
    "rutPersonal": $.trim($("#rutAsignacionVehiculo").val().replace('.','').replace('.','')),
    "telefonoPersonal": $("#telefonoAsignacionVehiculo").val(),
    "idPatente": $("#patenteAsignacionVehiculo").val(),
    "kilometrajePatente": $("#kilometrajeAsignacionVehiculo").val(),
    "idBodegaPatente": $("#bodegaAsignacionVehiculo").val(),
    "observacion": $("#observacionAsignacionVehiculo").val(),
  }
  $("#modalAsignacionVehiculo").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url: "controller/asignacionVehiculo.php",
    type: 'POST',
    data: parametros,
    success:  async function (response) {
      var p = jQuery.parseJSON(response);
      parametros = {
        "checkboxs" : toPost,
        "idAsig": Number(p[0]['LAST_INSERT_ID()']),
      }
      await $.ajax({
        url: "controller/ingresaCheckboxAsignacion.php",
        type:"POST",
        data:{
          "checkboxs" : toPost,
          "idAsig": Number(p[0]['LAST_INSERT_ID()']),
        },
        success: async function (res1){
          await $.ajax({
            url: "controller/generaPDF/asignacionChecklistVehiculo.php?idLoad=205",
            type: "POST",
            data:{
              "idAsig": Number(p[0]['LAST_INSERT_ID()']),
              "url": window.location.toString().split("?")[0]
            },
            success: async function (res2){
              window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/flota/asignaciones/checklist' + res2, '_blank');
              var p = res2.split(",");
              if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaListadoAsignacion').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Vehículo asignado correctamente");
                  $("#validarAsignacion").attr("disabled","disabled");
                  $("#anularAsignacion").attr("disabled","disabled");
                  $("#subirPdfAsignacion").attr("disabled","disabled");

                  await $.ajax({
                    url:   'controller/datosSelectorPeriodosAsignaciones.php',
                    type:  'post',
                    success: function (response) {
                      var p = jQuery.parseJSON(response);
                      var cuerpoSelect = '';
                      if(p.aaData.length !== 0) {
                        for(var i = 0; i < p.aaData.length; i++){
                          if(i == 0){
                            cuerpoSelect += '<option select value="' + p.aaData[i].PERIODO + '">' + p.aaData[i].PERIODO + '</option>';
                          }
                          else{
                            cuerpoSelect += '<option value="' + p.aaData[i].PERIODO + '">' + p.aaData[i].PERIODO + '</option>';
                          }
                        }
                        $("#fechaAsignacion").html(cuerpoSelect);
                      }
                      else{
                        cuerpoSelect = '<option value="' + moment().format('YYYY-MM').toString() + '">' + moment().format('YYYY-MM').toString() + '</option>';
                        $("#fechaAsignacion").html(cuerpoSelect);
                      }

                      if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                        $("#fechaAsignacion").select2('destroy').select2({
                            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                        });
                      }

                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                      },500);
                    }
                  });
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar Vehiculo, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar Vehiculo, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
          });
        }
      });
    }
  });
});
// FIN FUNCION PARA MODAL CREAR ASIGNACION VEHICULO

function menuElegant(){
  $("#contenido").css("height",$(window).height()-20);
  setTimeout(function(){
    $('#contenido').overlayScrollbars({
      className: "os-theme-round-dark",
      autoUpdate: true,
      nativeScrollbarsOverlaid : {
        showNativeScrollbars   : false,
        initialize             : true
      },
      overflowBehavior: {
        x: 'hidden',
        y : "scroll"
      },
      resize: "none",
      scrollbars: {
        autoHide: "never",
        touchSupport: true,
      }
    });
  },500);
}

// FUNCION PARA MODAL SUBIR PDF ASIGNACION VEHICULO
// Primero cargamos los archivos
$("#pdfCargaChecklist" ).on('change', function(e){
  var file = e.target.files[0].name; // agarramos solo el nombre([0].name) del array que tiene tamaño, fecha y mas
  $("#inputPdfChecklist").val(file);
  $("#inputPdfChecklist").removeClass("is-invalid");
});

$("#pdfCargaLicencia" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfLicencia").val(file);
  $("#inputPdfLicencia").removeClass("is-invalid");
});

$("#pdfCargaAsignacion" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfAsignacion").val(file);
  $("#inputPdfAsignacion").removeClass("is-invalid");
});

$("#subirPdfAsignacion").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoAsignacion').DataTable();
  var idAsig = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_ASIGNACIONES;
  });
  var patente = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO;
  });

  $("#tituloSubirPdfAsignacionVehiculo").html('Patente: ' + patente);

  var parametros = {
    "idAsig" : idAsig[0]
  }
  await $.ajax({
    url:   'controller/datosPdfAsignacionVehiculo.php',
    type:  'post',
    data: parametros,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      checklist = p3.aaData[0].CHECKLIST;
      lic = p3.aaData[0].LIC;
      asig = p3.aaData[0].ASIG;
      contadorChecklist = p3.aaData[0].CONTADORCHECKILIST;
      contadorLic = p3.aaData[0].CONTADORLIC;
      contadorAsig = p3.aaData[0].CONTADORASIG;
    }
  });

  if(contadorChecklist == null || contadorChecklist == 1){
    $("#inputPdfChecklist").val(checklist);
    $("#spanChecklist").html("<font> </font>");
    $("#pdfCargaChecklist").removeAttr("disabled");
  }
  else{
    $("#spanChecklist").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfChecklist").val(checklist);
    $("#pdfCargaChecklist").attr("disabled","disabled");
  }

  if(contadorLic == null || contadorLic == 1){
    $("#inputPdfLicencia").val(lic);
    $("#spanLicencia").html("<font> </font>");
    $("#pdfCargaLicencia").removeAttr("disabled");
  }
  else{
    $("#spanLicencia").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfLicencia").val(lic);
    $("#pdfCargaLicencia").attr("disabled","disabled");
  }

  if(contadorAsig == null || contadorAsig == 1){
    $("#inputPdfAsignacion").val(asig);
    $("#spanAsignacion").html("<font> </font>");
    $("#pdfCargaAsignacion").removeAttr("disabled");
  }
  else{
    $("#spanAsignacion").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfAsignacion").val(asig);
    $("#pdfCargaAsignacion").attr("disabled","disabled");
  }

  if(contadorChecklist == 1 || contadorLic == 1){
    $("#pdfCargaAsignacion").attr("disabled","disabled");
  }
  else{
    $("#pdfCargaAsignacion").removeAttr("disabled");
  }

  $("#pdfCargaChecklist").val('');
  $("#inputPdfChecklist").removeClass("is-invalid");

  $("#pdfCargaLicencia").val('');
  $("#inputPdfLicencia").removeClass("is-invalid");

  $("#pdfCargaAsignacion").val('');
  $("#inputPdfAsignacion").removeClass("is-invalid");

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalSubirPdfAsignacionVehiculo").modal("show");
  },500);
});

$("#guardarSubirPdfAsignacionVehiculo").unbind("click").click( async function(){
  var table = $('#tablaListadoAsignacion').DataTable();
  var idAsig = $.map(table.rows('.selected').data(), function (item) {
    return item.IDPATENTE_ASIGNACIONES;
  });
  var patente = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO;
  });

  var parametros = {
    "idAsig" : idAsig[0]
  }
  await $.ajax({
    url:   'controller/datosPdfAsignacionVehiculo.php',
    type:  'post',
    data: parametros,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      contadorChecklist = p3.aaData[0].CONTADORCHECKILIST;
      contadorLic = p3.aaData[0].CONTADORLIC;
      contadorAsig = p3.aaData[0].CONTADORASIG;
    }
  });

  if(($("#inputPdfChecklist").val() != '' && contadorChecklist != 2) || ($("#inputPdfLicencia").val() != '' && contadorLic != 2) || ($("#inputPdfAsignacion").val() != '' && contadorAsig != 2)){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalSubirPdfAsignacionVehiculo").modal("hide");

    var formdata = new FormData();
    formdata.append('idAsig',idAsig);
    formdata.append('pdfChecklist',$("#pdfCargaChecklist")[0].files[0]);
    formdata.append('pdfLicencia',$("#pdfCargaLicencia")[0].files[0]);
    formdata.append('pdfAsig',$("#pdfCargaAsignacion")[0].files[0]);

    $.ajax({
      url: "controller/ingresaPdfAsignacionVehiculo.php",
      type: 'POST',
      data: formdata,
      cache: false,
      contentType: false,
      processData: false,
      success: function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            // generamos pdf Asignacion
            $.ajax({
              url: "controller/generaPDF/asignacionVehiculo.php?idLoad=205",
              type: "POST",
              data:{
                "idAsig": idAsig[0],
                "patente": patente[0],
                "url": window.location.toString().split("?")[0]
              },
              success: function (res2){
                if(res2 === "Sin_datos" || res2 === ""){
                  var table = $('#tablaListadoAsignacion').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>PDF cargado correctamente");
                  $("#validarAsignacion").attr("disabled","disabled");
                  $("#anularAsignacion").attr("disabled","disabled");
                  $("#subirPdfAsignacion").attr("disabled","disabled");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
                else{
                  window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/flota/asignaciones/asignacion' + res2, '_blank');
                  var table = $('#tablaListadoAsignacion').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>PDF de asignacion creado correctamente");
                  $("#validarAsignacion").attr("disabled","disabled");
                  $("#anularAsignacion").attr("disabled","disabled");
                  $("#subirPdfAsignacion").attr("disabled","disabled");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
            });
          }
        }
      }
    });
}
  else{
    if(contadorChecklist != 2){
      $("#inputPdfChecklist").addClass("is-invalid");
    }
    if(contadorLic != 2){
      $("#inputPdfLicencia").addClass("is-invalid");
    }
    if(contadorAsig != 2){
      $("#inputPdfAsignacion").addClass("is-invalid");
    }
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se ha cargado ningun PDF");
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
    },500);
  }
});
// FIN FUNCION PARA MODAL SUBIR PDF ASIGNACION VEHICULO

// EVENTO PARA ABRIR PDF ASIGNACION VEHICULO
async function pdf_Asig_Vehiculo(pdf){
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    window.open(window.location.toString().split("#/")[0].split('?')[0] + 'controller/repositorio/flota/asignaciones/' + pdf, '_blank');
  }
}
// FIN EVENTO PARA ABRIR PDF ASIGNACION VEHICULO

// FUNCION PARA MODAL VALIDAR ASIGNACION VEHICULO
$("#validarAsignacion").unbind('click').click(function(){
  var table = $('#tablaListadoAsignacion').DataTable();
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.CODIGO;
  });
  var personal = $.map(table.rows('.selected').data(), function (item) {
    return item.PERSONAL;
  });

  $("#patenteValidarAsignacion").html(patente);
  $("#personalValidarAsignacion").html(personal);
  $('#modalValidarAsignacionVehiculo').modal('show');
});

$("#guardarValidarAsignacionVehiculo").unbind('click').click(async function(){
  var table = $('#tablaListadoAsignacion').DataTable();
  var idAsig = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_ASIGNACIONES;
  });
  var patente = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO;
  });
  var dni = $.map(table.rows('.selected').data(), function (item) {
    return item.DNI;
  });
  var personal = $.map(table.rows('.selected').data(), function (item) {
    return item.PERSONAL;
  });

  parametros = {
    "idAsig": idAsig[0],
    "dni": dni[0],
    "personal": personal[0],
    "patente": patente[0]
  }
  $("#modalValidarAsignacionVehiculo").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/validarAsignacionVehiculo.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoAsignacion').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Asignación validada correctamente");
            $("#validarAsignacion").attr("disabled","disabled");
            $("#anularAsignacion").attr("disabled","disabled");
            $("#subirPdfAsignacion").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al Validar la Asignacion");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al Validar la Asignacion");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL VALIDAR ASIGNACION VEHICULO

// FUNCION PARA MODAL ANULAR ASIGNACION VEHICULO
$("#anularAsignacion").unbind('click').click(function(){
  var table = $('#tablaListadoAsignacion').DataTable();
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.CODIGO;
  });
  var personal = $.map(table.rows('.selected').data(), function (item) {
    return item.PERSONAL;
  });

  $("#patenteAnularAsignacion").html(patente);
  $("#personalAnularAsignacion").html(personal);
  $('#modalAnularAsignacionVehiculo').modal('show');
});

$("#guardarAnularAsignacionVehiculo").unbind('click').click(async function(){
  var table = $('#tablaListadoAsignacion').DataTable();
  var idAsig = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_ASIGNACIONES;
  });
  var dni = $.map(table.rows('.selected').data(), function (item) {
    return item.DNI;
  });
  var patente = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO;
  });
  var personal = $.map(table.rows('.selected').data(), function (item) {
    return item.PERSONAL;
  });
  parametros = {
    "idAsig": idAsig[0],
    "dni": dni[0],
    "personal": personal[0],
    "patente": patente[0],
  }
  $("#modalAnularAsignacionVehiculo").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/anularAsignacionVehiculo.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoAsignacion').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Asignación Anulada correctamente");
            $("#validarAsignacion").attr("disabled","disabled");
            $("#anularAsignacion").attr("disabled","disabled");
            $("#subirPdfAsignacion").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al Anular la Asignacion");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al Anular la Asignacion");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL ANULAR ASIGNACION VEHICULO

// FUNCION PARA MODAL INGRESAR CLAUSULAS
$("#agregarClausula").unbind("click").click(async function(){
  $("#modalIngresoClausulas").find("input,textarea,select").val("");
  $("#clausulaIngresoClausulas").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  setTimeout(function(){
    $("#modalIngresoClausulas").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoClausulas').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarIngresoClausulas").unbind('click').click(function(){
  if($("#clausulaIngresoClausulas").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#clausulaIngresoClausulas").val().length == 0){
      $("#clausulaIngresoClausulas").addClass("is-invalid");
    }
  }
  else {
    parametros = {
      "clausula": $("#clausulaIngresoClausulas").val(),
    }
    $("#modalIngresoClausulas").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaClausulas.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoClausulas').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Cláusula Creado correctamente");
            $("#editarClausula").attr("disabled","disabled");
            $("#eliminarClausula").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Cláusula, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear Cláusula, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#clausulaIngresoClausulas").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN PARA MODAL INGRESAR CLAUSULAS

// FUNCION PARA MODAL EDITAR CLAUSULAS
$("#editarClausula").unbind('click').click( async function(){
  var table = $('#tablaListadoClausulas').DataTable();
  var clausula = $.map(table.rows('.selected').data(), function (item) {
      return item.CLAUSULA;
  });
  $("#clausulaEditarClausulas").val(clausula);
  $('#modalEditarClausulas').modal('show');
});

$("#guardarEditarClausulas").unbind('click').click(function(){
  var table = $('#tablaListadoClausulas').DataTable();
  var idClausulas = $.map(table.rows('.selected').data(), function (item) {
    return item.IDPATENTE_CLAUSULAS;
  });
  parametros = {
    "idClausulas": idClausulas[0],
    "clausula":  $("#clausulaEditarClausulas").val(),
  }
  $("#modalEditarClausulas").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarClausulas.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoClausulas').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Cláusula Editada correctamente");
          $("#editarClausula").attr("disabled","disabled");
          $("#eliminarClausula").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Cláusula, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Cláusula, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL EDITAR CLAUSULAS

// FUNCION PARA MODAL ELIMINAR CLAUSULAS
$("#eliminarClausula").unbind('click').click(function(){
  var table = $('#tablaListadoClausulas').DataTable();
  var clausula = $.map(table.rows('.selected').data(), function (item) {
    return item.CLAUSULA;
  });

  $("#clausulaEliminarClausulas").html(clausula);
  $('#modalEliminarClausulas').modal('show');
});

$("#guardarEliminarClausulas").unbind('click').click(async function(){
  var table = $('#tablaListadoClausulas').DataTable();
  var idClausulas = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_CLAUSULAS;
  });
  parametros = {
    "idClausulas": idClausulas[0],
  }
  $("#modalEliminarClausulas").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarClausulas.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoClausulas').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Cláusula eliminada correctamente");
            $("#editarClausula").attr("disabled","disabled");
            $("#eliminarClausula").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar la Cláusula");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar la Cláusula");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
//  FIN FUNCION PARA MODAL ELIMINAR CLAUSULAS

// Funcion para el filtro por periodo de asignacion (Cambio de fecha)
$("#fechaAsignacion").unbind("click").change(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  var parametros = {
    "path": path,
    "ano": $("#fechaAsignacion").val().split("-")[0],
    "mes": $("#fechaAsignacion").val().split("-")[1]
  }

  await $('#tablaListadoAsignacion').DataTable( {
      ajax: {
          url: "controller/datosAsignacionVehiculo.php",
          type: 'POST',
          data: parametros,
      },
      columns: [
          { data: 'S'},
          { data: 'IDPATENTE_ASIGNACIONES' },
          { data: 'CODIGO'},
          { data: 'FECHA'},
          { data: 'HORA' },
          { data: 'TIPO' },
          { data: 'COMUNA' },
          { data: 'DNI'},
          { data: 'PERSONAL'},
          { data: 'TELEFONO'},
          { data: 'SERVICIO' },
          { data: 'CLIENTE'},
          { data: 'ACTIVIDAD'},
          { data: 'ESTADO'},
          { data: 'CHECKLIST', className: "centerDataTable" },
          { data: 'LIC', className: "centerDataTable" },
          { data: 'ASIG', className: "centerDataTable" }
      ],
      buttons: [
          {
            extend: 'excel',
            exportOptions: {
              columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16 ]
            },
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          },
          {
            text: '<span class="fas fa-arrow-alt-circle-up" id="spanButtonFiltrosListadoAsignaciones"></span>&nbsp;&nbsp;Filtros',
            action: function(){
              if($("#filtrosListadoAsignaciones").height() > 100){
                $("#filtrosListadoAsignaciones").css("height","0");
                $("#filtrosListadoAsignaciones").fadeOut();
                $("#spanButtonFiltrosListadoAsignaciones").removeClass("fas fa-arrow-alt-circle-up");
                $("#spanButtonFiltrosListadoAsignaciones").addClass("fas fa-arrow-alt-circle-down");
              }
              else{
                if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                  $("#filtrosListadoAsignaciones").css("height","100pt");
                }
                else{
                  $("#filtrosListadoAsignaciones").css("height","180pt");
                }
                $("#filtrosListadoAsignaciones").fadeIn();
                $("#spanButtonFiltrosListadoAsignaciones").removeClass("fas fa-arrow-alt-circle-down");
                $("#spanButtonFiltrosListadoAsignaciones").addClass("fas fa-arrow-alt-circle-up");
              }
            }
          }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        // {
        //   "orderable": false,
        //   "className": 'select-checkbox',
        //   "targets": [ 0 ]
        // },
      ],
      "select": {
          style: 'single'
      },
      "scrollX": false,
      "responsive": {
          details: {
              renderer: function ( api, rowIdx, columns ) {
                  var data = $.map( columns, function ( col, i ) {
                      return col.hidden ?
                          '<tr data-dt-row="'+col.rowIndex+'" data-dt-column="'+col.columnIndex+'">'+
                              '<td style="font-weight: bold; min-width: 150px;">'+col.title+':'+'</td> '+
                              '<td style="min-width: 150px; text-align: center;">'+col.data+'</td>'+
                          '</tr>' :
                          '';
                  } ).join('');

                  return data ?
                      $('<table/>').append( data ) :
                      false;
              }
          }
      },
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function(){
        setTimeout(function(){
          if ($('#filtroEstadoAsignacion').prop('checked') ) {
            var table = $("#tablaListadoAsignacion").DataTable();
            table.columns('13').search('').draw();
          }
          else{
            var table = $("#tablaListadoAsignacion").DataTable();

            var val = [];

            val.push("Generada");
            val.push("En Revisión");

            var data = val.join('|');

            table.column('13').search( data ? data : '', true, false ).draw();
          }

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        },500);
      }
  });
});
// Fin Funcion para el filtro por periodo de asignacion (Cambio de fecha)

// Filtro para el Checkbox de Asignacion que habilita la visualizacion de Validadas y Anuladas
$('#filtroEstadoAsignacion').on('change', function() {
  if ($('#filtroEstadoAsignacion').prop('checked') ) {
    var table = $("#tablaListadoAsignacion").DataTable();
    table.columns('13').search('').draw();
  }
  else{
    var table = $("#tablaListadoAsignacion").DataTable();

    var val = [];

    val.push("Generada");
    val.push("En Revisión");

    var data = val.join('|');

    table.column('13').search( data ? data : '', true, false ).draw();
  }
});
// Fin del Filtro para el Checkbox de Asignacion que habilita la visualizacion de Validadas y Anuladas

// FUNCION PARA MODAL CREAR DESASIGNACION VEHICULO
$("#agregarDesasignacion").unbind("click").click(async function(){
  $("#guardarDesasignacionVehiculo").attr("disabled","disabled");
  $("#patenteDesasignacionVehiculo").removeClass("is-invalid");
  $("#rutDesasignacionVehiculo").removeClass("is-invalid");
  $("#rutDesasignacionVehiculo").val("");
  $("#nombreDesasignacionVehiculo").val("");
  $("#patenteDesasignacionVehiculo").val("");
  $("#marcaDesasignacionVehiculo").val("");
  $("#anoDesasignacionVehiculo").val("");
  $("#modeloDesasignacionVehiculo").val("");
  $("#telefonoDesasignacionVehiculo").val("");
  $("#bodegaDesasignacionVehiculo").val("");
  $("#kilometrajeDesasignacionVehiculo").val("");
  $("#kilometrajeDesasignacionVehiculo").removeClass("is-invalid");
  $("#negocioDesasignacionVehiculo").val("");
  $("#observacionDesasignacionVehiculo").val("");
  $("#patenteDesasignacionVehiculo").removeAttr("disabled","disabled");
  $("#rutDesasignacionVehiculo").removeAttr("disabled","disabled");
  $("#nombreDesasignacionVehiculo").attr("disabled","disabled");
  $("#marcaDesasignacionVehiculo").attr("disabled","disabled");
  $("#anoDesasignacionVehiculo").attr("disabled","disabled");
  $("#modeloDesasignacionVehiculo").attr("disabled","disabled");
  $("#telefonoDesasignacionVehiculo").attr("disabled","disabled");
  $("#bodegaDesasignacionVehiculo").attr("disabled","disabled");
  $("#negocioDesasignacionVehiculo").attr("disabled","disabled");
  $("#licenciaDesasignacionVehiculo").html("");
  $("#proyectoDesasignacionVehiculo").html("");
  $("#checkboxDesasigancion").html("");
  $("#rutDesasignacionVehiculo").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url:   'controller/datosAsignacionesValidadas.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var listaPersonalUsuario = [];
        for(var i = 0; i < p.aaData.length; i++) {
          listaPersonalUsuario.push(p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRE + ' - ' + p.aaData[i].CODIGO);
        }
        $('#rutDesasignacionVehiculo').autocomplete({
          // req will contain an object with a "term" property that contains the value
          // currently in the text input.  responseFn should be invoked with the options
          // to display to the user.
          source: function (req, responseFn) {
            // Escape any RegExp meaningful characters such as ".", or "^" from the
            // keyed term.
            var term = $.ui.autocomplete.escapeRegex(req.term),
              // '^' is the RegExp character to match at the beginning of the string.
              // 'i' tells the RegExp to do a case insensitive match.
              matcher = new RegExp(term, 'i'),
              // Loop over the options and selects only the ones that match the RegExp.
              matches = $.grep(listaPersonalUsuario, function (item) {
                return matcher.test(item);
              });
            // Return the matched options.
            responseFn(matches);
          }
        });
      }
    }
  });

  await $.ajax({
    url:   'controller/datosAsignacionesValidadas.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var listaPersonalUsuario = [];
        for(var i = 0; i < p.aaData.length; i++) {
          listaPersonalUsuario.push(p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE + ' - ' + p.aaData[i].DNI);
        }
        $('#patenteDesasignacionVehiculo').autocomplete({
          // req will contain an object with a "term" property that contains the value
          // currently in the text input.  responseFn should be invoked with the options
          // to display to the user.
          source: function (req, responseFn) {
            // Escape any RegExp meaningful characters such as ".", or "^" from the
            // keyed term.
            var term = $.ui.autocomplete.escapeRegex(req.term),
              // '^' is the RegExp character to match at the beginning of the string.
              // 'i' tells the RegExp to do a case insensitive match.
              matcher = new RegExp(term, 'i'),
              // Loop over the options and selects only the ones that match the RegExp.
              matches = $.grep(listaPersonalUsuario, function (item) {
                return matcher.test(item);
              });
            // Return the matched options.
            responseFn(matches);
          }
        });
      }
    }
  });

  setTimeout(function(){
    var h = $(window).height() - 240;
    $("#bodyDesasignacionVehiculo").css("height",h);
    $("#modalDesasignacionVehiculo").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyDesasignacionVehiculo').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#patenteDesasignacionVehiculo").focusout(function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  patente = $("#patenteDesasignacionVehiculo").val().split(" - ")[0];
  rut = $("#patenteDesasignacionVehiculo").val().split(" - ")[2];
  if(patente.length > 5){
    $('#modalDesasignacionVehiculo').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    rut = $("#patenteDesasignacionVehiculo").val().split(" - ")[2];
    var parametros = {
      "patente": patente,
      "rut": rut
    }
    $.ajax({
      url:   'controller/datosAsignacionValidadaSelectForPatente.php',
      type:  'post',
      data: parametros,
      success: function (response3) {
        if(response3.localeCompare("Sin datos") != 0 && response3 != ""){
          var p3 = jQuery.parseJSON(response3);
          $("#rutDesasignacionVehiculo").val(rut);
          $("#guardarDesasignacionVehiculo").removeAttr("disabled");
          $("#rutDesasignacionVehiculo").attr("disabled","disabled");
          $("#nombreDesasignacionVehiculo").val(p3.aaData[0].NOMBRE);
          $("#nombreDesasignacionVehiculo").attr("disabled","disabled");
          $("#patenteDesasignacionVehiculo").val(p3.aaData[0].CODIGO);
          $("#marcaDesasignacionVehiculo").val(p3.aaData[0].MARCA);
          $("#marcaDesasignacionVehiculo").attr("disabled","disabled");
          $("#anoDesasignacionVehiculo").val(p3.aaData[0].ANO);
          $("#anoDesasignacionVehiculo").attr("disabled","disabled");
          $("#modeloDesasignacionVehiculo").val(p3.aaData[0].MODELO);
          $("#modeloDesasignacionVehiculo").attr("disabled","disabled");
          $("#telefonoDesasignacionVehiculo").val(p3.aaData[0].TELEFONO);
          $("#telefonoDesasignacionVehiculo").attr("disabled","disabled");
          $("#bodegaDesasignacionVehiculo").val(p3.aaData[0].COMUNA);
          $("#bodegaDesasignacionVehiculo").attr("disabled","disabled");
          $("#kilometrajeDesasignacionVehiculo").val(p3.aaData[0].KILOMETRAJE);
          $("#negocioDesasignacionVehiculo").val(p3.aaData[0].NEGOCIO);
          $("#negocioDesasignacionVehiculo").attr("disabled","disabled");
          $("#observacionDesasignacionVehiculo").val(p3.aaData[0].OBSERVACION);
          $("#proyectoDesasignacionVehiculo").html(p3.aaData[0].NEGOCIO + ' - ' + p3.aaData[0].NOMENCLATURA);
          $("#licenciaDesasignacionVehiculo").html(p3.aaData[0].LICENCIA);

          idAsig = p3.aaData[0].IDPATENTE_ASIGNACIONES;
          $("#idAsigDesasignacionVehiculo").val(idAsig);
          var param = {
            "idAsig" : idAsig
          }
          $.ajax({
            url:   'controller/datosCheckboxDesasignacion.php',
            type:  'post',
            data: param,
            success: function (response2) {
              var p2 = jQuery.parseJSON(response2);
              if(p2.aaData.length !== 0){
                var cuerpoC = '';
                for(i = 0; i < p2.aaData.length; i++){
                  if(p2.aaData[i].DATO === "Si"){
                    cuerpoC += '<div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;">';
                    cuerpoC += '<label class="switch"><input name="checkDesasignacion" value="' + p2.aaData[i].IDPATENTE_ASIGNACION_CHECKS + '" type="checkbox" checked="checked"><span class="slider round"></span></label>&nbsp;&nbsp;<label>' + p2.aaData[i].ITEM + ' <span style="color:red;" id="valor' + p2.aaData[i].IDPATENTE_ASIGNACION_CHECKS + '"></span></label>';
                    cuerpoC += '</div>';
                  }
                  else{
                    cuerpoC += '<div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;">';
                    cuerpoC += '<label class="switch"><input name="checkDesasignacion" value="' + p2.aaData[i].IDPATENTE_ASIGNACION_CHECKS + '" type="checkbox"><span class="slider round"></span></label>&nbsp;&nbsp;<label>' + p2.aaData[i].ITEM + ' <span style="color:red;" id="valor' + p2.aaData[i].IDPATENTE_ASIGNACION_CHECKS + '"></span></label>';
                    cuerpoC += '</div>';
                  }
                }
                $("#checkboxDesasigancion").html(cuerpoC);

                setTimeout(function(){
                  $('input[name="checkDesasignacion"]').on('change', function(e) {
                    e.stopImmediatePropagation();

                    var bug= $(this).val();
                    if( $(this).is(':checked') ){
                      var dato = 'Si';
                    }else{
                      var dato = 'No';
                    }

                    var para = {
                      "idAsigCheck": bug,
                      "idAsig": $("#idAsigDesasignacionVehiculo").val(),
                    }
                    $.ajax({
                      url:   'controller/datosEstadoCheckAsig.php',
                      type:  'post',
                      data: para,
                      success: function (res) {
                        if(res.localeCompare("Sin datos") != 0 && res != ""){
                          var p3 = jQuery.parseJSON(res);
                          if(p3.aaData[0].DATO != dato){
                            $("#valor" + bug).html("<span class='fas fa-exclamation-triangle'></span>");
                            $("#valor" + bug).attr("name","D");
                          }else{
                            $("#valor" + bug).html("");
                            $("#valor" + bug).attr("name","");
                          }
                        }
                      }
                    });
                  });
                },500);
              }
            }
          });

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalDesasignacionVehiculo').modal('show');
          },500);
        }
        else{
          $.ajax({
            url:   'controller/datosChequeaPatente.php',
            type:  'post',
            data: parametros,
            success: function (response2) {
              if(response2.localeCompare("Sin datos") != 0 && response2 != ""){
                $('#modalAlertasSplash').modal('hide');
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La patente ingresada no está asignada a ningún colaborador");
                $("#patenteDesasignacionVehiculo").val("");
                $("#patenteDesasignacionVehiculo").addClass("is-invalid");
                setTimeout(function(){
                  $('#modalDesasignacionVehiculo').modal('show');
                },500);
              }
              else{
                $('#modalAlertasSplash').modal('hide');
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La patente ingresada no es válida o no pertenece a la empresa");
                $("#patenteDesasignacionVehiculo").val("");
                $("#patenteDesasignacionVehiculo").addClass("is-invalid");
                setTimeout(function(){
                  $('#modalDesasignacionVehiculo').modal('show');
                },500);
              }
            }
          });
        }
      }
    });
  }
});

$("#rutDesasignacionVehiculo").focusout(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#idAsigDesasignacionVehiculo").val("");
  vari = $("#rutDesasignacionVehiculo").val().split(" - ")[0];
  varp = $("#rutDesasignacionVehiculo").val().split(" - ")[2];
  if (vari.length > 8){
    $('#modalDesasignacionVehiculo').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var parametrosRut = {
      "rut": $.trim(vari.replace('.','').replace('.','')),
      "patente": varp
    }
    await $.ajax({
      url:   'controller/datosAsignacionValidadaSelect.php',
      type:  'post',
      data: parametrosRut,
      success: function (response3) {
        if(response3.localeCompare("Sin datos") != 0 && response3 != ""){
          var p3 = jQuery.parseJSON(response3);
          $("#rutDesasignacionVehiculo").val(vari);
          $("#guardarDesasignacionVehiculo").removeAttr("disabled");
          $("#nombreDesasignacionVehiculo").val(p3.aaData[0].NOMBRE);
          $("#nombreDesasignacionVehiculo").attr("disabled","disabled");
          $("#patenteDesasignacionVehiculo").val(p3.aaData[0].CODIGO);
          $("#marcaDesasignacionVehiculo").val(p3.aaData[0].MARCA);
          $("#marcaDesasignacionVehiculo").attr("disabled","disabled");
          $("#anoDesasignacionVehiculo").val(p3.aaData[0].ANO);
          $("#anoDesasignacionVehiculo").attr("disabled","disabled");
          $("#modeloDesasignacionVehiculo").val(p3.aaData[0].MODELO);
          $("#modeloDesasignacionVehiculo").attr("disabled","disabled");
          $("#telefonoDesasignacionVehiculo").val(p3.aaData[0].TELEFONO);
          $("#telefonoDesasignacionVehiculo").attr("disabled","disabled");
          $("#bodegaDesasignacionVehiculo").val(p3.aaData[0].COMUNA);
          $("#bodegaDesasignacionVehiculo").attr("disabled","disabled");
          $("#kilometrajeDesasignacionVehiculo").val(p3.aaData[0].KILOMETRAJE);
          $("#negocioDesasignacionVehiculo").val(p3.aaData[0].NEGOCIO);
          $("#negocioDesasignacionVehiculo").attr("disabled","disabled");
          $("#observacionDesasignacionVehiculo").val(p3.aaData[0].OBSERVACION);
          $("#proyectoDesasignacionVehiculo").html(p3.aaData[0].NEGOCIO + ' - ' + p3.aaData[0].NOMENCLATURA);
          $("#licenciaDesasignacionVehiculo").html(p3.aaData[0].LICENCIA);
          idAsig = p3.aaData[0].IDPATENTE_ASIGNACIONES;
          $("#idAsigDesasignacionVehiculo").val(idAsig);
          var param = {
            "idAsig" : idAsig
          }
          $.ajax({
            url:   'controller/datosCheckboxDesasignacion.php',
            type:  'post',
            data: param,
            success: function (response2) {
              var p2 = jQuery.parseJSON(response2);
              if(p2.aaData.length !== 0){
                var cuerpoC = '';
                for(i = 0; i < p2.aaData.length; i++){
                  if(p2.aaData[i].DATO === "Si"){
                    cuerpoC += '<div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;">';
                    cuerpoC += '<label class="switch"><input name="checkDesasignacion" value="' + p2.aaData[i].IDPATENTE_ASIGNACION_CHECKS + '" type="checkbox" checked="checked"><span class="slider round"></span></label>&nbsp;&nbsp;<label>' + p2.aaData[i].ITEM + ' <span style="color:red;" id="valor' + p2.aaData[i].IDPATENTE_ASIGNACION_CHECKS + '"></span></label>';
                    cuerpoC += '</div>';
                  }
                  else{
                    cuerpoC += '<div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;">';
                    cuerpoC += '<label class="switch"><input name="checkDesasignacion" value="' + p2.aaData[i].IDPATENTE_ASIGNACION_CHECKS + '" type="checkbox"><span class="slider round"></span></label>&nbsp;&nbsp;<label>' + p2.aaData[i].ITEM + ' <span style="color:red;" id="valor' + p2.aaData[i].IDPATENTE_ASIGNACION_CHECKS + '"></span></label>';
                    cuerpoC += '</div>';
                  }
                }
                $("#checkboxDesasigancion").html(cuerpoC);

                setTimeout(function(){
                  $('input[name="checkDesasignacion"]').on('change', function(e) {
                    e.stopImmediatePropagation();

                    var bug= $(this).val();
                    if( $(this).is(':checked') ){
                      var dato = 'Si';
                    }else{
                      var dato = 'No';
                    }

                    var para = {
                      "idAsigCheck": bug,
                      "idAsig": $("#idAsigDesasignacionVehiculo").val(),
                    }
                    $.ajax({
                      url:   'controller/datosEstadoCheckAsig.php',
                      type:  'post',
                      data: para,
                      success: function (res) {
                        if(res.localeCompare("Sin datos") != 0 && res != ""){
                          var p3 = jQuery.parseJSON(res);
                          if(p3.aaData[0].DATO != dato){
                            $("#valor" + bug).html("<span class='fas fa-exclamation-triangle'></span>");
                            $("#valor" + bug).attr("name","D");
                          }else{
                            $("#valor" + bug).html("");
                            $("#valor" + bug).attr("name","");
                          }
                        }
                      }
                    });
                  });
                },500);
              }
            }
          });
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalDesasignacionVehiculo').modal('show');
          },500);
        }
        else{
          $.ajax({
            url:   'controller/datosChequeaPersonal.php',
            type:  'post',
            data: parametrosRut,
            success: function (response2) {
              if(response2.localeCompare("Sin datos") != 0 && response2 != ""){
                $('#modalAlertasSplash').modal('hide');
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El DNI ingresado no tiene asignado ningún vehículo");
                $("#rutDesasignacionVehiculo").val("");
                $("#rutDesasignacionVehiculo").addClass("is-invalid");
                setTimeout(function(){
                  $('#modalDesasignacionVehiculo').modal('show');
                },500);
              }
              else{
                $('#modalAlertasSplash').modal('hide');
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El DNI es inválido o no pertenece a la empresa");
                $("#rutDesasignacionVehiculo").val("");
                $("#rutDesasignacionVehiculo").addClass("is-invalid");
                setTimeout(function(){
                  $('#modalDesasignacionVehiculo').modal('show');
                },500);
              }
            }
          });
        }
      }
    });
  }
});

$("#kilometrajeDesasignacionVehiculo").focusout(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  patente = $("#patenteDesasignacionVehiculo").val();
  rut = $("#rutDesasignacionVehiculo").val();
  var parametrosPatente = {
    "patente" : patente,
    "rut": rut
  }
  await $.ajax({
    url:   'controller/datosAsignacionValidadaSelectForPatente.php',
    type:  'post',
    data: parametrosPatente,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      var kil = p3.aaData[0].KILOMETRAJE;
      if(parseInt($("#kilometrajeDesasignacionVehiculo").val()) < parseInt(kil) || $("#kilometrajeDesasignacionVehiculo").val().length == 0){
        $("#kilometrajeDesasignacionVehiculo").val(kil);
        $("#kilometrajeDesasignacionVehiculo").addClass("is-invalid");
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un kilometraje menor al del sistema");
      }
    }
  });
});

$("#kilometrajeDesasignacionVehiculo").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#rutDesasignacionVehiculo").on('input', function(){
  $(this).removeClass("is-invalid");
  $("#kilometrajeDesasignacionVehiculo").removeClass("is-invalid");
  $("#guardarDesasignacionVehiculo").attr("disabled","disabled");
  $("#patenteDesasignacionVehiculo").removeClass("is-invalid");
  $("#nombreDesasignacionVehiculo").val("");
  $("#patenteDesasignacionVehiculo").val("");
  $("#marcaDesasignacionVehiculo").val("");
  $("#anoDesasignacionVehiculo").val("");
  $("#modeloDesasignacionVehiculo").val("");
  $("#telefonoDesasignacionVehiculo").val("");
  $("#bodegaDesasignacionVehiculo").val("");
  $("#kilometrajeDesasignacionVehiculo").val("");
  $("#negocioDesasignacionVehiculo").val("");
  $("#observacionDesasignacionVehiculo").val("");
  $("#patenteDesasignacionVehiculo").removeAttr("disabled","disabled");
  $("#nombreDesasignacionVehiculo").attr("disabled","disabled");
  $("#marcaDesasignacionVehiculo").attr("disabled","disabled");
  $("#anoDesasignacionVehiculo").attr("disabled","disabled");
  $("#modeloDesasignacionVehiculo").attr("disabled","disabled");
  $("#telefonoDesasignacionVehiculo").attr("disabled","disabled");
  $("#bodegaDesasignacionVehiculo").attr("disabled","disabled");
  $("#negocioDesasignacionVehiculo").attr("disabled","disabled");
  $("#licenciaDesasignacionVehiculo").html("");
  $("#proyectoDesasignacionVehiculo").html("");
  $("#checkboxDesasigancion").html("");
});
$("#patenteDesasignacionVehiculo").on('input', function(){
  $(this).removeClass("is-invalid");
  $("#kilometrajeDesasignacionVehiculo").removeClass("is-invalid");
  $("#guardarDesasignacionVehiculo").attr("disabled","disabled");
  $("#rutDesasignacionVehiculo").removeClass("is-invalid");
  $("#rutDesasignacionVehiculo").val("");
  $("#nombreDesasignacionVehiculo").val("");
  $("#marcaDesasignacionVehiculo").val("");
  $("#anoDesasignacionVehiculo").val("");
  $("#modeloDesasignacionVehiculo").val("");
  $("#telefonoDesasignacionVehiculo").val("");
  $("#bodegaDesasignacionVehiculo").val("");
  $("#kilometrajeDesasignacionVehiculo").val("");
  $("#negocioDesasignacionVehiculo").val("");
  $("#observacionDesasignacionVehiculo").val("");
  $("#rutDesasignacionVehiculo").removeAttr("disabled","disabled");
  $("#nombreDesasignacionVehiculo").attr("disabled","disabled");
  $("#marcaDesasignacionVehiculo").attr("disabled","disabled");
  $("#anoDesasignacionVehiculo").attr("disabled","disabled");
  $("#modeloDesasignacionVehiculo").attr("disabled","disabled");
  $("#telefonoDesasignacionVehiculo").attr("disabled","disabled");
  $("#bodegaDesasignacionVehiculo").attr("disabled","disabled");
  $("#negocioDesasignacionVehiculo").attr("disabled","disabled");
  $("#licenciaDesasignacionVehiculo").html("");
  $("#proyectoDesasignacionVehiculo").html("");
  $("#checkboxDesasigancion").html("");
});

// Funcion para el evento del boton guardar Asignacion del modal
$("#guardarDesasignacionVehiculo").unbind('click').click( async function(){
  var checkbox = new Array();
  $('#checkboxDesasigancion input[type=checkbox]').each(function(){
    var item = {};
    item.id = this.value;
    item.status = this.checked;
    item.span = $("#valor" + $(this).val()).attr("name");
    checkbox.push(item);
  });

  var toPost = JSON.stringify(checkbox);

  parametros = {
    "rutPersonal": $.trim($("#rutDesasignacionVehiculo").val().replace('.','').replace('.','')),
    "Patente": $("#patenteDesasignacionVehiculo").val(),
    "observacion": $("#observacionDesasignacionVehiculo").val(),
    "kilometraje": $("#kilometrajeDesasignacionVehiculo").val(),
  }
  $("#modalDesasignacionVehiculo").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url: "controller/desasignacionVehiculo.php",
    type: 'POST',
    data: parametros,
    success:  async function (response) {
      var p = jQuery.parseJSON(response);
      parametros1 = {
        "checkboxs" : toPost,
        "idDesasig": Number(p[0]['LAST_INSERT_ID()']),
      }
      await $.ajax({
        url: "controller/ingresaCheckboxDesasignacion.php",
        type:"POST",
        data: parametros1,
        success: async function (res1){
          await $.ajax({
            url: "controller/generaPDF/desasignacionChecklistVehiculo.php?idLoad=205",
            type: "POST",
            data:{
              "idDesasig": Number(p[0]['LAST_INSERT_ID()']),
              "url": window.location.toString().split("?")[0],
              "patente": $("#patenteDesasignacionVehiculo").val(),
              "rutPersonal": $.trim($("#rutDesasignacionVehiculo").val().replace('.','').replace('.',''))
            },
            success: function (res2){
              window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/flota/desasignaciones' + res2, '_blank');
              var p = res2.split(",");
              if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaListadoDesasignacion').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Vehículo Desasignado correctamente");
                  $("#anularDesasignacion").attr("disabled","disabled");
                  $("#subirPdfDesasignacion").attr("disabled","disabled");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al desasignar Vehiculo, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al desasignar Vehiculo, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
          });
        }
      });
    }
  });
})
// FIN FUNCION PARA MODAL CREAR DESASIGNACION VEHICULO

// EVENTO PARA ABRIR PDF DESASIGNACION VEHICULO
async function pdf_Desasig_Vehiculo(pdf){
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    window.open(window.location.toString().split("#/")[0].split('?')[0] + 'controller/repositorio/flota/desasignaciones/' + pdf, '_blank');
  }
}
// FIN EVENTO PARA ABRIR PDF ASIGNACION VEHICULO

// FUNCION PARA MODAL SUBIR PDF DESASIGNACION VEHICULO
// Primero cargamos los archivos
$("#pdfCargaChecklistDes" ).on('change', function(e){
  var file = e.target.files[0].name; // agarramos solo el nombre([0].name) del array que tiene tamaño, fecha y mas
  $("#inputPdfChecklistDes").val(file);
  $("#inputPdfChecklistDes").removeClass("is-invalid");
});

$("#subirPdfDesasignacion").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoDesasignacion').DataTable();
  var patente = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO;
  });
  var idDesasig = $.map(table.rows('.selected').data(), function (item) {
    return item.IDPATENTE_DESASIGNACIONES;
  });

  $("#tituloSubirPdfDesasignacionVehiculo").html('Patente: ' + patente);

  var parametros = {
    "idDesasig" : idDesasig[0]
  }
  await $.ajax({
    url:   'controller/datosPdfDesasignacionVehiculo.php',
    type:  'post',
    data: parametros,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      checklist = p3.aaData[0].CHECKLIST;
      contadorChecklist = p3.aaData[0].CONTADORCHECKILIST;
    }
  });

  if(contadorChecklist == null || contadorChecklist == 1){
    $("#inputPdfChecklistDes").val(checklist);
    $("#spanChecklistDes").html("<font> </font>");
    $("#pdfCargaChecklistDes").removeAttr("disabled");
  }
  else{
    $("#spanChecklistDes").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfChecklistDes").val(checklist);
    $("#pdfCargaChecklistDes").attr("disabled","disabled");
  }

  $("#pdfCargaChecklistDes").val('');
  $("#inputPdfChecklistDes").removeClass("is-invalid");

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalSubirPdfDesasignacionVehiculo").modal("show");
  },500);
});

$("#guardarSubirPdfDesasignacionVehiculo").unbind("click").click(async function(){
  var table = $('#tablaListadoDesasignacion').DataTable();
  var idDesasig = $.map(table.rows('.selected').data(), function (item) {
    return item.IDPATENTE_DESASIGNACIONES;
  });
  var patente = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO;
  });
  var rutPersonal = $.map(table.rows('.selected').data(), function (item) {
    return item.DNI;
  });
  var personal = $.map(table.rows('.selected').data(), function (item) {
    return item.PERSONAL;
  });

  var parametros = {
    "idDesasig" : idDesasig[0]
  }
  await $.ajax({
    url:   'controller/datosPdfDesasignacionVehiculo.php',
    type:  'post',
    data: parametros,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      contadorChecklist = p3.aaData[0].CONTADORCHECKILIST;
    }
  });

if(($("#inputPdfChecklistDes").val() != '' && contadorChecklist != 2)){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalSubirPdfDesasignacionVehiculo").modal("hide");

  var formdata = new FormData();
  formdata.append('idDesasig',idDesasig);
  formdata.append('patente',patente);
  formdata.append('rutPersonal',rutPersonal);
  formdata.append('personal',personal);
  formdata.append('pdfChecklist',$("#pdfCargaChecklistDes")[0].files[0]);

  $.ajax({
    url: "controller/ingresaPdfDesasignacion.php",
    type: 'POST',
    data: formdata,
    cache: false,
    contentType: false,
    processData: false,
    success: function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoDesasignacion').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>PDF cargado correctamente");
          $("#anularDesasignacion").attr("disabled","disabled");
          $("#subirPdfDesasignacion").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar PDF, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar PDF, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
  });
}
else{
  if(contadorChecklist != 2){
    $("#inputPdfChecklistDes").addClass("is-invalid");
  }
  var random = Math.round(Math.random() * (1000000 - 1) + 1);
  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se ha cargado ningun PDF");
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },500);
}
});
// FIN FUNCION PARA MODAL SUBIR PDF DESASIGNACION VEHICULO

$("#eliminarZonaOrden").unbind("click").click(function(){
  $("#modalEliminarZonaOrden").modal("show");
});

$("#guardarEliminarZonaOrden").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEliminarZonaOrden").modal("hide");
  var table = $("#tablaMantenedorZonas").DataTable();
  var datos = table.rows('.selected').data();
  var parametros;
  var idZonas = '';
  if(table.rows('.selected').data().length > 0){
    for(var i = 0; i < table.rows('.selected').data().length; i++){
      if(i == 0){
        idZonas += datos[i].FOLIO;
      }
      else{
        idZonas += ',' + datos[i].FOLIO;
      }
    }

    parametros = {
      "idZonas": idZonas
    }
  }

  $.ajax({
      url:   'controller/eliminarZonasOrden.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorZonas').DataTable();
            //table.rows('.selected').remove().draw();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Zona eliminada correctamente");
            $('#modalAlertasSplash').modal('hide');
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No es posible eliminar la zona configurada dado que posee personal u órdenes asignadas.");
            $('#modalAlertasSplash').modal('hide');
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No es posible eliminar la zona configurada dado que posee personal u órdenes asignadas.");
          $('#modalAlertasSplash').modal('hide');
        }
      }
    });
});

$("#activarZonaOrden").unbind("click").click(function(){
  var table = $("#tablaMantenedorZonas").DataTable();
  var datos = table.rows('.selected').data();
  var parametros;
  var idZonas = '';
  if(table.rows('.selected').data().length > 0){
    if(datos[0].ACTIVA == 'Habilitada'){
      $("#tituloActivarZonaOrden").html('Desactivar Zona');
      $("#detalleActivarZonaOrden").html('¿Está seguro que desea desactivar la zona seleccionada?');
    }
    else{
      $("#tituloActivarZonaOrden").html('Activar Zona');
      $("#detalleActivarZonaOrden").html('¿Está seguro que desea activar la zona seleccionada?');
    }
  }
  $("#modalActivarZonaOrden").modal("show");
});

$("#guardarActivarZonaOrden").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalActivarZonaOrden").modal("hide");
  var table = $("#tablaMantenedorZonas").DataTable();
  var datos = table.rows('.selected').data();
  var parametros;
  var idZonas = '';
  var activa = '';
  if(table.rows('.selected').data().length > 0){
    for(var i = 0; i < table.rows('.selected').data().length; i++){
      if(i == 0){
        idZonas += datos[i].FOLIO;
      }
      else{
        idZonas += ',' + datos[i].FOLIO;
      }
    }

    if(datos[0].ACTIVA == 'Habilitada'){
      activa = 0;
    }
    else{
      activa = 1;
    }

    parametros = {
      "idZonas": idZonas,
      "activa": activa
    }
  }

  $.ajax({
      url:   'controller/activarZonasOrden.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorZonas').DataTable();
            //table.rows('.selected').remove().draw();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Actualización ingresada correctamente");
            $('#modalAlertasSplash').modal('hide');
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear usuario, si el problema persiste favor comuniquese con soporte");
            $('#modalAlertasSplash').modal('hide');
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear usuario, si el problema persiste favor comuniquese con soporte");
          $('#modalAlertasSplash').modal('hide');
        }
      }
    });
});

$("#agregarZonaOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorZonas").DataTable();
  var datos = table.rows().data();

  await $.ajax({
    url:   'controller/datosProyectoConfigOrden.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoProyecto = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoProyecto += '<option value="' + p.aaData[i].ID_ESTRUCTURA + '" name="' + p.aaData[i].AREA + '">' + p.aaData[i].PROYECTO + '</option>';
        }
        $("#proyectoConfigurarZonas").html(cuerpoProyecto);
      }
    }
  });

  $("#divZonaConfigurarZonas").html('');
  $("#divZonaConfigurarZonas").append('<label style="font-weight: bold;">Zona Geográfica</label><select multiple id="zonaConfigurarZonas" class="form-control"></select>');

  var seleccionados = [];
  for(var z = 0; z < datos.length; z++){
    if($("#proyectoConfigurarZonas").val() == datos[z].IDESTRUCTURA_OPERACION){
      seleccionados.push(datos[z].IDAREAFUNCIONAL);
    }
  }

  await $.ajax({
    url:   'controller/datosAreaFuncionalConfigZonas.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoZona = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          var ing = 0;
          for(var j = 0; j < p.aaData.length; j++){
            if(p.aaData[i].IDAREAFUNCIONAL == seleccionados[j]){
              // cuerpoZona += '<option selected value="' + p.aaData[i].IDAREAFUNCIONAL + '">&nbsp;&nbsp;' + p.aaData[i].COMUNA + '</option>';
              ing = 1;
              break;
            }
          }
          if(ing == 0){
            cuerpoZona += '<option value="' + p.aaData[i].IDAREAFUNCIONAL + '">&nbsp;&nbsp;' + p.aaData[i].COMUNA + '</option>';
          }
        }
        $("#zonaConfigurarZonas").html(cuerpoZona);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoConfigurarZonas").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  $("#areaConfigurarZonas").val($("#proyectoConfigurarZonas").find('option:selected').attr("name"));
  await $("#zonaConfigurarZonas").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalConfigurarZonas").modal("show");
  },500);
});

$("#proyectoConfigurarZonas").unbind("click").change(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalConfigurarZonas").modal("hide");
  $('#modalAlertasSplash').modal('show');
  $("#areaConfigurarZonas").val($("#proyectoConfigurarZonas").find('option:selected').attr("name"));
  $("#zonaConfigurarZonas").multiSelect('deselect_all');
  var table = $("#tablaMantenedorZonas").DataTable();
  var datos = table.rows().data();
  var seleccionados = [];

  $("#divZonaConfigurarZonas").html('');
  $("#divZonaConfigurarZonas").append('<label style="font-weight: bold;">Zona Geográfica</label><select multiple id="zonaConfigurarZonas" class="form-control"></select>');

  var seleccionados = [];
  for(var z = 0; z < datos.length; z++){
    if($("#proyectoConfigurarZonas").val() == datos[z].IDESTRUCTURA_OPERACION){
      seleccionados.push(datos[z].IDAREAFUNCIONAL);
    }
  }

  await $.ajax({
    url:   'controller/datosAreaFuncionalConfigZonas.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoZona = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          var ing = 0;
          for(var j = 0; j < p.aaData.length; j++){
            if(p.aaData[i].IDAREAFUNCIONAL == seleccionados[j]){
              // cuerpoZona += '<option selected value="' + p.aaData[i].IDAREAFUNCIONAL + '">&nbsp;&nbsp;' + p.aaData[i].COMUNA + '</option>';
              ing = 1;
              break;
            }
          }
          if(ing == 0){
            cuerpoZona += '<option value="' + p.aaData[i].IDAREAFUNCIONAL + '">&nbsp;&nbsp;' + p.aaData[i].COMUNA + '</option>';
          }
        }
        $("#zonaConfigurarZonas").html(cuerpoZona);
      }
    }
  });
  $("#areaConfigurarZonas").val($("#proyectoConfigurarZonas").find('option:selected').attr("name"));
  await $("#zonaConfigurarZonas").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalConfigurarZonas").modal("show");
  },500);
});

$("#guardarConfigurarZonas").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalConfigurarZonas").modal("hide");
  var parametros = {
    "proyecto": $("#proyectoConfigurarZonas").val(),
    "zonas": $("#zonaConfigurarZonas").val()
  }

  $.ajax({
      url:   'controller/cargarZonasOrdenPreConfig.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorZonas').DataTable();
            //table.rows('.selected').remove().draw();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Zonas ingresadas correctamente");
            $('#modalAlertasSplash').modal('hide');
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar el proceso, si el problema persiste favor comuniquese con soporte");
            $('#modalAlertasSplash').modal('hide');
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar el proceso, si el problema persiste favor comuniquese con soporte");
          $('#modalAlertasSplash').modal('hide');
        }
      }
    });
});

// FUNCION PARA MODAL ANULAR DESASIGNACION VEHICULO
$("#anularDesasignacion").unbind('click').click(function(){
  var table = $('#tablaListadoDesasignacion').DataTable();
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.CODIGO;
  });
  var personal = $.map(table.rows('.selected').data(), function (item) {
    return item.PERSONAL;
  });

  $("#patenteAnularDesasignacion").html(patente);
  $("#personalAnularDesasignacion").html(personal);
  $('#modalAnularDesasignacionVehiculo').modal('show');
});

$("#guardarAnularDesasignacionVehiculo").unbind('click').click(async function(){
  var table = $('#tablaListadoDesasignacion').DataTable();
  var idDesasig = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_DESASIGNACIONES;
  });
  var dni = $.map(table.rows('.selected').data(), function (item) {
    return item.DNI;
  });
  var patente = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO;
  });
  var personal = $.map(table.rows('.selected').data(), function (item) {
    return item.PERSONAL;
  });
  parametros = {
    "idDesasig": idDesasig[0],
    "dni": dni[0],
    "personal": personal[0],
    "patente": patente[0],
  }
  $("#modalAnularDesasignacionVehiculo").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/anularDesasignacionVehiculo.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoDesasignacion').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Desasignación Anulada correctamente");
            $("#anularDesasignacion").attr("disabled","disabled");
            $("#subirPdfDesasignacion").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al Anular la Desasignacion");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al Anular la Desasignacion");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
  $('#modalAnularDesasignacionVehiculo').modal('hide');
});
// FIN FUNCION PARA MODAL ANULAR DESASIGNACION VEHICULO

$("#nuevaConfiguracion").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectIncidenciaEstructura").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectIncidenciaUsuario").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectIncidenciaSLATipo").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectIncidenciaSLAQuantity").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#selectIncidenciaEstructura").html('');
  await $.ajax({
    url: "controller/datosIncidenciaEstructura.php",
    type: 'POST',
    data: { },
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0) {

        var options = '';

        p.aaData.forEach(({
          IDINCIDENCIA_ESTRUCTURA,
          IDAREA,
          AREA,
          IDITEM,
          ITEM,
          IDELEME,
          ELEME,
          IDANOMA,
          ANOMA,
          IDDEPAR,
          DEPAR,
          IDALERT,
          ALERT,
          PRIORIDAD
        }) => {
          options += `
          <option value="${IDINCIDENCIA_ESTRUCTURA}">
            ${AREA} / ${ITEM} / ${ELEME} / ${ANOMA} / ${DEPAR}
          </option>`;
        });

        $("#selectIncidenciaEstructura").html(options);

      }
    }
  });

  $("#selectIncidenciaZona").html('');
  await $.ajax({
    url: "controller/datosSucursal.php",
    type: 'POST',
    data: { },
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0) {
        var options = '';
        p.aaData.forEach(({ IDSUCURSAL, COMUNA }) => {
          options += `<option value="${IDSUCURSAL}">&nbsp;&nbsp;${COMUNA}</option>`;
        });
        $("#selectIncidenciaZona").html(options);
      }
    }
  });
  $("#selectIncidenciaZona").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoZona' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectZona' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });

  $("#selectIncidenciaOperacion").html('');
  await $.ajax({
    url: "controller/datosEstructuraOperacion.php",
    type: 'POST',
    data: { },
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var options = '';
        p.aaData.forEach(({ IDESTRUCTURA_OPERACION, SERVICIO, CLIENTE, ACTIVIDAD }) => {
          options += `<option value="${IDESTRUCTURA_OPERACION}">&nbsp;&nbsp;${SERVICIO} - ${CLIENTE} - ${ACTIVIDAD}</option>`;
        });
        $("#selectIncidenciaOperacion").html(options);
      }
    }
  });
  $("#selectIncidenciaOperacion").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoOper' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectOper' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });

  $("#selectIncidenciaUsuario").html('');
  await $.ajax({
    url: "controller/datosUsuarios.php",
    type: 'POST',
    data: { },
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {

        var options = '';

        p.aaData.forEach(({
          RUT,
          EMAIL,
          NOMBRE,
          PERFIL,
          ESTADO
        }) => {
          if (ESTADO === 'Activo') {
            options += `
            <option value="${RUT}">
              ${RUT} - ${NOMBRE}
            </option>`;
          }
        });

        $("#selectIncidenciaUsuario").html(options);

      }
    }
  });

  $("#selectIncidenciaSLATipo").html('');
  var aaData = ['Días', 'Horas'];
  var options = '';
  aaData.forEach((p) => {
    options += `<option value="${p}">${p}</option>`;
  });
  $("#selectIncidenciaSLATipo").html(options);

  $("#selectIncidenciaSLAQuantity").html('');
  var aaData = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24];
  var options = '';
  aaData.forEach((p) => {
    options += `<option value="${p}">${p}</option>`;
  });
  $("#selectIncidenciaSLAQuantity").html(options);

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#modalNuevaConfiguracion").modal("show");
    $("#modalNuevaConfiguracion").css("z-index", "1050");
    $('#modalAlertasSplash').modal('hide');
  }, 500);
});

$("#eliminarConfiguracion").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#modalEliminarConfiguracion").modal("show");
    $("#modalEliminarConfiguracion").css("z-index", "1050");
    $('#modalAlertasSplash').modal('hide');
  }, 500);
});

$("#guardarEliminarConfiguracion").unbind("click").click(async function(){
  $("#modalEliminarConfiguracion").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var tableConConfiguracion = $('#tablaIncidenciaSinConfiguracion').DataTable();
  var datos = tableConConfiguracion.rows('.selected').data();

  var configsClean = [];
  var idsConfiguracion = [];
  for (var i = 0; i < datos.length; i++) {
    configsClean.push({
      S: datos[i].S,
      AREA: datos[i].AREA,
      ITEM: datos[i].ITEM,
      DEPARTAMENTO: datos[i].DEPARTAMENTO,
      SERVICIO: datos[i].SERVICIO,
      CLIENTE: datos[i].CLIENTE,
      ACTIVIDAD: datos[i].ACTIVIDAD,
      SUCURSAL: datos[i].SUCURSAL,
      COMUNA: datos[i].COMUNA,
      SLA: '',
      DNI_RESOLUTOR: '',
      NOMBRE_RESOLUTOR: ''
    });
    idsConfiguracion.push(datos[i].IDINCIDENCIA_CONFIGURACION);
  }

  await $.ajax({
    url: "controller/eliminarIncidenciaConfiguracion.php",
    type: 'POST',
    data: {
      idsConfiguracion: idsConfiguracion
    },
    success: async function (response) {
      tableConConfiguracion.rows('.selected').remove().draw();
      tableConConfiguracion.rows.add(configsClean)
      $("#nuevaConfiguracion").attr("disabled","disabled");
      $("#eliminarConfiguracion").attr("disabled","disabled");
      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
      },500);
    }
  });
});

// Filtro para el Checkbox de Desasignacion que habilita la visualizacion de Finalizadas y Anuladas
$('#filtroEstadoDesasignacion').on('change', function() {
  if ($('#filtroEstadoDesasignacion').prop('checked') ) {
    var table = $("#tablaListadoDesasignacion").DataTable();
    table.columns('13').search('').draw();
  }
  else{
    var table = $("#tablaListadoDesasignacion").DataTable();

    var val = [];

    val.push("Generada");
    val.push("En Revisión");

    var data = val.join('|');

    table.column('13').search( data ? data : '', true, false ).draw();
  }
});
// Fin del Filtro para el Checkbox de Desasignacion que habilita la visualizacion de Finalizadas y Anuladas

// Funcion para el filtro por periodo de desasignacion (Cambio de fecha)
$("#fechaDesasignacion").unbind("click").change(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  var parametros = {
    "path": path,
    "ano": $("#fechaDesasignacion").val().split("-")[0],
    "mes": $("#fechaDesasignacion").val().split("-")[1]
  }

  await $('#tablaListadoDesasignacion').DataTable( {
      ajax: {
          url: "controller/datosDesasignacionVehiculo.php",
          type: 'POST',
          data: parametros,
      },
      columns: [
          { data: 'S'},
          { data: 'IDPATENTE_DESASIGNACIONES' },
          { data: 'CODIGO'},
          { data: 'FECHA'},
          { data: 'HORA' },
          { data: 'TIPO' },
          { data: 'COMUNA' },
          { data: 'DNI'},
          { data: 'PERSONAL'},
          { data: 'TELEFONO'},
          { data: 'SERVICIO' },
          { data: 'CLIENTE'},
          { data: 'ACTIVIDAD'},
          { data: 'ESTADO'},
          { data: 'CHECKLIST', className: "centerDataTable" }
      ],
      buttons: [
          {
            extend: 'excel',
            exportOptions: {
              columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14 ]
            },
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        // {
        //   "orderable": false,
        //   "className": 'select-checkbox',
        //   "targets": [ 0 ]
        // },
      ],
      "select": {
          style: 'single'
      },
      "scrollX": false,
      "responsive": {
          details: {
              renderer: function ( api, rowIdx, columns ) {
                  var data = $.map( columns, function ( col, i ) {
                      return col.hidden ?
                          '<tr data-dt-row="'+col.rowIndex+'" data-dt-column="'+col.columnIndex+'">'+
                              '<td style="font-weight: bold; min-width: 150px;">'+col.title+':'+'</td> '+
                              '<td style="min-width: 150px; text-align: center;">'+col.data+'</td>'+
                          '</tr>' :
                          '';
                  } ).join('');

                  return data ?
                      $('<table/>').append( data ) :
                      false;
              }
          }
      },
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function(){
        setTimeout(function(){
          if ($('#filtroEstadoDesasignacion').prop('checked') ) {
            var table = $("#tablaListadoDesasignacion").DataTable();
            table.columns('13').search('').draw();
          }
          else{
            var table = $("#tablaListadoDesasignacion").DataTable();

            var val = [];

            val.push("Generada");
            val.push("En Revisión");

            var data = val.join('|');

            table.column('13').search( data ? data : '', true, false ).draw();
          }
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
  });
});
// Fin Funcion para el filtro por periodo de desasignacion (Cambio de fecha)

$("#comunaOrden").unbind("click").change(function(){
  var table = $("#tablaOrdenes").DataTable();
  var item = $("#comunaOrden").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('3').search(item).draw();
});

$("#categoriaOrden").unbind("click").change(function(){
  var table = $("#tablaOrdenes").DataTable();
  var item = $("#categoriaOrden").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('4').search(item).draw();
});

$("#tipoOrden").unbind("click").change(function(){
  var table = $("#tablaOrdenes").DataTable();
  var item = $("#tipoOrden").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('5').search(item).draw();
});

$("#estadoOrden").unbind("click").change(function(){
  var table = $("#tablaOrdenes").DataTable();
  var item = $("#estadoOrden").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('28').search(item).draw();
});

$("#subEstadoOrden").unbind("click").change(function(){
  var table = $("#tablaOrdenes").DataTable();
  var item = $("#subEstadoOrden").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('29').search(item).draw();
});

$("#tramoOrden").unbind("click").change(function(){
  var table = $("#tablaOrdenes").DataTable();
  var item = $("#tramoOrden").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('14').search(item).draw();
});

$("#reagendamientoOrden").unbind("click").change(function(){
  var table = $("#tablaOrdenes").DataTable();
  var item = $("#reagendamientoOrden").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('10').search(item).draw();
});

$("#proyectoOrden").unbind("click").change(function(){
  var table = $("#tablaOrdenes").DataTable();
  var item = $("#proyectoOrden").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('2').search(item).draw();
});

$("#agendarOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();
  var fc = '';
  if(datos[0].FECHA_AGENDA == null){
    fc = '';
  }
  else{
    fc = datos[0].FECHA_AGENDA;
  }
  // console.log(fc);
  var hc = '';
  if(datos[0].HORA_AGENDA == null){
    hc = '';
  }
  else{
    hc = datos[0].HORA_AGENDA.substring(0,5);
  }

  var fc_ok = '';
  if(datos[0].FECHA_AGENDA == null){
    fc_ok = '';
  }
  else{
    fc_ok = fc.toString() + ' ' + hc.toString();
  }

  $("#tituloAsignarAgendarOrden").html("<b>OT seleccionada: " + datos[0].FOLIO + "</b>");

  $('#fechaCompromisoAgendarOrden').val('');

  var min = moment().format('YYYY/MM/DD');
  $.datetimepicker.setLocale('es');
  $("#fechaCompromisoAgendarOrden").datetimepicker({
    format: 'Y-m-d H:i',
    minDate: min.toString(),
    step: 01
  });

  $("#fechaCompromisoAgendarOrden").val(fc_ok);

  var parametrosOrden = {
    "idEstructura": datos[0].IDESTRUCTURA_OPERACION
  }

  await $.ajax({
    url: "controller/datosOrdenesEstructura.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoTramosOrden = '';
        p.aaData.forEach(({ IDORDEN_TRAMO, TRAMO, INICIO, FIN }) => {
          if(TRAMO == datos[0].TRAMO){
            cuerpoTramosOrden += `<option selected value="${IDORDEN_TRAMO}">${TRAMO}</option>`;
          }else{
            cuerpoTramosOrden += `<option value="${IDORDEN_TRAMO}">${TRAMO}</option>`;
          }
        });
        $("#rangoAgendarOrden").html(cuerpoTramosOrden);
      }
    }
  });

  $("#rutClienteAgendarOrden").val('');
  $("#clienteAgendarOrden").val('');

  $("#rutClienteAgendarOrden").val(datos[0].DNI_CLIENTE);
  $("#clienteAgendarOrden").val(datos[0].NOMBRE_CLIENTE);

  await $.ajax({
    url: "controller/datosOrdenesZona.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoComunaOrden = '';
        var cuerpoRegionOrden = '';
        p.aaData.forEach(({ IDAREAFUNCIONAL, COMUNA, REGION }) => {
          if(IDAREAFUNCIONAL == datos[0].IDAREAFUNCIONAL){
            cuerpoComunaOrden += `<option selected value="${IDAREAFUNCIONAL}">${COMUNA}</option>`;
          }else{
            cuerpoComunaOrden += `<option value="${IDAREAFUNCIONAL}">${COMUNA}</option>`;
          }
          if(IDAREAFUNCIONAL == datos[0].IDAREAFUNCIONAL){
            cuerpoRegionOrden += `<option selected value="${IDAREAFUNCIONAL}">${REGION}</option>`;
          }else{
            cuerpoRegionOrden += `<option value="${IDAREAFUNCIONAL}">${REGION}</option>`;
          }
        });
        $("#comunaAgendarOrden").html(cuerpoComunaOrden);
        $("#regionAgendarOrden").html(cuerpoRegionOrden);
      }
    }
  });

  $("#direccionAgendarOrden").val('');
  $("#fonoAgendarOrden").val('');

  $("#direccionAgendarOrden").val(datos[0].DIRECCIONLIMPIA);
  $("#fonoAgendarOrden").val(datos[0].FONO_CLIENTE);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#rangoAgendarOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaAgendarOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#regionAgendarOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalAsignarAgendarOrden").modal("show")
  },500);
});

$("#guardarAsignarAgendarOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalAsignarAgendarOrden").modal("hide");
  $('#modalAlertasSplash').modal('show');

  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();

  var parametrosGO = {
    "fechaAgenda": $("#fechaCompromisoAgendarOrden").val().split(" ")[0],
    "horaAgenda": $("#fechaCompromisoAgendarOrden").val().split(" ")[1],
    "idTramo": $("#rangoAgendarOrden").val(),
    "fono": $("#fonoAgendarOrden").val(),
    "idOrden": datos[0].IDORDEN
  }

  $.ajax({
    url: "controller/actualizaOrgenAgenda.php",
    type: 'POST',
    data: parametrosGO,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaOrdenes').DataTable();
          table.ajax.reload();

          setTimeout(function(){
            var table = $('#tablaOrdenes').DataTable();

            var comunaOr = '';
            comunaOr += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(3).data().unique().length; i++){
              if(table.column(3).data().unique()[i] !== null){
                comunaOr += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
              }
            }
            $("#comunaOrden").html(comunaOr);

            var categoriaOr = '';
            categoriaOr += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(4).data().unique().length; i++){
              if(table.column(4).data().unique()[i] !== null){
                categoriaOr += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
              }
            }
            $("#categoriaOrden").html(categoriaOr);

            var tipoOr = '';
            tipoOr += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(5).data().unique().length; i++){
              if(table.column(5).data().unique()[i] !== null){
                tipoOr += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
              }
            }
            $("#tipoOrden").html(tipoOr);

            var estadoOr = '';
            estadoOr += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(27).data().unique().length; i++){
              if(table.column(27).data().unique()[i] !== null){
                estadoOr += '<option value="' + table.column(27).data().unique()[i] + '">' + table.column(27).data().unique()[i] + '</option>';
              }
            }
            $("#estadoOrden").html(estadoOr);

            var subEstadoOr = '';
            subEstadoOr += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(28).data().unique().length; i++){
              if(table.column(28).data().unique()[i] !== null){
                subEstadoOr += '<option value="' + table.column(28).data().unique()[i] + '">' + table.column(28).data().unique()[i] + '</option>';
              }
            }
            $("#subEstadoOrden").html(subEstadoOr);

            var tramoOr = '';
            tramoOr += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(13).data().unique().length; i++){
              if(table.column(13).data().unique()[i] !== null){
                tramoOr += '<option value="' + table.column(13).data().unique()[i] + '">' + table.column(13).data().unique()[i] + '</option>';
              }
            }
            $("#tramoOrden").html(tramoOr);

            var agendasOr = '';
            agendasOr += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(10).data().unique().length; i++){
              if(table.column(10).data().unique()[i] !== null){
                agendasOr += '<option value="' + table.column(10).data().unique()[i] + '">' + table.column(10).data().unique()[i] + '</option>';
              }
            }
            $("#reagendamientoOrden").html(agendasOr);

            var proyectoOr = '';
            proyectoOr += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(2).data().unique().length; i++){
              if(table.column(2).data().unique()[i] !== null){
                proyectoOr += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
              }
            }
            $("#proyectoOrden").html(proyectoOr);

            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              $("#comunaOrden").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $("#categoriaOrden").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $("#tipoOrden").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $("#tramoOrden").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $("#estadoOrden").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $("#subEstadoOrden").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $("#reagendamientoOrden").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                  sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
              });
              $("#proyectoOrden").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
            }


            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Agenda ingresada correctamente");
            $("#agendarOrden").attr("disabled", "disabled");
            $("#asignarDespachoOrden").attr("disabled", "disabled");
            $("#asignarTecnicoOrden").attr("disabled", "disabled");
            $("#botonEstadoOrden").attr("disabled", "disabled");
            $("#completarOrden").attr("disabled", "disabled");
            $("#observacionOrden").attr("disabled", "disabled");
            $("#historialOrden").attr("disabled", "disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          },1500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al guardar la agenda, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al guardar la agenda, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

async function generaMapa(direccion, folio, run, cliente, proyecto){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
	u = 'https://maps.googleapis.com/maps/api/geocode/json?';
	datos = {
		address	: direccion + ', Chile',
		key		: 'AIzaSyCb15rFHKSkFxmZbQIo6KVes2-GR3N-LcQ'
	};

  var lat = '';
  var lng = '';
	await $.ajax({
		url: u,
		type: 'get',
		dataType: "json",
		data: datos,
		success: function(data){
      lat = data.results[0].geometry.location.lat;
			lng = data.results[0].geometry.location.lng;
		}
	});
  google.charts.load("current", {
    "packages":["map"],
    // Note: you will need to get a mapsApiKey for your project.
    // See: https://developers.google.com/chart/interactive/docs/basic_load_libs#load-settings
    "mapsApiKey": "AIzaSyCb15rFHKSkFxmZbQIo6KVes2-GR3N-LcQ"
  });

  google.charts.setOnLoadCallback(drawChart);

  function drawChart() {
    var data = google.visualization.arrayToDataTable([
      ['Lat', 'Long', 'Name'],
      [lat, lng, 'Dir: ' + direccion],
    ]);

    var options = {
      zoomLevel: 17,
      showTooltip: true,
      showInfoWindow: true,
      mapType: 'terrain',
      icons: {
        default: {
          normal: 'view/img/icon_map/Map-Marker-Ball-Pink-icon.png',
          selected: 'view/img/icon_map/Map-Marker-Ball-Right-Pink-icon.png'
        }
      }
    };

    setTimeout(function(){
      $("#tituloMapaOrden").html('<b>Orden</b>: ' + folio + '<br><b>DNI Cliente</b>: ' + run + '<br><b>Nombre Cliente</b>: ' + cliente + '<br><b>Proyecto</b>: ' + proyecto);
      $('#modalAlertasSplash').modal('hide');
      $("#modalMapaOrden").modal({backdrop: 'static', keyboard: false});
      $("#modalMapaOrden").modal('show');

      var instance = OverlayScrollbars(document.getElementById('bodyMapaOrden'), { });

      //destroy the instance
      instance.destroy();

      setTimeout(function(){
        var h = $(window).height() - 300;
        $("#bodyMapaOrden").css("height",h);
        $("#mapaOrdenGoogle").css("height",h-30);
        var map = new google.visualization.Map(document.getElementById('mapaOrdenGoogle'));
        map.draw(data, options);
      },200);
    },1000);
  }
}

$("#sinAgendaOrden").unbind("click").change(async function(){
  $("#agendarOrden").attr("disabled", "disabled");
  $("#asignarDespachoOrden").attr("disabled", "disabled");
  $("#asignarTecnicoOrden").attr("disabled", "disabled");
  $("#botonEstadoOrden").attr("disabled", "disabled");
  $("#completarOrden").attr("disabled", "disabled");
  $("#observacionOrden").attr("disabled", "disabled");
  $("#completadasOrden").prop("checked",false);
  if($("#sinAgendaOrden").prop("checked")){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    //initialize the plugin and get its instance
    var instance = OverlayScrollbars(document.getElementById('contenido'), { });

    //destroy the instance
    instance.destroy();

    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

    $("#fechaOrden").attr("disabled","disabled");

    var parametros = {
      "path": window.location.href.split('#/')[1]
    }

    await $('#tablaOrdenes').DataTable( {
        ajax: {
            url: "controller/datosOrdenesFechaSinAgenda.php",
            type: 'POST',
            data: parametros
        },
        columns: [
          { data: 'S'},
          { data: 'FOLIO'},
          { data: 'PROYECTO'},
          { data: 'COMUNA'},
          { data: 'CATEGORIA'},
          { data: 'TIPO'},
          { data: 'SUB_TIPO'},
          { data: 'TECNOLOGIA'},
          { data: 'ESTADO'},
          { data: 'SUB_ESTADO'},
          { data: 'Q_AGENDA', className: "centerDataTable"},
          { data: 'FECHA_CREACION', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'FECHA_AGENDA', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'HORA_AGENDA', className: "centerDataTable"},
          { data: 'TRAMO'},
          { data: 'FECHA_ATENCION'},
          { data: 'HORA_INICIO'},
          { data: 'HORA_FIN'},
          { data: 'DIRECCION'},
          { data: 'DNI_CLIENTE'},
          { data: 'NOMBRE_CLIENTE'},
          { data: 'FONO_CLIENTE'},
          { data: 'EMPRESA'},
          { data: 'DESPACHO'},
          { data: 'TECNICO'},
          { data: 'IDORDEN'},
          { data: 'LATITUD'},
          { data: 'LONGITUD'},
          { data: 'ESTADO_TEXTO'},
          { data: 'SUB_ESTADO_TEXTO'},
          { data: 'DNI_DESPACHO'},
          { data: 'RUT_TECNICO'},
          { data: 'IDESTRUCTURA_OPERACION'},
          { data: 'IDAREAFUNCIONAL'},
          { data: 'DIRECCIONLIMPIA'},
          { data: 'IDORDEN_ESTADO'},
          { data: 'OBSERVACION'}
        ],
        buttons: [
            {
              extend: 'excel',
              exportOptions: {
                columns: [ 1,	2,	3,	4,	5,	6,	7,	8,	9,	10,	11,	12,	13,	14,	15,	16,	17,	18,	19,	20,	21,	22,	23, 24 ]
              },
              title: null,
              text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
            },
            {
              text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
              action: function ( e, dt, node, config ) {
                var table = $('#tablaOrdenes').DataTable();
                $("#agendarOrden").attr("disabled", "disabled");
                $("#asignarDespachoOrden").attr("disabled", "disabled");
                $("#asignarTecnicoOrden").attr("disabled", "disabled");
                $("#estadoOrden").attr("disabled", "disabled");
                $("#completarOrden").attr("disabled", "disabled");
                $("#observacionOrden").attr("disabled", "disabled");
                table.rows().deselect();
              }
            },
            {
              text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonFiltrosOrden"></span>&nbsp;&nbsp;Filtros',
              action: function(){
                if($("#filtrosOrden").height() > 100){
                  $("#filtrosOrden").css("height","0");
                  $("#filtrosOrden").fadeOut();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
                }
                else{
                  $("#filtrosOrden").css("height","150pt");
                  $("#filtrosOrden").fadeIn();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
                }
              }
            }
        ],
        "columnDefs": [
          {
            "width": "5px",
            "targets": 0
          },
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 25 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 26 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 27 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 28 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 29 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 30 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 31 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 32 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 33 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 34 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 35 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 36 ]
          }
        ],
        fixedColumns:   {
          leftColumns: 2
        },
        "select": {
            style: 'multi'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        "order": [[ 1, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'Bfrtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": true,
        "initComplete": function( settings, json){
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();

          var table = $('#tablaOrdenes').DataTable();

          var comunaOr = '';
          comunaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(3).data().unique().length; i++){
            if(table.column(3).data().unique()[i] !== null){
              comunaOr += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
            }
          }
          $("#comunaOrden").html(comunaOr);

          var categoriaOr = '';
          categoriaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(4).data().unique().length; i++){
            if(table.column(4).data().unique()[i] !== null){
              categoriaOr += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
            }
          }
          $("#categoriaOrden").html(categoriaOr);

          var tipoOr = '';
          tipoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(5).data().unique().length; i++){
            if(table.column(5).data().unique()[i] !== null){
              tipoOr += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
            }
          }
          $("#tipoOrden").html(tipoOr);

          var estadoOr = '';
          estadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(28).data().unique().length; i++){
            if(table.column(28).data().unique()[i] !== null){
              estadoOr += '<option value="' + table.column(28).data().unique()[i] + '">' + table.column(28).data().unique()[i] + '</option>';
            }
          }
          $("#estadoOrden").html(estadoOr);

          var subEstadoOr = '';
          subEstadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(29).data().unique().length; i++){
            if(table.column(29).data().unique()[i] !== null){
              subEstadoOr += '<option value="' + table.column(29).data().unique()[i] + '">' + table.column(29).data().unique()[i] + '</option>';
            }
          }
          $("#subEstadoOrden").html(subEstadoOr);

          var tramoOr = '';
          tramoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(14).data().unique().length; i++){
            if(table.column(14).data().unique()[i] !== null){
              tramoOr += '<option value="' + table.column(14).data().unique()[i] + '">' + table.column(14).data().unique()[i] + '</option>';
            }
          }
          $("#tramoOrden").html(tramoOr);

          var agendasOr = '';
          agendasOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(10).data().unique().length; i++){
            if(table.column(10).data().unique()[i] !== null){
              agendasOr += '<option value="' + table.column(10).data().unique()[i] + '">' + table.column(10).data().unique()[i] + '</option>';
            }
          }
          $("#reagendamientoOrden").html(agendasOr);

          var proyectoOr = '';
          proyectoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(2).data().unique().length; i++){
            if(table.column(2).data().unique()[i] !== null){
              proyectoOr += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
            }
          }
          $("#proyectoOrden").html(proyectoOr);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#comunaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#categoriaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tipoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tramoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#estadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#subEstadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#reagendamientoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
            });
            $("#proyectoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
          setTimeout(async function(){
            menuElegant();
            if($("#filtrosOrden").height() > 100){
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
            }
            else{
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
            }
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaOrdenes').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    //initialize the plugin and get its instance
    var instance = OverlayScrollbars(document.getElementById('contenido'), { });

    //destroy the instance
    instance.destroy();

    $("#fechaOrden").removeAttr("disabled");

    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

    var parametros = {
      "fecha": $("#fechaOrden").val(),
      "path": window.location.href.split('#/')[1]
    }

    await $('#tablaOrdenes').DataTable( {
        ajax: {
            url: "controller/datosOrdenesFecha.php",
            type: 'POST',
            data: parametros
        },
        columns: [
          { data: 'S'},
          { data: 'FOLIO'},
          { data: 'PROYECTO'},
          { data: 'COMUNA'},
          { data: 'CATEGORIA'},
          { data: 'TIPO'},
          { data: 'SUB_TIPO'},
          { data: 'TECNOLOGIA'},
          { data: 'ESTADO'},
          { data: 'SUB_ESTADO'},
          { data: 'Q_AGENDA', className: "centerDataTable"},
          { data: 'FECHA_CREACION', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'FECHA_AGENDA', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'HORA_AGENDA', className: "centerDataTable"},
          { data: 'TRAMO'},
          { data: 'FECHA_ATENCION'},
          { data: 'HORA_INICIO'},
          { data: 'HORA_FIN'},
          { data: 'DIRECCION'},
          { data: 'DNI_CLIENTE'},
          { data: 'NOMBRE_CLIENTE'},
          { data: 'FONO_CLIENTE'},
          { data: 'EMPRESA'},
          { data: 'DESPACHO'},
          { data: 'TECNICO'},
          { data: 'IDORDEN'},
          { data: 'LATITUD'},
          { data: 'LONGITUD'},
          { data: 'ESTADO_TEXTO'},
          { data: 'SUB_ESTADO_TEXTO'},
          { data: 'DNI_DESPACHO'},
          { data: 'RUT_TECNICO'},
          { data: 'IDESTRUCTURA_OPERACION'},
          { data: 'IDAREAFUNCIONAL'},
          { data: 'DIRECCIONLIMPIA'},
          { data: 'IDORDEN_ESTADO'},
          { data: 'OBSERVACION'}
        ],
        buttons: [
            {
              extend: 'excel',
              exportOptions: {
                columns: [ 1,	2,	3,	4,	5,	6,	7,	8,	9,	10,	11,	12,	13,	14,	15,	16,	17,	18,	19,	20,	21,	22,	23, 24 ]
              },
              title: null,
              text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
            },
            {
              text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
              action: function ( e, dt, node, config ) {
                var table = $('#tablaOrdenes').DataTable();
                $("#agendarOrden").attr("disabled", "disabled");
                $("#asignarDespachoOrden").attr("disabled", "disabled");
                $("#asignarTecnicoOrden").attr("disabled", "disabled");
                $("#estadoOrden").attr("disabled", "disabled");
                $("#completarOrden").attr("disabled", "disabled");
                $("#observacionOrden").attr("disabled", "disabled");
                table.rows().deselect();
              }
            },
            {
              text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonFiltrosOrden"></span>&nbsp;&nbsp;Filtros',
              action: function(){
                if($("#filtrosOrden").height() > 100){
                  $("#filtrosOrden").css("height","0");
                  $("#filtrosOrden").fadeOut();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
                }
                else{
                  $("#filtrosOrden").css("height","150pt");
                  $("#filtrosOrden").fadeIn();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
                }
              }
            }
        ],
        "columnDefs": [
          {
            "width": "5px",
            "targets": 0
          },
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 25 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 26 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 27 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 28 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 29 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 30 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 31 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 32 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 33 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 34 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 35 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 36 ]
          }
        ],
        fixedColumns:   {
          leftColumns: 2
        },
        "select": {
            style: 'multi'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        "order": [[ 1, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'Bfrtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": true,
        "initComplete": function( settings, json){
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();

          var table = $('#tablaOrdenes').DataTable();

          var comunaOr = '';
          comunaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(3).data().unique().length; i++){
            if(table.column(3).data().unique()[i] !== null){
              comunaOr += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
            }
          }
          $("#comunaOrden").html(comunaOr);

          var categoriaOr = '';
          categoriaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(4).data().unique().length; i++){
            if(table.column(4).data().unique()[i] !== null){
              categoriaOr += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
            }
          }
          $("#categoriaOrden").html(categoriaOr);

          var tipoOr = '';
          tipoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(5).data().unique().length; i++){
            if(table.column(5).data().unique()[i] !== null){
              tipoOr += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
            }
          }
          $("#tipoOrden").html(tipoOr);

          var estadoOr = '';
          estadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(28).data().unique().length; i++){
            if(table.column(28).data().unique()[i] !== null){
              estadoOr += '<option value="' + table.column(28).data().unique()[i] + '">' + table.column(28).data().unique()[i] + '</option>';
            }
          }
          $("#estadoOrden").html(estadoOr);

          var subEstadoOr = '';
          subEstadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(29).data().unique().length; i++){
            if(table.column(29).data().unique()[i] !== null){
              subEstadoOr += '<option value="' + table.column(29).data().unique()[i] + '">' + table.column(29).data().unique()[i] + '</option>';
            }
          }
          $("#subEstadoOrden").html(subEstadoOr);

          var tramoOr = '';
          tramoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(14).data().unique().length; i++){
            if(table.column(14).data().unique()[i] !== null){
              tramoOr += '<option value="' + table.column(14).data().unique()[i] + '">' + table.column(14).data().unique()[i] + '</option>';
            }
          }
          $("#tramoOrden").html(tramoOr);

          var agendasOr = '';
          agendasOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(10).data().unique().length; i++){
            if(table.column(10).data().unique()[i] !== null){
              agendasOr += '<option value="' + table.column(10).data().unique()[i] + '">' + table.column(10).data().unique()[i] + '</option>';
            }
          }
          $("#reagendamientoOrden").html(agendasOr);

          var proyectoOr = '';
          proyectoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(2).data().unique().length; i++){
            if(table.column(2).data().unique()[i] !== null){
              proyectoOr += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
            }
          }
          $("#proyectoOrden").html(proyectoOr);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#comunaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#categoriaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tipoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tramoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#estadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#subEstadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#reagendamientoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
            });
            $("#proyectoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
          setTimeout(async function(){
            menuElegant();
            if($("#filtrosOrden").height() > 100){
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
            }
            else{
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
            }
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaOrdenes').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
  }
});

// FUNCION PARA MODAL INGRESAR DESCUENTO SINIESTROS
$("#descuentoSiniestros").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $('#checkboxGenerarPdfDesc').prop('checked', true);
  $("#montoDescuentoSiniestros").removeClass("is-invalid");
  $("#costoTotalSiniestros").removeClass("is-invalid");
  var table = $('#tablaListadoSiniestros').DataTable();
  var monto_Desc = $.map(table.rows('.selected').data(), function (item) {
      return item.MONTODESC;
  });
  var costo_Total = $.map(table.rows('.selected').data(), function (item) {
    return item.COSTOTOTAL;
  });
  var descuento = $.map(table.rows('.selected').data(), function (item) {
    return item.DESCUENTO;
  });

  $("#montoDescuentoSiniestros").val(monto_Desc);
  $("#costoTotalSiniestros").val(costo_Total);
  $("#selectDescuentoSiniestros").val(descuento);

  if($("#selectDescuentoSiniestros").val() === "Excepción"){
    $("#montoDescuentoSiniestros").val("");
    $("#costoTotalSiniestros").val("");
    $("#montoDescuentoSiniestros").attr("disabled","disabled");
    $("#costoTotalSiniestros").attr("disabled","disabled");
    $('#checkboxGenerarPdfDesc').prop('checked', false);
  }
  else{
    $("#montoDescuentoSiniestros").removeAttr("disabled");
    $("#costoTotalSiniestros").removeAttr("disabled");
    $('#checkboxGenerarPdfDesc').prop('checked', true);
  }

  $("#selectDescuentoSiniestros").unbind("click").change(async function(){
    if($("#selectDescuentoSiniestros").val() === "Excepción"){
      $("#montoDescuentoSiniestros").val("");
      $("#costoTotalSiniestros").val("");
      $("#montoDescuentoSiniestros").attr("disabled","disabled");
      $("#costoTotalSiniestros").attr("disabled","disabled");
      $('#checkboxGenerarPdfDesc').prop('checked', false);
    }
    else{
      $("#montoDescuentoSiniestros").removeAttr("disabled");
      $("#costoTotalSiniestros").removeAttr("disabled");
      $('#checkboxGenerarPdfDesc').prop('checked', true);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectDescuentoSiniestros").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#montoDescuentoSiniestros" ).focusout(function(){
    desc = $("#montoDescuentoSiniestros").val();
    if(desc < 0){
      $("#montoDescuentoSiniestros").val(0);
      $("#montoDescuentoSiniestros").addClass("is-invalid");


      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
    }
    else{
      $("#montoDescuentoSiniestros").val(desc);
    }
  });

  $("#costoTotalSiniestros" ).focusout(function(){
    total = $("#costoTotalSiniestros").val();
    if(total < 0){
      $("#costoTotalSiniestros").val(0);
      $("#costoTotalSiniestros").addClass("is-invalid");


      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
    }
    else{
      $("#costoTotalSiniestros").val(total);
    }
  });

  setTimeout(function(){
    $("#modalDescuentoSiniestros").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyDescuentoSiniestros').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarDescuentoSiniestros").unbind('click').click(function(){
  var table = $('#tablaListadoSiniestros').DataTable();
  var idSiniestros = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_SINIESTROS;
  });
  costoTotal = parseInt($("#costoTotalSiniestros").val());
  montoDesc = parseInt($("#montoDescuentoSiniestros").val());
  if(costoTotal < montoDesc){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El descuento no puede ser mayor al costo total");
    $("#costoTotalSiniestros").addClass("is-invalid");
    $("#montoDescuentoSiniestros").addClass("is-invalid");
  }
  else if($("#selectDescuentoSiniestros").val() === "Excepción" || ($('#checkboxGenerarPdfDesc').prop('checked')) === false){
    pdfDescDestroy = 1;
    parametros = {
      "descuento": $("#selectDescuentoSiniestros").val(),
      "montoDesc": $("#montoDescuentoSiniestros").val(),
      "costoTotal": $("#costoTotalSiniestros").val(),
      "idSiniestros": idSiniestros[0],
      "pdfDescDestroy" : pdfDescDestroy,
    }
    $("#modalDescuentoSiniestros").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/actualizarDescuentoSiniestros.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoSiniestros').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Descuento actualizado correctamente");
            $("#subirPdfSiniestros").attr("disabled","disabled");
            $("#numeroSiniestros").attr("disabled","disabled");
            $("#numeroFacturaSiniestros").attr("disabled","disabled");
            $("#descuentoSiniestros").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar Descuento, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar Descuento, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
  else{
    pdfDescDestroy = 2;
    parametros = {
      "descuento": $("#selectDescuentoSiniestros").val(),
      "montoDesc": $("#montoDescuentoSiniestros").val(),
      "costoTotal": $("#costoTotalSiniestros").val(),
      "idSiniestros": idSiniestros[0],
      "pdfDescDestroy" : pdfDescDestroy,
    }
    $("#modalDescuentoSiniestros").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/actualizarDescuentoSiniestros.php",
      type: 'POST',
      data: parametros,
      success:  async function (response) {
        await $.ajax({
          url: "controller/generaPDF/descuentoSiniestro.php?idLoad=205",
          type:"POST",
          data:{
            "idSiniestro": idSiniestros[0],
            "montoDesc": $("#montoDescuentoSiniestros").val(),
            "descuento": $("#selectDescuentoSiniestros").val(),
            "url": window.location.toString().split("?")[0]
          },
          success: function (res2){
            window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/flota/siniestros/descuento' + res2, '_blank');
            var p = res2.split(",");
            if(res2.localeCompare("Sin datos")!= 0 && res2 != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                var table = $('#tablaListadoSiniestros').DataTable();
                table.ajax.reload();
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Descuento actualizado correctamente");
                $("#subirPdfSiniestros").attr("disabled","disabled");
                $("#numeroSiniestros").attr("disabled","disabled");
                $("#numeroFacturaSiniestros").attr("disabled","disabled");
                $("#descuentoSiniestros").attr("disabled","disabled");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar Descuento, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar Descuento, si el problema persiste favor comuniquese con soporte");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
        });
      }
    });
  }
});

$("#montoDescuentoSiniestros").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#costoTotalSiniestros").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL INGRESAR DESCUENTO SINIESTROS

// FUNCION PARA MODAL INGRESAR NUM_SINIESTRO SINIESTROS
$("#numeroSiniestros").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoSiniestros').DataTable();
  var num_siniestro = $.map(table.rows('.selected').data(), function (item) {
      return item.N_SINIESTRO;
  });
  $("#ingresoNumeroSiniestros").val(num_siniestro);
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalNumeroSiniestros").modal("show");
    setTimeout(function(){
      $('#bodyNumeroSiniestros').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarNumeroSiniestros").unbind('click').click(function(){
  var table = $('#tablaListadoSiniestros').DataTable();
  var idSiniestros = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_SINIESTROS;
  });

  parametros = {
    "num_siniestro": $("#ingresoNumeroSiniestros").val(),
    "idSiniestros": idSiniestros[0],
  }

  $("#modalNumeroSiniestros").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/actualizarNumeroSiniestros.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoSiniestros').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Numero de Siniestro actualizado correctamente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar Numero de Siniestro, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar Numero de Siniestro, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL INGRESAR NUM_SINIESTRO SINIESTROS

// FUNCION PARA MODAL INGRESAR NUM_FACTURA SINIESTROS
$("#numeroFacturaSiniestros").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoSiniestros').DataTable();
  var num_factura = $.map(table.rows('.selected').data(), function (item) {
      return item.N_FACTURA;
  });
  $("#ingresoFacturaSiniestros").val(num_factura);
  setTimeout(function(){
    $("#modalFacturaSiniestros").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyFacturaSiniestros').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarFacturaSiniestros").unbind('click').click(function(){
  var table = $('#tablaListadoSiniestros').DataTable();
  var idSiniestros = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_SINIESTROS;
  });
  parametros = {
    "num_factura": $("#ingresoFacturaSiniestros").val(),
    "idSiniestros": idSiniestros[0],
  }
  $("#modalFacturaSiniestros").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/actualizarFacturaSiniestros.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoSiniestros').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Numero de Factura actualizado correctamente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar Numero de Factura, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar Numero de Factura, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL INGRESAR NUM_FACTURA SINIESTROS

// FUNCION PARA MODAL SUBIR PDF SINIESTROS
// Primero cargamos los archivos
$("#pdfCargaSiniestro" ).on('change', function(e){
  var file = e.target.files[0].name; // agarramos solo el nombre([0].name) del array que tiene tamaño, fecha y mas
  $("#inputPdfSiniestro").val(file);
  $("#inputPdfSiniestro").removeClass("is-invalid");
});

$("#pdfCargaDeclaracion" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfDeclaracion").val(file);
  $("#inputPdfDeclaracion").removeClass("is-invalid");
});

$("#pdfCargaDeclAseg" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfDeclAseg").val(file);
  $("#inputPdfDeclAseg").removeClass("is-invalid");
});

$("#pdfCargaDescuento" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfDescuento").val(file);
  $("#inputPdfDescuento").removeClass("is-invalid");
});

$("#pdfCargaLicenciaSiniestro" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfLicenciaSiniestro").val(file);
  $("#inputPdfLicenciaSiniestro").removeClass("is-invalid");
});

$("#subirPdfSiniestros").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoSiniestros').DataTable();
  var patente = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO;
  });
  var idSiniestro = $.map(table.rows('.selected').data(), function (item) {
    return item.IDPATENTE_SINIESTROS;
  });

  $("#tituloSubirPdfSiniestros").html('Patente: ' + patente);

  var parametros = {
    "idSiniestro" : idSiniestro[0]
  }
  await $.ajax({
    url:   'controller/datosPdfSiniestro.php',
    type:  'post',
    data: parametros,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      siniestro = p3.aaData[0].PDF_SINIESTRO;
      declaracion = p3.aaData[0].PDF_DECLARACION;
      decl_aseg = p3.aaData[0].PDF_DECLARACION_ASEG;
      lic = p3.aaData[0].PDF_LIC_CED;
      descuento = p3.aaData[0].PDF_DESCUENTO;
      contadorSiniestro = p3.aaData[0].CONTADOR_SINIESTRO;
      contadorDeclaracion = p3.aaData[0].CONTADOR_DECLARACION;
      contadorDeclAseg = p3.aaData[0].CONTADOR_DECL_ASEG;
      contadorLic = p3.aaData[0].CONTADOR_LIC;
      contadorDesc = p3.aaData[0].CONTADOR_DESC;
    }
  });
  if(contadorSiniestro == null || contadorSiniestro == 1){
    $("#inputPdfSiniestro").val(siniestro);
    $("#spanSiniestro").html("<font> </font>");
    $("#pdfCargaSiniestro").removeAttr("disabled");
  }
  else{
    $("#spanSiniestro").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfSiniestro").val(siniestro);
    $("#pdfCargaSiniestro").attr("disabled","disabled");
  }

  if(contadorDeclaracion == null || contadorDeclaracion == 1){
    $("#inputPdfDeclaracion").val(declaracion);
    $("#spanDeclaracion").html("<font> </font>");
    $("#pdfCargaDeclaracion").removeAttr("disabled");
  }
  else{
    $("#spanDeclaracion").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfDeclaracion").val(declaracion);
    $("#pdfCargaDeclaracion").attr("disabled","disabled");
  }

  if(contadorDeclAseg == null || contadorDeclAseg == 1){
    $("#inputPdfDeclAseg").val(decl_aseg);
    $("#spanDeclAseg").html("<font> </font>");
    $("#pdfCargaDeclAseg").removeAttr("disabled");
  }
  else{
    $("#spanDeclAseg").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfDeclAseg").val(decl_aseg);
    $("#pdfCargaDeclAseg").attr("disabled","disabled");
  }

  if(contadorLic == null || contadorLic == 1){
    $("#inputPdfLicenciaSiniestro").val(lic);
    $("#spanLicencia").html("<font> </font>");
    $("#pdfCargaLicenciaSiniestro").removeAttr("disabled");
  }
  else{
    $("#spanLicencia").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfLicenciaSiniestro").val(lic);
    $("#pdfCargaLicenciaSiniestro").attr("disabled","disabled");
  }

  if(contadorDesc == null || contadorDesc == 1){
    $("#inputPdfDescuento").val(descuento);
    $("#spanDescuento").html("<font> </font>");
    $("#pdfCargaDescuento").removeAttr("disabled");
  }
  else{
    $("#spanDescuento").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfDescuento").val(descuento);
    $("#pdfCargaDescuento").attr("disabled","disabled");
  }

  $("#pdfCargaSiniestro").val('');
  $("#inputPdfSiniestro").removeClass("is-invalid");

  $("#pdfCargaDeclaracion").val('');
  $("#inputPdfDeclaracion").removeClass("is-invalid");

  $("#pdfCargaDeclAseg").val('');
  $("#inputPdfDeclAseg").removeClass("is-invalid");

  $("#pdfCargaLicenciaSiniestro").val('');
  $("#inputPdfLicenciaSiniestro").removeClass("is-invalid");

  $("#pdfCargaDescuento").val('');
  $("#inputPdfDescuento").removeClass("is-invalid");

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalSubirPdfSiniestros").modal("show");
  },500);
});

$("#guardarSubirPdfSiniestros").unbind("click").click( async function(){
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalSubirPdfSiniestros").modal("hide");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoSiniestros').DataTable();
  var idSiniestro = $.map(table.rows('.selected').data(), function (item) {
    return item.IDPATENTE_SINIESTROS;
  });

  var parametros = {
    "idSiniestro" : idSiniestro[0]
  }
  await $.ajax({
    url:   'controller/datosPdfSiniestro.php',
    type:  'post',
    data: parametros,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      siniestro = p3.aaData[0].PDF_SINIESTRO;
      declaracion = p3.aaData[0].PDF_DECLARACION;
      decl_aseg = p3.aaData[0].PDF_DECLARACION_ASEG;
      lic = p3.aaData[0].PDF_LIC_CED;
      descuento = p3.aaData[0].PDF_DESCUENTO;
      contadorSiniestro = p3.aaData[0].CONTADOR_SINIESTRO;
      contadorDeclaracion = p3.aaData[0].CONTADOR_DECLARACION;
      contadorDeclAseg = p3.aaData[0].CONTADOR_DECL_ASEG;
      contadorLic = p3.aaData[0].CONTADOR_LIC;
      contadorDesc = p3.aaData[0].CONTADOR_DESC;
    }
  });

  if(($("#inputPdfSiniestro").val() != '' && contadorSiniestro != 2) || ($("#inputPdfDeclaracion").val() != '' && contadorDeclaracion != 2) || ($("#inputPdfDeclAseg").val() != '' && contadorDeclAseg != 2) || ($("#inputPdfLicenciaSiniestro").val() != '' && contadorLic != 2) || ($("#inputPdfDescuento").val() != '' && contadorDesc != 2)){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    var formdata = new FormData();
    formdata.append('idSiniestro',idSiniestro);
    formdata.append('pdfSiniestro',$("#pdfCargaSiniestro")[0].files[0]);
    formdata.append('pdfDeclaracion',$("#pdfCargaDeclaracion")[0].files[0]);
    formdata.append('pdfDeclAseg',$("#pdfCargaDeclAseg")[0].files[0]);
    formdata.append('pdfLicencia',$("#pdfCargaLicenciaSiniestro")[0].files[0]);
    formdata.append('pdfDescuento',$("#pdfCargaDescuento")[0].files[0]);

    $.ajax({
      url: "controller/ingresaPdfSiniestros.php",
      type: 'POST',
      data: formdata,
      cache: false,
      contentType: false,
      processData: false,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoSiniestros').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Pdf cargado correctamente");
            $("#subirPdfSiniestros").attr("disabled","disabled");
            $("#numeroSiniestros").attr("disabled","disabled");
            $("#numeroFacturaSiniestros").attr("disabled","disabled");
            $("#descuentoSiniestros").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar Pdf, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar Pdf, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
  else{
    if(contadorChecklist != 2){
      $("#inputPdfChecklist").addClass("is-invalid");
    }
    if(contadorLic != 2){
      $("#inputPdfLicencia").addClass("is-invalid");
    }
    if(contadorAsig != 2){
      $("#inputPdfAsignacion").addClass("is-invalid");
    }

    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se ha cargado ningun PDF");7
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
      $("#modalSubirPdfSiniestros").modal("show");
    },500);
  }
});
// FIN FUNCION PARA MODAL SUBIR PDF SINIESTROS

// EVENTO PARA ABRIR PDF SINIESTROS
async function pdf_Siniestro(pdf){
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    window.open(window.location.toString().split("#/")[0].split('?')[0] + 'controller/repositorio/flota/siniestros/' + pdf, '_blank');
  }
}
// FIN EVENTO PARA ABRIR PDF SINIESTROS

// FUNCION PARA MODAL CREAR SINIESTROS
$("#ingresarSiniestros").unbind("click").click(async function(){
  $('#checkboxDatosTerceroSiniestros').prop('checked', false);
  $("#fechaSiniestros").removeClass("is-invalid");
  $("#direccionSiniestros").removeClass("is-invalid");
  $("#guardarIngresoSiniestros").attr("disabled","disabled");
  $("#patenteVehiculoSiniestros").val("");
  $("#patenteVehiculoSiniestros").removeAttr("disabled","disabled");
  $("#rutPersonalSiniestros").val("");
  $("#patenteVehiculoSiniestros").removeClass("is-invalid");
  $("#rutPersonalSiniestros").removeClass("is-invalid");
  $("#nombrePersonalSiniestros").val("");
  $("#nombrePersonalSiniestros").attr("disabled","disabled");
  $("#correoPersonalSiniestros").val("");
  $("#direccionPersonalSiniestros").val("");
  $("#celularPersonalSiniestros").val("");
  $("#marcaVehiculoSiniestros").val("");
  $("#marcaVehiculoSiniestros").attr("disabled","disabled");
  $("#modeloVehiculoSiniestros").val("");
  $("#modeloVehiculoSiniestros").attr("disabled","disabled");
  $("#anoVehiculoSiniestros").val("");
  $("#anoVehiculoSiniestros").attr("disabled","disabled");
  $("#piezasDañadasVehiculoSiniestros").val("");
  $("#fechaSiniestros").val("");
  $("#horaSiniestros").val("");
  $("#direccionSiniestros").val("");
  $("#parteSiniestros").val("");
  $("#comisariaSiniestros").val("");
  $("#datosTerceroSiniestros").html("");
  $("#cantSiniestrosPersonal").html("");
  $("#descripcionSiniestros").val("");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoSiniestros").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaSiniestros").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaPersonalSiniestros").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  await $.ajax({
    url:   'controller/datosAreaFuncional.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].COMUNA + '">' + p2.aaData[i].COMUNA + '</option>';
        }
        $("#comunaPersonalSiniestros").html(cuerpoEC);
        $("#comunaSiniestros").html(cuerpoEC);
      }
    }
  });

  var max = new Date();

  $("#fechaSiniestros").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    maxDate: max,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  await $.ajax({
    url:   'controller/datosAsignacionesValidadas.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var listaPersonalSiniestro = [];
        for(var i = 0; i < p.aaData.length; i++) {
          listaPersonalSiniestro.push(p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRE + ' - ' + p.aaData[i].CODIGO);
        }
        $('#rutPersonalSiniestros').autocomplete({
          // req will contain an object with a "term" property that contains the value
          // currently in the text input.  responseFn should be invoked with the options
          // to display to the user.
          source: function (req, responseFn) {
            // Escape any RegExp meaningful characters such as ".", or "^" from the
            // keyed term.
            var term = $.ui.autocomplete.escapeRegex(req.term),
              // '^' is the RegExp character to match at the beginning of the string.
              // 'i' tells the RegExp to do a case insensitive match.
              matcher = new RegExp(term, 'i'),
              // Loop over the options and selects only the ones that match the RegExp.
              matches = $.grep(listaPersonalSiniestro, function (item) {
                return matcher.test(item);
              });
            // Return the matched options.
            responseFn(matches);
          }
        });
      }
    }
  });

  await $.ajax({
    url:   'controller/datosVehiculosForSiniestros.php',
    type:  'post',
    success: function (response1) {
      var p1 = jQuery.parseJSON(response1);
      if(p1.aaData.length !== 0){
        var listaVehiculoSiniestro = [];
        for(var i = 0; i < p1.aaData.length; i++) {
          listaVehiculoSiniestro.push(p1.aaData[i].CODIGO);
        }
        $('#patenteVehiculoSiniestros').autocomplete({
          // req will contain an object with a "term" property that contains the value
          // currently in the text input.  responseFn should be invoked with the options
          // to display to the user.
          source: function (req, responseFn) {
            // Escape any RegExp meaningful characters such as ".", or "^" from the
            // keyed term.
            var term = $.ui.autocomplete.escapeRegex(req.term),
              // '^' is the RegExp character to match at the beginning of the string.
              // 'i' tells the RegExp to do a case insensitive match.
              matcher = new RegExp(term, 'i'),
              // Loop over the options and selects only the ones that match the RegExp.
              matches = $.grep(listaVehiculoSiniestro, function (item) {
                return matcher.test(item);
              });
            // Return the matched options.
            responseFn(matches);
          }
        });
      }
    }
  });

  $('input[type=checkbox]').on('change', async function() {
    if ($('#checkboxDatosTerceroSiniestros').prop('checked') ) {
      cuerpoC = '';
      cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Nombre Tercero</label><input id="nombreTerceroSiniestros" class="form-control" type="text" value=" "></div>';
      cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Correo Tercero</label><input id="correoTerceroSiniestros" class="form-control" type="text" value=" "></div>';
      cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Celular Tercero</label><input id="celularTerceroSiniestros" class="form-control" type="text" value=" "></div>';
      cuerpoC += '<div class="col-xl-7 col-lg-7 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Dirección Tercero</label><input id="direccionTerceroSiniestros" class="form-control" type="text" value=" "></div>';
      cuerpoC += '<div class="col-xl-5 col-lg-5 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Comuna Tercero</label><select id="comunaTerceroSiniestros" class="form-control"></select></div>';
      cuerpoC += '<div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Patente Tercero</label><input id="patenteTerceroSiniestros" class="form-control" type="text" value=" "></div>';
      cuerpoC += '<div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Marca Tercero</label><input id="marcaTerceroSiniestros" class="form-control" type="text" value=" "></div>';
      cuerpoC += '<div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Modelo Tercero</label><input id="modeloTerceroSiniestros" class="form-control" type="text" value=" "></div>';
      cuerpoC += '<div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Año Tercero</label><input id="anoTerceroSiniestros" class="form-control" type="text" value=" "></div>';
      cuerpoC += '<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Piezas dañadas tercero</label><textarea id="piezasDañadasTerceroSiniestros" class="form-control" rows="3" style="resize: none;" maxlength="500"></textarea></div>';
    }
    else{
      cuerpoC = '';
    }
    $("#datosTerceroSiniestros").html(cuerpoC);

    await $.ajax({
      url:   'controller/datosAreaFuncional.php',
      type:  'post',
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          var cuerpoEC = '';
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoEC += '<option value="' + p2.aaData[i].COMUNA + '">' + p2.aaData[i].COMUNA + '</option>';
          }
          $("#comunaTerceroSiniestros").html(cuerpoEC);
        }
      }
    });

    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ){
      $("#comunaTerceroSiniestros").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }

    var input = document.getElementById('direccionTerceroSiniestros');
    var autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.addListener('place_changed', function() {
      var place = autocomplete.getPlace();
    });
    $("#direccionTerceroSiniestros").attr("placeholder","");

  });

  $('input[type=checkbox]').on('change', async function() {
    if ($('#checkboxDanosInfra').prop('checked') ) {
      cuerpoC = '';
      cuerpoC += '<div class="col-xl-5 col-lg-5 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Tipo</label><select id="tipoDanoInfra" class="form-control"><option value="Público">Público</option><option value="Privado">Privado</option></select></div>';
      cuerpoC += '<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;"><label style="font-weight: bold;">Observación</label><textarea id="observacionDanosInfra" class="form-control" rows="3" style="resize: none;" maxlength="500"></textarea></div>';
    }
    else{
      cuerpoC = '';
    }
    $("#datosDanoInfra").html(cuerpoC);

    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ){
      $("#tipoDanoInfra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }

  });

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyIngresoSiniestros").css("height",h);
    $("#modalIngresoSiniestros").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoSiniestros').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#patenteVehiculoSiniestros").focusout(function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  patente = $("#patenteVehiculoSiniestros").val();
  if(patente.length > 5){
    $('#modalIngresoSiniestros').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var parametros = {
      "patente": patente,
    }
    $.ajax({
      url:   'controller/datosVehiculoForSiniestrosSelect.php',
      type:  'post',
      data: parametros,
      success: function (response3) {
        if(response3.localeCompare("Sin datos") != 0 && response3 != ""){
          var p3 = jQuery.parseJSON(response3);
          $("#patenteVehiculoSiniestros").val(patente);
          $("#marcaVehiculoSiniestros").val(p3.aaData[0].MARCA);
          $("#marcaVehiculoSiniestros").attr("disabled","disabled");
          $("#anoVehiculoSiniestros").val(p3.aaData[0].ANO);
          $("#anoVehiculoSiniestros").attr("disabled","disabled");
          $("#modeloVehiculoSiniestros").val(p3.aaData[0].MODELO);
          $("#modeloVehiculoSiniestros").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalIngresoSiniestros').modal('show');
          },500);
        }
        else{
          $.ajax({
            url:   'controller/datosChequeaPatente.php',
            type:  'post',
            data: parametros,
            success: function (response2) {
              if(response2.localeCompare("Sin datos") != 0 && response2 != ""){
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se le puede ingresar un siniestro a la patente ingresada, dado que no cumple las condiciones necesarias");
                $("#patenteVehiculoSiniestros").val("");
                $("#patenteVehiculoSiniestros").addClass("is-invalid");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  $("#modalIngresoSiniestros").modal("show");
                },500);

              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La patente ingresada es inválida o no pertenece a la empresa");
                $("#patenteVehiculoSiniestros").val("");
                $("#patenteVehiculoSiniestros").addClass("is-invalid");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  $("#modalIngresoSiniestros").modal("show");
                },500);
              }
            }
          });
        }
      }
    });
  }
});

$("#rutPersonalSiniestros").focusout(function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  vari = $("#rutPersonalSiniestros").val().split(" - ")[0];
  varp = $("#rutDesasignacionVehiculo").val().split(" - ")[2];
  if(vari.length > 8){
    $('#modalIngresoSiniestros').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var parametrosRut = {
      "rut": $.trim(vari.replace('.','').replace('.','')),
      "patente": varp
    }
    $.ajax({
      url:   'controller/cantidadSiniestroPersonal.php',
      type:  'post',
      data: parametrosRut,
      success: function (respon) {
        var c = jQuery.parseJSON(respon);
        $("#cantSiniestrosPersonal").html("Cantidad de Siniestros: " + c.aaData[0].CANT_SINIESTROS);
      }
    });
    $.ajax({
      url:   'controller/datosAsignacionValidadaSelect.php',
      type:  'post',
      data: parametrosRut,
      success: function (response3) {
        if(response3.localeCompare("Sin datos") != 0 && response3 != ""){
          var p3 = jQuery.parseJSON(response3);
          $("#rutPersonalSiniestros").val(vari);
          $("#guardarIngresoSiniestros").removeAttr("disabled");
          $("#nombrePersonalSiniestros").val(p3.aaData[0].NOMBRE);
          $("#nombrePersonalSiniestros").attr("disabled","disabled");
          $("#patenteVehiculoSiniestros").val(p3.aaData[0].CODIGO);
          //$("#patenteVehiculoSiniestros").attr("disabled","disabled");
          $("#marcaVehiculoSiniestros").val(p3.aaData[0].MARCA);
          $("#marcaVehiculoSiniestros").attr("disabled","disabled");
          $("#anoVehiculoSiniestros").val(p3.aaData[0].ANO);
          $("#anoVehiculoSiniestros").attr("disabled","disabled");
          $("#modeloVehiculoSiniestros").val(p3.aaData[0].MODELO);
          $("#modeloVehiculoSiniestros").attr("disabled","disabled");
          $("#correoPersonalSiniestros").val(p3.aaData[0].EMAIL);
          $("#celularPersonalSiniestros").val(p3.aaData[0].TELEFONO);
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalIngresoSiniestros').modal('show');
          },500);
        }
        else{
          $.ajax({
            url:   'controller/datosChequeaPersonal.php',
            type:  'post',
            data: parametrosRut,
            success: function (response2) {
              if(response2.localeCompare("Sin datos") != 0 && response2 != ""){
                var p2 = jQuery.parseJSON(response2);
                $("#rutPersonalSiniestros").val(vari);
                $("#guardarIngresoSiniestros").removeAttr("disabled");
                $("#nombrePersonalSiniestros").val(p2.aaData[0].PERSONAL);
                $("#nombrePersonalSiniestros").attr("disabled","disabled");
                $("#correoPersonalSiniestros").val(p2.aaData[0].EMAIL);
                $("#celularPersonalSiniestros").val(p2.aaData[0].TELEFONO);
                $('#modalAlertasSplash').modal('hide');
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El DNI ingresado no tiene vehículo asignado");
                $('#modalIngresoSiniestros').modal('show');
              }
              else{
                $('#modalAlertasSplash').modal('hide');
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El DNI ingresado es inválido o no pertenece a la empresa");
                $("#rutPersonalSiniestros").val("");
                $("#rutPersonalSiniestros").addClass("is-invalid");
                $('#modalIngresoSiniestros').modal('show');
              }
            }
          });
        }
      }
    });
  }
});

$("#rutPersonalSiniestros").on('input', function(){
  $('#checkboxDatosTerceroSiniestros').prop('checked', false);
  $(this).removeClass("is-invalid");
  $("#guardarIngresoSiniestros").attr("disabled","disabled");
  $("#patenteVehiculoSiniestros").removeAttr("disabled","disabled");
  $("#patenteVehiculoSiniestros").removeClass("is-invalid");
  $("#nombrePersonalSiniestros").val("");
  $("#nombrePersonalSiniestros").attr("disabled","disabled");
  $("#correoPersonalSiniestros").val("");
  $("#direccionPersonalSiniestros").val("");
  $("#celularPersonalSiniestros").val("");
  $("#piezasDañadasVehiculoSiniestros").val("");
  $("#fechaSiniestros").val("");
  $("#horaSiniestros").val("");
  $("#direccionSiniestros").val("");
  $("#parteSiniestros").val("");
  $("#comisariaSiniestros").val("");
  $("#datosTerceroSiniestros").html("");
  $("#descripcionSiniestros").val("");
  $("#patenteVehiculoSiniestros").val("");
  $("#marcaVehiculoSiniestros").val("");
  $("#modeloVehiculoSiniestros").val("");
  $("#anoVehiculoSiniestros").val("");
  $("#cantSiniestrosPersonal").html("");
});

$("#patenteVehiculoSiniestros").on('input', function(){
  $('#checkboxDatosTerceroSiniestros').prop('checked', false);
  $(this).removeClass("is-invalid");
  $("#patenteVehiculoSiniestros").removeClass("is-invalid");
  $("#rutPersonalSiniestros").removeClass("is-invalid");
  $("#marcaVehiculoSiniestros").val("");
  $("#marcaVehiculoSiniestros").attr("disabled","disabled");
  $("#modeloVehiculoSiniestros").val("");
  $("#modeloVehiculoSiniestros").attr("disabled","disabled");
  $("#anoVehiculoSiniestros").val("");
  $("#anoVehiculoSiniestros").attr("disabled","disabled");
  $("#piezasDañadasVehiculoSiniestros").val("");
  $("#fechaSiniestros").val("");
  $("#horaSiniestros").val("");
  $("#direccionSiniestros").val("");
  $("#parteSiniestros").val("");
  $("#comisariaSiniestros").val("");
  $("#datosTerceroSiniestros").html("");
  $("#descripcionSiniestros").val("");
});

$("#guardarIngresoSiniestros").unbind('click').click(async function(){
  if($("#rutPersonalSiniestros").val().length == 0 || $("#patenteVehiculoSiniestros").val().length == 0 || $("#fechaSiniestros").val().length == 0 || $("#direccionSiniestros").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#rutPersonalSiniestros").val().length == 0){
      $("#rutPersonalSiniestros").addClass("is-invalid");
    }
    if ($("#patenteVehiculoSiniestros").val().length == 0){
      $("#patenteVehiculoSiniestros").addClass("is-invalid");
    }
    if ($("#fechaSiniestros").val().length == 0){
      $("#fechaSiniestros").addClass("is-invalid");
    }
    if ($("#direccionSiniestros").val().length == 0){
      $("#direccionSiniestros").addClass("is-invalid");
    }
  }
  else{
    parametros = {
      "rutPersonal": $("#rutPersonalSiniestros").val(),
      "correoPersonal": $("#correoPersonalSiniestros").val(),
      "direccionPersonal": $("#direccionPersonalSiniestros").val(),
      "comunaPersonal": $("#comunaPersonalSiniestros").val(),
      "celularPersonal": $("#celularPersonalSiniestros").val(),
      "patente": $("#patenteVehiculoSiniestros").val(),
      "textoPiezasDanadas": $("#piezasDañadasVehiculoSiniestros").val(),
      "fechaSiniestro": $("#fechaSiniestros").val(),
      "horaSiniestro": $("#horaSiniestros").val(),
      "direccionSiniestro": $("#direccionSiniestros").val(),
      "tipoSiniestro": $("#tipoSiniestros").val(),
      "nparteSiniestro": $("#parteSiniestros").val(),
      "comisariaSiniestro": $("#comisariaSiniestros").val(),
      "comunaSiniestro": $("#comunaSiniestros").val(),
      "nombreTercero": $("#nombreTerceroSiniestros").val(),
      "correoTercero": $("#correoTerceroSiniestros").val(),
      "celularTercero": $("#celularTerceroSiniestros").val(),
      "direccionTercero": $("#direccionTerceroSiniestros").val(),
      "comunaTercero": $("#comunaTerceroSiniestros").val(),
      "patenteTercero": $("#patenteTerceroSiniestros").val(),
      "marcaTercero": $("#marcaTerceroSiniestros").val(),
      "modeloTercero": $("#modeloTerceroSiniestros").val(),
      "anoTercero": $("#anoTerceroSiniestros").val(),
      "piezasDanadasTercero": $("#piezasDañadasTerceroSiniestros").val(),
      "descripcion": $("#descripcionSiniestros").val(),
      "nombrePersonal": $("#nombrePersonalSiniestros").val(),
      "tipoDanoInfra": $("#tipoDanoInfra").val(),
      "observacionDanosInfra": $("#observacionDanosInfra").val(),
    }
    $("#modalIngresoSiniestros").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    await $.ajax({
      url: "controller/ingresarSiniestros.php",
      type: 'POST',
      data: parametros,
      success:  async function (response) {
        var p = jQuery.parseJSON(response);
        await $.ajax({
          url: "controller/generaPDF/formularioSiniestro.php?idLoad=205",
          type:"POST",
          data:{
            "idSiniestro": Number(p[0]['LAST_INSERT_ID()']),
            "url": window.location.toString().split("?")[0]
          },
          success: async function (res1){
            window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/flota/siniestros/formulario' + res1, '_blank');
            await $.ajax({
              url: "controller/generaPDF/declaracionSiniestro.php?idLoad=205",
              type: "POST",
              data:{
                "idSiniestro": Number(p[0]['LAST_INSERT_ID()']),
                "url": window.location.toString().split("?")[0]
              },
              success: function (res2){
                window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/flota/siniestros/declaracion' + res2, '_blank');
                var p = res2.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                  if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaListadoSiniestros').DataTable();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Siniestro ingresado correctamente");
                    $("#subirPdfSiniestros").attr("disabled","disabled");
                    $("#numeroSiniestros").attr("disabled","disabled");
                    $("#numeroFacturaSiniestros").attr("disabled","disabled");
                    $("#descuentoSiniestros").attr("disabled","disabled");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                  else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear siniestro, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear siniestro, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
            });
          }
        });
      }
    });
  }
});

$("#fechaSiniestros").on('change', function(){
  $(this).removeClass("is-invalid");
});

$("#direccionSiniestros").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN FUNCION PARA MODAL CREAR SINIESTROS

$("#asignarDespachoOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();
  var parametros = {
    'idarea': datos[0].IDAREAFUNCIONAL,
    'idestructura': datos[0].IDESTRUCTURA_OPERACION
  }

  await $.ajax({
    url:   'controller/datosUsuariosAsignablesOrden.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoDes = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].TIPO == 'Despacho'){
            cuerpoDes += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
          }
        }
        $("#despachoAsignarDespachoOrdenes").html(cuerpoDes);

        $("#despachoAsignarDespachoOrdenes").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalAsignarDespachoOrdenes").modal("show");
        },500);
      }
      else{
        $("#despachoAsignarDespachoOrdenes").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalAsignarDespachoOrdenes").modal("show");
        },500);
      }
    }
  });
});

$("#asignarTecnicoOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();
  var parametros = {
    'idarea': datos[0].IDAREAFUNCIONAL,
    'idestructura': datos[0].IDESTRUCTURA_OPERACION
  }

  await $.ajax({
    url:   'controller/datosUsuariosAsignablesOrden.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoTec = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].TIPO == 'Tecnico'){
            cuerpoTec += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
          }
        }
        $("#despachoAsignarTecnicoOrdenes").html(cuerpoTec);
        $("#despachoAsignarTecnicoOrdenes").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalAsignarTecnicoOrdenes").modal("show");
        },500);
      }
      else{
        $("#despachoAsignarTecnicoOrdenes").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalAsignarTecnicoOrdenes").modal("show");
        },500);
      }
    }
  });
});

$("#asignarPersonalZonaOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorZonas').DataTable();
  var datos = table.rows('.selected').data();
  var parametros = {
    'idez': datos[0].FOLIO
  }

  $("#tituloConfigurarZonasPersonal").html('');
  $("#tituloConfigurarZonasPersonal").html(datos[0].SERVICIO + ' - ' + datos[0].CLIENTE + ' - ' + datos[0].ACTIVIDAD + ' - ' + datos[0].COMUNA);

  await $.ajax({
    url:   'controller/datosPersonalOrdenZonaAsignar.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPer = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + ' - ' + p2.aaData[i].PERFIL + '</option>';
        }
        $("#personalConfigurarZonasPersonal").html(cuerpoPer);
      }
    }
  });

  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/40);

  await $('#tablaConfigurarZonasPersonal').DataTable( {
      ajax: {
          url: "controller/datosPersonalOrdenZonaAsignados.php",
          type: 'POST',
          data: parametros
      },
      columns: [
          { data: 'S'},
          { data: 'RUT' },
          { data: 'NOMBRE'},
          { data: 'PERFIL' },
          { data: 'TIPO' },
          { data: 'BORRAR', className: 'centerDataTable hoverDel' }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        },
        {
          "width": "5px",
          "targets": 5
        }
      ],
      "select": {
          style: 'single',
          selector: 'td:not(:nth-child(6))'
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "order": [[ 2, "asc" ]],
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'rtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json){
      }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#personalConfigurarZonasPersonal").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#funcionConfigurarZonasPersonal").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  var h = $(window).height() - 200;
  $("#bodyConfigurarZonasPersonal").css("height",h);
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalConfigurarZonasPersonal").modal("show");
    setTimeout(function(){
      $('#tablaConfigurarZonasPersonal').DataTable().columns.adjust();
    },500);
  },500);
});

async function quitarPersonalZonaOrden(id){
  $("#modalConfigurarZonasPersonal").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var parametros = {
    'id': id
  }
  await $.ajax({
    url: "controller/eliminarPersonalZonaOrden.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaConfigurarZonasPersonal').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Ejecutado correctamente");
          $("#editarUsuario").attr("disabled","disabled");
          $("#usuarioResetPass").attr("disabled","disabled");
          var table = $('#tablaMantenedorZonas').DataTable();
          var datos = table.rows('.selected').data();
          var parametros = {
            'idez': datos[0].FOLIO
          }
          $.ajax({
            url:   'controller/datosPersonalOrdenZonaAsignar.php',
            type:  'post',
            data:  parametros,
            success: function (response2) {
              var p2 = jQuery.parseJSON(response2);
              if(p2.aaData.length !== 0){
                var cuerpoPer = '';
                for(var i = 0; i < p2.aaData.length; i++){
                  cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + ' - ' + p2.aaData[i].PERFIL + '</option>';
                }
                $("#personalConfigurarZonasPersonal").html(cuerpoPer);
              }

              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $("#modalConfigurarZonasPersonal").modal("show");
                setTimeout(function(){
                  $('#tablaConfigurarZonasPersonal').DataTable().columns.adjust();
                },500);
              },500);
            }
          });
          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#personalConfigurarZonasPersonal").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalConfigurarZonasPersonal").modal("show");
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalConfigurarZonasPersonal").modal("show");
        },500);
      }
    }
  });
}

$("#agregarConfigurarZonasPersonal").unbind("click").click(async function(){
  $("#modalConfigurarZonasPersonal").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorZonas').DataTable();
  var datos = table.rows('.selected').data();
  var parametros = {
    'idusuario': $("#personalConfigurarZonasPersonal").val(),
    'idoz': datos[0].FOLIO,
    'tipo': $("#funcionConfigurarZonasPersonal").val()
  }

  await $.ajax({
    url: "controller/ingresarPersonalZonaOrden.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaConfigurarZonasPersonal').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Ejecutado correctamente");
          $("#editarUsuario").attr("disabled","disabled");
          $("#usuarioResetPass").attr("disabled","disabled");
          var table = $('#tablaMantenedorZonas').DataTable();
          var datos = table.rows('.selected').data();
          var parametros = {
            'idez': datos[0].FOLIO
          }
          $.ajax({
            url:   'controller/datosPersonalOrdenZonaAsignar.php',
            type:  'post',
            data:  parametros,
            success: function (response2) {
              var p2 = jQuery.parseJSON(response2);
              if(p2.aaData.length !== 0){
                var cuerpoPer = '';
                for(var i = 0; i < p2.aaData.length; i++){
                  cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + ' - ' + p2.aaData[i].PERFIL + '</option>';
                }
                $("#personalConfigurarZonasPersonal").html(cuerpoPer);

                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  $("#modalConfigurarZonasPersonal").modal("show");
                  setTimeout(function(){
                    $('#tablaConfigurarZonasPersonal').DataTable().columns.adjust();
                  },500);
                },500);
              }
            }
          });
          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#personalConfigurarZonasPersonal").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalConfigurarZonasPersonal").modal("show");
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalConfigurarZonasPersonal").modal("show");
        },500);
      }
    }
  });
});

// Funcion para el filtro por periodo de Siniestros (Cambio de fecha)
$("#periodoFiltroSiniestros").unbind("click").change(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  var parametros = {
    "path": path,
    "ano": $("#periodoFiltroSiniestros").val().split("-")[0],
    "mes": $("#periodoFiltroSiniestros").val().split("-")[1]
  }

  await $('#tablaListadoSiniestros').DataTable( {
      ajax: {
          url: "controller/datosSiniestros.php",
          type: 'POST',
          data: parametros,
      },
      columns: [
        { data: 'S'},
        { data: 'IDPATENTE_SINIESTROS', className: "centerDataTable" },
        { data: 'CODIGO'},
        { data: 'ESTADO'},
        { data: 'PATENTE_REEMPLAZO'},
        { data: 'N_SINIESTRO', className: "centerDataTable"},
        { data: 'N_FACTURA', className: "centerDataTable"},
        { data: 'FECHA'},
        { data: 'HORA' },
        { data: 'GRAVEDAD' },
        { data: 'DNI'},
        { data: 'PERSONAL'},
        { data: 'TELEFONO'},
        { data: 'SERVICIO' },
        { data: 'CLIENTE'},
        { data: 'ACTIVIDAD'},
        { data: 'COMUNA'},
        { data: 'DESCUENTO'},
        { data: 'MONTODESC', className: "centerDataTable"},
        { data: 'COSTOTOTAL', className: "centerDataTable"},
        { data: 'USUARIO'},
        { data: 'PDF_SINIESTRO', className: "centerDataTable" },
        { data: 'PDF_DECLARACION', className: "centerDataTable" },
        { data: 'PDF_DECLARACION_ASEG', className: "centerDataTable" },
        { data: 'PDF_LIC_CED', className: "centerDataTable" },
        { data: 'PDF_DESCUENTO', className: "centerDataTable" }
      ],
      buttons: [
          {
            extend: 'excel',
            exportOptions: {
              columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18 ]
            },
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        // {
        //   "orderable": false,
        //   "className": 'select-checkbox',
        //   "targets": [ 0 ]
        // },
      ],
      "select": {
          style: 'single'
      },
      "scrollX": false,
      "responsive": {
          details: {
              renderer: function ( api, rowIdx, columns ) {
                  var data = $.map( columns, function ( col, i ) {
                      return col.hidden ?
                          '<tr data-dt-row="'+col.rowIndex+'" data-dt-column="'+col.columnIndex+'">'+
                              '<td style="font-weight: bold; min-width: 150px;">'+col.title+':'+'</td> '+
                              '<td style="min-width: 150px; text-align: center;">'+col.data+'</td>'+
                          '</tr>' :
                          '';
                  } ).join('');

                  return data ?
                      $('<table/>').append( data ) :
                      false;
              }
          }
      },
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function(){
        setTimeout(function(){
          var table = $('#tablaListadoSiniestros').DataTable();

          var gravedadSel = '';
          gravedadSel += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(7).data().unique().length; i++){
            if(table.column(7).data().unique()[i] !== null){
              gravedadSel += '<option value="' + table.column(7).data().unique()[i] + '">' + table.column(7).data().unique()[i] + '</option>';
            }
          }
          $("#tipoFiltroSiniestros").html(gravedadSel);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#tipoFiltroSiniestros").select2('destroy').select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        },500);
      }
  });
});
// Fin Funcion para el filtro por periodo de Siniestros (Cambio de fecha)

$("#guardarAsignarDespachoOrdenes").unbind("click").click(async function(){
  $("#modalAsignarDespachoOrdenes").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();
  var ordenes = [];

  for(var i = 0; i < datos.length; i++){
    ordenes.push(datos[i].IDORDEN);
  }
  var parametros = {
    'idusuario': $("#despachoAsignarDespachoOrdenes").val(),
    'ordenes': ordenes
  }

  await $.ajax({
    url: "controller/actualizarDespachoOrden.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaOrdenes').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload();
          $("#agendarOrden").attr("disabled", "disabled");
          $("#asignarDespachoOrden").attr("disabled", "disabled");
          $("#asignarTecnicoOrden").attr("disabled", "disabled");
          $("#botonEstadoOrden").attr("disabled", "disabled");
          $("#completarOrden").attr("disabled", "disabled");
          $("#observacionOrden").attr("disabled", "disabled");

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Despacho asignado correctamente");
          $("#agendarOrden").attr("disabled", "disabled");
          $("#asignarDespachoOrden").attr("disabled", "disabled");
          $("#asignarTecnicoOrden").attr("disabled", "disabled");
          $("#botonEstadoOrden").attr("disabled", "disabled");
          $("#completarOrden").attr("disabled", "disabled");
          $("#observacionOrden").attr("disabled", "disabled");
          $("#historialOrden").attr("disabled", "disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#guardarAsignarTecnicoOrdenes").unbind("click").click(async function(){
  $("#modalAsignarTecnicoOrdenes").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();
  var ordenes = [];

  for(var i = 0; i < datos.length; i++){
    ordenes.push(datos[i].IDORDEN);
  }
  var parametros = {
    'idusuario': $("#despachoAsignarTecnicoOrdenes").val(),
    'ordenes': ordenes
  }

  await $.ajax({
    url: "controller/actualizarTecnicoOrden.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaOrdenes').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload();
          $("#agendarOrden").attr("disabled", "disabled");
          $("#asignarDespachoOrden").attr("disabled", "disabled");
          $("#asignarTecnicoOrden").attr("disabled", "disabled");
          $("#botonEstadoOrden").attr("disabled", "disabled");
          $("#completarOrden").attr("disabled", "disabled");
          $("#observacionOrden").attr("disabled", "disabled");

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Técnico asignado correctamente");
          $("#agendarOrden").attr("disabled", "disabled");
          $("#asignarDespachoOrden").attr("disabled", "disabled");
          $("#asignarTecnicoOrden").attr("disabled", "disabled");
          $("#botonEstadoOrden").attr("disabled", "disabled");
          $("#completarOrden").attr("disabled", "disabled");
          $("#observacionOrden").attr("disabled", "disabled");
          $("#historialOrden").attr("disabled", "disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#botonEstadoOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();

  $("#tituloAsignarEstadoOrdenes").html("Folio: " + datos[0].FOLIO);

  await $.ajax({
    url:   'controller/datosEstadosOrden.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEst = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].IDORDEN_ESTADO == datos[0].IDORDEN_ESTADO){
            cuerpoEst += '<option selected value="' + p2.aaData[i].IDORDEN_ESTADO + '">' + p2.aaData[i].ESTADO_SEL + '</option>';
          }
          else{
            cuerpoEst += '<option value="' + p2.aaData[i].IDORDEN_ESTADO + '">' + p2.aaData[i].ESTADO_SEL + '</option>';
          }
        }
        $("#despachoAsignarEstadoOrdenes").html(cuerpoEst);
        $("#despachoAsignarEstadoOrdenes").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
            sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
        });
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalAsignarEstadoOrdenes").modal("show");
        },500);
      }
      else{
        $("#despachoAsignarEstadoOrdenes").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
            sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
        });
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalAsignarEstadoOrdenes").modal("show");
        },500);
      }
    }
  });
});

$("#observacionOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();

  $("#tituloAsignarObservacionOrdenes").html("Folio: " + datos[0].FOLIO + "<br>Fecha: " + moment().format('YYYY-MM-DD HH:mm:ss').toString());
  $("#observacionObservacionOrdenes").val('');

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalAsignarObservacionOrdenes").modal("show");
  },500);
});

$("#guardarAsignarEstadoOrdenes").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalAsignarEstadoOrdenes").modal("hide");
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();
  var parametros = {
    "idorden": datos[0].IDORDEN,
    "idestado": $("#despachoAsignarEstadoOrdenes").val()
  }

  await $.ajax({
    url: "controller/actualizarEstadoOrden.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaOrdenes').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload();

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Estado actualizado correctamente");
          $("#agendarOrden").attr("disabled", "disabled");
          $("#asignarDespachoOrden").attr("disabled", "disabled");
          $("#asignarTecnicoOrden").attr("disabled", "disabled");
          $("#botonEstadoOrden").attr("disabled", "disabled");
          $("#completarOrden").attr("disabled", "disabled");
          $("#observacionOrden").attr("disabled", "disabled");
          $("#historialOrden").attr("disabled", "disabled");

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#guardarAsignarObservacionOrdenes").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalAsignarObservacionOrdenes").modal("hide");
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();
  var parametros = {
    "idorden": datos[0].IDORDEN,
    "observacion": $("#observacionObservacionOrdenes").val()
  }

  await $.ajax({
    url: "controller/actualizarObservacionOrden.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaOrdenes').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload();

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Observación actualizada correctamente");
          $("#agendarOrden").attr("disabled", "disabled");
          $("#asignarDespachoOrden").attr("disabled", "disabled");
          $("#asignarTecnicoOrden").attr("disabled", "disabled");
          $("#botonEstadoOrden").attr("disabled", "disabled");
          $("#completarOrden").attr("disabled", "disabled");
          $("#observacionOrden").attr("disabled", "disabled");
          $("#historialOrden").attr("disabled", "disabled");

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#completarOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();

  $("#tituloCompletarOrden").html("Folio: " + datos[0].FOLIO);
  $("#ordenCompletarOrden").html(datos[0].FOLIO);

  await $.ajax({
    url:   'controller/datosEstadosOrden.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].ESTADO_SEL == 'Agendada / Completada'){
            $("#idCompletarOrden").val(p2.aaData[i].IDORDEN_ESTADO);
          }
        }
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalCompletarOrden").modal("show");
        },500);
      }
    }
  });
});

$("#guardarCompletarOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalCompletarOrden").modal("hide");
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();
  var parametros = {
    "idorden": datos[0].IDORDEN,
    "idestado": $("#idCompletarOrden").val()
  }

  await $.ajax({
    url: "controller/actualizarEstadoOrden.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaOrdenes').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload();

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Orden completada correctamente");
          $("#agendarOrden").attr("disabled", "disabled");
          $("#asignarDespachoOrden").attr("disabled", "disabled");
          $("#asignarTecnicoOrden").attr("disabled", "disabled");
          $("#botonEstadoOrden").attr("disabled", "disabled");
          $("#completarOrden").attr("disabled", "disabled");
          $("#observacionOrden").attr("disabled", "disabled");
          $("#historialOrden").attr("disabled", "disabled");

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#completadasOrden").unbind("click").change(async function(){
  $("#fechaOrden").removeAttr("disabled");
  $("#agendarOrden").attr("disabled", "disabled");
  $("#asignarDespachoOrden").attr("disabled", "disabled");
  $("#asignarTecnicoOrden").attr("disabled", "disabled");
  $("#botonEstadoOrden").attr("disabled", "disabled");
  $("#completarOrden").attr("disabled", "disabled");
  $("#observacionOrden").attr("disabled", "disabled");
  $("#sinAgendaOrden").prop("checked",false);
  if($("#completadasOrden").prop("checked")){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    //initialize the plugin and get its instance
    var instance = OverlayScrollbars(document.getElementById('contenido'), { });

    //destroy the instance
    instance.destroy();

    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

    var parametros = {
      "fecha": $("#fechaOrden").val(),
      "path": window.location.href.split('#/')[1]
    }

    await $('#tablaOrdenes').DataTable( {
        ajax: {
            url: "controller/datosOrdenesFechaCompletadas.php",
            type: 'POST',
            data: parametros
        },
        columns: [
          { data: 'S'},
          { data: 'FOLIO'},
          { data: 'PROYECTO'},
          { data: 'COMUNA'},
          { data: 'CATEGORIA'},
          { data: 'TIPO'},
          { data: 'SUB_TIPO'},
          { data: 'TECNOLOGIA'},
          { data: 'ESTADO'},
          { data: 'SUB_ESTADO'},
          { data: 'Q_AGENDA', className: "centerDataTable"},
          { data: 'FECHA_CREACION', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'FECHA_AGENDA', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'HORA_AGENDA', className: "centerDataTable"},
          { data: 'TRAMO'},
          { data: 'FECHA_ATENCION'},
          { data: 'HORA_INICIO'},
          { data: 'HORA_FIN'},
          { data: 'DIRECCION'},
          { data: 'DNI_CLIENTE'},
          { data: 'NOMBRE_CLIENTE'},
          { data: 'FONO_CLIENTE'},
          { data: 'EMPRESA'},
          { data: 'DESPACHO'},
          { data: 'TECNICO'},
          { data: 'IDORDEN'},
          { data: 'LATITUD'},
          { data: 'LONGITUD'},
          { data: 'ESTADO_TEXTO'},
          { data: 'SUB_ESTADO_TEXTO'},
          { data: 'DNI_DESPACHO'},
          { data: 'RUT_TECNICO'},
          { data: 'IDESTRUCTURA_OPERACION'},
          { data: 'IDAREAFUNCIONAL'},
          { data: 'DIRECCIONLIMPIA'},
          { data: 'IDORDEN_ESTADO'},
          { data: 'OBSERVACION'}
        ],
        buttons: [
            {
              extend: 'excel',
              exportOptions: {
                columns: [ 1,	2,	3,	4,	5,	6,	7,	8,	9,	10,	11,	12,	13,	14,	15,	16,	17,	18,	19,	20,	21,	22,	23, 24 ]
              },
              title: null,
              text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
            },
            {
              text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
              action: function ( e, dt, node, config ) {
                var table = $('#tablaOrdenes').DataTable();
                $("#agendarOrden").attr("disabled", "disabled");
                $("#asignarDespachoOrden").attr("disabled", "disabled");
                $("#asignarTecnicoOrden").attr("disabled", "disabled");
                $("#estadoOrden").attr("disabled", "disabled");
                $("#completarOrden").attr("disabled", "disabled");
                $("#observacionOrden").attr("disabled", "disabled");
                table.rows().deselect();
              }
            },
            {
              text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonFiltrosOrden"></span>&nbsp;&nbsp;Filtros',
              action: function(){
                if($("#filtrosOrden").height() > 100){
                  $("#filtrosOrden").css("height","0");
                  $("#filtrosOrden").fadeOut();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
                }
                else{
                  $("#filtrosOrden").css("height","150pt");
                  $("#filtrosOrden").fadeIn();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
                }
              }
            }
        ],
        "columnDefs": [
          {
            "width": "5px",
            "targets": 0
          },
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 25 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 26 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 27 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 28 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 29 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 30 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 31 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 32 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 33 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 34 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 35 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 36 ]
          }
        ],
        fixedColumns:   {
          leftColumns: 2
        },
        "select": {
            style: 'multi'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        "order": [[ 1, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'Bfrtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": true,
        "initComplete": function( settings, json){
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();

          var table = $('#tablaOrdenes').DataTable();

          var comunaOr = '';
          comunaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(3).data().unique().length; i++){
            if(table.column(3).data().unique()[i] !== null){
              comunaOr += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
            }
          }
          $("#comunaOrden").html(comunaOr);

          var categoriaOr = '';
          categoriaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(4).data().unique().length; i++){
            if(table.column(4).data().unique()[i] !== null){
              categoriaOr += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
            }
          }
          $("#categoriaOrden").html(categoriaOr);

          var tipoOr = '';
          tipoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(5).data().unique().length; i++){
            if(table.column(5).data().unique()[i] !== null){
              tipoOr += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
            }
          }
          $("#tipoOrden").html(tipoOr);

          var estadoOr = '';
          estadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(28).data().unique().length; i++){
            if(table.column(28).data().unique()[i] !== null){
              estadoOr += '<option value="' + table.column(28).data().unique()[i] + '">' + table.column(28).data().unique()[i] + '</option>';
            }
          }
          $("#estadoOrden").html(estadoOr);

          var subEstadoOr = '';
          subEstadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(29).data().unique().length; i++){
            if(table.column(29).data().unique()[i] !== null){
              subEstadoOr += '<option value="' + table.column(29).data().unique()[i] + '">' + table.column(29).data().unique()[i] + '</option>';
            }
          }
          $("#subEstadoOrden").html(subEstadoOr);

          var tramoOr = '';
          tramoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(14).data().unique().length; i++){
            if(table.column(14).data().unique()[i] !== null){
              tramoOr += '<option value="' + table.column(14).data().unique()[i] + '">' + table.column(14).data().unique()[i] + '</option>';
            }
          }
          $("#tramoOrden").html(tramoOr);

          var agendasOr = '';
          agendasOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(10).data().unique().length; i++){
            if(table.column(10).data().unique()[i] !== null){
              agendasOr += '<option value="' + table.column(10).data().unique()[i] + '">' + table.column(10).data().unique()[i] + '</option>';
            }
          }
          $("#reagendamientoOrden").html(agendasOr);

          var proyectoOr = '';
          proyectoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(2).data().unique().length; i++){
            if(table.column(2).data().unique()[i] !== null){
              proyectoOr += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
            }
          }
          $("#proyectoOrden").html(proyectoOr);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#comunaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#categoriaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tipoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tramoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#estadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#subEstadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#reagendamientoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
            });
            $("#proyectoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
          setTimeout(async function(){
            menuElegant();
            if($("#filtrosOrden").height() > 100){
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
            }
            else{
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
            }
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaOrdenes').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    //initialize the plugin and get its instance
    var instance = OverlayScrollbars(document.getElementById('contenido'), { });

    //destroy the instance
    instance.destroy();

    var parametros = {
      "fecha": $("#fechaOrden").val(),
      "path": window.location.href.split('#/')[1]
    }

    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

    await $('#tablaOrdenes').DataTable( {
        ajax: {
            url: "controller/datosOrdenesFecha.php",
            type: 'POST',
            data: parametros
        },
        columns: [
          { data: 'S'},
          { data: 'FOLIO'},
          { data: 'PROYECTO'},
          { data: 'COMUNA'},
          { data: 'CATEGORIA'},
          { data: 'TIPO'},
          { data: 'SUB_TIPO'},
          { data: 'TECNOLOGIA'},
          { data: 'ESTADO'},
          { data: 'SUB_ESTADO'},
          { data: 'Q_AGENDA', className: "centerDataTable"},
          { data: 'FECHA_CREACION', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'FECHA_AGENDA', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'HORA_AGENDA', className: "centerDataTable"},
          { data: 'TRAMO'},
          { data: 'FECHA_ATENCION'},
          { data: 'HORA_INICIO'},
          { data: 'HORA_FIN'},
          { data: 'DIRECCION'},
          { data: 'DNI_CLIENTE'},
          { data: 'NOMBRE_CLIENTE'},
          { data: 'FONO_CLIENTE'},
          { data: 'EMPRESA'},
          { data: 'DESPACHO'},
          { data: 'TECNICO'},
          { data: 'IDORDEN'},
          { data: 'LATITUD'},
          { data: 'LONGITUD'},
          { data: 'ESTADO_TEXTO'},
          { data: 'SUB_ESTADO_TEXTO'},
          { data: 'DNI_DESPACHO'},
          { data: 'RUT_TECNICO'},
          { data: 'IDESTRUCTURA_OPERACION'},
          { data: 'IDAREAFUNCIONAL'},
          { data: 'DIRECCIONLIMPIA'},
          { data: 'IDORDEN_ESTADO'},
          { data: 'OBSERVACION'}
        ],
        buttons: [
            {
              extend: 'excel',
              exportOptions: {
                columns: [ 1,	2,	3,	4,	5,	6,	7,	8,	9,	10,	11,	12,	13,	14,	15,	16,	17,	18,	19,	20,	21,	22,	23, 24 ]
              },
              title: null,
              text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
            },
            {
              text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
              action: function ( e, dt, node, config ) {
                var table = $('#tablaOrdenes').DataTable();
                $("#agendarOrden").attr("disabled", "disabled");
                $("#asignarDespachoOrden").attr("disabled", "disabled");
                $("#asignarTecnicoOrden").attr("disabled", "disabled");
                $("#estadoOrden").attr("disabled", "disabled");
                $("#completarOrden").attr("disabled", "disabled");
                $("#observacionOrden").attr("disabled", "disabled");
                table.rows().deselect();
              }
            },
            {
              text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonFiltrosOrden"></span>&nbsp;&nbsp;Filtros',
              action: function(){
                if($("#filtrosOrden").height() > 100){
                  $("#filtrosOrden").css("height","0");
                  $("#filtrosOrden").fadeOut();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
                }
                else{
                  $("#filtrosOrden").css("height","150pt");
                  $("#filtrosOrden").fadeIn();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
                }
              }
            }
        ],
        "columnDefs": [
          {
            "width": "5px",
            "targets": 0
          },
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 25 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 26 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 27 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 28 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 29 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 30 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 31 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 32 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 33 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 34 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 35 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 36 ]
          }
        ],
        fixedColumns:   {
          leftColumns: 2
        },
        "select": {
            style: 'multi'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        "order": [[ 1, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'Bfrtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": true,
        "initComplete": function( settings, json){
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();

          var table = $('#tablaOrdenes').DataTable();

          var comunaOr = '';
          comunaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(3).data().unique().length; i++){
            if(table.column(3).data().unique()[i] !== null){
              comunaOr += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
            }
          }
          $("#comunaOrden").html(comunaOr);

          var categoriaOr = '';
          categoriaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(4).data().unique().length; i++){
            if(table.column(4).data().unique()[i] !== null){
              categoriaOr += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
            }
          }
          $("#categoriaOrden").html(categoriaOr);

          var tipoOr = '';
          tipoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(5).data().unique().length; i++){
            if(table.column(5).data().unique()[i] !== null){
              tipoOr += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
            }
          }
          $("#tipoOrden").html(tipoOr);

          var estadoOr = '';
          estadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(28).data().unique().length; i++){
            if(table.column(28).data().unique()[i] !== null){
              estadoOr += '<option value="' + table.column(28).data().unique()[i] + '">' + table.column(28).data().unique()[i] + '</option>';
            }
          }
          $("#estadoOrden").html(estadoOr);

          var subEstadoOr = '';
          subEstadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(29).data().unique().length; i++){
            if(table.column(29).data().unique()[i] !== null){
              subEstadoOr += '<option value="' + table.column(29).data().unique()[i] + '">' + table.column(29).data().unique()[i] + '</option>';
            }
          }
          $("#subEstadoOrden").html(subEstadoOr);

          var tramoOr = '';
          tramoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(14).data().unique().length; i++){
            if(table.column(14).data().unique()[i] !== null){
              tramoOr += '<option value="' + table.column(14).data().unique()[i] + '">' + table.column(14).data().unique()[i] + '</option>';
            }
          }
          $("#tramoOrden").html(tramoOr);

          var agendasOr = '';
          agendasOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(10).data().unique().length; i++){
            if(table.column(10).data().unique()[i] !== null){
              agendasOr += '<option value="' + table.column(10).data().unique()[i] + '">' + table.column(10).data().unique()[i] + '</option>';
            }
          }
          $("#reagendamientoOrden").html(agendasOr);

          var proyectoOr = '';
          proyectoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(2).data().unique().length; i++){
            if(table.column(2).data().unique()[i] !== null){
              proyectoOr += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
            }
          }
          $("#proyectoOrden").html(proyectoOr);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#comunaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#categoriaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tipoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tramoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#estadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#subEstadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#reagendamientoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
            });
            $("#proyectoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
          setTimeout(async function(){
            menuElegant();
            if($("#filtrosOrden").height() > 100){
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
            }
            else{
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
            }
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaOrdenes').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
  }
});

$("#fechaOrden").unbind("click").change(async function(){
  $("#agendarOrden").attr("disabled", "disabled");
  $("#asignarDespachoOrden").attr("disabled", "disabled");
  $("#asignarTecnicoOrden").attr("disabled", "disabled");
  $("#botonEstadoOrden").attr("disabled", "disabled");
  $("#completarOrden").attr("disabled", "disabled");
  $("#observacionOrden").attr("disabled", "disabled");
  if($("#completadasOrden").prop("checked")){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    //initialize the plugin and get its instance
    var instance = OverlayScrollbars(document.getElementById('contenido'), { });

    //destroy the instance
    instance.destroy();

    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

    var parametros = {
      "fecha": $("#fechaOrden").val(),
      "path": window.location.href.split('#/')[1]
    }

    await $('#tablaOrdenes').DataTable( {
        ajax: {
            url: "controller/datosOrdenesFechaCompletadas.php",
            type: 'POST',
            data: parametros
        },
        columns: [
          { data: 'S'},
          { data: 'FOLIO'},
          { data: 'PROYECTO'},
          { data: 'COMUNA'},
          { data: 'CATEGORIA'},
          { data: 'TIPO'},
          { data: 'SUB_TIPO'},
          { data: 'TECNOLOGIA'},
          { data: 'ESTADO'},
          { data: 'SUB_ESTADO'},
          { data: 'Q_AGENDA', className: "centerDataTable"},
          { data: 'FECHA_CREACION', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'FECHA_AGENDA', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'HORA_AGENDA', className: "centerDataTable"},
          { data: 'TRAMO'},
          { data: 'FECHA_ATENCION'},
          { data: 'HORA_INICIO'},
          { data: 'HORA_FIN'},
          { data: 'DIRECCION'},
          { data: 'DNI_CLIENTE'},
          { data: 'NOMBRE_CLIENTE'},
          { data: 'FONO_CLIENTE'},
          { data: 'EMPRESA'},
          { data: 'DESPACHO'},
          { data: 'TECNICO'},
          { data: 'IDORDEN'},
          { data: 'LATITUD'},
          { data: 'LONGITUD'},
          { data: 'ESTADO_TEXTO'},
          { data: 'SUB_ESTADO_TEXTO'},
          { data: 'DNI_DESPACHO'},
          { data: 'RUT_TECNICO'},
          { data: 'IDESTRUCTURA_OPERACION'},
          { data: 'IDAREAFUNCIONAL'},
          { data: 'DIRECCIONLIMPIA'},
          { data: 'IDORDEN_ESTADO'},
          { data: 'OBSERVACION'}
        ],
        buttons: [
            {
              extend: 'excel',
              exportOptions: {
                columns: [ 1,	2,	3,	4,	5,	6,	7,	8,	9,	10,	11,	12,	13,	14,	15,	16,	17,	18,	19,	20,	21,	22,	23, 24 ]
              },
              title: null,
              text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
            },
            {
              text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
              action: function ( e, dt, node, config ) {
                var table = $('#tablaOrdenes').DataTable();
                $("#agendarOrden").attr("disabled", "disabled");
                $("#asignarDespachoOrden").attr("disabled", "disabled");
                $("#asignarTecnicoOrden").attr("disabled", "disabled");
                $("#estadoOrden").attr("disabled", "disabled");
                $("#completarOrden").attr("disabled", "disabled");
                $("#observacionOrden").attr("disabled", "disabled");
                table.rows().deselect();
              }
            },
            {
              text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonFiltrosOrden"></span>&nbsp;&nbsp;Filtros',
              action: function(){
                if($("#filtrosOrden").height() > 100){
                  $("#filtrosOrden").css("height","0");
                  $("#filtrosOrden").fadeOut();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
                }
                else{
                  $("#filtrosOrden").css("height","150pt");
                  $("#filtrosOrden").fadeIn();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
                }
              }
            }
        ],
        "columnDefs": [
          {
            "width": "5px",
            "targets": 0
          },
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 25 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 26 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 27 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 28 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 29 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 30 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 31 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 32 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 33 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 34 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 35 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 36 ]
          }
        ],
        fixedColumns:   {
          leftColumns: 2
        },
        "select": {
            style: 'multi'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        "order": [[ 1, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'Bfrtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": true,
        "initComplete": function( settings, json){
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();

          var table = $('#tablaOrdenes').DataTable();

          var comunaOr = '';
          comunaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(3).data().unique().length; i++){
            if(table.column(3).data().unique()[i] !== null){
              comunaOr += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
            }
          }
          $("#comunaOrden").html(comunaOr);

          var categoriaOr = '';
          categoriaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(4).data().unique().length; i++){
            if(table.column(4).data().unique()[i] !== null){
              categoriaOr += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
            }
          }
          $("#categoriaOrden").html(categoriaOr);

          var tipoOr = '';
          tipoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(5).data().unique().length; i++){
            if(table.column(5).data().unique()[i] !== null){
              tipoOr += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
            }
          }
          $("#tipoOrden").html(tipoOr);

          var estadoOr = '';
          estadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(28).data().unique().length; i++){
            if(table.column(28).data().unique()[i] !== null){
              estadoOr += '<option value="' + table.column(28).data().unique()[i] + '">' + table.column(28).data().unique()[i] + '</option>';
            }
          }
          $("#estadoOrden").html(estadoOr);

          var subEstadoOr = '';
          subEstadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(29).data().unique().length; i++){
            if(table.column(29).data().unique()[i] !== null){
              subEstadoOr += '<option value="' + table.column(29).data().unique()[i] + '">' + table.column(29).data().unique()[i] + '</option>';
            }
          }
          $("#subEstadoOrden").html(subEstadoOr);

          var tramoOr = '';
          tramoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(14).data().unique().length; i++){
            if(table.column(14).data().unique()[i] !== null){
              tramoOr += '<option value="' + table.column(14).data().unique()[i] + '">' + table.column(14).data().unique()[i] + '</option>';
            }
          }
          $("#tramoOrden").html(tramoOr);

          var agendasOr = '';
          agendasOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(10).data().unique().length; i++){
            if(table.column(10).data().unique()[i] !== null){
              agendasOr += '<option value="' + table.column(10).data().unique()[i] + '">' + table.column(10).data().unique()[i] + '</option>';
            }
          }
          $("#reagendamientoOrden").html(agendasOr);

          var proyectoOr = '';
          proyectoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(2).data().unique().length; i++){
            if(table.column(2).data().unique()[i] !== null){
              proyectoOr += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
            }
          }
          $("#proyectoOrden").html(proyectoOr);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#comunaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#categoriaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tipoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tramoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#estadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#subEstadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#reagendamientoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
            });
            $("#proyectoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
          setTimeout(async function(){
            menuElegant();
            if($("#filtrosOrden").height() > 100){
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
            }
            else{
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
            }
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaOrdenes').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    //initialize the plugin and get its instance
    var instance = OverlayScrollbars(document.getElementById('contenido'), { });

    //destroy the instance
    instance.destroy();

    var parametros = {
      "fecha": $("#fechaOrden").val(),
      "path": window.location.href.split('#/')[1]
    }

    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

    await $('#tablaOrdenes').DataTable( {
        ajax: {
            url: "controller/datosOrdenesFecha.php",
            type: 'POST',
            data: parametros
        },
        columns: [
          { data: 'S'},
          { data: 'FOLIO'},
          { data: 'PROYECTO'},
          { data: 'COMUNA'},
          { data: 'CATEGORIA'},
          { data: 'TIPO'},
          { data: 'SUB_TIPO'},
          { data: 'TECNOLOGIA'},
          { data: 'ESTADO'},
          { data: 'SUB_ESTADO'},
          { data: 'Q_AGENDA', className: "centerDataTable"},
          { data: 'FECHA_CREACION', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'FECHA_AGENDA', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'HORA_AGENDA', className: "centerDataTable"},
          { data: 'TRAMO'},
          { data: 'FECHA_ATENCION'},
          { data: 'HORA_INICIO'},
          { data: 'HORA_FIN'},
          { data: 'DIRECCION'},
          { data: 'DNI_CLIENTE'},
          { data: 'NOMBRE_CLIENTE'},
          { data: 'FONO_CLIENTE'},
          { data: 'EMPRESA'},
          { data: 'DESPACHO'},
          { data: 'TECNICO'},
          { data: 'IDORDEN'},
          { data: 'LATITUD'},
          { data: 'LONGITUD'},
          { data: 'ESTADO_TEXTO'},
          { data: 'SUB_ESTADO_TEXTO'},
          { data: 'DNI_DESPACHO'},
          { data: 'RUT_TECNICO'},
          { data: 'IDESTRUCTURA_OPERACION'},
          { data: 'IDAREAFUNCIONAL'},
          { data: 'DIRECCIONLIMPIA'},
          { data: 'IDORDEN_ESTADO'},
          { data: 'OBSERVACION'}
        ],
        buttons: [
            {
              extend: 'excel',
              exportOptions: {
                columns: [ 1,	2,	3,	4,	5,	6,	7,	8,	9,	10,	11,	12,	13,	14,	15,	16,	17,	18,	19,	20,	21,	22,	23, 24 ]
              },
              title: null,
              text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
            },
            {
              text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
              action: function ( e, dt, node, config ) {
                var table = $('#tablaOrdenes').DataTable();
                $("#agendarOrden").attr("disabled", "disabled");
                $("#asignarDespachoOrden").attr("disabled", "disabled");
                $("#asignarTecnicoOrden").attr("disabled", "disabled");
                $("#estadoOrden").attr("disabled", "disabled");
                $("#completarOrden").attr("disabled", "disabled");
                $("#observacionOrden").attr("disabled", "disabled");
                table.rows().deselect();
              }
            },
            {
              text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonFiltrosOrden"></span>&nbsp;&nbsp;Filtros',
              action: function(){
                if($("#filtrosOrden").height() > 100){
                  $("#filtrosOrden").css("height","0");
                  $("#filtrosOrden").fadeOut();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
                }
                else{
                  $("#filtrosOrden").css("height","150pt");
                  $("#filtrosOrden").fadeIn();
                  $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
                  $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
                }
              }
            }
        ],
        "columnDefs": [
          {
            "width": "5px",
            "targets": 0
          },
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 25 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 26 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 27 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 28 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 29 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 30 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 31 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 32 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 33 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 34 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 35 ]
          },
          {
            "visible": false,
            "searchable": true,
            "targets": [ 36 ]
          }
        ],
        fixedColumns:   {
          leftColumns: 2
        },
        "select": {
            style: 'multi'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        "order": [[ 1, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'Bfrtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": true,
        "initComplete": function( settings, json){
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();

          var table = $('#tablaOrdenes').DataTable();

          var comunaOr = '';
          comunaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(3).data().unique().length; i++){
            if(table.column(3).data().unique()[i] !== null){
              comunaOr += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
            }
          }
          $("#comunaOrden").html(comunaOr);

          var categoriaOr = '';
          categoriaOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(4).data().unique().length; i++){
            if(table.column(4).data().unique()[i] !== null){
              categoriaOr += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
            }
          }
          $("#categoriaOrden").html(categoriaOr);

          var tipoOr = '';
          tipoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(5).data().unique().length; i++){
            if(table.column(5).data().unique()[i] !== null){
              tipoOr += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
            }
          }
          $("#tipoOrden").html(tipoOr);

          var estadoOr = '';
          estadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(28).data().unique().length; i++){
            if(table.column(28).data().unique()[i] !== null){
              estadoOr += '<option value="' + table.column(28).data().unique()[i] + '">' + table.column(28).data().unique()[i] + '</option>';
            }
          }
          $("#estadoOrden").html(estadoOr);

          var subEstadoOr = '';
          subEstadoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(29).data().unique().length; i++){
            if(table.column(29).data().unique()[i] !== null){
              subEstadoOr += '<option value="' + table.column(29).data().unique()[i] + '">' + table.column(29).data().unique()[i] + '</option>';
            }
          }
          $("#subEstadoOrden").html(subEstadoOr);

          var tramoOr = '';
          tramoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(14).data().unique().length; i++){
            if(table.column(14).data().unique()[i] !== null){
              tramoOr += '<option value="' + table.column(14).data().unique()[i] + '">' + table.column(14).data().unique()[i] + '</option>';
            }
          }
          $("#tramoOrden").html(tramoOr);

          var agendasOr = '';
          agendasOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(10).data().unique().length; i++){
            if(table.column(10).data().unique()[i] !== null){
              agendasOr += '<option value="' + table.column(10).data().unique()[i] + '">' + table.column(10).data().unique()[i] + '</option>';
            }
          }
          $("#reagendamientoOrden").html(agendasOr);

          var proyectoOr = '';
          proyectoOr += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(2).data().unique().length; i++){
            if(table.column(2).data().unique()[i] !== null){
              proyectoOr += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
            }
          }
          $("#proyectoOrden").html(proyectoOr);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#comunaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#categoriaOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tipoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tramoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#estadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#subEstadoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#reagendamientoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
            });
            $("#proyectoOrden").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
          setTimeout(async function(){
            menuElegant();
            if($("#filtrosOrden").height() > 100){
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-down");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-up");
            }
            else{
              $("#spanButtonFiltrosOrden").removeClass("fas fa-arrow-alt-circle-up");
              $("#spanButtonFiltrosOrden").addClass("fas fa-arrow-alt-circle-down");
            }
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaOrdenes').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
  }
});

$("#agregarOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var h = $(window).height() - 200;
  $("#bodyIngOrden").css("height",h);

  var min = moment().format('YYYY/MM/DD');
  $.datetimepicker.setLocale('es');
  $("#fechaHoraIngOrden").datetimepicker({
    format: 'Y-m-d H:i',
    minDate: min.toString(),
    step: 01
  });

  await $.ajax({
    url: "controller/datosProyectosOrdenesIng.php",
    type: 'POST',
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoProy = '';
        p.aaData.forEach(({ ID, PROYECTO }) => {
          cuerpoProy += `<option value="${ID}">${PROYECTO}</option>`;
        });
        $("#proyectoIngOrden").html(cuerpoProy);
      }
    }
  });

  var parametrosOrden = {
    "idEstructura": $("#proyectoIngOrden").val()
  }

  await $.ajax({
    url: "controller/datosOrdenesEstructura.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoTramosOrden = '';
        p.aaData.forEach(({ IDORDEN_TRAMO, TRAMO, INICIO, FIN }) => {
          cuerpoTramosOrden += `<option value="${IDORDEN_TRAMO}">${TRAMO}</option>`;
        });
        $("#tramoIngOrden").html(cuerpoTramosOrden);
      }
    }
  });

  await $.ajax({
    url: "controller/datosComunasOrdenesIng.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoComuna = '';
        p.aaData.forEach(({ ID, COMUNA }) => {
          cuerpoComuna += `<option value="${ID}">${COMUNA}</option>`;
        });
        $("#comunaRegionIngOrden").html(cuerpoComuna);
      }
    }
  });

  await $.ajax({
    url: "controller/datosTipoOrdenesIng.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoTipo = '';
        p.aaData.forEach(({ ID, TIPO }) => {
          cuerpoTipo += `<option value="${ID}">${TIPO}</option>`;
        });
        $("#tipoIngOrden").html(cuerpoTipo);
      }
    }
  });

  parametrosOrden['idOrdenTipo'] = $("#tipoIngOrden").val();

  await $.ajax({
    url: "controller/datosCategoriaOrdenesIng.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoCat = '';
        p.aaData.forEach(({ ID, CATEGORIA }) => {
          cuerpoCat += `<option value="${ID}">${CATEGORIA}</option>`;
        });
        $("#categoriaIngOrden").html(cuerpoCat);
      }
    }
  });

  await $.ajax({
    url: "controller/datosEmpresaOrdenIng.php",
    type: 'POST',
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoEmpresa = '';
        p.aaData.forEach(({ ID, EMPRESA }) => {
          cuerpoEmpresa += `<option value="${ID}">${EMPRESA}</option>`;
        });
        $("#empresaIngOrden").html(cuerpoEmpresa);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoIngOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#tramoIngOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaRegionIngOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#tipoIngOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#categoriaIngOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#empresaIngOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalIngOrden").modal("show");
  },500);
});

async function dibujaTimeline(fecha){
  var tiempo;

  if(fecha === moment().format('YYYY-MM-DD').toString()){
    momentoActual = new Date();
    hora = momentoActual.getHours() + 10;
    minuto = momentoActual.getMinutes();
    segundo = momentoActual.getSeconds();

    if(hora < 10){
      hora = '0' + hora;
    }
    if(minuto < 10){
      minuto = '0' + minuto;
    }
    if(segundo < 10){
      segundo = '0' + segundo;
    }
    tiempo = hora + ":" + minuto;
  }
  else{
    hora = '23';
    minuto = '59';
    segundo = '59';
    tiempo = '23:59';
  }

  function MarcarHoy (div, filaActual){
    var altura = 0;
    $('#'+div+' rect').each(function( index ) {
      yValor = parseFloat($(this).attr('y'));
      xValor = parseFloat($(this).attr('x'));
      if ( yValor == 0 && yValor == 0 ) { altura = parseFloat($(this).attr('height')) };
    });
    $('#'+div+' text:contains(' + tiempo +')').css('font-size','11px').attr('fill','#A6373C').prev().first().attr('height',altura+'px').attr('width','1px').attr('y','0');

    $('#'+div+' text:contains("Hora actual")').css('font-size','11px').attr('fill','#A6373C').prev().first().attr('y','0');

    if (filaActual != -1) {
      if ( 0 == filaActual )
        $('.google-visualization-tooltip').css('display','none');
      else
        $('.google-visualization-tooltip').css('display','inline');
    }
  }

  google.charts.load('current', {'packages':['timeline']});
  google.charts.setOnLoadCallback(drawChart2);

  function drawChart2() {
    var container = document.getElementById('timelineOrdenesAsignadas');
    var chart = new google.visualization.Timeline(container);
    var dataTable = new google.visualization.DataTable();

    dataTable.addColumn({ type: 'string', id: 'TAC' });
    dataTable.addColumn({ type: 'string', id: 'Tipo' });
    dataTable.addColumn({ type: 'string', id: 'style', role: 'style' });
    dataTable.addColumn({ type: 'date', id: 'Inicio' });
    dataTable.addColumn({ type: 'date', id: 'Fin' });
    dataTable.addColumn({ type: 'string', role: 'tooltip', id: 'Id' });

    dataTable.addRows([
      ['Hora actual', tiempo, 'red', new Date(0,0,0,hora,minuto,segundo),  new Date(0,0,0,hora,minuto,segundo), 'hoy'],
    ]);

    var parametros = {
      "fecha": fecha,
      "path": window.location.href.split('#/')[1],
      "idestructura": $("#proyectoOrdenAsignada").val(),
      "idareafuncional": $("#comunaOrdenAsignada").val(),
      "idcategoria":  $("#categoriaOrdenAsignada").val(),
      "idtipo": $("#tipoOrdenAsignada").val(),
      "idtecnico": $("#técnicoOrdenAsignada").val()
    }

    let comunaOrAs = [];
    let categoriaOrAs = [];
    let tipoOrAs = [];
    let tecnicoOrAs = [];
    let proyectoOrAs = [];

    $.ajax({
      url:   'controller/datosOrdenesTimeline.php',
      type:  'post',
      data: parametros,
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          for(var i = 0; i < p2.aaData.length; i++){
            comunaOrAs.push(p2.aaData[i].IDAREAFUNCIONAL + ',' + p2.aaData[i].COMUNA);
            categoriaOrAs.push(p2.aaData[i].IDORDEN_CATEGORIA + ',' + p2.aaData[i].CATEGORIA);
            tipoOrAs.push(p2.aaData[i].IDORDEN_TIPO + ',' + p2.aaData[i].TIPO);
            tecnicoOrAs.push(p2.aaData[i].IDTECNICO + ',' + p2.aaData[i].NOMBRE);
            proyectoOrAs.push(p2.aaData[i].IDESTRUCTURA_OPERACION + ',' + p2.aaData[i].PROYECTO);
            dataTable.addRows([[
              '(' + p2.aaData[i].COMUNA + ') ' + p2.aaData[i].NOMBRE,
              p2.aaData[i].TIPO.substring(0,2) + '-' + p2.aaData[i].FOLIO,
              p2.aaData[i].COLOR,
              new Date(0,0,0,p2.aaData[i].HORA_INICIO,p2.aaData[i].MIN_INICIO,p2.aaData[i].SEC_INICIO),
              new Date(0,0,0,p2.aaData[i].HORA_FIN,p2.aaData[i].MIN_FIN,p2.aaData[i].SEC_FIN),
              p2.aaData[i].FOLIO
            ]]);
          }

          let comunaOrAsUnique = comunaOrAs.filter((item,index)=>{
            return comunaOrAs.indexOf(item) === index;
          });
          let categoriaOrAsUnique = categoriaOrAs.filter((item,index)=>{
            return categoriaOrAs.indexOf(item) === index;
          });
          let tipoOrAsUnique = tipoOrAs.filter((item,index)=>{
            return tipoOrAs.indexOf(item) === index;
          });
          let tecnicoOrAsUnique = tecnicoOrAs.filter((item,index)=>{
            return tecnicoOrAs.indexOf(item) === index;
          });
          let proyectoOrAsUnique = proyectoOrAs.filter((item,index)=>{
            return proyectoOrAs.indexOf(item) === index;
          });

          var comunaOr = '<option selected value="0">Todos</option>';
          comunaOrAsUnique.forEach((item, i) => {
            comunaOr += '<option value="' + item.split(',')[0] + '">' + item.split(',')[1] + '</option>';
          });
          var categoriaOr = '<option selected value="0">Todos</option>';
          categoriaOrAsUnique.forEach((item, i) => {
            categoriaOr += '<option value="' + item.split(',')[0] + '">' + item.split(',')[1] + '</option>';
          });
          var tipoOr = '<option selected value="0">Todos</option>';
          tipoOrAsUnique.forEach((item, i) => {
            tipoOr += '<option value="' + item.split(',')[0] + '">' + item.split(',')[1] + '</option>';
          });
          var tecnicoOr = '<option selected value="0">Todos</option>';
          tecnicoOrAsUnique.forEach((item, i) => {
            tecnicoOr += '<option value="' + item.split(',')[0] + '">' + item.split(',')[1] + '</option>';
          });
          var proyectoOr = '<option selected value="0">Todos</option>';
          proyectoOrAsUnique.forEach((item, i) => {
            proyectoOr += '<option value="' + item.split(',')[0] + '">' + item.split(',')[1] + '</option>';
          });

          $("#comunaOrdenAsignada").html(comunaOr);
          $("#categoriaOrdenAsignada").html(categoriaOr);
          $("#tipoOrdenAsignada").html(tipoOr);
          $("#técnicoOrdenAsignada").html(tecnicoOr);
          $("#proyectoOrdenAsignada").html(proyectoOr);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#comunaOrdenAsignada").select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#categoriaOrdenAsignada").select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tipoOrdenAsignada").select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#técnicoOrdenAsignada").select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#proyectoOrdenAsignada").select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }

          var options = {
            timeline: {
              rowLabelStyle: {
                fontSize: 12,
                color: 'black'
              },
              barLabelStyle: {
                fontSize: 12
              }
            },
            avoidOverlappingGridLines: false,
            enableInteractivity: true
          };

          chart.draw(dataTable, options);
          MarcarHoy('timelineOrdenesAsignadas',-1);

          google.visualization.events.addListener(chart, 'onmouseover', function(obj) {
            MarcarHoy('timelineOrdenesAsignadas',obj.row);
          });

          google.visualization.events.addListener(chart, 'onmouseout', function(obj) {
            MarcarHoy('timelineOrdenesAsignadas',-1);
          });

          google.visualization.events.addListener(chart, 'select', function () {
            var selection = chart.getSelection();
            if (selection.length > 0 && dataTable.getValue(selection[0].row, 5) !== 'hoy') {
              // console.log(dataTable.getValue(selection[0].row,0));
              // console.log(dataTable.getValue(selection[0].row,1));
              // console.log(dataTable.getValue(selection[0].row,2));
              // console.log(dataTable.getValue(selection[0].row,3));
              // console.log(dataTable.getValue(selection[0].row,4));
              // console.log(dataTable.getValue(selection[0].row,5));
            }
            MarcarHoy('timelineOrdenesAsignadas',-1);
          });

          var observer = new MutationObserver(setBorderRadius);
          google.visualization.events.addListener(chart, 'ready', function () {
            setBorderRadius();
            observer.observe(container, {
              childList: true,
              subtree: true
            });
            MarcarHoy('timelineOrdenesAsignadas',-1);
          });

          function setBorderRadius() {
            Array.prototype.forEach.call(container.getElementsByTagName('rect'), function (rect) {
              if (parseFloat(rect.getAttribute('x')) > 0) {
                rect.setAttribute('rx', 10);
                rect.setAttribute('ry', 10);
              }
            });
          }

          chart.clearChart();
          chart.draw(dataTable, options);

          esconderMenu();
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
}

$("#agregarTipoOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#minutosAgregarTipoOrden").val(0);
  $("#nombreAgregarTipoOrden").val('');
  await $.ajax({
    url:   'controller/datosProyectoConfigOrden.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoProyecto = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoProyecto += '<option value="' + p.aaData[i].ID_ESTRUCTURA + '" name="' + p.aaData[i].AREA + '">' + p.aaData[i].PROYECTO + '</option>';
        }
        $("#proyectoAgregarTipoOrden").html(cuerpoProyecto);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosOrdenClasificacion.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoClasi = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoClasi += '<option value="' + p.aaData[i].IDORDEN_CLASIFICACION + '">' + p.aaData[i].CLASIFICACION + '</option>';
        }
        $("#clasificacionAgregarTipoOrden").html(cuerpoClasi);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoAgregarTipoOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
        sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#clasificacionAgregarTipoOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
        sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
  }

  setTimeout(function(){
    $("#modalAgregarTipoOrden").modal("show");
    $("#modalAlertasSplash").modal("hide");
  },500);
});

$("#minutosAgregarTipoOrden").focusout(function(){
  if($("#minutosAgregarTipoOrden").val() < 0){
    $("#minutosAgregarTipoOrden").val(0);
  }
});

$("#guardarAgregarTipoOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalAgregarTipoOrden").modal("hide");

  var parametros = {
    'tipo': $("#nombreAgregarTipoOrden").val(),
    'idestructura': $("#proyectoAgregarTipoOrden").val(),
    'idclasificacion': $("#clasificacionAgregarTipoOrden").val(),
    'minutos': $("#minutosAgregarTipoOrden").val()
  }

  await $.ajax({
    url:   'controller/datosChequeaTipoOrden.php',
    type:  'post',
    data: parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length === 0){
        $.ajax({
            url: "controller/ingresarOrdenTipo.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
                var p = response.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                    if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                        var table = $('#tablaMantenedorTipos').DataTable();
                        table.ajax.reload();
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Tipo de orden ingresado correctamente");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                    }
                    else{
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                    }
                }else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
            }
        });
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El tipo que desea ingresar ya existe para el proyecto seleccionado");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#editarTipoOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#minutosEditarTipoOrden").val(0);
  $("#nombreEditarTipoOrden").val('');

  var table = $("#tablaMantenedorTipos").DataTable();
  var datos = table.rows('.selected').data();

  $("#nombreEditarTipoOrden").val(datos[0].TIPO);
  $("#minutosEditarTipoOrden").val(datos[0].MINUTOS);

  await $.ajax({
    url:   'controller/datosProyectoConfigOrden.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoProyecto = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          if(p.aaData[i].ID_ESTRUCTURA === datos[0].IDESTRUCTURA_OPERACION){
            cuerpoProyecto += '<option selected value="' + p.aaData[i].ID_ESTRUCTURA + '" name="' + p.aaData[i].AREA + '">' + p.aaData[i].PROYECTO + '</option>';
          }
          else{
            cuerpoProyecto += '<option value="' + p.aaData[i].ID_ESTRUCTURA + '" name="' + p.aaData[i].AREA + '">' + p.aaData[i].PROYECTO + '</option>';
          }
        }
        $("#proyectoEditarTipoOrden").html(cuerpoProyecto);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosOrdenClasificacion.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoClasi = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          if(p.aaData[i].IDORDEN_CLASIFICACION === datos[0].IDORDEN_CLASIFICACION){
            cuerpoClasi += '<option selected value="' + p.aaData[i].IDORDEN_CLASIFICACION + '">' + p.aaData[i].CLASIFICACION + '</option>';
          }
          else{
            cuerpoClasi += '<option value="' + p.aaData[i].IDORDEN_CLASIFICACION + '">' + p.aaData[i].CLASIFICACION + '</option>';
          }
        }
        $("#clasificacionEditarTipoOrden").html(cuerpoClasi);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoEditarTipoOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
        sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#clasificacionEditarTipoOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
        sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
  }

  setTimeout(function(){
    $("#modalEditarTipoOrden").modal("show");
    $("#modalAlertasSplash").modal("hide");
  },500);
});

$("#minutosEditarTipoOrden").focusout(function(){
  if($("#minutosEditarTipoOrden").val() < 0){
    $("#minutosEditarTipoOrden").val(0);
  }
});

$("#guardarEditarTipoOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEditarTipoOrden").modal("hide");

  var table = $("#tablaMantenedorTipos").DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    'tipo': $("#nombreEditarTipoOrden").val(),
    'idestructura': $("#proyectoEditarTipoOrden").val(),
    'idclasificacion': $("#clasificacionEditarTipoOrden").val(),
    'minutos': $("#minutosEditarTipoOrden").val(),
    'folio': datos[0].IDORDEN_TIPO
  }

  await $.ajax({
    url:   'controller/datosChequeaTipoOrdenEditar.php',
    type:  'post',
    data: parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length === 0){
        $.ajax({
            url: "controller/editarOrdenTipo.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
                var p = response.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                    if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                        var table = $('#tablaMantenedorTipos').DataTable();
                        table.ajax.reload();
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Tipo de orden editado correctamente");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                    }
                    else{
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                    }
                }else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
            }
        });
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El tipo que desea editar ya existe para el proyecto seleccionado");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#eliminarTipoOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  setTimeout(function(){
    $("#modalEliminarOrdenTipo").modal("show");
    $("#modalAlertasSplash").modal("hide");
  },500);
});

$("#guardarEliminarTipoOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEliminarOrdenTipo").modal("hide");

  var table = $("#tablaMantenedorTipos").DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    'folio': datos[0].IDORDEN_TIPO
  }

  $.ajax({
      url: "controller/eliminarTipoOrden.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaMantenedorTipos').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Tipo de orden eliminado correctamente");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
              else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Error al ejecutar la operación, no se puede eliminar un tipo asignado a alguna orden de trabajo");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
          }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Error al ejecutar la operación, no se puede eliminar un tipo asignado a alguna orden de trabajo");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
      }
  });
});

$("#fechaOrdenesAsignadas").unbind("click").change(function(){
  clearInterval(lineaTiempo);
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  dibujaTimeline($("#fechaOrdenesAsignadas").val());

  lineaTiempo = setInterval(function () {
    dibujaTimeline($("#fechaOrdenesAsignadas").val());
  }, 60000);

  setTimeout(async function(){
    $('#modalAlertasSplash').modal('hide');
    menuElegant();
  },2000);
});

$("#agregarTarjetaCombustible").unbind('click').click(function(){
  $("#numeroAgregarTarjeta").val("");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoAgregarTarjeta").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#productoAgregarTarjeta").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(async function(){
    $("#modalAgregarTarjeta").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#guardarAgregarTarjeta").unbind('click').click(function(){
  if($("#numeroAgregarTarjeta").val().length == 0){
    alertasToast("Debe completar todos los campos");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    $("#numeroAgregarTarjeta").addClass("is-invalid");
  }
  else {
    $("#modalAgregarTarjeta").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    parametros = {
      "numero":   $("#numeroAgregarTarjeta").val(),
      "estado":   $("#estadoAgregarTarjeta").val(),
      "tipo":   $("#tipoAgregarTarjeta").val(),
      "producto":   $("#productoAgregarTarjeta").val()
    }
    $.ajax({
        url:   'controller/datosChequeaTarjetaCombustible.php',
        type:  'post',
        data:  parametros,
        success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Ya existe una tarjeta ingresada con ese número");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $("#modalAgregarTarjeta").modal("show");
              },500);
            }
          }
          else{
            $.ajax({
              url: "controller/ingresaTarjetaCombustible.php",
              type: 'POST',
              data: parametros,
              success:  function (response) {
                var p = response.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                  if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaTarjetaCombustible').DataTable();
                    //table.rows('.selected').remove().draw();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Tarjeta agregada correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                  else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al agregar tarjeta, si el problema persiste favor comuniquese con soporte");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
                }
                else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al agregar tarjeta, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
              }
            });
          }
        }
      });
    }
});

$("#numeroAgregarTarjeta").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#editarTarjetaCombustible").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaTarjetaCombustible").DataTable();
  var datos = table.rows('.selected').data();

  $("#numeroEditarTarjeta").val(datos[0].NUMERO);
  $("#tipoEditarTarjeta").val(datos[0].TIPO);
  $("#productoEditarTarjeta").val(datos[0].PRODUCTO);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#estadoEditarTarjeta").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#tipoEditarTarjeta").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#productoEditarTarjeta").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  $.ajax({
    url:   'controller/datosEstadoTarCombustible.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoN = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(datos[0].ESTADO === p2.aaData[i].NOMBRE){
            cuerpoN = cuerpoN + "<option selected value=" + p2.aaData[i].IDTARJETACOMBUSTIBLE_ESTADO + ">"  + p2.aaData[i].NOMBRE + "</option>";
          }
          else{
            cuerpoN = cuerpoN + "<option value=" + p2.aaData[i].IDTARJETACOMBUSTIBLE_ESTADO + ">"  + p2.aaData[i].NOMBRE + "</option>";
          }
        }
        $("#estadoEditarTarjeta").html(cuerpoN)
      }
    }
  });
  setTimeout(async function(){
    if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      var h = $(window).height() - 200;
      $("#bodyEditarTarjeta").css("height",h);
    }
    $("#modalEditarTarjeta").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#guardarEditarTarjeta").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEditarTarjeta").modal("hide");

  var parametros = {
    "numero":   $("#numeroEditarTarjeta").val(),
    "estado":   $("#estadoEditarTarjeta").val(),
    "tipo":   $("#tipoEditarTarjeta").val(),
    "producto":   $("#productoEditarTarjeta").val()
  }

  $.ajax({
    url: "controller/editarTarjetaCombustible.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaTarjetaCombustible').DataTable();
          table.ajax.reload();

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Tarjeta editada correctamente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar tarjeta, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar tarjeta, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#desasignarTarjetaCombustible").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaTarjetaCombustible").DataTable();
  var datos = table.rows('.selected').data();

  $("#TarjetaNumeroDesasignar").html(datos[0].NUMERO);
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalDesasignarTarjetaCombustible").modal("show");
  },500);
});

$("#guardarDesasignarTarjetaCombustible").unbind('click').click(function(){
  $("#modalDesasignarTarjetaCombustible").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaTarjetaCombustible").DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    "numero":   datos[0].NUMERO,
    "patente":   datos[0].PATENTE
  }

  $.ajax({
    url: "controller/desasignarTarjetaCombustible.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaTarjetaCombustible').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Tarjeta desasignada correctamente");
          $("#desasignarTarjetaCombustible").attr("disabled","disabled");
          $("#solicitarTarjetaCombustible").attr("disabled","disabled");
          $("#devolucionTarjetaCombustible").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al desasignar tarjeta, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al desasignar tarjeta, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#agregarCategoriaOrden").unbind('click').click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#nombreAgregarCategoriaOrden").val('');
  await $.ajax({
    url:   'controller/datosProyectoConfigOrdenCategoria.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoProyecto = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoProyecto += '<option value="' + p.aaData[i].ID_ESTRUCTURA + '" name="' + p.aaData[i].AREA + '">' + p.aaData[i].PROYECTO + '</option>';
        }
        $("#proyectoAgregarCategoriaOrden").html(cuerpoProyecto);
      }
    }
  });

  var parametros = {
    "idestructura": $("#proyectoAgregarCategoriaOrden").val()
  }

  await $.ajax({
    url:   'controller/datosTipoOrdenPorEstructura.php',
    type:  'post',
    data: parametros,
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoTipo = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoTipo += '<option value="' + p.aaData[i].IDORDEN_TIPO + '">' + p.aaData[i].TIPO + '</option>';
        }
        $("#tipoAgregarCategoriaOrden").html(cuerpoTipo);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoAgregarCategoriaOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
        sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#tipoAgregarCategoriaOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalAgregarCategoriaOrden").modal("show");
    $("#modalAlertasSplash").modal("hide");
  },500);
});

$("#proyectoAgregarCategoriaOrden").unbind("click").change(async function(){
  $("#modalAgregarCategoriaOrden").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var parametros = {
    "idestructura": $("#proyectoAgregarCategoriaOrden").val()
  }

  await $.ajax({
    url:   'controller/datosTipoOrdenPorEstructura.php',
    type:  'post',
    data: parametros,
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoTipo = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoTipo += '<option value="' + p.aaData[i].IDORDEN_TIPO + '">' + p.aaData[i].TIPO + '</option>';
        }
        $("#tipoAgregarCategoriaOrden").html(cuerpoTipo);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoAgregarCategoriaOrden").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalAgregarCategoriaOrden").modal("show");
  },500);
});

$("#guardarAgregarCategoriaOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalAgregarCategoriaOrden").modal("hide");

  var parametros = {
    'tipo': $("#tipoAgregarCategoriaOrden").val(),
    'idestructura': $("#proyectoAgregarCategoriaOrden").val(),
    'categoria': $("#nombreAgregarCategoriaOrden").val()
  }

  await $.ajax({
    url:   'controller/datosChequeaTipoCategoria.php',
    type:  'post',
    data: parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length === 0){
        $.ajax({
            url: "controller/ingresarOrdenCategoria.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
                var p = response.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                    if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                        var table = $('#tablaMantenedorCategorias').DataTable();
                        table.ajax.reload();
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Categoria de orden ingresado correctamente");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                    }
                    else{
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                    }
                }else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
            }
        });
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La categoria que desea ingresar ya existe para el proyecto seleccionado");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#eliminarCategoriaOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  setTimeout(function(){
    $("#modalEliminarOrdenCategoria").modal("show");
    $("#modalAlertasSplash").modal("hide");
  },500);
});

$("#guardarEliminarCategoriaOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEliminarOrdenCategoria").modal("hide");

  var table = $("#tablaMantenedorCategorias").DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    'folio': datos[0].IDORDEN_CATEGORIA
  }

  $.ajax({
      url: "controller/eliminarCategoriaOrden.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaMantenedorCategorias').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Categoría de orden eliminada correctamente");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
              else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Error al ejecutar la operación, no se puede eliminar una categoria asignada a alguna orden de trabajo");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
          }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Error al ejecutar la operación, no se puede eliminar una categoria asignada a alguna orden de trabajo");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
      }
  });
});

$("#editarCategoriaOrden").unbind('click').click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#nombreEditarCategoriaOrden").val('');

  var table = $("#tablaMantenedorCategorias").DataTable();
  var datos = table.rows('.selected').data();

  $("#nombreEditarCategoriaOrden").val(datos[0].CATEGORIA);

  await $.ajax({
    url:   'controller/datosProyectoConfigOrdenCategoria.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoProyecto = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          if(datos[0].IDESTRUCTURA_OPERACION === p.aaData[i].ID_ESTRUCTURA){
            cuerpoProyecto += '<option selected value="' + p.aaData[i].ID_ESTRUCTURA + '" name="' + p.aaData[i].AREA + '">' + p.aaData[i].PROYECTO + '</option>';
          }
          else{
            cuerpoProyecto += '<option value="' + p.aaData[i].ID_ESTRUCTURA + '" name="' + p.aaData[i].AREA + '">' + p.aaData[i].PROYECTO + '</option>';
          }
        }
        $("#proyectoEditarCategoriaOrden").html(cuerpoProyecto);
      }
    }
  });

  var parametros = {
    "idestructura": $("#proyectoEditarCategoriaOrden").val()
  }

  await $.ajax({
    url:   'controller/datosTipoOrdenPorEstructura.php',
    type:  'post',
    data: parametros,
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoTipo = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          if(datos[0].IDORDEN_TIPO === p.aaData[i].IDORDEN_TIPO){
            cuerpoTipo += '<option selected value="' + p.aaData[i].IDORDEN_TIPO + '">' + p.aaData[i].TIPO + '</option>';
          }
          else{
            cuerpoTipo += '<option value="' + p.aaData[i].IDORDEN_TIPO + '">' + p.aaData[i].TIPO + '</option>';
          }
        }
        $("#tipoEditarCategoriaOrden").html(cuerpoTipo);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoEditarCategoriaOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
        sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#tipoEditarCategoriaOrden").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalEditarCategoriaOrden").modal("show");
    $("#modalAlertasSplash").modal("hide");
  },500);
});

$("#guardarEditarCategoriaOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEditarCategoriaOrden").modal("hide");

  var table = $("#tablaMantenedorCategorias").DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    'tipo': $("#tipoEditarCategoriaOrden").val(),
    'folio': datos[0].IDORDEN_CATEGORIA,
    'idestructura': $("#proyectoEditarCategoriaOrden").val(),
    'categoria': $("#nombreEditarCategoriaOrden").val()
  }

  await $.ajax({
    url:   'controller/datosChequeaTipoCategoria.php',
    type:  'post',
    data: parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length === 0){
        $.ajax({
            url: "controller/editarOrdenCategoria.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
                var p = response.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                    if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                        var table = $('#tablaMantenedorCategorias').DataTable();
                        table.ajax.reload();
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Categoria de orden actualizada correctamente");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                    }
                    else{
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                    }
                }else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
            }
        });
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La categoria que desea ingresar ya existe para el proyecto seleccionado");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#itemFiltroConfiguracion").unbind("click").change(function(){
  var table = $("#tablaIncidenciaSinConfiguracion").DataTable();
  var item = $("#itemFiltroConfiguracion").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('2').search(item).draw();
});

$("#departamentoFiltroConfiguracion").unbind("click").change(function(){
  var table = $("#tablaIncidenciaSinConfiguracion").DataTable();
  var item = $("#departamentoFiltroConfiguracion").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('3').search(item).draw();
});

$("#servicioFiltroConfiguracion").unbind("click").change(function(){
  var table = $("#tablaIncidenciaSinConfiguracion").DataTable();
  var item = $("#servicioFiltroConfiguracion").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('4').search(item).draw();
});

$("#clienteFiltroConfiguracion").unbind("click").change(function(){
  var table = $("#tablaIncidenciaSinConfiguracion").DataTable();
  var item = $("#clienteFiltroConfiguracion").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('5').search(item).draw();
});

$("#actividadFiltroConfiguracion").unbind("click").change(function(){
  var table = $("#tablaIncidenciaSinConfiguracion").DataTable();
  var item = $("#actividadFiltroConfiguracion").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('6').search(item).draw();
});

$("#sucursalFiltroConfiguracion").unbind("click").change(function(){
  var table = $("#tablaIncidenciaSinConfiguracion").DataTable();
  var item = $("#sucursalFiltroConfiguracion").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('7').search(item).draw();
});

$("#comunaFiltroConfiguracion").unbind("click").change(function(){
  var table = $("#tablaIncidenciaSinConfiguracion").DataTable();
  var item = $("#comunaFiltroConfiguracion").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('8').search(item).draw();
});

$("#fotoIncidencia").on('change', function(e){
  var file = e.target.files[0].name;
  $("#fileIncidencia").val(file);
});

$("#verMapaOrdenesTecnicoAsignadas").unbind("click").click(async function(){
  $("#googleMapaAsignadasTecnico").remove();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var parametros = {
    "fecha": $("#fechaOrdenesAsignadas").val(),
    "path": window.location.href.split('#/')[1],
    "idestructura": $("#proyectoOrdenAsignada").val(),
    "idareafuncional": $("#comunaOrdenAsignada").val(),
    "idcategoria":  $("#categoriaOrdenAsignada").val(),
    "idtipo": $("#tipoOrdenAsignada").val(),
    "idtecnico": $("#técnicoOrdenAsignada").val()
  }

  let tecnicoOrAsMapa = [];

  await $.ajax({
    url:   'controller/datosOrdenesTimeline.php',
    type:  'post',
    data: parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          tecnicoOrAsMapa.push(p2.aaData[i].IDTECNICO + ',' + p2.aaData[i].NOMBRE);
        }

        let tecnicoOrAsUniqueMapa = tecnicoOrAsMapa.filter((item,index)=>{
          return tecnicoOrAsMapa.indexOf(item) === index;
        });

        var tecnicoOrMapa = '<option selected value="0">Seleccione un técnico</option>';
        tecnicoOrAsUniqueMapa.forEach((item, i) => {
          tecnicoOrMapa += '<option value="' + item.split(',')[0] + '">' + item.split(',')[1] + '</option>';
        });

        $("#idTecnicoMapaAsignadasTecnico").html(tecnicoOrMapa);

        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#idTecnicoMapaAsignadasTecnico").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
      }
    }
  });
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalMapaAsignadasTecnico").modal("show");
  },1000);
});

$("#idTecnicoMapaAsignadasTecnico").unbind("click").change(async function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalMapaAsignadasTecnico").modal("hide");
  if($("#idTecnicoMapaAsignadasTecnico").val() !== '0'){
    var parametros = {
      "fecha": $("#fechaOrdenesAsignadas").val(),
      "idtecnico": $("#idTecnicoMapaAsignadasTecnico").val()
    }
    await $.ajax({
      url:   'controller/datosOrdenesAsignadasTac.php',
      type:  'post',
      data: parametros,
      success: function (response2) {
        var p = jQuery.parseJSON(response2);
        if(p.aaData.length !== 0){
          var h = $(window).height() - 300;
          $("#googleMapaAsignadasTecnico").remove();
          $("#padreGoogleMapaAsignadasTecnico").append('<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" id="googleMapaAsignadasTecnico" style="border: 1px solid gray; height: ' + h + 'px; min-height: ' + h + 'px;"></div>');
          generaMapaAsignadasTac(p);
        }
      }
    });
  }
  else{
    // console.log("Valor en 0");
  }
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#idTecnicoMapaAsignadasTecnico").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

async function generaMapaAsignadasTac(p){
  const directionsService = new google.maps.DirectionsService();
  const directionsRenderer = new google.maps.DirectionsRenderer();
  const map = new google.maps.Map(document.getElementById("googleMapaAsignadasTecnico"), {
    minZoom: 1,
    maxZoom: 18
  });

  directionsRenderer.setMap(map);

  calculateAndDisplayRoute(directionsService, directionsRenderer, p);
}

function calculateAndDisplayRoute(directionsService, directionsRenderer, p){
  var arrayWay = [];
  var start = p.aaData[0].DIRECCION + ', ' + p.aaData[0].COMUNA + ', Chile';
  var end = p.aaData[p.aaData.length-1].DIRECCION + ', ' + p.aaData[p.aaData.length-1].COMUNA + ', Chile';
  for(var i = 1; i < p.aaData.length-1; i++){
    arrayWay.push({location: p.aaData[i].DIRECCION + ', ' + p.aaData[i].COMUNA + ', Chile', stopover: true});
  }

  directionsService
    .route({
      origin: {
        query: start,
      },
      waypoints: arrayWay,
      destination: {
        query: end
      },
      travelMode: google.maps.TravelMode.DRIVING,
      unitSystem: google.maps.UnitSystem.METRIC,
      // optimizeWaypoints: true
    })
    .then((response) => {
      directionsRenderer.setDirections(response);
    })
    .catch((e) => console.log('error al recuperar las direcciones'));

    setTimeout(function(){
      setTimeout(function(){
        $("#modalMapaAsignadasTecnico").modal("show");
        setTimeout(function(){
          var map = directionsRenderer.getMap();
          map.setZoom(11);
          $('#modalAlertasSplash').modal('hide');
        },500);
      },500);
    },1000);
}

// FUNCION PARA MODAL INGRESAR RANGO MANTENCIONES
$("#ingresarRango").unbind("click").click(async function(){
  $("#minutosConfigRangoMantenciones").val("");
  $("#horaInicioConfigRangoMantenciones").val("");
  $("#horaFinConfigRangoMantenciones").val("");
  $("#minutosConfigRangoMantenciones").removeClass("is-invalid");
  $("#horaInicioConfigRangoMantenciones").removeClass("is-invalid");
  $("#horaFinConfigRangoMantenciones").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#minutosConfigRangoMantenciones" ).focusout(function(){
    minutos = $("#minutosConfigRangoMantenciones").val();
    if(minutos < 0){
      $("#minutosConfigRangoMantenciones").val(0);
      $("#minutosConfigRangoMantenciones").addClass("is-invalid");


      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor negativo");
    }
    else{
      $("#minutosConfigRangoMantenciones").val(minutos);
    }
  });

  setTimeout(function(){
    $("#modalConfigRangoMantenciones").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyConfigRangoMantenciones').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarConfigRangoMantenciones").unbind('click').click(function(){
  if($("#minutosConfigRangoMantenciones").val().length == 0 || $("#horaInicioConfigRangoMantenciones").val().length == 0 || $("#horaFinConfigRangoMantenciones").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#minutosConfigRangoMantenciones").val().length == 0){
      $("#minutosConfigRangoMantenciones").addClass("is-invalid");
    }
    if ($("#horaInicioConfigRangoMantenciones").val().length == 0){
      $("#horaInicioConfigRangoMantenciones").addClass("is-invalid");
    }
    if ($("#horaFinConfigRangoMantenciones").val().length == 0){
      $("#horaFinConfigRangoMantenciones").addClass("is-invalid");
    }
  }
  else {
    parametros = {
      "minutos": $("#minutosConfigRangoMantenciones").val(),
      "horaInicio": $("#horaInicioConfigRangoMantenciones").val(),
      "horaFin": $("#horaFinConfigRangoMantenciones").val(),
    }
    $("#modalConfigRangoMantenciones").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaRangoMantenciones.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaRangoMantencion').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Rango de mantención ingresado correctamente");
            $("#configurarRango").attr("disabled","disabled");
            $('#ingresarRango').remove();
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar rango de mantención, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar rango de mantención, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#minutosConfigRangoMantenciones").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#horaInicioConfigRangoMantenciones").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#horaFinConfigRangoMantenciones").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN PARA MODAL INGRESAR RANGO MANTENCIONES

// MODAL HABILITAR/DESHABILITAR RANGO MANTENCIONES
$("#configurarRango").unbind("click").click(async function(){
  $("#topeMantenciones").removeClass("is-invalid");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  if($('select[id="selectHabDeshRangoMantenciones"] option:selected').text() === "Desactivar"){
    $("#topeMantenciones").val("");
    $("#topeMantenciones").attr("disabled","disabled");
    $("#topeMantenciones").removeClass("is-invalid");
  }
  else{
    $("#topeMantenciones").val("");
    $("#topeMantenciones").removeAttr("disabled");
  }

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectHabDeshRangoMantenciones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalHabDeshRangoMantenciones").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyHabDeshRangoMantenciones').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#selectHabDeshRangoMantenciones").unbind("click").change(async function(){
  if($('select[id="selectHabDeshRangoMantenciones"] option:selected').text() === "Desactivar"){
    $("#topeMantenciones").val("");
    $("#topeMantenciones").attr("disabled","disabled");
    $("#topeMantenciones").removeClass("is-invalid");
  }
  else{
    $("#topeMantenciones").val("");
    $("#topeMantenciones").removeAttr("disabled");
  }
});

$("#guardarHabDeshRangoMantenciones").unbind('click').click(function(){
  var table = $('#tablaRangoMantencion').DataTable();
  var idRangoMant = $.map(table.rows('.selected').data(), function (item) {
    return item.IDMANTENCION_RANGOS;
  });

  if($('select[id="selectHabDeshRangoMantenciones"] option:selected').text() === "Activar"){
    tope2 = $("#topeMantenciones").val();
    if($("#topeMantenciones").val().length == 0 || tope2 < 0){
      if ($("#topeMantenciones").val().length == 0){
        $("#topeMantenciones").addClass("is-invalid");
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar el campo tope de mantenciones");
      }
      if (tope2 < 0){
        $("#topeMantenciones").addClass("is-invalid");
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor negativo");
        $("#topeMantenciones").val(0);
      }
    }
    else {
      parametros = {
        "tope": tope2,
        "idRangoMant": idRangoMant,
      }
      $("#modalHabDeshRangoMantenciones").modal("hide");
      $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
      $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
      $('#modalAlertasSplash').modal('show');
      $.ajax({
        url: "controller/activarRangoMantenciones.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var table = $('#tablaRangoMantencion').DataTable();
              table.ajax.reload();
              setTimeout(function(){
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Rango de mantención activado correctamente");
                $("#configurarRango").attr("disabled","disabled");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              },2000);
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al activar rango de mantención, si el problema persiste favor comuniquese con soporte");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al activar rango de mantención, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
      });
    }
  }
  else{
    parametros = {
      "idRangoMant": idRangoMant,
    }
    $("#modalHabDeshRangoMantenciones").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/desactivarRangoMantenciones.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaRangoMantencion').DataTable();
            table.ajax.reload();
            setTimeout(function(){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Rango de mantención desactivado correctamente");
              $("#configurarRango").attr("disabled","disabled");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            },2000);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al desactivar rango de mantención, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al desactivar rango de mantención, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#topeMantenciones").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN PARA MODAL HABILITAR/DESHABILITAR RANGO MANTENCIONES

// Funcion para ingreso de datos a mantención
$("#rutAgregarMantencion").focusout(function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  vari = $("#rutAgregarMantencion").val().split(" - ")[0];
  if(vari.length > 8){
    $('#agregarMantencion').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');

    var parametrosRut = {
      "rut": $.trim(vari.replace('.','').replace('.','')),
    }
    $.ajax({
      url:   'controller/datosRutForMantencionSelect.php',
      type:  'post',
      data: parametrosRut,
      success: function (response3) {
        if(response3.localeCompare("Sin datos") != 0 && response3 != ""){
          var p3 = jQuery.parseJSON(response3);
          if(p3.aaData[0].CODIGO !== null){
            $("#rutAgregarMantencion").val(vari);
            $("#guardarAgregarMantencion").removeAttr("disabled");
            $("#nombreAgregarMantencion").val(p3.aaData[0].NOMBRE);
            $("#correoAgregarMantencion").val(p3.aaData[0].EMAIL);
            $("#celularAgregarMantencion").val(p3.aaData[0].TELEFONO);
            $("#patenteAgregarMantencion").val(p3.aaData[0].CODIGO);
            $("#marcaAgregarMantencion").val(p3.aaData[0].MARCA);
            $("#modeloAgregarMantencion").val(p3.aaData[0].MODELO);
            $("#anoAgregarMantencion").val(p3.aaData[0].AÑO);
            $("#kilometrajeAgregarMantencion").val(p3.aaData[0].KILOMETRAJE);
            // Buscamos siniestros con la patente
            var parametros = {
              "patente": p3.aaData[0].CODIGO,
            }

            $.ajax({
              url:   'controller/datosPatenteSiniestrosForMantenciones.php',
              type:  'post',
              data: parametros,
              success: function (response) {
                if(response.localeCompare("Sin datos") != 0 && response != ""){
                  var p = jQuery.parseJSON(response);
                  if(p.aaData.length !== 0 ){
                    var cuerpoS = "";
                    for(var i = 0; i < p.aaData.length; i++){
                      cuerpoS += '<option value="' + p.aaData[i].FOLIO + '">' + p.aaData[i].FOLIO + '</option>';
                    }
                    $("#motivoAgregarMantencion").html('<option value="Mantencion_correctiva">Mantención correctiva</option>,<option value="Mantencion_preventiva">Mantención preventiva</option>,<option value="Siniestro">Siniestro</option>');
                    $("#siniestroAgregarMantencion").removeAttr("disabled");
                    $("#siniestroAgregarMantencion").html(cuerpoS);
                  }
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                    $('#agregarMantencion').modal('show');
                  },500);
                }
                else{
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                    $('#agregarMantencion').modal('show');
                  },500);
                }
              }
            });
          }
          else{
            $.ajax({
              url:   'controller/datosChequeaPersonal.php',
              type:  'post',
              data: parametrosRut,
              success: function (response2) {
                if(response2.localeCompare("Sin datos") != 0 && response2 != ""){
                  var p2 = jQuery.parseJSON(response2);
                  $("#guardarAgregarMantencion").attr("disabled","disabled");
                  $("#rutAgregarMantencion").val(vari);
                  $("#nombreAgregarMantencion").val(p2.aaData[0].PERSONAL);
                  $("#correoAgregarMantencion").val(p2.aaData[0].EMAIL);
                  $("#celularAgregarMantencion").val(p2.aaData[0].TELEFONO);

                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El DNI ingresado no tiene vehículo asignado");

                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                    $('#agregarMantencion').modal('show');
                  },500);

                }
                else{

                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El DNI ingresado es inválido o no pertenece a la empresa");
                  $("#rutAgregarMantencion").val("");
                  $("#rutAgregarMantencion").addClass("is-invalid");

                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                    $('#agregarMantencion').modal('show');
                  },500);

                }
              }
            });
          }
        }
        else{

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El DNI ingresado es inválido o no pertenece a la empresa");
          $("#rutAgregarMantencion").val("");
          $("#rutAgregarMantencion").addClass("is-invalid");

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#agregarMantencion').modal('show');
          },500);

        }
      }
    });
  }
});

$("#patenteAgregarMantencion").focusout(function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  patente = $("#patenteAgregarMantencion").val();
  if(patente.length > 5){
    $('#agregarMantencion').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var parametros = {
      "patente": patente
    }
    $.ajax({
      url:   'controller/datosPatenteSiniestrosForMantenciones.php',
      type:  'post',
      data: parametros,
      success: function (response3) {
        if(response3.localeCompare("Sin datos") != 0 && response3 != ""){
          var p3 = jQuery.parseJSON(response3);
          $("#patenteAgregarMantencion").val(patente);
          $("#guardarAgregarMantencion").removeAttr("disabled");
          $("#marcaAgregarMantencion").val(p3.aaData[0].MARCA);
          $("#modeloAgregarMantencion").val(p3.aaData[0].MODELO);
          $("#anoAgregarMantencion").val(p3.aaData[0].AÑO);
          $("#kilometrajeAgregarMantencion").val(p3.aaData[0].KILOMETRAJE);
          if(p3.aaData.length !== 0 ){
            var cuerpoS1 = "";
            for(var i = 0; i < p3.aaData.length; i++){
              cuerpoS1 += '<option value="' + p3.aaData[i].FOLIO + '">' + p3.aaData[i].FOLIO + '</option>';
            }
            $("#motivoAgregarMantencion").html('<option value="Mantencion_correctiva">Mantención correctiva</option>,<option value="Mantencion_preventiva">Mantención preventiva</option>,<option value="Siniestro">Siniestro</option>');
            $("#siniestroAgregarMantencion").removeAttr("disabled");
            $("#siniestroAgregarMantencion").html(cuerpoS1);
          }
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#agregarMantencion').modal('show');
          },500);
        }
        else{
          $.ajax({
            url:   'controller/datosChequeaPatente.php',
            type:  'post',
            data: parametros,
            success: function (response2) {
              if(response2.localeCompare("Sin datos") != 0 && response2 != ""){
                var p2 = jQuery.parseJSON(response2);
                $("#patenteAgregarMantencion").val(patente);
                $("#guardarAgregarMantencion").removeAttr("disabled");
                $("#marcaAgregarMantencion").val(p2.aaData[0].MARCA);
                $("#modeloAgregarMantencion").val(p2.aaData[0].MODELO);
                $("#anoAgregarMantencion").val(p2.aaData[0].AÑO);
                $("#kilometrajeAgregarMantencion").val(p2.aaData[0].KILOMETRAJE);


                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La patente ingresada no tiene siniestro");

                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  $('#agregarMantencion').modal('show');
                },2000);
              }
              else{

                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La patente ingresada es inválida o no pertenece a la empresa");
                $("#patenteAgregarMantencion").val("");
                $("#patenteAgregarMantencion").addClass("is-invalid");

                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  $('#agregarMantencion').modal('show');
                },2000);
              }
            }
          });
        }
      }
    });
  }
});

$("#kilometrajeAgregarMantencion").focusout(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  patente = $("#patenteAgregarMantencion").val();
  var parametrosPatente = {
    "patente" : patente
  }
  await $.ajax({
    url:   'controller/datosChequeaPatente.php',
    type:  'post',
    data: parametrosPatente,
    success: function (response31) {
      var p3 = jQuery.parseJSON(response31);
      var kil = p3.aaData[0].KILOMETRAJE;
      if(parseInt($("#kilometrajeAgregarMantencion").val()) < parseInt(kil) || $("#kilometrajeAgregarMantencion").val().length == 0){
        $("#kilometrajeAgregarMantencion").val(kil);
        $("#kilometrajeAgregarMantencion").addClass("is-invalid");
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un kilometraje menor al del sistema");
      }
    }
  });
});

$("#kilometrajeAgregarMantencion").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#rutAgregarMantencion").on('input', function(){
  $(this).removeClass("is-invalid");
  $("#guardarAgregarMantencion").attr("disabled","disabled");
  $("#patenteAgregarMantencion").removeAttr("disabled","disabled");
  $("#motivoAgregarMantencion").html('<option value="Mantencion_correctiva">Mantención correctiva</option>,<option value="Mantencion_preventiva">Mantención preventiva</option>,<option value="Siniestro">Siniestro</option>');
  $("#nombreAgregarMantencion").val("");
  $("#correoAgregarMantencion").val("");
  $("#celularAgregarMantencion").val("");
  $("#patenteAgregarMantencion").val("");
  $("#marcaAgregarMantencion").val("");
  $("#modeloAgregarMantencion").val("");
  $("#anoAgregarMantencion").val("");
  $("#kilometrajeAgregarMantencion").val("");
  $("#siniestroAgregarMantencion").html('<option value="Ninguno">Ninguno</option>');
  $("#siniestroAgregarMantencion").attr("disabled","disabled");
});

$("#patenteAgregarMantencion").on('input', function(){
  $(this).removeClass("is-invalid");
  $("#guardarAgregarMantencion").attr("disabled","disabled");
  $("#motivoAgregarMantencion").html('<option value="Mantencion_correctiva">Mantención correctiva</option>,<option value="Mantencion_preventiva">Mantención preventiva</option>,<option value="Siniestro">Siniestro</option>');
  $("#marcaAgregarMantencion").val("");
  $("#modeloAgregarMantencion").val("");
  $("#anoAgregarMantencion").val("");
  $("#kilometrajeAgregarMantencion").val("");
  $("#siniestroAgregarMantencion").html('<option value="Ninguno">Ninguno</option>');
  $("#siniestroAgregarMantencion").attr("disabled","disabled");
});

$("#tallerAgregarMantencion").unbind("click").change(async function(){
  $("#direccionTallerAgregarMantencion").val("Cargando dirección...");
  var param = {
    "idTaller": $("#tallerAgregarMantencion").val(),
  }
  await $.ajax({
    url:   'controller/datosDireccionTallerMantencion.php',
    type:  'post',
    data: param,
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        $("#direccionTallerAgregarMantencion").val(p.aaData[0].DIRECCION + ' (' + p.aaData[0].COMUNA + ')');
      }
      else{
        $("#direccionTallerAgregarMantencion").val("");
      }
    }
  });
});

$("#guardarAgregarMantencion").unbind('click').click(function(){
  if($("#tallerAgregarMantencion").val() != 0 && $("#celularAgregarMantencion").val().length >= 9){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#agregarMantencion").modal("hide");
    $.ajax({
      url:   'controller/datosChequeaPatenteForMantencion.php',
      type:  'post',
      data: {
        "patente": $("#patenteAgregarMantencion").val(),
      },
      success: function (response3) {
        var p3 = jQuery.parseJSON(response3);
        if(response3.localeCompare("Sin datos") != 0){
          if (parseInt(p3.aaData[0].CANTIDAD) !== 0){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar una agenda de mantención a este vehículo ya que tiene otra agenda en proceso en días superiores o igual a hoy");
              $('#modalAlertasSplash').modal('hide');
              $("#agregarMantencion").modal("show");
          }
          else{
            var taller = $("#tallerAgregarMantencion").find('option:selected').text();
            var direccionTaller = $("#direccionTallerAgregarMantencion").val();
            parametros = {
              "rutMantencion": $("#rutAgregarMantencion").val(),
              "correoPersonal": $("#correoAgregarMantencion").val(),
              "celularPersonal": $("#celularAgregarMantencion").val(),
              "patenteMantencion": $("#patenteAgregarMantencion").val(),
              "kilometraje": $("#kilometrajeAgregarMantencion").val(),
              "fechaMantencion": $("#fechaAgregarMantencion").val(),
              "horaMantencion": $("#horaAgregarMantencion").val(),
              "motivoMantencion": $("#motivoAgregarMantencion").val(),
              "siniestro": $("#siniestroAgregarMantencion").val(),
              "sucursal": $("#sucursalAgregarMantencion").val(),
              "colorLetra": $("#colorLetraAgregarMantencion").val(),
              "colorFondo": $("#colorFondoAgregarMantencion").val(),
              "observacion": $("#observacionAgregarMantencion").val(),
              "idTaller": $("#tallerAgregarMantencion").val(),
            }
            $.ajax({
              url: "controller/ingresaMantencionesFlota.php",
              type: 'POST',
              data: parametros,
              success:  async function (response) {
                var p = jQuery.parseJSON(response);
                await $.ajax({
                  url: "controller/generaPDF/agendaMantencion.php?idLoad=205",
                  type: "POST",
                  data:{
                    "idMantencion": Number(p[0]['LAST_INSERT_ID()']),
                    "url": window.location.toString().split("?")[0]
                  },
                  success: async function (res2){
                    window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/flota/mantenciones/agenda' + res2, '_blank');
                    await $.ajax({
                      url: "controller/envio_sms.php",
                      type:"POST",
                      data:{
                        'celular': $("#celularAgregarMantencion").val(),
                        'mensaje': "Le informamos que se ha agendado una nueva mantención para el vehículo con patente " + $("#patenteAgregarMantencion").val() + ", fecha: " + $("#fechaAgregarMantencion").val() + ", hora: " + $("#horaAgregarMantencion").find('option:selected').text().split(' (Dis')[0] + " en el taller: " + taller + " con dirección en " + direccionTaller,
                      },
                      success: function (resp2){
                      }
                    });
                    await $.ajax({
                      url: "controller/enviaEmailNotificacionesMantencion.php",
                      type:"POST",
                      data:{
                        "pdf":res2,
                        "nombrePersonal": $("#nombreAgregarMantencion").val(),
                        "correoPersonal": $("#correoAgregarMantencion").val(),
                        "rutPersonal": $("#rutAgregarMantencion").val(),
                        "patenteMantencion": $("#patenteAgregarMantencion").val(),
                        "taller": $("#tallerAgregarMantencion").find('option:selected').text(),
                        "direccionTaller": $("#direccionTallerAgregarMantencion").val(),
                      },
                      success: function (res1){
                        var p1 = res1.split(",");
                        if(res1.localeCompare("Sin datos")!= 0 && res1 != ""){
                          if(p1[0].localeCompare("Sin datos") != 0 && p1[0] != ""){
                            var random = Math.round(Math.random() * (1000000 - 1) + 1);
                            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Mantención ingresado correctamente");

                            var calendarEl = document.getElementById('calendario');

                            var calendar = new FullCalendar.Calendar(calendarEl, {
                              themeSystem: 'standard',
                              height: $(window).height() - 120,
                              timezoneParam: 'America/Santiago',
                              locale: 'es',
                              firstDay: 1,
                              buttonIcons: true,
                              navLinks: true, // can click day/week names to navigate views
                              businessHours: true, // display business hours
                              editable: true,
                              selectable: false,
                              weekNumbers: false,
                              eventDisplay: 'block',
                              titleFormat: { year: 'numeric', month: 'numeric' },
                              headerToolbar: {
                                left: 'prev,next today',
                                center: 'title',
                                right: 'dayGridMonth'
                              },
                              events: "controller/datosCalendar.php",
                              dateClick: async function(info){
                                  var dia = info.dateStr;
                                  var actual = moment().format('YYYY-MM-DD').toString();
                                  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                                  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                                  $('#modalAlertasSplash').modal('show');
                                  if(moment(dia).isSameOrAfter(actual, 'day')){
                                    $("#horaAgregarMantencion").html("");
                                    $("#guardarAgregarMantencion").attr("disabled","disabled");
                                    $("#rutAgregarMantencion").val("");
                                    $("#nombreAgregarMantencion").val("");
                                    $("#direccionTallerAgregarMantencion").val("")
                                    $("#correoAgregarMantencion").val("");
                                    $("#celularAgregarMantencion").val("");
                                    $("#patenteAgregarMantencion").val("");
                                    $("#marcaAgregarMantencion").val("");
                                    $("#modeloAgregarMantencion").val("");
                                    $("#anoAgregarMantencion").val("");
                                    $("#kilometrajeAgregarMantencion").val("");
                                    $("#siniestroAgregarMantencion").val("");
                                    $("#observacionAgregarMantencion").val("");
                                    $("#motivoAgregarMantencion").html('<option value="Mantencion_correctiva">Mantención correctiva</option>,<option value="Mantencion_preventiva">Mantención preventiva</option>,<option value="Siniestro">Siniestro</option>');
                                    $("#nombreAgregarMantencion").attr("disabled","disabled");
                                    $("#patenteAgregarMantencion").removeAttr("disabled","disabled");
                                    $("#marcaAgregarMantencion").attr("disabled","disabled");
                                    $("#modeloAgregarMantencion").attr("disabled","disabled");
                                    $("#direccionTallerAgregarMantencion").attr("disabled","disabled");
                                    $("#anoAgregarMantencion").attr("disabled","disabled");
                                    $("#rutAgregarMantencion").removeAttr("disabled","disabled");
                                    $("#rutAgregarMantencion").removeClass("is-invalid");
                                    $("#patenteAgregarMantencion").removeClass("is-invalid");
                                    $("#celularAgregarMantencion").removeClass("is-invalid");
                                    $("#kilometrajeAgregarMantencion").removeClass("is-invalid");
                                    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                                      $("#motivoAgregarMantencion").select2({
                                        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                                      });
                                      $("#horaAgregarMantencion").select2({
                                        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                                      });
                                      $("#sucursalAgregarMantencion").select2({
                                        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                                      });
                                      $("#siniestroAgregarMantencion").select2({
                                        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                                      });
                                      $("#tallerAgregarMantencion").select2({
                                        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                                      });
                                    }

                                    if($('select[id="motivoAgregarMantencion"] option:selected').text() === "Mantención correctiva" || $('select[id="motivoAgregarMantencion"] option:selected').text() === "Mantención preventiva"){
                                      $("#siniestroAgregarMantencion").html('<option value="Ninguno">Ninguno</option>');
                                      $("#siniestroAgregarMantencion").attr("disabled","disabled");
                                    }
                                    else{
                                      $("#siniestroAgregarMantencion").removeAttr("disabled");
                                    }

                                    $("#motivoAgregarMantencion").unbind("click").change(async function(){
                                      if($('select[id="motivoAgregarMantencion"] option:selected').text() === "Mantención correctiva" || $('select[id="motivoAgregarMantencion"] option:selected').text() === "Mantención preventiva"){
                                        $("#siniestroAgregarMantencion").html('<option value="Ninguno">Ninguno</option>');
                                        $("#siniestroAgregarMantencion").attr("disabled","disabled");
                                      }
                                      else{
                                        $("#siniestroAgregarMantencion").removeAttr("disabled");
                                      }
                                    });

                                    await $.ajax({
                                      url:   'controller/datosSucursal.php',
                                      type:  'post',
                                      success: function (response2) {
                                        var p2 = jQuery.parseJSON(response2);
                                        if(p2.aaData.length !== 0){
                                          var cuerpoS = '';
                                          for(var i = 0; i < p2.aaData.length; i++){
                                            if(p2.aaData[i].BODEGA_FLOTA === "SI"){
                                              cuerpoS += '<option value="' + p2.aaData[i].IDSUCURSAL + '">' + p2.aaData[i].COMUNA + ' - ' + p2.aaData[i].SUCURSAL + '</option>';
                                            }
                                          }
                                          $("#sucursalAgregarMantencion").html(cuerpoS);
                                        }
                                      }
                                    });

                                    var parametros = {
                                      "fecha": info.dateStr
                                    }
                                    await $.ajax({
                                      url:   'controller/datosRangoHoraMantencion.php',
                                      type:  'post',
                                      data: parametros,
                                      success: function (response3) {
                                        var p2 = jQuery.parseJSON(response3);
                                        if(p2.aaData.length !== 0){
                                          var cuerpoR = '';
                                          for(var i = 0; i < p2.aaData.length; i++){
                                            cuerpoR += '<option value="' + p2.aaData[i].IDMANTENCION_RANGOS + '">' + p2.aaData[i].RANGO + '</option>';
                                          }
                                          $("#horaAgregarMantencion").html(cuerpoR);
                                        }
                                      }
                                    });

                                    var param = {
                                      "idSucursal": $("#sucursalAgregarMantencion").val(),
                                    }
                                    await $.ajax({
                                      url:   'controller/datosTallerMantencion.php',
                                      type:  'post',
                                      data: param,
                                      success: function (response) {
                                        var p = jQuery.parseJSON(response);
                                        if(p.aaData.length !== 0){
                                          var cuerpoM = '<option selected value=0>Seleccionar Taller</option>';
                                          for(var i = 0; i < p.aaData.length; i++){
                                            cuerpoM += '<option value="' + p.aaData[i].IDPATENTE_TALLER + '">' + p.aaData[i].NOMBRE + ' - ' + p.aaData[i].DIRECCION + '</option>';
                                          }
                                          $("#tallerAgregarMantencion").html(cuerpoM);
                                        }
                                        else{
                                          $("#tallerAgregarMantencion").html('<option selected value=0>Seleccionar Taller</option>');
                                        }
                                      }
                                    });

                                    await $.ajax({
                                      url:   'controller/datosRutForMantencion.php',
                                      type:  'post',
                                      success: function (response) {
                                        var p = jQuery.parseJSON(response);
                                        if(p.aaData.length !== 0){
                                          var listaPersonalSiniestro = [];
                                          for(var i = 0; i < p.aaData.length; i++) {
                                            if(p.aaData[i].CODIGO === null){
                                              listaPersonalSiniestro.push(p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRE);
                                            }else{
                                              listaPersonalSiniestro.push(p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRE + ' - ' + p.aaData[i].CODIGO);
                                            }
                                          }
                                          $('#rutAgregarMantencion').autocomplete({
                                            // req will contain an object with a "term" property that contains the value
                                            // currently in the text input.  responseFn should be invoked with the options
                                            // to display to the user.
                                            source: function (req, responseFn) {
                                              // Escape any RegExp meaningful characters such as ".", or "^" from the
                                              // keyed term.
                                              var term = $.ui.autocomplete.escapeRegex(req.term),
                                                // '^' is the RegExp character to match at the beginning of the string.
                                                // 'i' tells the RegExp to do a case insensitive match.
                                                matcher = new RegExp(term, 'i'),
                                                // Loop over the options and selects only the ones that match the RegExp.
                                                matches = $.grep(listaPersonalSiniestro, function (item) {
                                                  return matcher.test(item);
                                                });
                                              // Return the matched options.
                                              responseFn(matches);
                                            }
                                          });
                                        }
                                      }
                                    });

                                    await $.ajax({
                                      url:   'controller/datosPatenteForMantencion.php',
                                      type:  'post',
                                      success: function (response) {
                                        var p = jQuery.parseJSON(response);
                                        if(p.aaData.length !== 0){
                                          var listaPersonalSiniestro = [];
                                          for(var i = 0; i < p.aaData.length; i++) {
                                            listaPersonalSiniestro.push(p.aaData[i].CODIGO);
                                          }
                                          $('#patenteAgregarMantencion').autocomplete({
                                            // req will contain an object with a "term" property that contains the value
                                            // currently in the text input.  responseFn should be invoked with the options
                                            // to display to the user.
                                            source: function (req, responseFn) {
                                              // Escape any RegExp meaningful characters such as ".", or "^" from the
                                              // keyed term.
                                              var term = $.ui.autocomplete.escapeRegex(req.term),
                                                // '^' is the RegExp character to match at the beginning of the string.
                                                // 'i' tells the RegExp to do a case insensitive match.
                                                matcher = new RegExp(term, 'i'),
                                                // Loop over the options and selects only the ones that match the RegExp.
                                                matches = $.grep(listaPersonalSiniestro, function (item) {
                                                  return matcher.test(item);
                                                });
                                              // Return the matched options.
                                              responseFn(matches);
                                            }
                                          });
                                        }
                                      }
                                    });

                                    $("#fechaAgregarMantencion").val(info.dateStr);
                                    $("#fechaAgregarMantencion").attr("disabled","disabled");

                                    setTimeout(function(){
                                      hora = $("#horaAgregarMantencion").val();
                                      if(hora === null){
                                        $("#buttonAceptarAlerta").css("display","inline");
                                        $("#modalAlertas").modal({backdrop: 'static', keyboard: false});
                                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                                        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se puede ingresar una mantención por que no hay horario disponible");
                                        setTimeout(function(){
                                          $('#modalAlertasSplash').modal('hide');
                                        },500);
                                      }
                                      else{
                                        var h = $(window).height() - 200;
                                        $("#bodyAgregarMantencion").css("height",h);
                                        setTimeout(function(){
                                          $('#modalAlertasSplash').modal('hide');
                                          $("#agregarMantencion").modal("show");
                                        },1000);
                                      }
                                      setTimeout(function(){
                                        $('#bodyAgregarMantencion').animate({ scrollTop: 0 }, 'fast');
                                      },200);
                                    },500);
                                  }
                                  else{
                                    $("#buttonAceptarAlerta").css("display","inline");
                                    $("#modalAlertas").modal({backdrop: 'static', keyboard: false});
                                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                                    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar una agenda de mantención en días anteriores a hoy");
                                    setTimeout(function(){
                                      $('#modalAlertasSplash').modal('hide');
                                    },500);
                                  }

                              },
                              eventClick: async function(calEvent){
                                id = calEvent.event.extendedProps.descripcion.split("@@@@@")[0];
                                $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                                $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                                $('#modalAlertasSplash').modal('show');
                                parametros = {
                                  "idMantencion": id
                                }
                                await $.ajax({
                                  url:   'controller/datosCalendarSelect.php',
                                  type:  'post',
                                  data: parametros,
                                  success: function (response3) {
                                    var p3 = jQuery.parseJSON(response3);
                                    if(response3.localeCompare("Sin datos") != 0){
                                      $("#patenteMantencion").html(p3.aaData[0].CODIGO);
                                      $("#marcaMantencion").html(p3.aaData[0].MARCA);
                                      $("#modeloMantencion").html(p3.aaData[0].MODELO);
                                      $("#personalMantencion").html(p3.aaData[0].PERSONAL);
                                      $("#correoMantencion").html(p3.aaData[0].CORREO_PERSONAL);
                                      $("#telefonoMantencion").html(p3.aaData[0].CELULAR_PERSONAL);
                                      $("#fechaMantencion").html(p3.aaData[0].FECHA);
                                      $("#horaMantencion").html(p3.aaData[0].RANGO);
                                      $("#sucursalMantencion").html(p3.aaData[0].SUCURSAL);
                                      $("#tallerMantencion").html(p3.aaData[0].NOMBRE);
                                      $("#direccionMantencion").html(p3.aaData[0].DIRECCION);
                                      $("#motivoMantencion").html(p3.aaData[0].MOTIVO);
                                      $("#folioSiniestroMantencion").html(p3.aaData[0].SINIESTRO);
                                      $("#estadoMantencion").html(p3.aaData[0].ESTADO_FINAL);
                                      $("#folioMantencion").html(id);

                                      if(p3.aaData[0].PDF_AGENDA != null){
                                        $("#agendaVerMantencion").removeAttr("disabled","disabled");
                                        $("#colorAgendaVerMantencion").css("color","red");
                                        $("#agendaVerMantencion").attr("onclick","pdf_Mantencion('/agenda/"+ p3.aaData[0].PDF_AGENDA + "');");
                                      }
                                      else{
                                        $("#agendaVerMantencion").attr("disabled","disabled");
                                        $("#colorAgendaVerMantencion").css("color","gray");
                                      }

                                      if(p3.aaData[0].PDF_DIAG != null){
                                        $("#diagnosticoVerMantencion").removeAttr("disabled","disabled");
                                        $("#colorDiagnosticoVerMantencion").css("color","red");
                                        $("#diagnosticoVerMantencion").attr("onclick","pdf_Mantencion('/diagnostico/"+ p3.aaData[0].PDF_DIAG + "');");
                                      }
                                      else{
                                        $("#diagnosticoVerMantencion").attr("disabled","disabled");
                                        $("#colorDiagnosticoVerMantencion").css("color","gray");
                                      }

                                      if(p3.aaData[0].PDF_FACTURA != null){
                                        $("#facturaVerMantencion").removeAttr("disabled","disabled");
                                        $("#colorFacturaVerMantencion").css("color","red");
                                        $("#facturaVerMantencion").attr("onclick","pdf_Mantencion('/factura/"+ p3.aaData[0].PDF_FACTURA + "');");
                                      }
                                      else{
                                        $("#facturaVerMantencion").attr("disabled","disabled");
                                        $("#colorFacturaVerMantencion").css("color","gray");
                                      }

                                      if(p3.aaData[0].PDF_OC != null){
                                        $("#ocVerMantencion").removeAttr("disabled","disabled");
                                        $("#colorOcVerMantencion").css("color","red");
                                        $("#ocVerMantencion").attr("onclick","pdf_Mantencion('/oc/"+ p3.aaData[0].PDF_OC + "');");
                                      }
                                      else{
                                        $("#ocVerMantencion").attr("disabled","disabled");
                                        $("#colorOcVerMantencion").css("color","gray");
                                      }

                                      if(p3.aaData[0].ESTADO === "Agendada" && p3.aaData[0].SUBESTADO === "Agendada"){
                                        if(p3.aaData[0].PDF_AGENDA != null && p3.aaData[0].PDF_DIAG != null && p3.aaData[0].PDF_FACTURA != null &&  p3.aaData[0].PDF_OC != null){
                                          $("#subirPdfMantencion").attr("disabled","disabled");
                                          $("#cancelarMantencion").removeAttr("disabled","disabled");
                                          $("#completarMantencion").removeAttr("disabled","disabled");
                                        }
                                        else{
                                          $("#subirPdfMantencion").removeAttr("disabled","disabled");
                                          $("#completarMantencion").removeAttr("disabled","disabled");
                                          $("#cancelarMantencion").removeAttr("disabled","disabled");
                                        }
                                      }
                                      else if(p3.aaData[0].ESTADO === "Taller" && p3.aaData[0].SUBESTADO === "Ingresado"){
                                        $("#subirPdfMantencion").removeAttr("disabled","disabled");
                                        $("#completarMantencion").removeAttr("disabled","disabled");
                                        $("#cancelarMantencion").attr("disabled","disabled");
                                        $("#ingregoTallerMantencion").attr("disabled","disabled");
                                      }
                                      else{
                                        $("#subirPdfMantencion").attr("disabled","disabled");
                                        $("#completarMantencion").attr("disabled","disabled");
                                        $("#cancelarMantencion").attr("disabled","disabled");
                                      }
                                    }
                                  }
                                });
                                setTimeout(function(){
                                  var h = $(window).height() - 250;
                                  $("#bodyVerEvento").css("height",h);
                                  $('#modalAlertasSplash').modal('hide');
                                  $('#modalVerEvento').modal('show');
                                },2000);
                              },
                              loading: async function(bool) {
                                if(bool === false){
                                  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
                                  var parametros = {
                                    "mes": $("#fc-dom-1").html().split("/")[0],
                                    "ano": $("#fc-dom-1").html().split("/")[1]
                                  }
                                  await $('#tablaCalendario').DataTable( {
                                      ajax: {
                                          url: "controller/datosPatenteMantencionLista.php",
                                          type: 'POST',
                                          data: parametros
                                      },
                                      columns: [
                                        { data: 'S', className: "centerDataTable" },
                                        { data: 'FOLIO', className: "centerDataTable" },
                                        { data: 'ESTADO', className: "centerDataTable" },
                                        { data: 'FECHA_HORA_AGENDA'},
                                        { data: 'FECHA_INGRESO'},
                                        { data: 'MOTIVO'},
                                        { data: 'PATENTE' },
                                        { data: 'COLABORADOR'},
                                        { data: 'CORREO_PERSONAL'},
                                        { data: 'CELULAR_PERSONAL'},
                                        { data: 'TALLER' },
                                        { data: 'DIRECCION_TALLER'},
                                        { data: 'CONTACTO_TALLER'},
                                        { data: 'FONO_TALLER' },
                                        { data: 'PDF_AGENDA_D', className: "centerDataTable" },
                                        { data: 'PDF_DIAG_D' , className: "centerDataTable" },
                                        { data: 'PDF_FACTURA_D', className: "centerDataTable" },
                                        { data: 'PDF_OC_D' , className: "centerDataTable" },
                                        { data: 'PDF_AGENDA' },
                                        { data: 'PDF_DIAG' },
                                        { data: 'PDF_FACTURA'},
                                        { data: 'PDF_OC' }
                                      ],
                                      buttons: [
                                          {
                                            extend: 'excel',
                                            exportOptions: {
                                              columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,18,19,20,21 ]
                                            },
                                            title: null,
                                            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
                                          },
                                          {
                                            text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
                                            action: function ( e, dt, node, config ) {
                                              var table = $('#tablaCalendario').DataTable();
                                              table.rows().deselect();
                                            }
                                          }
                                      ],
                                      "columnDefs": [
                                        {
                                          "width": "5px",
                                          "targets": 0
                                        },
                                        {
                                          "orderable": false,
                                          "className": 'select-checkbox',
                                          "targets": [ 0 ]
                                        },
                                        {
                                          "visible": false,
                                          "searchable": false,
                                          "targets": [ 18 ]
                                        },
                                        {
                                          "visible": false,
                                          "searchable": false,
                                          "targets": [ 19 ]
                                        },
                                        {
                                          "visible": false,
                                          "searchable": false,
                                          "targets": [ 20 ]
                                        },
                                        {
                                          "visible": false,
                                          "searchable": false,
                                          "targets": [ 21 ]
                                        },
                                      ],
                                      "select": {
                                          style: 'single'
                                      },
                                      "paging": true,
                                      "ordering": true,
                                      "scrollCollapse": true,
                                      "scrollX": false,
                                      "responsive": {
                                          details: {
                                              renderer: function ( api, rowIdx, columns ) {
                                                  var data = $.map( columns, function ( col, i ) {
                                                      return col.hidden ?
                                                          '<tr data-dt-row="'+col.rowIndex+'" data-dt-column="'+col.columnIndex+'">'+
                                                              '<td style="font-weight: bold; min-width: 150px;">'+col.title+':'+'</td> '+
                                                              '<td style="min-width: 150px; text-align: center;">'+col.data+'</td>'+
                                                          '</tr>' :
                                                          '';
                                                  } ).join('');

                                                  return data ?
                                                      $('<table/>').append( data ) :
                                                      false;
                                              }
                                          }
                                      },
                                      "info":     true,
                                      "lengthMenu": [[largo], [largo]],
                                      "dom": 'Bfrtip',
                                      "language": {
                                        "zeroRecords": "No hay datos disponibles",
                                        "info": "Registro _START_ de _END_ de _TOTAL_",
                                        "infoEmpty": "No hay datos disponibles",
                                        "paginate": {
                                            "previous": "Anterior",
                                            "next": "Siguiente"
                                          },
                                          "search": "Buscar: ",
                                          "select": {
                                              "rows": "- %d registros seleccionados"
                                          },
                                          "infoFiltered": "(Filtrado de _MAX_ registros)"
                                      },
                                      "destroy": true,
                                      "autoWidth": false,
                                      "initComplete": function( settings, json){
                                        setTimeout(function(){
                                          $('#modalAlertasSplash').modal('hide');
                                          setTimeout(function(){
                                            $('#tablaCalendario').DataTable().columns.adjust();
                                          },200);
                                        },1000);
                                      },
                                      "drawCallback": function( settings ) {
                                          setTimeout(function(){
                                            $('#tablaCalendario').DataTable().columns.adjust();
                                          },50);
                                      }
                                  });
                                }
                                else{
                                  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                                  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                                  $('#modalAlertasSplash').modal('show');
                                }
                              }
                            });

                            calendar.render();

                            setTimeout(function(){
                              $('#modalAlertasSplash').modal('hide');
                            },1000);
                          }
                          else{
                            var random = Math.round(Math.random() * (1000000 - 1) + 1);
                            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar mantención, si el problema persiste favor comuniquese con soporte");
                            setTimeout(function(){
                              $('#modalAlertasSplash').modal('hide');
                            },1000);
                          }
                        }
                        else{
                          var random = Math.round(Math.random() * (1000000 - 1) + 1);
                          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar mantención, si el problema persiste favor comuniquese con soporte");
                          setTimeout(function(){
                            $('#modalAlertasSplash').modal('hide');
                          },1000);
                        }
                      }
                    });
                  }
                });
              }
            });
          }
        }
      }
    });
  }
  else if($("#celularAgregarMantencion").val().length < 9){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar un celular con 9 digitos");
  }
  else{
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar un taller");
  }
});

$("#celularAgregarMantencion").focusout(function(e){
  e.preventDefault();
  var telefono = $("#celularAgregarMantencion").val();
  if(telefono.length < 9){
    $("#celularAgregarMantencion").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El número de celular debe tener 9 digitos exactos");
  }
});

$("#celularAgregarMantencion").on('input', function(){
  $(this).removeClass("is-invalid");
});
// Fin Funcion para ingreso de datos a mantención

$("#validaCodeGA").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url:   'controller/validaTestGACrear.php',
    type:  'post',
    data:  {
      "codigo": $("#codeGA").val()
    },
    success: async function (response) {
      if(response != 'Error'){
        await $.ajax({
          url:   'controller/ingresarCodeGA.php',
          type:  'post',
          data: {
            "login2fa": $("#optionFirmaLogin" ).prop('checked') === true ? 1 : 0,
            "firma2fa": $("#optionFirmaPDF" ).prop('checked') === true ? 1 : 0,
            "codigo": $("#codeGA").val()
          },
          success: function (resp) {
            if(resp != 'Error'){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Contraseña 2FA creada correctamente");
              $('#codeGA').attr('disabled', 'disabled');
              $('#validaCodeGA').attr('disabled', 'disabled');
              $('#codeGA').remove();
              $('#validaCodeGA').remove();
              $('#messageGA').show();
              $('#optionsFirma').show();
              $("#titleGA").remove();
              $("#qrGA").remove();
              $("#messageGAValid").remove();
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
        });
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Código incorrecto");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

async function ingresarCodeGATipo(flagLogin, flagPDF) {
  await $.ajax({
    url:   'controller/ingresarCodeGATipo.php',
    type:  'post',
    data: {
      "login2fa": flagLogin === true ? 1 : 0,
      "firma2fa": flagPDF === true ? 1 : 0,
      "codigo": $("#codeGA").val()
    },
    success: function (resp) {
    }
  });
}

$("#validarLogin2fa").unbind("click").click(async function(e){
  e.preventDefault();
  valida2faEnter();
});

$("#codigoLogin2fa").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#agregarZonaObra").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorZonasObra").DataTable();
  var datos = table.rows().data();

  await $.ajax({
    url:   'controller/datosProyectoConfigObra.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoProyecto = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoProyecto += '<option value="' + p.aaData[i].ID_ESTRUCTURA + '" name="' + p.aaData[i].AREA + '">' + p.aaData[i].PROYECTO + '</option>';
        }
        $("#proyectoConfigurarZonasObra").html(cuerpoProyecto);
      }
    }
  });

  $("#divZonaConfigurarZonasObra").html('');
  $("#divZonaConfigurarZonasObra").append('<label style="font-weight: bold;">Zona Geográfica</label><select multiple id="zonaConfigurarZonasObra" class="form-control"></select>');

  var seleccionados = [];
  for(var z = 0; z < datos.length; z++){
    if($("#proyectoConfigurarZonasObra").val() == datos[z].IDESTRUCTURA_OPERACION){
      seleccionados.push(datos[z].IDAREAFUNCIONAL);
    }
  }

  await $.ajax({
    url:   'controller/datosAreaFuncionalConfigZonasObras.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoZona = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          var ing = 0;
          for(var j = 0; j < p.aaData.length; j++){
            if(p.aaData[i].IDAREAFUNCIONAL == seleccionados[j]){
              // cuerpoZona += '<option selected value="' + p.aaData[i].IDAREAFUNCIONAL + '">&nbsp;&nbsp;' + p.aaData[i].COMUNA + '</option>';
              ing = 1;
              break;
            }
          }
          if(ing == 0){
            cuerpoZona += '<option value="' + p.aaData[i].IDAREAFUNCIONAL + '">&nbsp;&nbsp;' + p.aaData[i].COMUNA + '</option>';
          }
        }
        $("#zonaConfigurarZonasObra").html(cuerpoZona);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoConfigurarZonasObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  $("#areaConfigurarZonasObra").val($("#proyectoConfigurarZonasObra").find('option:selected').attr("name"));
  await $("#zonaConfigurarZonasObra").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalConfigurarZonasObra").modal("show");
  },500);
});

$("#proyectoConfigurarZonasObra").unbind("click").change(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalConfigurarZonasObra").modal("hide");
  $('#modalAlertasSplash').modal('show');
  $("#areaConfigurarZonasObra").val($("#proyectoConfigurarZonasObra").find('option:selected').attr("name"));
  $("#zonaConfigurarZonasObra").multiSelect('deselect_all');
  var table = $("#tablaMantenedorZonasObra").DataTable();
  var datos = table.rows().data();
  var seleccionados = [];

  $("#divZonaConfigurarZonasObra").html('');
  $("#divZonaConfigurarZonasObra").append('<label style="font-weight: bold;">Zona Geográfica</label><select multiple id="zonaConfigurarZonasObra" class="form-control"></select>');

  var seleccionados = [];
  for(var z = 0; z < datos.length; z++){
    if($("#proyectoConfigurarZonasObra").val() == datos[z].IDESTRUCTURA_OPERACION){
      seleccionados.push(datos[z].IDAREAFUNCIONAL);
    }
  }

  await $.ajax({
    url:   'controller/datosAreaFuncionalConfigZonasObras.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoZona = '';
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++){
          var ing = 0;
          for(var j = 0; j < p.aaData.length; j++){
            if(p.aaData[i].IDAREAFUNCIONAL == seleccionados[j]){
              // cuerpoZona += '<option selected value="' + p.aaData[i].IDAREAFUNCIONAL + '">&nbsp;&nbsp;' + p.aaData[i].COMUNA + '</option>';
              ing = 1;
              break;
            }
          }
          if(ing == 0){
            cuerpoZona += '<option value="' + p.aaData[i].IDAREAFUNCIONAL + '">&nbsp;&nbsp;' + p.aaData[i].COMUNA + '</option>';
          }
        }
        $("#zonaConfigurarZonasObra").html(cuerpoZona);
      }
    }
  });
  $("#areaConfigurarZonasObra").val($("#proyectoConfigurarZonasObra").find('option:selected').attr("name"));
  await $("#zonaConfigurarZonasObra").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectProyecto' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalConfigurarZonasObra").modal("show");
  },500);
});

$("#guardarConfigurarZonasObra").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalConfigurarZonasObra").modal("hide");
  var parametros = {
    "proyecto": $("#proyectoConfigurarZonasObra").val(),
    "zonas": $("#zonaConfigurarZonasObra").val()
  }

  $.ajax({
      url:   'controller/cargarZonasObraPreConfig.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorZonasObra').DataTable();
            //table.rows('.selected').remove().draw();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Zonas ingresadas correctamente");
            $("#eliminarZonaObra").attr("disabled","disabled");
            $("#activarZonaObra").attr("disabled","disabled");
            $("#asignarPersonalZonaObra").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear usuario, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear usuario, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
});

$("#eliminarZonaObra").unbind("click").click(function(){
  $("#modalEliminarZonaObra").modal("show");
});

$("#guardarEliminarZonaObra").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEliminarZonaObra").modal("hide");
  var table = $("#tablaMantenedorZonasObra").DataTable();
  var datos = table.rows('.selected').data();
  var parametros;
  var idZonas = '';
  if(table.rows('.selected').data().length > 0){
    for(var i = 0; i < table.rows('.selected').data().length; i++){
      if(i == 0){
        idZonas += datos[i].FOLIO;
      }
      else{
        idZonas += ',' + datos[i].FOLIO;
      }
    }

    parametros = {
      "idZonas": idZonas
    }
  }

  $.ajax({
      url:   'controller/eliminarZonasObra.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorZonasObra').DataTable();
            //table.rows('.selected').remove().draw();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Zona eliminada correctamente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
            $("#eliminarZonaObra").attr("disabled","disabled");
            $("#activarZonaObra").attr("disabled","disabled");
            $("#asignarPersonalZonaObra").attr("disabled","disabled");
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No es posible eliminar la zona configurada dado que posee personal u órdenes asignadas.");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No es posible eliminar la zona configurada dado que posee personal u órdenes asignadas.");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
});

$("#activarZonaObra").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorZonasObra").DataTable();
  var datos = table.rows('.selected').data();
  var parametros;
  var idZonas = '';
  if(table.rows('.selected').data().length > 0){
    if(datos[0].ACTIVA == 'Habilitada'){
      $("#tituloActivarZonaObra").html('Desactivar Zona');
      $("#detalleActivarZonaObra").html('¿Está seguro que desea desactivar la zona seleccionada?');
    }
    else{
      $("#tituloActivarZonaObra").html('Activar Zona');
      $("#detalleActivarZonaObra").html('¿Está seguro que desea activar la zona seleccionada?');
    }
  }
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalActivarZonaObra").modal("show");
  },500);
});

$("#guardarActivarZonaObra").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalActivarZonaObra").modal("hide");
  var table = $("#tablaMantenedorZonasObra").DataTable();
  var datos = table.rows('.selected').data();
  var parametros;
  var idZonas = '';
  var activa = '';
  if(table.rows('.selected').data().length > 0){
    for(var i = 0; i < table.rows('.selected').data().length; i++){
      if(i == 0){
        idZonas += datos[i].FOLIO;
      }
      else{
        idZonas += ',' + datos[i].FOLIO;
      }
    }

    if(datos[0].ACTIVA == 'Habilitada'){
      activa = 0;
    }
    else{
      activa = 1;
    }

    parametros = {
      "idZonas": idZonas,
      "activa": activa
    }
  }

  $.ajax({
      url:   'controller/activarZonasObra.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorZonasObra').DataTable();
            //table.rows('.selected').remove().draw();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Actualización ingresada correctamente");
            $("#eliminarZonaObra").attr("disabled","disabled");
            $("#activarZonaObra").attr("disabled","disabled");
            $("#asignarPersonalZonaObra").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear usuario, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear usuario, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
});

var varGraficoPorFlota = function graficoPorFlota(){
  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawChartFlota);

  function drawChartFlota() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Estado');
    data.addColumn('number', 'Q');
    data.addColumn({type:'string', role:'style'});
    data.addColumn({type:'string', role:'annotation'});

    var tableFlota = $('#informeListadoVehiculo').DataTable();
    var datosFlota = tableFlota.rows().data();

    for(var k = 0; k < datosFlota.length; k++){
      data.addRow([datosFlota[k].ESTADO_TEXTO, parseInt(datosFlota[k].Q), datosFlota[k].COLOR_PLANO, datosFlota[k].Q]);
    }

    var w = $(window).width()/3;

    var options = {
      height: '100%',
      width: '100%',
      chartArea: {
        left: 150,
        top: 0,
        bottom: 0,
        width: '70%',
        height: '100%'
      },
      legend: {
        position: "none"
      },
      vAxis : {
        textStyle : {
          fontSize: 11 // or the number you want
        }
      }
    };

    var chart = new google.visualization.BarChart(document.getElementById('graficaListadoVehiculo'));

    setTimeout(function(){
      chart.draw(data, options);
    },500);
  }
}

// Funcion para modal rechazar mantencion
$("#cancelarMantencion").unbind('click').click(function(){
  $("#observacionCancelarMantencion").val("");
  $("#observacionCancelarMantencion").removeClass("is-invalid");
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#motivoCancelarMantencion").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  $('#modalVerEvento').modal('hide');
  $('#modalCancelarMantencion').modal('show');
});

$("#guardarCancelarMantencion").unbind('click').click(async function(){
  if($("#observacionCancelarMantencion").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar una observación");
    if ($("#observacionCancelarMantencion").val().length == 0){
      $("#observacionCancelarMantencion").addClass("is-invalid");
    }
  }
  else{
    $("#modalCancelarMantencion").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    parametros = {
      "idMantencion": $("#folioMantencion").text(),
      "motivo": $("#motivoCancelarMantencion").val(),
      "observacion": $("#observacionCancelarMantencion").val(),
      "patente": $("#patenteMantencion").text(),
    }
    await $.ajax({
      url:   'controller/rechazarMantencion.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Mantención rechazada correctamente");
              $('#modalAlertasSplash').modal('hide');
              $('#calendario').fullCalendar('refetchEvents');
          }
          else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al rechazar la Mantención");
              $('#modalAlertasSplash').modal('hide');
          }
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al rechazar la Mantención");
            $('#modalAlertasSplash').modal('hide');
        }
      }
    });
  }
});

$("#observacionCancelarMantencion").on('input', function(){
  $(this).removeClass("is-invalid");
});
// Fin Funcion para modal rechazar mantencion

// Funcion para modal completar mantencion
$("#completarMantencion").unbind('click').click(async function(){
  $("#observacionCompletarMantencion").val("");
  $("#observacionCompletarMantencion").removeClass("is-invalid");

  await $.ajax({
    url:   'controller/datosPatenteEstadoCompletarMantencion.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEst = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(p2.aaData[i].IDPATENTE_ESTADO == 1){
            cuerpoEst += '<option selected value="' + p2.aaData[i].IDPATENTE_ESTADO + '">' + p2.aaData[i].ESTADO + '    ' + p2.aaData[i].SUB_ESTADO1 + '    ' + p2.aaData[i].SUB_ESTADO2 + '</option>';
          }
          else if(p2.aaData[i].IDPATENTE_ESTADO == 2){
            cuerpoEst += '<option value="' + p2.aaData[i].IDPATENTE_ESTADO + '">' + p2.aaData[i].ESTADO + '    ' + p2.aaData[i].SUB_ESTADO1 + '    ' + p2.aaData[i].SUB_ESTADO2 + '</option>';
          }
          else if(p2.aaData[i].IDPATENTE_ESTADO >= 19){
            cuerpoEst += '<option value="' + p2.aaData[i].IDPATENTE_ESTADO + '">' + p2.aaData[i].ESTADO + '    ' + p2.aaData[i].SUB_ESTADO1 + '    ' + p2.aaData[i].SUB_ESTADO2 + '</option>';
          }
        }
        $("#estadoVehiculoCompletarMantencion").html(cuerpoEst);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#estadoVehiculoCompletarMantencion").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $('#modalVerEvento').modal('hide');
  $('#modalCompletarMantencion').modal('show');
});

$("#guardarCompletarMantencion").unbind('click').click(async function(){
  if($("#observacionCompletarMantencion").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar una observación");
    if ($("#observacionCompletarMantencion").val().length == 0){
      $("#observacionCompletarMantencion").addClass("is-invalid");
    }
  }
  else{
    $("#modalCompletarMantencion").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    parametros = {
      "idMantencion": $("#folioMantencion").text(),
      "observacion": $("#observacionCompletarMantencion").val(),
      "patente": $("#patenteMantencion").text(),
      "estado": $("#estadoVehiculoCompletarMantencion").val()
    }
    await $.ajax({
      url:   'controller/completarMantencion.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Mantención completada correctamente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
          }
          else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al completar la Mantención");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
          }
        }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al completar la Mantención");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }
    });
  }
});

$("#observacionCompletarMantencion").on('input', function(){
  $(this).removeClass("is-invalid");
});
// Fin Funcion para modal completar mantencion

// EVENTO PARA ABRIR PDF MANTENCION
async function pdf_Mantencion(pdf){
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    window.open(window.location.toString().split("#/")[0].split('?')[0] + 'controller/repositorio/flota/mantenciones' + pdf, '_blank');
  }
}
// FIN EVENTO PARA ABRIR PDF MANTENCION

// FUNCION PARA MODAL SUBIR PDF MANTENCION
// Primero cargamos los archivos
$("#pdfCargaAgenda" ).on('change', function(e){
  var file = e.target.files[0].name; // agarramos solo el nombre([0].name) del array que tiene tamaño, fecha y mas
  $("#inputPdfAgenda").val(file);
  $("#inputPdfAgenda").removeClass("is-invalid");
});

$("#pdfCargaDiagnostico" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfDiagnostico").val(file);
  $("#inputPdfDiagnostico").removeClass("is-invalid");
});

$("#pdfCargaFactura" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfFactura").val(file);
  $("#inputPdfFactura").removeClass("is-invalid");
});

$("#pdfCargaOc" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfOc").val(file);
  $("#inputPdfOc").removeClass("is-invalid");
});

$("#subirPdfMantencion").unbind("click").click(async function(){
  $("#modalVerEvento").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var parametros = {
    "idMantencion" : $("#folioMantencion").text()
  }
  await $.ajax({
    url:   'controller/datosPdfMantencion.php',
    type:  'post',
    data: parametros,
    success: function (response3) {
      var p3 = jQuery.parseJSON(response3);
      agenda = p3.aaData[0].PDF_AGENDA;
      diagnostico = p3.aaData[0].PDF_DIAG;
      factura = p3.aaData[0].PDF_FACTURA;
      oc = p3.aaData[0].PDF_OC;
      cont_agenda = p3.aaData[0].CONTADOR_AGENDA;
      cont_diag = p3.aaData[0].CONTADOR_DIAG;
      cont_factura = p3.aaData[0].CONTADOR_FACTURA;
      cont_oc = p3.aaData[0].CONTADOR_OC;
    }
  });

  if(cont_agenda == null || cont_agenda == 1){
    $("#inputPdfAgenda").val(agenda);
    $("#spanAgenda").html("<font> </font>");
    $("#pdfCargaAgenda").removeAttr("disabled");
  }
  else{
    $("#spanAgenda").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfAgenda").val(agenda);
    $("#pdfCargaAgenda").attr("disabled","disabled");
  }

  if(cont_diag == null || cont_diag == 1){
    $("#inputPdfDiagnostico").val(diagnostico);
    $("#spanDiagnostico").html("<font> </font>");
    $("#pdfCargaDiagnostico").removeAttr("disabled");
  }
  else{
    $("#spanDiagnostico").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfDiagnostico").val(diagnostico);
    $("#pdfCargaDiagnostico").attr("disabled","disabled");
  }

  if(cont_factura == null || cont_factura == 1){
    $("#inputPdfFactura").val(factura);
    $("#spanFactura").html("<font> </font>");
    $("#pdfCargaFactura").removeAttr("disabled");
  }
  else{
    $("#spanFactura").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfFactura").val(factura);
    $("#pdfCargaFactura").attr("disabled","disabled");
  }

  if(cont_oc == null || cont_oc == 1){
    $("#inputPdfOc").val(oc);
    $("#spanOc").html("<font> </font>");
    $("#pdfCargaOc").removeAttr("disabled");
  }
  else{
    $("#spanOc").html("<font>  ¡PDF Cargado! </font>");
    $("#inputPdfOc").val(oc);
    $("#pdfCargaOc").attr("disabled","disabled");
  }

  $("#pdfCargaAgenda").val('');
  $("#inputPdfAgenda").removeClass("is-invalid");

  $("#pdfCargaDiagnostico").val('');
  $("#inputPdfDiagnostico").removeClass("is-invalid");

  $("#pdfCargaFactura").val('');
  $("#inputPdfFactura").removeClass("is-invalid");

  $("#pdfCargaOc").val('');
  $("#inputPdfOc").removeClass("is-invalid");

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalSubirPdfMantencion").modal("show");
  },500);
});

$("#guardarSubirPdfMantencion").unbind("click").click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalSubirPdfMantencion").modal("hide");

  var idMant = $("#folioMantencion").text();
  var patente = $("#patenteMantencion").text();
  var motivo = $("#motivoMantencion").text();

  var formdata = new FormData();
  formdata.append('idMantencion',idMant);
  formdata.append('patente',patente);
  formdata.append('motivo',motivo);
  formdata.append('pdfDiagnostico',$("#pdfCargaDiagnostico")[0].files[0]);
  formdata.append('pdfFactura',$("#pdfCargaFactura")[0].files[0]);
  formdata.append('pdfOc',$("#pdfCargaOc")[0].files[0]);

  await $.ajax({
    url: "controller/ingresaPdfMantencion.php",
    type: 'POST',
    data: formdata,
    cache: false,
    contentType: false,
    processData: false,
    success: async function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Pdf ingresado correctamente");

            parametros = {
              "idMantencion": idMant
            }
            await $.ajax({
              url:   'controller/datosCalendarSelect.php',
              type:  'post',
              data: parametros,
              success: function (response3) {
                var p3 = jQuery.parseJSON(response3);
                if(response3.localeCompare("Sin datos") != 0){
                  $("#patenteMantencion").html(p3.aaData[0].CODIGO);
                  $("#marcaMantencion").html(p3.aaData[0].MARCA);
                  $("#modeloMantencion").html(p3.aaData[0].MODELO);
                  $("#personalMantencion").html(p3.aaData[0].PERSONAL);
                  $("#correoMantencion").html(p3.aaData[0].CORREO_PERSONAL);
                  $("#telefonoMantencion").html(p3.aaData[0].CELULAR_PERSONAL);
                  $("#fechaMantencion").html(p3.aaData[0].FECHA);
                  $("#horaMantencion").html(p3.aaData[0].RANGO);
                  $("#sucursalMantencion").html(p3.aaData[0].SUCURSAL);
                  $("#tallerMantencion").html(p3.aaData[0].NOMBRE);
                  $("#direccionMantencion").html(p3.aaData[0].DIRECCION);
                  $("#motivoMantencion").html(p3.aaData[0].MOTIVO);
                  $("#folioSiniestroMantencion").html(p3.aaData[0].SINIESTRO);
                  $("#estadoMantencion").html(p3.aaData[0].ESTADO_FINAL);
                  $("#folioMantencion").html(id);

                  if(p3.aaData[0].PDF_AGENDA != null){
                    $("#agendaVerMantencion").removeAttr("disabled","disabled");
                    $("#colorAgendaVerMantencion").css("color","red");
                    $("#agendaVerMantencion").attr("onclick","pdf_Mantencion('/agenda/"+ p3.aaData[0].PDF_AGENDA + "');");
                  }
                  else{
                    $("#agendaVerMantencion").attr("disabled","disabled");
                    $("#colorAgendaVerMantencion").css("color","gray");
                  }

                  if(p3.aaData[0].PDF_DIAG != null){
                    $("#diagnosticoVerMantencion").removeAttr("disabled","disabled");
                    $("#colorDiagnosticoVerMantencion").css("color","red");
                    $("#diagnosticoVerMantencion").attr("onclick","pdf_Mantencion('/diagnostico/"+ p3.aaData[0].PDF_DIAG + "');");
                  }
                  else{
                    $("#diagnosticoVerMantencion").attr("disabled","disabled");
                    $("#colorDiagnosticoVerMantencion").css("color","gray");
                  }

                  if(p3.aaData[0].PDF_FACTURA != null){
                    $("#facturaVerMantencion").removeAttr("disabled","disabled");
                    $("#colorFacturaVerMantencion").css("color","red");
                    $("#facturaVerMantencion").attr("onclick","pdf_Mantencion('/factura/"+ p3.aaData[0].PDF_FACTURA + "');");
                  }
                  else{
                    $("#facturaVerMantencion").attr("disabled","disabled");
                    $("#colorFacturaVerMantencion").css("color","gray");
                  }

                  if(p3.aaData[0].PDF_OC != null){
                    $("#ocVerMantencion").removeAttr("disabled","disabled");
                    $("#colorOcVerMantencion").css("color","red");
                    $("#ocVerMantencion").attr("onclick","pdf_Mantencion('/oc/"+ p3.aaData[0].PDF_OC + "');");
                  }
                  else{
                    $("#ocVerMantencion").attr("disabled","disabled");
                    $("#colorOcVerMantencion").css("color","gray");
                  }

                  if(p3.aaData[0].ESTADO === "Agendada" && p3.aaData[0].SUBESTADO === "Agendada"){
                    if(p3.aaData[0].PDF_AGENDA != null && p3.aaData[0].PDF_DIAG != null && p3.aaData[0].PDF_FACTURA != null &&  p3.aaData[0].PDF_OC != null){
                      $("#subirPdfMantencion").attr("disabled","disabled");
                      $("#cancelarMantencion").attr("disabled","disabled");
                      $("#completarMantencion").removeAttr("disabled","disabled");
                    }
                    else{
                      $("#subirPdfMantencion").removeAttr("disabled","disabled");
                      $("#completarMantencion").attr("disabled","disabled");
                      $("#cancelarMantencion").removeAttr("disabled","disabled");
                    }
                  }
                  else{
                    $("#subirPdfMantencion").attr("disabled","disabled");
                    $("#completarMantencion").attr("disabled","disabled");
                    $("#cancelarMantencion").attr("disabled","disabled");
                  }
                }

                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  $('#modalVerEvento').modal('show');
                },500);
              }
            });
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar Pdf");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar Pdf");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL SUBIR PDF MANTENCION

$("#solicitarTarjetaCombustible").unbind('click').click(function(){
  $("#modalFlotaTarjetaSolCarga").find("input,textarea,select").val("");
  $("#obsSolicitarCarga").val("");
  var table = $('#tablaTarjetaCombustible').DataTable();
  var datos = table.rows('.selected').data();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#rutSolicitarCarga").val(datos[0].DNI);
  $("#nombreSolicitarCarga").val(datos[0].USUARIO_ASIGNADO);
  $("#estadoSolicitarCarga").val(datos[0].ESTADO_GESTPER2);
  $("#patenteSolicitarCarga").val(datos[0].PATENTE);
  $("#tarjetaSolicitarCarga").val(datos[0].NUMERO);
  $("#productoSolicitarCarga").val(datos[0].PRODUCTO);
  $("#tipoSolicitarCarga").val(datos[0].TIPO);
  $("#bodegaSolicitarCarga").val(datos[0].BODEGA.split("<br>"));
  $("#servicioSolicitarCarga").val(datos[0].SERVICIO);
  $("#clienteSolicitarCarga").val(datos[0].CLIENTE);
  $("#actividadSolicitarCarga").val(datos[0].ACTIVIDAD);
  setTimeout(async function(){
    if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      var h = $(window).height() - 200;
      $("#bodyEditarTarjeta").css("height",h);
    }
    $("#modalSolicitarCarga").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#devolucionTarjetaCombustible").unbind('click').click(function(){
  $("#modalDevolucionCarga").find("input,textarea,select").val("");
  $("#obsDevolucionCarga").val("");
  var table = $('#tablaTarjetaCombustible').DataTable();
  var datos = table.rows('.selected').data();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  if(datos[0].SALDOFINAL <= 0 ){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Tarjeta no tiene saldo suficiente para solicitar devolución");
    $('#modalAlertasSplash').modal('hide');
  }
  else{
    $("#rutDevolucionCarga").val(datos[0].DNI);
    $("#nombreDevolucionCarga").val(datos[0].USUARIO_ASIGNADO);
    $("#estadoDevolucionCarga").val(datos[0].ESTADO_GESTPER2);
    $("#patenteDevolucionCarga").val(datos[0].PATENTE);
    $("#tarjetaDevolucionCarga").val(datos[0].NUMERO);
    $("#productoDevolucionCarga").val(datos[0].PRODUCTO);
    $("#tipoDevolucionCarga").val(datos[0].TIPO);
    $("#bodegaDevolucionCarga").val(datos[0].BODEGA);
    $("#servicioDevolucionCarga").val(datos[0].SERVICIO);
    $("#clienteDevolucionCarga").val(datos[0].CLIENTE);
    $("#actividadDevolucionCarga").val(datos[0].ACTIVIDAD);
    $("#montoDevolucionCarga").val(datos[0].SALDO);
  }
  setTimeout(async function(){
    if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      var h = $(window).height() - 200;
      $("#bodyDevolucionCarga").css("height",h);
    }
    $("#modalDevolucionCarga").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#optionFirmaLogin" ).on('change', async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  if($("#optionFirmaLogin" ).prop('checked') && $("#optionFirmaPDF" ).prop('checked')){
    await ingresarCodeGATipo(true, true);
  }
  else if($("#optionFirmaLogin" ).prop('checked') && !$("#optionFirmaPDF" ).prop('checked')){
    await ingresarCodeGATipo(true, false);
  }
  else if(!$("#optionFirmaLogin" ).prop('checked') && !$("#optionFirmaPDF" ).prop('checked')){
    await ingresarCodeGATipo(false, false);
  }
  else if(!$("#optionFirmaLogin" ).prop('checked') && $("#optionFirmaPDF" ).prop('checked')){
    await ingresarCodeGATipo(false, true);
  }
});

$("#optionFirmaPDF" ).on('change', async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  if($("#optionFirmaLogin" ).prop('checked') && $("#optionFirmaPDF" ).prop('checked')){
    await ingresarCodeGATipo(true, true);
  }
  else if($("#optionFirmaLogin" ).prop('checked') && !$("#optionFirmaPDF" ).prop('checked')){
    await ingresarCodeGATipo(true, false);
  }
  else if(!$("#optionFirmaLogin" ).prop('checked') && !$("#optionFirmaPDF" ).prop('checked')){
    await ingresarCodeGATipo(false, false);
  }
  else if(!$("#optionFirmaLogin" ).prop('checked') && $("#optionFirmaPDF" ).prop('checked')){
    await ingresarCodeGATipo(false, true);
  }
});

$("#guardarSolicitarCarga").unbind('click').click(async function(){
  if($.trim($("#montoSolicitarCarga").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    $("#montoSolicitarCarga").addClass("is-invalid");
  }
  if($("#obsSolicitarCarga").val() === null || $("#obsSolicitarCarga").val().length === 0 || /^\s+$/.test($("#obsSolicitarCarga").val())){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    $("#obsSolicitarCarga").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalSolicitarCarga").modal("hide");
    var table = $('#tablaTarjetaCombustible').DataTable();
    var tarjeta = $.map(table.rows('.selected').data(), function (item) {
      return item.NUMERO;
    });
    var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE;
    });
    var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.USUARIO_ASIGNADO;
    });
    var bodega = $.map(table.rows('.selected').data(), function (item) {
      return item.BODEGA;
    });
    var producto = $.map(table.rows('.selected').data(), function (item) {
      return item.PRODUCTO;
    });
    var tipo = $.map(table.rows('.selected').data(), function (item) {
      return item.TIPO;
    });
    var rutPersonal = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI;
    });

    parametros = {
      "tarjeta": tarjeta[0],
      "patente": patente[0],
      "nombre": nombre[0],
      "monto": $("#montoSolicitarCarga").val(),
      "observacion": $("#obsSolicitarCarga").val(),
      "producto": producto[0],
      "tipo": tipo[0],
      "bodega": bodega[0],
      "rutPersonal": rutPersonal[0]
    }

    await $.ajax({
      url: "controller/ingresaTarjetaSolicitudCarga.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        if(response.localeCompare("Sin datos") != 0 && response != ""){
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Solicitud de carga ingresada correctamente");
          $("#montoSolicitarCarga").val("");
          $("#obsSolicitarCarga").val("");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar solicitud de carga");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#montoSolicitarCarga").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#obsSolicitarCarga").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#asignarPersonalZonaObra").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorZonasObra').DataTable();
  var datos = table.rows('.selected').data();
  var parametros = {
    'idez': datos[0].FOLIO
  }

  $("#tituloConfigurarZonasPersonalObra").html('');
  $("#tituloConfigurarZonasPersonalObra").html(datos[0].SERVICIO + ' - ' + datos[0].CLIENTE + ' - ' + datos[0].ACTIVIDAD + ' - ' + datos[0].COMUNA);

  await $.ajax({
    url:   'controller/datosPersonalObraZonaAsignar.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoPer = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + ' - ' + p2.aaData[i].PERFIL + '</option>';
        }
        $("#personalConfigurarZonasPersonalObra").html(cuerpoPer);
      }
    }
  });

  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/40);

  await $('#tablaConfigurarZonasPersonalObra').DataTable( {
      ajax: {
          url: "controller/datosPersonalObraZonaAsignados.php",
          type: 'POST',
          data: parametros
      },
      columns: [
          { data: 'S'},
          { data: 'RUT' },
          { data: 'NOMBRE'},
          { data: 'PERFIL' },
          { data: 'TIPO' },
          { data: 'BORRAR', className: 'centerDataTable hoverDel' }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        },
        {
          "width": "5px",
          "targets": 5
        }
      ],
      "select": {
          style: 'single',
          selector: 'td:not(:nth-child(6))'
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "order": [[ 2, "asc" ]],
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'rtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json){
      }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#personalConfigurarZonasPersonalObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#funcionConfigurarZonasPersonalObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalConfigurarZonasPersonalObra").modal("show");
    setTimeout(function(){
      $('#tablaConfigurarZonasPersonalObra').DataTable().columns.adjust();
    },500);
  },1000);
});

async function quitarPersonalZonaObra(id){
  $("#modalConfigurarZonasPersonalObra").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var parametros = {
    'id': id
  }
  await $.ajax({
    url: "controller/eliminarPersonalZonaObra.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaConfigurarZonasPersonalObra').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Ejecutado correctamente");
          var table = $('#tablaMantenedorZonasObra').DataTable();
          var datos = table.rows('.selected').data();
          var parametros = {
            'idez': datos[0].FOLIO
          }

          $.ajax({
            url:   'controller/datosPersonalObraZonaAsignar.php',
            type:  'post',
            data:  parametros,
            success: function (response2) {
              var p2 = jQuery.parseJSON(response2);
              if(p2.aaData.length !== 0){
                var cuerpoPer = '';
                for(var i = 0; i < p2.aaData.length; i++){
                  cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + ' - ' + p2.aaData[i].PERFIL + '</option>';
                }
                $("#personalConfigurarZonasPersonalObra").html(cuerpoPer);
              }

              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $("#modalConfigurarZonasPersonalObra").modal("show");
                setTimeout(function(){
                  $('#tablaConfigurarZonasPersonalObra').DataTable().columns.adjust();
                },500);
              },500);
            }
          });

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#personalConfigurarZonasPersonalObra").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalConfigurarZonasPersonalObra").modal("show");
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalConfigurarZonasPersonalObra").modal("show");
        },500);
      }
    }
  });
};

$("#agregarConfigurarZonasPersonalObra").unbind("click").click(async function(){
  $("#modalConfigurarZonasPersonalObra").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorZonasObra').DataTable();
  var datos = table.rows('.selected').data();
  var parametros = {
    'idusuario': $("#personalConfigurarZonasPersonalObra").val(),
    'idoz': datos[0].FOLIO,
    'tipo': $("#funcionConfigurarZonasPersonalObra").val()
  }

  await $.ajax({
    url: "controller/ingresarPersonalZonaObra.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaConfigurarZonasPersonalObra').DataTable();
          //table.rows('.selected').remove().draw();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Ejecutado correctamente");
          var table = $('#tablaMantenedorZonasObra').DataTable();
          var datos = table.rows('.selected').data();
          var parametros = {
            'idez': datos[0].FOLIO
          }

          $.ajax({
            url:   'controller/datosPersonalObraZonaAsignar.php',
            type:  'post',
            data:  parametros,
            success: function (response2) {
              var p2 = jQuery.parseJSON(response2);
              if(p2.aaData.length !== 0){
                var cuerpoPer = '';
                for(var i = 0; i < p2.aaData.length; i++){
                  cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + ' - ' + p2.aaData[i].PERFIL + '</option>';
                }
                $("#personalConfigurarZonasPersonalObra").html(cuerpoPer);
              }

              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $("#modalConfigurarZonasPersonalObra").modal("show");
                setTimeout(function(){
                  $('#tablaConfigurarZonasPersonalObra').DataTable().columns.adjust();
                },500);
              },500);
            }
          });

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#personalConfigurarZonasPersonalObra").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalConfigurarZonasPersonalObra").modal("show");
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalConfigurarZonasPersonalObra").modal("show");
        },500);
      }
    }
  });
});

$("#guardarDevolucionCarga").unbind('click').click(async function(){
  if($.trim($("#montoSolicitarCarga").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    $("#montoDevolucionCarga").addClass("is-invalid");
  }
  if($("#obsDevolucionCarga").val() === null || $("#obsDevolucionCarga").val().length === 0 || /^\s+$/.test($("#obsDevolucionCarga").val())){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    $("#obsDevolucionCarga").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalDevolucionCarga").modal("hide");
    var table = $('#tablaTarjetaCombustible').DataTable();
    var tarjeta = $.map(table.rows('.selected').data(), function (item) {
      return item.NUMERO;
    });
    var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE;
    });
    var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.USUARIO_ASIGNADO;
    });
    var bodega = $.map(table.rows('.selected').data(), function (item) {
      return item.BODEGA;
    });
    var producto = $.map(table.rows('.selected').data(), function (item) {
      return item.PRODUCTO;
    });
    var tipo = $.map(table.rows('.selected').data(), function (item) {
      return item.TIPO;
    });
    var rutPersonal = $.map(table.rows('.selected').data(), function (item) {
      return item.DNI;
    });

    parametros = {
      "tarjeta": tarjeta[0],
      "patente": patente[0],
      "nombre": nombre[0],
      "monto": $("#montoDevolucionCarga").val(),
      "observacion": $("#obsDevolucionCarga").val(),
      "producto": producto[0],
      "tipo": tipo[0],
      "bodega": bodega[0],
      "rutPersonal": rutPersonal[0]
    }

    await $.ajax({
      url: "controller/ingresaTarjetaDevolucionCarga.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        if(response.localeCompare("Sin datos") != 0 && response != ""){
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Solicitud de devolución ingresada correctamente");
          $("#montoDevolucionCarga").val("");
          $("#obsDevolucionCarga").val("");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar solicitud de devolución");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#montoDevolucionCarga").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#obsDevolucionCarga").on('input', function(){
  $(this).removeClass("is-invalid");
});

// FUNCION PARA MODAL CONTRATOS OBRA
$("#agregarContrato").unbind("click").click(function(){
  $("#nombreIngresoContratos").removeClass("is-invalid");
  $("#anoIngresoContratos").removeClass("is-invalid");
  $("#idContratoIngresoContratos").removeClass("is-invalid");
  $("#nombreIngresoContratos").val("");
  $("#anoIngresoContratos").val("");
  $("#idContratoIngresoContratos").val("");
  $("#modalIngresoContratos").find("input,textarea,select").val("");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  setTimeout(function(){
    $("#modalIngresoContratos").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoContratos').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarIngresoContratos").unbind('click').click(function(){
  if($("#nombreIngresoContratos").val().length == 0 || $("#anoIngresoContratos").val().length == 0 || $("#idContratoIngresoContratos").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#nombreIngresoContratos").val().length == 0){
      $("#nombreIngresoContratos").addClass("is-invalid");
    }
    if ($("#anoIngresoContratos").val().length == 0){
      $("#anoIngresoContratos").addClass("is-invalid");
    }
    if ($("#idContratoIngresoContratos").val().length == 0){
      $("#idContratoIngresoContratos").addClass("is-invalid");
    }
  }
  else {
    parametros = {
      "nombreContrato": $("#nombreIngresoContratos").val(),
      "anoContrato": $("#anoIngresoContratos").val(),
      "idContrato": $("#idContratoIngresoContratos").val(),
    }
    $("#modalIngresoContratos").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaContratosObras.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoContratos').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Contrato ingresado correctamente");
            $("#editarContrato").attr("disabled","disabled");
            $("#eliminarContrato").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar un contrato ya que existe un ID duplicado");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalIngresoContratos").modal("show");
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar un contrato ya que existe un ID duplicado");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalIngresoContratos").modal("show");
          },500);
        }
      }
    });
  }
});

$("#nombreIngresoContratos").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#anoIngresoContratos").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#idContratoIngresoContratos").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN PARA MODAL INGRESAR CONTRATOS OBRA

// FUNCION PARA MODAL EDITAR CONTRATOS OBRA
$("#editarContrato").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoContratos').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  var ano = $.map(table.rows('.selected').data(), function (item) {
    return item.ANO;
  });
  var idContrato = $.map(table.rows('.selected').data(), function (item) {
    return item.IDCONTRATO;
  });

  $("#nombreEditarContratos").val(nombre);
  $("#anoEditarContratos").val(ano);
  $("#idContratoEditarContratos").val(idContrato);

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $('#modalEditarContratos').modal('show');
  },500);
});

$("#guardarEditarContratos").unbind('click').click(function(){
  var table = $('#tablaListadoContratos').DataTable();
  var idContratosObras = $.map(table.rows('.selected').data(), function (item) {
    return item.IDOBRA_CONTRATO;
  });
  parametros = {
    "idContratosObras": idContratosObras[0],
    "nombre":  $("#nombreEditarContratos").val(),
    "ano":  $("#anoEditarContratos").val(),
    "idContrato":  $("#idContratoEditarContratos").val(),
  }
  $("#modalEditarContratos").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarContratosObras.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoContratos').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Contrato editado correctamente");
          $("#editarContrato").attr("disabled","disabled");
          $("#eliminarContrato").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar contrato, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar contrato, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL EDITAR CONTRATOS OBRA

// FUNCION PARA MODAL ELIMINAR CONTRATOS OBRA
$("#eliminarContrato").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoContratos').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBRE;
  });
  var ano = $.map(table.rows('.selected').data(), function (item) {
    return item.ANO;
  });

  $("#nombreEliminarContratos").html(nombre + " " + ano);

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $('#modalEliminarContratos').modal('show');
  },500);
});

$("#guardarEliminarContratos").unbind('click').click(async function(){
  var table = $('#tablaListadoContratos').DataTable();
  var idContratosObras = $.map(table.rows('.selected').data(), function (item) {
      return item.IDOBRA_CONTRATO;
  });
  parametros = {
    "idContratosObras": idContratosObras[0],
  }
  $("#modalEliminarContratos").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarContratosObras.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoContratos').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Contrato eliminado correctamente");
            $("#editarContrato").attr("disabled","disabled");
            $("#eliminarContrato").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el contrato");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el contrato");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
//  FIN FUNCION PARA MODAL ELIMINAR CONTRATOS OBRA

// EVENTO PARA ABRIR MODAL CARATULA OBRAS A PARTIR DE "ORDEN" DE LA  TABLA
async function caratula_Obras(idObras,tipo,proyInterno){
  var newIdObras = idObras;
  $("#tituloCaratulaObras").empty();
  $("#cuerpoCaratulaObras").empty();
  $("#tituloCaratulaObras").append('<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12"><h5 style="color:gray;"><span class="fas fa-clipboard-list"></span>&nbsp;&nbsp;<span style="font-weight: bold;">Orden de ejecución</span><br></h5></div>');
  $("#cuerpoCaratulaObras").append('<div id="cuerpoCaratulaObrasRowOrden" class="row"></div>');
  $("#cuerpoCaratulaObrasRowOrden").append('<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="margin-bottom: 10pt; margin-top: 10pt;"><span style="font-weight: bold; color:gray; font-size: 1.2em;">Datos de la orden</span></div>');
  $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Folio:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + idObras + "' readonly style='background-color: #f1f1f1 !important;'></div>");
  var parametros = {
    "idObras":idObras,
  }
  await $.ajax({
      url:   'controller/datosCaratulaObras.php',
      type:  'post',
      data: parametros,
      success: function (response3) {
        if(response3.localeCompare("Sin datos") != 0 && response3 != ""){
          var p3 = jQuery.parseJSON(response3);
          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Comuna:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].COMUNA + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Orden de ej.:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].ORDEN + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Agencia:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].AGENCIA + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>F. de importación:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].FCREA + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Central:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].CENTRAL + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Tipo:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + tipo + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Dirección:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].DIRECCION + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Red:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].RED + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Cliente:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].CLIENTE + "' readonly style='background-color: #f1f1f1 !important;'></div>");


          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Contrato:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].CONTRATO + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Fecha de emisión:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].INIOE + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Proyecto mandante:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].PROYECTO + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Fecha de término:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].FINOE + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>P.E. :</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].PEP2 + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Días faltantes:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><span class='form-control' readonly style='background-color: #f1f1f1 !important;'>" + p3.aaData[0].DIAS_FALTANTES + "</span></div>");

          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Gestor cliente:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].GESTOR + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Estado:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].ESTADO + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Gestor externo:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].GESTOR_EXTERNO + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          agn = p3.aaData[0].AGENCIA.split(") ")[1];

          $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Cubicación:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control hoverPDF' style='color: red; background-color: #f1f1f1 !important;' onclick='obras_cubicacion(" + idObras + ",\"" + p3.aaData[0].ORDEN + "\",\"" + p3.aaData[0].CODIGO_CUB + "\",\"" + agn + "\");' value='" + p3.aaData[0].CODIGO_CUB + "' readonly></div>");

          if(p3.aaData[0].TIPO === "Ingenieria" || p3.aaData[0].TIPO === "INGENIERIA" || p3.aaData[0].TIPO === "Ingeniería"){
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 d-none d-md-none d-lg-block'>&nbsp;</div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 d-none d-md-none d-lg-block'>&nbsp;</div>");
          }else{
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Estado permisos:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].ESTADO_PERMISOS + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          }

          if(p3.aaData[0].TIPO === "Ingenieria" || p3.aaData[0].TIPO === "INGENIERIA" || p3.aaData[0].TIPO === "Ingeniería"){
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0; margin-top: 0pt; padding-top: 0pt;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Empresa asignada:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].EMPRESA_ASIGNADA + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0; margin-top: 0pt; padding-top: 0pt;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Proyecto interno:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + proyInterno + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Jefe de proyecto:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].JEFE_PROYECTO + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Proyectista:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].PROYECTISTA + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          }else if(idObras.includes("/")){
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Empresa asignada:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].EMPRESA_ASIGNADA + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Proyecto interno:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + proyInterno + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Jefe de proyecto:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].JEFE_PROYECTO + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Supervisor:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].SUPERVISOR + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Certificador:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].CERTIFICADOR + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Gestor de permisos:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].GESTOR_PERMISOS + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Proyectista:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].PROYECTISTA + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          }else{
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Empresa asignada:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].EMPRESA_ASIGNADA + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Proyecto interno:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + proyInterno + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Jefe de proyecto:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].JEFE_PROYECTO + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Supervisor:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].SUPERVISOR + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Certificador:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].CERTIFICADOR + "' readonly style='background-color: #f1f1f1 !important;'></div>");
            $("#cuerpoCaratulaObrasRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Gestor de permisos:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].GESTOR_PERMISOS + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          }

          $("#cuerpoCaratulaObras").append('<div id="cuerpoCaratulaObrasOT" class="row" style="margin-top: 20pt; margin-bottom: 20pt; margin-bottom: 10pt;"></div>');
          $("#cuerpoCaratulaObrasOT").append('<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;"><span style="font-weight: bold; color:gray; font-size: 1.2em;">Órdenes de trabajo</span></div>');
        }
        detalleCub(idObras,'tablaCaratulaObrasCubicacion');
      }
    });

  // Tabla con OTs
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/40);
  var parametros1 = {
    "idObras":idObras,
  }
  await $('#tablaCaratulaObras').DataTable( {
      ajax: {
          url: "controller/datosCaratulaOtsObras.php",
          type: 'POST',
          data: parametros1
      },
      columns: [
          { data: 'S'},
          { data: 'OT' },
          { data: 'TIPO'},
          { data: 'ESTADO' },
          { data: 'EMPRESA'},
          { data: 'JEFE_BRIGADA' },
          { data: 'FECHA_INI_TERRENO'},
          { data: 'FECHA_FIN_TERRENO' },
          { data: 'AVANCE_EJECUCION'}
      ],
      buttons: [
          {
            extend: 'excel',
            exportOptions: {
              columns: [ 1,2,3,4,5,6,7,8 ]
            },
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          },
          {
            //text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonFiltrosListadoAsignaciones"></span>&nbsp;&nbsp;Filtros',
            text: 'Ver OT',
            action: function( e, dt, node, config ){
              var table = $("#tablaCaratulaObras").DataTable();
              if(table.rows('.selected').data().length > 0){
                $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                $('#modalAlertasSplash').modal('show');
                var datos = table.rows('.selected').data();
                detalle_Ot(datos[0].OT);
              }else{
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar un elemento");
              }
            }
          }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        },
      ],
      "select": {
          style: 'single',
          //selector: 'td:not(:nth-child(5))'
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json){
      }
  });
}
// FIN EVENTO PARA ABRIR MODAL CARATULA OBRAS A PARTIR DE "ORDEN" DE LA  TABLA

$('#tablaCaratulaObras tbody').on( 'click', 'tr', function () {
  setTimeout(async function(){
    var table = $('#tablaCaratulaObras').DataTable();
    var data = table.rows('.selected').data();
    if(data.length <= 0){
      $("#asignarFecTerOtCaratulaObras").attr("disabled","disabled");
      $("#asignarBrigadaOtCaratulaObras").attr("disabled","disabled");
      $("#duplicarOtCaratulaObras").attr("disabled","disabled");
      $("#elimnarOtCaratulaObras").attr("disabled","disabled");
      $("#pedirMaterialCaratulaObras").attr("disabled","disabled");
    }
    else{
      $("#asignarFecTerOtCaratulaObras").removeAttr("disabled");
      $("#asignarBrigadaOtCaratulaObras").removeAttr("disabled");
      $("#duplicarOtCaratulaObras").removeAttr("disabled");
      $("#elimnarOtCaratulaObras").removeAttr("disabled");
      $("#pedirMaterialCaratulaObras").removeAttr("disabled");
    }
  },200);
});

async function cargarComprasFinanzasEstructura() {
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  await $('#tablaMantenedorFinancieras').DataTable({
    ajax: {
      url: "controller/datosComprasFinanzasEstructura.php",
      type: 'POST',
      data: {}
    },
    columns: [
      { data: 'S'},
      { data: 'IDCOMPRAS_FINANZAS_ESTRUCTURA', className: "centerDataTable"},
      { data: 'NOMBREA' },
      { data: 'NOMBREB' },
      { data: 'NOMBREC' },
      { data: 'TIPOC' },
    ],
    buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        },
        {
          text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
          action: function ( e, dt, node, config ) {
            /*var table = $('#tablaIncidencia').DataTable();
            $("#cambiarEstadoIncidencia").attr("disabled","disabled");
            $("#derivarIncidencia").attr("disabled","disabled");
            $("#confirmarIncidencia").attr("disabled","disabled");
            $("#reactivarIncidencia").attr("disabled","disabled");
            $("#historialIncidencia").attr("disabled","disabled");
            table.rows().deselect();*/
          }
        }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      }
    ],
    "select": {
      style: 'single',
      selector: 'td:not(:nth-child(20))'
    },
    fixedColumns:   {
      leftColumns: 2
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "order": [[ 1, "desc" ]],
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json) {
      var table = $('#tablaMantenedorFinancieras').DataTable();

      /*var estadoInc = '';
      estadoInc += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(2).data().unique().length; i++){
        if(table.column(2).data().unique()[i] !== null){
          estadoInc += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
        }
      }
      $("#estadoTablaIncidencias").html(estadoInc);*/

      $('#contenido').show();
      $('#menu-lateral').show();
      $('#footer').parent().show();
$('#footer').show();

      esconderMenu();
      setTimeout(async function(){
        $('#tablaMantenedorFinancieras').DataTable().columns.adjust();
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
        menuElegant();
      },1500);
    }
  });

  await $.ajax({
    url:   'controller/datosAccionesVisibles.php',
    type:  'post',
    data: {
      "path": window.location.href.split('#/')[1]
    },
    success: function (response) {
      var p = jQuery.parseJSON(response);
      $("#accionesMantenedorFinancieras").html('');
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++) {
          if(p.aaData[i].VISIBLE == 1){
            if(p.aaData[i].ENABLE == 1){
              $("#accionesMantenedorFinancieras").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
            else{
              $("#accionesMantenedorFinancieras").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button disabled class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
          }
        }
      }
    }
  });

  setTimeout(function(){
    var js = document.createElement('script');
    js.src = 'view/js/funciones.js?idLoad=205';
    document.getElementsByTagName('head')[0].appendChild(js);
  },500);
}

$("#agregarMantenedorFinanciero").unbind("click").click(async function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url: "controller/datosComprasFinanzasDim1.php",
    type: 'POST',
    data: {
      "clas": $("#selectComprasFinanzasClasif").val()
    },
    // dataType: 'json',
    success:  function (response) {
      var p = jQuery.parseJSON(response);
      var options = '';
      options += '<option selected value="No Aplica">No Aplica</option>';
      for(var i = 0; i < p.aaData.length; i++){
        var id = p.aaData[i].IDCOMPRAS_FINANZAS_DIM1;
        var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasFinanzasDim1").html(options);
    }
  });

  await $.ajax({
    url: "controller/datosComprasFinanzasDim2.php",
    type: 'POST',
    data: {
      "clas": $("#selectComprasFinanzasClasif").val()
    },
    // dataType: 'json',
    success:  function (response) {
      var p = jQuery.parseJSON(response);
      var options = '';
      options += '<option selected value="No Aplica">No Aplica</option>';
      for(var i = 0; i < p.aaData.length; i++){
        var id = p.aaData[i].IDCOMPRAS_FINANZAS_DIM2;
        var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasFinanzasDim2").html(options);
    }
  });

  await $.ajax({
    url: "controller/datosComprasFinanzasDim3.php",
    type: 'POST',
    data: {
      "clas": $("#selectComprasFinanzasClasif").val()
    },
    // dataType: 'json',
    success:  function (response) {
      var p = jQuery.parseJSON(response);
      var options = '';
      options += '<option selected value="No Aplica">No Aplica</option>';
      for(var i = 0; i < p.aaData.length; i++){
        var id = p.aaData[i].IDCOMPRAS_FINANZAS_DIM3;
        var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasFinanzasDim3").html(options);
    }
  });

  var h = $(window).height() - 200;
  $("#bodyAgregarMantFinanciera").css("height",h);
  $("#modalAgregarMantFinanciera").modal('show');
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },500);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#selectComprasFinanzasDim1').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasFinanzasDim2').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasFinanzasDim3').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasFinanzasClasif').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$('#selectComprasFinanzasDim1').change(async function (e) {
  /*e.preventDefault();
  e.stopImmediatePropagation();*/
  if($('select[id="selectComprasFinanzasDim1"] option:selected').text() === "No Aplica") {
    $("#codigoComprasFinanzasDim1").removeAttr("disabled");
    $("#nombreComprasFinanzasDim1").removeAttr("disabled");
  } else {
    $("#codigoComprasFinanzasDim1").attr("disabled","disabled");
    $("#nombreComprasFinanzasDim1").attr("disabled","disabled");
  }
});

$('#selectComprasFinanzasDim2').change(async function (e) {
  /*e.preventDefault();
  e.stopImmediatePropagation();*/
  if($('select[id="selectComprasFinanzasDim2"] option:selected').text() === "No Aplica") {
    $("#codigoComprasFinanzasDim2").removeAttr("disabled");
    $("#nombreComprasFinanzasDim2").removeAttr("disabled");
  } else {
    $("#codigoComprasFinanzasDim2").attr("disabled","disabled");
    $("#nombreComprasFinanzasDim2").attr("disabled","disabled");
  }
});

$('#selectComprasFinanzasDim3').change(async function (e) {
  /*e.preventDefault();
  e.stopImmediatePropagation();*/
  if($('select[id="selectComprasFinanzasDim3"] option:selected').text() === "No Aplica") {
    $("#codigoComprasFinanzasDim3").removeAttr("disabled");
    $("#nombreComprasFinanzasDim3").removeAttr("disabled");
  } else {
    $("#codigoComprasFinanzasDim3").attr("disabled","disabled");
    $("#nombreComprasFinanzasDim3").attr("disabled","disabled");
  }
});

$("#editarMantenedorFinanciero").unbind("click").click(function() {
  $("#modalEditarMantFinanciera").modal('show');
});

$("#eliminarMantenedorFinanciero").unbind("click").click(function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorFinancieras').DataTable();
  var datos = table.rows('.selected').data();

  $("#tituloActivarZonaOrden").html('Desactivar Zona');
  $("#detalleEliminarMantFinanciera").html('¿Está seguro que desea eliminar la estructura seleccionada con folio: ' + datos[0].IDCOMPRAS_FINANZAS_ESTRUCTURA + '?');
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEliminarMantFinanciera").modal('show');
  },500);
});

$('#guardarAgregarMantFinanciera').unbind("click").click(async function() {
  $('#modalAgregarMantFinanciera').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var alreadyDim1 = false;
  var alreadyDim2 = false;
  var alreadyDim3 = false;

  var directInsertion = true;

  /* BEGIN - VALIDACIONES */
  if($('select[id="selectComprasFinanzasDim1"] option:selected').text() === "No Aplica") {
    directInsertion = false;
    await $.ajax({
      url: "controller/validaCodigoEnComprasFinanzasDims.php",
      type: 'POST',
      dataType: 'json',
      data: {
        dim: '1',
        codigo: $('#codigoComprasFinanzasDim1').val(),
      },
      success: (response) => (alreadyDim1 = response.aaData ? true: false)
    });
  }

  if($('select[id="selectComprasFinanzasDim2"] option:selected').text() === "No Aplica") {
    directInsertion = false;
    await $.ajax({
      url: "controller/validaCodigoEnComprasFinanzasDims.php",
      type: 'POST',
      dataType: 'json',
      data: {
        dim: '2',
        codigo: $('#codigoComprasFinanzasDim2').val(),
      },
      success: (response) => (alreadyDim1 = response.aaData ? true: false)
    });
  }

  if($('select[id="selectComprasFinanzasDim3"] option:selected').text() === "No Aplica") {
    directInsertion = false;
    await $.ajax({
      url: "controller/validaCodigoEnComprasFinanzasDims.php",
      type: 'POST',
      dataType: 'json',
      data: {
        dim: '3',
        codigo: $('#codigoComprasFinanzasDim3').val(),
      },
      success: (response) => (alreadyDim1 = response.aaData ? true: false)
    });
  }
  /* END - VALIDACIONES */

  if (alreadyDim1 || alreadyDim2 || alreadyDim3) {

    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast(
      `<img src='view/img/error.gif' class='splash_load'><br/>${
        alreadyDim1
          ? 'El código de la Dimension 1 ya existe'
          : alreadyDim2
            ? 'El código de la Dimension 2 ya existe'
            : alreadyDim3
              ? 'El código de la Dimension 3 ya existe'
              : 'Código de una dimensión enviada ya existe'
      }`
    );
    $('#modalAgregarMantFinanciera').modal('show');
    // cleanMantFinanzas();
  } else {
    /* BEGIN - INSERCION */
    if (directInsertion) {
      await $.ajax({
        url: "controller/validaCodigoEnComprasFinanzasDims.php",
        type: 'POST',
        dataType: 'json',
        data: {
          dim: 'all',
          idDim1: $('select[id="selectComprasFinanzasDim1"] option:selected').val(),
          idDim2: $('select[id="selectComprasFinanzasDim2"] option:selected').val(),
          idDim3: $('select[id="selectComprasFinanzasDim3"] option:selected').val(),
          clas: $("#selectComprasFinanzasClasif").val()
        },
        success: async (response) => {
          if (response.aaData) {
            alertasToast(`<img src='view/img/info.png' class='splash_load'><br/>Estructura ya existente`);
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $('#modalAgregarMantFinanciera').modal('show');
            },500);
            // cleanMantFinanzas();
          } else {
            await $.ajax({
              url: "controller/ingresarMantFinanzas.php",
              type: 'POST',
              dataType: 'json',
              data: {
                dim: 'all',
                idDim1: $('select[id="selectComprasFinanzasDim1"] option:selected').val(),
                idDim2: $('select[id="selectComprasFinanzasDim2"] option:selected').val(),
                idDim3: $('select[id="selectComprasFinanzasDim3"] option:selected').val(),
                clas: $("#selectComprasFinanzasClasif").val()
              },
              success: async (response) => {
                idComprasFinanzasEstructura = response.aaData['IDCOMPRAS_FINANZAS_ESTRUCTURA'];

                alertasToast(`<img src='view/img/check.gif' class='splash_load'><br/>Estructura agregada correctamente`);
                cleanMantFinanzas();

                await cargarComprasFinanzasEstructuraReload();

                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            });

          }
        }
      });
    } else {
      var idComprasFinanzasDim1 = 0;
      var idComprasFinanzasDim2 = 0;
      var idComprasFinanzasDim3 = 0;

      if($('select[id="selectComprasFinanzasDim1"] option:selected').text() === "No Aplica") {
        await $.ajax({
          url: "controller/ingresarMantFinanzas.php",
          type: 'POST',
          dataType: 'json',
          data: {
            dim: '1',
            codigo: $('#codigoComprasFinanzasDim2').val(),
            nombre: $('#nombreComprasFinanzasDim2').val(),
            tipo: $("#selectComprasFinanzasClasif").val(),
          },
          success: (response) => {
            idComprasFinanzasDim1 = response.aaData['IDCOMPRAS_FINANZAS_DIM1'];
          }
        });
      } else {
        idComprasFinanzasDim1 = $('select[id="selectComprasFinanzasDim1"] option:selected').val();
      }

      if($('select[id="selectComprasFinanzasDim2"] option:selected').text() === "No Aplica") {
        await $.ajax({
          url: "controller/ingresarMantFinanzas.php",
          type: 'POST',
          dataType: 'json',
          data: {
            dim: '2',
            codigo: $('#codigoComprasFinanzasDim2').val(),
            nombre: $('#nombreComprasFinanzasDim2').val(),
            tipo: $("#selectComprasFinanzasClasif").val()
          },
          success: (response) => {
            idComprasFinanzasDim2 = response.aaData['IDCOMPRAS_FINANZAS_DIM2'];
          }
        });
      } else {
        idComprasFinanzasDim2 = $('select[id="selectComprasFinanzasDim2"] option:selected').val();
      }

      if($('select[id="selectComprasFinanzasDim3"] option:selected').text() === "No Aplica") {
        await $.ajax({
          url: "controller/ingresarMantFinanzas.php",
          type: 'POST',
          dataType: 'json',
          data: {
            dim: '3',
            codigo: $('#codigoComprasFinanzasDim3').val(),
            nombre: $('#nombreComprasFinanzasDim3').val(),
            tipo: $("#selectComprasFinanzasClasif").val()
          },
          success: (response) => {
            idComprasFinanzasDim3 = response.aaData['IDCOMPRAS_FINANZAS_DIM3'];
          }
        });
      } else {
        idComprasFinanzasDim3 = $('select[id="selectComprasFinanzasDim3"] option:selected').val();
      }

      if (
        (!isNaN(idComprasFinanzasDim1) && idComprasFinanzasDim1 > 0) &&
        (!isNaN(idComprasFinanzasDim2) && idComprasFinanzasDim2 > 0) &&
        (!isNaN(idComprasFinanzasDim3) && idComprasFinanzasDim3 > 0)
      ) {
        await $.ajax({
          url: "controller/ingresarMantFinanzas.php",
          type: 'POST',
          dataType: 'json',
          data: {
            dim: 'all',
            idDim1: idComprasFinanzasDim1,
            idDim2: idComprasFinanzasDim2,
            idDim3: idComprasFinanzasDim3
          },
          success: async (response) => {
            idComprasFinanzasEstructura = response.aaData['IDCOMPRAS_FINANZAS_ESTRUCTURA'];

            alertasToast(`<img src='view/img/check.gif' class='splash_load'><br/>Estructura agregada correctamente`);
            cleanMantFinanzas();

            await cargarComprasFinanzasEstructuraReload();

            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        });
      } else {
        alertasToast(`<img src='view/img/error.gif' class='splash_load'><br/>Error al realizar la operación, si el problema persiste favor comuniquese con soporte`);
        cleanMantFinanzas();
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }

    }
    /* END - INSERCION */

  }

});

function cleanMantFinanzas() {
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $('input:text').val('');
    $("#codigoComprasFinanzasDim1").removeAttr("disabled");
    $("#nombreComprasFinanzasDim1").removeAttr("disabled");
    $("#codigoComprasFinanzasDim2").removeAttr("disabled");
    $("#nombreComprasFinanzasDim2").removeAttr("disabled");
    $("#codigoComprasFinanzasDim3").removeAttr("disabled");
    $("#nombreComprasFinanzasDim3").removeAttr("disabled");
  },500);
}

$('#guardarEliminarMantFinanciera').unbind("click").click(async function() {
  $("#modalEliminarMantFinanciera").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorFinancieras').DataTable();
  var datos = table.rows('.selected').data();

  await $.ajax({
    url:   'controller/eliminarComprasFinanzasEstructura.php',
    type:  'post',
    data:  {
      idFinanzasEstructura: datos[0].IDCOMPRAS_FINANZAS_ESTRUCTURA
    },
    success: async  function (response) {
      alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>¡Estructura eliminada correctamente!");
      // $('#modalAlertasSplash').modal('hide');
      await cargarComprasFinanzasEstructuraReload();

      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
      },500);
    }
  });
});

async function cargarComprasGestion() {
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  await $('#tablaMantenedorGestion').DataTable({
    ajax: {
      url: "controller/datosComprasGestion.php",
      type: 'POST',
      data: {}
    },
    columns: [
      { data: 'S'},
      { data: 'IDCOMPRAS_GESTION_DIM3', className: "centerDataTable"},
      { data: 'DIM1' },
      { data: 'DIM2' },
      { data: 'DIM3' },
      { data: 'TIPO' },
    ],
    buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        },
        {
          text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
          action: function ( e, dt, node, config ) {
            var table = $('#tablaMantenedorGestion').DataTable();
            $("#eliminarMantenedorGestion").attr("disabled","disabled");
            table.rows().deselect();
          }
        },
        {
          text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonFiltrosComprasGestion"></span>&nbsp;&nbsp;Filtros',
          action: function(){
            if($("#filtrosComprasGestion").height() > 100){
              $("#filtrosComprasGestion").css("height","0");
              $("#filtrosComprasGestion").fadeOut();
              $("#spanButtonFiltrosComprasGestion").removeClass("fas fa-arrow-alt-circle-up");
              $("#spanButtonFiltrosComprasGestion").addClass("fas fa-arrow-alt-circle-down");
            }
            else{
              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#filtrosComprasGestion").css("height","170pt");
              }
              else{
                $("#filtrosComprasGestion").css("height","690pt");
              }
              $("#filtrosComprasGestion").fadeIn();
              $("#spanButtonFiltrosComprasGestion").removeClass("fas fa-arrow-alt-circle-down");
              $("#spanButtonFiltrosComprasGestion").addClass("fas fa-arrow-alt-circle-up");
            }
          }
        }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      },
      {
        "width": "10px",
        "targets": 1
      }
    ],
    "select": {
      style: 'single',
      selector: 'td:not(:nth-child(20))'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "order": [[ 1, "desc" ]],
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json) {
      $("#filtrosComprasGestion").css("height","0");
      $("#filtrosComprasGestion").fadeOut();

      var table = $('#tablaMantenedorGestion').DataTable();

      var familiaGest = '';
      familiaGest += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(2).data().unique().length; i++){
        if(table.column(2).data().unique()[i] !== null){
          familiaGest += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
        }
      }
      $("#familiaComprasGestion").html(familiaGest);

      var segmentoGest = '';
      segmentoGest += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(3).data().unique().length; i++){
        if(table.column(3).data().unique()[i] !== null){
          segmentoGest += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
        }
      }
      $("#segmentoComprasGestion").html(segmentoGest);

      var claveGest = '';
      claveGest += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(4).data().unique().length; i++){
        if(table.column(4).data().unique()[i] !== null){
          claveGest += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
        }
      }
      $("#claveComprasGestion").html(claveGest);

      var tipoGest = '';
      tipoGest += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(5).data().unique().length; i++){
        if(table.column(5).data().unique()[i] !== null){
          tipoGest += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
        }
      }
      $("#tipoComprasGestion").html(tipoGest);

      if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        $('#familiaComprasGestion').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $('#segmentoComprasGestion').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $('#claveComprasGestion').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $('#tipoComprasGestion').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
      }

      $('#contenido').show();
      $('#menu-lateral').show();
      $('#footer').parent().show();
      $('#footer').show();

      esconderMenu();
      menuElegant();
      setTimeout(async function(){
        setTimeout(function(){
          $("#spanButtonFiltrosComprasGestion").click();
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            setTimeout(function(){
              $('#tablaMantenedorGestion').DataTable().columns.adjust();
            },500);
          },200);
        },100);
      },1500);
    }
  });

  await $.ajax({
    url:   'controller/datosAccionesVisibles.php',
    type:  'post',
    data: {
      "path": window.location.href.split('#/')[1]
    },
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++) {
          if(p.aaData[i].VISIBLE == 1){
            if(p.aaData[i].ENABLE == 1){
              $("#accionesMantenedorGestion").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
            else{
              $("#accionesMantenedorGestion").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button disabled class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
          }
        }
      }
    }
  });

  setTimeout(function(){
    var js = document.createElement('script');
    js.src = 'view/js/funciones.js?idLoad=205';
    document.getElementsByTagName('head')[0].appendChild(js);
  },500);
}

$("#agregarMantenedorGestion").unbind("click").click(async function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url: "controller/datosComprasGestionDim1.php",
    type: 'POST',
    data: {
      "clasif": $("#selectComprasGestionClasif").val()
    },
    // dataType: 'json',
    success:  async function (response) {
      var p = jQuery.parseJSON(response);
      var options = '';
      options += '<option selected value="No Aplica">No Aplica</option>';
      for(var i = 0; i < p.aaData.length; i++){
        var id = p.aaData[i].IDCOMPRAS_GESTION_DIM1;
        var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasGestionDim1").html(options);
      $("#selectComprasGestionDim2").html('<option selected value="No Aplica">No Aplica</option>');
      $("#selectComprasGestionDim3").html('<option selected value="No Aplica">No Aplica</option>');

      var h = $(window).height() - 200;
      $("#bodyAgregarMantGestion").css("height",h);
      $("#modalAgregarMantGestion").modal('show');
      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
      },500);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#selectComprasGestionDim1').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasGestionDim2').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasGestionDim3').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasGestionClasif').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$('#selectComprasGestionDim1').change(async function (e) {
  e.preventDefault();
  e.stopImmediatePropagation();
  if($('select[id="selectComprasGestionDim1"] option:selected').text() === "No Aplica") {
    $("#codigoComprasGestionDim1").removeAttr("disabled");
    $("#nombreComprasGestionDim1").removeAttr("disabled");

    $("#selectComprasGestionDim2").html('<option selected value="No Aplica">No Aplica</option>');
    $("#selectComprasGestionDim3").html('<option selected value="No Aplica">No Aplica</option>');

    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $('#selectComprasGestionDim1').select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $('#selectComprasGestionDim2').select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $('#selectComprasGestionDim3').select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  } else {
    $("#codigoComprasGestionDim1").attr("disabled","disabled");
    $("#nombreComprasGestionDim1").attr("disabled","disabled");

    $("#modalAgregarMantGestion").modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    await $.ajax({
      url: "controller/datosComprasGestionDim2.php",
      type: 'POST',
      // dataType: 'json',
      data: {
        idComprasGestionDim1: $('select[id="selectComprasGestionDim1"] option:selected').val(),
      },
      success: async function (response) {
        var p = jQuery.parseJSON(response);
        var options = '';
        options += '<option selected value="No Aplica">No Aplica</option>';
        for(var i = 0; i < p.aaData.length; i++){
          var id = p.aaData[i].IDCOMPRAS_GESTION_DIM2;
          var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
          options += `<option value="${id}">${label}</option>`;
        }
        $("#selectComprasGestionDim2").html(options);

        await $.ajax({
          url: "controller/datosComprasGestionDim3.php",
          type: 'POST',
          // dataType: 'json',
          data: {
            idComprasGestionDim2: $('select[id="selectComprasGestionDim2"] option:selected').val(),
          },
          success: async function (response) {
            var p = jQuery.parseJSON(response);
            var options = '';
            options += '<option selected value="No Aplica">No Aplica</option>';
            for(var i = 0; i < p.aaData.length; i++){
              var id = p.aaData[i].IDCOMPRAS_GESTION_DIM3;
              var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
              options += `<option value="${id}">${label}</option>`;
            }
            $("#selectComprasGestionDim3").html(options);

            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              $('#selectComprasGestionDim1').select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $('#selectComprasGestionDim2').select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $('#selectComprasGestionDim3').select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
            }
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalAgregarMantGestion").modal('show');
            },500);
          }
        });
      }
    });
  }
});

$('#selectComprasGestionDim2').change(async function (e) {
  e.preventDefault();
  e.stopImmediatePropagation();
  if($('select[id="selectComprasGestionDim2"] option:selected').text() === "No Aplica") {
    $("#codigoComprasGestionDim2").removeAttr("disabled");
    $("#nombreComprasGestionDim2").removeAttr("disabled");

    $("#selectComprasGestionDim3").html('<option selected value="No Aplica">No Aplica</option>');
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $('#selectComprasGestionDim1').select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $('#selectComprasGestionDim2').select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $('#selectComprasGestionDim3').select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  } else {
    $("#codigoComprasGestionDim2").attr("disabled","disabled");
    $("#nombreComprasGestionDim2").attr("disabled","disabled");

    $("#modalAgregarMantGestion").modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    await $.ajax({
      url: "controller/datosComprasGestionDim3.php",
      type: 'POST',
      // dataType: 'json',
      data: {
        idComprasGestionDim2: $('select[id="selectComprasGestionDim2"] option:selected').val(),
      },
      success: async function (response) {
        var p = jQuery.parseJSON(response);
        var options = '';
        options += '<option selected value="No Aplica">No Aplica</option>';
        for(var i = 0; i < p.aaData.length; i++){
          var id = p.aaData[i].IDCOMPRAS_GESTION_DIM3;
          var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
          options += `<option value="${id}">${label}</option>`;
        }
        $("#selectComprasGestionDim3").html(options);

        if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $('#selectComprasGestionDim1').select2('destroy').select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
          $('#selectComprasGestionDim2').select2('destroy').select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
          $('#selectComprasGestionDim3').select2('destroy').select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalAgregarMantGestion").modal('show');
        },500);
      }
    });
  }
});

$('#selectComprasGestionDim3').change(async function (e) {
  /*e.preventDefault();
  e.stopImmediatePropagation();*/
  if($('select[id="selectComprasGestionDim3"] option:selected').text() === "No Aplica") {
    $("#codigoComprasGestionDim3").removeAttr("disabled");
    $("#nombreComprasGestionDim3").removeAttr("disabled");
  } else {
    $("#codigoComprasGestionDim3").attr("disabled","disabled");
    $("#nombreComprasGestionDim3").attr("disabled","disabled");
  }
});

$("#editarMantenedorGestion").unbind("click").click(function() {
  $("#modalEditarMantGestion").modal('show');
});

$("#eliminarMantenedorGestion").unbind("click").click(function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorGestion').DataTable();
  var datos = table.rows('.selected').data();

  $("#tituloActivarZonaOrden").html('Desactivar Zona');
  $("#detalleEliminarMantGestion").html('¿Está seguro que desea eliminar la dimension seleccionada con folio: ' + datos[0].IDCOMPRAS_GESTION_DIM3 + '?');

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEliminarMantGestion").modal("show");
  },500);
});

$('#guardarAgregarMantGestion').unbind("click").click(async function() {
  $('#modalAgregarMantGestion').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var alreadyDim1 = false;
  var alreadyDim2 = false;
  var alreadyDim3 = false;

  /* BEGIN - VALIDACIONES */
  if($('select[id="selectComprasGestionDim1"] option:selected').text() === "No Aplica") {
    await $.ajax({
      url: "controller/validaCodigoEnComprasGestionDims.php",
      type: 'POST',
      dataType: 'json',
      data: {
        dim: '1',
        codigo: $('#codigoComprasGestionDim1').val(),
      },
      success: (response) => (alreadyDim1 = response.aaData ? true: false)
    });
  }
  else {
    if($('select[id="selectComprasGestionDim2"] option:selected').text() === "No Aplica") {
      await $.ajax({
        url: "controller/validaCodigoEnComprasGestionDims.php",
        type: 'POST',
        dataType: 'json',
        data: {
          dim: '2',
          idComprasGestionDim1: $('select[id="selectComprasGestionDim1"] option:selected').val(),
          codigo: $('#codigoComprasGestionDim2').val(),
        },
        success: (response) => (alreadyDim2 = response.aaData ? true : false)
      });
    }
    else {
      if($('select[id="selectComprasGestionDim3"] option:selected').text() === "No Aplica") {
        await $.ajax({
          url: "controller/validaCodigoEnComprasGestionDims.php",
          type: 'POST',
          dataType: 'json',
          data: {
            dim: '3',
            idComprasGestionDim2: $('select[id="selectComprasGestionDim2"] option:selected').val(),
            codigo: $('#codigoComprasGestionDim3').val(),
          },
          success: (response) => (alreadyDim3 = response.aaData ? true : false)
        });
      }
      else{
        alreadyDim3 = true;
        alreadyDim2 = true;
        alreadyDim1 = true;
      }
    }
  }
  /* END - VALIDACIONES */

  if (alreadyDim1 && alreadyDim2 && alreadyDim3) {
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>La estructura ingresada ya existe en la base de datos");
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
    },500);
  }
  else if (alreadyDim1 || alreadyDim2 || alreadyDim3) {
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast(
      `<img src='view/img/error.gif' class='splash_load'><br/>${
        alreadyDim1
          ? 'El código de la Dimension 1 ya existe'
          : alreadyDim2
            ? 'El código de la Dimension 2 ya existe'
            : alreadyDim3
              ? 'El código de la Dimension 3 ya existe'
              : 'Código de una dimensión enviada ya existe'
      }`
    );
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
    },500);
  }
  else {
    /* BEGIN - INSERCION */
    if($('select[id="selectComprasGestionDim1"] option:selected').text() === "No Aplica") {
      await $.ajax({
        url: "controller/ingresarMantGestion.php",
        type: 'POST',
        dataType: 'json',
        data: {
          dim: '1',
          codigo: $('#codigoComprasGestionDim1').val(),
          nombre: $('#nombreComprasGestionDim1').val(),
          tipo: $('#selectComprasGestionClasif').val()
        },
        success: async (response1) => {
          var p1 = response1.aaData;
          await $.ajax({
            url: "controller/ingresarMantGestion.php",
            type: 'POST',
            dataType: 'json',
            data: {
              dim: '2',
              idComprasGestionDim1: p1['IDCOMPRAS_GESTION_DIM1'],
              codigo: $('#codigoComprasGestionDim2').val(),
              nombre: $('#nombreComprasGestionDim2').val(),
              tipo: $('#selectComprasGestionClasif').val()
            },
            success: async (response2) => {
              var p2 = response2.aaData;

              await $.ajax({
                url: "controller/ingresarMantGestion.php",
                type: 'POST',
                dataType: 'json',
                data: {
                  dim: '3',
                  idComprasGestionDim2: p2['IDCOMPRAS_GESTION_DIM2'],
                  codigo: $('#codigoComprasGestionDim3').val(),
                  nombre: $('#nombreComprasGestionDim3').val(),
                  tipo: $('#selectComprasGestionClasif').val()
                },
                success: (response3) => {
                  var p3 = response3.aaData;
                  ingresaNuevaComprasGestion(p3['IDCOMPRAS_GESTION_DIM3'], $('#codigoComprasGestionDim3').val() + ' - ' + $('#nombreComprasGestionDim3').val(), $('#codigoComprasGestionDim2').val() + ' - ' + $('#nombreComprasGestionDim2').val(), $('#codigoComprasGestionDim1').val() + ' - ' + $('#nombreComprasGestionDim1').val());
                }
              });

            }
          });

        }
      });
    }
    else {

      if($('select[id="selectComprasGestionDim2"] option:selected').text() === "No Aplica") {
        await $.ajax({
          url: "controller/ingresarMantGestion.php",
          type: 'POST',
          dataType: 'json',
          data: {
            dim: '2',
            idComprasGestionDim1: $('select[id="selectComprasGestionDim1"] option:selected').val(),
            codigo: $('#codigoComprasGestionDim2').val(),
            nombre: $('#nombreComprasGestionDim2').val(),
            tipo: $('#selectComprasGestionClasif').val()
          },
          success: async (response2) => {
            var p2 = response2.aaData;

            await $.ajax({
              url: "controller/ingresarMantGestion.php",
              type: 'POST',
              dataType: 'json',
              data: {
                dim: '3',
                idComprasGestionDim2: p2['IDCOMPRAS_GESTION_DIM2'],
                codigo: $('#codigoComprasGestionDim3').val(),
                nombre: $('#nombreComprasGestionDim3').val(),
                tipo: $('#selectComprasGestionClasif').val()
              },
              success: (response3) => {
                var p3 = response3.aaData;
                ingresaNuevaComprasGestion(p3['IDCOMPRAS_GESTION_DIM3'], $('#codigoComprasGestionDim3').val() + ' - ' + $('#nombreComprasGestionDim3').val(), $('#codigoComprasGestionDim2').val() + ' - ' + $('#nombreComprasGestionDim2').val(), $('select[id="selectComprasGestionDim1"] option:selected').text());
              }
            });

          }
        });
      } else {

        if($('select[id="selectComprasGestionDim3"] option:selected').text() === "No Aplica") {
          await $.ajax({
            url: "controller/ingresarMantGestion.php",
            type: 'POST',
            dataType: 'json',
            data: {
              dim: '3',
              idComprasGestionDim2: $('select[id="selectComprasGestionDim2"] option:selected').val(),
              codigo: $('#codigoComprasGestionDim3').val(),
              nombre: $('#nombreComprasGestionDim3').val(),
              tipo: $('#selectComprasGestionClasif').val()
            },
            success: (response3) => {
              var p3 = response3.aaData;
              ingresaNuevaComprasGestion(p3['IDCOMPRAS_GESTION_DIM3'], $('#codigoComprasGestionDim3').val() + ' - ' + $('#nombreComprasGestionDim3').val(), $('select[id="selectComprasGestionDim2"] option:selected').text(), $('select[id="selectComprasGestionDim1"] option:selected').text());
            }
          });
        }

      }

    }
    /* END - INSERCION */
  }
  setTimeout(function(){
    $('#tablaMantenedorGestion').DataTable().columns.adjust();
  },1000);
});

function ingresaNuevaComprasGestion(idComprasDim3, dim3, dim2, dim1) {
  var table = $('#tablaMantenedorGestion').DataTable();
  table.rows.add([{
    'S': ' ',
    'IDCOMPRAS_GESTION_DIM3': idComprasDim3,
    'DIM1': dim1,
    'DIM2': dim2,
    'DIM3': dim3,
    'TIPO': $('#selectComprasGestionClasif').val()
  }]).draw();
  $('#modalAlertasSplash').modal('hide');
  $('input:text').val('');
  $("#codigoComprasGestionDim3").removeAttr("disabled");
  $("#nombreComprasGestionDim3").removeAttr("disabled");
  $("#codigoComprasGestionDim2").removeAttr("disabled");
  $("#nombreComprasGestionDim2").removeAttr("disabled");
  $("#codigoComprasGestionDim1").removeAttr("disabled");
  $("#nombreComprasGestionDim1").removeAttr("disabled");
  setTimeout(function(){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Dimensión ingresada correctamente");
    $('#modalAlertasSplash').modal('hide');
  },500);
}

$('#guardarEliminarMantGestion').unbind("click").click(async function() {
  $('#modalAgregarMantGestion').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEliminarMantGestion").modal("hide");
  var table = $('#tablaMantenedorGestion').DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    "idDim3": datos[0].IDCOMPRAS_GESTION_DIM3
  }

  await $.ajax({
    url:   'controller/eliminarDim3GestionCompras.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorGestion').DataTable();
            table.rows('.selected').remove().draw();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Dimensión eliminada correctamente");
            $('#modalAlertasSplash').modal('hide');
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No es posible eliminar la dimensión dado que existen articulos o servicios asociados");
            $('#modalAlertasSplash').modal('hide');
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No es posible eliminar la dimensión dado que existen articulos o servicios asociados");
          $('#modalAlertasSplash').modal('hide');
      }
    }
  });
});

async function cargarComprasMateriales() {
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  await $('#tablaMantenedorMateriales').DataTable({
    ajax: {
      url: "controller/datosComprasMateriales.php",
      type: 'POST',
      data: {}
    },
    columns: [
      { data: 'S'},
      { data: 'IDCOMPRAS_MATERIAL', className: "centerDataTable"},
      { data: 'CODIGO' },
      { data: 'NOMBRE' },
      { data: 'MARCA' },
      { data: 'MODELO' },
      { data: 'COLOR' },
      { data: 'TIPO' },
      { data: 'MATERIAL_FAB' },
      { data: 'TALLA' },
      { data: 'ENVASE' },
      { data: 'PRECIO_MIN' },
      { data: 'PRECIO_MAX' },
      { data: 'VOLTAJE' },
      { data: 'POTENCIA' },
      { data: 'CALIBRE' },
      { data: 'ANCHO' },
      { data: 'ALTO' },
      { data: 'LARGO' },
    ],
    buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        },
        {
          text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
          action: function ( e, dt, node, config ) {
            var table = $('#tablaMantenedorMateriales').DataTable();
            $("#editarMantenedorMaterial").attr("disabled","disabled");
            $("#eliminarMantenedorMaterial").attr("disabled","disabled");
            $("#masivoMantenedorMaterial").attr("disabled","disabled");
            table.rows().deselect();
          }
        },
        {
          text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonfiltrosComprasMaterial"></span>&nbsp;&nbsp;Filtros',
          action: function(){
            if($("#filtrosComprasMaterial").height() > 60){
              $("#filtrosComprasMaterial").css("height","0");
              $("#filtrosComprasMaterial").fadeOut();
              $("#spanButtonfiltrosComprasMaterial").removeClass("fas fa-arrow-alt-circle-up");
              $("#spanButtonfiltrosComprasMaterial").addClass("fas fa-arrow-alt-circle-down");
            }
            else{
              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#filtrosComprasMaterial").css("height","100pt");
              }
              else{
                $("#filtrosComprasMaterial").css("height","210pt");
              }
              $("#filtrosComprasMaterial").fadeIn();
              $("#spanButtonfiltrosComprasMaterial").removeClass("fas fa-arrow-alt-circle-down");
              $("#spanButtonfiltrosComprasMaterial").addClass("fas fa-arrow-alt-circle-up");
            }
          }
        }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      }
    ],
    "select": {
      style: 'single',
      // selector: 'td:not(:nth-child(20))'
    },
    // fixedColumns:   {
    //   leftColumns: 2
    // },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "order": [[ 1, "desc" ]],
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json) {
      var table = $('#tablaMantenedorMateriales').DataTable();

      var marcaMantSer = '';
      marcaMantSer += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(4).data().unique().length; i++){
        if(table.column(4).data().unique()[i] !== null){
          marcaMantSer += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
        }
      }
      $("#marcaMantenedorMateriales").html(marcaMantSer);

      var modeloMantSer = '';
      modeloMantSer += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(5).data().unique().length; i++){
        if(table.column(5).data().unique()[i] !== null){
          modeloMantSer += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
        }
      }
      $("#modeloMantenedorMateriales").html(modeloMantSer);

      var tipoMantSer = '';
      tipoMantSer += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(7).data().unique().length; i++){
        if(table.column(7).data().unique()[i] !== null){
          tipoMantSer += '<option value="' + table.column(7).data().unique()[i] + '">' + table.column(7).data().unique()[i] + '</option>';
        }
      }
      $("#tipoMantenedorMateriales").html(tipoMantSer);

      $('#contenido').show();
      $('#menu-lateral').show();
      $('#footer').parent().show();
$('#footer').show();

      if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        $("#marcaMantenedorMateriales").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $("#modeloMantenedorMateriales").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $("#tipoMantenedorMateriales").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
      }

      esconderMenu();
      menuElegant();
      setTimeout(async function(){
        $('#tablaMantenedorMateriales').DataTable().columns.adjust();
        $("#filtrosComprasMaterial").css("height","0");
        $("#filtrosComprasMaterial").fadeOut();
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      },1500);
    }
  });

  await $.ajax({
    url:   'controller/datosAccionesVisibles.php',
    type:  'post',
    data: {
      "path": window.location.href.split('#/')[1]
    },
    success: function (response) {
      var p = jQuery.parseJSON(response);
      $("#accionesMantenedorMateriales").html('');
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++) {
          if(p.aaData[i].VISIBLE == 1){
            if(p.aaData[i].ENABLE == 1){
              $("#accionesMantenedorMateriales").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
            else{
              $("#accionesMantenedorMateriales").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button disabled class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
          }
        }
      }
    }
  });

  setTimeout(function(){
    var js = document.createElement('script');
    js.src = 'view/js/funciones.js?idLoad=205';
    document.getElementsByTagName('head')[0].appendChild(js);
  },500);
}

$("#agregarMantenedorMaterial").unbind("click").click(async function() {
  $('input:text').val('');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url: 'controller/datosComprasMaterialSelect.php',
    type: 'POST',
    data: {},
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      var options = '<option value="0">Seleccionar</option>';
      for (var i=0; i < p.aaData.length; i++) {
        var id = p.aaData[i].IDCOMPRAS_MATERIAL;
        var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $('#baseAgregarMantMateriales').html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosGestionAgregarDim.php',
    type: 'POST',
    data: {
      "tipo": "MAT"
    },
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      var options = '<option value="0">Seleccionar</option>';
      for (var i=0; i < p.aaData.length; i++) {
        var id = p.aaData[i].ID;
        var label = p.aaData[i].GESTION;
        options += `<option value="${id}">${label}</option>`;
      }
      $('#selectComprasMaterialGD3').html(options);

      await $.ajax({
        url: 'controller/datosFinanzasAgregarDim.php',
        type: 'POST',
        data: {
          "tipo": "MAT"
        },
        success: async function (response) {
          var p = jQuery.parseJSON(response);
          var options = '<option value="0">Seleccionar</option>';
          for (var i=0; i < p.aaData.length; i++) {
            var id = p.aaData[i].ID;
            var label = p.aaData[i].FINANZAS;
            options += `<option value="${id}">${label}</option>`;
          }
          $('#selectComprasMaterialFE').html(options);

          await $.ajax({
            url: 'controller/datosSubcontratistasVehiculoInterno.php',
            type: 'POST',
            data: {},
            success: function (response) {
              var p = jQuery.parseJSON(response);
              var options = '<option value="0">Seleccionar</option>';
              for (var i=0; i < p.aaData.length; i++) {
                var id = p.aaData[i].IDSUBCONTRATO;
                var label = p.aaData[i].NOMBRE_SUBCONTRATO;
                options += `<option value="${id}">${label}</option>`;
              }
              $('#selectComprasMaterialSBC').html(options);

              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $('#baseAgregarMantMateriales').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $('#selectComprasMaterialGD3').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $('#selectComprasMaterialFE').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $('#selectComprasMaterialSBC').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
              }

              setTimeout(function(){
                var h = $(window).height() - 200;
                $("#bodyAgregarMantMateriales").css("height",h);
                $('#modalAlertasSplash').modal('hide');
                $("#modalAgregarMantMateriales").modal('show');
              },500);
            }
          });
        }
      });
    }
  });
});

$('#baseAgregarMantMateriales').change(async function (e) {
  $('#modalAgregarMantMateriales').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  e.preventDefault();
  e.stopImmediatePropagation();
  var idMaterial = $('select[id="baseAgregarMantMateriales"] option:selected').val();
  await $.ajax({
    url:   'controller/datosComprasMaterialDetalle.php',
    type:  'post',
    dataType: 'json',
    data:  {
      idMaterial: idMaterial
    },
    success:  function (response) {
      var p = response.aaData;

      $('#codigoMantMateriales').val(p[0].CODIGO);
      $('#nombreMantMateriales').val(p[0].NOMBRE);
      $('#marcaMantMateriales').val(p[0].MARCA);
      $('#modeloMantMateriales').val(p[0].MODELO);
      $('#colorMantMateriales').val(p[0].COLOR);
      $('#tipoMantMateriales').val(p[0].TIPO);
      $('#matMantMateriales').val(p[0].MATERIAL_FAB);
      $('#tallaMantMateriales').val(p[0].TALLA);
      $('#envaseMantMateriales').val(p[0].ENVASE);
      $('#preciominMantMateriales').val(p[0].PRECIO_MIN);
      $('#preciomaxMantMateriales').val(p[0].PRECIO_MAX);
      $('#voltajeMantMateriales').val(p[0].VOLTAJE);
      $('#potenciaMantMateriales').val(p[0].POTENCIA);
      $('#calibreMantMateriales').val(p[0].CALIBRE);
      $('#anchoMantMateriales').val(p[0].ANCHO);
      $('#altoMantMateriales').val(p[0].ALTO);
      $('#largoMantMateriales').val(p[0].LARGO);
      $('#observacionMantMateriales').val(p[0].OBSERVACION);

      $('#selectComprasMaterialSBC').val(p[0].IDSUBCONTRATO);
      $('#selectComprasMaterialGD3').val(p[0].IDCOMPRAS_GESTION_DIM3);
      $('#selectComprasMaterialFE').val(p[0].IDCOMPRAS_FINANZAS_ESTRUCTURA);

      if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        $('#baseAgregarMantMateriales').select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $('#selectComprasMaterialSBC').select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $('#selectComprasMaterialGD3').select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $('#selectComprasMaterialFE').select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
      }

      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
        $('#modalAgregarMantMateriales').modal('show');
      },500);
    }
  });
});

$("#editarMantenedorMaterial").unbind("click").click(async function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorMateriales').DataTable();
  var datos = table.rows('.selected').data();

  $('#tituloEditarMantMateriales').html(`
    Folio: ${datos[0].IDCOMPRAS_MATERIAL}
    <br>
    Nombre: ${datos[0].NOMBRE}
    <br>
    Empresa: ${datos[0].SB_NOMBRE_SUBCONTRATO}
  `);

  await $.ajax({
    url: 'controller/datosGestionAgregarDim.php',
    type: 'POST',
    data: {
      "tipo": "MAT"
    },
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      var options = '<option value="0">Seleccionar</option>';
      for (var i=0; i < p.aaData.length; i++) {
        var id = p.aaData[i].ID;
        var label = p.aaData[i].GESTION;
        if(datos[0].IDCOMPRAS_GESTION_DIM3 === p.aaData[i].ID){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $('#selectComprasMaterialGD3_upd').html(options);

      await $.ajax({
        url: 'controller/datosFinanzasAgregarDim.php',
        type: 'POST',
        data: {
          "tipo": "MAT"
        },
        success: async function (response) {
          var p = jQuery.parseJSON(response);
          var options = '<option value="0">Seleccionar</option>';
          for (var i=0; i < p.aaData.length; i++) {
            var id = p.aaData[i].ID;
            var label = p.aaData[i].FINANZAS;
            if(datos[0].IDCOMPRAS_FINANZAS_ESTRUCTURA === p.aaData[i].ID){
              options += `<option selected value="${id}">${label}</option>`;
            }
            else{
              options += `<option value="${id}">${label}</option>`;
            }
          }
          $('#selectComprasMaterialFE_upd').html(options);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $('#selectComprasMaterialGD3_upd').select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $('#selectComprasMaterialFE_upd').select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }

          $('#codigoMantMateriales_upd').val(datos[0].CODIGO);
          $('#nombreMantMateriales_upd').val(datos[0].NOMBRE);
          $('#marcaMantMateriales_upd').val(datos[0].MARCA);
          $('#modeloMantMateriales_upd').val(datos[0].MODELO);
          $('#colorMantMateriales_upd').val(datos[0].COLOR);
          $('#tipoMantMateriales_upd').val(datos[0].TIPO);
          $('#matMantMateriales_upd').val(datos[0].MATERIAL_FAB);
          $('#tallaMantMateriales_upd').val(datos[0].TALLA);
          $('#envaseMantMateriales_upd').val(datos[0].ENVASE);
          $('#preciominMantMateriales_upd').val(datos[0].PRECIO_MIN);
          $('#preciomaxMantMateriales_upd').val(datos[0].PRECIO_MAX);
          $('#voltajeMantMateriales_upd').val(datos[0].VOLTAJE);
          $('#potenciaMantMateriales_upd').val(datos[0].POTENCIA);
          $('#calibreMantMateriales_upd').val(datos[0].CALIBRE);
          $('#anchoMantMateriales_upd').val(datos[0].ANCHO);
          $('#altoMantMateriales_upd').val(datos[0].ALTO);
          $('#largoMantMateriales_upd').val(datos[0].LARGO);
          $('#observacionMantMateriales_upd').val(datos[0].OBSERVACION);

          setTimeout(function(){
            var h = $(window).height() - 300;
            $("#bodyEditarMantMateriales").css("height",h);
            $("#modalEditarMantMateriales").modal('show');
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      });
    }
  });
});

$("#eliminarMantenedorMaterial").unbind("click").click(function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorMateriales').DataTable();
  var datos = table.rows('.selected').data();

  $("#tituloActivarZonaOrden").html('Desactivar Zona');
  $("#detalleEliminarMantMateriales").html('¿Está seguro que desea eliminar el material con folio: ' + datos[0].IDCOMPRAS_MATERIAL + '?');

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEliminarMantMateriales").modal("show");
  },500);
});

$('#guardarAgregarMantMateriales').unbind("click").click(async function() {
  if($("#selectComprasMaterialSBC").val() === "0" || $("#codigoMantMateriales").val() === "" || $("#nombreMantMateriales").val() === "" || $("#selectComprasMaterialGD3").val() === "0" || $("#selectComprasMaterialFE").val() === "0"){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos Empresa, Cod. Contable, Nombre, Dim. Gestión y Dim. Finanzas por lo menos");
    $("#selectComprasMaterialSBC").next().find('.select2-selection').addClass("select2-error");
    $("#selectComprasMaterialGD3").next().find('.select2-selection').addClass("select2-error");
    $("#selectComprasMaterialFE").next().find('.select2-selection').addClass("select2-error");
    $("#codigoMantMateriales").addClass("is-invalid");
    $("#nombreMantMateriales").addClass("is-invalid");
  }
  else{
    $('#modalAgregarMantMateriales').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var data = {
      idComprasGestionDim3: $('#selectComprasMaterialGD3').val(),
      idComprasFinanzasEstructura: $('#selectComprasMaterialFE').val(),
      idSubcontrato: $('#selectComprasMaterialSBC').val(),
      codigo: $('#codigoMantMateriales').val(),
      nombre: $('#nombreMantMateriales').val(),
      marca: $('#marcaMantMateriales').val(),
      modelo: $('#modeloMantMateriales').val(),
      color: $('#colorMantMateriales').val(),
      tipo: $('#tipoMantMateriales').val(),
      material_fab: $('#matMantMateriales').val(),
      talla: $('#tallaMantMateriales').val(),
      envase: $('#envaseMantMateriales').val(),
      precio_min: $('#preciominMantMateriales').val(),
      precio_max: $('#preciomaxMantMateriales').val(),
      voltaje: $('#voltajeMantMateriales').val(),
      potencia: $('#potenciaMantMateriales').val(),
      calibre: $('#calibreMantMateriales').val(),
      ancho: $('#anchoMantMateriales').val(),
      alto: $('#altoMantMateriales').val(),
      largo: $('#largoMantMateriales').val(),
      observacion: $('#observacionMantMateriales').val()
    };
    await $.ajax({
      url:   'controller/ingresarMantMateriales.php',
      type:  'post',
      data: data,
      success: function (response) {
        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Dimensión eliminada correctamente");
        $('input:text').val('');
        $('input:number').val('');
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    });

    await cargarComprasMateriales();
  }
});

$('#guardarEditarMantMateriales').unbind("click").click(async function() {
  var table = $('#tablaMantenedorMateriales').DataTable();
  var datos = table.rows('.selected').data();

  $('#modalEditarMantMateriales').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var data = {
    idMaterial: datos[0].IDCOMPRAS_MATERIAL,
    // idComprasGestionDim3: 1,
    // idComprasFinanzasEstructura: 25107,
    // idSubcontrato: 5,
    codigo: $('#codigoMantMateriales_upd').val(),
    nombre: $('#nombreMantMateriales_upd').val(),
    marca: $('#marcaMantMateriales_upd').val(),
    modelo: $('#modeloMantMateriales_upd').val(),
    color: $('#colorMantMateriales_upd').val(),
    tipo: $('#tipoMantMateriales_upd').val(),
    material_fab: $('#matMantMateriales_upd').val(),
    talla: $('#tallaMantMateriales_upd').val(),
    envase: $('#envaseMantMateriales_upd').val(),
    precio_min: $('#preciominMantMateriales_upd').val(),
    precio_max: $('#preciomaxMantMateriales_upd').val(),
    voltaje: $('#voltajeMantMateriales_upd').val(),
    potencia: $('#potenciaMantMateriales_upd').val(),
    calibre: $('#calibreMantMateriales_upd').val(),
    ancho: $('#anchoMantMateriales_upd').val(),
    alto: $('#altoMantMateriales_upd').val(),
    largo: $('#largoMantMateriales_upd').val(),
    observacion: $('#observacionMantMateriales_upd').val()
  };
  await $.ajax({
    url:   'controller/editarComprasMaterial.php',
    type:  'post',
    data: data,
    success: function (response) {
      alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Material actualizado correctamente");
      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
      },500);

      $('input:text').val('');
    }
  });

  await cargarComprasMateriales();
});

$('#guardarEliminarMantMateriales').unbind("click").click(async function() {
  var table = $('#tablaMantenedorMateriales').DataTable();
  var datos = table.rows('.selected').data();

  $('#modalEliminarMantMateriales').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var data = {
    idMaterial: datos[0].IDCOMPRAS_MATERIAL,
  };
  await $.ajax({
    url:   'controller/eliminarComprasMaterial.php',
    type:  'post',
    data: data,
    success: function (response) {
      alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Material eliminado correctamente");
      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
      },500);

      $('input:text').val('');
      $('input:number').val('');
    }
  });

  await cargarComprasMateriales();
});

async function cargarComprasProveedores() {
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  await $('#tablaMantenedorProveedores').DataTable({
    ajax: {
      url: "controller/datosComprasProveedores.php",
      type: 'POST',
      data: {}
    },
    columns: [
      { data: 'S'},
      { data: 'IDCOMPRAS_PROVEEDOR', className: "centerDataTable"},
      { data: 'BP' },
      { data: 'RUT' },
      { data: 'NOMBRE' },
      { data: 'CONTACTO' },
      { data: 'EMAIL_CONTACTO' },
      { data: 'FONO_CONTACTO' },
      { data: 'CONDICION_PAGO', className: "centerDataTable"},
      { data: 'CONTRATO', className: "centerDataTable"},
      { data: 'F_INICIO_CONTRATO', className: "centerDataTable"},
      { data: 'F_FIN_CONTRATO', className: "centerDataTable"},
      { data: 'DIRECCION' },
      { data: 'COMUNA_MAPA' },
      { data: 'SOCIEDAD' },
      { data: 'ACTIVIDAD' },
      { data: 'TIPO' },
      { data: 'ACREDITADO'},
      { data: 'BLOQUEO_SAP'},
      { data: 'MONEDA'},
      { data: 'CRITICO'},
      { data: 'COMPRADOR_ASIGNADO' },
      { data: 'USUARIO_MODIFICA' },
      { data: 'USUARIO_EVALUADOR' },
      { data: 'FECHA_SOLICITUD' },
      { data: 'FECHA_INGRESO' },
      { data: 'FECHA_ACTUALIZACION' },
      { data: 'AVANCE'},
      { data: 'EVALUACION'},
      { data: 'EVALUADO'},
      { data: 'CATEGORIA'},
      { data: 'REGION_MAPA'},
      { data: 'IDMONEDA_PAGO'},
      { data: 'IDSOCIEDADES'},
      { data: 'IDCOMUNAS'},
      { data: 'IDTIPOS'},
      { data: 'IDACTIVIDAD'}
    ],
    buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        },
        {
          text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
          action: function ( e, dt, node, config ) {
            var table = $('#tablaMantenedorProveedores').DataTable();
            $("#editarMantenedorProveedores").attr("disabled","disabled");
            $("#eliminarMantenedorProveedores").attr("disabled","disabled");
            $("#asignarCompMantenedorProveedores").attr("disabled","disabled");
            table.rows().deselect();
          }
        }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "visible": false,
        "searchable": true,
        "targets": [ 31 ]
      },
      {
        "visible": false,
        "searchable": true,
        "targets": [ 32 ]
      },
      {
        "visible": false,
        "searchable": true,
        "targets": [ 33 ]
      },
      {
        "visible": false,
        "searchable": true,
        "targets": [ 34 ]
      },
      {
        "visible": false,
        "searchable": true,
        "targets": [ 35 ]
      },
      {
        "visible": false,
        "searchable": true,
        "targets": [ 36 ]
      }
    ],
    "select": {
      style: 'multi',
      // selector: 'td:not(:nth-child(19))'
    },
    "scrollX": false,
    "paging": true,
    "ordering": true,
    "responsive": {
        details: {
            renderer: function ( api, rowIdx, columns ) {
                var data = $.map( columns, function ( col, i ) {
                    return col.hidden ?
                        '<tr data-dt-row="'+col.rowIndex+'" data-dt-column="'+col.columnIndex+'">'+
                            '<td style="font-weight: bold; min-width: 150px;">'+col.title+':'+'</td> '+
                            '<td style="min-width: 150px; text-align: center;">'+col.data+'</td>'+
                        '</tr>' :
                        '';
                } ).join('');

                return data ?
                    $('<table/>').append( data ) :
                    false;
            }
        }
    },
    "scrollCollapse": true,
    "info":     true,
    "order": [[ 1, "desc" ]],
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json) {
      var table = $('#tablaMantenedorProveedores').DataTable();
      $('#contenido').show();
      $('#menu-lateral').show();
      $('#footer').parent().show();
      $('#footer').show();

      var avanceProveedor = '';
      avanceProveedor += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(27).data().unique().length; i++){
        if(table.column(27).data().unique()[i] !== null){
          avanceProveedor += '<option value="' + table.column(27).data().unique()[i] + '">' + table.column(27).data().unique()[i] + '</option>';
        }
      }
      $("#avanceMantenedorProveedores").html(avanceProveedor);

      var compradorProveedor = '';
      compradorProveedor += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(21).data().unique().length; i++){
        if(table.column(21).data().unique()[i] !== null){
          compradorProveedor += '<option value="' + table.column(21).data().unique()[i] + '">' + table.column(21).data().unique()[i] + '</option>';
        }
      }
      $("#compradorMantenedorProveedores").html(compradorProveedor);

      var evaluadorProveedor = '';
      evaluadorProveedor += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(23).data().unique().length; i++){
        if(table.column(23).data().unique()[i] !== null){
          evaluadorProveedor += '<option value="' + table.column(23).data().unique()[i] + '">' + table.column(23).data().unique()[i] + '</option>';
        }
      }
      $("#evaluadorMantenedorProveedores").html(evaluadorProveedor);

      // Aqui Voy //
      var sociedadProveedor = '';
      var arraySociedadProveedor = [];
      for(var i = 0; i < table.column(14).data().unique().length; i++){
        if(table.column(14).data().unique()[i] !== null){
          var asc = table.column(14).data().unique()[i].split("<br>");
          for(var j = 0; j < asc.length; j++){
            arraySociedadProveedor.push(asc[j]);
          }
        }
      }

      let resultSociedad = arraySociedadProveedor.filter((item,index)=>{
        return arraySociedadProveedor.indexOf(item) === index;
      })

      sociedadProveedor += '<option selected value="Todos">Todos</option>';
      for(var j = 0; j < resultSociedad.length; j++){
        sociedadProveedor += '<option value="' + resultSociedad[j] + '">' + resultSociedad[j] + '</option>';
      }
      $("#sociedadMantenedorProveedores").html(sociedadProveedor);

      var tipoProveedor = '';
      var arrayTipoProveedor = [];
      for(var i = 0; i < table.column(16).data().unique().length; i++){
        if(table.column(16).data().unique()[i] !== null){
          var asc = table.column(16).data().unique()[i].split("<br>");
          for(var j = 0; j < asc.length; j++){
            arrayTipoProveedor.push(asc[j]);
          }
        }
      }

      let resultTipo = arrayTipoProveedor.filter((item,index)=>{
        return arrayTipoProveedor.indexOf(item) === index;
      })

      tipoProveedor += '<option selected value="Todos">Todos</option>';
      for(var j = 0; j < resultTipo.length; j++){
        tipoProveedor += '<option value="' + resultTipo[j] + '">' + resultTipo[j] + '</option>';
      }
      $("#tipoMantenedorProveedores").html(tipoProveedor);

      var comunaProveedor = '';
      var arrayComunaProveedor = [];
      for(var i = 0; i < table.column(13).data().unique().length; i++){
        if(table.column(13).data().unique()[i] !== null){
          var asc = table.column(13).data().unique()[i].split("<br>");
          for(var j = 0; j < asc.length; j++){
            arrayComunaProveedor.push(asc[j]);
          }
        }
      }

      let resultComuna = arrayComunaProveedor.filter((item,index)=>{
        return arrayComunaProveedor.indexOf(item) === index;
      })

      comunaProveedor += '<option selected value="Todos">Todos</option>';
      for(var j = 0; j < resultComuna.length; j++){
        comunaProveedor += '<option value="' + resultComuna[j] + '">' + resultComuna[j] + '</option>';
      }
      $("#comunaMantenedorProveedores").html(comunaProveedor);

      var actividadProveedor = '';
      var arrayActividadProveedor = [];
      for(var i = 0; i < table.column(15).data().unique().length; i++){
        if(table.column(15).data().unique()[i] !== null){
          var asc = table.column(15).data().unique()[i].split("<br>");
          for(var j = 0; j < asc.length; j++){
            arrayActividadProveedor.push(asc[j]);
          }
        }
      }

      let resultActividad = arrayActividadProveedor.filter((item,index)=>{
        return arrayActividadProveedor.indexOf(item) === index;
      })

      actividadProveedor += '<option selected value="Todos">Todos</option>';
      for(var j = 0; j < resultActividad.length; j++){
        actividadProveedor += '<option value="' + resultActividad[j] + '">' + resultActividad[j] + '</option>';
      }
      $("#actividadMantenedorProveedores").html(actividadProveedor);

      var regionProveedor = '';
      var arrayRegionProveedor = [];
      for(var i = 0; i < table.column(31).data().unique().length; i++){
        if(table.column(31).data().unique()[i] !== null){
          var asc = table.column(31).data().unique()[i].split("<br>");
          for(var j = 0; j < asc.length; j++){
            arrayRegionProveedor.push(asc[j]);
          }
        }
      }

      let resultRegion = arrayRegionProveedor.filter((item,index)=>{
        return arrayRegionProveedor.indexOf(item) === index;
      })

      regionProveedor += '<option selected value="Todos">Todos</option>';
      for(var j = 0; j < resultRegion.length; j++){
        regionProveedor += '<option value="' + resultRegion[j] + '">' + resultRegion[j] + '</option>';
      }
      $("#regionMantenedorProveedores").html(regionProveedor);

      esconderMenu();
      menuElegant();
      setTimeout(async function(){
        $('#modalAlertasSplash').modal('hide');
        $('#tablaMantenedorProveedores').DataTable().columns.adjust();
        setTimeout(function(){
          $('#tablaMantenedorProveedores').DataTable().columns.adjust();
          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#sociedadMantenedorProveedores").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
              sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
            });
            $("#tipoMantenedorProveedores").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#comunaMantenedorProveedores").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#actividadMantenedorProveedores").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#regionMantenedorProveedores").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#avanceMantenedorProveedores").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#compradorMantenedorProveedores").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#evaluadorMantenedorProveedores").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }
        },500);
      },1500);
    }
  });

  await $.ajax({
    url:   'controller/datosAccionesVisibles.php',
    type:  'post',
    data: {
      "path": window.location.href.split('#/')[1]
    },
    success: function (response) {
      $("#accionesMantenedorProveedores").html('');
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++) {
          if(p.aaData[i].VISIBLE == 1){
            if(p.aaData[i].ENABLE == 1){
              $("#accionesMantenedorProveedores").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
            else{
              $("#accionesMantenedorProveedores").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button disabled class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
          }
        }
      }
    }
  });

  setTimeout(function(){
    var js = document.createElement('script');
    js.src = 'view/js/funciones.js?idLoad=205';
    document.getElementsByTagName('head')[0].appendChild(js);
  },500);
}

$("#agregarMantenedorProveedores").unbind("click").click(async function() {
  $("#basicosAgregarMantProveedores-tab").css("color","black");
  $("#clasificacionAgregarMantProveedores-tab").css("color","black");
  $('input:text').val('');
  $("#rutMantProveedores_agr").removeClass("is-invalid");
  $("#nombreMantProveedores_agr").removeClass("is-invalid");
  $("#contactoMantProveedores_agr").removeClass("is-invalid");
  $("#emailMantProveedores_agr").removeClass("is-invalid");
  $("#bpMantProveedores_agr").removeClass("is-invalid");
  $("#fonoMantProveedores_agr").removeClass("is-invalid");
  $("#direccionMantProveedores_agr").removeClass("is-invalid");

  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url: 'controller/datosCondicionPago.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].CONDICION;
        var label = p[i].DESCRIPCION;
        if(label === "Sin seleccionar"){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $("#condPagoMantProveedores_agr").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosCondicionSAP.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDCOMPRAS_PROVEEDOR_SAP;
        var label = p[i].SAP;
        if(label === "Sin seleccionar"){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $("#bloqueoMantProveedores_agr").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosCondicionNexcel.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDCOMPRAS_PROVEEDOR_NEXCEL;
        var label = p[i].NEXCEL;
        if(label === "Sin seleccionar"){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $("#acreditadoMantProveedores_agr").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosMonedaPago.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDMONEDA_PAGO;
        var label = p[i].ABREVIATURA;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasProveedoresMoneda_agr").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosSubcontratistasVehiculoInterno.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDSUBCONTRATO;
        var label = p[i].NOMBRE_SUBCONTRATO;
        options += `<option value="${id}">&nbsp;&nbsp;${label}</option>`;
      }
      $("#sociedadMantProveedores_agr").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosComunaConRegion.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDAREAFUNCIONAL;
        var label = p[i].COMUNA;
        var flag = 0;
        options += `<option value="${id}">&nbsp;&nbsp;${label}</option>`;
      }
      $("#comunaMantProveedores_agr").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosTiposProveedores.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDCOMPRAS_TIPO;
        var label = p[i].TIPO;
        var flag = 0;
        options += `<option value="${id}">&nbsp;&nbsp;${label}</option>`;
      }
      $("#tipoMantProveedores_agr").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosComprasGestionDim1.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDCOMPRAS_GESTION_DIM1;
        var label = p[i].ACTIVIDAD;
        options += `<option value="${id}">&nbsp;&nbsp;${label}</option>`;
      }
      $("#actividadMantProveedores_agr").html(options);
    }
  });

  await $.ajax({
    url:   'controller/datosCompradoresAsignables.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoDes = '<option value="">Sin seleccionar</option>';
      for(var i = 0; i < p2.aaData.length; i++){
        cuerpoDes += '<option value="' + p2.aaData[i].RUT + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
      }
      $("#compradorMantProveedores_agr").html(cuerpoDes);
    }
  });

  $("#fechaFinContratoMantProveedores_agr").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });
  $("#fechaInicioContratoMantProveedores_agr").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });
  $("#fechaSolicitudMantProveedores_agr").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });
  $("#sociedadMantProveedores_agr").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
  $("#comunaMantProveedores_agr").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
  $("#tipoMantProveedores_agr").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
  $("#actividadMantProveedores_agr").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#compradorMantProveedores_agr").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#contratoMantProveedores_agr').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#acreditadoMantProveedores_agr').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasProveedoresMoneda_agr').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#bloqueoMantProveedores_agr').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#condPagoMantProveedores_agr').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#criticoMantProveedores_agr').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var h = $(window).height() - 200;
  $("#bodyAgregarMantProveedores").css("height",h);
  $("#modalAgregarMantProveedores").modal('show');
  setTimeout(function() {
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#editarMantenedorProveedores").unbind("click").click(async function() {
  $("#basicosEditarMantProveedores-tab").css("color","black");
  $("#clasificacionEditarMantProveedores-tab").css("color","black");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $('#tablaMantenedorProveedores').DataTable();
  var datos = table.rows('.selected').data();
  var idSociedades = '';
  var idComunas = '';
  var idTipos = '';
  var idActividad = '';
  if(datos[0].IDTIPOS !== null){
    idTipos = datos[0].IDTIPOS.split(',');
  }
  if(datos[0].IDCOMUNAS !== null){
    idComunas = datos[0].IDCOMUNAS.split(',');
  }
  if(datos[0].IDSOCIEDADES !== null){
    idSociedades = datos[0].IDSOCIEDADES.split(',');
  }
  if(datos[0].IDACTIVIDAD !== null){
    idActividad = datos[0].IDACTIVIDAD.split(',');
  }

  idProveedor = datos[0].IDCOMPRAS_PROVEEDOR;

  $('#bpMantProveedores_upd').val(datos[0].BP);
  $('#rutMantProveedores_upd').val(datos[0].RUT);
  $('#nombreMantProveedores_upd').val(datos[0].NOMBRE);
  $('#contactoMantProveedores_upd').val(datos[0].CONTACTO);
  $('#emailMantProveedores_upd').val(datos[0].EMAIL_CONTACTO);
  $('#fonoMantProveedores_upd').val(datos[0].FONO_CONTACTO);
  $('#direccionMantProveedores_upd').val(datos[0].DIRECCION);
  $('#fechaInicioContratoMantProveedores_upd').val(datos[0].F_INICIO_CONTRATO);
  $('#fechaFinContratoMantProveedores_upd').val(datos[0].F_FIN_CONTRATO);
  $('#fechaSolicitudMantProveedores_upd').val(datos[0].FECHA_SOLICITUD);

  var idcon = 0;
  if(datos[0].CONTRATO === "Si"){
    idcon = 1;
  }
  else if(datos[0].CONTRATO === "-"){
    idcon = 9;
  }

  var idcri = 0;
  if(datos[0].CRITICO === "Si"){
    idcri = 1;
  }
  else if(datos[0].CRITICO === "-"){
    idcri = 9;
  }

  var idacre = 0;
  if(datos[0].ACREDITADO === "-"){
    idacre = "Sin seleccionar";
  }
  else{
    idacre = datos[0].ACREDITADO;
  }
  var idbloq = 0;
  if(datos[0].BLOQUEO_SAP === "-"){
    idbloq = "Sin seleccionar";
  }
  else{
    idbloq = datos[0].BLOQUEO_SAP;
  }
  var condPago = '';
  condPago = datos[0].CONDICION_PAGO;

  var comp = '';
  if(datos[0].RUT_COMPRADOR_ASIGNADO !== ""){
    comp = datos[0].RUT_COMPRADOR_ASIGNADO;
  }
  $('#contratoMantProveedores_upd').val(idcon);
  $('#criticoMantProveedores_upd').val(idcri);
  $("#estdoCriticoComprasMantProveedores_upd").val(datos[0].CRITICO);
  $("#jefeComprasCriticoMantProveedores_upd").val("Decisión jefe de compras");

  if(datos[0].NEX_PREA === null){
    datos[0].NEX_PREA = '';
  }
  if(datos[0].NEX_ACR === null){
    datos[0].NEX_ACR = '';
  }
  if(datos[0].NEX_PREC === null){
    datos[0].NEX_PREC = '';
  }

  $("#nexcelMantProveedores_upd").html("&nbsp;&nbsp;- Acreditación: " + datos[0].NEX_ACR + "<br>&nbsp;&nbsp;- Pre-Calificación: " + datos[0].NEX_PREC + "<br>&nbsp;&nbsp;- Pre-Adjudicación: " + datos[0].NEX_PREA)

  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  await $('#historialCriticoComprasMantProveedores_upd').DataTable({
    ajax: {
      url: "controller/datosHistorialCriticosProveedor.php",
      type: 'POST',
      data: {
        "id": datos[0].IDCOMPRAS_PROVEEDOR
      }
    },
    buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        },
    ],
    columns: [
      { data: 'S'},
      { data: 'FOLIO', className: "centerDataTable"},
      { data: 'USUARIO' },
      { data: 'PERFIL' },
      { data: 'CRITICO' },
      { data: 'FECHA' },
      { data: 'HORA' }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      }
    ],
    "select": {
      style: 'single',
    },
    // fixedColumns:   {
    //   leftColumns: 4
    // },
    "processing": true,
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "order": [[ 1, "desc" ]],
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json) {

    }
  });

  await $('#historialEvalMantProveedores_upd').DataTable({
    ajax: {
      url: "controller/datosPeriodoEvalProveedoresHistorial.php",
      type: 'POST',
      data: {
        "folio": datos[0].IDCOMPRAS_PROVEEDOR
      }
    },
    buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        },
    ],
    columns: [
      { data: 'S'},
      { data: 'FOLIO', className: "centerDataTable"},
      { data: 'USUARIO' },
      { data: 'PERFIL' },
      { data: 'PLAZO' },
      { data: 'CALIDAD' },
      { data: 'PONDERADO' },
      { data: 'PERIODO' },
      { data: 'FECHA' },
      { data: 'HORA' }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      }
    ],
    "select": {
      style: 'single',
    },
    // fixedColumns:   {
    //   leftColumns: 4
    // },
    "processing": true,
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "order": [[ 1, "desc" ]],
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json) {

    }
  });

  await $.ajax({
    url: 'controller/datosCondicionPago.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].CONDICION;
        var label = p[i].DESCRIPCION;
        if(id === condPago){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $("#condPagoMantProveedores_upd").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosCondicionSAP.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDCOMPRAS_PROVEEDOR_SAP;
        var label = p[i].SAP;
        if(label === idbloq){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $("#bloqueoMantProveedores_upd").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosCondicionNexcel.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDCOMPRAS_PROVEEDOR_NEXCEL;
        var label = p[i].NEXCEL;
        if(label === idacre){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $("#acreditadoMantProveedores_upd").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosMonedaPago.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDMONEDA_PAGO;
        var label = p[i].ABREVIATURA;
        if(datos[0].IDMONEDA_PAGO === p[i].IDMONEDA_PAGO){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $("#selectComprasProveedoresMoneda_upd").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosSubcontratistasVehiculoInterno.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDSUBCONTRATO;
        var label = p[i].NOMBRE_SUBCONTRATO;
        var flag = 0;
        for(var j = 0; j < idSociedades.length; j++){
          if(idSociedades[j] === p[i].IDSUBCONTRATO){
            options += `<option selected value="${id}">&nbsp;&nbsp;${label}</option>`;
            flag = 1;
            break;
          }
        }
        if(flag === 0){
          options += `<option value="${id}">&nbsp;&nbsp;${label}</option>`;
        }
      }
      $("#sociedadMantProveedores_upd").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosComunaConRegion.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDAREAFUNCIONAL;
        var label = p[i].COMUNA;
        var flag = 0;
        for(var j = 0; j < idComunas.length; j++){
          if(idComunas[j] === p[i].IDAREAFUNCIONAL){
            options += `<option selected value="${id}">&nbsp;&nbsp;${label}</option>`;
            flag = 1;
            break;
          }
        }
        if(flag === 0){
          options += `<option value="${id}">&nbsp;&nbsp;${label}</option>`;
        }
      }
      $("#comunaMantProveedores_upd").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosTiposProveedores.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDCOMPRAS_TIPO;
        var label = p[i].TIPO;
        var flag = 0;
        for(var j = 0; j < idTipos.length; j++){
          if(idTipos[j] === p[i].IDCOMPRAS_TIPO){
            options += `<option selected value="${id}">&nbsp;&nbsp;${label}</option>`;
            flag = 1;
            break;
          }
        }
        if(flag === 0){
          options += `<option value="${id}">&nbsp;&nbsp;${label}</option>`;
        }
      }
      $("#tipoMantProveedores_upd").html(options);
    }
  });

  await $.ajax({
    url: 'controller/datosComprasGestionDim1.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDCOMPRAS_GESTION_DIM1;
        var label = p[i].ACTIVIDAD;
        var flag = 0;
        for(var j = 0; j < idActividad.length; j++){
          if(idActividad[j] === p[i].IDCOMPRAS_GESTION_DIM1){
            options += `<option selected value="${id}">&nbsp;&nbsp;${label}</option>`;
            flag = 1;
            break;
          }
        }
        if(flag === 0){
          options += `<option value="${id}">&nbsp;&nbsp;${label}</option>`;
        }
      }
      $("#actividadMantProveedores_upd").html(options);
    }
  });

  await $.ajax({
    url:   'controller/datosCompradoresAsignables.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoDes = '<option value="">Sin seleccionar</option>';
      for(var i = 0; i < p2.aaData.length; i++){
        if(comp === p2.aaData[i].RUT){
          cuerpoDes += '<option selected value="' + p2.aaData[i].RUT + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
        }
        else{
          cuerpoDes += '<option value="' + p2.aaData[i].RUT + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
        }
      }
      $("#compradorMantProveedores_upd").html(cuerpoDes);
    }
  });

  await $.ajax({
    url:   'controller/datosPeriodoEvalProveedores.php',
    type:  'post',
    data:  {
      'folio': idProveedor
    },
    success: function (response) {
      var p = jQuery.parseJSON(response);
      console.log(p.aaData);
      $("#periodoEvalMantProveedores_upd").html(p.aaData.PERIODO);
      $("#nombreEvaluadorMantProveedores_upd").val(p.aaData.EVALUADOR);
      $("#campoEvaluadorMantProveedores_upd").val("Evaluador");
      if(p.aaData.EVALUADOR !== null){
        $("#evalPlazoMantProveedores_upd").attr("disabled","disabled");
        $("#evalCalidadMantProveedores_upd").attr("disabled","disabled");
        $("#evalPlazoMantProveedores_upd").val(p.aaData.PLAZO);
        $("#evalCalidadMantProveedores_upd").val(p.aaData.CALIDAD);
      }
      else{
        $("#evalPlazoMantProveedores_upd").removeAttr("disabled");
        $("#evalCalidadMantProveedores_upd").removeAttr("disabled");
        $("#evalPlazoMantProveedores_upd").val(0);
        $("#evalCalidadMantProveedores_upd").val(0);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosCheckEvaluador.php',
    type:  'post',
    data:  {
      'folio': idProveedor
    },
    success: function (response) {
      var p = jQuery.parseJSON(response);
      $("#perfilEvaluador").val(p.aaData.PERFIL);
      $("#aplicaEvaluador").val(p.aaData.EVALUADOR_OK);
    }
  });

  $("#fechaFinContratoMantProveedores_upd").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });
  $("#fechaInicioContratoMantProveedores_upd").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });
  $("#fechaSolicitudMantProveedores_upd").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });
  $("#sociedadMantProveedores_upd").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
  $("#comunaMantProveedores_upd").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
  $("#tipoMantProveedores_upd").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });
  $("#actividadMantProveedores_upd").multiSelect({
    selectableFooter: "<div class='custom-header'>&nbsp;Disponibles</div>",
    selectionFooter: "<div class='custom-header'>&nbsp;Seleccionadas</div>",
    selectableHeader: "<input id='dispoArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    selectionHeader: "<input id='selectArea' type='text' class='search-input form-control' autocomplete='off' placeholder='Buscar'>",
    afterInit: function(ms){
      var that = this,
          $selectableSearch = that.$selectableUl.prev(),
          $selectionSearch = that.$selectionUl.prev(),
          selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
          selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

      that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
      .on('keydown', function(e){
        if (e.which === 40){
          that.$selectableUl.focus();
          return false;
        }
      });

      that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
      .on('keydown', function(e){
        if (e.which == 40){
          that.$selectionUl.focus();
          return false;
        }
      });
    },
    afterSelect: function(){
      this.qs1.cache();
      this.qs2.cache();
    },
    afterDeselect: function(){
      this.qs1.cache();
      this.qs2.cache();
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#compradorMantProveedores_upd').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#contratoMantProveedores_upd').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#acreditadoMantProveedores_upd').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasProveedoresMoneda_upd').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#bloqueoMantProveedores_upd').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#condPagoMantProveedores_upd').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#criticoMantProveedores_upd').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var h = $(window).height() - 200;
  $("#bodyEditarMantProveedores").css("height",h);
  $("#modalEditarMantProveedores").modal('show');

  /* Perfiles que aplican
    Jefe de Compras
  Comprador
  Administrador Compradores
  Administrador Sistema
  */
  if($("#perfilEvaluador").val() === "Jefe de Compras" || $("#perfilEvaluador").val() === "Comprador" || $("#perfilEvaluador").val() === "Administrador Compradores"){
    $("#guardarEditarMantProveedores").css("display","inline");
  }
  else{
    $("#guardarEditarMantProveedores").css("display","none");
  }

  $("#clasificacionEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#clasificacionEditarMantProveedores").addClass("tab-pane fade");
  $("#evaluacionEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#evaluacionEditarMantProveedores").addClass("tab-pane fade");
  $("#criticosEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#criticosEditarMantProveedores").addClass("tab-pane fade");
  $("#ocEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#ocEditarMantProveedores").addClass("tab-pane fade");
  $("#basicosEditarMantProveedores").addClass("tab-pane fade show active");

  $("#clasificacionEditarMantProveedores-tab").removeClass("nav-link active");
  $("#evaluacionEditarMantProveedores-tab").removeClass("nav-link active");
  $("#criticosEditarMantProveedores-tab").removeClass("nav-link active");
  $("#ocEditarMantProveedores-tab").removeClass("nav-link active");
  $("#basicosEditarMantProveedores-tab").addClass("nav-link active");
  $("#clasificacionEditarMantProveedores-tab").addClass("nav-link");
  $("#evaluacionEditarMantProveedores-tab").addClass("nav-link");
  $("#criticosEditarMantProveedores-tab").addClass("nav-link");
  $("#ocEditarMantProveedores-tab").addClass("nav-link");

  setTimeout(function() {
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#cancelarEditarMantProveedores").unbind("click").click(function() {
  $("#tipoMantProveedores_upd").multiSelect('deselect_all');
  $("#sociedadMantProveedores_upd").multiSelect('deselect_all');
  $("#comunaMantProveedores_upd").multiSelect('deselect_all');
  $("#actividadMantProveedores_upd").multiSelect('deselect_all');
});

$("#eliminarMantenedorProveedores").unbind("click").click(function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorProveedores').DataTable();
  var datos = table.rows('.selected').data();

  $("#detalleEliminarMantProveedores").html('¿Está seguro que desea eliminar la compra proveedor con folio: ' + datos[0].IDCOMPRAS_PROVEEDOR + '?');

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEliminarMantProveedores").modal("show");
  },500);
});

$('#guardarAgregarMantProveedores').unbind("click").click(async function() {
  if($("#rutMantProveedores_agr").val() === "" || $("#contactoMantProveedores_agr").val() === "" || $("#emailMantProveedores_agr").val() === "" || $("#nombreMantProveedores_agr").val() === "" || $("#fonoMantProveedores_agr").val() === "" || $("#direccionMantProveedores_agr").val() === ""){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos básicos marcados en rojo");

    if($("#fonoMantProveedores_agr").val() === ""){
      $("#fonoMantProveedores_agr").addClass("is-invalid");
      var idPa = $("#fonoMantProveedores_agr").parent().parent().parent().attr("aria-labelledby");
      $("#" + idPa).css("color","red");
    }
    if($("#emailMantProveedores_agr").val() === ""){
      $("#emailMantProveedores_agr").addClass("is-invalid");
      var idPa = $("#fonoMantProveedores_agr").parent().parent().parent().attr("aria-labelledby");
      $("#" + idPa).css("color","red");
    }
    if($("#contactoMantProveedores_agr").val() === ""){
      $("#contactoMantProveedores_agr").addClass("is-invalid");
      var idPa = $("#fonoMantProveedores_agr").parent().parent().parent().attr("aria-labelledby");
      $("#" + idPa).css("color","red");
    }
    if($("#nombreMantProveedores_agr").val() === ""){
      $("#nombreMantProveedores_agr").addClass("is-invalid");
      var idPa = $("#fonoMantProveedores_agr").parent().parent().parent().attr("aria-labelledby");
      $("#" + idPa).css("color","red");
    }
    if($("#rutMantProveedores_agr").val() === ""){
      $("#rutMantProveedores_agr").addClass("is-invalid");
      var idPa = $("#fonoMantProveedores_agr").parent().parent().parent().attr("aria-labelledby");
      $("#" + idPa).css("color","red");
    }
    if($("#direccionMantProveedores_agr").val() === ""){
      $("#direccionMantProveedores_agr").addClass("is-invalid");
      var idPa = $("#fonoMantProveedores_agr").parent().parent().parent().attr("aria-labelledby");
      $("#" + idPa).css("color","red");
    }
  }
  else if($("#tipoMantProveedores_agr").val().length <= 0 || $("#sociedadMantProveedores_agr").val().length <= 0 || $("#comunaMantProveedores_agr").val().length <= 0 || $("#actividadMantProveedores_agr").val().length <= 0){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar por lo menos un tipo, una sociedad, una comuna y una actividad");
    var idPa = $("#tipoMantProveedores_agr").parent().parent().parent().attr("aria-labelledby");
    $("#" + idPa).css("color","red");
  }
  else{
    var idPa = $("#tipoMantProveedores_agr").parent().parent().parent().attr("aria-labelledby");
    $("#" + idPa).css("color","black");
    $("#modalAgregarMantProveedores").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');

    var parametros = {
      "bp": $("#bpMantProveedores_agr").val(),
      "rut": $("#rutMantProveedores_agr").val().replace(".","").replace(".",""),
      "nombre": $("#nombreMantProveedores_agr").val(),
      "contacto": $("#contactoMantProveedores_agr").val(),
      "email": $("#emailMantProveedores_agr").val(),
      "fono": $("#fonoMantProveedores_agr").val(),
      "direccion": $("#direccionMantProveedores_agr").val(),
      "condicion_pago": $("#condPagoMantProveedores_agr").val(),
      "moneda": $("#selectComprasProveedoresMoneda_agr").val(),
      "contrato": $("#contratoMantProveedores_agr").val(),
      "contrato_f_ini": $("#fechaInicioContratoMantProveedores_agr").val(),
      "contrato_f_fin": $("#fechaFinContratoMantProveedores_agr").val(),
      "acreditado": $("#acreditadoMantProveedores_agr").val(),
      "bloqueo": $("#bloqueoMantProveedores_agr").val(),
      "tipo": $("#tipoMantProveedores_agr").val(),
      "sociedad": $("#sociedadMantProveedores_agr").val(),
      "comuna": $("#comunaMantProveedores_agr").val(),
      "actividad": $("#actividadMantProveedores_agr").val(),
      "rutComprador": $("#compradorMantProveedores_agr").val(),
      "fechaSolicitud": $("#fechaSolicitudMantProveedores_agr").val(),
      "critico": $("#criticoMantProveedores_agr").val()
    }

    await $.ajax({
      url:   'controller/ingresarComprasProveedor.php',
      type:  'post',
      data: parametros,
      success: async function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
            var table = $('#tablaMantenedorProveedores').DataTable();
            await ingresaCambioProveedor(p);

            $('input:text').val('');
            $('#modalAlertasSplash').modal('hide');
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Proveedor actualizado correctamente");
            setTimeout(async function(){
              // Aqui Voy //
              var sociedadProveedor = '';
              var arraySociedadProveedor = [];
              for(var i = 0; i < table.column(14).data().unique().length; i++){
                if(table.column(14).data().unique()[i] !== null){
                  var asc = table.column(14).data().unique()[i].split("<br>");
                  for(var j = 0; j < asc.length; j++){
                    arraySociedadProveedor.push(asc[j]);
                  }
                }
              }

              let resultSociedad = arraySociedadProveedor.filter((item,index)=>{
                return arraySociedadProveedor.indexOf(item) === index;
              })

              sociedadProveedor += '<option selected value="Todos">Todos</option>';
              for(var j = 0; j < resultSociedad.length; j++){
                sociedadProveedor += '<option value="' + resultSociedad[j] + '">' + resultSociedad[j] + '</option>';
              }
              $("#sociedadMantenedorProveedores").html(sociedadProveedor);

              var tipoProveedor = '';
              var arrayTipoProveedor = [];
              for(var i = 0; i < table.column(16).data().unique().length; i++){
                if(table.column(16).data().unique()[i] !== null){
                  var asc = table.column(16).data().unique()[i].split("<br>");
                  for(var j = 0; j < asc.length; j++){
                    arrayTipoProveedor.push(asc[j]);
                  }
                }
              }

              let resultTipo = arrayTipoProveedor.filter((item,index)=>{
                return arrayTipoProveedor.indexOf(item) === index;
              })

              tipoProveedor += '<option selected value="Todos">Todos</option>';
              for(var j = 0; j < resultTipo.length; j++){
                tipoProveedor += '<option value="' + resultTipo[j] + '">' + resultTipo[j] + '</option>';
              }
              $("#tipoMantenedorProveedores").html(tipoProveedor);

              var comunaProveedor = '';
              var arrayComunaProveedor = [];
              for(var i = 0; i < table.column(13).data().unique().length; i++){
                if(table.column(13).data().unique()[i] !== null){
                  var asc = table.column(13).data().unique()[i].split("<br>");
                  for(var j = 0; j < asc.length; j++){
                    arrayComunaProveedor.push(asc[j]);
                  }
                }
              }

              let resultComuna = arrayComunaProveedor.filter((item,index)=>{
                return arrayComunaProveedor.indexOf(item) === index;
              })

              comunaProveedor += '<option selected value="Todos">Todos</option>';
              for(var j = 0; j < resultComuna.length; j++){
                comunaProveedor += '<option value="' + resultComuna[j] + '">' + resultComuna[j] + '</option>';
              }
              $("#comunaMantenedorProveedores").html(comunaProveedor);

              var actividadProveedor = '';
              var arrayActividadProveedor = [];
              for(var i = 0; i < table.column(15).data().unique().length; i++){
                if(table.column(15).data().unique()[i] !== null){
                  var asc = table.column(15).data().unique()[i].split("<br>");
                  for(var j = 0; j < asc.length; j++){
                    arrayActividadProveedor.push(asc[j]);
                  }
                }
              }

              let resultActividad = arrayActividadProveedor.filter((item,index)=>{
                return arrayActividadProveedor.indexOf(item) === index;
              })

              actividadProveedor += '<option selected value="Todos">Todos</option>';
              for(var j = 0; j < resultActividad.length; j++){
                actividadProveedor += '<option value="' + resultActividad[j] + '">' + resultActividad[j] + '</option>';
              }
              $("#actividadMantenedorProveedores").html(actividadProveedor);

              var regionProveedor = '';
              var arrayRegionProveedor = [];
              for(var i = 0; i < table.column(31).data().unique().length; i++){
                if(table.column(31).data().unique()[i] !== null){
                  var asc = table.column(31).data().unique()[i].split("<br>");
                  for(var j = 0; j < asc.length; j++){
                    arrayRegionProveedor.push(asc[j]);
                  }
                }
              }

              let resultRegion = arrayRegionProveedor.filter((item,index)=>{
                return arrayRegionProveedor.indexOf(item) === index;
              })

              regionProveedor += '<option selected value="Todos">Todos</option>';
              for(var j = 0; j < resultRegion.length; j++){
                regionProveedor += '<option value="' + resultRegion[j] + '">' + resultRegion[j] + '</option>';
              }
              $("#regionMantenedorProveedores").html(regionProveedor);

              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#sociedadMantenedorProveedores").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                  sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
                });
                $("#tipoMantenedorProveedores").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#comunaMantenedorProveedores").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#actividadMantenedorProveedores").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#regionMantenedorProveedores").select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
              }

              $("#tipoMantProveedores_agr").multiSelect('deselect_all');
              $("#sociedadMantProveedores_agr").multiSelect('deselect_all');
              $("#comunaMantProveedores_agr").multiSelect('deselect_all');
              $("#actividadMantProveedores_agr").multiSelect('deselect_all');

              $("#agregarMantenedorProveedores").removeAttr("disabled");
              $("#editarMantenedorProveedores").attr("disabled","disabled");
              $("#eliminarMantenedorProveedores").attr("disabled","disabled");
              $("#asignarCompMantenedorProveedores").attr("disabled","disabled");

              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },2000);
            },500);
          }
        else{
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible actualizar el proveedor, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalAgregarMantProveedores").modal("show");
          },500);
        }
      }
    });
  }
});

$("#cancelarAgregarMantProveedores").unbind("click").click(function() {
  $("#tipoMantProveedores_agr").multiSelect('deselect_all');
  $("#sociedadMantProveedores_agr").multiSelect('deselect_all');
  $("#comunaMantProveedores_agr").multiSelect('deselect_all');
  $("#actividadMantProveedores_agr").multiSelect('deselect_all');
});

$("input[id*='_agr']").on('input', function(){
  $(this).removeClass("is-invalid");
  var idPa = $(this).parent().parent().parent().attr("aria-labelledby");
  $("#" + idPa).css("color","black");
});

$("input[id*='_upd']").on('input', function(){
  $(this).removeClass("is-invalid");
  var idPa = $(this).parent().parent().parent().attr("aria-labelledby");
  $("#" + idPa).css("color","black");
});

$('#guardarEditarMantProveedores').unbind("click").click(async function() {
  if($("#tipoIngresoDatos").val() === "1"){
    if($("#rutMantProveedores_upd").val() === "" || $("#contactoMantProveedores_upd").val() === "" || $("#emailMantProveedores_upd").val() === "" || $("#nombreMantProveedores_upd").val() === "" || $("#fonoMantProveedores_upd").val() === "" || $("#direccionMantProveedores_upd").val() === ""){
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos básicos marcados en rojo");
      if($("#fonoMantProveedores_upd").val() === ""){
        $("#fonoMantProveedores_upd").addClass("is-invalid");
        var idPa = $("#fonoMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
        $("#" + idPa).css("color","red");
      }
      if($("#emailMantProveedores_upd").val() === ""){
        $("#emailMantProveedores_upd").addClass("is-invalid");
        var idPa = $("#emailMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
        $("#" + idPa).css("color","red");
      }
      if($("#contactoMantProveedores_upd").val() === ""){
        $("#contactoMantProveedores_upd").addClass("is-invalid");
        var idPa = $("#contactoMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
        $("#" + idPa).css("color","red");
      }
      if($("#nombreMantProveedores_upd").val() === ""){
        $("#nombreMantProveedores_upd").addClass("is-invalid");
        var idPa = $("#nombreMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
        $("#" + idPa).css("color","red");
      }
      if($("#rutMantProveedores_upd").val() === ""){
        $("#rutMantProveedores_upd").addClass("is-invalid");
        var idPa = $("#rutMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
        $("#" + idPa).css("color","red");
      }
      if($("#direccionMantProveedores_upd").val() === ""){
        $("#direccionMantProveedores_upd").addClass("is-invalid");
        var idPa = $("#direccionMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
        $("#" + idPa).css("color","red");
      }
    }
    else if($("#tipoMantProveedores_upd").val().length <= 0 || $("#sociedadMantProveedores_upd").val().length <= 0 || $("#comunaMantProveedores_upd").val().length <= 0 || $("#actividadMantProveedores_upd").val().length <= 0){
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar por lo menos un tipo, una sociedad, una comuna y una actividad");
      var idPa = $("#tipoMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
      $("#" + idPa).css("color","red");
    }
    else{
      var idPa = $("#tipoMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
      $("#" + idPa).css("color","black");
      $("#modalEditarMantProveedores").modal("hide");
      $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
      $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
      $('#modalAlertasSplash').modal('show');

      var table = $('#tablaMantenedorProveedores').DataTable();
      var datos = table.rows('.selected').data();

      var parametros = {
        "id": datos[0].IDCOMPRAS_PROVEEDOR,
        "bp": $("#bpMantProveedores_upd").val(),
        "rut": $("#rutMantProveedores_upd").val().replace(".","").replace(".",""),
        "nombre": $("#nombreMantProveedores_upd").val(),
        "contacto": $("#contactoMantProveedores_upd").val(),
        "email": $("#emailMantProveedores_upd").val(),
        "fono": $("#fonoMantProveedores_upd").val(),
        "direccion": $("#direccionMantProveedores_upd").val(),
        "condicion_pago": $("#condPagoMantProveedores_upd").val(),
        "moneda": $("#selectComprasProveedoresMoneda_upd").val(),
        "contrato": $("#contratoMantProveedores_upd").val(),
        "contrato_f_ini": $("#fechaInicioContratoMantProveedores_upd").val(),
        "contrato_f_fin": $("#fechaFinContratoMantProveedores_upd").val(),
        "acreditado": $("#acreditadoMantProveedores_upd").val(),
        "bloqueo": $("#bloqueoMantProveedores_upd").val(),
        "tipo": $("#tipoMantProveedores_upd").val(),
        "sociedad": $("#sociedadMantProveedores_upd").val(),
        "comuna": $("#comunaMantProveedores_upd").val(),
        "actividad": $("#actividadMantProveedores_upd").val(),
        "rutComprador": $("#compradorMantProveedores_upd").val(),
        "fechaSolicitud": $("#fechaSolicitudMantProveedores_upd").val(),
        "critico": $("#criticoMantProveedores_upd").val(),
        "plazo": $("#evalPlazoMantProveedores_upd").val(),
        "calidad": $("#evalCalidadMantProveedores_upd").val(),
        "periodo": $("#periodoEvalMantProveedores_upd").html(),
        "tipoIngreso": $("#tipoIngresoDatos").val()
      }

      await $.ajax({
        url:   'controller/editarComprasProveedor.php',
        type:  'post',
        data: parametros,
        success: async function (response) {
          var p = jQuery.parseJSON(response);
          if(p.aaData.length !== 0){
              var table = $('#tablaMantenedorProveedores').DataTable();
              var rows = table.rows( '.selected' ).remove().draw();
              await ingresaCambioProveedor(p);

              $('input:text').val('');
              $('#modalAlertasSplash').modal('hide');
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Proveedor actualizado correctamente");
              setTimeout(async function(){
                // Aqui Voy //
                var sociedadProveedor = '';
                var arraySociedadProveedor = [];
                for(var i = 0; i < table.column(14).data().unique().length; i++){
                  if(table.column(14).data().unique()[i] !== null){
                    var asc = table.column(14).data().unique()[i].split("<br>");
                    for(var j = 0; j < asc.length; j++){
                      arraySociedadProveedor.push(asc[j]);
                    }
                  }
                }

                let resultSociedad = arraySociedadProveedor.filter((item,index)=>{
                  return arraySociedadProveedor.indexOf(item) === index;
                })

                sociedadProveedor += '<option selected value="Todos">Todos</option>';
                for(var j = 0; j < resultSociedad.length; j++){
                  sociedadProveedor += '<option value="' + resultSociedad[j] + '">' + resultSociedad[j] + '</option>';
                }
                $("#sociedadMantenedorProveedores").html(sociedadProveedor);

                var tipoProveedor = '';
                var arrayTipoProveedor = [];
                for(var i = 0; i < table.column(16).data().unique().length; i++){
                  if(table.column(16).data().unique()[i] !== null){
                    var asc = table.column(16).data().unique()[i].split("<br>");
                    for(var j = 0; j < asc.length; j++){
                      arrayTipoProveedor.push(asc[j]);
                    }
                  }
                }

                let resultTipo = arrayTipoProveedor.filter((item,index)=>{
                  return arrayTipoProveedor.indexOf(item) === index;
                })

                tipoProveedor += '<option selected value="Todos">Todos</option>';
                for(var j = 0; j < resultTipo.length; j++){
                  tipoProveedor += '<option value="' + resultTipo[j] + '">' + resultTipo[j] + '</option>';
                }
                $("#tipoMantenedorProveedores").html(tipoProveedor);

                var comunaProveedor = '';
                var arrayComunaProveedor = [];
                for(var i = 0; i < table.column(13).data().unique().length; i++){
                  if(table.column(13).data().unique()[i] !== null){
                    var asc = table.column(13).data().unique()[i].split("<br>");
                    for(var j = 0; j < asc.length; j++){
                      arrayComunaProveedor.push(asc[j]);
                    }
                  }
                }

                let resultComuna = arrayComunaProveedor.filter((item,index)=>{
                  return arrayComunaProveedor.indexOf(item) === index;
                })

                comunaProveedor += '<option selected value="Todos">Todos</option>';
                for(var j = 0; j < resultComuna.length; j++){
                  comunaProveedor += '<option value="' + resultComuna[j] + '">' + resultComuna[j] + '</option>';
                }
                $("#comunaMantenedorProveedores").html(comunaProveedor);

                var actividadProveedor = '';
                var arrayActividadProveedor = [];
                for(var i = 0; i < table.column(15).data().unique().length; i++){
                  if(table.column(15).data().unique()[i] !== null){
                    var asc = table.column(15).data().unique()[i].split("<br>");
                    for(var j = 0; j < asc.length; j++){
                      arrayActividadProveedor.push(asc[j]);
                    }
                  }
                }

                let resultActividad = arrayActividadProveedor.filter((item,index)=>{
                  return arrayActividadProveedor.indexOf(item) === index;
                })

                actividadProveedor += '<option selected value="Todos">Todos</option>';
                for(var j = 0; j < resultActividad.length; j++){
                  actividadProveedor += '<option value="' + resultActividad[j] + '">' + resultActividad[j] + '</option>';
                }
                $("#actividadMantenedorProveedores").html(actividadProveedor);

                var regionProveedor = '';
                var arrayRegionProveedor = [];
                for(var i = 0; i < table.column(31).data().unique().length; i++){
                  if(table.column(31).data().unique()[i] !== null){
                    var asc = table.column(31).data().unique()[i].split("<br>");
                    for(var j = 0; j < asc.length; j++){
                      arrayRegionProveedor.push(asc[j]);
                    }
                  }
                }

                let resultRegion = arrayRegionProveedor.filter((item,index)=>{
                  return arrayRegionProveedor.indexOf(item) === index;
                })

                regionProveedor += '<option selected value="Todos">Todos</option>';
                for(var j = 0; j < resultRegion.length; j++){
                  regionProveedor += '<option value="' + resultRegion[j] + '">' + resultRegion[j] + '</option>';
                }
                $("#regionMantenedorProveedores").html(regionProveedor);

                if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                  $("#sociedadMantenedorProveedores").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                    sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
                  });
                  $("#tipoMantenedorProveedores").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  });
                  $("#comunaMantenedorProveedores").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  });
                  $("#actividadMantenedorProveedores").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  });
                  $("#regionMantenedorProveedores").select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  });
                }

                $("#tipoMantProveedores_upd").multiSelect('deselect_all');
                $("#sociedadMantProveedores_upd").multiSelect('deselect_all');
                $("#comunaMantProveedores_upd").multiSelect('deselect_all');
                $("#actividadMantProveedores_upd").multiSelect('deselect_all');

                $("#agregarMantenedorProveedores").removeAttr("disabled");
                $("#editarMantenedorProveedores").attr("disabled","disabled");
                $("#eliminarMantenedorProveedores").attr("disabled","disabled");
                $("#asignarCompMantenedorProveedores").attr("disabled","disabled");

                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },2000);
              },500);
            }
          else{
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible actualizar el proveedor, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalEditarMantProveedores").modal("show");
            },500);
          }
        }
      });
    }
  }
  else if($("#tipoIngresoDatos").val() === "2"){
    if($("#evalPlazoMantProveedores_upd").val() === "" || $("#evalPlazoMantProveedores_upd").val() === "0" || $("#evalCalidadMantProveedores_upd").val() === "" || $("#evalCalidadMantProveedores_upd").val() === "0"){
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos de plazo y calidad distintos a 0");
      if($("#evalPlazoMantProveedores_upd").val() === "" || $("#evalPlazoMantProveedores_upd").val() === "0"){
        $("#evalPlazoMantProveedores_upd").addClass("is-invalid");
        var idPa = $("#evalPlazoMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
        $("#" + idPa).css("color","red");
      }
      if($("#evalCalidadMantProveedores_upd").val() === "" || $("#evalCalidadMantProveedores_upd").val() === "0"){
        $("#evalCalidadMantProveedores_upd").addClass("is-invalid");
        var idPa = $("#evalCalidadMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
        $("#" + idPa).css("color","red");
      }
    }
    else{
      var idPa = $("#tipoMantProveedores_upd").parent().parent().parent().attr("aria-labelledby");
      $("#" + idPa).css("color","black");
      $("#modalEditarMantProveedores").modal("hide");
      $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
      $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
      $('#modalAlertasSplash').modal('show');

      var table = $('#tablaMantenedorProveedores').DataTable();
      var datos = table.rows('.selected').data();

      var parametros = {
        "id": datos[0].IDCOMPRAS_PROVEEDOR,
        "bp": $("#bpMantProveedores_upd").val(),
        "rut": $("#rutMantProveedores_upd").val().replace(".","").replace(".",""),
        "nombre": $("#nombreMantProveedores_upd").val(),
        "contacto": $("#contactoMantProveedores_upd").val(),
        "email": $("#emailMantProveedores_upd").val(),
        "fono": $("#fonoMantProveedores_upd").val(),
        "direccion": $("#direccionMantProveedores_upd").val(),
        "condicion_pago": $("#condPagoMantProveedores_upd").val(),
        "moneda": $("#selectComprasProveedoresMoneda_upd").val(),
        "contrato": $("#contratoMantProveedores_upd").val(),
        "contrato_f_ini": $("#fechaInicioContratoMantProveedores_upd").val(),
        "contrato_f_fin": $("#fechaFinContratoMantProveedores_upd").val(),
        "acreditado": $("#acreditadoMantProveedores_upd").val(),
        "bloqueo": $("#bloqueoMantProveedores_upd").val(),
        "tipo": $("#tipoMantProveedores_upd").val(),
        "sociedad": $("#sociedadMantProveedores_upd").val(),
        "comuna": $("#comunaMantProveedores_upd").val(),
        "actividad": $("#actividadMantProveedores_upd").val(),
        "rutComprador": $("#compradorMantProveedores_upd").val(),
        "fechaSolicitud": $("#fechaSolicitudMantProveedores_upd").val(),
        "critico": $("#criticoMantProveedores_upd").val(),
        "plazo": $("#evalPlazoMantProveedores_upd").val(),
        "calidad": $("#evalCalidadMantProveedores_upd").val(),
        "periodo": $("#periodoEvalMantProveedores_upd").html(),
        "tipoIngreso": $("#tipoIngresoDatos").val()
      }

      await $.ajax({
        url:   'controller/editarComprasProveedor.php',
        type:  'post',
        data: parametros,
        success: async function (response) {
          var p = jQuery.parseJSON(response);
          if(p.aaData.length !== 0){
              var table = $('#tablaMantenedorProveedores').DataTable();
              var rows = table.rows( '.selected' ).remove().draw();
              await ingresaCambioProveedor(p);

              $('input:text').val('');
              $('#modalAlertasSplash').modal('hide');
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Proveedor actualizado correctamente");
              setTimeout(async function(){
                var sociedadProveedor = '';
                var arraySociedadProveedor = [];
                for(var i = 0; i < table.column(14).data().unique().length; i++){
                  if(table.column(14).data().unique()[i] !== null){
                    var asc = table.column(14).data().unique()[i].split("<br>");
                    for(var j = 0; j < asc.length; j++){
                      arraySociedadProveedor.push(asc[j]);
                    }
                  }
                }

                let resultSociedad = arraySociedadProveedor.filter((item,index)=>{
                  return arraySociedadProveedor.indexOf(item) === index;
                })

                sociedadProveedor += '<option selected value="Todos">Todos</option>';
                for(var j = 0; j < resultSociedad.length; j++){
                  sociedadProveedor += '<option value="' + resultSociedad[j] + '">' + resultSociedad[j] + '</option>';
                }
                $("#sociedadMantenedorProveedores").html(sociedadProveedor);

                var tipoProveedor = '';
                var arrayTipoProveedor = [];
                for(var i = 0; i < table.column(16).data().unique().length; i++){
                  if(table.column(16).data().unique()[i] !== null){
                    var asc = table.column(16).data().unique()[i].split("<br>");
                    for(var j = 0; j < asc.length; j++){
                      arrayTipoProveedor.push(asc[j]);
                    }
                  }
                }

                let resultTipo = arrayTipoProveedor.filter((item,index)=>{
                  return arrayTipoProveedor.indexOf(item) === index;
                })

                tipoProveedor += '<option selected value="Todos">Todos</option>';
                for(var j = 0; j < resultTipo.length; j++){
                  tipoProveedor += '<option value="' + resultTipo[j] + '">' + resultTipo[j] + '</option>';
                }
                $("#tipoMantenedorProveedores").html(tipoProveedor);

                var comunaProveedor = '';
                var arrayComunaProveedor = [];
                for(var i = 0; i < table.column(13).data().unique().length; i++){
                  if(table.column(13).data().unique()[i] !== null){
                    var asc = table.column(13).data().unique()[i].split("<br>");
                    for(var j = 0; j < asc.length; j++){
                      arrayComunaProveedor.push(asc[j]);
                    }
                  }
                }

                let resultComuna = arrayComunaProveedor.filter((item,index)=>{
                  return arrayComunaProveedor.indexOf(item) === index;
                })

                comunaProveedor += '<option selected value="Todos">Todos</option>';
                for(var j = 0; j < resultComuna.length; j++){
                  comunaProveedor += '<option value="' + resultComuna[j] + '">' + resultComuna[j] + '</option>';
                }
                $("#comunaMantenedorProveedores").html(comunaProveedor);

                var actividadProveedor = '';
                var arrayActividadProveedor = [];
                for(var i = 0; i < table.column(15).data().unique().length; i++){
                  if(table.column(15).data().unique()[i] !== null){
                    var asc = table.column(15).data().unique()[i].split("<br>");
                    for(var j = 0; j < asc.length; j++){
                      arrayActividadProveedor.push(asc[j]);
                    }
                  }
                }

                let resultActividad = arrayActividadProveedor.filter((item,index)=>{
                  return arrayActividadProveedor.indexOf(item) === index;
                })

                actividadProveedor += '<option selected value="Todos">Todos</option>';
                for(var j = 0; j < resultActividad.length; j++){
                  actividadProveedor += '<option value="' + resultActividad[j] + '">' + resultActividad[j] + '</option>';
                }
                $("#actividadMantenedorProveedores").html(actividadProveedor);

                var regionProveedor = '';
                var arrayRegionProveedor = [];
                for(var i = 0; i < table.column(31).data().unique().length; i++){
                  if(table.column(31).data().unique()[i] !== null){
                    var asc = table.column(31).data().unique()[i].split("<br>");
                    for(var j = 0; j < asc.length; j++){
                      arrayRegionProveedor.push(asc[j]);
                    }
                  }
                }

                let resultRegion = arrayRegionProveedor.filter((item,index)=>{
                  return arrayRegionProveedor.indexOf(item) === index;
                })

                regionProveedor += '<option selected value="Todos">Todos</option>';
                for(var j = 0; j < resultRegion.length; j++){
                  regionProveedor += '<option value="' + resultRegion[j] + '">' + resultRegion[j] + '</option>';
                }
                $("#regionMantenedorProveedores").html(regionProveedor);

                if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                  $("#sociedadMantenedorProveedores").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                    sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
                  });
                  $("#tipoMantenedorProveedores").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  });
                  $("#comunaMantenedorProveedores").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  });
                  $("#actividadMantenedorProveedores").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  });
                  $("#regionMantenedorProveedores").select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  });
                }

                $("#tipoMantProveedores_upd").multiSelect('deselect_all');
                $("#sociedadMantProveedores_upd").multiSelect('deselect_all');
                $("#comunaMantProveedores_upd").multiSelect('deselect_all');
                $("#actividadMantProveedores_upd").multiSelect('deselect_all');

                $("#agregarMantenedorProveedores").removeAttr("disabled");
                $("#editarMantenedorProveedores").attr("disabled","disabled");
                $("#eliminarMantenedorProveedores").attr("disabled","disabled");
                $("#asignarCompMantenedorProveedores").attr("disabled","disabled");

                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },2000);
              },500);
            }
          else{
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible actualizar el proveedor, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalEditarMantProveedores").modal("show");
            },500);
          }
        }
      });
    }
  }
});

$('#guardarEliminarMantProveedores').unbind("click").click(async function() {
  $('#modalEliminarMantProveedores').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $('#tablaMantenedorProveedores').DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    "idProveedor": datos[0].IDCOMPRAS_PROVEEDOR
  }

  await $.ajax({
    url:   'controller/eliminarComprasProveedor.php',
    type:  'post',
    data:  parametros,
    success: async function (response) {
      var p = response.split(",")
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorProveedores').DataTable();
            table.rows( '.selected' ).remove().draw();
            $('input:text').val('');
            $('#modalAlertasSplash').modal('hide');
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Prveedor eliminado correctamente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#editarMantenedorProveedores").attr("disabled", "disabled");
              $("#eliminarMantenedorProveedores").attr("disabled", "disabled");
      				$("#asignarCompMantenedorProveedores").attr("disabled", "disabled");
            },500);
          }
          else{
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible eliminar el proveedor, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalAgregarMantProveedores").modal("show");
            },500);
          }
      }
      else{
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible eliminar el proveedor, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalAgregarMantProveedores").modal("show");
        },500);
      }
    }
  });
});

async function cargarComprasServicios() {
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  await $('#tablaMantenedorServicios').DataTable({
    ajax: {
      url: "controller/datosComprasServicios.php",
      type: 'POST',
      data: {}
    },
    columns: [
      { data: 'S'},
      { data: 'FOLIO', className: "centerDataTable"},
      { data: 'CODIGO' },
      { data: 'NOMBRE' },
      { data: 'MARCA' },
      { data: 'MODELO' },
      { data: 'TIPO' },
      { data: 'PRECIO_MIN' },
      { data: 'PRECIO_MAX' },
      { data: 'POTENCIA' },
      { data: 'PESO' },
      { data: 'CAPACIDAD' },
      { data: 'AREA_M2' },
      { data: 'ANCHO' },
      { data: 'ALTO' },
      { data: 'LARGO' },
      { data: 'TEMPERATURA' },
      { data: 'HUMEDAD' },
      { data: 'PRECISION' },
      { data: 'UNIDAD_MEDIDA' },
      { data: 'GESTION' },
      { data: 'FINANZAS' },
      { data: 'EMPRESA' }
    ],
    buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        },
        {
          text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
          action: function ( e, dt, node, config ) {
            var table = $('#tablaMantenedorServicios').DataTable();
            $("#editarMantenedorServicio").attr("disabled","disabled");
            $("#eliminarMantenedorServicio").attr("disabled","disabled");
            $("#masivoMantenedorServicio").attr("disabled","disabled");
            table.rows().deselect();
          }
        },
        {
          text: '<span class="fas fa-arrow-alt-circle-down" id="spanButtonfiltrosComprasServicio"></span>&nbsp;&nbsp;Filtros',
          action: function(){
            if($("#filtrosComprasServicio").height() > 60){
              $("#filtrosComprasServicio").css("height","0");
              $("#filtrosComprasServicio").fadeOut();
              $("#spanButtonfiltrosComprasServicio").removeClass("fas fa-arrow-alt-circle-up");
              $("#spanButtonfiltrosComprasServicio").addClass("fas fa-arrow-alt-circle-down");
            }
            else{
              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#filtrosComprasServicio").css("height","100pt");
              }
              else{
                $("#filtrosComprasServicio").css("height","210pt");
              }
              $("#filtrosComprasServicio").fadeIn();
              $("#spanButtonfiltrosComprasServicio").removeClass("fas fa-arrow-alt-circle-down");
              $("#spanButtonfiltrosComprasServicio").addClass("fas fa-arrow-alt-circle-up");
            }
          }
        }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      }
    ],
    "select": {
      style: 'single',
    },
    // fixedColumns:   {
    //   leftColumns: 4
    // },
    "processing": true,
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "order": [[ 1, "desc" ]],
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json) {
      var table = $('#tablaMantenedorServicios').DataTable();

      var marcaMantSer = '';
      marcaMantSer += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(4).data().unique().length; i++){
        if(table.column(4).data().unique()[i] !== null){
          marcaMantSer += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
        }
      }
      $("#marcaMantenedorServicios").html(marcaMantSer);

      var modeloMantSer = '';
      modeloMantSer += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(5).data().unique().length; i++){
        if(table.column(5).data().unique()[i] !== null){
          modeloMantSer += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
        }
      }
      $("#modeloMantenedorServicios").html(modeloMantSer);

      var tipoMantSer = '';
      tipoMantSer += '<option selected value="Todos">Todos</option>';
      for(var i = 0; i < table.column(6).data().unique().length; i++){
        if(table.column(6).data().unique()[i] !== null){
          tipoMantSer += '<option value="' + table.column(6).data().unique()[i] + '">' + table.column(6).data().unique()[i] + '</option>';
        }
      }
      $("#tipoMantenedorServicios").html(tipoMantSer);

      $('#contenido').show();
      $('#menu-lateral').show();
      $('#footer').parent().show();
$('#footer').show();

      if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        $("#marcaMantenedorServicios").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $("#modeloMantenedorServicios").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $("#tipoMantenedorServicios").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
      }
      esconderMenu();
      menuElegant();
      setTimeout(async function(){
        $('#tablaMantenedorServicios').DataTable().columns.adjust();
        $("#filtrosComprasServicio").css("height","0");
        $("#filtrosComprasServicio").fadeOut();
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      },1500);
    }
  });

  await $.ajax({
    url:   'controller/datosAccionesVisibles.php',
    type:  'post',
    data: {
      "path": window.location.href.split('#/')[1]
    },
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++) {
          if(p.aaData[i].VISIBLE == 1){
            if(p.aaData[i].ENABLE == 1){
              $("#accionesMantenedorServicios").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
            else{
              $("#accionesMantenedorServicios").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button disabled class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
          }
        }
      }
    }
  });

  setTimeout(function(){
    var js = document.createElement('script');
    js.src = 'view/js/funciones.js?idLoad=205';
    document.getElementsByTagName('head')[0].appendChild(js);
  },500);
}

$("#asignarTarjetaCombustible").unbind("click").click( function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaTarjetaCombustible').DataTable();
  var n = $.map(table.rows('.selected').data(), function (item) {
      return item.NUMERO;
  });
  var e = $.map(table.rows('.selected').data(), function (item) {
      return item.ESTADO;
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#patenteTarjetaAsignar").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#estadoTarjetaAsignar").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  $.ajax({
      url:   'controller/datosPatentesSinTarjeta.php',
      type:  'post',
      success:  function (response) {
          if(response.localeCompare("Sin datos") != 0 && response != ""){
              var p = jQuery.parseJSON(response);
              if(p.aaData.length !== 0){
                  var cuerpoPatenteSinTarjeta = "";
                  for(var i = 0; i < p.aaData.length; i++){
                     cuerpoPatenteSinTarjeta = cuerpoPatenteSinTarjeta + "<option value=" + p.aaData[i].CODIGO + ">"  + p.aaData[i].CODIGO + "</option>";
                  }
                  $("#patenteTarjetaAsignar").html(cuerpoPatenteSinTarjeta);
                  var parametros = {
                    'codigo': $("#patenteTarjetaAsignar").val()
                  };
                  $("#flotaVehiculoTarSel").html(parametros['codigo']);
                  var datosVehiculo;
                  $.ajax({
                    url:   'controller/datosFlotaVehiculoPatenteCantAsig.php',
                    type:  'post',
                    data:  parametros,
                    success:  function (response) {
                      var datosVehiculo;
                    if(response.localeCompare("Sin datos") != 0 && response != ""){
                        datosVehiculo = jQuery.parseJSON(response);
                        $("#flotaVehiculoTarAsig").html(datosVehiculo.aaData[0].ASIGNADA);
                        $("#flotaVehiculoTarBack").html(datosVehiculo.aaData[0].BACKUP);
                        $("#TarjetaCantAsignadas").val(datosVehiculo.aaData[0].ASIGNADA);
                        $("#TarjetaCantBackup").val(datosVehiculo.aaData[0].BACKUP);
                      }
                    }
                  });
                  $.ajax({
                    url:   'controller/datosTarjetaEstado.php',
                    type:  'post',
                    success:  function (response) {
                        if(response.localeCompare("Sin datos") != 0 && response != ""){
                            var p = jQuery.parseJSON(response);
                            if(p.aaData.length !== 0){
                                var cuerpoTarjetaEstado = "";
                                for(var i = 0; i < p.aaData.length; i++){
                                    if(e[0] === "Backup"){
                                      if(p.aaData[i].ESTADO === 'Asignada'){
                                        cuerpoTarjetaEstado = cuerpoTarjetaEstado + "<option value=" + p.aaData[i].ESTADO + ">"  + p.aaData[i].ESTADO + "</option>";
                                      }
                                    }
                                    else{
                                      if(p.aaData[i].ESTADO === 'Asignada' || p.aaData[i].ESTADO === 'Backup'){
                                        cuerpoTarjetaEstado = cuerpoTarjetaEstado + "<option value=" + p.aaData[i].ESTADO + ">"  + p.aaData[i].ESTADO + "</option>";
                                      }
                                    }
                                }
                                $("#estadoTarjetaAsignar").html(cuerpoTarjetaEstado);
                            }
                        }
                    }
                });
              }
          }
      }
  });
  $("#numeroTarjetaAsignar").val(n[0]);
  if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    var h = $(window).height() - 200;
    $("#bodyTarjetaAsignar").css("height",h);
  }
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalTarjetaAsignar").modal("show");
  },500);
});

$("#patenteTarjetaAsignar").unbind('click').change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalTarjetaAsignar").modal("hide");
  var parametros = {
      'codigo': $("#patenteTarjetaAsignar").val()
    };
    $("#flotaVehiculoTarSel").html(parametros['codigo']);
    var datosVehiculo;
    $.ajax({
      url:   'controller/datosFlotaVehiculoPatenteCantAsig.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
      if(response.localeCompare("Sin datos") != 0 && response != ""){
        console.log(response);
          datosVehiculo = jQuery.parseJSON(response);
          $("#flotaVehiculoTarAsig").html(datosVehiculo.aaData[0].ASIGNADA);
          $("#flotaVehiculoTarBack").html(datosVehiculo.aaData[0].BACKUP);
          $("#TarjetaCantAsignadas").val(datosVehiculo.aaData[0].ASIGNADA);
          $("#TarjetaCantBackup").val(datosVehiculo.aaData[0].BACKUP);

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalTarjetaAsignar").modal("show");
          },500);
        }
        else{
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalTarjetaAsignar").modal("show");
          },500);
        }
      }
    });
});

$("#guardarTarjetaAsignar").unbind('click').click(function(){
  var table = $('#tablaTarjetaCombustible').DataTable();
  var n = $.map(table.rows('.selected').data(), function (item) {
      return item.NUMERO;
  });
  var p = $.map(table.rows('.selected').data(), function (item) {
      return item.PRODUCTO;
  });
  var parametros = {
    "numero": n[0],
    "producto": p[0],
    "estado": $("#estadoTarjetaAsignar").val(),
    "patente": $("#patenteTarjetaAsignar").val()
  };
  if($("#TarjetaCantAsignadas").val() === '1' && $("#estadoTarjetaAsignar").val() === "Asignada"){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Esta patente ya posee una tarjeta asignada");
  }
  else if($("#TarjetaCantBackup").val() === '1' && $("#estadoTarjetaAsignar").val() === "Backup"){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Esta patente ya posee una tarjeta backup");
  }
  else{
    $("#modalTarjetaAsignar").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    // console.log(parametros);
    // console.log($("#flotaVehiculoTarAsig").val());
    $.ajax({
      data:  parametros,
      url:   'controller/asignarTarjeta.php',
      type:  'post',
      success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                var table = $('#tablaTarjetaCombustible').DataTable();
                table.ajax.reload();
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Tarjeta asignada correctamente");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar tarjeta, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar tarjeta, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
      });
  }
});

$("#proyectoOrdenAsignada,#comunaOrdenAsignada,#categoriaOrdenAsignada,#tipoOrdenAsignada,#técnicoOrdenAsignada").unbind("click").change(function(){
  clearInterval(lineaTiempo);
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  //initialize the plugin and get its instance
  var instance = OverlayScrollbars(document.getElementById('contenido'), { });

  //destroy the instance
  instance.destroy();

  dibujaTimelineSeleccionado($("#fechaOrdenesAsignadas").val());

  lineaTiempo = setInterval(function () {
    dibujaTimelineSeleccionado($("#fechaOrdenesAsignadas").val());
  }, 60000);

  setTimeout(async function(){
    $('#modalAlertasSplash').modal('hide');
    menuElegant();
  },2000);
});

async function dibujaTimelineSeleccionado(fecha){
  var tiempo;

  if(fecha === moment().format('YYYY-MM-DD').toString()){
    momentoActual = new Date();
    hora = momentoActual.getHours() + 10;
    minuto = momentoActual.getMinutes();
    segundo = momentoActual.getSeconds();

    if(hora < 10){
      hora = '0' + hora;
    }
    if(minuto < 10){
      minuto = '0' + minuto;
    }
    if(segundo < 10){
      segundo = '0' + segundo;
    }
    tiempo = hora + ":" + minuto;
  }
  else{
    hora = '23';
    minuto = '59';
    segundo = '59';
    tiempo = '23:59';
  }

  function MarcarHoy (div, filaActual){
    var altura = 0;
    $('#'+div+' rect').each(function( index ) {
      yValor = parseFloat($(this).attr('y'));
      xValor = parseFloat($(this).attr('x'));
      if ( yValor == 0 && yValor == 0 ) { altura = parseFloat($(this).attr('height')) };
    });
    $('#'+div+' text:contains(' + tiempo +')').css('font-size','11px').attr('fill','#A6373C').prev().first().attr('height',altura+'px').attr('width','1px').attr('y','0');

    $('#'+div+' text:contains("Hora actual")').css('font-size','11px').attr('fill','#A6373C').prev().first().attr('y','0');

    if (filaActual != -1) {
      if ( 0 == filaActual )
        $('.google-visualization-tooltip').css('display','none');
      else
        $('.google-visualization-tooltip').css('display','inline');
    }
  }

  google.charts.load('current', {'packages':['timeline']});
  google.charts.setOnLoadCallback(drawChart2);

  function drawChart2() {
    var container = document.getElementById('timelineOrdenesAsignadas');
    var chart = new google.visualization.Timeline(container);
    var dataTable = new google.visualization.DataTable();

    dataTable.addColumn({ type: 'string', id: 'TAC' });
    dataTable.addColumn({ type: 'string', id: 'Tipo' });
    dataTable.addColumn({ type: 'string', id: 'style', role: 'style' });
    dataTable.addColumn({ type: 'date', id: 'Inicio' });
    dataTable.addColumn({ type: 'date', id: 'Fin' });
    dataTable.addColumn({ type: 'string', role: 'tooltip', id: 'Id' });

    dataTable.addRows([
      ['Hora actual', tiempo, 'red', new Date(0,0,0,hora,minuto,segundo),  new Date(0,0,0,hora,minuto,segundo), 'hoy'],
    ]);

    var parametros = {
      "fecha": fecha,
      "path": window.location.href.split('#/')[1],
      "idestructura": $("#proyectoOrdenAsignada").val(),
      "idareafuncional": $("#comunaOrdenAsignada").val(),
      "idcategoria":  $("#categoriaOrdenAsignada").val(),
      "idtipo": $("#tipoOrdenAsignada").val(),
      "idtecnico": $("#técnicoOrdenAsignada").val()
    }

    let comunaOrAs = [];
    let categoriaOrAs = [];
    let tipoOrAs = [];
    let tecnicoOrAs = [];
    let proyectoOrAs = [];

    $.ajax({
      url:   'controller/datosOrdenesTimeline.php',
      type:  'post',
      data: parametros,
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        if(p2.aaData.length !== 0){
          for(var i = 0; i < p2.aaData.length; i++){
            comunaOrAs.push(p2.aaData[i].IDAREAFUNCIONAL + ',' + p2.aaData[i].COMUNA);
            categoriaOrAs.push(p2.aaData[i].IDORDEN_CATEGORIA + ',' + p2.aaData[i].CATEGORIA);
            tipoOrAs.push(p2.aaData[i].IDORDEN_TIPO + ',' + p2.aaData[i].TIPO);
            tecnicoOrAs.push(p2.aaData[i].IDTECNICO + ',' + p2.aaData[i].NOMBRE);
            proyectoOrAs.push(p2.aaData[i].IDESTRUCTURA_OPERACION + ',' + p2.aaData[i].PROYECTO);
            dataTable.addRows([[
              '(' + p2.aaData[i].COMUNA + ') ' + p2.aaData[i].NOMBRE,
              p2.aaData[i].TIPO.substring(0,2) + '-' + p2.aaData[i].FOLIO,
              p2.aaData[i].COLOR,
              new Date(0,0,0,p2.aaData[i].HORA_INICIO,p2.aaData[i].MIN_INICIO,p2.aaData[i].SEC_INICIO),
              new Date(0,0,0,p2.aaData[i].HORA_FIN,p2.aaData[i].MIN_FIN,p2.aaData[i].SEC_FIN),
              p2.aaData[i].FOLIO
            ]]);
          }

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#comunaOrdenAsignada").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#categoriaOrdenAsignada").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#tipoOrdenAsignada").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#técnicoOrdenAsignada").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#proyectoOrdenAsignada").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }

          var options = {
            timeline: {
              rowLabelStyle: {
                fontSize: 12,
                color: 'black'
              },
              barLabelStyle: {
                fontSize: 12
              }
            },
            avoidOverlappingGridLines: false,
            enableInteractivity: true
          };

          chart.draw(dataTable, options);
          MarcarHoy('timelineOrdenesAsignadas',-1);

          google.visualization.events.addListener(chart, 'onmouseover', function(obj) {
            MarcarHoy('timelineOrdenesAsignadas',obj.row);
          });

          google.visualization.events.addListener(chart, 'onmouseout', function(obj) {
            MarcarHoy('timelineOrdenesAsignadas',-1);
          });

          google.visualization.events.addListener(chart, 'select', function () {
            var selection = chart.getSelection();
            if (selection.length > 0 && dataTable.getValue(selection[0].row, 5) !== 'hoy') {
              // console.log(dataTable.getValue(selection[0].row,0));
              // console.log(dataTable.getValue(selection[0].row,1));
              // console.log(dataTable.getValue(selection[0].row,2));
              // console.log(dataTable.getValue(selection[0].row,3));
              // console.log(dataTable.getValue(selection[0].row,4));
              // console.log(dataTable.getValue(selection[0].row,5));
            }
            MarcarHoy('timelineOrdenesAsignadas',-1);
          });

          var observer = new MutationObserver(setBorderRadius);
          google.visualization.events.addListener(chart, 'ready', function () {
            setBorderRadius();
            observer.observe(container, {
              childList: true,
              subtree: true
            });
            MarcarHoy('timelineOrdenesAsignadas',-1);
          });

          function setBorderRadius() {
            Array.prototype.forEach.call(container.getElementsByTagName('rect'), function (rect) {
              if (parseFloat(rect.getAttribute('x')) > 0) {
                rect.setAttribute('rx', 10);
                rect.setAttribute('ry', 10);
              }
            });
          }

          chart.clearChart();
          chart.draw(dataTable, options);

          esconderMenu();
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
}

$("#historialOrden").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaOrdenes').DataTable();
  var datos = table.rows('.selected').data();
  $("#cuerpoDetalleOrdenAtc").empty();
  $("#tituloDetalleOrdenAtc").empty();

  $("#tituloDetalleOrdenAtc").append('<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="margin-bottom: 10px;"><h5 style="color:gray; font-weight: bold;"><span class="far fa-list-alt"></span>&nbsp;&nbsp;<span>Detalle de orden</span></h5></div>');
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>ID Orden:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].IDORDEN + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Proyecto:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].PROYECTO + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Folio ext:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].FOLIO + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Comuna:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].COMUNA + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Categoria:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].CATEGORIA + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Dirección:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].DIRECCIONLIMPIA + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Tipo:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].TIPO + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Cliente:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].DNI_CLIENTE + ' / ' + datos[0].NOMBRE_CLIENTE + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Tecnología:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].TECNOLOGIA + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Fono cliente:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].FONO_CLIENTE + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Estado:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].ESTADO + ' / ' + datos[0].SUB_ESTADO + "</label></div></div></div>");
  $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>F. Agenda:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].FECHA_AGENDA + ' ' + datos[0].HORA_AGENDA + "</label></div></div></div>");

  if(datos[0].DNI_DESPACHO != null){
    $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Despacho:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].DNI_DESPACHO + ' / ' + datos[0].DESPACHO + "</label></div></div></div>");
  }
  else{
    $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Despacho:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>Sin asignar</label></div></div></div>");
  }
  if(datos[0].RUT_TECNICO != null){
    $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Técnico:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>" + datos[0].RUT_TECNICO + ' / ' + datos[0].TECNICO + "</label></div></div></div>");
  }
  else{
    $("#cuerpoDetalleOrdenAtc").append("<div style='padding-bottom: 0;' class='col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12'><div style='padding-bottom: 0;' class='row'><div style='padding-bottom: 0; font-weight: bold;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><label>Técnico:</label></div><div style='padding-bottom: 0;' class='col-xl-8 col-lg-8 col-md-12 col-sm-12 col-xs-12'><label>Sin asignar</label></div></div></div>");
  }

  var h = $(window).height() - 300;
  var largo = Math.trunc(($(window).height() - 150 - ($(window).height()/100)*50)/30);
  // console.log(largo);

  await $('#tablaDetalleOrdenAtc').DataTable( {
      ajax: {
          url: "controller/datosDetalleOrdenAtc.php",
          type: 'POST',
          data: {
            "idorden": datos[0].IDORDEN
          }
      },
      columns: [
          { data: 'S'},
          { data: 'IDORDEN_HISTORIAL'},
          { data: 'FECHA', render: $.fn.dataTable.render.moment( 'YYYY-MM-DD', 'DD-MM-YYYY' )},
          { data: 'HORA'},
          { data: 'HISTORIA'},
          { data: 'OBSERVACION', className: "centerDataTable"},
          { data: 'EJECUTOR'},
          { data: 'ESTADO'},
          { data: 'SUB_ESTADO'},
          { data: 'TECNICO'},
          { data: 'DESPACHO'},
      ],
      buttons: [
          {
            extend: 'excel',
            exportOptions: {
              columns: [ 1,	2,	3,	4,	5,	6,	7,	8, 9, 10 ]
            },
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        }
      ],
      "select": {
          style: 'single'
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "order": [[ 1, "desc" ]],
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": true,
      "initComplete": function( settings, json){
        setTimeout(function(){
          $("#bodyDetalleOrdenAtc").css("height",h);
          $("#modalDetalleOrdenAtc").modal("show");
          $('#modalAlertasSplash').modal('hide');
          setTimeout(function(){
            $('#tablaDetalleOrdenAtc').DataTable().columns.adjust();
          },500);
        },2000);
      }
  });
});

async function obras_cubicacion(folio,oecf,codCub,agencia){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalCaratulaObras').modal('hide');
  $('#modalAlertasSplash').modal('show');

  $("#folioObraDetalleCubicacion").html('Folio: ' + folio + "   |   Agencia: " + agencia);
  $("#oeDetalleCubicacion").html('Orden de ejecución: ' + oecf);
  $("#codigoCubDetalleCubicacion").html('Código de cubicación: ' + codCub);

  var parametros = {
    "idobra": folio
  }
  var idTablaCub = 'tablaDetalleCubicacion';
  await detalleCub(folio,idTablaCub);
}

$("#periodoSolCombustible").unbind("click").change(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  var parametros = {
    "ano": $("#periodoSolCombustible").val().split("-")[0],
    "mes": $("#periodoSolCombustible").val().split("-")[1]
  }

  await $('#tablaListadoSolCombustible').DataTable( {
      ajax: {
          url: "controller/datosListaSolCombustible.php",
          type: 'POST',
          data: parametros,
      },
      columns: [
        { data: 'S'},
        { data: 'IDCARGA_SOLICITADA', className: "centerDataTable" },
        { data: 'ESTADO_CARGA'},
        { data: 'CARGA_TIPO', className: "centerDataTable"},
        { data: 'NOMBRE'},
        { data: 'RUT'},
        { data: 'PATENTE'},
        { data: 'TARJETA' },
        { data: 'PRODUCTO' },
        { data: 'TIPO'},
        { data: 'BODEGA'},
        { data: 'FECHA_SOLICITUD', className: "centerDataTable"},
        { data: 'HORA_SOLICITUD' , className: "centerDataTable"},
        { data: 'FECHA_VALIDACION', className: "centerDataTable"},
        { data: 'HORA_VALIDACION', className: "centerDataTable"},
        { data: 'RUT_USUARIO'},
        { data: 'MONTO', render: $.fn.dataTable.render.number( '', '.', 0, '$ ' ), className: "centerDataTable"},
        { data: 'MONTO_VALIDADO', render: $.fn.dataTable.render.number( '', '.', 0, '$ ' ), className: "centerDataTable"}
      ],
      buttons: [
          {
            extend: 'excel',
            exportOptions: {
              columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]
            },
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          }
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        },
      ],
      "select": {
          style: 'single'
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'Bfrtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function(){
        setTimeout(function(){
          var table = $('#tablaListadoSolCombustible').DataTable();
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
$('#footer').show();

          var estadodSel = '';
          estadodSel += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(2).data().unique().length; i++){
            if(table.column(2).data().unique()[i] !== null){
              estadodSel += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
            }
          }
          $("#estadoSolicitudCombustible").html(estadodSel);

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#estadoSolicitudCombustible").select2('destroy').select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          }

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        },500);
      }
  });
});

$("#estadoSolicitudCombustible").unbind("click").change(function(){
  var table = $("#tablaListadoSolCombustible").DataTable();
  var estado = $("#estadoSolicitudCombustible").val();
  if(estado == "Todos"){
    estado = '';
  }
  table.rows('').deselect();
  table.columns('2').search(estado).draw();
});

$("#validarSolCombustible").unbind('click').click(function(){
  $("#modalFlotaTarjetaSolCarga").find("input,textarea,select").val("");
  $("#obsValidarSolCombustible2").val("");
  var table = $('#tablaListadoSolCombustible').DataTable();
  var datos = table.rows('.selected').data();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#rutValidarSolCombustible").val(datos[0].RUT);
  $("#nombreValidarSolCombustible").val(datos[0].NOMBRE);
  $("#estadoValidarSolCombustible").val(datos[0].ESTADO_GESTPER2);
  $("#patenteValidarSolCombustible").val(datos[0].PATENTE);
  $("#tarjetaValidarSolCombustible").val(datos[0].TARJETA);
  $("#productoValidarSolCombustible").val(datos[0].PRODUCTO);
  $("#tipoValidarSolCombustible").val(datos[0].TIPO);
  $("#bodegaValidarSolCombustible").val(datos[0].BODEGA);
  $("#montoValidarSolCombustible").val(datos[0].MONTO);
  $("#obsValidarSolCombustible1").val(datos[0].OBSERVACION);
  setTimeout(async function(){
    $("#modalValidarSolCombustible").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#guardarValidarSolCombustible").unbind('click').click(async function(){
  if($.trim($("#montoValidarSolCombustible").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#montoValidarSolCombustible").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalValidarSolCombustible").modal("hide");
    var table = $('#tablaListadoSolCombustible').DataTable();
    var tarjeta = $.map(table.rows('.selected').data(), function (item) {
      return item.TARJETA;
    });
    var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE;
    });
    var cargaTipo = $.map(table.rows('.selected').data(), function (item) {
      return item.CARGA_TIPO;
    });
    var idSolicitud = $.map(table.rows('.selected').data(), function (item) {
      return item.IDCARGA_SOLICITADA;
    });

    parametros = {
      "tarjeta": tarjeta[0],
      "idSolicitud": idSolicitud[0],
      "cargaTipo": cargaTipo[0],
      "patente": patente[0],
      "monto": $("#montoValidarSolCombustible").val(),
      "observacion": $("#obsValidarSolCombustible2").val()
    }

    await $.ajax({
      url: "controller/actualizaTarjetaSolicitudCombustible.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        if(response.localeCompare("Sin datos") != 0 && response != ""){
          var table = $('#tablaListadoSolCombustible').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>La solicitud fue validada correctamente");
          $("#obsValidarSolCombustible2").val("");
          $("#validarSolCombustible").attr("disabled","disabled");
          $("#rechazarSolCombustible").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
          }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al validar solicitud");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#montoValidarSolCombustible").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#rechazarSolCombustible").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaListadoSolCombustible").DataTable();
  var datos = table.rows('.selected').data();

  $("#TarjetaRechazarSolCombustible").html(datos[0].IDCARGA_SOLICITADA);
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalRechazarSolCombustible").modal('show');
  },500);
});

$("#guardarRechazarSolCombustible").unbind('click').click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalRechazarSolCombustible").modal("hide");
  var table = $('#tablaListadoSolCombustible').DataTable();
  var idSolicitud = $.map(table.rows('.selected').data(), function (item) {
    return item.IDCARGA_SOLICITADA;
  });

  parametros = {
    "idSolicitud": idSolicitud[0],
    "estado": 'Rechazada',
    "observacion": 'Solicitud rechazada',
    "monto": 0
  }

  await $.ajax({
    url: "controller/rechazarTarjetaSolicitudCombustible.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      if(response.localeCompare("Sin datos") != 0 && response != ""){
        var table = $('#tablaListadoSolCombustible').DataTable();
        table.ajax.reload();
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>La solicitud fue rechazada correctamente");
        $("#validarSolCombustible").attr("disabled","disabled");
        $("#rechazarSolCombustible").attr("disabled","disabled");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al rechazar solicitud");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

// FUNCION PARA MODAL SUBIR CARATULA XML
// Primero cargamos los archivos
$("#xmlCargaCaratulaObras" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputXmlCaratulaObras").val(file);
  $("#inputXmlCaratulaObras").removeClass("is-invalid");
});

$("#xmlCargaCubicacionObras" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputXmlCubicacionObras").val(file);
  $("#inputXmlCubicacionObras").removeClass("is-invalid");
});

$("#agregarObras").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#xmlCargaCubicacionObras").removeAttr("disabled");
  $("#xmlCargaCaratulaObras").removeAttr("disabled");
  $("#xmlCargaCubicacionObras").parent().removeAttr("disabled");
  $("#xmlCargaCaratulaObras").parent().removeAttr("disabled");
  $("#nombreOeAsignarPers").val("");
  $("#inputXmlCaratulaObras").val("");
  $("#inputXmlCaratulaObras").removeClass("is-invalid");
  $("#inputXmlCubicacionObras").val("");
  $("#inputXmlCubicacionObras").removeClass("is-invalid");
  $("#jefeProyectoCaratula").attr("disabled","disabled");
  $("#superisorCaratula").attr("disabled","disabled");
  $("#proyectistaCaratula").attr("disabled","disabled");
  $("#selectObraProyectoCaratula").removeAttr("disabled");
  $("#selectObraEmpresaAsigCaratula").removeAttr("disabled");

  $("#jefeProyectoCaratula").parent().css('display','none');
  $("#superisorCaratula").parent().css('display','none');
  $("#proyectistaCaratula").parent().css('display','none');
  $("#asignarSubirXmlCaratulaObras").hide();
  $("#guardarSubirXmlCaratulaObras").show();

  // await $.ajax({
  //   url:   'controller/datosProyectoObraIngCaratula.php',
  //   type:  'post',
  //   success: function (response2) {
  //     var p2 = jQuery.parseJSON(response2);
  //     if(p2.aaData.length !== 0){
  //       var cuerpoProyectoOb = '<option value="0">Seleccionar</option>';
  //       for(var i = 0; i < p2.aaData.length; i++){
  //         cuerpoProyectoOb += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].PROYECTO_INTERNO + '</option>';
  //       }
  //       $("#selectObraProyectoCaratula").html(cuerpoProyectoOb);
  //     }
  //   }
  // });

  await $.ajax({
    url:   'controller/datosEmpresaOrdenIng.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEmpresaObr = '<option value="0">Seleccionar</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEmpresaObr += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].EMPRESA + '</option>';
        }
        $("#selectObraEmpresaAsigCaratula").html(cuerpoEmpresaObr);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectObraProyectoCaratula").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectObraEmpresaAsigCaratula").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalSubirXmlCaratulaObras").modal("show");
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#guardarSubirXmlCaratulaObras").unbind("click").click( async function(){
  if($("#inputXmlCaratulaObras").val() == "" /*|| $("#selectObraProyectoCaratula").val() == "0"*/ || $("#selectObraEmpresaAsigCaratula").val() == "0" || $("#inputXmlCubicacionObras").val() == ""){
    if($("#inputXmlCaratulaObras").val() == ""){
      $("#inputXmlCaratulaObras").addClass("is-invalid");
    }
    if($("#inputXmlCubicacionObras").val() == ""){
      $("#inputXmlCubicacionObras").addClass("is-invalid");
    }
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Favor seleccionar empresa e ingresar carátula y cubicación .xml");
  }
  else {
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalSubirXmlCaratulaObras").modal("hide");
    var formdata = new FormData();
    formdata.append('xmlCaratula',$("#xmlCargaCaratulaObras")[0].files[0]);
    // formdata.append('idEstructura', $("#selectObraProyectoCaratula").val());
    formdata.append('idEmpresa', $("#selectObraEmpresaAsigCaratula").val());
    await $.ajax({
      url: "controller/ingresaXmlCaratulaObras.php",
      type: 'POST',
      data: formdata,
      cache: false,
      contentType: false,
      processData: false,
      success: async function (response1) {
        var idObra = response1.split('%%%')[0];
        var formdata = new FormData();
        formdata.append('xmlCubicacion',$("#xmlCargaCubicacionObras")[0].files[0]);
        formdata.append('idObra', idObra);
        await $.ajax({
          url: "controller/ingresaXmlCubicacionObras.php",
          type: 'POST',
          data: formdata,
          cache: false,
          contentType: false,
          processData: false,
          success: async function (response) {
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(response[0].localeCompare("Sin datos") != 0 && response[0] != ""){
                var table = $('#tablaListadoObras').DataTable();
                table.ajax.reload();
                $("#detalleObraCaratula").attr("disabled", "disabled");
                $("#cubicacionObra").attr("disabled", "disabled");
                $("#usuariosRolesObra").attr("disabled", "disabled");
                $("#documentosObra").attr("disabled", "disabled");
                setTimeout(async function(){
                  $("#xmlCargaCubicacionObras").attr("disabled","disabled");
                  $("#xmlCargaCaratulaObras").attr("disabled","disabled");
                  $("#xmlCargaCubicacionObras").parent().attr("disabled","disabled");
                  $("#xmlCargaCaratulaObras").parent().attr("disabled","disabled");
                  $("#selectObraProyectoCaratula").attr("disabled","disabled");
                  $("#selectObraEmpresaAsigCaratula").attr("disabled","disabled");
                  $("#jefeProyectoCaratula").removeAttr("disabled");
                  $("#superisorCaratula").removeAttr("disabled");
                  $("#proyectistaCaratula").removeAttr("disabled");
                  $("#asignarSubirXmlCaratulaObras").show();
                  $("#guardarSubirXmlCaratulaObras").hide();
                  // $("#jefeProyectoCaratula").parent().css('display','block');
                  // if(response1.split('%%%')[1] === 'Ingenieria' || response1.split('%%%')[1] === 'Ingeniería' || response1.split('%%%')[1] === 'INGENIERIA'){
                  //   $("#proyectistaCaratula").parent().css('display','block');
                  //   $("#superisorCaratula").parent().css('display','none');
                  // }else{
                  //   $("#superisorCaratula").parent().css('display','block');
                  //   $("#proyectistaCaratula").parent().css('display','none');
                  // }
                  // $("#nombreOeAsignarPers").val(idObra);
                  // var parametros = {
                  //   "nombreOe": idObra,
                  // }
                  // await $.ajax({
                  //   url:   'controller/datosPersAsigCargaCaratula.php',
                  //   type:  'post',
                  //   data: parametros,
                  //   success: function (resp) {
                  //     var t = jQuery.parseJSON(resp);
                  //     if(t.aaData.length !== 0){
                  //       var cuerpoSU = '<option value="0">Sin asignar</option>';
                  //       var cuerpoJP = '<option value="0">Sin asignar</option>';
                  //       var cuerpoPY = '<option value="0">Sin asignar</option>';
                  //       for(var i = 0; i < t.aaData.length; i++){
                  //         if(t.aaData[i].TIPO === 'Supervisor'){
                  //           cuerpoSU += '<option value="' + t.aaData[i].IDUSUARIO + '">' + t.aaData[i].NOMBRE + '</option>';
                  //         }else if (t.aaData[i].TIPO === 'Proyectista'){
                  //           cuerpoPY += '<option value="' + t.aaData[i].IDUSUARIO + '">' + t.aaData[i].NOMBRE + '</option>';
                  //         }
                  //         else{
                  //           cuerpoJP += '<option value="' + t.aaData[i].IDUSUARIO + '">' + t.aaData[i].NOMBRE + '</option>';
                  //         }
                  //       }
                  //       $("#superisorCaratula").html(cuerpoSU);
                  //       $("#jefeProyectoCaratula").html(cuerpoJP);
                  //       $("#proyectistaCaratula").html(cuerpoPY);
                  //
                  //     }
                  //     setTimeout(function(){
                  //       alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Xml ingresado correctamente");
                  //       $("#modalSubirXmlCaratulaObras").modal("show");
                  //       $('#modalAlertasSplash').modal('hide');
                  //     },1500);
                  //   }
                  // });
                  // if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                  //   $("#superisorCaratula").select2({
                  //       theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  //   });
                  //   $("#jefeProyectoCaratula").select2({
                  //       theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  //   });
                  //   $("#proyectistaCaratula").select2({
                  //       theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  //   });
                  // }
                  setTimeout(function(){
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Xml ingresado correctamente");
                    // $("#modalSubirXmlCaratulaObras").modal("show");
                    $('#modalAlertasSplash').modal('hide');
                  },1500);
                },500);
              }
              else{
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La orden cargada ya existe en el sistema");
                $("#modalSubirXmlCaratulaObras").modal("show");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
            else{
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La orden cargada ya existe en el sistema");
              $("#modalSubirXmlCaratulaObras").modal("show");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
        });
      }
    });
  }
});
// FIN FUNCION PARA MODAL SUBIR CARATULA XML

// FUNCION PARA MODAL AGENCIAS OBRA
$("#agregarAgencias").unbind("click").click(function(){
  $("#nombreIngresoAgencias").removeClass("is-invalid");
  $("#idAgenciaIngresoAgencias").removeClass("is-invalid");
  $("#nombreIngresoAgencias").val("");
  $("#idAgenciaIngresoAgencias").val("");
  $("#modalIngresoAgencias").find("input,textarea,select").val("");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  setTimeout(function(){
    $("#modalIngresoAgencias").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoAgencias').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarIngresoAgencias").unbind('click').click(function(){
  if($("#nombreIngresoAgencias").val().length == 0 || $("#idAgenciaIngresoAgencias").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#nombreIngresoAgencias").val().length == 0){
      $("#nombreIngresoAgencias").addClass("is-invalid");
    }
    if ($("#idAgenciaIngresoAgencias").val().length == 0){
      $("#idAgenciaIngresoAgencias").addClass("is-invalid");
    }
  }
  else {
    parametros = {
      "nombreAgencia": $("#nombreIngresoAgencias").val(),
      "idAgencia": $("#idAgenciaIngresoAgencias").val(),
    }
    $("#modalIngresoAgencias").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaAgenciasObras.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoAgencias').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Agencia ingresado correctamente");
            $("#editarAgencia").attr("disabled","disabled");
            $("#eliminarAgencia").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar una agencia ya que existe un ID duplicado");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalIngresoAgencias").modal("show");
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar una agencia ya que existe un ID duplicado");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalIngresoAgencias").modal("show");
          },500);
        }
      }
    });
  }
});

$("#nombreIngresoAgencias").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#idAgenciaIngresoAgencias").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN PARA MODAL INGRESAR AGENCIAS OBRA

// FUNCION PARA MODAL EDITAR AGENCIAS OBRA
$("#editarAgencias").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoAgencias').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  var idAgencia = $.map(table.rows('.selected').data(), function (item) {
    return item.IDAGENCIA;
  });

  $("#nombreEditarAgencias").val(nombre);
  $("#idAgenciaEditarAgencias").val(idAgencia);

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEditarAgencias").modal("show");
  },500);
});

$("#guardarEditarAgencias").unbind('click').click(function(){
  var table = $('#tablaListadoAgencias').DataTable();
  var idAgenciasObras = $.map(table.rows('.selected').data(), function (item) {
    return item.IDOBRA_AGENCIA;
  });
  parametros = {
    "idAgenciasObras": idAgenciasObras[0],
    "nombre":  $("#nombreEditarAgencias").val(),
    "idAgencia":  $("#idAgenciaEditarAgencias").val(),
  }
  $("#modalEditarAgencias").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarAgenciasObras.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoAgencias').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Agencia editado correctamente");
          $("#editarAgencia").attr("disabled","disabled");
          $("#eliminarAgencia").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar agencia, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar agencia, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL EDITAR AGENCIAS OBRA

// FUNCION PARA MODAL ELIMINAR AGENCIAS OBRA
$("#eliminarAgencias").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoAgencias').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBRE;
  });

  $("#nombreEliminarAgencia").html(nombre);

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEliminarAgencias").modal("show");
  },500);
});

$("#guardarEliminarAgencias").unbind('click').click(async function(){
  var table = $('#tablaListadoAgencias').DataTable();
  var idAgenciasObras = $.map(table.rows('.selected').data(), function (item) {
      return item.IDOBRA_AGENCIA;
  });
  parametros = {
    "idAgenciasObras": idAgenciasObras[0],
  }
  $("#modalEliminarAgencias").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarAgenciasObras.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoAgencias').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Agencia eliminado correctamente");
            $("#editarAgencia").attr("disabled","disabled");
            $("#eliminarAgencia").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el agencia");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el agencia");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
//  FIN FUNCION PARA MODAL ELIMINAR AGENCIAS OBRA

$("#detalleObraCaratula").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaListadoObras").DataTable();
  var datos = table.rows('.selected').data();
  var idObra = datos[0].IDOBRA;
  var tipo = datos[0].TIPO;
  var proyInterno = datos[0].PROYEC_INTER;
  $("#changeSelectorTipo").val("0");
  caratula_Obras(idObra,tipo,proyInterno);
});

$("#xmlCargaCubicacionObras" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputXmlCubicacionObras").val(file);
  $("#inputXmlCubicacionObras").removeClass("is-invalid");
});

$("#selectComprasGestionClasif").unbind("click").change(async function(e) {
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalAgregarMantGestion").modal('hide');
  await $.ajax({
    url: "controller/datosComprasGestionDim1.php",
    type: 'POST',
    data: {
      "clasif": $("#selectComprasGestionClasif").val()
    },
    // dataType: 'json',
    success:  async function (response) {
      var p = jQuery.parseJSON(response);
      var options = '';
      options += '<option selected value="No Aplica">No Aplica</option>';
      for(var i = 0; i < p.aaData.length; i++){
        var id = p.aaData[i].IDCOMPRAS_GESTION_DIM1;
        var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasGestionDim1").html(options);
      $("#selectComprasGestionDim2").html('<option selected value="No Aplica">No Aplica</option>');
      $("#selectComprasGestionDim3").html('<option selected value="No Aplica">No Aplica</option>');

      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
        $("#modalAgregarMantGestion").modal('show');
      },500);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#selectComprasGestionDim1').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasGestionDim2').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasGestionDim3').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasGestionClasif').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#codigoComprasGestionDim3").removeAttr("disabled");
  $("#nombreComprasGestionDim3").removeAttr("disabled");
  $("#codigoComprasGestionDim2").removeAttr("disabled");
  $("#nombreComprasGestionDim2").removeAttr("disabled");
  $("#codigoComprasGestionDim1").removeAttr("disabled");
  $("#nombreComprasGestionDim1").removeAttr("disabled");
});

function alertasToast(texto){
  toastr.options = {
    "closeButton": true,
    "debug": false,
    "newestOnTop": false,
    "progressBar": true,
    "positionClass": "toast-top-right",
    "preventDuplicates": false,
    "onclick": false,
    // "onHidden": function(){
    //   setTimeout(function(){
    //     $('#modalAlertasSplash').modal('hide');
    //   },4000);
    // },
    // "onShown": function(){
    //   setTimeout(function(){
    //     $('#modalAlertasSplash').modal('hide');
    //   },500);
    // },
    "showDuration": "300",
    "hideDuration": "1000",
    "timeOut": "2000",
    "extendedTimeOut": "1000",
    "showEasing": "swing",
    "hideEasing": "linear",
    "showMethod": "slideDown",
    "hideMethod": "slideUp"
  }
  if(texto.includes("check.gif") == true){
    texto = texto.replace("<img src='view/img/check.gif' class='splash_load'><br/>","").replace("<img src='view/img/info.png' class='splash_load'><br/>","").replace("<img src='view/img/error.gif' class='splash_load'><br/>","");
    toastr["success"](texto);
  }
  else if(texto.includes("info.png") == true){
    texto = texto.replace("<img src='view/img/check.gif' class='splash_load'><br/>","").replace("<img src='view/img/info.png' class='splash_load'><br/>","").replace("<img src='view/img/error.gif' class='splash_load'><br/>","");
    toastr["info"](texto);
  }
  else if(texto.includes("error.gif") == true){
    texto = texto.replace("<img src='view/img/check.gif' class='splash_load'><br/>","").replace("<img src='view/img/info.png' class='splash_load'><br/>","").replace("<img src='view/img/error.gif' class='splash_load'><br/>","");
    toastr["error"](texto);
  }
  else{
    toastr["info"](texto);
  }
}

$('#montoSolicitarCarga').on('input', function () {
    this.value = this.value.replace(/[^0-9]/g,'');
});

$("#montoDevolucionCarga").on('input', function () {
    this.value = this.value.replace(/[^0-9]/g,'');
});

$("#montoValidarSolCombustible").on('input', function () {
    this.value = this.value.replace(/[^0-9]/g,'');
});

$("#selectComprasFinanzasClasif").unbind("click").change(async function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalAgregarMantFinanciera").modal('hide');
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url: "controller/datosComprasFinanzasDim1.php",
    type: 'POST',
    data: {
      "clas": $("#selectComprasFinanzasClasif").val()
    },
    // dataType: 'json',
    success:  function (response) {
      var p = jQuery.parseJSON(response);
      var options = '';
      options += '<option selected value="No Aplica">No Aplica</option>';
      for(var i = 0; i < p.aaData.length; i++){
        var id = p.aaData[i].IDCOMPRAS_FINANZAS_DIM1;
        var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasFinanzasDim1").html(options);
    }
  });

  await $.ajax({
    url: "controller/datosComprasFinanzasDim2.php",
    type: 'POST',
    data: {
      "clas": $("#selectComprasFinanzasClasif").val()
    },
    // dataType: 'json',
    success:  function (response) {
      var p = jQuery.parseJSON(response);
      var options = '';
      options += '<option selected value="No Aplica">No Aplica</option>';
      for(var i = 0; i < p.aaData.length; i++){
        var id = p.aaData[i].IDCOMPRAS_FINANZAS_DIM2;
        var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasFinanzasDim2").html(options);
    }
  });

  await $.ajax({
    url: "controller/datosComprasFinanzasDim3.php",
    type: 'POST',
    data: {
      "clas": $("#selectComprasFinanzasClasif").val()
    },
    // dataType: 'json',
    success:  function (response) {
      var p = jQuery.parseJSON(response);
      var options = '';
      options += '<option selected value="No Aplica">No Aplica</option>';
      for(var i = 0; i < p.aaData.length; i++){
        var id = p.aaData[i].IDCOMPRAS_FINANZAS_DIM3;
        var label = p.aaData[i].CODIGO + ' - ' + p.aaData[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasFinanzasDim3").html(options);
    }
  });

  var h = $(window).height() - 200;
  $("#bodyAgregarMantFinanciera").css("height",h);
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalAgregarMantFinanciera").modal('show');
  },500);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#selectComprasFinanzasDim1').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasFinanzasDim2').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasFinanzasDim3').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#selectComprasFinanzasClasif').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

async function cargarComprasFinanzasEstructuraReload() {
  var table = $('#tablaMantenedorFinancieras').DataTable();
  table.ajax.reload();
}

$("#agregarMantenedorServicio").unbind("click").click(async function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/datosServiciosBase.php',
    type:  'post',
    success: function (response2) {
      var p = jQuery.parseJSON(response2);
      if(p.aaData.length !== 0){
        var cuerpoSB = '<option value="0">Seleccionar</option>';
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoSB += '<option value="' + p.aaData[i].ID + '">' + p.aaData[i].SERVICIO + '</option>';
        }
        $('#baseAgregarMantServicios').append(cuerpoSB);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosGestionAgregarDim.php',
    type:  'post',
    data: {
      "tipo": "SER"
    },
    success: function (response2) {
      var p = jQuery.parseJSON(response2);
      if(p.aaData.length !== 0){
        var cuerpoGS = '<option value="0">Seleccionar</option>';
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoGS += '<option value="' + p.aaData[i].ID + '">' + p.aaData[i].GESTION + '</option>';
        }
        $('#gestionAgregarMantServicios').append(cuerpoGS);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosFinanzasAgregarDim.php',
    type:  'post',
    data: {
      "tipo": "SER"
    },
    success: function (response2) {
      var p = jQuery.parseJSON(response2);
      if(p.aaData.length !== 0){
        var cuerpoFN = '<option value="0">Seleccionar</option>';
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoFN += '<option value="' + p.aaData[i].ID + '">' + p.aaData[i].FINANZAS + '</option>';
        }
        $('#finanzasAgregarMantServicios').append(cuerpoFN);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosEmpresaOrdenIng.php',
    type:  'post',
    success: function (response2) {
      var p = jQuery.parseJSON(response2);
      if(p.aaData.length !== 0){
        var cuerpoEM = '<option value="0">Seleccionar</option>';
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoEM += '<option value="' + p.aaData[i].ID + '">' + p.aaData[i].EMPRESA + '</option>';
        }
        $('#subcontratoAgregarMantServicios').append(cuerpoEM);
      }
    }
  });
  if(!/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
    $('#baseAgregarMantServicios').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#gestionAgregarMantServicios').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#finanzasAgregarMantServicios').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#subcontratoAgregarMantServicios').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  var h = $(window).height() - 200;
  $("#bodyAgregarMantServicios").css("height",h);
  $("#modalAgregarMantServicios").modal('show');
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$('.input-decimal').on('input', function () {
    this.value = this.value.replace(/[^0-9,.]/g,'');
});

$("#baseAgregarMantServicios").unbind("click").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalAgregarMantServicios").modal('hide');
  await $.ajax({
    url:   'controller/datosServiciosBaseSeleccionado.php',
    type:  'post',
    data: {
      "id": $("#baseAgregarMantServicios").val()
    },
    success: function (response2) {
      var p = jQuery.parseJSON(response2);
      if(p.aaData.length !== 0){
        $('#gestionAgregarMantServicios').val(p.aaData[0].ID_GESTION);
        $('#finanzasAgregarMantServicios').val(p.aaData[0].ID_FINANZAS);
        $("#codigoAgregarMantServicios").val(p.aaData[0].CODIGO);
        $("#nombreAgregarMantServicios").val(p.aaData[0].NOMBRE);
        $("#marcaAgregarMantServicios").val(p.aaData[0].MARCA);
        $("#modeloAgregarMantServicios").val(p.aaData[0].MODELO);
        $("#tipoAgregarMantServicios").val(p.aaData[0].TIPO);
        $("#precioMinAgregarMantServicios").val(p.aaData[0].PRECIO_MIN);
        $("#precioMaxAgregarMantServicios").val(p.aaData[0].PRECIO_MAX);
        $("#potenciaAgregarMantServicios").val(p.aaData[0].POTENCIA);
        $("#pesoAgregarMantServicios").val(p.aaData[0].PESO);
        $("#capacidadAgregarMantServicios").val(p.aaData[0].CAPACIDAD);
        $("#areaAgregarMantServicios").val(p.aaData[0].AREA_M2);
        $("#anchoAgregarMantServicios").val(p.aaData[0].ANCHO);
        $("#altoAgregarMantServicios").val(p.aaData[0].ALTO);
        $("#largoAgregarMantServicios").val(p.aaData[0].LARGO);
        $("#temperaturaAgregarMantServicios").val(p.aaData[0].TEMPERATURA);
        $("#humedadAgregarMantServicios").val(p.aaData[0].HUMEDAD);
        $("#presicionAgregarMantServicios").val(p.aaData[0].PRECISION);
        $("#unidadMedidaAgregarMantServicios").val(p.aaData[0].UNIDAD_MEDIDA);
        $("#subcontratoAgregarMantServicios").val(p.aaData[0].IDSUBCONTRATO);
        $("#observacionAgregarMantServicios").val(p.aaData[0].OBSERVACION);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#baseAgregarMantServicios').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#gestionAgregarMantServicios').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#finanzasAgregarMantServicios').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#subcontratoAgregarMantServicios').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalAgregarMantServicios").modal('show');
  },500);
});

$('#guardarAgregarMantServicios').unbind("click").click(function() {
  if($("#subcontratoAgregarMantServicios").val() === "0" || $("#codigoAgregarMantServicios").val() === "" || $("#nombreAgregarMantServicios").val() === "" || $("#gestionAgregarMantServicios").val() === "0" || $("#finanzasAgregarMantServicios").val() === "0"){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos Empresa, Cod. Contable, Nombre, Dim. Gestión y Dim. Finanzas por lo menos");
    $("#subcontratoAgregarMantServicios").next().find('.select2-selection').addClass("select2-error");
    $("#gestionAgregarMantServicios").next().find('.select2-selection').addClass("select2-error");
    $("#finanzasAgregarMantServicios").next().find('.select2-selection').addClass("select2-error");
    $("#codigoAgregarMantServicios").addClass("is-invalid");
    $("#nombreAgregarMantServicios").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalAgregarMantServicios").modal('hide');

    var parametros = {};

    $('#bodyAgregarMantServicios').find('input, select, textarea').each(function() {
      parametros[$(this).attr("id")] = $(this).val();
    });

    $.ajax({
      url: "controller/ingresarComprasServicioNuevo.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorServicios').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Servicio ingresado correctamente");
            $("#editarAseguradora").attr("disabled","disabled");
            $("#eliminarAseguradora").attr("disabled","disabled");

            setTimeout(function(){
              var table = $('#tablaMantenedorServicios').DataTable();

              var marcaMantSer = '';
              marcaMantSer += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(4).data().unique().length; i++){
                if(table.column(4).data().unique()[i] !== null){
                  marcaMantSer += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
                }
              }
              $("#marcaMantenedorServicios").html(marcaMantSer);

              var modeloMantSer = '';
              modeloMantSer += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(5).data().unique().length; i++){
                if(table.column(5).data().unique()[i] !== null){
                  modeloMantSer += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
                }
              }
              $("#modeloMantenedorServicios").html(modeloMantSer);

              var tipoMantSer = '';
              tipoMantSer += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(6).data().unique().length; i++){
                if(table.column(6).data().unique()[i] !== null){
                  tipoMantSer += '<option value="' + table.column(6).data().unique()[i] + '">' + table.column(6).data().unique()[i] + '</option>';
                }
              }
              $("#tipoMantenedorServicios").html(tipoMantSer);

              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#marcaMantenedorServicios").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#modeloMantenedorServicios").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#tipoMantenedorServicios").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
              }
              $('#modalAlertasSplash').modal('hide');
            },2000);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El campo de Cod. contable ingresado ya existe en el sistema");
            $("#codigoAgregarMantServicios").addClass("is-invalid");
            setTimeout(function(){
              $("#modalAgregarMantServicios").modal('show');
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El campo de Cod. contable ingresado ya existe en el sistema");
          $("#codigoAgregarMantServicios").addClass("is-invalid");
          setTimeout(function(){
            $("#modalAgregarMantServicios").modal('show');
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#eliminarMantenedorServicio").unbind("click").click(function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorServicios").DataTable();
  var datos = table.rows('.selected').data();
  $("#tituloEliminarMantServicios").html("Folio: " + datos[0].FOLIO);

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEliminarMantServicios").modal("show");
  },500);
});

$("#guardarEliminarMantServicios").unbind("click").click(function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEliminarMantServicios").modal("hide")
  var table = $("#tablaMantenedorServicios").DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    "id": datos[0].FOLIO
  }

  $.ajax({
    url: "controller/eliminarComprasServicio.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaMantenedorServicios').DataTable();
          table.ajax.reload();
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Servicio eliminado correctamente");
          $("#editarAseguradora").attr("disabled","disabled");
          $("#eliminarAseguradora").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El servicio no se puede elimnar ya que esta asociado a solicitudes, cotizaciones o proveedores");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
      }
      else{
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El servicio no se puede elimnar ya que esta asociado a solicitudes, cotizaciones o proveedores");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#editarMantenedorServicio").unbind("click").click(async function() {
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/datosGestionAgregarDim.php',
    type:  'post',
    data: {
      "tipo": "SER"
    },
    success: function (response2) {
      var p = jQuery.parseJSON(response2);
      if(p.aaData.length !== 0){
        var cuerpoGS = '<option value="0">Seleccionar</option>';
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoGS += '<option value="' + p.aaData[i].ID + '">' + p.aaData[i].GESTION + '</option>';
        }
        $('#gestionEditarMantServicios').append(cuerpoGS);
      }
    }
  });
  await $.ajax({
    url:   'controller/datosFinanzasAgregarDim.php',
    type:  'post',
    data: {
      "tipo": "SER"
    },
    success: function (response2) {
      var p = jQuery.parseJSON(response2);
      if(p.aaData.length !== 0){
        var cuerpoFN = '<option value="0">Seleccionar</option>';
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoFN += '<option value="' + p.aaData[i].ID + '">' + p.aaData[i].FINANZAS + '</option>';
        }
        $('#finanzasEditarMantServicios').append(cuerpoFN);
      }
    }
  });

  var table = $("#tablaMantenedorServicios").DataTable();
  var datos = table.rows('.selected').data();

  await $.ajax({
    url:   'controller/datosServiciosBaseSeleccionado.php',
    type:  'post',
    data: {
      "id": datos[0].FOLIO
    },
    success: function (response2) {
      var p = jQuery.parseJSON(response2);
      if(p.aaData.length !== 0){
        $('#gestionEditarMantServicios').val(p.aaData[0].ID_GESTION);
        $('#finanzasEditarMantServicios').val(p.aaData[0].ID_FINANZAS);
        $("#codigoEditarMantServicios").val(p.aaData[0].CODIGO);
        $("#nombreEditarMantServicios").val(p.aaData[0].NOMBRE);
        $("#marcaEditarMantServicios").val(p.aaData[0].MARCA);
        $("#modeloEditarMantServicios").val(p.aaData[0].MODELO);
        $("#tipoEditarMantServicios").val(p.aaData[0].TIPO);
        $("#precioMinEditarMantServicios").val(p.aaData[0].PRECIO_MIN);
        $("#precioMaxEditarMantServicios").val(p.aaData[0].PRECIO_MAX);
        $("#potenciaEditarMantServicios").val(p.aaData[0].POTENCIA);
        $("#pesoEditarMantServicios").val(p.aaData[0].PESO);
        $("#capacidadEditarMantServicios").val(p.aaData[0].CAPACIDAD);
        $("#areaEditarMantServicios").val(p.aaData[0].AREA_M2);
        $("#anchoEditarMantServicios").val(p.aaData[0].ANCHO);
        $("#altoEditarMantServicios").val(p.aaData[0].ALTO);
        $("#largoEditarMantServicios").val(p.aaData[0].LARGO);
        $("#temperaturaEditarMantServicios").val(p.aaData[0].TEMPERATURA);
        $("#humedadEditarMantServicios").val(p.aaData[0].HUMEDAD);
        $("#presicionEditarMantServicios").val(p.aaData[0].PRECISION);
        $("#unidadMedidaEditarMantServicios").val(p.aaData[0].UNIDAD_MEDIDA);
        $("#observacionEditarMantServicios").val(p.aaData[0].OBSERVACION);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#gestionEditarMantServicios').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#finanzasEditarMantServicios').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

$("#tituloEditarMantServicios").html("Folio: " + datos[0].FOLIO + "<br>Nombre: " + datos[0].NOMBRE + "<br>Empresa: " + datos[0].EMPRESA);
  setTimeout(function(){
    var h = $(window).height() - 250;
    $("#bodyEditarMantServicios").css("height",h);
    $("#modalEditarMantServicios").modal("show");
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$('#guardarEditarMantServicios').unbind("click").click(function() {
  if($("#codigoEditarMantServicios").val() === "" || $("#nombreEditarMantServicios").val() === "" || $("#gestionEditarMantServicios").val() === "0" || $("#finanzasEditarMantServicios").val() === "0"){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos Cod. Contable, Nombre, Dim. Gestión y Dim. Finanzas por lo menos");
    $("#gestionEditarMantServicios").next().find('.select2-selection').addClass("select2-error");
    $("#finanzasEditarMantServicios").next().find('.select2-selection').addClass("select2-error");
    $("#codigoEditarMantServicios").addClass("is-invalid");
    $("#nombreEditarMantServicios").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEditarMantServicios").modal('hide');

    var parametros = {};

    var table = $("#tablaMantenedorServicios").DataTable();
    var datos = table.rows('.selected').data();

    parametros['id'] = datos[0].FOLIO;

    $('#bodyEditarMantServicios').find('input, select, textarea').each(function() {
      parametros[$(this).attr("id")] = $(this).val();
    });

    $.ajax({
      url: "controller/editarComprasServicioNuevo.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorServicios').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Servicio editado correctamente");
            $("#editarMantenedorServicio").attr("disabled","disabled");
            $("#eliminarMantenedorServicio").attr("disabled","disabled");
            setTimeout(function(){
              var table = $('#tablaMantenedorServicios').DataTable();

              var marcaMantSer = '';
              marcaMantSer += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(4).data().unique().length; i++){
                if(table.column(4).data().unique()[i] !== null){
                  marcaMantSer += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
                }
              }
              $("#marcaMantenedorServicios").html(marcaMantSer);

              var modeloMantSer = '';
              modeloMantSer += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(5).data().unique().length; i++){
                if(table.column(5).data().unique()[i] !== null){
                  modeloMantSer += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
                }
              }
              $("#modeloMantenedorServicios").html(modeloMantSer);

              var tipoMantSer = '';
              tipoMantSer += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(6).data().unique().length; i++){
                if(table.column(6).data().unique()[i] !== null){
                  tipoMantSer += '<option value="' + table.column(6).data().unique()[i] + '">' + table.column(6).data().unique()[i] + '</option>';
                }
              }
              $("#tipoMantenedorServicios").html(tipoMantSer);

              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#marcaMantenedorServicios").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#modeloMantenedorServicios").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#tipoMantenedorServicios").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
              }
              $('#modalAlertasSplash').modal('hide');
            },2000);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El campo de Cod. contable ingresado ya existe en el sistema");
            setTimeout(function(){
              $("#modalEditarMantServicios").modal('show');
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El campo de Cod. contable ingresado ya existe en el sistema");
          setTimeout(function(){
            $("#modalEditarMantServicios").modal('show');
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#marcaMantenedorServicios").unbind("click").change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorServicios").DataTable();
  var item = $("#marcaMantenedorServicios").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('4').search(item).draw();

  var cols = table.rows({ search: 'applied' }).data();

  const modeloMantSerArray = [];
  for(var i = 0; i < cols.length; i++){
    modeloMantSerArray.push(cols[i].MODELO);
  }

  let modeloMantSerUnique = [...new Set(modeloMantSerArray)];

  var modeloMantSer = '';
  modeloMantSer += '<option selected value="Todos">Todos</option>';
  for(var i = 0; i < modeloMantSerUnique.length; i++){
    if(modeloMantSerUnique[i] !== null){
      modeloMantSer += '<option value="' + modeloMantSerUnique[i] + '">' + modeloMantSerUnique[i] + '</option>';
    }
  }
  $("#modeloMantenedorServicios").html(modeloMantSer);

  const tipoMantSerArray = [];
  for(var i = 0; i < cols.length; i++){
    tipoMantSerArray.push(cols[i].TIPO);
  }

  let tipoMantSerUnique = [...new Set(tipoMantSerArray)];

  var tipoMantSer = '';
  tipoMantSer += '<option selected value="Todos">Todos</option>';
  for(var i = 0; i < tipoMantSerUnique.length; i++){
    if(tipoMantSerUnique[i] !== null){
      tipoMantSer += '<option value="' + tipoMantSerUnique[i] + '">' + tipoMantSerUnique[i] + '</option>';
    }
  }
  $("#tipoMantenedorServicios").html(tipoMantSer);

  setTimeout(function(){
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#modeloMantenedorServicios").select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#tipoMantenedorServicios").select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
    },500);
  },500);
});

$("#modeloMantenedorServicios").unbind("click").change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorServicios").DataTable();
  var item = $("#modeloMantenedorServicios").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('5').search(item).draw();

  if($("#modeloMantenedorServicios").val() === "Todos"){
    $("#marcaMantenedorServicios").removeAttr("disabled");
  }
  else{
    $("#marcaMantenedorServicios").attr("disabled","disabled");
  }

  var cols = table.rows({ search: 'applied' }).data();

  const tipoMantSerArray = [];
  for(var i = 0; i < cols.length; i++){
    tipoMantSerArray.push(cols[i].TIPO);
  }

  let tipoMantSerUnique = [...new Set(tipoMantSerArray)];

  var tipoMantSer = '';
  tipoMantSer += '<option selected value="Todos">Todos</option>';
  for(var i = 0; i < tipoMantSerUnique.length; i++){
    if(tipoMantSerUnique[i] !== null){
      tipoMantSer += '<option value="' + tipoMantSerUnique[i] + '">' + tipoMantSerUnique[i] + '</option>';
    }
  }
  $("#tipoMantenedorServicios").html(tipoMantSer);

  setTimeout(function(){
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#tipoMantenedorServicios").select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
    },500);
  },500);
});

$("#tipoMantenedorServicios").unbind("click").change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorServicios").DataTable();
  var item = $("#tipoMantenedorServicios").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('6').search(item).draw();

  if($("#tipoMantenedorServicios").val() === "Todos"){
    $("#modeloMantenedorServicios").removeAttr("disabled");
    if($("#modeloMantenedorServicios").val() === "Todos"){
      $("#marcaMantenedorServicios").removeAttr("disabled");
    }
    else{
      $("#marcaMantenedorServicios").attr("disabled","disabled");
    }
  }
  else{
    $("#modeloMantenedorServicios").attr("disabled","disabled");
    $("#marcaMantenedorServicios").attr("disabled","disabled");
  }

  setTimeout(function(){
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
    },500);
  },500);
});

$("#codigoAgregarMantServicios").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombreAgregarMantServicios").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#subcontratoAgregarMantServicios").unbind("click").change(function(){
  $(this).next().find('.select2-selection').removeClass("select2-error");
});

$("#gestionAgregarMantServicios").unbind("click").change(function(){
  $(this).next().find('.select2-selection').removeClass("select2-error");
});

$("#finanzasAgregarMantServicios").unbind("click").change(function(){
  $(this).next().find('.select2-selection').removeClass("select2-error");
});

$("#codigoEditarMantServicios").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombreEditarMantServicios").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#gestionEditarMantServicios").unbind("click").change(function(){
  $(this).next().find('.select2-selection').removeClass("select2-error");
});

$("#finanzasEditarMantServicios").unbind("click").change(function(){
  $(this).next().find('.select2-selection').removeClass("select2-error");
});

$("#proyectoIngOrden").unbind("click").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalIngOrden").modal("hide");
  var parametrosOrden = {
    "idEstructura": $("#proyectoIngOrden").val()
  }

  await $.ajax({
    url: "controller/datosOrdenesEstructura.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoTramosOrden = '';
        p.aaData.forEach(({ IDORDEN_TRAMO, TRAMO, INICIO, FIN }) => {
          cuerpoTramosOrden += `<option value="${IDORDEN_TRAMO}">${TRAMO}</option>`;
        });
        $("#tramoIngOrden").html(cuerpoTramosOrden);
      }
    }
  });

  await $.ajax({
    url: "controller/datosComunasOrdenesIng.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoComuna = '';
        p.aaData.forEach(({ ID, COMUNA }) => {
          cuerpoComuna += `<option value="${ID}">${COMUNA}</option>`;
        });
        $("#comunaRegionIngOrden").html(cuerpoComuna);
      }
    }
  });

  await $.ajax({
    url: "controller/datosTipoOrdenesIng.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoTipo = '';
        p.aaData.forEach(({ ID, TIPO }) => {
          cuerpoTipo += `<option value="${ID}">${TIPO}</option>`;
        });
        $("#tipoIngOrden").html(cuerpoTipo);
      }
    }
  });

  parametrosOrden['idOrdenTipo'] = $("#tipoIngOrden").val();

  await $.ajax({
    url: "controller/datosCategoriaOrdenesIng.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoCat = '';
        p.aaData.forEach(({ ID, CATEGORIA }) => {
          cuerpoCat += `<option value="${ID}">${CATEGORIA}</option>`;
        });
        $("#categoriaIngOrden").html(cuerpoCat);
      }
    }
  });

  await $.ajax({
    url: "controller/datosEmpresaOrdenIng.php",
    type: 'POST',
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoEmpresa = '';
        p.aaData.forEach(({ ID, EMPRESA }) => {
          cuerpoEmpresa += `<option value="${ID}">${EMPRESA}</option>`;
        });
        $("#empresaIngOrden").html(cuerpoEmpresa);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoIngOrden").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#tramoIngOrden").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaRegionIngOrden").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#tipoIngOrden").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#categoriaIngOrden").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#empresaIngOrden").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalIngOrden").modal("show");
  },500);
});

$("input#rutIngOrden").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutIngOrden").val() !== ''){rutIngOrden
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutIngOrden").val("");
    $("#rutIngOrden").addClass("is-invalid");
  }
});

$("#rutIngOrden").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#guardarIngOrden").unbind("click").click(async function(e){
  if($("#folioIngOrden").val() === "" || $("#fechaHoraIngOrden").val() === "" || $("#rutIngOrden").val() === "" || $("#clienteIngOrden").val() === "" || $("#fonoIngOrden").val() === "" || $("#direccionIngOrden").val() === "" || $("#tecnologiaIngOrden").val() === ""){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos indicados");
    $("#folioIngOrden").addClass("is-invalid");
    $("#fechaHoraIngOrden").addClass("is-invalid");
    $("#rutIngOrden").addClass("is-invalid");
    $("#clienteIngOrden").addClass("is-invalid");
    $("#fonoIngOrden").addClass("is-invalid");
    $("#direccionIngOrden").addClass("is-invalid");
    $("#tecnologiaIngOrden").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalIngOrden").modal('hide');

    var parametros = {};

    $('#bodyIngOrden').find('input, select').each(function() {
      parametros[$(this).attr("id")] = $(this).val();
    });

    $.ajax({
      url: "controller/ingresarOrdenATC.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaOrdenes').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Orden ingresada correctamente");
            $("#agendarOrden").attr("disabled", "disabled");
            $("#asignarDespachoOrden").attr("disabled", "disabled");
            $("#asignarTecnicoOrden").attr("disabled", "disabled");
            $("#botonEstadoOrden").attr("disabled", "disabled");
            $("#completarOrden").attr("disabled", "disabled");
            $("#observacionOrden").attr("disabled", "disabled");
            $("#historialOrden").attr("disabled", "disabled");

            setTimeout(function(){
              var table = $('#tablaOrdenes').DataTable();

              var comunaOr = '';
              comunaOr += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(3).data().unique().length; i++){
                if(table.column(3).data().unique()[i] !== null){
                  comunaOr += '<option value="' + table.column(3).data().unique()[i] + '">' + table.column(3).data().unique()[i] + '</option>';
                }
              }
              $("#comunaOrden").html(comunaOr);

              var categoriaOr = '';
              categoriaOr += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(4).data().unique().length; i++){
                if(table.column(4).data().unique()[i] !== null){
                  categoriaOr += '<option value="' + table.column(4).data().unique()[i] + '">' + table.column(4).data().unique()[i] + '</option>';
                }
              }
              $("#categoriaOrden").html(categoriaOr);

              var tipoOr = '';
              tipoOr += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(5).data().unique().length; i++){
                if(table.column(5).data().unique()[i] !== null){
                  tipoOr += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
                }
              }
              $("#tipoOrden").html(tipoOr);

              var estadoOr = '';
              estadoOr += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(28).data().unique().length; i++){
                if(table.column(28).data().unique()[i] !== null){
                  estadoOr += '<option value="' + table.column(28).data().unique()[i] + '">' + table.column(28).data().unique()[i] + '</option>';
                }
              }
              $("#estadoOrden").html(estadoOr);

              var subEstadoOr = '';
              subEstadoOr += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(29).data().unique().length; i++){
                if(table.column(29).data().unique()[i] !== null){
                  subEstadoOr += '<option value="' + table.column(29).data().unique()[i] + '">' + table.column(29).data().unique()[i] + '</option>';
                }
              }
              $("#subEstadoOrden").html(subEstadoOr);

              var tramoOr = '';
              tramoOr += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(14).data().unique().length; i++){
                if(table.column(14).data().unique()[i] !== null){
                  tramoOr += '<option value="' + table.column(14).data().unique()[i] + '">' + table.column(14).data().unique()[i] + '</option>';
                }
              }
              $("#tramoOrden").html(tramoOr);

              var agendasOr = '';
              agendasOr += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(10).data().unique().length; i++){
                if(table.column(10).data().unique()[i] !== null){
                  agendasOr += '<option value="' + table.column(10).data().unique()[i] + '">' + table.column(10).data().unique()[i] + '</option>';
                }
              }
              $("#reagendamientoOrden").html(agendasOr);

              var proyectoOr = '';
              proyectoOr += '<option selected value="Todos">Todos</option>';
              for(var i = 0; i < table.column(2).data().unique().length; i++){
                if(table.column(2).data().unique()[i] !== null){
                  proyectoOr += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
                }
              }
              $("#proyectoOrden").html(proyectoOr);

              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#comunaOrden").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#categoriaOrden").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#tipoOrden").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#tramoOrden").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#estadoOrden").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#subEstadoOrden").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#reagendamientoOrden").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                    sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
                });
                $("#proyectoOrden").select2('destroy').select2({
                    theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
              }
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            },2000);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El folio de la órden ya existe en sistema");
            $("#folioIngOrden").addClass("is-invalid");
            setTimeout(function(){
              $("#modalIngOrden").modal('show');
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El folio de la órden ya existe en sistema");
          $("#folioIngOrden").addClass("is-invalid");
          setTimeout(function(){
            $("#modalIngOrden").modal('show');
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("input[id*='IngOrden']").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#fechaHoraIngOrden").on('change', function(){
  $(this).removeClass("is-invalid");
});

$("#tipoIngOrden").unbind("click").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalIngOrden").modal('hide');
  var parametrosOrden = {
    "idEstructura": $("#proyectoIngOrden").val(),
    "idOrdenTipo": $("#tipoIngOrden").val()
  }

  await $.ajax({
    url: "controller/datosCategoriaOrdenesIng.php",
    type: 'POST',
    data: parametrosOrden,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if (p.aaData.length !== 0) {
        var cuerpoCat = '';
        p.aaData.forEach(({ ID, CATEGORIA }) => {
          cuerpoCat += `<option value="${ID}">${CATEGORIA}</option>`;
        });
        $("#categoriaIngOrden").html(cuerpoCat);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoIngOrden").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#categoriaIngOrden").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalIngOrden").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("#numTarea").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#direccionCliente").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#rutCliente").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#selectPersonal").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#usuariosRolesObra").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoObras').DataTable();
  var datos = table.rows('.selected').data();
  var folios = datos[0].IDOBRA;
  var oe = datos[0].NOMBREOE;
  var tipo = datos[0].TIPO;
  var proyecto = datos[0].PROYECTO;
  $("#oeConfigurarPersonalObras").html('OE: ' + oe);
  $("#proyectoConfigurarPersonalObras").html('Proyecto: ' + proyecto);

  if(folios.includes('/')){
    $("#tipoConfigurarPersonalObras").html(tipo);
    var selector = '';
    selector += '<option value="Jefe proyecto">Jefe proyecto</option><option value="Proyectista">Proyectista</option>';
    selector += '<option value="Supervisor">Supervisor</option><option value="Certificador">Certificador</option><option value="Gestor permisos">Gestor permisos</option>'
    $("#funcionConfigurarPersonalObras").html(selector);

    var parametros = {
      'idez': folios.replace(" / ",","),
      "rol": $("#funcionConfigurarPersonalObras").val(),
      "idarea": datos[0].IDAREAFUNCIONAL,
      "idEstructura": datos[0].IDESTRUCTURA_OPERACION
    }
    await $.ajax({
      url:   'controller/datosPersonalObrasAsignar.php',
      type:  'post',
      data:  parametros,
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        var cuerpoPer = '<option value="0">Seleccionar Usuario</option>';
        if(p2.aaData.length !== 0){
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
          }
          $("#personalConfigurarPersonalObras").html(cuerpoPer);
        }
        else{
          $("#personalConfigurarPersonalObras").html(cuerpoPer);
        }
      }
    });

    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/40);
    var parametros1 = {
      'idez': folios.replace(" / ",",").trim(),
    }
    await $('#tablaConfigurarPersonalObras').DataTable( {
        ajax: {
            url: "controller/datosPersonalObraAsignados.php",
            type: 'POST',
            data: parametros1
        },
        columns: [
            { data: 'S'},
            { data: 'RUT' },
            { data: 'NOMBRE'},
            { data: 'TIPO' },
            { data: 'BORRAR', className: 'centerDataTable hoverDel' }
        ],
        "columnDefs": [
          {
            "width": "5px",
            "targets": 0
          },
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "width": "5px",
            "targets": 4
          }
        ],
        "select": {
            style: 'single',
            selector: 'td:not(:nth-child(5))'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        "order": [[ 2, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'rtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalConfigurarPersonalObras").modal("show");
            setTimeout(function(){
              $('#tablaConfigurarPersonalObras').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
  }else{
    $("#tipoConfigurarPersonalObras").html(tipo);
    $("#datosConfigurarPersonalObrasFull").hide();
    if(tipo === "Ingenieria" || tipo === "INGENIERIA" || tipo === "Ingeniería"){
      $("#funcionConfigurarPersonalObras").html('<option value="Jefe proyecto">Jefe proyecto</option><option value="Proyectista">Proyectista</option>');
    }
    else{
      $("#funcionConfigurarPersonalObras").html('<option value="Jefe proyecto">Jefe proyecto</option><option value="Supervisor">Supervisor</option><option value="Certificador">Certificador</option><option value="Gestor permisos">Gestor permisos</option>');
    }
    var parametros = {
      'idez': folios.replace(" / ",","),
      "rol": $("#funcionConfigurarPersonalObras").val(),
      "idarea": datos[0].IDAREAFUNCIONAL,
      "idEstructura": datos[0].IDESTRUCTURA_OPERACION
    }
    await $.ajax({
      url:   'controller/datosPersonalObrasAsignar.php',
      type:  'post',
      data:  parametros,
      success: function (response2) {
        var p2 = jQuery.parseJSON(response2);
        var cuerpoPer = '<option value="0">Seleccionar Usuario</option>';
        if(p2.aaData.length !== 0){
          for(var i = 0; i < p2.aaData.length; i++){
            cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
          }
          $("#personalConfigurarPersonalObras").html(cuerpoPer);
        }
        else{
          $("#personalConfigurarPersonalObras").html(cuerpoPer);
        }
      }
    });

    var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/40);

    await $('#tablaConfigurarPersonalObras').DataTable( {
        ajax: {
            url: "controller/datosPersonalObraAsignados.php",
            type: 'POST',
            data: parametros
        },
        columns: [
            { data: 'S'},
            { data: 'RUT' },
            { data: 'NOMBRE'},
            { data: 'TIPO' },
            { data: 'BORRAR', className: 'centerDataTable hoverDel' }
        ],
        "columnDefs": [
          {
            "width": "5px",
            "targets": 0
          },
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "width": "5px",
            "targets": 4
          }
        ],
        "select": {
            style: 'single',
            selector: 'td:not(:nth-child(5))'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        "order": [[ 2, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'rtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalConfigurarPersonalObras").modal("show");
            setTimeout(function(){
              $('#tablaConfigurarPersonalObras').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
  }

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#personalConfigurarPersonalObras").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#personalConfigurarPersonalObrasFull").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#funcionConfigurarPersonalObras").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#funcionConfigurarPersonalObrasFull").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
////////////////////////////////////////////////////////
});

async function quitarPersonalObraAsig(id){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalConfigurarPersonalObras").modal("hide");
  var parametros = {
    'id': id.replace("N",",").replace('"','').replace('"',''),
  }
  await $.ajax({
    url: "controller/eliminarPersonalObraAsig.php",
    type: 'POST',
    data: parametros,
    success: async function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaConfigurarPersonalObras').DataTable();
          table.ajax.reload();

          var table = $('#tablaListadoObras').DataTable();
          var datos = table.rows('.selected').data();

          var parametros = {
            'idez': datos[0].IDOBRA.replace(" / ",","),
            "rol": $("#funcionConfigurarPersonalObras").val(),
            "idarea": datos[0].IDAREAFUNCIONAL,
            "idEstructura": datos[0].IDESTRUCTURA_OPERACION
          }
          await $.ajax({
            url:   'controller/datosPersonalObrasAsignar.php',
            type:  'post',
            data:  parametros,
            success: function (response2) {
              var p2 = jQuery.parseJSON(response2);
              var cuerpoPer = '<option value="0">Seleccionar Usuario</option>';
              if(p2.aaData.length !== 0){
                for(var i = 0; i < p2.aaData.length; i++){
                  cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
                }
                $("#personalConfigurarPersonalObras").html(cuerpoPer);
              }
              else{
                $("#personalConfigurarPersonalObras").html(cuerpoPer);
              }
            }
          });

          if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            $("#personalConfigurarPersonalObras").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
            $("#funcionConfigurarPersonalObras").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
            });
          };

          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Ejecutado correctamente");

          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalConfigurarPersonalObras").modal("show");
            setTimeout(function(){
              $('#tablaConfigurarPersonalObras').DataTable().columns.adjust();
            },500);
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalConfigurarPersonalObras").modal("show");
            setTimeout(function(){
              $('#tablaConfigurarPersonalObras').DataTable().columns.adjust();
            },500);
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalConfigurarPersonalObras").modal("show");
          setTimeout(function(){
            $('#tablaConfigurarPersonalObras').DataTable().columns.adjust();
          },500);
        },500);
      }
    }
  });
};

$("#agregarConfigurarPersonalObras").unbind("click").click(async function(){
  if($("#personalConfigurarPersonalObras").val() === "0"){
    alertasToast('No ha seleccionado un usuario para asignar');
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalConfigurarPersonalObras").modal("hide");
    var table = $('#tablaListadoObras').DataTable();
    var datos = table.rows('.selected').data();
    var parametros = {
      'idusuario': $("#personalConfigurarPersonalObras").val(),
      'idoz': datos[0].IDOBRA,
      'tipo': $("#funcionConfigurarPersonalObras").val()
    }
    await $.ajax({
      url: "controller/ingresarPersonalAsigObra.php",
      type: 'POST',
      data: parametros,
      success: async function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaConfigurarPersonalObras').DataTable();
            table.ajax.reload();
            var table = $('#tablaListadoObras').DataTable();
            var datos = table.rows('.selected').data();
            var parametros = {
              'idez': datos[0].IDOBRA.replace(" / ",","),
              "rol": $("#funcionConfigurarPersonalObras").val(),
              "idarea": datos[0].IDAREAFUNCIONAL,
              "idEstructura": datos[0].IDESTRUCTURA_OPERACION
            }
            await $.ajax({
              url:   'controller/datosPersonalObrasAsignar.php',
              type:  'post',
              data:  parametros,
              success: function (response2) {
                var p2 = jQuery.parseJSON(response2);
                var cuerpoPer = '<option value="0">Seleccionar Usuario</option>';
                if(p2.aaData.length !== 0){
                  for(var i = 0; i < p2.aaData.length; i++){
                    cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
                  }
                  $("#personalConfigurarPersonalObras").html(cuerpoPer);
                }
                else{
                  $("#personalConfigurarPersonalObras").html(cuerpoPer);
                }
              }
            });
            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              $("#personalConfigurarPersonalObras").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $("#funcionConfigurarPersonalObras").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
            };
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Ejecutado correctamente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalConfigurarPersonalObras").modal("show");
              setTimeout(function(){
                $('#tablaConfigurarPersonalObras').DataTable().columns.adjust();
              },500);
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $("#modalConfigurarPersonalObras").modal("show");
              setTimeout(function(){
                $('#tablaConfigurarPersonalObras').DataTable().columns.adjust();
              },500);
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ejecutar la operación, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalConfigurarPersonalObras").modal("show");
            setTimeout(function(){
              $('#tablaConfigurarPersonalObras').DataTable().columns.adjust();
            },500);
          },500);
        }
      }
    });
  }
});

$("#funcionConfigurarPersonalObras").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalConfigurarPersonalObras").modal("hide");
  e.stopImmediatePropagation();
  e.preventDefault();
  var table = $('#tablaListadoObras').DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    'idez': datos[0].IDOBRA.replace(" / ",","),
    "rol": $("#funcionConfigurarPersonalObras").val(),
    "idarea": datos[0].IDAREAFUNCIONAL,
    "idEstructura": datos[0].IDESTRUCTURA_OPERACION
  }
  await $.ajax({
    url:   'controller/datosPersonalObrasAsignar.php',
    type:  'post',
    data:  parametros,
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoPer = '<option value="0">Seleccionar Usuario</option>';
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoPer += '<option value="' + p2.aaData[i].IDUSUARIO + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
        }
        $("#personalConfigurarPersonalObras").html(cuerpoPer);
      }
      else{
        $("#personalConfigurarPersonalObras").html(cuerpoPer);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#personalConfigurarPersonalObras").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#funcionConfigurarPersonalObras").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  };

  setTimeout(function(){
    $("#modalConfigurarPersonalObras").modal("show");
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#nombreMantMateriales").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#codigoMantMateriales").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#selectComprasMaterialSBC").on('change', function(){
  $(this).next().find('.select2-selection').removeClass("select2-error");
});

$("#selectComprasMaterialGD3").on('change', function(){
  $(this).next().find('.select2-selection').removeClass("select2-error");
});

$("#selectComprasMaterialFE").on('change', function(){
  $(this).next().find('.select2-selection').removeClass("select2-error");
});

$("input#rutMantProveedores").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutMantProveedores").val() !== ''){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutMantProveedores").val("");
    $("#rutMantProveedores").addClass("is-invalid");
  }
});

$("#rutMantProveedores").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombreMantProveedores").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#emailMantProveedores").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#rutMantProveedores_upd").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombreMantProveedores_upd").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#emailMantProveedores_upd").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#selectComprasProveedoresAreaFuncional").unbind("click").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();

  await $.ajax({
    url: 'controller/datosPais.php',
    type: 'POST',
    dataType: 'json',
    data:  {
      "idarea": $("#selectComprasProveedoresAreaFuncional").val()
    },
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDPAIS;
        var label = p[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasProveedoresPais").html(options);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectComprasProveedoresAreaFuncional").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectComprasProveedoresPais").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#selectComprasProveedoresAreaFuncional_upd").unbind("click").change(async function(e){
  e.stopImmediatePropagation();
  e.preventDefault();

  await $.ajax({
    url: 'controller/datosPais.php',
    type: 'POST',
    dataType: 'json',
    data:  {
      "idarea": $("#selectComprasProveedoresAreaFuncional_upd").val()
    },
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDPAIS;
        var label = p[i].NOMBRE;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#selectComprasProveedoresPais_upd").html(options);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectComprasProveedoresAreaFuncional_upd").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#selectComprasProveedoresPais_upd").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#marcaMantenedorMateriales").unbind("click").change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorMateriales").DataTable();
  var item = $("#marcaMantenedorMateriales").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('4').search(item).draw();

  var cols = table.rows({ search: 'applied' }).data();

  const modeloMantSerArray = [];
  for(var i = 0; i < cols.length; i++){
    modeloMantSerArray.push(cols[i].MODELO);
  }

  let modeloMantSerUnique = [...new Set(modeloMantSerArray)];

  var modeloMantSer = '';
  modeloMantSer += '<option selected value="Todos">Todos</option>';
  for(var i = 0; i < modeloMantSerUnique.length; i++){
    if(modeloMantSerUnique[i] !== null){
      modeloMantSer += '<option value="' + modeloMantSerUnique[i] + '">' + modeloMantSerUnique[i] + '</option>';
    }
  }
  $("#modeloMantenedorMateriales").html(modeloMantSer);

  const tipoMantSerArray = [];
  for(var i = 0; i < cols.length; i++){
    tipoMantSerArray.push(cols[i].TIPO);
  }

  let tipoMantSerUnique = [...new Set(tipoMantSerArray)];

  var tipoMantSer = '';
  tipoMantSer += '<option selected value="Todos">Todos</option>';
  for(var i = 0; i < tipoMantSerUnique.length; i++){
    if(tipoMantSerUnique[i] !== null){
      tipoMantSer += '<option value="' + tipoMantSerUnique[i] + '">' + tipoMantSerUnique[i] + '</option>';
    }
  }
  $("#tipoMantenedorMateriales").html(tipoMantSer);

  setTimeout(function(){
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#modeloMantenedorMateriales").select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#tipoMantenedorMateriales").select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
    },500);
  },500);
});

$("#modeloMantenedorMateriales").unbind("click").change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorMateriales").DataTable();
  var item = $("#modeloMantenedorMateriales").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('5').search(item).draw();

  if($("#modeloMantenedorMateriales").val() === "Todos"){
    $("#marcaMantenedorMateriales").removeAttr("disabled");
  }
  else{
    $("#marcaMantenedorMateriales").attr("disabled","disabled");
  }

  var cols = table.rows({ search: 'applied' }).data();

  const tipoMantSerArray = [];
  for(var i = 0; i < cols.length; i++){
    tipoMantSerArray.push(cols[i].TIPO);
  }

  let tipoMantSerUnique = [...new Set(tipoMantSerArray)];

  var tipoMantSer = '';
  tipoMantSer += '<option selected value="Todos">Todos</option>';
  for(var i = 0; i < tipoMantSerUnique.length; i++){
    if(tipoMantSerUnique[i] !== null){
      tipoMantSer += '<option value="' + tipoMantSerUnique[i] + '">' + tipoMantSerUnique[i] + '</option>';
    }
  }
  $("#tipoMantenedorMateriales").html(tipoMantSer);

  setTimeout(function(){
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#tipoMantenedorMateriales").select2('destroy').select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
    },500);
  },500);
});

$("#tipoMantenedorMateriales").unbind("click").change(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorMateriales").DataTable();
  var item = $("#tipoMantenedorMateriales").val();
  if(item == "Todos"){
    item = '';
  }
  table.rows('').deselect();
  table.columns('7').search(item).draw();

  if($("#tipoMantenedorMateriales").val() === "Todos"){
    $("#modeloMantenedorMateriales").removeAttr("disabled");
    if($("#modeloMantenedorMateriales").val() === "Todos"){
      $("#marcaMantenedorMateriales").removeAttr("disabled");
    }
    else{
      $("#marcaMantenedorMateriales").attr("disabled","disabled");
    }
  }
  else{
    $("#modeloMantenedorMateriales").attr("disabled","disabled");
    $("#marcaMantenedorMateriales").attr("disabled","disabled");
  }

  setTimeout(function(){
    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
    },500);
  },500);
});

$("#agregarMantenedorResponsables").unbind("click").click(async function(e){
  $("input:text").val('');
  // e.stopImmediatePropagation();
  // e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url:   'controller/datosEstructuraOperacionResponsable.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoEstruc = '<option value="0">Seleccionar</option>';
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEstruc += '<option value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '" nomen="' + p2.aaData[i].NOMENCLATURA + '">' + p2.aaData[i].SERVICIO + ' - ' + p2.aaData[i].CLIENTE + ' - ' + p2.aaData[i].ACTIVIDAD + '</option>';
        }
        $("#proyectoAgregarResponsableProyecto").html(cuerpoEstruc);
      }
      else{
        $("#proyectoAgregarResponsableProyecto").html(cuerpoEstruc);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoAgregarResponsableProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  else{
    var h = $(window).height() - 200;
    $("#bodyAgregarResponsableProyecto").css("height",h);
  }

  setTimeout(function(){
    $("#modalAgregarResponsableProyecto").modal("show")
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("input#dniAgregarResponsableProyecto").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#dniAgregarResponsableProyecto").val() !== ''){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#dniAgregarResponsableProyecto").val("");
    $("#dniAgregarResponsableProyecto").addClass("is-invalid");
  }
});

$("#dniAgregarResponsableProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#proyectoAgregarResponsableProyecto").unbind("click").change(function(){
  $("#nomProyectoAgregarResponsableProyecto").val($('select[id="proyectoAgregarResponsableProyecto"] option:selected').attr("nomen"));
});

$("#guardarAgregarResponsableProyecto").unbind("click").click(async function(e){
  if($("#dniAgregarResponsableProyecto").val() === "" || $("#nombreAgregarResponsableProyecto").val() === "" || $("#emailAgregarResponsableProyecto").val() === "" || $("#fonoAgregarResponsableProyecto").val() === "" || $("#proyectoAgregarResponsableProyecto").val() === "0"){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos marcados en rojo");
    $("#proyectoAgregarResponsableProyecto").next().find('.select2-selection').addClass("select2-error");
    $("#dniAgregarResponsableProyecto").addClass("is-invalid");
    $("#nombreAgregarResponsableProyecto").addClass("is-invalid");
    $("#emailAgregarResponsableProyecto").addClass("is-invalid");
    $("#fonoAgregarResponsableProyecto").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalAgregarResponsableProyecto").modal("hide");

    var parametros = {};

    $('#bodyAgregarResponsableProyecto').find('input, select').each(function() {
      if($(this).attr("id") === "dniAgregarResponsableProyecto"){
        parametros[$(this).attr("id")] = $(this).val().replace(".","").replace(".","");
      }
      else{
        parametros[$(this).attr("id")] = $(this).val();
      }
    });

    $.ajax({
      url: "controller/ingresarResponsableProyecto.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorResponsables').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Responsable ingresado correctamente");
            $("#editarMantenedorResponsables").attr("disabled","disabled");
            $("#eliminarMantenedorResponsables").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El proyecto ya tiene asignado su responsable");
            setTimeout(function(){
              $("#modalAgregarResponsableProyecto").modal('show');
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El proyecto ya tiene asignado su responsable");
          setTimeout(function(){
            $("#modalAgregarResponsableProyecto").modal('show');
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#nombreAgregarResponsableProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#emailAgregarResponsableProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#fonoAgregarResponsableProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#proyectoAgregarResponsableProyecto").on('change', function(){
  $(this).next().find('.select2-selection').removeClass("select2-error");
});

$("#editarMantenedorResponsables").unbind("click").click(async function(e){
  $("input:text").val('');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $("#tablaMantenedorResponsables").DataTable()
  var datos = table.rows('.selected').data();

  await $.ajax({
    url:   'controller/datosEstructuraOperacion.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoEstruc = '<option value="0">Seleccionar</option>';
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          if(datos[0].IDPROYECTO === p2.aaData[i].IDESTRUCTURA_OPERACION){
            cuerpoEstruc += '<option selected value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '" nomen="' + p2.aaData[i].NOMENCLATURA + '">' + p2.aaData[i].SERVICIO + ' - ' + p2.aaData[i].CLIENTE + ' - ' + p2.aaData[i].ACTIVIDAD + '</option>';

            $("#nomProyectoEditarResponsableProyecto").val(p2.aaData[i].NOMENCLATURA);
          }
          else{
            cuerpoEstruc += '<option value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '" nomen="' + p2.aaData[i].NOMENCLATURA + '">' + p2.aaData[i].SERVICIO + ' - ' + p2.aaData[i].CLIENTE + ' - ' + p2.aaData[i].ACTIVIDAD + '</option>';
          }
        }
        $("#proyectoEditarResponsableProyecto").html(cuerpoEstruc);
      }
      else{
        $("#proyectoEditarResponsableProyecto").html(cuerpoEstruc);
      }
    }
  });

  $("#tituloEditarResponsableProyecto").html("Folio: " + datos[0].FOLIO + "<br>ID Proyecto: " + datos[0].IDPROYECTO);
  $("#dniEditarResponsableProyecto").val(datos[0].DNI);
  $("#nombreEditarResponsableProyecto").val(datos[0].NOMBRE);
  $("#emailEditarResponsableProyecto").val(datos[0].EMAIL);
  $("#fonoEditarResponsableProyecto").val(datos[0].FONO);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoEditarResponsableProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  else{
    var h = $(window).height() - 200;
    $("#bodyEditarResponsableProyecto").css("height",h);
  }

  setTimeout(function(){
    $("#modalEditarResponsableProyecto").modal("show")
    $('#modalAlertasSplash').modal('hide');
  },1000);
});

$("input#dniEditarResponsableProyecto").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#dniEditarResponsableProyecto").val() !== ''){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#dniEditarResponsableProyecto").val("");
    $("#dniEditarResponsableProyecto").addClass("is-invalid");
  }
});

$("#dniEditarResponsableProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombreEditarResponsableProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#emailEditarResponsableProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#fonoEditarResponsableProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#proyectoEditarResponsableProyecto").on('change', function(){
  $(this).next().find('.select2-selection').removeClass("select2-error");
});

$("#guardarEditarResponsableProyecto").unbind("click").click(async function(e){
  if($("#dniEditarResponsableProyecto").val() === "" || $("#nombreEditarResponsableProyecto").val() === "" || $("#emailEditarResponsableProyecto").val() === "" || $("#fonoEditarResponsableProyecto").val() === "" || $("#proyectoEditarResponsableProyecto").val() === "0"){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos marcados en rojo");
    $("#dniEditarResponsableProyecto").addClass("is-invalid");
    $("#nombreEditarResponsableProyecto").addClass("is-invalid");
    $("#emailEditarResponsableProyecto").addClass("is-invalid");
    $("#fonoEditarResponsableProyecto").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEditarResponsableProyecto").modal("hide");

    var table = $("#tablaMantenedorResponsables").DataTable()
    var datos = table.rows('.selected').data();

    var parametros = {};

    parametros['idresponsable'] = datos[0].FOLIO;

    $('#bodyEditarResponsableProyecto').find('input, select').each(function() {
      if($(this).attr("id") === "dniEditarResponsableProyecto"){
        parametros[$(this).attr("id")] = $(this).val().replace(".","").replace(".","");
      }
      else{
        parametros[$(this).attr("id")] = $(this).val();
      }
    });

    $.ajax({
      url: "controller/editarResponsableProyecto.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorResponsables').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Responsable editado correctamente");
            $("#editarMantenedorResponsables").attr("disabled","disabled");
            $("#eliminarMantenedorResponsables").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible editar el responsable, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $("#modalEditarResponsableProyecto").modal('show');
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible editar el responsable, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $("#modalEditarResponsableProyecto").modal('show');
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#eliminarMantenedorResponsables").unbind("click").click(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $("#tablaMantenedorResponsables").DataTable()
  var datos = table.rows('.selected').data();

  $("#cabeceraEliminarResponsableProyecto").html("Folio: " + datos[0].FOLIO + "<br>ID Proyecto: " + datos[0].IDPROYECTO);
  $("#tituloEliminarResponsableProyecto").html("Proyecto: " + datos[0].PROYECTO + "<br>Nom. Proyecto: " + datos[0].NOMENCLATURA + "<br><br>Responsable: " + datos[0].NOMBRE);

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEliminarResponsableProyecto").modal('show');
  },500);
});

$("#guardarEliminarResponsableProyecto").unbind("click").click(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEliminarResponsableProyecto").modal('hide');

  var table = $("#tablaMantenedorResponsables").DataTable()
  var datos = table.rows('.selected').data();

  var parametros = {
    "id": datos[0].FOLIO
  }

  $.ajax({
    url: "controller/eliminarResponsableProyecto.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaMantenedorResponsables').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Responsable eliminado correctamente");
          $("#editarMantenedorResponsables").attr("disabled","disabled");
          $("#eliminarMantenedorResponsables").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible eliminar el responsable, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $("#modalEliminarResponsableProyecto").modal('show');
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible eliminar el responsable, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $("#modalEliminarResponsableProyecto").modal('show');
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

// Pendientes Flota
$("#configurarChecks").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#agregarCheck").attr("disabled","disabled");
  $("#editarCheck").attr("disabled","disabled");
  $("#eliminarCheck").attr("disabled","disabled");


  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/40);

  await $.ajax({
    url:   'controller/datosCheckTipoVehiculo.php',
    type:  'post',
    success: function (resp) {
      var m = jQuery.parseJSON(resp);
      if(m.aaData.length !== 0){
        var cuerpoCT = '';
        cuerpoCT += '<option selected value="0">Seleccionar elemento</option>';
        for(var i = 0; i < m.aaData.length; i++){
          cuerpoCT += '<option value="' + m.aaData[i].IDCHECKTIPO + '">' + m.aaData[i].NOMBRE + '</option>';
        }
        $("#selectorTipoConfigChecksTipoVeh").html(cuerpoCT);
      }
    }
  });

  var parametros = {
    "checkTipo": $("#selectorTipoConfigChecksTipoVeh").val()
  }

  await $('#tablaConfigChecksTipoVeh').DataTable( {
      ajax: {
          url: "controller/datosListaChecksTipoVehiculo.php",
          type: 'POST',
          data: parametros
      },
      columns: [
          { data: 'S'},
          { data: 'FOLIO'},
          { data: 'ITEM'},
          { data: 'TIPO'},
          { data: 'INDISPENSABLE'},
          { data: 'DESCONTABLE'}
      ],
      "columnDefs": [
        {
          "width": "5px",
          "targets": 0
        },
        {
          "orderable": false,
          "className": 'select-checkbox',
          "targets": [ 0 ]
        },
      ],
      "select": {
          style: 'single',
          //selector: 'td:not(:nth-child(5))'
      },
      "scrollX": true,
      "paging": true,
      "ordering": true,
      "scrollCollapse": true,
      "info":     true,
      "lengthMenu": [[largo], [largo]],
      "dom": 'rtip',
      "language": {
        "zeroRecords": "No hay datos disponibles",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No hay datos disponibles",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "search": "Buscar: ",
          "select": {
              "rows": "- %d registros seleccionados"
          },
          "infoFiltered": "(Filtrado de _MAX_ registros)"
      },
      "destroy": true,
      "autoWidth": false,
      "initComplete": function( settings, json){
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalConfigChecksTipoVeh").modal("show");
          setTimeout(function(){
            $('#tablaConfigChecksTipoVeh').DataTable().columns.adjust();
          },500);
        },500);
      }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectorTipoConfigChecksTipoVeh").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$("#selectorTipoConfigChecksTipoVeh").unbind("click").change(async function(e){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalConfigChecksTipoVeh").modal("hide");
  e.stopImmediatePropagation();
  e.preventDefault();
  if(parseInt($("#selectorTipoConfigChecksTipoVeh").val()) === 0){
    $("#agregarCheck").attr("disabled","disabled");
  }else{
    $("#agregarCheck").removeAttr("disabled");
  }
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/40);

  var parametros = {
    "checkTipo": $("#selectorTipoConfigChecksTipoVeh").find('option:selected').text()
  }
  await $('#tablaConfigChecksTipoVeh').DataTable( {
    ajax: {
        url: "controller/datosListaChecksTipoVehiculo.php",
        type: 'POST',
        data: parametros
    },
    columns: [
        { data: 'S'},
        { data: 'FOLIO'},
        { data: 'ITEM'},
        { data: 'TIPO'},
        { data: 'INDISPENSABLE'},
        { data: 'DESCONTABLE'}
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      },
    ],
    "select": {
        style: 'single',
        //selector: 'td:not(:nth-child(5))'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'rtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
        $("#modalConfigChecksTipoVeh").modal("show");
        setTimeout(function(){
          $('#tablaConfigChecksTipoVeh').DataTable().columns.adjust();
        },500);
      },500);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectorTipoConfigChecksTipoVeh").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
});

$('#tablaConfigChecksTipoVeh tbody').on( 'click', 'tr', function () {
  setTimeout(async function(){
    var table = $('#tablaConfigChecksTipoVeh').DataTable();
    var data = table.rows('.selected').data();
    if(data.length <= 0){
      $("#editarCheck").attr("disabled","disabled");
      $("#eliminarCheck").attr("disabled","disabled");
    }
    else{
      $("#editarCheck").removeAttr("disabled");
      $("#eliminarCheck").removeAttr("disabled");
    }
  },200);
});

// FUNCION PARA MODAL INGRESAR CHECK
$("#agregarCheck").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalConfigChecksTipoVeh").modal("hide");
  $("#itemIngresoCheck").val("");
  $("#itemIngresoCheck").removeClass("is-invalid");

  tipo = $("#selectorTipoConfigChecksTipoVeh").find('option:selected').text();
  $("#tipoIngresoCheck").val(tipo);
  $("#tipoIngresoCheck").attr("disabled","disabled");

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#indispensableIngresoCheck").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#descontableIngresoCheck").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(function(){
    $("#modalIngresoCheck").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoCheck').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarIngresoCheck").unbind('click').click(function(){
  if($("#itemIngresoCheck").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#itemIngresoCheck").val().length == 0){
      $("#itemIngresoCheck").addClass("is-invalid");
    }
  }
  else {
    parametros = {
      "item": $("#itemIngresoCheck").val(),
      "tipo": $("#tipoIngresoCheck").val(),
      "indispensable": $("#indispensableIngresoCheck").val(),
      "descontable": $("#descontableIngresoCheck").val(),
    }
    $("#modalIngresoCheck").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaCheckTipoVehiculo.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaConfigChecksTipoVeh').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Check creado correctamente");
            $("#editarCheck").attr("disabled","disabled");
            $("#eliminarCheck").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $('#modalIngresoCheck').modal('show');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear check, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $('#modalIngresoCheck').modal('show');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al crear check, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalIngresoCheck').modal('show');
          },500);
        }
      }
    });
  }
});

$("#itemIngresoCheck").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN PARA MODAL INGRESAR CHECK

// FUNCION PARA MODAL EDITAR CHECK
$("#editarCheck").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalConfigChecksTipoVeh").modal("hide");
  $("#tipoEditarCheck").attr("disabled","disabled");

  var table = $('#tablaConfigChecksTipoVeh').DataTable();
  var item = $.map(table.rows('.selected').data(), function (item) {
    return item.ITEM;
  });
  var tipo = $.map(table.rows('.selected').data(), function (item) {
    return item.TIPO;
  });
  var indispensable = $.map(table.rows('.selected').data(), function (item) {
    return item.INDISPENSABLE;
  });
  var descontable = $.map(table.rows('.selected').data(), function (item) {
    return item.DESCONTABLE;
  });

  if (indispensable[0] === 'Si'){
    $("#indispensableEditarCheck").html('<option value="Si">Si</option>,<option value="No">No</option>');
  }
  else if(indispensable[0] === 'No'){
    $("#indispensableEditarCheck").html('<option value="No">No</option>,<option value="Si">Si</option>');
  }else{
    $("#indispensableEditarCheck").html('<option value=""></option>,<option value="Si">Si</option>,<option value="No">No</option>');
  }


  if (descontable[0] === 'Si'){
    $("#descontableEditarCheck").html('<option value="Si">Si</option>,<option value="No">No</option>');
  }
  else if(descontable[0] === 'No'){
    $("#descontableEditarCheck").html('<option value="No">No</option>,<option value="Si">Si</option>');
  }else{
    $("#descontableEditarCheck").html('<option value=""></option>,<option value="Si">Si</option>,<option value="No">No</option>');
  }

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#indispensableEditarCheck").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#descontableEditarCheck").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#itemEditarCheck").val(item);
  $("#tipoEditarCheck").val(tipo);
  $("#indispensableEditarCheck").val(indispensable);
  $("#descontableEditarCheck").val(descontable);

  setTimeout(function(){
    $("#modalEditarCheck").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyEditarCheck').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarEditarCheck").unbind('click').click(function(){
  $("#modalEditarCheck").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaConfigChecksTipoVeh').DataTable();
  var folio = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  parametros = {
    "folio": folio[0],
    "item": $("#itemEditarCheck").val(),
    "tipo": $("#tipoEditarCheck").val(),
    "indispensable": $("#indispensableEditarCheck").val(),
    "descontable": $("#descontableEditarCheck").val(),
  }
  $.ajax({
    url: "controller/editarCheckTipoVehiculo.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaConfigChecksTipoVeh').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Check editada correctamente");
          $("#editarCheck").attr("disabled","disabled");
          $("#eliminarCheck").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalConfigChecksTipoVeh').modal('show');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar check, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalConfigChecksTipoVeh').modal('show');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar check, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $('#modalConfigChecksTipoVeh').modal('show');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL EDITAR CHECK

// FUNCION PARA MODAL ELIMINAR CHECK
$("#eliminarCheck").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalConfigChecksTipoVeh").modal("hide");
  var table = $('#tablaConfigChecksTipoVeh').DataTable();
  var folio = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  var item = $.map(table.rows('.selected').data(), function (item) {
    return item.ITEM;
  });
  var tipo = $.map(table.rows('.selected').data(), function (item) {
    return item.TIPO;
  });

  $("#itemEliminarCheck").html(item + ' - ' + tipo);
  setTimeout(function(){
    $("#modalEliminarCheck").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyEliminarCheck').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarEliminarCheck").unbind('click').click(async function(){
  $("#modalEliminarCheck").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaConfigChecksTipoVeh').DataTable();
  var folio = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  parametros = {
    "folio": folio[0],
  }
  await $.ajax({
    url:   'controller/eliminarCheckTipoVehiculo.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaConfigChecksTipoVeh').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Check eliminada correctamente");
          $("#editarCheck").attr("disabled","disabled");
          $("#eliminarCheck").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalConfigChecksTipoVeh').modal('show');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El elemento seleccionado no se puede eliminar ya que posee datos asociados al sistema");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalConfigChecksTipoVeh').modal('show');
          },500);
        }
      }else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El elemento seleccionado no se puede elimina ya que posee datos asociados al sistema");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $('#modalConfigChecksTipoVeh').modal('show');
        },500);
      }
    }
  });
});
//  FIN FUNCION PARA MODAL ELIMINAR CHECK

// FUNCION PARA MODAL INGRESAR CHECKTIPO
$("#agregarCheckTipoConfigChecksTipoVeh").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalConfigChecksTipoVeh").modal("hide");
  $("#nombreIngresoCheckTipo").val("");
  $("#nombreIngresoCheckTipo").removeClass("is-invalid");

  setTimeout(function(){
    $("#modalIngresoCheckTipo").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoCheckTipo').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarIngresoCheckTipo").unbind('click').click(function(){
  if($("#nombreIngresoCheckTipo").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#nombreIngresoCheckTipo").val().length == 0){
      $("#nombreIngresoCheckTipo").addClass("is-invalid");
    }
  }
  else {
    parametros = {
      "nombre": $("#nombreIngresoCheckTipo").val(),
    }
    $("#modalIngresoCheckTipo").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaNombreChechTipoVehiculo.php",
      type: 'POST',
      data: parametros,
      success: function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>CheckTipo creado correctamente");
            $.ajax({
              url:   'controller/datosCheckTipoVehiculo.php',
              type:  'post',
              success: function (resp) {
                var m = jQuery.parseJSON(resp);
                if(m.aaData.length !== 0){
                  var cuerpoCT = '';
                  cuerpoCT += '<option selected value="0">Seleccionar elemento</option>';
                  for(var i = 0; i < m.aaData.length; i++){
                    cuerpoCT += '<option value="' + m.aaData[i].IDCHECKTIPO + '">' + m.aaData[i].NOMBRE + '</option>';
                  }
                  $("#selectorTipoConfigChecksTipoVeh").html(cuerpoCT);
                }
              }
            });
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $('#modalConfigChecksTipoVeh').modal('show');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Ya existe un nombre igual");
            $("#nombreIngresoCheckTipo").addClass("is-invalid");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $('#modalConfigChecksTipoVeh').modal('show');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Ya existe un nombre igual");
          $("#nombreIngresoCheckTipo").addClass("is-invalid");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalConfigChecksTipoVeh').modal('show');
          },500);
        }
      }
    });
  }
});

$("#nombreIngresoCheckTipo").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN PARA MODAL INGRESAR CHECKTIPO

async function cargarComprasPeticiones() {
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  await $('#tablaMantenedorPeticiones').DataTable({
    ajax: {
      url: "controller/datosComprasPeticiones.php",
      type: 'POST',
      data: {}
    },
    columns: [
      { data: 'S'},
      { data: 'IDCOMPRAS_PETICION', className: "centerDataTable"},
      { data: 'OPERACION' },
      { data: 'US_RUT' },
      { data: 'US_NOMBRE' },
      { data: 'CER_DNI' },
      { data: 'CER_NOMBRE' },
      { data: 'AF_COMUNA' },
      { data: 'PEP' },
      { data: 'FECHA_PEDIDO' },
      { data: 'HORA_PEDIDO' },
      { data: 'FECHA_LIMITE' },
      { data: 'REFACTURABLE' },
      { data: 'REGULARIZACION' },
      { data: 'TIPO' },
      { data: 'ESTADO' },
    ],
    buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        },
        {
          text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
          action: function ( e, dt, node, config ) {
            var table = $('#tablaMantenedorMateriales').DataTable();
            $("#editarMantenedorMaterial").attr("disabled","disabled");
            $("#eliminarMantenedorMaterial").attr("disabled","disabled");
            $("#masivoMantenedorMaterial").attr("disabled","disabled");
            table.rows().deselect();
          }
        }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      }
    ],
    "select": {
      style: 'single',
      // selector: 'td:not(:nth-child(20))'
    },
    // fixedColumns:   {
    //   leftColumns: 2
    // },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "order": [[ 1, "desc" ]],
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json) {
      var table = $('#tablaMantenedorPeticiones').DataTable();

      $('#contenido').show();
      $('#menu-lateral').show();
      $('#footer').parent().show();
$('#footer').show();

      esconderMenu();
      menuElegant();
      setTimeout(async function(){
        $('#tablaMantenedorPeticiones').DataTable().columns.adjust();
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      },1500);
    }
  });

  await $.ajax({
    url:   'controller/datosAccionesVisibles.php',
    type:  'post',
    data: {
      "path": window.location.href.split('#/')[1]
    },
    success: function (response) {
      var p = jQuery.parseJSON(response);
      $("#accionesMantenedorPeticiones").html('');
      if(p.aaData.length !== 0){
        for(var i = 0; i < p.aaData.length; i++) {
          if(p.aaData[i].VISIBLE == 1){
            if(p.aaData[i].ENABLE == 1){
              $("#accionesMantenedorPeticiones").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
            else{
              $("#accionesMantenedorPeticiones").append('<div class="col-xl-2 col-lg-2 col-md-4 col-sm-12 col-xs-12" style="padding-right: 0;"><button disabled class="form-control btn btn-secondary botonComun" id="' + p.aaData[i].IDBOTON + '"><span class="' + p.aaData[i].ICONO + '"></span>&nbsp;&nbsp;' + p.aaData[i].TEXTO + '</button></div>');
            }
          }
        }
      }
    }
  });

  setTimeout(function(){
    var js = document.createElement('script');
    js.src = 'view/js/funciones.js?idLoad=205';
    document.getElementsByTagName('head')[0].appendChild(js);
  },500);
}

$("#nuevaPeticionCompra").unbind('click').click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#proyectoAgregarMantPeticiones").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var min = new Date();
  $("#fechaLimiteAgregarMantPeticiones").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    minDate: min,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  var largo = 5;
  await $("#tablaMantenedorPeticionesModal").dataTable({
    buttons: [
      {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15 ],
            format: {
                body: function(data, row, column, node) {
                   return column == 12 ? data.replace( '.', '' ).replace( ',', '.' ) : data.replace('.','').replace(',','.');

                }
            }
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
      },
      {
        text: '<span class="far fa-plus-square"></span>&nbsp;&nbsp;Agregar',
        action: function ( e, dt, node, config ) {
          var table = $('#tablaMantenedorPeticionesModal').DataTable();
          table.row.add(['','','<select name="selServPeticionDin" class="form-control"><option value="SET">Servicio</option><option value="MAT">Material</option></select>','','','','<select name="selProdPeticionDin" class="form-control"></select>','','','','','','','','','']);
          table.draw();
          // if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          //   $("select[name*=selServPeticionDin]").select2({
          //       theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          //   });
          // }
        }
      },
      {
        text: '<span class="far fa-minus-square"></span>&nbsp;&nbsp;Eliminar',
        action: function ( e, dt, node, config ) {
          var table = $('#tablaMantenedorPeticionesModal').DataTable();

        }
      },
      {
        text: '<span class="far fa-minus-square"></span>&nbsp;&nbsp;Eliminar todo',
        action: function ( e, dt, node, config ) {
          var table = $('#tablaMantenedorPeticionesModal').DataTable();

        }
      }

    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      }
    ],
    "select": {
        style: 'single',
        selector: 'td:not(:nth-child(3))'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    // "order": [[ 2, "asc" ]],
    "info": true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
        "zeroRecords": "No tiene personal bajo su cargo",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No tiene personal bajo su cargo",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)",
        "loadingRecords": "&nbsp;",
        "processing": "Loading..."
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      $("#tituloAgregarMantPeticiones").html("N° Pedido: XXXXX");

      var h = $(window).height() - 200;
      $("#bodyAgregarMantPeticiones").css("height",h);
      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
        $('#modalAgregarMantPeticiones').modal('show');
        setTimeout(function(){
          $('#tablaMantenedorPeticionesModal').DataTable().columns.adjust();
        },500);
      },500);
    }
  });
});

$("#documentosObra").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#nombrePdfIngresarDocumentosObra").val("");
  $("#inputPdfIngresarDocumentosObra").val("");
  $("#observacionIngresarDocumentosObra").val("");
  $("#nombrePdfIngresarDocumentosObra").removeClass("is-invalid");
  $("#inputPdfIngresarDocumentosObra").removeClass("is-invalid");
  var table = $('#tablaListadoObras').DataTable();
  var folios = $.map(table.rows('.selected').data(), function (item) {
    return item.IDOBRA;
  });
  var oe = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBREOE;
  });
  var tipo = $.map(table.rows('.selected').data(), function (item) {
    return item.TIPO;
  });
  $("#oeIngresarDocumentosObra").html('Orden de ejecución: ' + oe);
  $("#folioIngresarDocumentosObra").html('Folio: ' + folios);
  $("#tipoIngresarDocumentosObra").html('Tipo: ' + tipo);

  var tipoSelect = '';
  if(folios[0].includes('/')){
    var folio1 = folios[0].split('/')[0].trim();
    var folio2 = folios[0].split('/')[1].trim();
    var tipo1 = tipo[0].split('/')[0].trim();
    var tipo2 = tipo[0].split('/')[1].trim();
    tipoSelect += '<option  value="0">Seleccione un tipo</option>';
    tipoSelect += '<option  value=' + folio1 + '>' + tipo1 + '</option>';
    tipoSelect += '<option  value=' + folio2 + '>' + tipo2 + '</option>';
  }else{
    tipoSelect += '<option  value=' + folios[0] + '>' + tipo + '</option>';
  }

  $("#selectTipoIngresarDocumentosObra").html(tipoSelect);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#selectTipoIngresarDocumentosObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/80);

  var parametros = {
    "folio": folios[0]
  }
  await $('#tablaIngresarDocumentosObra').DataTable( {
        ajax: {
            url: "controller/datosDocumPermisoObras.php",
            type: 'POST',
            data: parametros
        },
        columns: [
            { data: 'S'},
            { data: 'FOLIO'},
            { data: 'NOMBRE'},
            { data: 'ARCHIVO'},
            { data: 'TIPO_ARCHIVO'},
            { data: 'DOCUMENTO', className: "centerDataTable"},
            { data: 'VAL', className: "centerDataTable"},
            { data: 'TIPO'},
            { data: 'OBSERVACION', className: "centerDataTable"}
        ],
        "columnDefs": [
          {
            "width": "5px",
            "targets": 0
          },
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
        ],
        "select": {
            style: 'single',
            //selector: 'td:not(:nth-child(5))'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        "order": [[ 1, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'rtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": function( settings, json){
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalIngresarDocumentosObra").modal("show");
            var h = $(window).height() - 300;
            $("#bodyIngresarDocumentosObra").css("height",h);
            setTimeout(function(){
              $('#tablaIngresarDocumentosObra').DataTable().columns.adjust();
            },500);
          },500);
        }
    });
});

$("#pdfCargaIngresarDocumentosObra" ).on('change', function(e){
  var file = e.target.files[0].name; // agarramos solo el nombre([0].name) del array que tiene tamaño, fecha y mas
  $("#inputPdfIngresarDocumentosObra").val(file);
  $("#inputPdfIngresarDocumentosObra").removeClass("is-invalid");
});

$("#guardarPDfIngresarDocumentosObra").unbind("click").click(async function(){
  nombre = $("#nombrePdfIngresarDocumentosObra").val();
  observacion = $("#observacionIngresarDocumentosObra").val();
  file = $("#inputPdfIngresarDocumentosObra").val();
  tipoFile = $("#inputPdfIngresarDocumentosObra").val().split(".")[1];
  folio = $("#selectTipoIngresarDocumentosObra").val();

  if(nombre.length != 0 && file.length != 0 && folio != "0"){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalIngresarDocumentosObra").modal("hide");

    var formdata = new FormData();
    formdata.append('folio',folio);
    formdata.append('nombre',nombre);
    formdata.append('file',$("#pdfCargaIngresarDocumentosObra")[0].files[0]);
    formdata.append('tipoFile',tipoFile);
    formdata.append('observacion',observacion);
    $.ajax({
      url: "controller/ingresaDocumPermisoObras.php",
      type: 'POST',
      data: formdata,
      cache: false,
      contentType: false,
      processData: false,
      success: function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaIngresarDocumentosObra').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>PDF cargado correctamente");
            $("#nombrePdfIngresarDocumentosObra").val("");
            $("#inputPdfIngresarDocumentosObra").val("");
            $("#observacionIngresarDocumentosObra").val("");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $('#modalIngresarDocumentosObra').modal('show');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar PDF, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $('#modalIngresarDocumentosObra').modal('show');
            },500);
          }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar PDF, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              $('#modalIngresarDocumentosObra').modal('show');
            },500);
          }
        }
    });
  }
  else{
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar un nombre, documento y seleccionar un tipo");
    if ($("#nombrePdfIngresarDocumentosObra").val().length == 0){
      $("#nombrePdfIngresarDocumentosObra").addClass("is-invalid");
    }
    if ($("#inputPdfIngresarDocumentosObra").val().length == 0){
      $("#inputPdfIngresarDocumentosObra").addClass("is-invalid");
    }
  }
});

$("#nombrePdfIngresarDocumentosObra").on('input', function(){
  $(this).removeClass("is-invalid");
});

async function documentoObras(pdf){
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    window.open(window.location.toString().split("#/")[0].split('?')[0] + 'controller/repositorio/obras/' + pdf, '_blank');
  }
}

$("#cubicacionObra").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoObras').DataTable();
  var folio = $.map(table.rows('.selected').data(), function (item) {
    return item.IDOBRA;
  });
  var oecf = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBREOE;
  });
  var codCub = $.map(table.rows('.selected').data(), function (item) {
    return item.CUBICACION;
  });
  var agencia = $.map(table.rows('.selected').data(), function (item) {
    return item.AGENCIA;
  });
  $("#changeSelectorTipo").val("0");
  await obras_cubicacion(folio[0],oecf,codCub,agencia);
});

// FUNCION PARA MODAL MANTENEDOR ESPECIALIDAD OBRA
$("#agregarEspecialidad").unbind("click").click(function(){
  $("#nombreIngresoMantEspecialidad").removeClass("is-invalid");
  $("#codigoIngresoMantEspecialidad").removeClass("is-invalid");
  $("#nombreIngresoMantEspecialidad").val("");
  $("#codigoIngresoMantEspecialidad").val("");
  $("#modalIngresoAgencias").find("input,textarea,select").val("");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  setTimeout(function(){
    $("#modalIngresoMantEspecialidad").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoMantEspecialidad').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarIngresoMantEspecialidad").unbind('click').click(function(){
  if($("#nombreIngresoMantEspecialidad").val().length == 0 || $("#codigoIngresoMantEspecialidad").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#nombreIngresoMantEspecialidad").val().length == 0){
      $("#nombreIngresoMantEspecialidad").addClass("is-invalid");
    }
    if ($("#codigoIngresoMantEspecialidad").val().length == 0){
      $("#codigoIngresoMantEspecialidad").addClass("is-invalid");
    }
  }
  else {
    parametros = {
      "especialidad": $("#nombreIngresoMantEspecialidad").val(),
      "codEspecialidad": $("#codigoIngresoMantEspecialidad").val(),
    }
    $("#modalIngresoMantEspecialidad").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaMantenedorEspecialidad.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoEspecialidad').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Especialidad ingresada correctamente");
            $("#editarEspecialidad").attr("disabled","disabled");
            $("#eliminarEspecialidad").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar una especialidad ya que existe un ID duplicado");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar una especialidad ya que existe un ID duplicado");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#nombreIngresoMantEspecialidad").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#codigoIngresoMantEspecialidad").on('input', function(){
  $(this).removeClass("is-invalid");
});
// FIN PARA MODAL INGRESAR MANTENEDOR ESPECIALIDAD OBRA

// FUNCION PARA MODAL EDITAR MANTENEDOR ESPECIALIDAD OBRA
$("#editarEspecialidad").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoEspecialidad').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.ESPECIALIDAD;
  });
  var codigo = $.map(table.rows('.selected').data(), function (item) {
    return item.CODESP;
  });

  $("#nombreEditarMantEspecialidad").val(nombre);
  $("#codigoEditarMantEspecialidad").val(codigo);

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEditarMantEspecialidad").modal("show");
  },500);
});

$("#guardarEditarMantEspecialidad").unbind('click').click(function(){
  var table = $('#tablaListadoEspecialidad').DataTable();
  var idEspecialidad = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  parametros = {
    "idEspecialidad": idEspecialidad[0],
    "nombre":  $("#nombreEditarMantEspecialidad").val(),
    "codigo":  $("#codigoEditarMantEspecialidad").val(),
  }
  $("#modalEditarMantEspecialidad").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarMantenedorEspecialidad.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoEspecialidad').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Especialidad editado correctamente");
          $("#editarEspecialidad").attr("disabled","disabled");
          $("#eliminarEspecialidad").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar especialidad, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar especialidad, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});
// FIN FUNCION PARA MODAL EDITAR MANTENEDOR ESPECIALIDAD OBRA

// FUNCION PARA MODAL ELIMINAR MANTENEDOR ESPECIALIDAD OBRA
$("#eliminarEspecialidad").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoEspecialidad').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
    return item.ESPECIALIDAD;
  });

  $("#nombreEliminarMantEspecialidad").html(nombre);
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEliminarMantEspecialidad").modal("show");
  },500);
});

$("#guardarEliminarMantEspecialidad").unbind('click').click(async function(){
  var table = $('#tablaListadoEspecialidad').DataTable();
  var idEspecialidad = $.map(table.rows('.selected').data(), function (item) {
      return item.FOLIO;
  });
  parametros = {
    "idEspecialidad": idEspecialidad[0],
  }
  $("#modalEliminarMantEspecialidad").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarMantenedorEspecialidad.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoEspecialidad').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Especialidad eliminado correctamente");
            $("#editarEspecialidad").attr("disabled","disabled");
            $("#eliminarEspecialidad").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el especialidad");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el especialidad");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
//  FIN FUNCION PARA MODAL ELIMINAR MANTENEDOR ESPECIALIDAD OBRA


// FUNCION PARA MODAL MANTENEDOR UNIDAD DE OBRA
$("#agregarUnidadObra").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#proveedorIngresoMantUnidadObra").html('<option value="Cliente">Cliente</option>,<option value="Interno">Interno</option>');
  $("#nombreIngresoMantUnidadObra").removeClass("is-invalid");
  $("#codUoIngresoMantUnidadObra").removeClass("is-invalid");
  $("#codMatIngresoMantUnidadObra").removeClass("is-invalid");
  $("#valorIngresoMantUnidadObra").removeClass("is-invalid");
  $("#codClienteIngresoMantUnidadObra").removeClass("is-invalid");
  $("#nombreIngresoMantUnidadObra").val("");
  $("#codUoIngresoMantUnidadObra").val("");
  $("#codMatIngresoMantUnidadObra").val("");
  $("#valorIngresoMantUnidadObra").val(0);
  $("#codClienteIngresoMantUnidadObra").val("");

  $("#cod1IngresoMantUnidadObra").val("");
  $("#cod2IngresoMantUnidadObra").val("");
  $("#cod3IngresoMantUnidadObra").val("");

  await $.ajax({
    url:   'controller/datosListadoUmObras.php',
    type:  'post',
    success: function (res) {
      var p = jQuery.parseJSON(res);
      if(p.aaData.length !== 0){
        var cuerpoUM = '';
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoUM += '<option value="' + p.aaData[i].FOLIO + '">' + p.aaData[i].UM + '</option>';
        }
        $("#umIngresoMantUnidadObra").html(cuerpoUM);
      }
    }
  });


  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#umIngresoMantUnidadObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#proveedorIngresoMantUnidadObra").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalIngresoMantUnidadObra").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoMantUnidadObra').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarIngresoMantUnidadObra").unbind('click').click(function(){
  if($("#nombreIngresoMantUnidadObra").val().length == 0 || $("#codUoIngresoMantUnidadObra").val().length == 0 || $("#codMatIngresoMantUnidadObra").val().length == 0 || $("#valorIngresoMantUnidadObra").val().length == 0 || $("#codClienteIngresoMantUnidadObra").val().length == 0 || $("#valorIngresoMantUnidadObra").val() < 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#nombreIngresoMantUnidadObra").val().length == 0){
      $("#nombreIngresoMantUnidadObra").addClass("is-invalid");
    }
    if ($("#codUoIngresoMantUnidadObra").val().length == 0){
      $("#codUoIngresoMantUnidadObra").addClass("is-invalid");
    }
    if ($("#codMatIngresoMantUnidadObra").val().length == 0){
      $("#codMatIngresoMantUnidadObra").addClass("is-invalid");
    }
    if ($("#valorIngresoMantUnidadObra").val().length == 0){
      $("#valorIngresoMantUnidadObra").addClass("is-invalid");
    }
    if ($("#codClienteIngresoMantUnidadObra").val().length == 0){
      $("#codClienteIngresoMantUnidadObra").addClass("is-invalid");
    }
    if ($("#valorIngresoMantUnidadObra").val() < 0){
      $("#valorIngresoMantUnidadObra").addClass("is-invalid");
      var random = Math.round(Math.random() * (1000000 - 1) + 1);
      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
    }
  }
  else {
    parametros = {
      "nombre": $("#nombreIngresoMantUnidadObra").val(),
      "codigoUo": $("#codUoIngresoMantUnidadObra").val(),
      "codigoMat": $("#codMatIngresoMantUnidadObra").val(),
      "valor": $("#valorIngresoMantUnidadObra").val(),
      "proveedor": $("#proveedorIngresoMantUnidadObra").val(),
      "codCliente": $("#codClienteIngresoMantUnidadObra").val(),
      "um": $("#umIngresoMantUnidadObra").val(),
      "cod1": $("#cod1IngresoMantUnidadObra").val(),
      "cod2": $("#cod2IngresoMantUnidadObra").val(),
      "cod3": $("#cod3IngresoMantUnidadObra").val(),
    }
    $("#modalIngresoMantUnidadObra").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaMantenedorUnidadObra.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoUnidadObra').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Unidad de obra ingresada correctamente");
            $("#editarUnidadObra").attr("disabled","disabled");
            $("#eliminarUnidadObra").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar una unidad de obra ya que existe un ID duplicado");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar una unidad de obra ya que existe un ID duplicado");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#nombreIngresoMantUnidadObra").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#codUoIngresoMantUnidadObra").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#codMatIngresoMantUnidadObra").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#valorIngresoMantUnidadObra").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#codClienteIngresoMantUnidadObra").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#valorIngresoMantUnidadObra" ).focusout(function(){
  valorUO = $("#valorIngresoMantUnidadObra").val();
  if(valorUO < 0){
    $("#valorIngresoMantUnidadObra").val(0);
    $("#valorIngresoMantUnidadObra").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
  }
  else{
    $("#valorIngresoMantUnidadObra").val(valorUO);
  }
});
// FIN PARA MODAL INGRESAR MANTENEDOR UNIDAD DE OBRA

// FUNCION PARA MODAL EDITAR MANTENEDOR UNIDAD DE OBRA
$("#editarUnidadObra").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoUnidadObra').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  var codigoUo = $.map(table.rows('.selected').data(), function (item) {
    return item.CODUO;
  });
  var codigoMat = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO2_CLIENTE;
  });
  var valor = $.map(table.rows('.selected').data(), function (item) {
    return item.VALOR;
  });
  var proveedor = $.map(table.rows('.selected').data(), function (item) {
    return item.PROVEE;
  });
  var codCliente = $.map(table.rows('.selected').data(), function (item) {
    return item.COD_FIN_CLIENTE;
  });
  var um = $.map(table.rows('.selected').data(), function (item) {
    return item.UM;
  });

  var cod1 = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO1_INTERNO;
  });
  var cod2 = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO2_INTERNO;
  });
  var cod3 = $.map(table.rows('.selected').data(), function (item) {
    return item.CODIGO3_INTERNO;
  });

  if (proveedor[0] == "Cliente" || proveedor[0] == "CLIENTE"){
    $("#proveedorEditarMantUnidadObra").html('<option value="Cliente">Cliente</option>,<option value="Interno">Interno</option>');
  }
  else {
    $("#proveedorEditarMantUnidadObra").html('<option value="Interno">Interno</option>,<option value="Cliente">Cliente</option>');
  }

  await $.ajax({
    url:   'controller/datosListadoUmObras.php',
    type:  'post',
    success: function (resp) {
      var s = jQuery.parseJSON(resp);
      if(s.aaData.length !== 0){
        var cuerpoUM = '';
        for(var i = 0; i < s.aaData.length; i++){
          if(um == s.aaData[i].UM){
            cuerpoUM += '<option selected value="' + s.aaData[i].FOLIO + '">' + s.aaData[i].UM + '</option>';
          }
          else{
            cuerpoUM += '<option value="' + s.aaData[i].FOLIO + '">' + s.aaData[i].UM + '</option>';
          }
        }
        $("#umEditarMantUnidadObra").html(cuerpoUM);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#umEditarMantUnidadObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#proveedorEditarMantUnidadObra").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#nombreEditarMantUnidadObra").val(nombre);
  $("#codUoEditarMantUnidadObra").val(codigoUo);
  $("#codMatEditarMantUnidadObra").val(codigoMat);
  $("#valorEditarMantUnidadObra").val(valor);
  $("#codClienteEditarMantUnidadObra").val(codCliente);

  $("#cod1EditarMantUnidadObra").val(cod1);
  $("#cod2EditarMantUnidadObra").val(cod2);
  $("#cod3EditarMantUnidadObra").val(cod3);

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $('#modalEditarMantUnidadObra').modal('show');
  },500);
});

$("#guardarEditarMantUnidadObra").unbind('click').click(function(){
  var table = $('#tablaListadoUnidadObra').DataTable();
  var folioUO = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  parametros = {
    "folioUO": folioUO[0],
    "nombre":  $("#nombreEditarMantUnidadObra").val(),
    "codUO":  $("#codUoEditarMantUnidadObra").val(),
    "codMat":  $("#codMatEditarMantUnidadObra").val(),
    "valor":  $("#valorEditarMantUnidadObra").val(),
    "proveedor":  $("#proveedorEditarMantUnidadObra").val(),
    "codCliente":  $("#codClienteEditarMantUnidadObra").val(),
    "um":  $("#umEditarMantUnidadObra").val(),
    "cod1":  $("#cod1EditarMantUnidadObra").val(),
    "cod2":  $("#cod2EditarMantUnidadObra").val(),
    "cod3":  $("#cod3EditarMantUnidadObra").val(),
  }
  $("#modalEditarMantUnidadObra").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarMantenedorUnidadObra.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoUnidadObra').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Unidad de obra editado correctamente");
          $("#editarUnidadObra").attr("disabled","disabled");
          $("#eliminarUnidadObra").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar unidad de obra, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar unidad de obra, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#valorEditarMantUnidadObra" ).focusout(function(){
  valorUOE = $("#valorEditarMantUnidadObra").val();
  if(valorUOE < 0){
    $("#valorEditarMantUnidadObra").val(0);
    $("#valorEditarMantUnidadObra").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
  }
  else{
    $("#valorEditarMantUnidadObra").val(valorUOE);
  }
});
// FIN FUNCION PARA MODAL EDITAR MANTENEDOR UNIDAD DE OBRA

// FUNCION PARA MODAL ELIMINAR MANTENEDOR UNIDAD DE OBRA
$("#eliminarUnidadObra").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoUnidadObra').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBRE;
  });

  $("#nombreEliminarMantUnidadObra").html(nombre);
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEliminarMantUnidadObra").modal("show");
  },500);
});

$("#guardarEliminarMantUnidadObra").unbind('click').click(async function(){
  var table = $('#tablaListadoUnidadObra').DataTable();
  var idUnidadObra = $.map(table.rows('.selected').data(), function (item) {
      return item.FOLIO;
  });
  parametros = {
    "idUnidadObra": idUnidadObra[0],
  }
  $("#modalEliminarMantUnidadObra").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarMantenedorUnidadObra.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoUnidadObra').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Unidad de obra eliminado correctamente");
            $("#editarUnidadObra").attr("disabled","disabled");
            $("#eliminarUnidadObra").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el unidad de obra");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el unidad de obra");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
//  FIN FUNCION PARA MODAL ELIMINAR MANTENEDOR UNIDAD DE OBRA


// FUNCION PARA MODAL MANTENEDOR MANO DE OBRA
$("#agregarManoObra").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#nombreIngresoMantManoObra").removeClass("is-invalid");
  $("#codigoIngresoMantManoObra").removeClass("is-invalid");
  $("#cantidadIngresoMantManoObra").removeClass("is-invalid");
  $("#pbIngresoMantManoObra").removeClass("is-invalid");
  $("#nombreIngresoMantManoObra").val("");
  $("#codigoIngresoMantManoObra").val("");
  $("#cantidadIngresoMantManoObra").val(0);
  $("#pbIngresoMantManoObra").val(0);

  await $.ajax({
    url:   'controller/datosListadoMantenedorEspecialidad.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].FOLIO + '">' + p2.aaData[i].ESPECIALIDAD + '</option>';
        }
        $("#especialidadIngresoMantManoObra").html(cuerpoEC);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosListadoUmObras.php',
    type:  'post',
    success: function (res) {
      var p = jQuery.parseJSON(res);
      if(p.aaData.length !== 0){
        var cuerpoUM = '';
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoUM += '<option value="' + p.aaData[i].FOLIO + '">' + p.aaData[i].UM + '</option>';
        }
        $("#umIngresoMantManoObra").html(cuerpoUM);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#especialidadIngresoMantManoObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#umIngresoMantManoObra").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
  });
  }

  setTimeout(function(){
    $("#modalIngresoMantManoObra").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoMantManoObra').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarIngresoMantManoObra").unbind('click').click(function(){
  if($("#nombreIngresoMantManoObra").val().length == 0 || $("#codigoIngresoMantManoObra").val().length == 0 || $("#cantidadIngresoMantManoObra").val().length == 0 || $("#pbIngresoMantManoObra").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#nombreIngresoMantManoObra").val().length == 0){
      $("#nombreIngresoMantManoObra").addClass("is-invalid");
    }
    if ($("#codigoIngresoMantManoObra").val().length == 0){
      $("#codigoIngresoMantManoObra").addClass("is-invalid");
    }
    if ($("#cantidadIngresoMantManoObra").val().length == 0){
      $("#cantidadIngresoMantManoObra").addClass("is-invalid");
    }
    if ($("#pbIngresoMantManoObra").val().length == 0){
      $("#pbIngresoMantManoObra").addClass("is-invalid");
    }
  }
  else {
    parametros = {
      "nombre": $("#nombreIngresoMantManoObra").val(),
      "codigo": $("#codigoIngresoMantManoObra").val(),
      "especialidad": $("#especialidadIngresoMantManoObra").val(),
      "um": $("#umIngresoMantManoObra").val(),
      "cantidad": $("#cantidadIngresoMantManoObra").val(),
      "pb": $("#pbIngresoMantManoObra").val(),
    }
    $("#modalIngresoMantManoObra").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaMantenedorManoObra.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoManoObra').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Mano de obra ingresada correctamente");
            $("#editarManoObra").attr("disabled","disabled");
            $("#eliminarManoObra").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar una mano de obra ya que existe un ID duplicado");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar una mano de obra ya que existe un ID duplicado");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#nombreIngresoMantManoObra").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#codigoIngresoMantManoObra").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#cantidadIngresoMantManoObra").on('input', function(){
  $(this).removeClass("is-invalid");
});
$("#pbIngresoMantManoObra").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#cantidadIngresoMantManoObra" ).focusout(function(){
  cant = $("#cantidadIngresoMantManoObra").val();
  if(cant < 0){
    $("#cantidadIngresoMantManoObra").val(0);
    $("#cantidadIngresoMantManoObra").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
  }
  else{
    $("#cantidadIngresoMantManoObra").val(cant);
  }
});

$("#pbIngresoMantManoObra" ).focusout(function(){
  pbMO = $("#pbIngresoMantManoObra").val();
  if(pbMO < 0){
    $("#pbIngresoMantManoObra").val(0);
    $("#pbIngresoMantManoObra").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
  }
  else{
    $("#pbIngresoMantManoObra").val(pbMO);
  }
});
// FIN PARA MODAL INGRESAR MANTENEDOR MANO DE OBRA

// FUNCION PARA MODAL EDITAR MANTENEDOR MANO DE OBRA
$("#editarManoObra").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoManoObra').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
      return item.DESCRIPCION;
  });
  var codigo = $.map(table.rows('.selected').data(), function (item) {
    return item.CODMO;
  });
  var cantidad = $.map(table.rows('.selected').data(), function (item) {
    return item.CANTIDAD;
  });
  var pb = $.map(table.rows('.selected').data(), function (item) {
    return item.PB;
  });
  var especialidad = $.map(table.rows('.selected').data(), function (item) {
    return item.ESPECIALIDAD;
  });
  var um = $.map(table.rows('.selected').data(), function (item) {
    return item.UM;
  });

  await $.ajax({
    url:   'controller/datosListadoMantenedorEspecialidad.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoTV = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(especialidad == p2.aaData[i].ESPECIALIDAD){
            cuerpoTV += '<option selected value="' + p2.aaData[i].FOLIO + '">' + p2.aaData[i].ESPECIALIDAD + '</option>';
          }
          else{
            cuerpoTV += '<option value="' + p2.aaData[i].FOLIO + '">' + p2.aaData[i].ESPECIALIDAD + '</option>';
          }
        }
        $("#especialidadEditarMantManoObra").html(cuerpoTV);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosListadoUmObras.php',
    type:  'post',
    success: function (resp) {
      var s = jQuery.parseJSON(resp);
      if(s.aaData.length !== 0){
        var cuerpoUM = '';
        for(var i = 0; i < s.aaData.length; i++){
          if(um == s.aaData[i].UM){
            cuerpoUM += '<option selected value="' + s.aaData[i].FOLIO + '">' + s.aaData[i].UM + '</option>';
          }
          else{
            cuerpoUM += '<option value="' + s.aaData[i].FOLIO + '">' + s.aaData[i].UM + '</option>';
          }
        }
        $("#umEditarMantManoObra").html(cuerpoUM);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#especialidadEditarMantManoObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#umEditarMantManoObra").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
  });
  }

  $("#nombreEditarMantManoObra").val(nombre);
  $("#codigoEditarMantManoObra").val(codigo);
  $("#cantidadEditarMantManoObra").val(cantidad);
  $("#pbEditarMantManoObra").val(pb);

  setTimeout(function(){
    $("#modalEditarMantManoObra").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyEditarMantManoObra').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarEditarMantManoObra").unbind('click').click(function(){
  var table = $('#tablaListadoManoObra').DataTable();
  var folioMO = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  parametros = {
    "folioMO": folioMO[0],
    "nombre":  $("#nombreEditarMantManoObra").val(),
    "codigo":  $("#codigoEditarMantManoObra").val(),
    "especialidad":  $("#especialidadEditarMantManoObra").val(),
    "um":  $("#umEditarMantManoObra").val(),
    "cantidad":  $("#cantidadEditarMantManoObra").val(),
    "pb":  $("#pbEditarMantManoObra").val(),
  }
  $("#modalEditarMantManoObra").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarMantenedorManoObra.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoManoObra').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Mano de obra editado correctamente");
          $("#editarManoObra").attr("disabled","disabled");
          $("#eliminarManoObra").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar mano de obra, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar mano de obra, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#cantidadEditarMantManoObra" ).focusout(function(){
  cantMOE = $("#cantidadEditarMantManoObra").val();
  if(cantMOE < 0){
    $("#cantidadEditarMantManoObra").val(0);
    $("#cantidadEditarMantManoObra").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
  }
  else{
    $("#cantidadEditarMantManoObra").val(cantMOE);
  }
});

$("#pbEditarMantManoObra" ).focusout(function(){
  pbMOE = $("#pbEditarMantManoObra").val();
  if(pbMOE < 0){
    $("#pbEditarMantManoObra").val(0);
    $("#pbEditarMantManoObra").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
  }
  else{
    $("#pbEditarMantManoObra").val(pbMOE);
  }
});
// FIN FUNCION PARA MODAL EDITAR MANTENEDOR MANO DE OBRA

// FUNCION PARA MODAL ELIMINAR MANTENEDOR MANO DE OBRA
$("#eliminarManoObra").unbind('click').click(function(){
  var table = $('#tablaListadoManoObra').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
    return item.DESCRIPCION;
  });

  $("#nombreEliminarMantManoObra").html(nombre);
  $('#modalEliminarMantManoObra').modal('show');
});

$("#guardarEliminarMantManoObra").unbind('click').click(async function(){
  var table = $('#tablaListadoManoObra').DataTable();
  var idManoObra = $.map(table.rows('.selected').data(), function (item) {
      return item.FOLIO;
  });
  parametros = {
    "idManoObra": idManoObra[0],
  }
  $("#modalEliminarMantManoObra").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarMantenedorManoObra.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoManoObra').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Mano de obra eliminado correctamente");
            $("#editarManoObra").attr("disabled","disabled");
            $("#eliminarManoObra").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el mano de obra");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el mano de obra");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
//  FIN FUNCION PARA MODAL ELIMINAR MANTENEDOR MANO DE OBRA


// FUNCION PARA MODAL MANTENEDOR VALOR MANO DE OBRA
$("#agregarManoValor").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#valorIngresoMantValorManoObra").removeClass("is-invalid");
  $("#valorIngresoMantValorManoObra").val(0);

  await $.ajax({
    url:   'controller/datosListadoMantenedorEspecialidad.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].FOLIO + '">' + p2.aaData[i].ESPECIALIDAD + '</option>';
        }
        $("#especialidadIngresoMantValorManoObra").html(cuerpoEC);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosAreaFuncional.php',
    type:  'post',
    success: function (resp) {
      var t = jQuery.parseJSON(resp);
      if(t.aaData.length !== 0){
        var cuerpoAF = '';
        for(var i = 0; i < t.aaData.length; i++){
          cuerpoAF += '<option value="' + t.aaData[i].IDAREAFUNCIONAL + '">' + t.aaData[i].COMUNA + '</option>';
        }
        $("#comunaIngresoMantValorManoObra").html(cuerpoAF);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosListadoAgencias.php',
    type:  'post',
    success: function (res) {
      var c = jQuery.parseJSON(res);
      if(c.aaData.length !== 0){
        var cuerpoAG = '';
        for(var i = 0; i < c.aaData.length; i++){
          cuerpoAG += '<option value="' + c.aaData[i].IDOBRA_AGENCIA + '">' + c.aaData[i].NOMBRE + '</option>';
        }
        $("#agenciaIngresoMantValorManoObra").html(cuerpoAG);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#especialidadIngresoMantValorManoObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaIngresoMantValorManoObra").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#agenciaIngresoMantValorManoObra").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalIngresoMantValorManoObra").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyIngresoMantValorManoObra').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarIngresoMantValorManoObra").unbind('click').click(function(){
  if($("#valorIngresoMantValorManoObra").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#valorIngresoMantValorManoObra").val().length == 0){
      $("#valorIngresoMantValorManoObra").addClass("is-invalid");
    }
  }
  else {
    parametros = {
      "comuna": $("#comunaIngresoMantValorManoObra").val(),
      "agencia": $("#agenciaIngresoMantValorManoObra").val(),
      "especialidad": $("#especialidadIngresoMantValorManoObra").val(),
      "valor": $("#valorIngresoMantValorManoObra").val(),
    }
    $("#modalIngresoMantValorManoObra").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaMantenedorValorManoObra.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoManoObraValor').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Valor de mano de obra ingresada correctamente");
            $("#editarManoValor").attr("disabled","disabled");
            $("#eliminarManoValor").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar un valor de mano de obra ya que existe un valor duplicado");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede ingresar un valor de mano de obra ya que existe un valor duplicado");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);s
        }
      }
    });
  }
});

$("#valorIngresoMantValorManoObra").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#valorIngresoMantValorManoObra" ).focusout(function(){
  valorr = $("#valorIngresoMantValorManoObra").val();
  if(valorr < 0){
    $("#valorIngresoMantValorManoObra").val(0);
    $("#valorIngresoMantValorManoObra").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
  }
  else{
    $("#valorIngresoMantValorManoObra").val(valorr);
  }
});
// FIN PARA MODAL INGRESAR MANTENEDOR VALOR MANO DE OBRA

// FUNCION PARA MODAL EDITAR MANTENEDOR VALOR MANO DE OBRA
$("#editarManoValor").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoManoObraValor').DataTable();
  var comuna = $.map(table.rows('.selected').data(), function (item) {
      return item.COMUNA;
  });
  var agencia = $.map(table.rows('.selected').data(), function (item) {
    return item.AGENCIA;
  });
  var especialidad = $.map(table.rows('.selected').data(), function (item) {
    return item.ESPECIALIDAD;
  });
  var valor = $.map(table.rows('.selected').data(), function (item) {
    return item.VALOR;
  });

  await $.ajax({
    url:   'controller/datosListadoMantenedorEspecialidad.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoTV = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(especialidad == p2.aaData[i].ESPECIALIDAD){
            cuerpoTV += '<option selected value="' + p2.aaData[i].FOLIO + '">' + p2.aaData[i].ESPECIALIDAD + '</option>';
          }
          else{
            cuerpoTV += '<option value="' + p2.aaData[i].FOLIO + '">' + p2.aaData[i].ESPECIALIDAD + '</option>';
          }
        }
        $("#especialidadEditarMantValorManoObra").html(cuerpoTV);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosAreaFuncional.php',
    type:  'post',
    success: function (respon) {
      var p5 = jQuery.parseJSON(respon);
      if(p5.aaData.length !== 0){
        var cuerpoES = '';
        for(var i = 0; i < p5.aaData.length; i++){
          if(comuna == p5.aaData[i].COMUNA){
            cuerpoES += '<option selected value="' + p5.aaData[i].IDAREAFUNCIONAL + '">' + p5.aaData[i].COMUNA + '</option>';
          }
          else{
            cuerpoES += '<option value="' + p5.aaData[i].IDAREAFUNCIONAL + '">' + p5.aaData[i].COMUNA + '</option>';
          }
        }
        $("#comunaEditarMantValorManoObra").html(cuerpoES);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosListadoAgencias.php',
    type:  'post',
    success: function (respons) {
      var p6 = jQuery.parseJSON(respons);
      if(p6.aaData.length !== 0){
        var cuerpoAG = '';
        for(var i = 0; i < p6.aaData.length; i++){
          if(agencia == p6.aaData[i].NOMBRE){
            cuerpoAG += '<option selected value="' + p6.aaData[i].IDOBRA_AGENCIA + '">' + p6.aaData[i].NOMBRE + '</option>';
          }
          else{
            cuerpoAG += '<option value="' + p6.aaData[i].IDOBRA_AGENCIA + '">' + p6.aaData[i].NOMBRE + '</option>';
          }
        }
        $("#agenciaEditarMantValorManoObra").html(cuerpoAG);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#especialidadEditarMantValorManoObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#comunaEditarMantValorManoObra").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#agenciaEditarMantValorManoObra").select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#valorEditarMantValorManoObra").val(valor);

  setTimeout(function(){
    $("#modalEditarMantValorManoObra").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyEditarMantValorManoObra').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarEditarMantValorManoObra").unbind('click').click(function(){
  var table = $('#tablaListadoManoObraValor').DataTable();
  var folioValorMO = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  parametros = {
    "folioValorMO": folioValorMO[0],
    "comuna":  $("#comunaEditarMantValorManoObra").val(),
    "agencia":  $("#agenciaEditarMantValorManoObra").val(),
    "especialidad":  $("#especialidadEditarMantValorManoObra").val(),
    "valor":  $("#valorEditarMantValorManoObra").val(),
  }
  $("#modalEditarMantValorManoObra").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $.ajax({
    url: "controller/editarMantenedorValorManoObra.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoManoObraValor').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Valor de mano de obra editado correctamente");
          $("#editarManoValor").attr("disabled","disabled");
          $("#eliminarManoValor").attr("disabled","disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede editar un valor de mano de obra ya que existe un valor duplicado");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No puede editar un valor de mano de obra ya que existe un valor duplicado");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#valorEditarMantValorManoObra" ).focusout(function(){
  valorrED = $("#valorEditarMantValorManoObra").val();
  if(valorrED < 0){
    $("#valorEditarMantValorManoObra").val(0);
    $("#valorEditarMantValorManoObra").addClass("is-invalid");
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede ingresar un valor por debajo de 0");
  }
  else{
    $("#valorEditarMantValorManoObra").val(valorrED);
  }
});
// FIN FUNCION PARA MODAL EDITAR MANTENEDOR VALOR MANO DE OBRA

// FUNCION PARA MODAL ELIMINAR MANTENEDOR VALOR MANO DE OBRA
$("#eliminarManoValor").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoManoObraValor').DataTable();
  var comuna = $.map(table.rows('.selected').data(), function (item) {
      return item.COMUNA;
  });
  var agencia = $.map(table.rows('.selected').data(), function (item) {
    return item.AGENCIA;
  });
  var especialidad = $.map(table.rows('.selected').data(), function (item) {
    return item.ESPECIALIDAD;
  });
  var valor = $.map(table.rows('.selected').data(), function (item) {
    return item.VALOR;
  });

  $("#nombreEliminarMantValorManoObra").html(comuna + ' - ' + agencia + ' - ' + especialidad + ' - ' + valor);

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalEliminarMantValorManoObra").modal("show");
  },500);
});

$("#guardarEliminarMantValorManoObra").unbind('click').click(async function(){
  var table = $('#tablaListadoManoObraValor').DataTable();
  var folioValorMO = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  parametros = {
    "folioValorMO": folioValorMO[0],
  }
  $("#modalEliminarMantValorManoObra").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarMantenedorValorManoObra.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoManoObraValor').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Valor de mano de obra eliminado correctamente");
            $("#editarManoValor").attr("disabled","disabled");
            $("#eliminarManoValor").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el valor de mano de obra");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al eliminar el valor de mano de obra");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
//  FIN FUNCION PARA MODAL ELIMINAR MANTENEDOR VALOR MANO DE OBRA

$("#asignarSubcc").unbind("click").click(async function(){
  var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  var estructura = $.map(table.rows('.selected').data(), function (item) {
      return item.ESTRUCTURA_OPERACION;
  });
  var comuna = $.map(table.rows('.selected').data(), function (item) {
    return item.COMUNA;
  });
  var fechaIniTerreno = $.map(table.rows('.selected').data(), function (item) {
    return item.FECHA_INI_TERRENO;
  });
  var fechaFinTerreno = $.map(table.rows('.selected').data(), function (item) {
    return item.FECHA_FIN_TERRENO;
  });
  if(estructura.length <= 0 || fechaIniTerreno.length <= 0 || fechaFinTerreno.length <= 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede asignar brigada si no tiene un proyecto interno o fechas de inicio y fin en terreno asignados");
  }else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var parametros = {
      'estructura': estructura[0],
      'comuna': comuna[0],
    }
    await $.ajax({
      url:   'controller/datosListadoBrigadaOt.php',
      type:  'post',
      data: parametros,
      success: function (resp) {
        var t = jQuery.parseJSON(resp);
        if(t.aaData.length !== 0){
          var cuerpoAF = '<option  value="0">Seleccione una opción</option>';
          for(var i = 0; i < t.aaData.length; i++){
            cuerpoAF += '<option value="' + t.aaData[i].IDS + '">' + t.aaData[i].DATOS + '</option>';
          }
          $("#brigadaAsignarSubccObra").html(cuerpoAF);
        }
        else{
          var cuerpoAF = '<option  value="0">Sin datos</option>';
          $("#brigadaAsignarSubccObra").html(cuerpoAF);
        }
      }
    });

    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#brigadaAsignarSubccObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }

    setTimeout(function(){
      $("#modalAsignarSubccObra").modal("show");
      $('#modalAlertasSplash').modal('hide');
      setTimeout(function(){
        $('#bodyAsignarSubccObra').animate({ scrollTop: 0 }, 'fast');
      },200);
    },500);
  }
});

$("#guardarAsignarSubccObra").unbind('click').click(function(){
  var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  var folio = $.map(table.rows('.selected').data(), function (item) {
      return item.FOLIO;
  });
  if($("#brigadaAsignarSubccObra").val() == '0'){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una opción");
  }else{
    parametros = {
      "folio": folio[0],
      "empresaSubcc":  $("#brigadaAsignarSubccObra").val().split('%%%')[1],
      "gestorSubcc":  $("#brigadaAsignarSubccObra").val().split('%%%')[0],
      "estado" : 'Pte. Materiales',
    }
    $("#modalAsignarSubccObra").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/asignarEmpresaGestorOt.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoOrdenesTrabajo').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Empresa y gestor subcc. asignado correctamente");
            $("#asignarFechaTerreno").attr("disabled","disabled");
            $("#asignarSubcc").attr("disabled","disabled");
            $("#duplicarOt").attr("disabled","disabled");
            $("#eliminarOt").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar empresa y gestor subcc.");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar empresa y gestor subcc.");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#asignarSubirXmlCaratulaObras").unbind("click").click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalSubirXmlCaratulaObras").modal("hide");
  var pr = '';
  if($("#proyectistaCaratula").parent().css('display') === 'none'){
    pr = 'supervisor';
  }else{
    pr = 'proyectista';
  }
  parametros = {
    "jefeProyecto": $("#jefeProyectoCaratula").val(),
    "supervisor": $("#superisorCaratula").val(),
    "proyectista": $("#proyectistaCaratula").val(),
    "nombreOe" : $("#nombreOeAsignarPers").val(),
    "pr" : pr,
  }
  $.ajax({
    url: "controller/asignarPersIngresandoCaratula.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaListadoObras').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Personal asignado correctamente");
          $("#detalleObraCaratula").attr("disabled", "disabled");
          $("#cubicacionObra").attr("disabled", "disabled");
          $("#usuariosRolesObra").attr("disabled", "disabled");
          $("#documentosObra").attr("disabled", "disabled");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar personal, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar personal, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#jefeProyectoCaratula,#proyectistaCaratula,#superisorCaratula").unbind("click").change(function(){
  var pr = '';
  if($("#proyectistaCaratula").parent().css('display') === 'none'){
    pr = 'supervisor';
  }else{
    pr = 'proyectista';
  }
  if(pr === "supervisor"){
    if($("#jefeProyectoCaratula").val() !== "0" || $("#superisorCaratula").val() !== "0"){
      $("#asignarSubirXmlCaratulaObras").removeAttr("disabled");
    }
    else{
      $("#asignarSubirXmlCaratulaObras").attr("disabled","disabled");
    }
  }
  else{
    if($("#jefeProyectoCaratula").val() !== "0" || $("#proyectistaCaratula").val() !== "0"){
      $("#asignarSubirXmlCaratulaObras").removeAttr("disabled");
    }
    else{
      $("#asignarSubirXmlCaratulaObras").attr("disabled","disabled");
    }
  }
});

$("#tipoFiltroSiniestros").unbind("click").change(function(){
  var table = $("#tablaListadoSiniestros").DataTable();
  var ceco = $("#tipoFiltroSiniestros").val();
  if(ceco == "Todos"){
    ceco = '';
  }
  table.rows('').deselect();
  table.columns('7').search(ceco).draw();
});

$("#cancelarIngresoCheckTipo,#cancelarEditarCheck,#cancelarEliminarCheck").unbind("click").click(function(){
  $("#modalConfigChecksTipoVeh").modal("show");
});

async function cargarMantenedorPracticas() {
  await $.ajax({
    url: "controller/datosAuditoriaMeta.php",
    type: 'POST',
    data: { },
    dataType: 'json',
    success: async function (response) {
      var options = '';
      response.aaData.forEach(({ ID, TITULO }) => {
        options += `<option value="${ID}">${TITULO}</option>`;
      });
      $("#auditoriaMantenedorPracticas").html(options);

      if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        $("#auditoriaMantenedorPracticas").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
      }

      fancygridPracticas(response.aaData[0].ID);
    }
  });
}

async function fancygridPracticas(idAuditoria) {
  $('#tablaMantenedorPracticas').remove();
  $('#parentTablaMantenedorPracticas').append(`
    <div id="tablaMantenedorPracticas">
    </div>
  `);

  var largo = Math.trunc($(window).height() - 350);

  FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];

  var grid = new FancyGrid({
    renderTo: 'tablaMantenedorPracticas',
    scrollable: true,
    selModel: {
      type: 'rows'
    },
    theme: 'bootstrap',
    height: largo,
    data: {
      proxy: {
        url: 'controller/datosFormularioEstructuras.php',
        method: 'GET',
        params: {
          idAuditoria: idAuditoria
        }
      },
      fields: [
        'DIFF', 'ID', 'FAMILIA', 'TEXTOFAMILIA', 'CATEGORIA', 'TEXTOCATEGORIA'
      ]
    },
    trackOver: true,
    defaults: {
      // resizable: true,
      sortable: true,
      align: 'left',
      cellAlign: 'left'
    },
    cellHeight: 45,
    columns: [
      {
        type: 'select'
      },
      {
        type: 'tree',
        title: 'Item',
        index: 'TEXTOFAMILIA',
        flex: 5,

      },
      {
        title: 'Elemento',
        index: 'TEXTOCATEGORIA',
        flex: 5,

      },
    ],
    events: [
      {
        cellclick: function(grid, o){
          if(o.columnIndex == 3 && !o.data.FAMILIA.includes('-')){
            // detallePracticasFallasPersonas(o.data.FAMILIA, o.data.CATEGORIA);
          }
        },
        update: function(grid){
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    ],
    exporter: true,
    tbar: [
      {
        type: 'search',
        width: 200,
        emptyText: 'Buscar',
      },
      {
        text: 'Excel',
        handler: function() {
          this.expandAll();
          this.exportToExcel();
          this.collapseAll();
        }
      },
      {
        text: 'Expandir Todo',
        handler: function() {
          this.expandAll();
        }
      },
      {
        text: 'Colapsar Todo',
        handler: function() {
          this.collapseAll();
        }
      },
      {
        text: 'Agregar Elemento',
        handler: async function() {
          $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
          $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
          $('#modalAlertasSplash').modal('show');

          await $.ajax({
            url:   'controller/datosFormularioEstructuraFamilia.php',
            type:  'post',
            data: {
              idAuditoria: $('#auditoriaMantenedorPracticas').val(),
            },
            dataType: 'json',
            success: function (response) {
              var cuerpo = '';
              cuerpo += '<option selected value="noaplica">No aplica</option>';
              for(var i = 0; i < response.aaData.length; i++){
                cuerpo += '<option value="' + response.aaData[i].FAMILIA + '">' + response.aaData[i].TEXTOFAMILIA + '</option>';
              }
              $("#formularioFamilia").html(cuerpo);

              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#formularioFamilia").select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
              }
              setTimeout(async function(){
                $('#modalAddFormularioCategoria').modal('show');
                $('#modalAlertasSplash').modal('hide');
              },500);

            }
          });
        }
      },
      {
        text: 'Agregar Anomalia',
        handler: function() {
          var dataselected = this.getSelection();
          var parents = dataselected.filter((item) => item.DIFF === 'parent');
          if (parents.length === 1 && dataselected[0].DIFF === 'parent') {
            $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
            $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
            $('#modalAlertasSplash').modal('show');

            var dataselected = this.getSelection();
            $('#idFormularioEstructura').val(dataselected[0].ID);

            setTimeout(async function(){
              $('#modalAddFormularioFalla').modal('show');
              $('#modalAlertasSplash').modal('hide');
            },500);
          } else {
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una categoría y solo 1 elemento a la vez");
          }
        }
      },
      {
        text: 'Eliminar',
        handler: async function() {
          var dataselected = this.getSelection();
          if (dataselected.length > 0) {
            var parents = dataselected.filter((item) => item.DIFF === 'parent');
            var categorias = parents.map(({ CATEGORIA }) => CATEGORIA);
            var orphan = dataselected.filter((item) => item.DIFF !== 'parent');
            var idsFallas = orphan.map(({ ID }) => ID);

            $('#catsFormEstruct').val(categorias.join(','));
            $('#idsFallsFormEstruc').val(idsFallas.join(','));

            $('#modalDelFormularioFalla').modal('show');
          } else {
            alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar por lo menos 1 item");
          }
        }
      }
    ]
  });

  setTimeout(function(){
    $("a[href|='http://www.fancygrid.com']").parent().remove();
  }, 2000);
}

$("#formularioFamilia").change(function () {
  if ($('#formularioFamilia').val() === 'noaplica') {
    $('#formularioFamiliaNuevo').removeAttr('disabled');
  } else {
    $('#formularioFamiliaNuevo').attr('disabled', 'disabled');
  }
});

$('#guardarFormularioCategoriaAdd').unbind('click').click(async function () {
  $('#modalAddFormularioCategoria').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var inpFamilia = $('#formularioFamiliaNuevo').val();
  var inpCategoria = $('#formularioCategoriaAdd').val();
  $("input:text").val('');

  var data = {
    categoria: `li${inpCategoria.replace(/\s/g, '')}`,
    textocategoria: inpCategoria,
    idAuditoria: $('#auditoriaMantenedorPracticas').val(),
  }

  if ($('#formularioFamilia').val() === 'noaplica') {
    data['familia'] = `li${inpFamilia.replace(/\s/g, '')}`;
    data['textofamilia'] = inpFamilia;
  } else {
    data['familia'] = $('#formularioFamilia').val();
    data['textofamilia'] = $('#formularioFamilia option:selected').html();
  }

  await $.ajax({
    url:   'controller/ingresaFormularioEstructuraCategoria.php',
    type:  'post',
    data: data,
    success: function (response) {
      if (response === 'Sin datos') {
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No se puede agregar un elemento duplicado u ocurrió un problema al ingresar el dato");
      } else {
        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Elemento ingresado correctamente");
        fancygridPracticas($("#auditoriaMantenedorPracticas").val());
      }
    }
  });

});

function sanitizerSentence(sentence) {
  var sanitized = sentence.replace(/\s/g, '').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  return sanitized.charAt(0).toUpperCase() + sanitized.slice(1);
}

$('#guardarFormularioFallaAdd').unbind('click').click(async function () {
  $('#modalAddFormularioFalla').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var inpFalla = $('#inpFormularioFalla').val();
  $("input:text").val('');
  var falla = `li${sanitizerSentence(inpFalla)}`;

  var data = {
    idEstructura: $('#idFormularioEstructura').val(),
    falla: falla,
    textofalla: inpFalla,
    puntaje: 1
  }

  await $.ajax({
    url:   'controller/ingresaFormularioEstructuraFalla.php',
    type:  'post',
    data: data,
    success: async function (response) {
      if (response === 'Sin datos') {
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No se puede agregar una anomalía duplicada u ocurrió un problema al ingresar el dato");
      } else {
        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Anomalía ingresada correctamente");
        fancygridPracticas($("#auditoriaMantenedorPracticas").val());

        console.log('-----response-----')
        console.log(response);
        await $.ajax({
          url:   'controller/ingresaIncidenciaEstructura.php',
          type:  'post',
          data: {
            item: 'liFamiliaItem',
            elemento: 'liCategoriaElemento',
            anomalia: inpFalla
          },
          success: async function (response) {
          }
        });

      }
    }
  });
});

$('#guardarFormularioEstructuraDel').unbind('click').click(async function () {
  $('#modalDelFormularioFalla').modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var categorias = $('#catsFormEstruct').val().split(',');
  var idsFallas = $('#idsFallsFormEstruc').val().split(',');

  await $.ajax({
    url:   'controller/eliminarFormularioEstructura.php',
    type:  'post',
    data: {
      categorias: categorias,
      idsFallas: idsFallas,
    },
    success: function (response) {
      alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Items eliminados correctamente");
      fancygridPracticas($("#auditoriaMantenedorPracticas").val());
    }
  });
});

$("#agregarPais").unbind('click').click(function(){
  $("#modalAgregarPais").find("input,textarea,select").val("");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  setTimeout(async function(){
    $("#modalAgregarPais").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#guardarAgregarPais").unbind('click').click(async function(){
  if($.trim($("#abreviaturaAgregarPais").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#abreviaturaAgregarPais").addClass("is-invalid");
  }
  else if($.trim($("#nombreAgregarPais").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#nombreAgregarPais").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalAgregarPais").modal("hide");
    parametros = {
      "abreviaturaPais": $("#abreviaturaAgregarPais").val(),
      "nombrePais": $("#nombreAgregarPais").val()
    }

    await $.ajax({
      url: "controller/ingresaPais.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        if(response.localeCompare("Sin datos") != 0 && response != ""){
          $('#modalAlertasSplash').modal('hide');
          var table = $('#tablaMantenedorPaises').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>País agregado correctamente");
          $("#editarPais").attr("disabled","disabled");
          }
        else{
          $('#modalAlertasSplash').modal('hide');
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al agregar País");
        }
      }
    });
  }
});

$("#abreviaturaAgregarPais").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombreAgregarPais").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#editarPais").unbind('click').click(function(){
  var table = $('#tablaMantenedorPaises').DataTable();
  var datos = table.rows('.selected').data();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#abreviaturaEditarPais").val(datos[0].ABREVIATURA);
  $("#nombreEditarPais").val(datos[0].NOMBRE);
  setTimeout(async function(){
    $("#modalEditarPais").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#guardarEditarPais").unbind('click').click(async function(){
  var table = $('#tablaMantenedorPaises').DataTable();
  var datos = table.rows('.selected').data();
  if($.trim($("#abreviaturaEditarPais").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#abreviaturaEditarPais").addClass("is-invalid");
  }
  else if($.trim($("#nombreEditarPais").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#nombreEditarPais").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEditarPais").modal("hide");
    parametros = {
      "abreviaturaPais": $("#abreviaturaEditarPais").val(),
      "nombrePais": $("#nombreEditarPais").val(),
      "idPais": datos[0].IDPAIS
    }

    await $.ajax({
      url: "controller/editarPais.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        if(response.localeCompare("Sin datos") != 0 && response != ""){
          $('#modalAlertasSplash').modal('hide');
          var table = $('#tablaMantenedorPaises').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>País editado correctamente");
          $("#editarPais").attr("disabled","disabled");
          }
        else{
          $('#modalAlertasSplash').modal('hide');
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar País");
        }
      }
    });
  }
});

$("#abreviaturaEditarPais").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombreEditarPais").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#asignarProyInternoObra").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoObras').DataTable();
  var folios = $.map(table.rows('.selected').data(), function (item) {
      return item.IDOBRA;
  });
  var oe = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBREOE;
  });
  var tipo = $.map(table.rows('.selected').data(), function (item) {
      return item.TIPO;
  });
  var proyecto = $.map(table.rows('.selected').data(), function (item) {
      return item.PROYECTO;
  });
  var proyInterno = $.map(table.rows('.selected').data(), function (item) {
      return item.PROYEC_INTER;
  });
  console.log(proyInterno);
  $("#oeAsignarProyInternoObra").html('OE: ' + oe);
  $("#proyectoOrdenEjecucionSimple").html('Proyecto: ' + proyecto);
  if(folios[0].includes('/')){
    var tipo1 = tipo[0].split('/')[0];
    var tipo2 = tipo[0].split('/')[1];
    cuerpoC = '';
    cuerpoC += `<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12"  style="margin-top: 20pt;">
      <label style="font-weight: bold; color: gray; font-size: 14pt;">Tipo:</label>
      <span style="font-weight: bold; color: gray; font-size: 14pt;" id="tipoOrdenEjecucionFull"></span>
    </div>
    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">
      <label style="font-weight: bold;">Empresa</label>
      <select id="nombreProyInternoObraFull" class="form-control"></select>
    </div>`;
  }else{
    $("#tipoOrdenEjecucionSimple").html(tipo);
    cuerpoC = '';
  }
  $("#datosOrdenFull").html(cuerpoC);
  $("#tipoOrdenEjecucionSimple").html(tipo1);
  $("#tipoOrdenEjecucionFull").html(tipo2);

  await $.ajax({
    url:   'controller/datosProyectoInternoObras.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '<option value="0">Seleccione una opción</option>';
        var cuerpoSIM = '<option value="0">Seleccione una opción</option>';
        for(var i = 0; i < p2.aaData.length; i++){
          if(folios[0].includes('/')){
            if(proyInterno[0].split('/')[0].trim() === p2.aaData[i].DATOS){
              cuerpoSIM += '<option selected value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].DATOS + '</option>';
            }else{
              cuerpoSIM += '<option value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].DATOS + '</option>';
            }
            if(proyInterno[0].split('/')[1].trim() === p2.aaData[i].DATOS){
              cuerpoEC += '<option selected value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].DATOS + '</option>';
            }else{
              cuerpoEC += '<option value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].DATOS + '</option>';
            }
          }else{
            if(proyInterno[0] === p2.aaData[i].DATOS){
              cuerpoSIM += '<option selected value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].DATOS + '</option>';
            }else{
              cuerpoSIM += '<option value="' + p2.aaData[i].IDESTRUCTURA_OPERACION + '">' + p2.aaData[i].DATOS + '</option>';
            }
          }
        }
        $("#nombreProyInternoObra").html(cuerpoSIM);
        $("#nombreProyInternoObraFull").html(cuerpoEC);
      }
      else{
        var cuerpoEC = '<option value="0">Sin datos</option>';
        $("#nombreProyInternoObra").html(cuerpoEC);
        $("#nombreProyInternoObraFull").html(cuerpoEC);
      }
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#nombreProyInternoObra").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#nombreProyInternoObraFull").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalAsignarProyInternoObra").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyAsignarProyInternoObra').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarAsignarProyInternoObra").unbind('click').click(function(){
  var table = $('#tablaListadoObras').DataTable();
  var folios = $.map(table.rows('.selected').data(), function (item) {
      return item.IDOBRA;
  });
  if($("#nombreProyInternoObra").val() == '0' || $("#nombreProyInternoObraFull").val() == '0'){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar los dos proyectos");
  }else{
    var datos = new Array();
    if(folios[0].includes('/')){
      var item = {};
      item.id = folios[0].split('/')[0];
      item.proy = $("#nombreProyInternoObra").val();
      datos.push(item);
      var item1 = {};
      item1.id = folios[0].split('/')[1];
      item1.proy = $("#nombreProyInternoObraFull").val();
      datos.push(item1);
    }else{
      var item = {};
      item.id = folios[0];
      item.proy = $("#nombreProyInternoObra").val(),
      datos.push(item);
    }

    var proyecto = JSON.stringify(datos);
    parametros = {
      "proyecto": proyecto,
    }
    $("#modalAsignarProyInternoObra").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/asignarProyectoInternoObra.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoObras').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Proyecto interno asignado correctamente");
            $("#detalleObraCaratula").attr("disabled", "disabled");
            $("#cubicacionObra").attr("disabled", "disabled");
            $("#usuariosRolesObra").attr("disabled", "disabled");
            $("#documentosObra").attr("disabled", "disabled");
            $("#asignarProyInternoObra").attr("disabled", "disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar proyecto interno");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar proyecto interno");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

// FUNCION PARA MODAL DUPLICAR OT
$("#duplicarOt").unbind('click').click(function(){
  $("#cantidadDuplicarOt").val("");
  var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  var oe = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBREOE;
  });
  var tipo = $.map(table.rows('.selected').data(), function (item) {
    return item.TIPO;
  });
  var proyectoInterno = $.map(table.rows('.selected').data(), function (item) {
    return item.ESTRUCTURA_OPERACION;
  });
  if(proyectoInterno.length <= 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede duplicar una orden de trabajo si no tiene un proyecto interno asignado");
  }else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');

    $("#detalleDuplicarOt").html('Con orden de ejecución: ' + oe + ' y de tipo ' + tipo);

    setTimeout(async function(){
      $("#modalDuplicarOt").modal('show');
      $('#modalAlertasSplash').modal('hide');
    },500);
  }
});

$("#guardarDuplicarOt").unbind('click').click(async function(){
  var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  var idObra = $.map(table.rows('.selected').data(), function (item) {
      return item.IDOBRA;
  });
  parametros = {
    "idObra": idObra[0],
    "estado": 'Pte. Asignar Brigada',
    "cantidad" : $("#cantidadDuplicarOt").val(),
  }
  var cant = $("#cantidadDuplicarOt").val();
  if(cant < 1 || cant % 1 !== 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar un numero entero y no menor a 1");
  }else{
    $("#modalDuplicarOt").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    await $.ajax({
      url:   'controller/duplicarOrdenTrabajo.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var table = $('#tablaListadoOrdenesTrabajo').DataTable();
              table.ajax.reload()
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Orden de trabajo duplicada correctamente");
              $("#asignarFechaTerreno").attr("disabled","disabled");
              $("#asignarSubcc").attr("disabled","disabled");
              $("#duplicarOt").attr("disabled","disabled");
              $("#eliminarOt").attr("disabled","disabled");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
          }
          else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al duplicar orden de trabajo");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
          }
        }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al duplicar orden de trabajo");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }
    });
  }
});
//  FIN FUNCION PARA MODAL DUPLICAR OT

function detalleCub(folio,idTablaCub){
  var dato = folio;
  $("#"+idTablaCub).remove();
  if(idTablaCub !== 'tablaCaratulaObrasCubicacion'){
    $("#divTablaDetalleCubicacion").append('<div id="'+  idTablaCub +'"></div>');
  }else{
    $("#cuerpoCaratulaObrasCubicacion").append('<div id="'+  idTablaCub +'" class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="margin-bottom: 15pt; padding-right: 0;"></div>');
  }

  $("#idTablaCubDetalleCubicacion").val(idTablaCub);
  if($("#changeSelectorTipo").val() !== "1"){
    var table = $('#tablaListadoObras').DataTable();
    var datos = table.rows('.selected').data();
    var ids = datos[0].IDOBRA;
    var tipos = datos[0].TIPO;
    var tipo789 = '';
    if(ids.includes("/")){
      var id1 = ids.split("/")[0].trim();
      var id2 = ids.split("/")[1].trim();
      var tipo1 = tipos.split("/")[0].trim();
      var tipo2 = tipos.split("/")[1].trim();
      tipo789 += '<option  value="' + ids + '">Todos</option>';
      tipo789 += '<option  value=' + id1 + '>' + tipo1 + '</option>';
      tipo789 += '<option  value=' + id2 + '>' + tipo2 + '</option>';
    }else{
      tipo789 += '<option  value=' + ids + '>Todos</option>';
    }
    $("#tipoFiltroObra").html(tipo789);

    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#tipoFiltroObra").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  }

  setTimeout(function(){
    var largo = Math.trunc($(window).height() - 250);
    if(idTablaCub !== 'tablaCaratulaObrasCubicacion'){
      largo = Math.trunc($(window).height() - 350);
    }
    setTimeout(function(){
      FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];

      new FancyGrid({
          renderTo: idTablaCub,
          scrollable: true,
          multiSort: true,
          doubleHorizontalScroll: true,
          selModel: {
            type: 'rows',
            checkOnly: true
          },
          theme: 'bootstrap',
          height: largo,
          subSearch: true,
          data: {
            proxy: {
              url: 'controller/datosDetalleCubObra.php',
              method: 'GET',
              params: {
                idobra: dato,
              }
            },
            fields: ['CORR', 'ESPECIALIDAD', 'CODMO', 'MANO_OBRA', 'CANMOCUB', 'PB_MO', 'VALOR_MO', 'TOTAL_MO', 'CODUO', 'UNIDAD_OBRA', 'CANUOCUB', 'VALOR_UO', 'TOTAL_UO', 'PROVEE', 'IDOBRA_CUBICACION', 'IDOBRA', 'TIPO', 'DIRECCION', 'EXPANDIR','ESTADO']
          },
          trackOver: true,
          defaults: {
            sortable: true,
            align: 'left',
            cellAlign: 'left',
            menu: true
          },
          cellHeight: 45,
          columns: [
            {
              type: 'select',
              locked: true
            },
            {
              type: 'tree',
              locked: true,
              index: 'EXPANDIR',
              width: 40,
            },
            {
              type: 'number',
              resizable: true,
              locked: true,
              title: 'Corr',
              index: 'CORR',
              width: 60,
            },
            {
              title: 'Estado',
              resizable: true,
              locked: true,
              index: 'ESTADO',
              width: 200,
            },
            {
              title: 'Especialidad',
              resizable: true,
              locked: true,
              index: 'ESPECIALIDAD',
            },
            {
              title: 'Tipo',
              resizable: true,
              locked: true,
              index: 'TIPO',
            },
            {
              title: 'Dirección',
              resizable: true,
              draggable: true,
              width: 400,
              index: 'DIRECCION',
              //hidden: true,
            },
            {
              title: 'Cod. MO.',
              resizable: true,
              draggable: true,

              index: 'CODMO',
            },
            {
              title: 'Mano de obra',
              resizable: true,
              draggable: true,
              width: 400,
              index: 'MANO_OBRA',
            },
            {
              title: '# MO.',
              resizable: true,
              draggable: true,

              index: 'CANMOCUB',
            },
            {
              title: '# PB Mo.',
              resizable: true,
              draggable: true,

              index: 'PB_MO',
            },
            {
              title: 'Valor Mo.',
              type: 'currency',
              resizable: true,
              draggable: true,
              currency: Fancy.currency.USD,
              index: 'VALOR_MO',
            },
            {
              title: 'Total Mo.',
              type: 'currency',
              resizable: true,
              draggable: true,
              currency: Fancy.currency.USD,
              index: 'TOTAL_MO',
            },
            {
              title: 'Cod. UO.',
              resizable: true,
              draggable: true,
              index: 'CODUO',
            },
            {
              title: 'Unidad de obra',
              resizable: true,
              draggable: true,
              width: 400,
              index: 'UNIDAD_OBRA',
            },
            {
              title: '# UO.',
              resizable: true,
              draggable: true,
              index: 'CANUOCUB',
            },
            {
              title: 'Valor Uo.',
              type: 'currency',
              resizable: true,
              draggable: true,
              currency: Fancy.currency.USD,
              index: 'VALOR_UO',
            },
            {
              title: 'Total Uo.',
              type: 'currency',
              resizable: true,
              draggable: true,
              currency: Fancy.currency.USD,
              index: 'TOTAL_UO',
            },
            {
              title: 'Provee',
              resizable: true,
              draggable: true,

              index: 'PROVEE',
            }
          ],
          exporter: true,
          tbar: [
            {
              type: 'search',
              width: 200,
              emptyText: 'Buscar'
            },
            {
              text: 'Excel',
              handler: function() {
                this.expandAll();
                this.exportToExcel();
                this.collapseAll();
              }
            },
            {
              text: 'Expandir Todo',
              handler: function() {
                this.expandAll();
              }
            },
            {
              text: 'Colapsar Todo',
              handler: function() {
                this.collapseAll();
              }
            },
            {
              text: 'Asociar',
              id: 'asignarDetalleCubicacion',
              handler: async function() {
                $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                $('#modalAlertasSplash').modal('show');

                var datosCub = this.getSelection();
                //console.log(datosCub[0].child[0].ESTADO);
                if(datosCub.length > 0){
                  var parametros = {
                    'idObra': datosCub[0].IDOBRA,
                  }
                  await $.ajax({
                    url:   'controller/datosOtsForAsig.php',
                    type:  'post',
                    data: parametros,
                    success: function (resp) {
                      var t = jQuery.parseJSON(resp);
                      if(t.aaData.length !== 0){
                        var cuerpoAF = '<option  value="0">Seleccione una opción</option>';
                        for(var i = 0; i < t.aaData.length; i++){
                          cuerpoAF += '<option value="' + t.aaData[i].IDS + '">' + t.aaData[i].DATOS + '</option>';
                        }
                        $("#otsAsignarOt").html(cuerpoAF);
                      }
                      else{
                        var cuerpoAF = '<option  value="0">Sin datos</option>';
                        $("#otsAsignarOt").html(cuerpoAF);
                      }
                    }
                  });

                  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                    $("#otsAsignarOt").select2({
                        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                    });
                  }

                  if(datosCub.length > 0){
                    var cub = '';
                    var idObraCub = new Array();
                    var corrCub = '';
                    var tipo = new Array();
                    var estado = new Array();
                    for(var i = 0; i < datosCub.length; i++){
                      if(datosCub[i].TIPO !== ""){
                        if(i == 0){
                          cub += datosCub[i].IDOBRA_CUBICACION.toString();
                          var item = {};
                          item.id= datosCub[i].IDOBRA_CUBICACION;
                          idObraCub.push(item);
                          corrCub += datosCub[i].CORR.toString();
                          tipo.push(datosCub[i].TIPO.toString());
                          for(var k = 0; k < datosCub[i].child.length; k++){
                            if(datosCub[i].child[k].ESTADO !== '' && typeof datosCub[i].child[k].ESTADO !== 'undefined'){
                              estado.push(datosCub[i].child[k].ESTADO);
                            }
                          }
                        }
                        else{
                          cub += ',' + datosCub[i].IDOBRA_CUBICACION.toString();
                          var item = {};
                          item.id = datosCub[i].IDOBRA_CUBICACION;
                          idObraCub.push(item);
                          corrCub += ',' + datosCub[i].CORR.toString();
                          tipo.push(datosCub[i].TIPO.toString());
                          for(var k = 0; k < datosCub[i].child.length; k++){
                            if(datosCub[i].child[k].ESTADO !== '' && typeof datosCub[i].child[k].ESTADO !== 'undefined'){
                              estado.push(datosCub[i].child[k].ESTADO);
                            }
                          }
                        }
                      }
                    }
                    var toPost1 = JSON.stringify(idObraCub);
                    var newTipo = [...new Set(tipo)]
                    //console.log(estado);
                    var newEstado = [...new Set(estado)]
                    //console.log(newEstado);
                    //console.log(newEstado[0].length);
                    $("#folioAsignatOts").val(folio);
                    $("#idObraCubicacionAsignarOts").val(toPost1);
                    $("#idTablaCubAsignatOts").val(idTablaCub);
                    $("#detalleAsignarOt").html('Correlativos: ' + corrCub);
                    $("#detalle2AsignarOt").html('Ids Cubicación: ' + cub);

                    if(newTipo.length > 1){
                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                        if(idTablaCub === 'tablaCaratulaObrasCubicacion'){
                          $("#modalCaratulaObras").modal('show');
                        }
                      },500);
                      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se puede asignar cubicaciones de diferente tipo");
                    }
                    else if(newEstado.length != 0){
                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                        if(idTablaCub === 'tablaCaratulaObrasCubicacion'){
                          $("#modalCaratulaObras").modal('show');
                        }
                      },500);
                      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se puede asignar cubicaciones con pedido en curso");
                    }else{
                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                        $("#modalAsignarOt").modal('show');
                        if(idTablaCub === 'tablaCaratulaObrasCubicacion'){
                          $("#modalCaratulaObras").modal('show');
                        }
                      },500);
                    }
                  }
                }
                else{
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                    if(idTablaCub === 'tablaCaratulaObrasCubicacion'){
                      $("#modalCaratulaObras").modal('show');
                    }
                  },500);
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
                }
              }
            },
            {
              text: 'Distribuir',
              id: 'distribuirDetalleCubicacion',
              handler: async function() {
                $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                $('#modalAlertasSplash').modal('show');

                var datosCub = this.getSelection();

                if(datosCub.length === 1){
                  var idObraCub = datosCub[0].IDOBRA_CUBICACION;

                  var idObraCub = '';
                  var corrCub = '';
                  var manoObra = '';
                  var unidadObra = '';
                  var estado = new Array();
                  for(var i = 0; i < datosCub.length; i++){
                    if(i == 0){
                      idObraCub += datosCub[i].IDOBRA_CUBICACION.toString();
                      corrCub += datosCub[i].CORR.toString();
                      manoObra += datosCub[i].MANO_OBRA.toString();
                      unidadObra += datosCub[i].UNIDAD_OBRA.toString();
                      for(var k = 0; k < datosCub[i].child.length; k++){
                        if(datosCub[i].child[k].ESTADO !== '' && typeof datosCub[i].child[k].ESTADO !== 'undefined'){
                          estado.push(datosCub[i].child[k].ESTADO);
                        }
                      }
                    }
                    else{
                      idObraCub += ',' + datosCub[i].IDOBRA_CUBICACION.toString();
                      corrCub += ',' + datosCub[i].CORR.toString();
                      manoObra += ',' + datosCub[i].MANO_OBRA.toString();
                      unidadObra += ',' + datosCub[i].UNIDAD_OBRA.toString();
                      for(var k = 0; k < datosCub[i].child.length; k++){
                        if(datosCub[i].child[k].ESTADO !== '' && typeof datosCub[i].child[k].ESTADO !== 'undefined'){
                          estado.push(datosCub[i].child[k].ESTADO);
                        }
                      }
                    }
                  }
                  //console.log(estado);
                  var newEstado = [...new Set(estado)]
                  $("#correlativoDistribuirOt").html("Correlativo: " + corrCub);
                  $("#idCubicacionDistribuirOt").html("Id. Cubicación: " + idObraCub);
                  $("#mObraDistribuirOt").html("Mano Obra: " + manoObra);
                  $("#uObraDistribuirOt").html("Unidad Obra: " + unidadObra);
                  $("#idObraDistribuirOt").val(folio);
                  $("#idTablaCubDistribuirOt").val(idTablaCub);

                  await $.ajax({
                    url:   'controller/datosPreDistribucionCubicacion.php',
                    type:  'post',
                    data: {
                      "idobra": datosCub[0].IDOBRA,
                      "idcubicacion": idObraCub
                    },
                    success: function (response2) {
                      var p = jQuery.parseJSON(response2);
                      if(p.aaData.length !== 0){
                        cuerpo = '<div class="col-xl-8 col-lg-8 col-md-8 col-sm-8 col-xs-8"></div><div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2 celdaColor" style="border: 1px solid black; text-align: center;"># MO</div><div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2 celdaColor" style="border: 1px solid black; text-align: center;"># UO</div>';
                        cuerpo += '<div class="col-xl-8 col-lg-8 col-md-8 col-sm-8 col-xs-8 celdaColor" style="border: 1px solid black;">OT</div><div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="border: 1px solid black; text-align: center;" id="moTotal"></div><div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="border: 1px solid black; text-align: center;" id="uoTotal"></div>';
                        var mo = 0;
                        var uo = 0;
                        for(var j = 0; j < p.aaData.length; j++){
                          mo = mo + parseInt(p.aaData[j].CANMOCUB);
                          uo = uo + parseInt(p.aaData[j].CANUOCUB);
                          cuerpo += '<div class="col-xl-8 col-lg-8 col-md-8 col-sm-8 col-xs-8" style="border: 1px solid black; padding-top: 5px;">OT: ' + p.aaData[j].IDOBRA_OT + '</div><div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="border: 1px solid black; text-align: center; padding: 0;"><input style="text-align: center;" type="text" step="1" class="form-control input-number" min="0" value="' + p.aaData[j].CANMOCUB + '" id="moInput'+ p.aaData[j].IDOBRA_OT.split(" - ")[0] + '"></div><div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="border: 1px solid black; text-align: center;  padding: 0;"><input style="text-align: center;" type="text" step="1" class="form-control input-number" min="0" value="' + p.aaData[j].CANUOCUB + '" id="uoInput'+ p.aaData[j].IDOBRA_OT.split(" - ")[0] + '"></div>';
                        }
                        $("#rowDistribuirOt").html(cuerpo);
                        $("#moTotal").html(mo);
                        $("#uoTotal").html(uo);

                        //FN distribuir
                        $("input[id*='moInput']").unbind("click").focusout(function(){
                          var moTotal =  parseInt($('div[id="moTotal"]').text());
                          var uoTotal = parseInt($('div[id="uoTotal"]').text());
                          var resto = uoTotal % moTotal;
                          if(resto === 0){
                            var idMO = $(this).attr("id").split("Input")[1];
                            var idUO = "uoInput" + idMO;
                            var factorCalculo = $(this).val()/moTotal;
                            var valorIngreso = Math.round(uoTotal*factorCalculo);

                            $("#" + idUO).val(valorIngreso);
                          }
                        });
                      }
                      else{
                        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Error al obtener los datos de pre-distribución");
                      }
                    }
                  });
                  if(newEstado.length != 0){
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                      if(idTablaCub === 'tablaCaratulaObrasCubicacion'){
                        $("#modalCaratulaObras").modal('show');
                      }
                    },500);
                    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se puede asignar cubicaciones con pedido en curso");
                  }else{
                    setTimeout(async function(){
                      // var h = $(window).height() - 300;
                      // $("#bodyDistribuirOt").css("height",h);
                      $("#modalDistribuirOt").modal('show');
                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                        if(idTablaCub === 'tablaCaratulaObrasCubicacion'){
                          $("#modalCaratulaObras").modal('show');
                        }
                      },500);
                    },500);
                  }
                }
                else if(datosCub.length > 1){
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                    if(idTablaCub === 'tablaCaratulaObrasCubicacion'){
                      $("#modalCaratulaObras").modal('show');
                    }
                  },500);
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Seleccione solo una fila de cubicación y colapse la cubicación a distribuir");
                }
                else{
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                    if(idTablaCub === 'tablaCaratulaObrasCubicacion'){
                      $("#modalCaratulaObras").modal('show');
                    }
                  },500);
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
                }
              }
            }
          ],
          events: [
            {
              update: function(grid){
                var h = $(window).height() - 300;
                $("#bodyDetalleCubicacion").css("height",h);

                var h = $(window).height() - 200;
                $("#bodyCaratulaObras").css("height",h);

                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  if(idTablaCub !== 'tablaCaratulaObrasCubicacion'){
                    $("#modalDetalleCubicacion").modal("show");
                    largo = Math.trunc($(window).height() - 350);
                  }
                  else{
                    $('#modalCaratulaObras').modal('show');
                    $("#modalAlertasSplash").modal("hide");
                    setTimeout(function(){
                      $('#tablaCaratulaObras').DataTable().columns.adjust();
                    },500);
                  }
                },500);
              }
            }
          ],
      })
    },500);
  },500);
}

$("#guardarAsignarOt").unbind('click').click(function(){
  var folio = $("#folioAsignatOts").val();
  var datos = $("#idObraCubicacionAsignarOts").val();
  var idTablaCubAsigOts = $("#idTablaCubAsignatOts").val();
  if($("#otsAsignarOt").val() == '0'){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una opción");
  }
  else {
    parametros = {
      "datos": datos,
      "otAsignar": $("#otsAsignarOt").val(),
    }
    //console.log(parametros);
    //console.log(folio);
    $("#modalAsignarOt").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/asignarOrdenTrabajo.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            detalleCub(folio,idTablaCubAsigOts);
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Orden de trabajo asiganado correctamente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              setTimeout(function(){
                $(".os-viewport.os-viewport-native-scrollbars-invisible").scrollTop(10000,0);
              },500);
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar orden de trabajo");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar orden de trabajo");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#agregarAreaFuncional").unbind('click').click(async function(){
  $("#modalAgregarAreaFuncional").find("input,textarea,select").val("");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/datosListadoPaises.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoEC += '<option value="' + p2.aaData[i].IDPAIS + '">' + p2.aaData[i].NOMBRE + '</option>';
        }
        $("#paisAgregarAreaFuncional").html(cuerpoEC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#paisAgregarAreaFuncional").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(async function(){
    $("#modalAgregarAreaFuncional").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#guardarAgregarAreaFuncional").unbind('click').click(async function(){
  if($.trim($("#comunaAgregarAreaFuncional").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#comunaAgregarAreaFuncional").addClass("is-invalid");
  }
  else if($.trim($("#provinciaAgregarAreaFuncional").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#provinciaAgregarAreaFuncional").addClass("is-invalid");
  }
  else if($.trim($("#regionAgregarAreaFuncional").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#regionAgregarAreaFuncional").addClass("is-invalid");
  }
  else if($.trim($("#codigoAgregarPostalAreaFuncional").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#codigoAgregarPostalAreaFuncional").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalAgregarAreaFuncional").modal("hide");
    parametros = {
      "comuna": $("#comunaAgregarAreaFuncional").val(),
      "provincia": $("#provinciaAgregarAreaFuncional").val(),
      "region": $("#regionAgregarAreaFuncional").val(),
      "codigoPostal": $("#codigoAgregarPostalAreaFuncional").val(),
      "idPais": $("#paisAgregarAreaFuncional").val()
    }

    await $.ajax({
      url: "controller/ingresaAreaFuncional.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        if(response.localeCompare("Sin datos") != 0 && response != ""){
          $('#modalAlertasSplash').modal('hide');
          var table = $('#tablaAreaFuncional').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Área Funcional agregada correctamente");
          //$("#editarArea").attr("disabled","disabled");
          }
        else{
          $('#modalAlertasSplash').modal('hide');
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al agregar Área Funcional");
        }
      }
    });
  }
});

$("#comunaAgregarAreaFuncional").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#provinciaAgregarAreaFuncional").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#regionAgregarAreaFuncional").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#codigoAgregarPostalAreaFuncional").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#editarAreaFuncional").unbind('click').click(async function(){
  var table = $('#tablaAreaFuncional').DataTable();
  var datos = table.rows('.selected').data();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#comunaEditarAreaFuncional").val(datos[0].COMUNA);
  $("#provinciaEditarAreaFuncional").val(datos[0].PROVINCIA);
  $("#regionEditarAreaFuncional").val(datos[0].REGION);
  $("#codigoEditarPostalAreaFuncional").val(datos[0].CODIGOPOSTAL);

  await $.ajax({
    url:   'controller/datosListadoPaises.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEC = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(datos[0].PAIS === p2.aaData[i].NOMBRE){
            cuerpoEC += '<option selected value="' + p2.aaData[i].IDPAIS + '">' + p2.aaData[i].NOMBRE + '</option>';
          }
          else{
            cuerpoEC += '<option value="' + p2.aaData[i].IDPAIS + '">' + p2.aaData[i].NOMBRE + '</option>';
          }
        }
        $("#paisEditarAreaFuncional").html(cuerpoEC);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#paisEditarAreaFuncional").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }
  setTimeout(async function(){
    $("#modalEditarAreaFuncional").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#guardarEditarAreaFuncional").unbind('click').click(async function(){
  var table = $('#tablaAreaFuncional').DataTable();
  var datos = table.rows('.selected').data();
  if($.trim($("#comunaEditarAreaFuncional").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#comunaEditarAreaFuncional").addClass("is-invalid");
  }
  else if($.trim($("#provinciaEditarAreaFuncional").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#provinciaEditarAreaFuncional").addClass("is-invalid");
  }
  else if($.trim($("#regionEditarAreaFuncional").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#regionEditarAreaFuncional").addClass("is-invalid");
  }
  else if($.trim($("#codigoEditarPostalAreaFuncional").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#codigoEditarPostalAreaFuncional").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEditarAreaFuncional").modal("hide");
    parametros = {
      "comuna": $("#comunaEditarAreaFuncional").val(),
      "provincia": $("#provinciaEditarAreaFuncional").val(),
      "region": $("#regionEditarAreaFuncional").val(),
      "codigoPostal": $("#codigoEditarPostalAreaFuncional").val(),
      "idPais": $("#paisEditarAreaFuncional").val(),
      "idAreaFuncional": datos[0].IDAREAFUNCIONAL
    }

    await $.ajax({
      url: "controller/editarAreaFuncional.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        if(response.localeCompare("Sin datos") != 0 && response != ""){
          $('#modalAlertasSplash').modal('hide');
          var table = $('#tablaAreaFuncional').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Área Funcional editada correctamente");
          $("#editarAreaFuncional").attr("disabled","disabled");
          }
        else{
          $('#modalAlertasSplash').modal('hide');
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Área Funcional");
        }
      }
    });
  }
});

$("#comunaEditarAreaFuncional").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#provinciaEditarAreaFuncional").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#regionEditarAreaFuncional").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#codigoEditarPostalAreaFuncional").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#editarRangoDiasObra").unbind('click').click(function(){
  var table = $('#tablaMantenedorDiasObra').DataTable();
  var datos = table.rows('.selected').data();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#nroDiasEditarDiasObras").val(datos[0].RANGO);
  setTimeout(async function(){
    $("#modalEditarDiasObras").modal('show');
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#guardarEditarPais").unbind('click').click(async function(){
  var table = $('#tablaMantenedorPaises').DataTable();
  var datos = table.rows('.selected').data();
  if($.trim($("#abreviaturaEditarPais").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#abreviaturaEditarPais").addClass("is-invalid");
  }
  else if($.trim($("#nombreEditarPais").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#nombreEditarPais").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEditarPais").modal("hide");
    parametros = {
      "abreviaturaPais": $("#abreviaturaEditarPais").val(),
      "nombrePais": $("#nombreEditarPais").val(),
      "idPais": datos[0].IDPAIS
    }

    await $.ajax({
      url: "controller/editarPais.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        if(response.localeCompare("Sin datos") != 0 && response != ""){
          $('#modalAlertasSplash').modal('hide');
          var table = $('#tablaMantenedorPaises').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>País editado correctamente");
          $("#editarPais").attr("disabled","disabled");
          }
        else{
          $('#modalAlertasSplash').modal('hide');
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar País");
        }
      }
    });
  }
});

$("#guardarEditarDiasObras").unbind('click').click(async function(){
  var table = $('#tablaMantenedorDiasObra').DataTable();
  var datos = table.rows('.selected').data();
  if($.trim($("#nroDiasEditarDiasObras").val()) === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos en rojo");
    $("#nroDiasEditarDiasObras").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEditarDiasObras").modal("hide");
    parametros = {
      "nroDias": $("#nroDiasEditarDiasObras").val(),
      "idRango": datos[0].IDOBRA_RANGO_DIAS
    }

    await $.ajax({
      url: "controller/editarDiasObras.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        if(response.localeCompare("Sin datos") != 0 && response != ""){
          $('#modalAlertasSplash').modal('hide');
          var table = $('#tablaMantenedorDiasObra').DataTable();
          table.ajax.reload();
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Rango editado correctamente");
          $("#editarPais").attr("disabled","disabled");
          }
        else{
          $('#modalAlertasSplash').modal('hide');
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al editar Rango");
        }
      }
    });
  }
});

$("#nroDiasEditarDiasObras").on('input', function(){
  $(this).removeClass("is-invalid");
});

// FUNCION PARA MODAL VALIDAR DOCUMENTOS OBRA
$("#validarPDfIngresarDocumentosObra").unbind('click').click(function(){
  var table = $('#tablaIngresarDocumentosObra').DataTable();
  var nombre = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBRE;
  });
  var validado = $.map(table.rows('.selected').data(), function (item) {
    return item.VAL;
  });
  if(validado[0] === "--"){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');

    $("#nombreValidarDocumentosObra").html(nombre);
    setTimeout(async function(){
      $("#modalValidarDocumentosObra").modal('show');
      $('#modalAlertasSplash').modal('hide');
    },500);
  }else{
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El docuemento ya se encuentra validado");
  }

});

$("#guardarValidarDocumentosObra").unbind('click').click(async function(){
  var table = $('#tablaIngresarDocumentosObra').DataTable();
  var id = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  parametros = {
    "id": id[0],
  }
  $("#modalValidarDocumentosObra").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/validarDocumentoObra.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaIngresarDocumentosObra').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Documento validado correctamente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al validar documento");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al validar documento");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});
//  FIN FUNCION PARA MODAL VALIDAR DOCUMENTOS OBRA

$("#guardarDistribuirOt").unbind('click').click(function(){
  var datos = $('div.emphasis').find('input');
  var mo = 0;
  var uo = 0;
  var idTablaCub =  $("#idTablaCubDistribuirOt").val();
  var folio =  $("#idObraDistribuirOt").val();
  for(var i=0;i<datos.length;i++){
    if(datos[i].id.includes("mo")){
      mo = Number.parseInt($(datos[i]).val()) + mo
    }
    if(datos[i].id.includes("uo")){
      uo = Number.parseInt($(datos[i]).val()) + uo
    }
  }
  var moTotal =  $('div[id="moTotal"]').text();
  var uoTotal = $('div[id="uoTotal"]').text();
  if(mo != moTotal){
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>La MO distribuida no coincide con el total");
  }
  else if(uo != uoTotal){
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>La UO distribuida no coincide con el total");
  }else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $('#modalDistribuirOt').modal('hide');
    var idz = new Array();
    var datos12 = $('div.emphasis').find('input');
    for(var i=0;i<datos12.length;i=i+2){
      var item = {};
      if(datos12[i].id.includes("mo")){
        item.idOt = datos12[i].id.split(" ")[0].replace("moInput","");
        item.mo = $(datos12[i]).val();
        item.uo = $(datos12[i+1]).val();
      }
      if(datos12[i].id.includes("uo")){
        item.idOt = datos12[i].id.split(" ")[0].replace("uoInput","");
        item.mo = $(datos12[i]).val();
        item.uo = $(datos12[i+1]).val();
      }
      idz.push(item);
    }
    var idCub = ($('span[id="idCubicacionDistribuirOt"]').text()).split(":")[1].trim();
    var idzOk = JSON.stringify(idz);
    parametros = {
      "idzOk" : idzOk,
      "idCub": idCub,
    }
    $.ajax({
      url: "controller/distribuirCubicacionObra.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Cubicacion distribuida correctamente");
            detalleCub(folio,idTablaCub);
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
              setTimeout(function(){
                $(".os-viewport.os-viewport-native-scrollbars-invisible").scrollTop(10000,0);
              },500);
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al distribuir cubicacion, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al distribuir cubicacion, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });

  }
});

$('#btnFormularioAuditoriaAdd').unbind('click').click(function(){
  $('#modalAddFormularioAuditoria').modal('show');
});

$('#guardarFormularioAuditoriaAdd').unbind('click').click(async function(){
  $("#modalAddFormularioAuditoria").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/ingresaFormularioAuditoria.php',
    type:  'post',
    data:  {
      "titulo": $('#auditoriaTitulo').val()
    },
    success: function (response) {
      $('#auditoriaTitulo').val('');
      alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Auditoría agregada correctamente");
      cargarMantenedorPracticas();
    }
  });
});

$('#btnFormularioAuditoriaDel').unbind('click').click(function(){
  $('#modalDelFormularioAuditoria').modal('show');
});


$('#guardarFormularioAuditoriaDel').unbind('click').click(async function(){
  $("#modalDelFormularioAuditoria").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarFormularioAuditoria.php',
    type:  'post',
    data:  {
      "idAuditoria": $("#auditoriaMantenedorPracticas").val()
    },
    success: function (response) {
      alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Auditoría eliminada correctamente");
      cargarMantenedorPracticas();
    }
  });
});

$("#tipoFiltroObra").unbind("click").change(function(e){
  $("#changeSelectorTipo").val("1");
  e.preventDefault();
  e.stopImmediatePropagation();
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoFiltroObra").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  };
  var folio = $("#tipoFiltroObra").val();
  var idTablaCubDetalleCubicacion = $("#idTablaCubDetalleCubicacion").val();
  setTimeout(function(){
    detalleCub(folio,idTablaCubDetalleCubicacion);
  },500);
});

$("#auditoriaMantenedorPracticas").unbind("click").change(function(e){
  e.stopImmediatePropagation();
  e.preventDefault();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  fancygridPracticas($("#auditoriaMantenedorPracticas").val());

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#auditoriaMantenedorPracticas").select2('destroy').select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  };
});

$("#asignarFechaTerreno").unbind("click").click(async function(){
  $("#fechaInicioAsignarFechaTerrenoOt").removeClass("is-invalid");
  $("#fechaFinAsignarFechaTerrenoOt").removeClass("is-invalid");
  $("#fechaInicioAsignarFechaTerrenoOt").val("");
  $("#fechaFinAsignarFechaTerrenoOt").val("");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  // var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  // var fechaIniTerreno = $.map(table.rows('.selected').data(), function (item) {
  //   return item.FECHA_INI_TERRENO;
  // });
  $("#fechaInicioAsignarFechaTerrenoOt").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#fechaFinAsignarFechaTerrenoOt").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalAsignarFechaTerrenoOt").modal("show");
    setTimeout(function(){
      $('#bodyAsignarFechaTerrenoOt').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarAsignarFechaTerrenoOt").unbind('click').click(function(){
  var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  var id = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  var fechaIni = $("#fechaInicioAsignarFechaTerrenoOt").val();
  var fechaFin = $("#fechaFinAsignarFechaTerrenoOt").val();
  if(fechaIni.length > 0 && fechaFin.length > 0){
    parametros = {
      "idOt": id[0],
      "fechaIni": fechaIni,
      "fechaFin": fechaFin,
    }
    $("#modalAsignarFechaTerrenoOt").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/asignarFechasTerrenoOts.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoOrdenesTrabajo').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Fechas ingresada correctamente");
            $("#asignarFechaTerreno").attr("disabled","disabled");
            $("#asignarSubcc").attr("disabled","disabled");
            $("#duplicarOt").attr("disabled","disabled");
            $("#eliminarOt").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar fechas, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar fechas, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }else{
    if ($("#fechaInicioAsignarFechaTerrenoOt").val().length == 0){
      $("#fechaInicioAsignarFechaTerrenoOt").addClass("is-invalid");
    }
    if ($("#fechaFinAsignarFechaTerrenoOt").val().length == 0){
      $("#fechaFinAsignarFechaTerrenoOt").addClass("is-invalid");
    }
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Debe ingresar ambas fechas");

  }
});

$("#fechaInicioAsignarFechaTerrenoOt").on('change', function(){
  $(this).removeClass("is-invalid");
});

$("#fechaFinAsignarFechaTerrenoOt").on('change', function(){
  $(this).removeClass("is-invalid");
});

$("#eliminarOt").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  var id = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });

  $("#datosEliminarOt").html("Folio: " + id);
  setTimeout(function(){
    $("#modalEliminarOt").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyEliminarOt').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarEliminarOt").unbind('click').click(async function(){
  var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  var id = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  parametros = {
    "id": id[0],
  }
  $("#modalEliminarOt").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarOt.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaListadoOrdenesTrabajo').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Orden de trabajo eliminado correctamente");
            $("#asignarFechaTerreno").attr("disabled","disabled");
            $("#asignarSubcc").attr("disabled","disabled");
            $("#duplicarOt").attr("disabled","disabled");
            $("#eliminarOt").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No se puede elminar la orden de trabajo por que tiene una MO o UO asignada");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No se puede elminar la orden de trabajo por que tiene una MO o UO asignada");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});

$("#asignarFecTerOtCaratulaObras").unbind("click").click(async function(){
  $("#fechaInicioAsignarFechaTerrenoOtDesdeOe").removeClass("is-invalid");
  $("#fechaFinAsignarFechaTerrenoOtDesdeOe").removeClass("is-invalid");
  $("#fechaInicioAsignarFechaTerrenoOtDesdeOe").val("");
  $("#fechaFinAsignarFechaTerrenoOtDesdeOe").val("");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  // var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  // var fechaIniTerreno = $.map(table.rows('.selected').data(), function (item) {
  //   return item.FECHA_INI_TERRENO;
  // });
  $("#fechaInicioAsignarFechaTerrenoOtDesdeOe").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#fechaFinAsignarFechaTerrenoOtDesdeOe").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalAsignarFechaTerrenoOtDesdeOe").modal("show");
    setTimeout(function(){
      $('#bodyAsignarFechaTerrenoOtDesdeOe').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarAsignarFechaTerrenoOtDesdeOe").unbind('click').click(function(){
  var table = $('#tablaCaratulaObras').DataTable();
  var id = $.map(table.rows('.selected').data(), function (item) {
    return item.OT;
  });
  var fechaIni = $("#fechaInicioAsignarFechaTerrenoOtDesdeOe").val();
  var fechaFin = $("#fechaFinAsignarFechaTerrenoOtDesdeOe").val();
  if(fechaIni.length > 0 && fechaFin.length > 0){
    parametros = {
      "idOt": id[0],
      "fechaIni": fechaIni,
      "fechaFin": fechaFin,
    }
    $("#modalAsignarFechaTerrenoOtDesdeOe").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/asignarFechasTerrenoOts.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaCaratulaObras').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Fechas ingresada correctamente");
            $("#asignarFecTerOtCaratulaObras").attr("disabled","disabled");
            $("#asignarBrigadaOtCaratulaObras").attr("disabled","disabled");
            $("#duplicarOtCaratulaObras").attr("disabled","disabled");
            $("#elimnarOtCaratulaObras").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar fechas, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar fechas, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }else{
    if ($("#fechaInicioAsignarFechaTerrenoOtDesdeOe").val().length == 0){
      $("#fechaInicioAsignarFechaTerrenoOtDesdeOe").addClass("is-invalid");
    }
    if ($("#fechaFinAsignarFechaTerrenoOtDesdeOe").val().length == 0){
      $("#fechaFinAsignarFechaTerrenoOtDesdeOe").addClass("is-invalid");
    }
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Debe ingresar ambas fechas");

  }
});

$("#fechaInicioAsignarFechaTerrenoOtDesdeOe").on('change', function(){
  $(this).removeClass("is-invalid");
});

$("#fechaFinAsignarFechaTerrenoOtDesdeOe").on('change', function(){
  $(this).removeClass("is-invalid");
});

$("#asignarBrigadaOtCaratulaObras").unbind("click").click(async function(){
  var table = $('#tablaCaratulaObras').DataTable();
  var estructura = $.map(table.rows('.selected').data(), function (item) {
      return item.ESTRUCTURA_OPERACION;
  });
  var comuna = $.map(table.rows('.selected').data(), function (item) {
    return item.COMUNA;
  });
  var fechaIniTerreno = $.map(table.rows('.selected').data(), function (item) {
    return item.FECHA_INI_TERRENO;
  });
  var fechaFinTerreno = $.map(table.rows('.selected').data(), function (item) {
    return item.FECHA_FIN_TERRENO;
  });
  console.log(estructura);
  console.log(comuna);

  if(estructura.length <= 0 || fechaIniTerreno.length <= 0 || fechaFinTerreno.length <= 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede asignar brigada si no tiene un proyecto interno o fechas de inicio y fin en terreno asignados");
  }else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var parametros = {
      'estructura': estructura[0],
      'comuna': comuna[0],
    }
    await $.ajax({
      url:   'controller/datosListadoBrigadaOt.php',
      type:  'post',
      data: parametros,
      success: function (resp) {
        var t = jQuery.parseJSON(resp);
        if(t.aaData.length !== 0){
          var cuerpoAF = '<option  value="0">Seleccione una opción</option>';
          for(var i = 0; i < t.aaData.length; i++){
            cuerpoAF += '<option value="' + t.aaData[i].IDS + '">' + t.aaData[i].DATOS + '</option>';
          }
          $("#brigadaAsignarSubccObraDesdeOe").html(cuerpoAF);
        }
        else{
          var cuerpoAF = '<option  value="0">Sin datos</option>';
          $("#brigadaAsignarSubccObraDesdeOe").html(cuerpoAF);
        }
      }
    });

    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#brigadaAsignarSubccObraDesdeOe").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }

    setTimeout(function(){
      $("#modalAsignarSubccObraDesdeOe").modal("show");
      $('#modalAlertasSplash').modal('hide');
      setTimeout(function(){
        $('#bodyAsignarSubccObraDesdeOe').animate({ scrollTop: 0 }, 'fast');
      },200);
    },500);
  }
});

$("#guardarAsignarSubccObraDesdeOe").unbind('click').click(function(){
  var table = $('#tablaCaratulaObras').DataTable();
  var folio = $.map(table.rows('.selected').data(), function (item) {
      return item.OT;
  });
  if($("#brigadaAsignarSubccObraDesdeOe").val() == '0'){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una opción");
  }else{
    parametros = {
      "folio": folio[0],
      "empresaSubcc":  $("#brigadaAsignarSubccObraDesdeOe").val().split('%%%')[1],
      "gestorSubcc":  $("#brigadaAsignarSubccObraDesdeOe").val().split('%%%')[0],
      "estado" : 'Pte. Materiales',
    }
    $("#modalAsignarSubccObraDesdeOe").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/asignarEmpresaGestorOt.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaCaratulaObras').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Empresa y gestor subcc. asignado correctamente");
            $("#asignarFecTerOtCaratulaObras").attr("disabled","disabled");
            $("#asignarBrigadaOtCaratulaObras").attr("disabled","disabled");
            $("#duplicarOtCaratulaObras").attr("disabled","disabled");
            $("#elimnarOtCaratulaObras").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar empresa y gestor subcc.");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar empresa y gestor subcc.");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#duplicarOtCaratulaObras").unbind('click').click(function(){
  $("#cantidadDuplicarOtDesdeOe").val("");
  var table = $('#tablaCaratulaObras').DataTable();
  var oe = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBREOE;
  });
  var tipo = $.map(table.rows('.selected').data(), function (item) {
    return item.TIPO;
  });
  var proyectoInterno = $.map(table.rows('.selected').data(), function (item) {
    return item.ESTRUCTURA_OPERACION;
  });
  if(proyectoInterno.length <= 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No puede duplicar una orden de trabajo si no tiene un proyecto interno asignado");
  }else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');

    $("#detalleDuplicarOtDesdeOe").html('Con orden de ejecución: ' + oe + ' y de tipo ' + tipo);

    setTimeout(async function(){
      $("#modalDuplicarOtDesdeOe").modal('show');
      $('#modalAlertasSplash').modal('hide');
    },500);
  }
});

$("#guardarDuplicarOtDesdeOe").unbind('click').click(async function(){
  var table = $('#tablaCaratulaObras').DataTable();
  var idObra = $.map(table.rows('.selected').data(), function (item) {
      return item.IDOBRA;
  });
  parametros = {
    "idObra": idObra[0],
    "estado": 'Pte. Asignar Brigada',
    "cantidad" : $("#cantidadDuplicarOtDesdeOe").val(),
  }
  var cant = $("#cantidadDuplicarOtDesdeOe").val();
  if(cant < 1 || cant % 1 !== 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar un numero entero y no menor a 1");
  }else{
    $("#modalDuplicarOtDesdeOe").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    await $.ajax({
      url:   'controller/duplicarOrdenTrabajo.php',
      type:  'post',
      data:  parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              var table = $('#tablaCaratulaObras').DataTable();
              table.ajax.reload()
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Orden de trabajo duplicada correctamente");
              $("#asignarFecTerOtCaratulaObras").attr("disabled","disabled");
              $("#asignarBrigadaOtCaratulaObras").attr("disabled","disabled");
              $("#duplicarOtCaratulaObras").attr("disabled","disabled");
              $("#elimnarOtCaratulaObras").attr("disabled","disabled");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
          }
          else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al duplicar orden de trabajo");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
          }
        }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al duplicar orden de trabajo");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }
    });
  }
});

$("#elimnarOtCaratulaObras").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaCaratulaObras').DataTable();
  var id = $.map(table.rows('.selected').data(), function (item) {
    return item.OT;
  });

  $("#datosEliminarOtDesdeOe").html("Folio: " + id);
  setTimeout(function(){
    $("#modalEliminarOtDesdeOe").modal("show");
    $('#modalAlertasSplash').modal('hide');
    setTimeout(function(){
      $('#bodyEliminarOtDesdeOe').animate({ scrollTop: 0 }, 'fast');
    },200);
  },500);
});

$("#guardarEliminarOtDesdeOe").unbind('click').click(async function(){
  var table = $('#tablaCaratulaObras').DataTable();
  var id = $.map(table.rows('.selected').data(), function (item) {
    return item.OT;
  });
  parametros = {
    "id": id[0],
  }
  $("#modalEliminarOtDesdeOe").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url:   'controller/eliminarOt.php',
    type:  'post',
    data:  parametros,
    success:  function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaCaratulaObras').DataTable();
            table.ajax.reload()
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Orden de trabajo eliminado correctamente");
            $("#asignarFecTerOtCaratulaObras").attr("disabled","disabled");
            $("#asignarBrigadaOtCaratulaObras").attr("disabled","disabled");
            $("#duplicarOtCaratulaObras").attr("disabled","disabled");
            $("#elimnarOtCaratulaObras").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
        else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No se puede elminar la orden de trabajo por que tiene una MO o UO asignada");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
      }else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No se puede elminar la orden de trabajo por que tiene una MO o UO asignada");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
      }
    }
  });
});

$("#detalleOrdenTrabajo").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  var folioOt = $.map(table.rows('.selected').data(), function (item) {
    return item.FOLIO;
  });
  detalle_Ot(folioOt[0]);
});

async function detalle_Ot(folioOt){
  $("#tituloDetalleOrdenTrabajo").empty();
  $("#cuerpoDetalleOrdenTrabajo").empty();
  $("#tablaDetalleOrdenTrabajoCubicacion").empty();
  $("#tituloDetalleOrdenTrabajo").append('<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12"><h5 style="color:gray;"><span class="fas fa-clipboard-list"></span>&nbsp;&nbsp;<span style="font-weight: bold;">Orden de trabajo</span><br></h5></div>');
  $("#cuerpoDetalleOrdenTrabajo").append('<div id="cuerpoDetalleOrdenTrabajoRowOrden" class="row"></div>');
  $("#cuerpoDetalleOrdenTrabajoRowOrden").append('<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" style="margin-bottom: 10pt; margin-top: 10pt;"><span style="font-weight: bold; color:gray; font-size: 1.2em;">Datos de la orden</span></div>');
  $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Folio:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + folioOt + "' readonly style='background-color: #f1f1f1 !important;'></div>");
  var parametros = {
    "folioOt":folioOt,
  }
  await $.ajax({
      url:   'controller/datosDetalleOrdenTrabajo.php',
      type:  'post',
      data: parametros,
      success: async function (response3) {
        if(response3.localeCompare("Sin datos") != 0 && response3 != ""){
          var p3 = jQuery.parseJSON(response3);
          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Orden de ej.:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].ORDEN_EJEC + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Cubicación:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].CODIGO_CUB + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Tipo:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].TIPO + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Cliente:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].CLIENTE + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Comuna:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].COMUNA + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Central:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].CENTRAL + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Estado:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].ESTADO + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>% Avance:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].AVANCE + "' readonly style='background-color: #f1f1f1 !important;'></div>");
          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Fecha importación:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].FECHA_IMPORTACION + "' readonly style='background-color: #f1f1f1 !important;'></div>");


          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>F. ini. ejec.:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].FECHA_INI_EJEC + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>F. fin ejec.:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].FECHA_FIN_EJEC + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Días faltantes:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><span class='form-control' readonly style='background-color: #f1f1f1 !important;'>" + p3.aaData[0].DIAS_FALTANTES + "</span></div>");

          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Gestor mandante:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].GESTOR + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Jefe proyecto:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].JEFE_PROYECTO + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Supervisor:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><span class='form-control' readonly style='background-color: #f1f1f1 !important;'>" + p3.aaData[0].SUPERVISOR + "</span></div>");

          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Subcontratista:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].EMPRESA_EECC + "' readonly style='background-color: #f1f1f1 !important;'></div>");

          $("#cuerpoDetalleOrdenTrabajoRowOrden").append("<div style='padding-bottom: 0;' class='col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12'><label class='input-group-text' style='font-weight: bold; background-color: #b6b6b6;'>Jefe brigada:</label></div><div style='padding-bottom: 0;' class='col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12'><input class='form-control' value='" + p3.aaData[0].JEFE_BRIGADA + "' readonly style='background-color: #f1f1f1 !important;'></div>");
        }
        await cubDetalleOrdenTrabajo(folioOt);
        var h = $(window).height() - 350;
        $("#bodyDetalleOrdenTrabajo").css("height",h);
        setTimeout(function(){
          $('#modalDetalleOrdenTrabajo').modal('show');
          $("#modalAlertasSplash").modal("hide");
        },500);
      }
    });
}

async function cubDetalleOrdenTrabajo(folioOt){
  var dato = folioOt;
  setTimeout(function(){
    var largo = Math.trunc($(window).height() - 250);

    setTimeout(function(){
      FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];

      new FancyGrid({
          renderTo: 'tablaDetalleOrdenTrabajoCubicacion',
          scrollable: true,
          multiSort: true,
          doubleHorizontalScroll: true,
          selModel: {
            type: 'rows',
            checkOnly: true
          },
          theme: 'bootstrap',
          height: largo,
          subSearch: true,
          data: {
            proxy: {
              url: 'controller/datosCubDetalleOrdenTrabajo.php',
              method: 'GET',
              params: {
                idOt: dato,
              }
            },
            fields: ['CORR', 'ESPECIALIDAD', 'CODMO', 'MANO_OBRA', 'CANMOCUB', 'PB_MO', 'VALOR_MO', 'TOTAL_MO', 'CODUO', 'UNIDAD_OBRA', 'CANUOCUB', 'VALOR_UO', 'TOTAL_UO', 'PROVEE', 'IDOBRA_CUBICACION', 'IDOBRA', 'TIPO', 'DIRECCION', 'EXPANDIR']
          },
          trackOver: true,
          defaults: {
            sortable: true,
            align: 'left',
            cellAlign: 'left',
            menu: true
          },
          cellHeight: 45,
          columns: [
            {
              type: 'select',
              locked: true
            },
            {
              type: 'number',
              resizable: true,
              locked: true,
              title: 'Corr',
              index: 'CORR',
              width: 100,

            },
            {
              title: 'Especialidad',
              resizable: true,
              locked: true,
              index: 'ESPECIALIDAD',

            },
            {
              title: 'Tipo',
              resizable: true,
              locked: true,
              index: 'TIPO',

            },
            {
              title: 'Dirección',
              resizable: true,
              draggable: true,
              width: 400,
              index: 'DIRECCION',
              //hidden: true,

            },
            {
              title: 'Cod. MO.',
              resizable: true,
              draggable: true,

              index: 'CODMO',

            },
            {
              title: 'Mano de obra',
              resizable: true,
              draggable: true,
              width: 400,
              index: 'MANO_OBRA',

            },
            {
              title: '# MO.',
              resizable: true,
              draggable: true,

              index: 'CANMOCUB',

            },
            {
              title: '# PB Mo.',
              resizable: true,
              draggable: true,

              index: 'PB_MO',

            },
            {
              title: 'Valor Mo.',
              type: 'currency',
              resizable: true,
              draggable: true,
              currency: Fancy.currency.USD,
              index: 'VALOR_MO',

            },
            {
              title: 'Total Mo.',
              type: 'currency',
              resizable: true,
              draggable: true,
              currency: Fancy.currency.USD,
              index: 'TOTAL_MO',

            },
            {
              title: 'Cod. UO.',
              resizable: true,
              draggable: true,
              index: 'CODUO',

            },
            {
              title: 'Unidad de obra',
              resizable: true,
              draggable: true,
              width: 400,
              index: 'UNIDAD_OBRA',

            },
            {
              title: '# UO.',
              resizable: true,
              draggable: true,
              index: 'CANUOCUB',

            },
            {
              title: 'Valor Uo.',
              type: 'currency',
              resizable: true,
              draggable: true,
              currency: Fancy.currency.USD,
              index: 'VALOR_UO',

            },
            {
              title: 'Total Uo.',
              type: 'currency',
              resizable: true,
              draggable: true,
              currency: Fancy.currency.USD,
              index: 'TOTAL_UO',

            },
            {
              title: 'Provee',
              resizable: true,
              draggable: true,

              index: 'PROVEE',

            }
          ],
          exporter: true,
          tbar: [
            {
              type: 'search',
              width: 200,
              emptyText: 'Buscar'
            },
            {
              text: 'Excel',
              handler: function() {
                this.expandAll();
                this.exportToExcel();
                this.collapseAll();
              }
            }
          ],
          events: [
            {
              update: function(grid){
                var h = $(window).height() - 200;
                //console.log(h);
                $("#bodyDetalleOrdenTrabajo").css("height",h);
                setTimeout(function(){
                  $('#modalDetalleOrdenTrabajo').modal('show');
                  $("#modalAlertasSplash").modal("hide");
                },500);
              }
            }
          ],
      })
    },500);
  },500);
}

$("#anticiparMaterialesObra").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#divTablaAnticipoMatObras").empty();
  var table = $('#tablaListadoObras').DataTable();
  var folio = $.map(table.rows('.selected').data(), function (item) {
      return item.IDOBRA;
  });
  var oecf = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBREOE;
  });
  var codCub = $.map(table.rows('.selected').data(), function (item) {
    return item.CUBICACION;
  });
  var agencia = $.map(table.rows('.selected').data(), function (item) {
    return item.AGENCIA;
  });

  $("#folioObraAnticipoMatObras").html('Folio orden de ejecución: ' + folio + "   |   Agencia: " + agencia);
  $("#oeAnticipoMatObras").html('Orden de ejecución: ' + oecf);
  $("#codigoCubAnticipoMatObras").html('Código de cubicación: ' + codCub);
  anticiparMateriales(folio[0]);

});

function anticiparMateriales(folio){
  $("#divTablaAnticipoMatObras").empty();
  var largo = Math.trunc($(window).height() - 350);
  setTimeout(function(){
    FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];
    new FancyGrid({
        renderTo: 'divTablaAnticipoMatObras',
        scrollable: true,
        multiSort: true,
        doubleHorizontalScroll: true,
        selModel: {
          type: 'rows',
          checkOnly: true
        },
        theme: 'bootstrap',
        height: largo,
        subSearch: true,
        data: {
          proxy: {
            url: 'controller/datosAnticipoMatObras.php',
            method: 'GET',
            params: {
              idobra: folio,
            }
          },
          fields: ['CORR', 'ESPECIALIDAD', 'CODUO', 'UNIDAD_OBRA', 'CANUOCUB', 'VALOR_UO', 'TOTAL_UO', 'PROVEE', 'IDOBRA_CUBICACION', 'ESTADO_SOL_MAT', 'CODIGO_CLIENTE', 'CODIGO_INTERNO','FOLIO_SOLICITUD']
        },
        trackOver: true,
        defaults: {
          sortable: true,
          align: 'left',
          cellAlign: 'left',
          menu: true
        },
        cellHeight: 45,
        columns: [
          {
            type: 'select',
            locked: true
          },
          {
            resizable: true,
            title: 'Anticipo',
            index: 'ESTADO_SOL_MAT',
            width: 100,
          },
          {
            resizable: true,
            title: 'Folio Ant.',
            index: 'FOLIO_SOLICITUD',
            width: 100,
          },
          {
            type: 'number',
            resizable: true,
            title: 'Corr',
            index: 'CORR',
            width: 80,
          },
          {
            title: 'Especialidad',
            resizable: true,
            width: 140,
            index: 'ESPECIALIDAD',
          },
          {
            title: 'Cod. UO.',
            resizable: true,
            draggable: true,
            width: 70,
            index: 'CODUO',
          },
          {
            title: 'Unidad de obra',
            resizable: true,
            draggable: true,
            width: 360,
            index: 'UNIDAD_OBRA',
          },
          {
            title: '# UO.',
            resizable: true,
            draggable: true,
            index: 'CANUOCUB',
          },
          {
            title: 'Valor Uo.',
            type: 'currency',
            resizable: true,
            draggable: true,
            currency: Fancy.currency.USD,
            index: 'VALOR_UO',
          },
          {
            title: 'Total Uo.',
            type: 'currency',
            resizable: true,
            draggable: true,
            currency: Fancy.currency.USD,
            index: 'TOTAL_UO',
          },
          {
            title: 'Provee',
            resizable: true,
            draggable: true,
            index: 'PROVEE',
          },
          {
            title: 'SIMA / SAP (Cliente)',
            resizable: true,
            draggable: true,
            index: 'CODIGO_CLIENTE',
            width: 250,
          },
          {
            title: 'Cód SAP / Cód2 / Cód3 (Interno)',
            resizable: true,
            draggable: true,
            index: 'CODIGO_INTERNO',
            width: 250,
          }
        ],
        exporter: true,
        tbar: [
          {
            type: 'search',
            width: 200,
            emptyText: 'Buscar'
          },
          {
            text: 'Excel',
            handler: function() {
              this.expandAll();
              this.exportToExcel();
              this.collapseAll();
            }
          },
          {
            text: 'Anticipar',
            id: 'enviarAnticipacionMaterialesObra',
            handler: async function() {
              var datosCub = this.getSelection();
              if(datosCub.length > 0){
                $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                $('#modalAlertasSplash').modal('show');
                var codigoUo = '';
                var idObraCub = new Array();
                for(var i = 0; i < datosCub.length; i++){
                  if(i == 0){
                    codigoUo += datosCub[i].CODUO.toString();
                    var item = {};
                    item.id= datosCub[i].IDOBRA_CUBICACION;
                    idObraCub.push(item);
                  }
                  else{
                    codigoUo += ',' + datosCub[i].CODUO.toString();
                    var item = {};
                    item.id = datosCub[i].IDOBRA_CUBICACION;
                    idObraCub.push(item);
                  }
                }
                var toPost1 = JSON.stringify(idObraCub);
                $("#idCubGuardarAnticipoMatObras").val(toPost1);
                $("#detalleGuardarAnticipoMatObras").html('Códigos de unidad de obra: ' + codigoUo);
                $("#foliGuardarAnticipoMatObras").val(folio);
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  $("#modalGuardarAnticipoMatObras").modal('show');
                },500);
              }
              else{
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
              }
            }
          }
        ],
        events: [
          {
            update: function(grid){
              var h = $(window).height() - 300;
              $("#bodyAnticipoMatObras").css("height",h);
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalAnticipoMatObras').modal('show');
              },500);
            },
          },
          {
            cellclick: function(grid, o){
              var datosFila = this.getData();
              var datosSel = this.getSelection();
              for(var i = 0; i < datosFila.length; i++){
                for(var j = 0; j < datosSel.length; j++){
                  if(datosSel[j].id === datosFila[i].id){
                    datosSel[j].lineaTabla = i;
                  }
                }
              }
              var ms = 0;
              for(var i = 0; i < datosSel.length; i++){
                if(datosSel[i].ESTADO_SOL_MAT === 'Anticipado'){
                  this.deSelectRow(datosSel[i].lineaTabla);
                  ms++;
                }
              }
              if(ms > 0){
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Seleccionó un material ya anticipado");
              }
            }
          }
        ],
    })
  },500);
}

$("#guardarAnticipoMatObras").unbind('click').click(async function(){
  var datos = $("#idCubGuardarAnticipoMatObras").val();
  var folio = $("#foliGuardarAnticipoMatObras").val();
  $("#modalGuardarAnticipoMatObras").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url: "controller/anticiparMaterialesObra.php",
    type: 'POST',
    data:{
      "datos" : datos,
    },
    success:  async function (response) {
      var p2 = jQuery.parseJSON(response);
      await $.ajax({
        url: "controller/ingresaAnticiparMaterialesObra.php",
        type:"POST",
        data:{
          "datos" : datos,
          "idSolMatAnt": Number(p2[0]['LAST_INSERT_ID()']),
        },
        success: function (res2){
          var p = res2.split(",");
          if(res2.localeCompare("Sin datos")!= 0 && res2 != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              anticiparMateriales(folio);
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Anticipo de materiales guardado correctamente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al anticipar materiales");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al anticipar materiales");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
      });
    }
  });
});

$("#pedirMaterialesObra").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#divTablaPedirMatObrasOt").empty();
  var table = $('#tablaListadoOrdenesTrabajo').DataTable();
  var idOt = $.map(table.rows('.selected').data(), function (item) {
      return item.FOLIO;
  });
  var folio = $.map(table.rows('.selected').data(), function (item) {
      return item.IDOBRA;
  });
  var oecf = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBREOE;
  });
  var codCub = $.map(table.rows('.selected').data(), function (item) {
    return item.CUBICACION;
  });
  var agencia = $.map(table.rows('.selected').data(), function (item) {
    return item.AGENCIA;
  });

  $("#folioObraPedirMatObrasOt").html('Orden de trabajo: ' + idOt + "   |   Agencia: " + agencia);
  $("#oePedirMatObrasOt").html('Orden de ejecución: ' + oecf);
  $("#codigoCubPedirMatObrasOt").html('Código de cubicación: ' + codCub);
  pedirMateriales(idOt[0]);

});

function pedirMateriales(idOt){
  $("#divTablaPedirMatObrasOt").empty();
  var largo = Math.trunc($(window).height() - 350);
  setTimeout(function(){
    FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];
    new FancyGrid({
        renderTo: 'divTablaPedirMatObrasOt',
        scrollable: true,
        multiSort: true,
        doubleHorizontalScroll: true,
        selModel: {
          type: 'rows',
          checkOnly: true
        },
        theme: 'bootstrap',
        height: largo,
        subSearch: true,
        data: {
          proxy: {
            url: 'controller/datosPeticionMatObrasOt.php',
            method: 'GET',
            params: {
              idOt: idOt,
            }
          },
          fields: ['CORR', 'ESPECIALIDAD', 'CODUO', 'UNIDAD_OBRA', 'CANUOCUB', 'VALOR_UO', 'TOTAL_UO', 'PROVEE', 'IDOBRA_OT_CUBICACION', 'ESTADO_SOL_MAT', 'CODIGO_CLIENTE', 'CODIGO_INTERNO', 'FOLIO_SOLICITUD']
        },
        trackOver: true,
        defaults: {
          sortable: true,
          align: 'left',
          cellAlign: 'left',
          menu: true
        },
        cellHeight: 45,
        columns: [
          {
            type: 'select',
            locked: true
          },
          {
            resizable: true,
            title: 'Pedido',
            index: 'ESTADO_SOL_MAT',
            width: 100,
          },
          {
            resizable: true,
            title: 'Folio Ped.',
            index: 'FOLIO_SOLICITUD',
            width: 100,
          },
          {
            type: 'number',
            resizable: true,
            title: 'Corr',
            index: 'CORR',
            width: 80,
          },
          {
            title: 'Especialidad',
            resizable: true,
            width: 140,
            index: 'ESPECIALIDAD',
          },
          {
            title: 'Cod. UO.',
            resizable: true,
            draggable: true,
            width: 70,
            index: 'CODUO',
          },
          {
            title: 'Unidad de obra',
            resizable: true,
            draggable: true,
            width: 360,
            index: 'UNIDAD_OBRA',
          },
          {
            title: '# UO.',
            resizable: true,
            draggable: true,
            index: 'CANUOCUB',
          },
          {
            title: 'Valor Uo.',
            type: 'currency',
            resizable: true,
            draggable: true,
            currency: Fancy.currency.USD,
            index: 'VALOR_UO',
          },
          {
            title: 'Total Uo.',
            type: 'currency',
            resizable: true,
            draggable: true,
            currency: Fancy.currency.USD,
            index: 'TOTAL_UO',
          },
          {
            title: 'Provee',
            resizable: true,
            draggable: true,

            index: 'PROVEE',
          },
          {
            title: 'SIMA / SAP (Cliente)',
            resizable: true,
            draggable: true,
            index: 'CODIGO_CLIENTE',
            width: 250,
          },
          {
            title: 'Cód SAP / Cód2 / Cód3 (Interno)',
            resizable: true,
            draggable: true,
            index: 'CODIGO_INTERNO',
            width: 250,
          }
        ],
        exporter: true,
        tbar: [
          {
            type: 'search',
            width: 200,
            emptyText: 'Buscar'
          },
          {
            text: 'Excel',
            handler: function() {
              this.expandAll();
              this.exportToExcel();
              this.collapseAll();
            }
          },
          {
            text: 'Pedir Mat.',
            id: 'enviarGuardarPeticionMatObrasOt',
            handler: async function() {
              var datosCub = this.getSelection();
              if(datosCub.length > 0){
                $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                $('#modalAlertasSplash').modal('show');
                var codigoUo = '';
                var idObraCub = new Array();
                for(var i = 0; i < datosCub.length; i++){
                  if(i == 0){
                    codigoUo += datosCub[i].CODUO.toString();
                    var item = {};
                    item.id= datosCub[i].IDOBRA_OT_CUBICACION;
                    idObraCub.push(item);
                  }
                  else{
                    codigoUo += ',' + datosCub[i].CODUO.toString();
                    var item = {};
                    item.id = datosCub[i].IDOBRA_OT_CUBICACION;
                    idObraCub.push(item);
                  }
                }
                var toPost1 = JSON.stringify(idObraCub);
                $("#idCubGuardarPeticionMatObrasOt").val(toPost1);
                $("#idOtGuardarPeticionMatObrasOt").val(idOt);
                $("#detalleGuardarPeticionMatObrasOt").html('Códigos de unidad de obra: ' + codigoUo);
                $("#detalle2GuardarPeticionMatObrasOt").html('Folio OT: ' + idOt);
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  $("#modalGuardarPeticionMatObrasOt").modal('show');
                },500);
              }
              else{
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
              }
            }
          }
        ],
        events: [
          {
            update: function(grid){
              var h = $(window).height() - 300;
              $("#bodyPedirMatObrasOts").css("height",h);
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalPedirMatObrasOt').modal('show');
              },500);
            }
          },
          {
            cellclick: function(grid, o){
              var datosFila = this.getData();
              var datosSel = this.getSelection();
              for(var i = 0; i < datosFila.length; i++){
                for(var j = 0; j < datosSel.length; j++){
                  if(datosSel[j].id === datosFila[i].id){
                    datosSel[j].lineaTabla = i;
                  }
                }
              }
              var ms = 0;
              for(var i = 0; i < datosSel.length; i++){
                if(datosSel[i].ESTADO_SOL_MAT === 'Pedido'){
                  this.deSelectRow(datosSel[i].lineaTabla);
                  ms++;
                }
              }
              if(ms > 0){
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Seleccionó un material ya pedido");
              }
            }
          }
        ],
    })
  },500);
}

$("#guardarPeticionMatObrasOt").unbind('click').click(async function(){
  var datos = $("#idCubGuardarPeticionMatObrasOt").val();
  var idOt = $("#idOtGuardarPeticionMatObrasOt").val();
  $("#modalGuardarPeticionMatObrasOt").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url: "controller/pedirMaterialesObrasOt.php",
    type: 'POST',
    data: {
      "datos" : datos,
    },
    success:  async function (response) {
      var p2 = jQuery.parseJSON(response);
      await $.ajax({
        url: "controller/ingresaPedirMaterialesObrasOt.php",
        type:"POST",
        data:{
          "datos" : datos,
          "idSolMatPed": Number(p2[0]['LAST_INSERT_ID()']),
        },
        success: function (res2){
          var p = res2.split(",");
          if(res2.localeCompare("Sin datos")!= 0 && res2 != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              pedirMateriales(idOt);
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Petición de materiales guardado correctamente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al pedir materiales");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al pedir materiales");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
      });
    }
  });
});

$("#tipoSolicitudMaterialesObras").unbind("click").change(function(){
  var table = $("#tablaListadoSolicitudMaterialesObra").DataTable();
  var tipoSol = $("#tipoSolicitudMaterialesObras").val();
  if(tipoSol == "0"){
    tipoSol = '';
  }
  table.rows('').deselect();
  table.columns('2').search(tipoSol).draw();
});

$("#filtroEstadoSolicitudMateriales").unbind("click").change(function(){
  var table = $("#tablaListadoSolicitudMaterialesObra").DataTable();
  var estadoSol = $("#filtroEstadoSolicitudMateriales").val();
  if(estadoSol == "0"){
    estadoSol = '';
  }
  table.rows('').deselect();
  table.columns('6').search(estadoSol).draw();
});

$("#filtroAreaSolicitudMateriales").unbind("click").change(function(){
  var table = $("#tablaListadoSolicitudMaterialesObra").DataTable();
  var areaSol = $("#filtroAreaSolicitudMateriales").val();
  if(areaSol == "0"){
    areaSol = '';
  }
  table.rows('').deselect();
  table.columns('7').search(areaSol).draw();
});

async function recargaPeriodoSolicitudMateriales(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var path = window.location.href.split('#/')[1];
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);

  var parametros = {
    "path": path,
    "inicio": $('#filtroPeriodoSolicitudMateriales').val().split(" al ")[0],
    "fin": $('#filtroPeriodoSolicitudMateriales').val().split(" al ")[1],
  }

  await $('#tablaListadoSolicitudMaterialesObra').DataTable( {
    ajax: {
        url: "controller/datosListadoSolicitudMatObras.php",
        type: 'POST',
        data: parametros
    },
    columns: [
        { data: 'S'},
        { data: 'FOLIO'},
        { data: 'TIPO'},
        { data: 'FECHA' },
        { data: 'HORA'},
        { data: 'SOLICITANTE'},
        { data: 'ESTADO'},
        { data: 'AREA'}
    ],
    buttons: [
        {
          extend: 'excel',
          exportOptions: {
            columns: [ 1,2,3,4,5,6,7 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
        }
    ],
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      }
    ],
    "select": {
        style: 'single'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "info":     true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      var table = $('#tablaListadoSolicitudMaterialesObra').DataTable();
      var tipoSolMat = '';
      tipoSolMat += '<option selected value="0">Todos</option>';
      for(var i = 0; i < table.column(2).data().unique().length; i++){
        if(table.column(2).data().unique()[i] !== null){
          tipoSolMat += '<option value="' + table.column(2).data().unique()[i] + '">' + table.column(2).data().unique()[i] + '</option>';
        }
      }
      $("#tipoSolicitudMaterialesObras").html(tipoSolMat);

      var estadoSolMat = '';
      estadoSolMat += '<option selected value="0">Todos</option>';
      for(var i = 0; i < table.column(6).data().unique().length; i++){
        if(table.column(6).data().unique()[i] !== null){
          estadoSolMat += '<option value="' + table.column(6).data().unique()[i] + '">' + table.column(6).data().unique()[i] + '</option>';
        }
      }
      $("#filtroEstadoSolicitudMateriales").html(estadoSolMat);

      var areaSolMat = '';
      areaSolMat += '<option selected value="0">Todos</option>';
      for(var i = 0; i < table.column(7).data().unique().length; i++){
        if(table.column(7).data().unique()[i] !== null){
          areaSolMat += '<option value="' + table.column(7).data().unique()[i] + '">' + table.column(7).data().unique()[i] + '</option>';
        }
      }
      $("#filtroAreaSolicitudMateriales").html(areaSolMat);

      if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        $("#tipoSolicitudMaterialesObras").select2({
            theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $("#filtroEstadoSolicitudMateriales").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
        $("#filtroAreaSolicitudMateriales").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
        });
      }

      setTimeout(function(){
        $('#modalAlertasSplash').modal('hide');
      },500);
    }
  });
};

$("#agregarMaterial").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#observacionAgregarMaterial").val("");
  $("#divTablaAgregarMaterial").empty(); // divTablaAnticipoMatObras
  var table = $('#tablaListadoSolicitudMaterialesObra').DataTable();
  var folio = $.map(table.rows('.selected').data(), function (item) {
      return item.FOLIO;
  });
  var tipo = $.map(table.rows('.selected').data(), function (item) {
      return item.TIPO;
  });
  var area = $.map(table.rows('.selected').data(), function (item) {
      return item.AREA;
  });

  $("#folioAgregarMaterial").html('Folio: ' + folio);
  $("#tipoAgregarMaterial").html('Tipo: ' + tipo);
  $("#areaAgregarMaterial").html('Área funcional: ' + area);
  $("#tipoSolicitudAgregarMaterial").val(tipo[0]);
  solicitudMateriales(folio[0],tipo[0]);

});

function solicitudMateriales(folio,tipo){
  $("#divTablaAgregarMaterial").empty();
  var largo = Math.trunc($(window).height() - 350);
  setTimeout(function(){
    FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];
    var hid = false;
    var grid = new FancyGrid({
        renderTo: 'divTablaAgregarMaterial',
        scrollable: true,
        multiSort: true,
        doubleHorizontalScroll: true,
        selModel: {
          type: 'rows',
          checkOnly: true
        },
        theme: 'bootstrap',
        height: largo,
        subSearch: true,
        data: {
          proxy: {
            url: 'controller/datosAgregarMaterial.php',
            method: 'GET',
            params: {
              idAgregarMat: folio,
              tipo: tipo,
            }
          },
          fields: ['CORR', 'ESPECIALIDAD', 'CODUO', 'UNIDAD_OBRA', 'CANUOCUB', 'VALOR_UO', 'TOTAL_UO', 'PROVEE', 'IDOBRA_CUBICACION', 'IDOBRA_OT_CUBICACION', 'ESTADO', 'CODIGO_CLIENTE', 'CODIGO_INTERNO','PDF_ENTREGA','PDF_GUIA_DESPACHO','FOLIO_SOL','FOLIO_COORD','UM','BODEGA','NUMERO_PDF','NUMERO_GUIA']
        },
        trackOver: true,
        defaults: {
          sortable: true,
          align: 'left',
          cellAlign: 'left',
          menu: true
        },
        cellHeight: 45,
        exporter: true,
        tbar: [
          {
            type: 'search',
            width: 200,
            emptyText: 'Buscar'
          },
          {
            text: 'Excel',
            handler: function() {
              this.expandAll();
              this.exportToExcel();
              this.collapseAll();
            }
          },
          {
            text: 'Solicitar a mandante',
            id: 'solicitarClienteSolicitudMaterial',
            handler: async function() {
              var datosProvee = this.getSelection();
              if(datosProvee.length > 0){
                var estado = new Array();
                var provee = new Array();
                for(var i=0; i< datosProvee.length; i++){
                  estado.push(datosProvee[i].ESTADO.toString());
                  provee.push(datosProvee[i].PROVEE.toString());
                }
                var newEstado = [...new Set(estado)];
                var newProvee = [...new Set(provee)];
                if(newEstado.length == 1 && newEstado[0] === 'Solicitado'){
                  if(newProvee.length == 1 && newProvee[0] === 'Cliente'){
                    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                    $('#modalAlertasSplash').modal('show');
                    var codigoUo = '';
                    var codigoForEmail = new Array();
                    for(var i = 0; i < datosProvee.length; i++){
                      if(i == 0){
                        var item = {};
                        codigoUo += datosProvee[i].CODUO.toString();
                        item.id = datosProvee[i].IDOBRA_CUBICACION;
                        codigoForEmail.push(item);
                      }
                      else{
                        var item = {};
                        codigoUo += ',' + datosProvee[i].CODUO.toString();
                        item.id = datosProvee[i].IDOBRA_CUBICACION;
                        codigoForEmail.push(item);
                      }
                    }
                    var toPost1 = JSON.stringify(codigoForEmail);
                    $("#idCubSolicitarClienteSolicitudMaterial").val(toPost1);
                    $("#folioSolicitarClienteSolicitudMaterial").val(folio);
                    $("#tipoSolicitarClienteSolicitudMaterial").val(tipo);
                    $("#detalleSolicitarClienteSolicitudMaterial").html('Códigos de unidad de obra: ' + codigoUo);
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                      $("#modalSolicitarClienteSolicitudMaterial").modal('show');
                    },500);
                  }else if(newProvee.length == 1 && newProvee[0] === '--'){
                    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se puede gestionar materiales con proveedor no configurado");
                  }else{
                    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se puede solicitar materiales de tipo interno o con proveedor no configurado");
                  }
                }else{
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Materiales fuera de estado");
                }
              }
              else{
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
              }
            }
          },
          {
            text: 'En preparación',
            id:'estadoPreparacionSolicitudMaterial',
            handler: async function(){
              var datosPreparacion = this.getSelection();
              if(datosPreparacion.length > 0){
                var estado = new Array();
                var provee = new Array();
                for(var i=0; i< datosPreparacion.length; i++){
                  estado.push(datosPreparacion[i].ESTADO.toString());
                  provee.push(datosPreparacion[i].PROVEE.toString());
                }
                var newProvee = [...new Set(provee)];
                var newEstado = [...new Set(estado)];
                if(provee.includes('--')){
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se puede gestionar materiales con proveedor no configurado");
                }else{
                  if(newEstado.length == 1 ){
                    if(tipo == 'Pedido'){
                      if(newEstado[0] === 'Solicitado'){
                        $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                        $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                        $('#modalAlertasSplash').modal('show');
                        var codigoUo = '';
                        var codigos = new Array();
                        for(var i = 0; i < datosPreparacion.length; i++){
                          if(i == 0){
                            var item = {};
                            codigoUo += datosPreparacion[i].CODUO.toString();
                            item.id = datosPreparacion[i].IDOBRA_OT_CUBICACION;
                            codigos.push(item);
                          }
                          else{
                            var item = {};
                            codigoUo += ',' + datosPreparacion[i].CODUO.toString();
                            item.id = datosPreparacion[i].IDOBRA_OT_CUBICACION;
                            codigos.push(item);
                          }
                        }
                        var toPost1 = JSON.stringify(codigos);
                        $("#idCubEstadoPreparacionSolicitudMaterial").val(toPost1);
                        $("#folioEstadoPreparacionSolicitudMaterial").val(folio);
                        $("#tipoEstadoPreparacionSolicitudMaterial").val(tipo);
                        $("#detalleEstadoPreparacionSolicitudMaterial").html('Códigos de unidad de obra: ' + codigoUo);
                        $("#folioCoordEstadoPreparacionSolicitudMaterial").val('');
                        $("#folioCoordEstadoPreparacionSolicitudMaterial").removeClass("is-invalid");
                        $("#datosBodegaEnPreparacion").empty();
                        $("#folioCoordPreparacion").hide();
                        $('#checkboxInputsBodegaPreparacion').prop('checked', false);
                        $("#copiarInputsBodegaPreparacion").show();


                        for(var i = 0; i < datosPreparacion.length; i++){
                          if(i == 0){
                            cuerpoC = '';
                            cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="font-weight: bold;">UM</label></div>';
                            cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="font-weight: bold;">Descripción</label></div>';
                            cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="font-weight: bold;">Bodega</label></div>';
                            cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosPreparacion[i].CODUO +'</label></div>';
                            cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosPreparacion[i].UNIDAD_OBRA +'</label></div>';
                            cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            parametros = {
                              "id": datosPreparacion[i].IDOBRA_OT_CUBICACION ,
                            }
                            await $.ajax({
                              url:   'controller/bodegasAnticipoForPedido.php',
                              type:  'post',
                              data: parametros,
                              success: function (response) {
                                cuerpoC += '<input id="'+datosPreparacion[i].IDOBRA_OT_CUBICACION+'" class="form-control" type="text" value="'+ response +'"></div>';
                              }
                            });
                          }
                          else{
                            cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosPreparacion[i].CODUO +'</label></div>';
                            cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosPreparacion[i].UNIDAD_OBRA +'</label></div>';
                            cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            parametros2 = {
                              "id": datosPreparacion[i].IDOBRA_OT_CUBICACION ,
                            }
                            await $.ajax({
                              url:   'controller/bodegasAnticipoForPedido.php',
                              type:  'post',
                              data: parametros2,
                              success: function (respon) {
                                cuerpoC += '<input id="'+datosPreparacion[i].IDOBRA_OT_CUBICACION+'" class="form-control" type="text" value="'+ respon +'"></div>';
                              }
                            });
                          }
                        }
                        $("#datosBodegaEnPreparacion").html(cuerpoC);

                        for(var j = 0; j < datosPreparacion.length; j++){
                            await $.ajax({
                              url:   'controller/datosBodegaSucursal.php',
                              type:  'post',
                              success: function (response) {
                                var p = jQuery.parseJSON(response);
                                if(p.aaData.length !== 0){
                                  var listaBodegaSucursales = [];
                                  for(var i = 0; i < p.aaData.length; i++) {
                                    listaBodegaSucursales.push(p.aaData[i].SUCURSAL);
                                  }
                                  $('#'+datosPreparacion[j].IDOBRA_OT_CUBICACION+'').autocomplete({
                                    source: function (req, responseFn) {
                                      var term = $.ui.autocomplete.escapeRegex(req.term),
                                        matcher = new RegExp(term, 'i'),
                                        matches = $.grep(listaBodegaSucursales, function (item) {
                                          return matcher.test(item);
                                        });
                                      responseFn(matches);
                                    }
                                  });
                                }
                              }
                            });
                          }

                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                          $("#modalEstadoPreparacionSolicitudMaterial").modal('show');
                        },500);
                      }else{
                        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Materiales fuera de estado");
                      }
                    }else if(tipo == 'Anticipo'){
                      if(newProvee.length == 1){
                        if(newEstado[0] === 'En curso' || (newEstado[0] === 'Solicitado' && newProvee[0] === 'Interno')){
                          $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                          $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                          $('#modalAlertasSplash').modal('show');
                          $("#copiarInputsBodegaPreparacion").hide();
                          var codigoUo = '';
                          var codigos = new Array();
                          for(var i = 0; i < datosPreparacion.length; i++){
                            if(i == 0){
                              var item = {};
                              codigoUo += datosPreparacion[i].CODUO.toString();
                              item.id = datosPreparacion[i].IDOBRA_CUBICACION;
                              codigos.push(item);
                            }
                            else{
                              var item = {};
                              codigoUo += ',' + datosPreparacion[i].CODUO.toString();
                              item.id = datosPreparacion[i].IDOBRA_CUBICACION;
                              codigos.push(item);
                            }
                          }
                          var toPost1 = JSON.stringify(codigos);
                          $("#idCubEstadoPreparacionSolicitudMaterial").val(toPost1);
                          $("#folioEstadoPreparacionSolicitudMaterial").val(folio);
                          $("#tipoEstadoPreparacionSolicitudMaterial").val(tipo);
                          $("#detalleEstadoPreparacionSolicitudMaterial").html('Códigos de unidad de obra: ' + codigoUo);
                          $("#folioCoordEstadoPreparacionSolicitudMaterial").val('');
                          $("#folioCoordEstadoPreparacionSolicitudMaterial").removeClass("is-invalid");
                          $("#datosBodegaEnPreparacion").empty();
                          $("#folioCoordPreparacion").show();

                          if(newProvee[0] === 'Cliente'){
                            $("#estadoPreparacionSolicitudMaterial").val('Cliente');
                            $("#folioCoordEstadoPreparacionSolicitudMaterial").attr('placeholder','');
                          }else{
                            $("#estadoPreparacionSolicitudMaterial").val('Interno');
                            $("#folioCoordEstadoPreparacionSolicitudMaterial").attr('placeholder','No es obligatorio si el UO es de tipo interno');
                          }
                          setTimeout(function(){
                            $('#modalAlertasSplash').modal('hide');
                            $("#modalEstadoPreparacionSolicitudMaterial").modal('show');
                          },500);
                        }else{
                          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Materiales fuera de estado");
                        }
                      }else{
                        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar materiales solo de clientes o solo internos en la columna provee");
                      }
                    }
                  }else{
                    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar materiales con el mismo estado");
                  }
                }
              }else{
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
              }
            }
          },
          {
            text: 'Preparado',
            id:'estadoPreparadoSolicitudMaterial',
            handler: async function(){
              var datosPreparados = this.getSelection();
              if(datosPreparados.length > 0){
                var estado = new Array();
                var provee = new Array();
                for(var i=0; i< datosPreparados.length; i++){
                  estado.push(datosPreparados[i].ESTADO.toString());
                  provee.push(datosPreparados[i].PROVEE.toString());
                }
                var newProvee = [...new Set(provee)];
                var newEstado = [...new Set(estado)];

                if(provee.includes('--')){
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se puede gestionar materiales con proveedor no configurado");
                }else{
                  if(newEstado.length == 1 ){
                    if(newEstado[0] === 'En preparación'){
                      $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                      $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                      $('#modalAlertasSplash').modal('show');
                      var codigoUo = '';
                      var codigos = new Array();
                      for(var i = 0; i < datosPreparados.length; i++){
                        if(i == 0){
                          var item = {};
                          codigoUo += datosPreparados[i].CODUO.toString();
                          item.id = datosPreparados[i].IDOBRA_CUBICACION;
                          codigos.push(item);
                        }
                        else{
                          var item = {};
                          codigoUo += ',' + datosPreparados[i].CODUO.toString();
                          item.id = datosPreparados[i].IDOBRA_CUBICACION;
                          codigos.push(item);
                        }
                      }
                      var toPost1 = JSON.stringify(codigos);
                      $("#idCubEstadoPreparadoSolicitudMaterial").val(toPost1);
                      $("#folioEstadoPreparadoSolicitudMaterial").val(folio);
                      $("#tipoEstadoPreparadoSolicitudMaterial").val(tipo);
                      $("#detalleEstadoPreparadoSolicitudMaterial").html('Códigos de unidad de obra: ' + codigoUo);

                      for(var i = 0; i < datosPreparados.length; i++){
                        if(i == 0){
                          cuerpoC = '';
                          cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                          cuerpoC += '<label style="font-weight: bold;">UM</label></div>';
                          cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                          cuerpoC += '<label style="font-weight: bold;">Descripción</label></div>';
                          cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                          cuerpoC += '<label style="font-weight: bold;">Bodega</label></div>';
                          cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                          cuerpoC += '<label style="display: block;">'+ datosPreparados[i].CODUO +'</label></div>';
                          cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                          cuerpoC += '<label style="display: block;">'+ datosPreparados[i].UNIDAD_OBRA +'</label></div>';
                          cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                          cuerpoC += '<input id="'+datosPreparados[i].IDOBRA_CUBICACION+'" class="form-control" type="text" value=""></div>';
                        }
                        else{
                          cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                          cuerpoC += '<label style="display: block;">'+ datosPreparados[i].CODUO +'</label></div>';
                          cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                          cuerpoC += '<label style="display: block;">'+ datosPreparados[i].UNIDAD_OBRA +'</label></div>';
                          cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                          cuerpoC += '<input id="'+datosPreparados[i].IDOBRA_CUBICACION+'" class="form-control" type="text" value=""></div>';
                        }
                      }
                      $("#datosBodegaPreparado").html(cuerpoC);
                      $('#checkboxInputsBodegaPreparado').prop('checked', false);

                      for(var j = 0; j < datosPreparados.length; j++){
                        await $.ajax({
                          url:   'controller/datosBodegaSucursal.php',
                          type:  'post',
                          success: function (response) {
                            var p = jQuery.parseJSON(response);
                            if(p.aaData.length !== 0){
                              var listaBodegaSucursales = [];
                              for(var i = 0; i < p.aaData.length; i++) {
                                listaBodegaSucursales.push(p.aaData[i].SUCURSAL);
                              }
                              $('#'+datosPreparados[j].IDOBRA_CUBICACION+'').autocomplete({
                                source: function (req, responseFn) {
                                  var term = $.ui.autocomplete.escapeRegex(req.term),
                                    matcher = new RegExp(term, 'i'),
                                    matches = $.grep(listaBodegaSucursales, function (item) {
                                      return matcher.test(item);
                                    });
                                  responseFn(matches);
                                }
                              });
                            }
                          }
                        });
                      }

                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                        $("#modalEstadoPreparadoSolicitudMaterial").modal('show');
                      },500);
                    }else{
                      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Materiales fuera de estado");
                    }
                  }else{
                    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar materiales con el mismo estado");
                  }
                }
              }else{
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
              }
            }
          },
          {
            text: 'En bodega',
            id:'estadoBodegaSolicitudMaterial',
            handler: async function(){
              var datosBodega = this.getSelection();
              if(datosBodega.length > 0){
                var estado = new Array();
                var provee = new Array();
                for(var i=0; i< datosBodega.length; i++){
                  estado.push(datosBodega[i].ESTADO.toString());
                  provee.push(datosBodega[i].PROVEE.toString());
                }
                var newProvee = [...new Set(provee)];
                var newEstado = [...new Set(estado)];
                if(provee.includes('--')){
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se puede gestionar materiales con proveedor no configurado");
                }else{
                  if(newEstado.length == 1 ){
                    if(tipo == "Anticipo"){
                      if(newEstado[0] === 'Preparado' || newEstado[0] === 'En preparación'){
                        $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                        $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                        $('#modalAlertasSplash').modal('show');
                        var codigoUo = '';
                        var codigos = new Array();
                        for(var i = 0; i < datosBodega.length; i++){
                          if(i == 0){
                            var item = {};
                            codigoUo += datosBodega[i].CODUO.toString();
                            item.id = datosBodega[i].IDOBRA_CUBICACION;
                            codigos.push(item);
                          }
                          else{
                            var item = {};
                            codigoUo += ',' + datosBodega[i].CODUO.toString();
                            item.id = datosBodega[i].IDOBRA_CUBICACION;
                            codigos.push(item);
                          }
                        }
                        var toPost1 = JSON.stringify(codigos);
                        $("#idCubEstadoBodegaSolicitudMaterial").val(toPost1);
                        $("#folioEstadoBodegaSolicitudMaterial").val(folio);
                        $("#tipoEstadoBodegaSolicitudMaterial").val(tipo);
                        $("#detalleEstadoBodegaSolicitudMaterial").html('Códigos de unidad de obra: ' + codigoUo);

                        for(var i = 0; i < datosBodega.length; i++){
                          if(i == 0){
                            cuerpoC = '';
                            cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="font-weight: bold;">UM</label></div>';
                            cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="font-weight: bold;">Descripción</label></div>';
                            cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="font-weight: bold;">Bodega</label></div>';
                            cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosBodega[i].CODUO +'</label></div>';
                            cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosBodega[i].UNIDAD_OBRA +'</label></div>';
                            cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            if(datosBodega[i].BODEGA === ''){
                              datosBodega[i].BODEGA = 'Sin datos';
                            }
                            cuerpoC += '<input id="'+datosBodega[i].IDOBRA_CUBICACION+'" class="form-control" type="text" value="'+datosBodega[i].BODEGA+'"></div>';
                          }
                          else{
                            cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosBodega[i].CODUO +'</label></div>';
                            cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosBodega[i].UNIDAD_OBRA +'</label></div>';
                            cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            if(datosBodega[i].BODEGA === ''){
                              datosBodega[i].BODEGA = 'Sin datos';
                            }
                            cuerpoC += '<input id="'+datosBodega[i].IDOBRA_CUBICACION+'" class="form-control" type="text" value="'+datosBodega[i].BODEGA+'"></div>';
                          }
                        }
                        $("#datosBodegaEnBodega").html(cuerpoC);
                        $('#checkboxInputsBodegaBodega').prop('checked', false);

                        for(var j = 0; j < datosBodega.length; j++){
                          await $.ajax({
                            url:   'controller/datosBodegaSucursal.php',
                            type:  'post',
                            success: function (response) {
                              var p = jQuery.parseJSON(response);
                              if(p.aaData.length !== 0){
                                var listaBodegaSucursales = [];
                                for(var i = 0; i < p.aaData.length; i++) {
                                  listaBodegaSucursales.push(p.aaData[i].SUCURSAL);
                                }
                                $('#'+datosBodega[j].IDOBRA_CUBICACION+'').autocomplete({
                                  source: function (req, responseFn) {
                                    var term = $.ui.autocomplete.escapeRegex(req.term),
                                      matcher = new RegExp(term, 'i'),
                                      matches = $.grep(listaBodegaSucursales, function (item) {
                                        return matcher.test(item);
                                      });
                                    responseFn(matches);
                                  }
                                });
                              }
                            }
                          });
                        }

                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                          $("#modalEstadoBodegaSolicitudMaterial").modal('show');
                        },500);
                      }else{
                        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Materiales fuera de estado");
                      }
                    }else if(tipo == "Pedido"){
                      console.log(newEstado[0]);
                      if(newEstado[0] === 'Solicitado' || newEstado[0] === 'En preparación'){
                        $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                        $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                        $('#modalAlertasSplash').modal('show');
                        var codigoUo = '';
                        var codigos = new Array();
                        for(var i = 0; i < datosBodega.length; i++){
                          if(i == 0){
                            var item = {};
                            codigoUo += datosBodega[i].CODUO.toString();
                            item.id = datosBodega[i].IDOBRA_OT_CUBICACION;
                            codigos.push(item);
                          }
                          else{
                            var item = {};
                            codigoUo += ',' + datosBodega[i].CODUO.toString();
                            item.id = datosBodega[i].IDOBRA_OT_CUBICACION;
                            codigos.push(item);
                          }
                        }
                        var toPost1 = JSON.stringify(codigos);
                        $("#idCubEstadoBodegaSolicitudMaterial").val(toPost1);
                        $("#folioEstadoBodegaSolicitudMaterial").val(folio);
                        $("#tipoEstadoBodegaSolicitudMaterial").val(tipo);
                        $("#detalleEstadoBodegaSolicitudMaterial").html('Códigos de unidad de obra: ' + codigoUo);

                        for(var i = 0; i < datosBodega.length; i++){
                          if(i == 0){
                            cuerpoC = '';
                            cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="font-weight: bold;">UM</label></div>';
                            cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="font-weight: bold;">Descripción</label></div>';
                            cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="font-weight: bold;">Bodega</label></div>';
                            cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosBodega[i].CODUO +'</label></div>';
                            cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosBodega[i].UNIDAD_OBRA +'</label></div>';
                            cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            if(datosBodega[i].BODEGA === ''){
                              datosBodega[i].BODEGA = 'Sin datos';
                            }
                            cuerpoC += '<input id="'+datosBodega[i].IDOBRA_OT_CUBICACION+'" class="form-control" type="text" value="'+datosBodega[i].BODEGA+'"></div>';
                          }
                          else{
                            cuerpoC += '<div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosBodega[i].CODUO +'</label></div>';
                            cuerpoC += '<div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            cuerpoC += '<label style="display: block;">'+ datosBodega[i].UNIDAD_OBRA +'</label></div>';
                            cuerpoC += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">';
                            if(datosBodega[i].BODEGA === ''){
                              datosBodega[i].BODEGA = 'Sin datos';
                            }
                            cuerpoC += '<input id="'+datosBodega[i].IDOBRA_OT_CUBICACION+'" class="form-control" type="text" value="'+datosBodega[i].BODEGA+'"></div>';
                          }
                        }
                        $("#datosBodegaEnBodega").html(cuerpoC);
                        $('#checkboxInputsBodegaBodega').prop('checked', false);

                        for(var k = 0; k < datosBodega.length; k++){
                          await $.ajax({
                            url:   'controller/datosBodegaSucursal.php',
                            type:  'post',
                            success: function (response) {
                              var p = jQuery.parseJSON(response);
                              if(p.aaData.length !== 0){
                                var listaBodegaSucursales = [];
                                for(var i = 0; i < p.aaData.length; i++) {
                                  listaBodegaSucursales.push(p.aaData[i].SUCURSAL);
                                }
                                $('#'+datosBodega[k].IDOBRA_OT_CUBICACION+'').autocomplete({
                                  source: function (req, responseFn) {
                                    var term = $.ui.autocomplete.escapeRegex(req.term),
                                      matcher = new RegExp(term, 'i'),
                                      matches = $.grep(listaBodegaSucursales, function (item) {
                                        return matcher.test(item);
                                      });
                                    responseFn(matches);
                                  }
                                });
                              }
                            }
                          });
                        }

                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                          $("#modalEstadoBodegaSolicitudMaterial").modal('show');
                        },500);
                      }else{
                        alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Materiales fuera de estado");
                      }
                    }
                  }else{
                    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar materiales con el mismo estado");
                  }
                }
              }else{
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
              }
            }
          },
          {
            text: 'Entregado',
            id:'estadoEntregadoSolicitudMaterial',
            handler: async function(){
              var datosEntregado = this.getSelection();
              if(datosEntregado.length > 0){
                var estado = new Array();
                var provee = new Array();
                for(var i=0; i< datosEntregado.length; i++){
                  estado.push(datosEntregado[i].ESTADO.toString());
                  provee.push(datosEntregado[i].PROVEE.toString());
                }
                var newProvee = [...new Set(provee)];
                var newEstado = [...new Set(estado)];
                if(provee.includes('--')){
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>No se puede gestionar materiales con proveedor no configurado");
                }else{
                  if(newEstado.length == 1 ){
                    if(newEstado[0] === 'En bodega'){
                      $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                      $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                      $('#modalAlertasSplash').modal('show');
                      var codigoUo = '';
                      var codigos = new Array();
                      for(var i = 0; i < datosEntregado.length; i++){
                        if(i == 0){
                          var item = {};
                          codigoUo += datosEntregado[i].CODUO.toString();
                          item.codmat = datosEntregado[i].CODUO;
                          item.codin = datosEntregado[i].CODIGO_INTERNO;
                          item.codmand = datosEntregado[i].CODIGO_CLIENTE;
                          item.desc = datosEntregado[i].UNIDAD_OBRA;
                          item.cant = datosEntregado[i].CANUOCUB;
                          item.folcor = datosEntregado[i].FOLIO_COORD;
                          item.idOtCub = datosEntregado[i].IDOBRA_OT_CUBICACION;
                          item.um = datosEntregado[i].UM;
                          item.bodega = datosEntregado[i].BODEGA;
                          codigos.push(item);
                        }
                        else{
                          var item = {};
                          codigoUo += ',' + datosEntregado[i].CODUO.toString();
                          item.codmat = datosEntregado[i].CODUO;
                          item.codin = datosEntregado[i].CODIGO_INTERNO;
                          item.codmand = datosEntregado[i].CODIGO_CLIENTE;
                          item.desc = datosEntregado[i].UNIDAD_OBRA;
                          item.cant = datosEntregado[i].CANUOCUB;
                          item.folcor = datosEntregado[i].FOLIO_COORD;
                          item.idOtCub = datosEntregado[i].IDOBRA_OT_CUBICACION;
                          item.um = datosEntregado[i].UM;
                          item.bodega = datosEntregado[i].BODEGA;
                          codigos.push(item);
                        }
                      }
                      $("#guiaDespachoEstadoEntregadoSolicitudMateria").val("");
                      $("#rutPersEntregaEstadoEntregadoSolicitudMateria").val("");
                      $("#nombrePersEntregaEstadoEntregadoSolicitudMateria").val("");
                      var toPost1 = JSON.stringify(codigos);
                      $("#idCubEstadoEntregadoSolicitudMaterial").val(toPost1);
                      $("#folioEstadoEntregadoSolicitudMaterial").val(folio);
                      $("#tipoEstadoEntregadoSolicitudMaterial").val(tipo);
                      $("#detalleEstadoEntregadoSolicitudMaterial").html('Códigos de unidad de obra: ' + codigoUo);
                      $("#guiaDespachoEstadoEntregadoSolicitudMateria").removeClass("is-invalid");
                      $("#rutPersEntregaEstadoEntregadoSolicitudMateria").removeClass("is-invalid");
                      $("#nombrePersEntregaEstadoEntregadoSolicitudMateria").removeClass("is-invalid");

                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                        $("#modalEstadoEntregadoSolicitudMaterial").modal('show');
                      },500);
                    }else{
                      alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Materiales fuera de estado");
                    }
                  }else{
                    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar materiales con el mismo estado");
                  }
                }
              }else{
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
              }
            }
          },
          {
            text: 'Subir PDF y Guia entrega',
            id:'subirPdfGuiaSolicitudMaterial',
            handler: async function(){
              var datosSubirPdfs = this.getSelection();
              if(datosSubirPdfs.length > 0){
                var idEntrega = new Array();
                for(var i=0; i< datosSubirPdfs.length; i++){
                  idEntrega.push(datosSubirPdfs[i].NUMERO_PDF.toString());
                }
                var newIdEntrega = [...new Set(idEntrega)];
                if(newIdEntrega.length == 1){
                  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                  $('#modalAlertasSplash').modal('show');
                  var codigoUo = '';
                  for(var i = 0; i < datosSubirPdfs.length; i++){
                    if(i == 0){
                      var item = {};
                      codigoUo += datosSubirPdfs[i].CODUO.toString();
                    }
                    else{
                      var item = {};
                      codigoUo += ',' + datosSubirPdfs[i].CODUO.toString();
                    }
                  }
                  $("#idEntregaSubirPdfGuiaSolicitudMaterial").val(datosSubirPdfs[0].NUMERO_PDF.toString());
                  $("#folioSubirPdfGuiaSolicitudMaterial").val(folio);
                  $("#tipoSubirPdfGuiaSolicitudMaterial").val(tipo);
                  $("#tituloSubirPdfGuiaSolicitudMaterial").html('Códigos de unidad de obra: ' + codigoUo);

                  $("#inputPdfEntregaMaterial").val('');
                  $("#inputPdfEntregaMaterial").removeClass("is-invalid");
                  $("#inputPdfGuiaDespachoEntregaMaterial").val('');
                  $("#inputPdfGuiaDespachoEntregaMaterial").removeClass("is-invalid");

                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                    $("#modalSubirPdfGuiaSolicitudMaterial").modal('show');
                  },500);
                }else{
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar elementos con el mismo folio de entrega");
                }
              }else{
                  alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
              }
            }
          },
        ],
        events: [
          {
            update: function(grid){
              if(tipo === 'Anticipo' ){
                $("#estadoEntregadoSolicitudMaterial").hide();
                $("#subirPdfGuiaSolicitudMaterial").hide();
              }else if(tipo == 'Pedido'){
                $("#solicitarClienteSolicitudMaterial").hide();
                $("#estadoPreparadoSolicitudMaterial").hide();
                grid.hideColumn(['FOLIO_SOL','FOLIO_COORD']);
              }
              var h = $(window).height() - 300;
              $("#bodyAgregarMaterial").css("height",h);
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalDetalleAgregarMaterial').modal('show');
              },500);
            },
          },
          {
            cellclick: function(grid, o){
              var datosFila = this.getData();
              var datosSel = this.getSelection();
              for(var i = 0; i < datosFila.length; i++){
                for(var j = 0; j < datosSel.length; j++){
                  if(datosSel[j].id === datosFila[i].id){
                    datosSel[j].lineaTabla = i;
                  }
                }
              }
              var ms = 0;
              for(var i = 0; i < datosSel.length; i++){
                if(datosSel[i].ESTADO === 'Entregadoo'){
                  this.deSelectRow(datosSel[i].lineaTabla);
                  ms++;
                }
              }
              if(ms > 0){
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Seleccionó un material ya entregado");
              }
            }
          }
        ],
        columns: [
          {
            type: 'select',
            locked: true
          },
          {
            resizable: true,
            title: 'Estado',
            index: 'ESTADO',
            width: 100,
          },
          {
            resizable: true,
            title: 'Folio Mandante',
            index: 'FOLIO_SOL',
            width: 120,
          },
          {
            resizable: true,
            title: 'Folio Coord.',
            index: 'FOLIO_COORD',
            width: 100,
          },
          {
            type: 'number',
            resizable: true,
            title: 'Corr',
            index: 'CORR',
            width: 80,
          },
          {
            title: 'Especialidad',
            resizable: true,
            width: 140,
            index: 'ESPECIALIDAD',
          },
          {
            title: 'Cod. UO.',
            resizable: true,
            draggable: true,
            width: 70,
            index: 'CODUO',
          },
          {
            title: 'Unidad de obra',
            resizable: true,
            draggable: true,
            width: 360,
            index: 'UNIDAD_OBRA',
          },
          {
            title: '# UO.',
            resizable: true,
            draggable: true,
            index: 'CANUOCUB',
          },
          {
            title: 'Valor Uo.',
            type: 'currency',
            resizable: true,
            draggable: true,
            currency: Fancy.currency.USD,
            index: 'VALOR_UO',
          },
          {
            title: 'Total Uo.',
            type: 'currency',
            resizable: true,
            draggable: true,
            currency: Fancy.currency.USD,
            index: 'TOTAL_UO',
          },
          {
            title: 'Provee',
            resizable: true,
            draggable: true,
            index: 'PROVEE',
          },
          {
            title: 'SIMA / SAP (Cliente)',
            resizable: true,
            draggable: true,
            index: 'CODIGO_CLIENTE',
            width: 250,
          },
          {
            title: 'Cód1 / Cód2 / Cód3 (Interno)',
            resizable: true,
            draggable: true,
            index: 'CODIGO_INTERNO',
            width: 250,
          },
          {
            title: 'PDF Entrega',
            resizable: true,
            draggable: true,
            index: 'PDF_ENTREGA',
            width: 100,
          },
          {
            title: 'N° Doc. Entrega',
            resizable: true,
            draggable: true,
            index: 'NUMERO_PDF',
            width: 100,
          },
          {
            title: 'Guia de despacho',
            resizable: true,
            draggable: true,
            index: 'PDF_GUIA_DESPACHO',
            width: 140,
          },
          {
            title: 'N° Guía Desp.',
            resizable: true,
            draggable: true,
            index: 'NUMERO_GUIA',
            width: 100,
          }
        ],
    })
  },500);
}

$("#guardarSolicitarClienteSolicitudMaterial").unbind('click').click(async function(){
  var datos = $("#idCubSolicitarClienteSolicitudMaterial").val();
  var folio = $("#folioSolicitarClienteSolicitudMaterial").val();
  var tipo = $("#tipoSolicitarClienteSolicitudMaterial").val();
  $("#modalSolicitarClienteSolicitudMaterial").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url: "controller/ingresaMaterialesGestion.php",
    type: 'POST',
    data: {
      "folio" : folio
    },
    success:  async function (response) {
      var p2 = jQuery.parseJSON(response);
      await $.ajax({
        url: "controller/solicitarClienteSolicitudMaterial.php",
        type:"POST",
        data:{
          "datos" : datos,
          "folio" : folio,
          "folioMatGestion": Number(p2[0]['LAST_INSERT_ID()']),
        },
        success: function (res2){
          var p = res2.split(",");
          if(res2.localeCompare("Sin datos")!= 0 && res2 != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              solicitudMateriales(folio,tipo);
              var table = $('#tablaListadoSolicitudMaterialesObra').DataTable();
              table.ajax.reload();
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Solicitud enviado a cliente correctamente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al enviar solicitud a cliente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al enviar solicitud a cliente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
      });
    }
  });
});

$("#pedirMaterialCaratulaObras").unbind('click').click( async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  $("#divTablaPedirMatObrasOrdenEjec").empty();
  var table = $('#tablaCaratulaObras').DataTable();
  var idOt = $.map(table.rows('.selected').data(), function (item) {
      return item.OT;
  });
  var folio = $.map(table.rows('.selected').data(), function (item) {
      return item.IDOBRA;
  });
  var oecf = $.map(table.rows('.selected').data(), function (item) {
    return item.NOMBREOE;
  });
  // var codCub = $.map(table.rows('.selected').data(), function (item) {
  //   return item.CUBICACION;
  // });
  // var agencia = $.map(table.rows('.selected').data(), function (item) {
  //   return item.AGENCIA;
  // });

  $("#folioObraPedirMatObrasOrdenEjec").html('Orden de trabajo: ' + idOt);
  $("#oePedirMatObrasOrdenEjec").html('Orden de ejecución: ' + oecf);
  //$("#codigoCubPedirMatObrasOe").html('Código de cubicación: ' + codCub);
  pedirMaterialesDesdeOe(idOt[0],folio[0]);
});

function pedirMaterialesDesdeOe(idOt,folio){
  $("#divTablaPedirMatObrasOrdenEjec").empty();
  var largo = Math.trunc($(window).height() - 350);
  setTimeout(function(){
    FancyGrid.LICENSE = ['f3e1cd90dfb49ba1b9d16d7c5abe7260'];
    new FancyGrid({
        renderTo: 'divTablaPedirMatObrasOrdenEjec',
        scrollable: true,
        multiSort: true,
        doubleHorizontalScroll: true,
        selModel: {
          type: 'rows',
          checkOnly: true
        },
        theme: 'bootstrap',
        height: largo,
        subSearch: true,
        data: {
          proxy: {
            url: 'controller/datosPeticionMatObrasOt.php',
            method: 'GET',
            params: {
              idOt: idOt,
            }
          },
          fields: ['CORR', 'ESPECIALIDAD', 'CODUO', 'UNIDAD_OBRA', 'CANUOCUB', 'VALOR_UO', 'TOTAL_UO', 'PROVEE', 'IDOBRA_OT_CUBICACION', 'ESTADO_SOL_MAT', 'CODIGO_CLIENTE', 'CODIGO_INTERNO','FOLIO_SOLICITUD']
        },
        trackOver: true,
        defaults: {
          sortable: true,
          align: 'left',
          cellAlign: 'left',
          menu: true
        },
        cellHeight: 45,
        columns: [
          {
            type: 'select',
            locked: true
          },
          {
            resizable: true,
            title: 'Pedido',
            index: 'ESTADO_SOL_MAT',
            width: 100,
          },
          {
            resizable: true,
            title: 'Folio Ped.',
            index: 'FOLIO_SOLICITUD',
            width: 100,
          },
          {
            type: 'number',
            resizable: true,
            title: 'Corr',
            index: 'CORR',
            width: 80,
          },
          {
            title: 'Especialidad',
            resizable: true,
            width: 140,
            index: 'ESPECIALIDAD',
          },
          {
            title: 'Cod. UO.',
            resizable: true,
            draggable: true,
            width: 70,
            index: 'CODUO',
          },
          {
            title: 'Unidad de obra',
            resizable: true,
            draggable: true,
            width: 360,
            index: 'UNIDAD_OBRA',
          },
          {
            title: '# UO.',
            resizable: true,
            draggable: true,
            index: 'CANUOCUB',
          },
          {
            title: 'Valor Uo.',
            type: 'currency',
            resizable: true,
            draggable: true,
            currency: Fancy.currency.USD,
            index: 'VALOR_UO',
          },
          {
            title: 'Total Uo.',
            type: 'currency',
            resizable: true,
            draggable: true,
            currency: Fancy.currency.USD,
            index: 'TOTAL_UO',
          },
          {
            title: 'Provee',
            resizable: true,
            draggable: true,

            index: 'PROVEE',
          },
          {
            title: 'SIMA / SAP (Cliente)',
            resizable: true,
            draggable: true,
            index: 'CODIGO_CLIENTE',
            width: 250,
          },
          {
            title: 'Cód SAP / Cód2 / Cód3 (Interno)',
            resizable: true,
            draggable: true,
            index: 'CODIGO_INTERNO',
            width: 250,
          }
        ],
        exporter: true,
        tbar: [
          {
            type: 'search',
            width: 200,
            emptyText: 'Buscar'
          },
          {
            text: 'Excel',
            handler: function() {
              this.expandAll();
              this.exportToExcel();
              this.collapseAll();
            }
          },
          {
            text: 'Pedir Mat.',
            id: 'enviarGuardarPeticionMatObrasOrdenEjec',
            handler: async function() {
              var datosCub = this.getSelection();
              if(datosCub.length > 0){
                $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
                $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
                $('#modalAlertasSplash').modal('show');
                var codigoUo = '';
                var idObraCub = new Array();
                for(var i = 0; i < datosCub.length; i++){
                  if(i == 0){
                    codigoUo += datosCub[i].CODUO.toString();
                    var item = {};
                    item.id= datosCub[i].IDOBRA_OT_CUBICACION;
                    idObraCub.push(item);
                  }
                  else{
                    codigoUo += ',' + datosCub[i].CODUO.toString();
                    var item = {};
                    item.id = datosCub[i].IDOBRA_OT_CUBICACION;
                    idObraCub.push(item);
                  }
                }
                var toPost1 = JSON.stringify(idObraCub);
                $("#idCubGuardarPeticionMatObrasOrdenEjec").val(toPost1);
                $("#idOtGuardarPeticionMatObrasOrdenEjec").val(idOt);
                $("#detalleGuardarPeticionMatObrasOrdenEjec").html('Códigos de unidad de obra: ' + codigoUo);
                $("#detalle2GuardarPeticionMatObrasOrdenEjec").html('Folio OT: ' + idOt);
                $("#idObraGuardarPeticionMatObrasOrdenEjec").val(folio);
                $("#idTablaGuardarPeticionMatObrasOrdenEjec").val('tablaCaratulaObrasCubicacion');
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  $("#modalGuardarPeticionMatObrasOrdenEjec").modal('show');
                },500);
              }
              else{
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe seleccionar una fila para procesar los datos");
              }
            }
          }
        ],
        events: [
          {
            update: function(grid){
              var h = $(window).height() - 300;
              $("#bodyPedirMatObrasOts").css("height",h);
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalPedirMatObrasOrdenEjec').modal('show');
              },500);
            }
          },
          {
            cellclick: function(grid, o){
              var datosFila = this.getData();
              var datosSel = this.getSelection();
              for(var i = 0; i < datosFila.length; i++){
                for(var j = 0; j < datosSel.length; j++){
                  if(datosSel[j].id === datosFila[i].id){
                    datosSel[j].lineaTabla = i;
                  }
                }
              }
              var ms = 0;
              for(var i = 0; i < datosSel.length; i++){
                if(datosSel[i].ESTADO_SOL_MAT === 'Pedido'){
                  this.deSelectRow(datosSel[i].lineaTabla);
                  ms++;
                }
              }
              if(ms > 0){
                alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Seleccionó un material ya pedido");
              }
            }
          }
        ],
    })
  },500);
}

$("#guardarPeticionMatObrasOrdenEjec").unbind('click').click(async function(){
  var datos = $("#idCubGuardarPeticionMatObrasOrdenEjec").val();
  var idOt = $("#idOtGuardarPeticionMatObrasOrdenEjec").val();
  var idTablaCub =  $("#idTablaGuardarPeticionMatObrasOrdenEjec").val();
  var folio =  $("#idObraGuardarPeticionMatObrasOrdenEjec").val();
  $("#modalGuardarPeticionMatObrasOrdenEjec").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url: "controller/pedirMaterialesObrasOt.php",
    type: 'POST',
    data: {
      "datos" : datos,
    },
    success:  async function (response) {
      var p2 = jQuery.parseJSON(response);
      await $.ajax({
        url: "controller/ingresaPedirMaterialesObrasOt.php",
        type:"POST",
        data:{
          "datos" : datos,
          "idSolMatPed": Number(p2[0]['LAST_INSERT_ID()']),
        },
        success: function (res2){
          var p = res2.split(",");
          if(res2.localeCompare("Sin datos")!= 0 && res2 != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              pedirMaterialesDesdeOe(idOt);
              detalleCub(folio,idTablaCub);
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Petición de materiales guardado correctamente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al pedir materiales");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al pedir materiales");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
      });
    }
  });
});

$("#contactoClienteZonaObra").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#correoIngresoContactoClienteZonasObra").removeClass("is-invalid");
  $("#telefonoIngresoContactoClienteZonasObra").removeClass("is-invalid");
  var table = $('#tablaMantenedorZonasObra').DataTable();
  var folio = $.map(table.rows('.selected').data(), function (item) {
      return item.FOLIO;
  });
  var correo = $.map(table.rows('.selected').data(), function (item) {
    return item.CORREO;
  });
  var telefono = $.map(table.rows('.selected').data(), function (item) {
    return item.TELEFONO;
  });
  var servicio = $.map(table.rows('.selected').data(), function (item) {
    return item.SERVICIO;
  });
  var cliente = $.map(table.rows('.selected').data(), function (item) {
    return item.CLIENTE;
  });
  var actividad = $.map(table.rows('.selected').data(), function (item) {
    return item.ACTIVIDAD;
  });
  var comuna = $.map(table.rows('.selected').data(), function (item) {
    return item.COMUNA;
  });

  $("#correoIngresoContactoClienteZonasObra").val(correo);
  $("#telefonoIngresoContactoClienteZonasObra").val(telefono);

  $("#folioIngresoContactoClienteZonasObra").html('Folio: ' + folio);
  $("#proyectoIngresoContactoClienteZonasObra").html('Proyecto: ' + servicio + ' / ' + cliente + ' / ' + actividad);
  $("#comunaIngresoContactoClienteZonasObra").html('Comuna: ' + comuna);

  $("#folioIngresoContactoClienteZonasObra2").val(folio[0]);
  setTimeout(function(){
    $('#modalAlertasSplash').modal('hide');
    $("#modalIngresoContactoClienteZonasObra").modal("show");
  },500);
});

$("#guardarIngresoContactoClienteZonasObra").unbind('click').click(function(){
  if($("#correoIngresoContactoClienteZonasObra").val().length == 0 || $("#telefonoIngresoContactoClienteZonasObra").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe completar todos los campos");
    if ($("#correoIngresoContactoClienteZonasObra").val().length == 0){
      $("#correoIngresoContactoClienteZonasObra").addClass("is-invalid");
    }
    if ($("#telefonoIngresoContactoClienteZonasObra").val().length == 0){
      $("#telefonoIngresoContactoClienteZonasObra").addClass("is-invalid");
    }
  }
  else {
    parametros = {
      "folio": $("#folioIngresoContactoClienteZonasObra2").val(),
      "correo": $("#correoIngresoContactoClienteZonasObra").val(),
      "telefono": $("#telefonoIngresoContactoClienteZonasObra").val(),
    }
    $("#modalIngresoContactoClienteZonasObra").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $.ajax({
      url: "controller/ingresaContactoClienteZonaObra.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            var table = $('#tablaMantenedorZonasObra').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Contacto cliente ingresado correctamente");
            $("#eliminarZonaObra").attr("disabled","disabled");
            $("#activarZonaObra").attr("disabled","disabled");
            $("#asignarPersonalZonaObra").attr("disabled","disabled");
            $("#contactoClienteZonaObra").attr("disabled","disabled");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar contacto cliente, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar contacto cliente, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

async function cargaMenuFull(p){
  await $.ajax({
    url:   'controller/datosAreasComunesPadresSolo.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          var padre = "<div id='" + p2.aaData[i].PADRE + "' style='display:none;' class='contenedor-logos'><div class='logo'><span class='imgMenu " + p2.aaData[i].ICONOPADRE + "'></span></div><p class='title-menu'>" + p2.aaData[i].TEXTOPADRE + "</p></div>";

          $("#DivPrincipalMenu").append(padre);

          if(p2.aaData[i].PADRE === "liCuenta"){
            $("#" + p2.aaData[i].PADRE).append("<div class='sub-menu' style='display:none; color: white; font-size: 12px; margin-left: 15px; margin-bottom: 8px;'><div id='imgPerfil' class='div-sub-menu' style='margin-left: 5%; border: 2px solid black; width: 144px; min-width: 144px; max-width: 144px; 'margin-bottom: 10pt;'></div><div id='nombrePerfil' class='div-sub-menu' style='margin-left: 5%; font-weight: bold;'></div></div>");
            setTimeout(function(){
              $.ajax({
                url:   'controller/cargarImgPerfilSession.php',
                type:  'get',
                success: function (responseImg) {
                  if(responseImg == "Sin datos"){
                    $("#imgPerfil").append("<img style='width: 140px; min-width: 140px; max-width: 140px;' src='view/img/no_foto.jpg'>");
                  }
                  else{
                    $("#imgPerfil").append("<img style='width: 140px; min-width: 140px; max-width: 140px;' src='controller/cargarImgPerfilSession.php'>");
                  }
                }
              });
            },500);
          }
          // $('div[id $=' + p2.aaData[i].PADRE + ']').show();
          // $('li[id $=' + p2.aaData[i].NOMBRE + ']').show();
          // $('div[id $=' + p2.aaData[i].PADRE + ']').css("display","block");
          // $('li[id $=' + p2.aaData[i].NOMBRE + ']').css("display","block");
        }
        var atras = "<div id='regresarMenu' style='display: none;' class='contenedor-logos'><div class='logo'><span class='imgMenu fas fa-arrow-circle-left'></span></div></div>";

        $("#DivPrincipalMenu").append(atras);

        $("#regresarMenu").hover(
          function() {
            $("#regresarMenu").addClass("blink_me");
          }, function() {
            $("#regresarMenu").removeClass("blink_me");
          }
        );
      }
    }
  });
  await $.ajax({
    url:   'controller/datosAreasComunesPadres.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        for(var i = 0; i < p2.aaData.length; i++){
          var insert = 0;
          if(p2.aaData[i].TEXTO === "Cambiar contraseña"){
              var hijo = "<div class='sub-menu' style='display: none; color: white;'><ul><li id='" + p2.aaData[i].NOMBRE + "' style='display: none;'><div class='div-sub-menu'><i class='imgMenu-sub " + p2.aaData[i].ICONO + "'></i><a href='" + p2.aaData[i].RUTA + "' class='title-menu-sub'>" + p2.aaData[i].TEXTO + "</a></div></li></ul></div>";
              insert = 1;
          }
          else if(p2.aaData[i].TEXTO === "Firma Documentos"){
            if(p.aaData['FIRMA_2FA'] === "1"){
                var hijo = "<div class='sub-menu' style='display: none; color: white;'><ul><li id='" + p2.aaData[i].NOMBRE + "' style='display: none;'><div class='div-sub-menu'><i class='imgMenu-sub " + p2.aaData[i].ICONO + "'></i><a href='" + p2.aaData[i].RUTA + "' class='title-menu-sub'>" + p2.aaData[i].TEXTO + "</a></div></li></ul></div>";
                insert = 1;
            }
            else{
              insert = 0;
            }
          }
          else{
            var hijo = "<div class='sub-menu' style='display: none; color: white;'><ul><li id='" + p2.aaData[i].NOMBRE + "' style='display: none;'><div class='div-sub-menu'><i class='imgMenu-sub " + p2.aaData[i].ICONO + "'></i><a href='" + p2.aaData[i].RUTA + "' class='title-menu-sub'>" + p2.aaData[i].TEXTO + "</a></div></li></ul></div>";
            insert = 1;
          }

          if(insert === 1){
            $("#" + p2.aaData[i].PADRE).append(hijo);
          }
        }
      }
    }
  });

  n = p.aaData['NOMBRE'].split(" ");
  if(n.length <= 3){
    $("#nombrePerfil").html(p.aaData['NOMBRE']);
  }
  else{
    $("#nombrePerfil").html(n[0] + ' ' + n[2] + ' ' + n[3]);
  }

  $("#menu-lateral").unbind('click').hover(function(){

  },
  function(){
    $("div.sub-menu").parent().css("height", "45px");
    $("div.sub-menu").parent().css("background","rgba(30, 0, 0, 0.0)");
    $("div.sub-menu").hide();
    $("div.sub-menu").parent().find("p").css("color", "white");
  });

  $(".title-menu-sub").unbind('click').hover(function(){
    $(this).css("color", "yellow");
  },
  function(){
    $(this).css("color", "white");
  });

  $(".contenedor-logos").unbind('click').hover(function(){
    $(this).css({'cursor': 'pointer'});
  });

  $(".contenedor-logos").unbind('click').click(function(){
    var a = $(this).find("p").css("color");

    //Cierra todo
    $("div.sub-menu").parent().css("height", "45px");
    $("div.sub-menu").parent().css("background","rgba(30, 0, 0, 0.0)");
    $("div.sub-menu").hide();
    $("div.sub-menu").parent().find("p").css("color", "white");

    $("#DivPrincipalMenu").children().css("display","none");

    $(this).css("display","block");

    $("#regresarMenu").css("display","block");

    if(a !== "rgb(255, 255, 0)"){
      //Abre el clickado
      $(this).find("p").css("color", "yellow");
      $(this).find("div.sub-menu").show();
      var a = $(this).find('li[style*="block"]').length;
      if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        if($(this).attr("id") == 'liCuenta'){
          a = (a+1)*28 + 30 + 150;
        }
        else{
          a = a*28 + 30;
        }
      }
      else{
        if($(this).attr("id") == 'liCuenta'){
          a = (a+1)*25 + 30 + 150;
        }
        else{
          a = a*25 + 30;
        }
      }
      $(this).css("height", a + "pt");
      $(this).css("background-color","#004379");
    }
    else{
      $("#DivPrincipalMenu").children().css("display","block");
    }
  });

  $("#regresarMenu").unbind("click").click(function(){
    $("div.sub-menu").parent().css("height", "45px");
    $("div.sub-menu").parent().css("background","rgba(30, 0, 0, 0.0)");
    $("div.sub-menu").hide();
    $("div.sub-menu").parent().find("p").css("color", "white");
    $("#DivPrincipalMenu").children().css("display","block");
    $("#regresarMenu").css("display","none");
  });
}

$("#familiaComprasGestion").unbind("click").change(function(){
  var table = $("#tablaMantenedorGestion").DataTable();
  var mano = $("#familiaComprasGestion").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('2').search(mano).draw();
});

$("#segmentoComprasGestion").unbind("click").change(function(){
  var table = $("#tablaMantenedorGestion").DataTable();
  var mano = $("#segmentoComprasGestion").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('3').search(mano).draw();
});

$("#claveComprasGestion").unbind("click").change(function(){
  var table = $("#tablaMantenedorGestion").DataTable();
  var mano = $("#claveComprasGestion").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('4').search(mano).draw();
});

$("#tipoComprasGestion").unbind("click").change(function(){
  var table = $("#tablaMantenedorGestion").DataTable();
  var mano = $("#tipoComprasGestion").val();
  if(mano == "Todos"){
    mano = '';
  }
  table.rows('').deselect();
  table.columns('5').search(mano).draw();
});

$("#guardarEstadoPreparacionSolicitudMaterial").unbind('click').click(async function(){
  var datos = $("#idCubEstadoPreparacionSolicitudMaterial").val();
  var folio = $("#folioEstadoPreparacionSolicitudMaterial").val();
  var tipo = $("#tipoEstadoPreparacionSolicitudMaterial").val();
  var estado = $("#estadoPreparacionSolicitudMaterial").val();
  var folioCoord = $("#folioCoordEstadoPreparacionSolicitudMaterial").val();
  var inputsBodega = $('div.obtenerBodegasEnPreparacion').find('input');
  var datosBodega = new Array();
  for(var i=0;i<inputsBodega.length;i++){
    var item = {};
    item.id = inputsBodega[i].id;
    item.bodega = $(inputsBodega[i]).val();
    datosBodega.push(item);
  }
  var datosController = JSON.stringify(datosBodega);

  if(estado === 'Cliente' && $("#folioCoordEstadoPreparacionSolicitudMaterial").val().length == 0){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar el folio coordinador");
    $("#folioCoordEstadoPreparacionSolicitudMaterial").addClass("is-invalid");
  }else{
    $("#modalEstadoPreparacionSolicitudMaterial").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    await $.ajax({
      url: "controller/estadoEnPreparacionSolicitudMateriales.php",
      type: 'POST',
      data: {
        "datos" : datos,
        "folio" : folio,
        "tipo" : tipo,
        "folioCoord" : folioCoord,
        "datosController" : datosController,
      },
        success: function (res2){
          var p = res2.split(",");
          if(res2.localeCompare("Sin datos")!= 0 && res2 != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              solicitudMateriales(folio,tipo);
              var table = $('#tablaListadoSolicitudMaterialesObra').DataTable();
              table.ajax.reload();
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Materiales en estado de preparación guardado correctamente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cambiar de estado en los materiales");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cambiar de estado en los materiales");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
    });
  }
});

$("#folioCoordEstadoPreparacionSolicitudMaterial").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#guardarEstadoPreparadoSolicitudMaterial").unbind('click').click(async function(){
  var folio = $("#folioEstadoPreparadoSolicitudMaterial").val();
  var tipo = $("#tipoEstadoPreparadoSolicitudMaterial").val();
  var inputsBodega = $('div.obtenerBodegasPreparado').find('input');
  var datosBodega = new Array();
  for(var i=0;i<inputsBodega.length;i++){
    var item = {};
    item.id = inputsBodega[i].id;
    item.bodega = $(inputsBodega[i]).val();
    datosBodega.push(item);
  }
  var datosController = JSON.stringify(datosBodega);
  $("#modalEstadoPreparadoSolicitudMaterial").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url: "controller/estadoPreparadoSolicitudMateriales.php",
    type: 'POST',
    data: {
      "datos" : datosController,
      "folio" : folio,
    },
      success: function (res2){
        var p = res2.split(",");
        if(res2.localeCompare("Sin datos")!= 0 && res2 != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            solicitudMateriales(folio,tipo);
            var table = $('#tablaListadoSolicitudMaterialesObra').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Materiales en estado preparado guardado correctamente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cambiar de estado en los materiales");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cambiar de estado en los materiales");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
  });

});

$("#guardarEstadoBodegaSolicitudMaterial").unbind('click').click(async function(){
  var folio = $("#folioEstadoBodegaSolicitudMaterial").val();
  var tipo = $("#tipoEstadoBodegaSolicitudMaterial").val();
  var inputsBodega = $('div.obtenerBodegasEnBodega').find('input');
  var datosBodega = new Array();
  for(var i=0;i<inputsBodega.length;i++){
    var item = {};
    item.id = inputsBodega[i].id;
    item.bodega = $(inputsBodega[i]).val();
    datosBodega.push(item);
  }
  var datosController = JSON.stringify(datosBodega);
  $("#modalEstadoBodegaSolicitudMaterial").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  await $.ajax({
    url: "controller/estadoEnBodegaSolicitudMateriales.php",
    type: 'POST',
    data: {
      "datos" : datosController,
      "folio" : folio,
      "tipo" : tipo,
    },
      success: function (res2){
        var p = res2.split(",");
        if(res2.localeCompare("Sin datos")!= 0 && res2 != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            solicitudMateriales(folio,tipo);
            var table = $('#tablaListadoSolicitudMaterialesObra').DataTable();
            table.ajax.reload();
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Materiales en bodega guardado correctamente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cambiar de estado en los materiales");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cambiar de estado en los materiales");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
  });

});

$("#guardarEstadoEntregadoSolicitudMaterial").unbind('click').click(async function(){
  var datos = $("#idCubEstadoEntregadoSolicitudMaterial").val();
  var folio = $("#folioEstadoEntregadoSolicitudMaterial").val();
  var tipo = $("#tipoEstadoEntregadoSolicitudMaterial").val();
  var guiaDespacho = $("#guiaDespachoEstadoEntregadoSolicitudMateria").val();
  var observ = $("#obserEstadoEntregadoSolicitudMateria").val();
  var rutPersEntrega = $("#rutPersEntregaEstadoEntregadoSolicitudMateria").val();
  var nombrePersEntrega = $("#nombrePersEntregaEstadoEntregadoSolicitudMateria").val();

  if($("#guiaDespachoEstadoEntregadoSolicitudMateria").val().length == 0 || $("#rutPersEntregaEstadoEntregadoSolicitudMateria").val().length == 0 || $("#nombrePersEntregaEstadoEntregadoSolicitudMateria").val().length == 0){
    alertasToast("Debe completar todos los campos");
    if ($("#guiaDespachoEstadoEntregadoSolicitudMateria").val().length == 0){
      $("#guiaDespachoEstadoEntregadoSolicitudMateria").addClass("is-invalid");
    }
    if ($("#rutPersEntregaEstadoEntregadoSolicitudMateria").val().length == 0){
      $("#rutPersEntregaEstadoEntregadoSolicitudMateria").addClass("is-invalid");
    }
    if ($("#nombrePersEntregaEstadoEntregadoSolicitudMateria").val().length == 0){
      $("#nombrePersEntregaEstadoEntregadoSolicitudMateria").addClass("is-invalid");
    }
  }else{
    $("#modalEstadoEntregadoSolicitudMaterial").modal("hide");
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    await $.ajax({
      url: "controller/generaPDF/estadoEntregadoSolicitudMateriales.php?idLoad=205",
      type: 'POST',
      data: {
        "datos" : datos,
        "guiaDespacho" : guiaDespacho,
        "observ" : observ,
        "folio" : folio,
        "rutPersEntrega" : rutPersEntrega,
        "nombrePersEntrega" : nombrePersEntrega,
        "url": window.location.toString().split("?")[0]
      },
        success: function (res2){
          window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/materiales' + res2, '_blank');
          var p = res2.split(",");
          if(res2.localeCompare("Sin datos")!= 0 && res2 != ""){
            if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
              solicitudMateriales(folio,tipo);
              var table = $('#tablaListadoSolicitudMaterialesObra').DataTable();
              table.ajax.reload();
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Materiales entregado correctamente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cambiar de estado en los materiales");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cambiar de estado en los materiales");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
    });
  }
});

$("#guiaDespachoEstadoEntregadoSolicitudMateria").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#rutPersEntregaEstadoEntregadoSolicitudMateria").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#nombrePersEntregaEstadoEntregadoSolicitudMateria").on('input', function(){
  $(this).removeClass("is-invalid");
});

async function pdf_Entrega_Mat(pdf){
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    window.open(window.location.toString().split("#/")[0].split('?')[0] + 'controller/repositorio/materiales/' + pdf, '_blank');
  }
}

$('#checkboxInputsBodegaPreparacion').on('change', function() {
  if ($('#checkboxInputsBodegaPreparacion').prop('checked')){
    var inputsBodega = $('div.obtenerBodegasEnPreparacion').find('input');
    var copyBodega = $(inputsBodega[0]).val();
    for(var i=1;i<inputsBodega.length;i++){
      $(inputsBodega[i]).val(copyBodega);
      $(inputsBodega[i]).attr('disabled','disabled');
    }
  }else{
    var inputsBodega = $('div.obtenerBodegasEnPreparacion').find('input');
    var copyBodega = $(inputsBodega[0]).val();
    for(var i=1;i<inputsBodega.length;i++){
      $(inputsBodega[i]).removeAttr('disabled');
    }
  }
});

$('#checkboxInputsBodegaPreparado').on('change', function() {
  if ($('#checkboxInputsBodegaPreparado').prop('checked')){
    var inputsBodega = $('div.obtenerBodegasPreparado').find('input');
    var copyBodega = $(inputsBodega[0]).val();
    for(var i=1;i<inputsBodega.length;i++){
      $(inputsBodega[i]).val(copyBodega);
      $(inputsBodega[i]).attr('disabled','disabled');
    }
  }else{
    var inputsBodega = $('div.obtenerBodegasPreparado').find('input');
    var copyBodega = $(inputsBodega[0]).val();
    for(var i=1;i<inputsBodega.length;i++){
      $(inputsBodega[i]).removeAttr('disabled');
    }
  }
});

$('#checkboxInputsBodegaBodega').on('change', function() {
  if ($('#checkboxInputsBodegaBodega').prop('checked')){
    var inputsBodega = $('div.obtenerBodegasEnBodega').find('input');
    var copyBodega = $(inputsBodega[0]).val();
    for(var i=1;i<inputsBodega.length;i++){
      $(inputsBodega[i]).val(copyBodega);
      $(inputsBodega[i]).attr('disabled','disabled');
    }
  }else{
    var inputsBodega = $('div.obtenerBodegasEnBodega').find('input');
    var copyBodega = $(inputsBodega[0]).val();
    for(var i=1;i<inputsBodega.length;i++){
      $(inputsBodega[i]).removeAttr('disabled');
    }
  }
});

$("#pdfCargaEntregaMaterial" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfEntregaMaterial").val(file);
  $("#inputPdfEntregaMaterial").removeClass("is-invalid");
});

$("#pdfGuiaDespachoEntregaMaterial" ).on('change', function(e){
  var file = e.target.files[0].name;
  $("#inputPdfGuiaDespachoEntregaMaterial").val(file);
  $("#inputPdfGuiaDespachoEntregaMaterial").removeClass("is-invalid");
});

$("#guardarSubirPdfGuiaSolicitudMaterial").unbind("click").click( async function(){
  if($("#inputPdfEntregaMaterial").val().length == 0 || $("#inputPdfGuiaDespachoEntregaMaterial").val().length == 0){
    alertasToast("Debe completar todos los campos");
    if ($("#inputPdfEntregaMaterial").val().length == 0){
      $("#inputPdfEntregaMaterial").addClass("is-invalid");
    }
    if ($("#inputPdfGuiaDespachoEntregaMaterial").val().length == 0){
      $("#inputPdfGuiaDespachoEntregaMaterial").addClass("is-invalid");
    }
  }else{
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $("#modalSubirPdfGuiaSolicitudMaterial").modal("hide");
    $('#modalAlertasSplash').modal('show');
    var folio = $("#folioSubirPdfGuiaSolicitudMaterial").val();
    var tipo = $("#tipoSubirPdfGuiaSolicitudMaterial").val();
    var formdata = new FormData();
    formdata.append('idEntrega',$("#idEntregaSubirPdfGuiaSolicitudMaterial").val());
    formdata.append('pdfEntrega',$("#pdfCargaEntregaMaterial")[0].files[0]);
    formdata.append('pdfGuiaEntrega',$("#pdfGuiaDespachoEntregaMaterial")[0].files[0]);
    $.ajax({
      url: "controller/ingresaPdfsSolicitudMaterial.php",
      type: 'POST',
      data: formdata,
      cache: false,
      contentType: false,
      processData: false,
      success:  function (response) {
        var p = response.split(",");
        if(response.localeCompare("Sin datos")!= 0 && response != ""){
          if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
            solicitudMateriales(folio,tipo);
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Pdf cargado correctamente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar Pdf, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar Pdf, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#copecHistorialTarjetaCombustible").unbind("click").click(async function(){
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalSubirPdfGuiaSolicitudMaterial").modal("hide");
  $('#modalAlertasSplash').modal('show');
  var largo = Math.trunc(($(window).height() - ($(window).height()/100)*50)/30);
  var table = $("#tablaTarjetaCombustible").DataTable()
  var datos = table.rows('.selected').data();

  const fecha = new Date();

  var parametros = {
    "mes": fecha.getMonth() + 1,
    "ano": fecha.getFullYear(),
    "tarjeta": datos[0].NUMERO.substring(0,8)
  }
  await $('#tablaHistorialTarjetaCombustible').DataTable({
    ajax: {
        url: "controller/datosConsumoTarjeta.php",
        type: 'POST',
        data: parametros,
    },
    columns: [
        { data: 'S'},
        { data: 'FECHA' },
        { data: 'HORA' },
        { data: 'PATENTE' },
        { data: 'COMUNA' },
        { data: 'DIRECCION' },
        { data: 'COMPROBANTE' },
        { data: 'RUT' },
        { data: 'PRECIO' },
        { data: 'VOLUMEN' },
        { data: 'TOTAL' }
    ],
    //responsive: true,
    buttons: [
      {
        extend: 'excel',
        title: null,
        text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
      }
    ],
    "columnDefs": [
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      },
      {
        "width": "5px",
        "targets": 0
      }
    ],
    "select": {
        style: 'single'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    // "order": [[ 3, "asc" ]],
    "info":     true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
      "zeroRecords": "No hay datos disponibles",
      "info": "Registro _START_ de _END_ de _TOTAL_",
      "infoEmpty": "No hay datos disponibles",
      "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)"
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": async function( settings, json){
      await $('#tablaHistorialTarjetaCombustibleAbono').DataTable({
        ajax: {
            url: "controller/datosAbonosTarjeta.php",
            type: 'POST',
            data: parametros,
        },
        columns: [
            { data: 'S'},
            { data: 'FECHA' },
            { data: 'HORA' },
            { data: 'PATENTE' },
            { data: 'COMPROBANTE' },
            { data: 'TIPO' },
            { data: 'MONTO' },
            { data: 'USUARIO_CARGA' }
        ],
        //responsive: true,
        buttons: [
          {
            extend: 'excel',
            title: null,
            text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
          }
        ],
        "columnDefs": [
          {
            "orderable": false,
            "className": 'select-checkbox',
            "targets": [ 0 ]
          },
          {
            "width": "5px",
            "targets": 0
          }
        ],
        "select": {
            style: 'single'
        },
        "scrollX": true,
        "paging": true,
        "ordering": true,
        "scrollCollapse": true,
        // "order": [[ 3, "asc" ]],
        "info":     true,
        "lengthMenu": [[largo], [largo]],
        "dom": 'Bfrtip',
        "language": {
          "zeroRecords": "No hay datos disponibles",
          "info": "Registro _START_ de _END_ de _TOTAL_",
          "infoEmpty": "No hay datos disponibles",
          "paginate": {
              "previous": "Anterior",
              "next": "Siguiente"
            },
            "search": "Buscar: ",
            "select": {
                "rows": "- %d registros seleccionados"
            },
            "infoFiltered": "(Filtrado de _MAX_ registros)"
        },
        "destroy": true,
        "autoWidth": false,
        "initComplete": async function( settings, json){
          await $.ajax({
              url:   'controller/datosPeriodosConsumoTarjeta.php',
              type:  'post',
              success: function (response2) {
                var p2 = jQuery.parseJSON(response2);
                if(p2.aaData.length !== 0){
                  var cuerpoPeriodo = '';
                  for(var i = 0; i < p2.aaData.length; i++){
                    cuerpoPeriodo += '<option value="' + p2.aaData[i].PERIODO + '">' + p2.aaData[i].PERIODO + '</option>';
                  }
                  $("#periodoHistorialTarjetaCombustible").html(cuerpoPeriodo);
                }
                else{
                  var cuerpoPeriodo= '<option selected value="0">Sin datos</option>';
                  $("#periodoHistorialTarjetaCombustible").html(cuerpoPeriodo);
                }
                if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                  $("#periodoHistorialTarjetaCombustible").select2({
                      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                  });
                }
                $("#modalHistorialTarjetaCombustible").modal("show");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                  setTimeout(function(){
                    $('#tablaHistorialTarjetaCombustible').DataTable().columns.adjust();
                    $('#tablaHistorialTarjetaCombustibleAbono').DataTable().columns.adjust();
                  },100);
                },500);
              }
            });
        }
      });
    }
  });
});

$("#sociedadMantenedorProveedores").unbind("click").change(function(){
  var table = $("#tablaMantenedorProveedores").DataTable();
  var tipoSol = $("#sociedadMantenedorProveedores").val();
  if(tipoSol == "Todos"){
    tipoSol = '';
  }
  table.rows('').deselect();
  table.columns('14').search(tipoSol).draw();
});

$("#tipoMantenedorProveedores").unbind("click").change(function(){
  var table = $("#tablaMantenedorProveedores").DataTable();
  var tipoSol = $("#tipoMantenedorProveedores").val();
  if(tipoSol == "Todos"){
    tipoSol = '';
  }
  table.rows('').deselect();
  table.columns('16').search(tipoSol).draw();
});

$("#comunaMantenedorProveedores").unbind("click").change(function(){
  var table = $("#tablaMantenedorProveedores").DataTable();
  var tipoSol = $("#comunaMantenedorProveedores").val();
  if(tipoSol == "Todos"){
    tipoSol = '';
  }
  table.rows('').deselect();
  table.columns('13').search(tipoSol).draw();
});

$("#actividadMantenedorProveedores").unbind("click").change(function(){
  var table = $("#tablaMantenedorProveedores").DataTable();
  var tipoSol = $("#actividadMantenedorProveedores").val();
  if(tipoSol == "Todos"){
    tipoSol = '';
  }
  table.rows('').deselect();
  table.columns('15').search(tipoSol).draw();
});

$("#avanceMantenedorProveedores").unbind("click").change(function(){
  var table = $("#tablaMantenedorProveedores").DataTable();
  var tipoSol = $("#avanceMantenedorProveedores").val();
  if(tipoSol == "Todos"){
    tipoSol = '';
  }
  table.rows('').deselect();
  table.columns('27').search(tipoSol).draw();
});

$("#compradorMantenedorProveedores").unbind("click").change(function(){
  var table = $("#tablaMantenedorProveedores").DataTable();
  var tipoSol = $("#compradorMantenedorProveedores").val();
  if(tipoSol == "Todos"){
    tipoSol = '';
  }
  table.rows('').deselect();
  table.columns('21').search(tipoSol).draw();
});

$("#evaluadorMantenedorProveedores").unbind("click").change(function(){
  var table = $("#tablaMantenedorProveedores").DataTable();
  var tipoSol = $("#evaluadorMantenedorProveedores").val();
  if(tipoSol == "Todos"){
    tipoSol = '';
  }
  table.rows('').deselect();
  table.columns('23').search(tipoSol).draw();
});

$("#regionMantenedorProveedores").unbind("click").change(function(){
  var table = $("#tablaMantenedorProveedores").DataTable();
  var tipoSol = $("#regionMantenedorProveedores").val();
  if(tipoSol == "Todos"){
    tipoSol = '';
  }
  table.rows('').deselect();
  table.columns('31').search(tipoSol).draw();
});

function ingresaCambioProveedor(p){
  var table2 = $('#tablaMantenedorProveedores').DataTable();
  for(var k = 0; k < p.aaData.length; k++){
    table2.rows.add([{
      'S': p.aaData[k].S,
      'IDCOMPRAS_PROVEEDOR': p.aaData[k].IDCOMPRAS_PROVEEDOR,
      'BP': p.aaData[k].BP,
      'RUT': p.aaData[k].RUT,
      'NOMBRE': p.aaData[k].NOMBRE,
      'CONTACTO': p.aaData[k].CONTACTO,
      'EMAIL_CONTACTO': p.aaData[k].EMAIL_CONTACTO,
      'FONO_CONTACTO': p.aaData[k].FONO_CONTACTO,
      'CONDICION_PAGO': p.aaData[k].CONDICION_PAGO,
      'CONTRATO': p.aaData[k].CONTRATO,
      'F_INICIO_CONTRATO': p.aaData[k].F_INICIO_CONTRATO,
      'F_FIN_CONTRATO': p.aaData[k].F_FIN_CONTRATO,
      'DIRECCION': p.aaData[k].DIRECCION,
      'COMUNA_MAPA': p.aaData[k].COMUNA_MAPA,
      'SOCIEDAD': p.aaData[k].SOCIEDAD,
      'ACTIVIDAD': p.aaData[k].ACTIVIDAD,
      'TIPO': p.aaData[k].TIPO,
      'ACREDITADO': p.aaData[k].ACREDITADO,
      'BLOQUEO_SAP': p.aaData[k].BLOQUEO_SAP,
      'MONEDA': p.aaData[k].MONEDA,
      'CRITICO': p.aaData[k].CRITICO,
      'COMPRADOR_ASIGNADO': p.aaData[k].COMPRADOR_ASIGNADO,
      'USUARIO_MODIFICA': p.aaData[k].USUARIO_MODIFICA,
      'USUARIO_EVALUADOR': p.aaData[k].USUARIO_EVALUADOR,
      'FECHA_INGRESO': p.aaData[k].FECHA_INGRESO,
      'FECHA_ACTUALIZACION': p.aaData[k].FECHA_ACTUALIZACION,
      'FECHA_SOLICITUD': p.aaData[k].FECHA_SOLICITUD,
      'AVANCE': p.aaData[k].AVANCE,
      'EVALUACION': p.aaData[k].EVALUACION,
      'EVALUADO': p.aaData[k].EVALUADO,
      'CATEGORIA': p.aaData[k].CATEGORIA,
      'REGION_MAPA': p.aaData[k].REGION_MAPA,
      'IDMONEDA_PAGO': p.aaData[k].IDMONEDA_PAGO,
      'IDSOCIEDADES': p.aaData[k].IDSOCIEDADES,
      'IDCOMUNAS': p.aaData[k].IDCOMUNAS,
      'IDTIPOS': p.aaData[k].IDTIPOS,
      'IDACTIVIDAD': p.aaData[k].IDACTIVIDAD
    }]).draw();
  }
}

$("input#rutMantProveedores_agr").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutMantProveedores_agr").val() !== ''){rutIngOrden
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutMantProveedores_agr").val("");
    $("#rutMantProveedores_agr").addClass("is-invalid");
  }
});

$("input#rutMantProveedores_upd").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutMantProveedores_upd").val() !== ''){rutIngOrden
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutMantProveedores_upd").val("");
    $("#rutMantProveedores_upd").addClass("is-invalid");
  }
});

$("input#rutMantProveedores_upd").on('input', function () {
    this.value = this.value.replace(/[^0-9,K,k]/g,'');
});

$("input#rutMantProveedores_agr").on('input', function () {
    this.value = this.value.replace(/[^0-9,K,k]/g,'');
});

$("#asignarCompMantenedorProveedores").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaMantenedorProveedores').DataTable();
  var datos = table.rows('.selected').data();
  var titulo = 'Listado BP Seleccionados:<br>';
  for(var j = 0; j < datos.length; j++){
    if(j%6 === 0 && j !== 0){
      if(j === 0){
        titulo += datos[j].BP;
      }
      else{
        titulo += ', ' + datos[j].BP;
      }
      titulo += '<br>';
    }
    else{
      if(j === 0){
        titulo += datos[j].BP;
      }
      else{
        titulo += ', ' + datos[j].BP;
      }
    }
  }

  $("#tituloAsignarCompradorProveedor").html(titulo);

  await $.ajax({
    url:   'controller/datosCompradoresAsignables.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoDes = '';
        for(var i = 0; i < p2.aaData.length; i++){
          cuerpoDes += '<option value="' + p2.aaData[i].RUT + '">' + p2.aaData[i].RUT + ' - ' + p2.aaData[i].NOMBRE + '</option>';
        }
        $("#compradorAsignarCompradorProveedor").html(cuerpoDes);


        if(!/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#compradorAsignarCompradorProveedor").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalAsignarCompradorProveedor").modal("show");
        },500);
      }
      else{
        if(!/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          $("#compradorAsignarCompradorProveedor").select2({
              theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
          });
        }
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalAsignarCompradorProveedor").modal("show");
        },500);
      }
    }
  });
});

$("#guardarAsignarCompradorProveedor").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalAsignarCompradorProveedor").modal("hide");
  var table = $('#tablaMantenedorProveedores').DataTable();
  var datos = table.rows('.selected').data();
  var pArray = '';

  for(var j = 0; j < datos.length; j++){
    if(j > 0){
      pArray += ',' + datos[j].IDCOMPRAS_PROVEEDOR;
    }
    else{
      pArray += datos[j].IDCOMPRAS_PROVEEDOR;
    }
  }

  var parametros = {
    'pArray': pArray,
    'comprador': $("#compradorAsignarCompradorProveedor").val()
  }

  $.ajax({
    url: "controller/actualizarCompradorProveedor.php",
    type: 'POST',
    data: parametros,
    success: async function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
          var table = $('#tablaMantenedorProveedores').DataTable();
          var rows = table.rows( '.selected' ).remove().draw();
          await ingresaCambioProveedor(p);

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Comprador asignado correctamente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#editarMantenedorProveedores").attr("disabled","disabled");
            $("#eliminarMantenedorProveedores").attr("disabled","disabled");
            $("#asignarCompMantenedorProveedores").attr("disabled","disabled");
          },500);
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al asignar comprador");
        setTimeout(function(){
          $("#modalAsignarCompradorProveedor").modal("show");
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#agregarMantenedorCargos").unbind("click").click(async function() {
  $('input:text').val('');
  $("#caracteristicasCargos_agr").val('');
  $("#valroRefMantCargos_agr").removeClass("is-invalid");
  $("#fechaIngresoMantCargos_agr").removeClass("is-invalid");
  $("#caracteristicasCargos_agr").removeClass("is-invalid");
  $("#serieMantCargos_agr").removeClass("is-invalid");

  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  await $.ajax({
    url: 'controller/datosCargosTITipo.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_TIPO;
        var label = p[i].TIPO;
        var flag = 0;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#tipoMantCargos_agr").html(options);
    }
  });

  var parametros = {
    "tipo": $("#tipoMantCargos_agr").val()
  }

  await $.ajax({
    url: 'controller/datosCargosTIMarca.php',
    type: 'POST',
    data: parametros,
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_MARCA;
        var label = p[i].MARCA;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#marcaMantCargos_agr").html(options);
    }
  });

  parametros["marca"] =  $('select[id="marcaMantCargos_agr"] option:selected').text();

  await $.ajax({
    url: 'controller/datosCargosTIModelo.php',
    type: 'POST',
    data: parametros,
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_MARCA;
        var label = p[i].MODELO;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#modeloMantCargos_agr").html(options);
    }
  });

  $("#fechaIngresoMantCargos_agr").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  var y = moment().format('YYYY-MM-DD');
  $("#fechaIngresoMantCargos_agr").attr("disabled","disabled");
  $("#fechaIngresoMantCargos_agr").val(y.toString());

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoMantCargos_agr").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#marcaMantCargos_agr').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#modeloMantCargos_agr').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#estadoMantCargos_agr').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var h = $(window).height() - 200;
  $("#bodyAgregarMantCargos").css("height",h);
  $("#modalAgregarMantCargos").modal('show');
  setTimeout(function() {
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#tipoMantCargos_agr").unbind("click").change(async function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $('#modalAgregarMantCargos').modal('hide');

  var parametros = {
    "tipo": $("#tipoMantCargos_agr").val()
  }

  await $.ajax({
    url: 'controller/datosCargosTIMarca.php',
    type: 'POST',
    data: parametros,
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_MARCA;
        var label = p[i].MARCA;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#marcaMantCargos_agr").html(options);
    }
  });

  parametros["marca"] = $('select[id="marcaMantCargos_agr"] option:selected').text();

  await $.ajax({
    url: 'controller/datosCargosTIModelo.php',
    type: 'POST',
    data: parametros,
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_MARCA;
        var label = p[i].MODELO;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#modeloMantCargos_agr").html(options);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#tipoMantCargos_agr').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#marcaMantCargos_agr').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#modeloMantCargos_agr').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#modalAgregarMantCargos").modal('show');
  setTimeout(function() {
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#marcaMantCargos_agr").unbind("click").change(async function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $('#modalAgregarMantCargos').modal('hide');

  var parametros = {
    "tipo": $("#tipoMantCargos_agr").val(),
    "marca": $('select[id="marcaMantCargos_agr"] option:selected').text()
  }

  await $.ajax({
    url: 'controller/datosCargosTIModelo.php',
    type: 'POST',
    data: parametros,
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_MARCA;
        var label = p[i].MODELO;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#modeloMantCargos_agr").html(options);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#marcaMantCargos_agr').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#modeloMantCargos_agr').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#modalAgregarMantCargos").modal('show');
  setTimeout(function() {
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#tipoMantenedorCargos").unbind("click").change(function(){
  var table = $("#tablaMantenedorCargos").DataTable();
  var estado = $("#tipoMantenedorCargos").val();
  if(estado == "Todos"){
    estado = '';
  }
  table.rows('').deselect();
  table.columns('5').search(estado).draw();
});

$("#marcaMantenedorCargos").unbind("click").change(function(){
  var table = $("#tablaMantenedorCargos").DataTable();
  var estado = $("#marcaMantenedorCargos").val();
  if(estado == "Todos"){
    estado = '';
  }
  table.rows('').deselect();
  table.columns('6').search(estado).draw();
});

$("#modeloMantenedorCargos").unbind("click").change(function(){
  var table = $("#tablaMantenedorCargos").DataTable();
  var estado = $("#modeloMantenedorCargos").val();
  if(estado == "Todos"){
    estado = '';
  }
  table.rows('').deselect();
  table.columns('7').search(estado).draw();
});

$("#estadoMantenedorCargos").unbind("click").change(function(){
  var table = $("#tablaMantenedorCargos").DataTable();
  var estado = $("#estadoMantenedorCargos").val();
  if(estado == "Todos"){
    estado = '';
  }
  table.rows('').deselect();
  table.columns('11').search(estado).draw();
});

$("#guardarAgregarMantCargos").unbind("click").click(async function(){
  if($("#caracteristicasCargos_agr").val() === "" || $("#fechaIngresoMantCargos_agr").val() === "" || $("#valroRefMantCargos_agr").val() === "" || $("#serieMantCargos_agr").val() === ""){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos básicos marcados en rojo");
    if($("#caracteristicasCargos_agr").val() === ""){
      $("#caracteristicasCargos_agr").addClass("is-invalid");
    }
    if($("#fechaIngresoMantCargos_agr").val() === ""){
      $("#fechaIngresoMantCargos_agr").addClass("is-invalid");
    }
    if($("#valroRefMantCargos_agr").val() === ""){
      $("#valroRefMantCargos_agr").addClass("is-invalid");
    }
    if($("#serieMantCargos_agr").val() === ""){
      $("#serieMantCargos_agr").addClass("is-invalid");
    }
  }
  else{
    $("#modalAgregarMantCargos").modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var parametros = {
      "serie": $("#serieMantCargos_agr").val(),
      "imei": $("#imeiMantCargos_agr").val(),
      "tipo": $("#tipoMantCargos_agr").val(),
      "marca_modelo": $("#modeloMantCargos_agr").val(),
      "valorRef": $("#valroRefMantCargos_agr").val(),
      "fechaIng": $("#fechaIngresoMantCargos_agr").val(),
      "caracteristicas": $("#caracteristicasCargos_agr").val(),
      "marcaTexto": $('select[id="marcaMantCargos_agr"] option:selected').text(),
      "modeloTexto": $('select[id="modeloMantCargos_agr"] option:selected').text(),
      "estado": $("#estadoMantCargos_agr").val(),
      "linea": $("#lineaMantCargos_agr").val()
    }

    await $.ajax({
      url:   'controller/ingresarCargoTI.php',
      type:  'post',
      data: parametros,
      success: async function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
            var table = $('#tablaMantenedorCargos').DataTable();
            await ingresaCambioCargo(p);

            $('input:text').val('');
            $('#modalAlertasSplash').modal('hide');
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Cargo ingresado correctamente");

            var tipoCargos = '';
            tipoCargos += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(5).data().unique().length; i++){
              if(table.column(5).data().unique()[i] !== null){
                tipoCargos += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
              }
            }
            $("#tipoMantenedorCargos").html(tipoCargos);

            var marcaCargos = '';
            marcaCargos += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(6).data().unique().length; i++){
              if(table.column(6).data().unique()[i] !== null){
                marcaCargos += '<option value="' + table.column(6).data().unique()[i] + '">' + table.column(6).data().unique()[i] + '</option>';
              }
            }
            $("#marcaMantenedorCargos").html(marcaCargos);

            var modeloCargos = '';
            modeloCargos += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(7).data().unique().length; i++){
              if(table.column(7).data().unique()[i] !== null){
                modeloCargos += '<option value="' + table.column(7).data().unique()[i] + '">' + table.column(7).data().unique()[i] + '</option>';
              }
            }
            $("#modeloMantenedorCargos").html(modeloCargos);

            var estadoCargos = '';
            estadoCargos += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(11).data().unique().length; i++){
              if(table.column(11).data().unique()[i] !== null){
                estadoCargos += '<option value="' + table.column(11).data().unique()[i] + '">' + table.column(11).data().unique()[i] + '</option>';
              }
            }
            $("#estadoMantenedorCargos").html(estadoCargos);

            setTimeout(function(){
              $('#tablaMantenedorCargos').DataTable().columns.adjust();
              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#tipoMantenedorCargos").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                  sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
                });
                $("#marcaMantenedorCargos").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#modeloMantenedorCargos").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#estadoMantenedorCargos").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
              }
              setTimeout(function(){
                $("#agregarMantenedorCargos").removeAttr("disabled");
                $("#editarMantenedorCargos").attr("disabled", "disabled");
                $("#eliminarMantenedorCargos").attr("disabled", "disabled");
                $('#modalAlertasSplash').modal('hide');
              },2000);
            },500);
          }
        else{
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible ingresar el cargo, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalAgregarMantCargos").modal("show");
          },500);
        }
      }
    });
  }
});

function ingresaCambioCargo(p){
  var table2 = $('#tablaMantenedorCargos').DataTable();
  for(var k = 0; k < p.aaData.length; k++){
    table2.rows.add([{
      'S': p.aaData[k].S,
      'IDTI_CARGOS': p.aaData[k].IDTI_CARGOS,
      'SERIE': p.aaData[k].SERIE,
      'IMEI': p.aaData[k].IMEI,
      'LINEA': p.aaData[k].LINEA,
      'TIPO': p.aaData[k].TIPO,
      'MARCA': p.aaData[k].MARCA,
      'MODELO': p.aaData[k].MODELO,
      'VALOR_REFERENCIAL': p.aaData[k].VALOR_REFERENCIAL,
      'FECHA_INGRESO': p.aaData[k].FECHA_INGRESO,
      'CARACTERISTICAS': p.aaData[k].CARACTERISTICAS,
      'ESTADO': p.aaData[k].ESTADO,
      'QR': p.aaData[k].QR
    }]).draw();
  }
}

$("#editarMantenedorCargos").unbind("click").click(async function() {
  $('input:text').val('');
  $("#caracteristicasCargos_upd").val('');
  $("#valroRefMantCargos_upd").removeClass("is-invalid");
  $("#fechaIngresoMantCargos_upd").removeClass("is-invalid");
  $("#caracteristicasCargos_agr").removeClass("is-invalid");
  $("#serieMantCargos_upd").removeClass("is-invalid");

  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $("#tablaMantenedorCargos").DataTable();
  var datos = table.rows('.selected').data();

  await $.ajax({
    url: 'controller/datosCargosTITipo.php',
    type: 'POST',
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_TIPO;
        var label = p[i].TIPO;
        var flag = 0;
        if(datos[0].TIPO === label){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $("#tipoMantCargos_upd").html(options);
    }
  });

  var parametros = {
    "tipo": $("#tipoMantCargos_upd").val()
  }

  await $.ajax({
    url: 'controller/datosCargosTIMarca.php',
    type: 'POST',
    data: parametros,
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_MARCA;
        var label = p[i].MARCA;
        if(datos[0].MARCA === label){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $("#marcaMantCargos_upd").html(options);
    }
  });

  parametros["marca"] = $('select[id="marcaMantCargos_upd"] option:selected').text();

  await $.ajax({
    url: 'controller/datosCargosTIModelo.php',
    type: 'POST',
    data: parametros,
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_MARCA;
        var label = p[i].MODELO;
        if(datos[0].MODELO === label){
          options += `<option selected value="${id}">${label}</option>`;
        }
        else{
          options += `<option value="${id}">${label}</option>`;
        }
      }
      $("#modeloMantCargos_upd").html(options);
    }
  });

  $("#fechaIngresoMantCargos_upd").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#serieMantCargos_upd").val(datos[0].SERIE);
  $("#fechaIngresoMantCargos_upd").val(datos[0].FECHA_INGRESO);
  $("#fechaIngresoMantCargos_upd").attr("disabled","disabled");
  $("#valroRefMantCargos_upd").val(datos[0].VALOR_REFERENCIAL);
  $("#caracteristicasCargos_upd").val(datos[0].CARACTERISTICAS);
  $("#imeiMantCargos_upd").val(datos[0].IMEI);
  $("#estadoMantCargos_upd").val(datos[0].ESTADO);
  $("#lineaMantCargos_upd").val(datos[0].LINEA);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoMantCargos_upd").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#marcaMantCargos_upd').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#modeloMantCargos_upd').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#estadoMantCargos_upd').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  var h = $(window).height() - 200;
  $("#bodyEditarMantCargos").css("height",h);
  $("#modalEditarMantCargos").modal('show');
  setTimeout(function() {
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#tipoMantCargos_upd").unbind("click").change(async function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $('#modalEditarMantCargos').modal('hide');

  var parametros = {
    "tipo": $("#tipoMantCargos_upd").val()
  }

  await $.ajax({
    url: 'controller/datosCargosTIMarca.php',
    type: 'POST',
    data: parametros,
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_MARCA;
        var label = p[i].MARCA;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#marcaMantCargos_upd").html(options);
    }
  });

  parametros["marca"] = $('select[id="marcaMantCargos_upd"] option:selected').text();

  await $.ajax({
    url: 'controller/datosCargosTIModelo.php',
    type: 'POST',
    data: parametros,
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_MARCA;
        var label = p[i].MODELO;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#modeloMantCargos_upd").html(options);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#tipoMantCargos_upd').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#marcaMantCargos_upd').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#modeloMantCargos_upd').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#modalEditarMantCargos").modal('show');
  setTimeout(function() {
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#marcaMantCargos_upd").unbind("click").change(async function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $('#modalEditarMantCargos').modal('hide');

  var parametros = {
    "tipo": $("#tipoMantCargos_upd").val(),
    "marca": $('select[id="marcaMantCargos_upd"] option:selected').text()
  }

  await $.ajax({
    url: 'controller/datosCargosTIModelo.php',
    type: 'POST',
    data: parametros,
    dataType: 'json',
    success: function (response) {
      var p = response.aaData;
      var options = '';
      for (var i= 0; i < p.length; i++) {
        var id = p[i].IDTI_CARGOS_MARCA;
        var label = p[i].MODELO;
        options += `<option value="${id}">${label}</option>`;
      }
      $("#modeloMantCargos_upd").html(options);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $('#marcaMantCargos_upd').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $('#modeloMantCargos_upd').select2('destroy').select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#modalEditarMantCargos").modal('show');
  setTimeout(function() {
    $('#modalAlertasSplash').modal('hide');
  },500);
});

function printDOM(url) {
  var random = Math.round(Math.random() * (1000000 - 1) + 1);
  var w = window.open('controller/cargarQRCargo.php?folio=' + url + '&id=' + random);
}

$("#guardarEditarMantCargos").unbind("click").click(async function(){
  if($("#caracteristicasCargos_upd").val() === "" || $("#fechaIngresoMantCargos_upd").val() === "" || $("#valroRefMantCargos_upd").val() === "" || $("#serieMantCargos_upd").val() === ""){
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Debe ingresar los campos básicos marcados en rojo");
    if($("#caracteristicasCargos_upd").val() === ""){
      $("#caracteristicasCargos_upd").addClass("is-invalid");
    }
    if($("#fechaIngresoMantCargos_upd").val() === ""){
      $("#fechaIngresoMantCargos_upd").addClass("is-invalid");
    }
    if($("#valroRefMantCargos_upd").val() === ""){
      $("#valroRefMantCargos_upd").addClass("is-invalid");
    }
    if($("#serieMantCargos_upd").val() === ""){
      $("#serieMantCargos_upd").addClass("is-invalid");
    }
  }
  else{
    $("#modalEditarMantCargos").modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var table = $('#tablaMantenedorCargos').DataTable();
    var datos = table.rows('.selected').data();

    var parametros = {
      "folio": datos[0].IDTI_CARGOS,
      "serie": $("#serieMantCargos_upd").val(),
      "imei": $("#imeiMantCargos_upd").val(),
      "tipo": $("#tipoMantCargos_upd").val(),
      "marca_modelo": $("#modeloMantCargos_upd").val(),
      "valorRef": $("#valroRefMantCargos_upd").val(),
      "fechaIng": $("#fechaIngresoMantCargos_upd").val(),
      "caracteristicas": $("#caracteristicasCargos_upd").val(),
      "marcaTexto": $('select[id="marcaMantCargos_upd"] option:selected').text(),
      "modeloTexto": $('select[id="modeloMantCargos_upd"] option:selected').text(),
      "estado": $("#estadoMantCargos_upd").val(),
      "linea": $("#lineaMantCargos_upd").val()
    }

    await $.ajax({
      url:   'controller/actualizarCargoTI.php',
      type:  'post',
      data: parametros,
      success: async function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
            var table = $('#tablaMantenedorCargos').DataTable();
            table.rows('.selected').remove().draw();
            await ingresaCambioCargo(p);

            $('input:text').val('');
            $('#modalAlertasSplash').modal('hide');
            alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Cargo editado correctamente");

            var tipoCargos = '';
            tipoCargos += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(5).data().unique().length; i++){
              if(table.column(5).data().unique()[i] !== null){
                tipoCargos += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
              }
            }
            $("#tipoMantenedorCargos").html(tipoCargos);

            var marcaCargos = '';
            marcaCargos += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(6).data().unique().length; i++){
              if(table.column(6).data().unique()[i] !== null){
                marcaCargos += '<option value="' + table.column(6).data().unique()[i] + '">' + table.column(6).data().unique()[i] + '</option>';
              }
            }
            $("#marcaMantenedorCargos").html(marcaCargos);

            var modeloCargos = '';
            modeloCargos += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(7).data().unique().length; i++){
              if(table.column(7).data().unique()[i] !== null){
                modeloCargos += '<option value="' + table.column(7).data().unique()[i] + '">' + table.column(7).data().unique()[i] + '</option>';
              }
            }
            $("#modeloMantenedorCargos").html(modeloCargos);

            var estadoCargos = '';
            estadoCargos += '<option selected value="Todos">Todos</option>';
            for(var i = 0; i < table.column(11).data().unique().length; i++){
              if(table.column(11).data().unique()[i] !== null){
                estadoCargos += '<option value="' + table.column(11).data().unique()[i] + '">' + table.column(11).data().unique()[i] + '</option>';
              }
            }
            $("#estadoMantenedorCargos").html(estadoCargos);

            setTimeout(function(){
              $('#tablaMantenedorCargos').DataTable().columns.adjust();
              if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                $("#tipoMantenedorCargos").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                  sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
                });
                $("#marcaMantenedorCargos").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#modeloMantenedorCargos").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
                $("#estadoMantenedorCargos").select2('destroy').select2({
                  theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
                });
              }
              setTimeout(function(){
                $("#agregarMantenedorCargos").removeAttr("disabled");
                $("#editarMantenedorCargos").attr("disabled", "disabled");
                $("#eliminarMantenedorCargos").attr("disabled", "disabled");
                $('#modalAlertasSplash').modal('hide');
              },2000);
            },500);
          }
        else{
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible editar el cargo, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalEditarMantCargos").modal("show");
          },500);
        }
      }
    });
  }
});

$("#eliminarMantenedorCargos").unbind("click").click(async function(){
  var table = $('#tablaMantenedorCargos').DataTable();
  var datos = table.rows('.selected').data();

  $("#tituloEliminarMantCargos").html("Folio: " + datos[0].IDTI_CARGOS);

  $("#modalEliminarMantCargos").modal("show");
});

$("#guardarEliminarMantCargos").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEliminarMantCargos").modal("hide");

  var table = $('#tablaMantenedorCargos').DataTable();
  var datos = table.rows('.selected').data();

  var parametros = {
    "id": datos[0].IDTI_CARGOS
  }

  await $.ajax({
    url:   'controller/eliminarCargoTI.php',
    type:  'post',
    data: parametros,
    success: async function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          var table = $('#tablaMantenedorCargos').DataTable();
          table.rows('.selected').remove().draw();

          $('input:text').val('');
          $('#modalAlertasSplash').modal('hide');
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Cargo eliminado correctamente");

          var tipoCargos = '';
          tipoCargos += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(5).data().unique().length; i++){
            if(table.column(5).data().unique()[i] !== null){
              tipoCargos += '<option value="' + table.column(5).data().unique()[i] + '">' + table.column(5).data().unique()[i] + '</option>';
            }
          }
          $("#tipoMantenedorCargos").html(tipoCargos);

          var marcaCargos = '';
          marcaCargos += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(6).data().unique().length; i++){
            if(table.column(6).data().unique()[i] !== null){
              marcaCargos += '<option value="' + table.column(6).data().unique()[i] + '">' + table.column(6).data().unique()[i] + '</option>';
            }
          }
          $("#marcaMantenedorCargos").html(marcaCargos);

          var modeloCargos = '';
          modeloCargos += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(7).data().unique().length; i++){
            if(table.column(7).data().unique()[i] !== null){
              modeloCargos += '<option value="' + table.column(7).data().unique()[i] + '">' + table.column(7).data().unique()[i] + '</option>';
            }
          }
          $("#modeloMantenedorCargos").html(modeloCargos);

          var estadoCargos = '';
          estadoCargos += '<option selected value="Todos">Todos</option>';
          for(var i = 0; i < table.column(11).data().unique().length; i++){
            if(table.column(11).data().unique()[i] !== null){
              estadoCargos += '<option value="' + table.column(11).data().unique()[i] + '">' + table.column(11).data().unique()[i] + '</option>';
            }
          }
          $("#estadoMantenedorCargos").html(estadoCargos);

          setTimeout(function(){
            $('#tablaMantenedorCargos').DataTable().columns.adjust();
            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              $("#tipoMantenedorCargos").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
                sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
              });
              $("#marcaMantenedorCargos").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $("#modeloMantenedorCargos").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              $("#estadoMantenedorCargos").select2('destroy').select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
            }
            setTimeout(function(){
              $("#agregarMantenedorCargos").removeAttr("disabled");
              $("#editarMantenedorCargos").attr("disabled", "disabled");
              $("#eliminarMantenedorCargos").attr("disabled", "disabled");
              $('#modalAlertasSplash').modal('hide');
            },2000);
          },500);
        }
        else{
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible eliminar el cargo, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $("#modalEliminarMantCargos").modal("show");
          },500);
        }
      }
      else{
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>No fue posible eliminar el cargo, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalEliminarMantCargos").modal("show");
        },500);
      }
    }
  });
});

$("#detalleAsignarCargos").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaAsignarCargos').DataTable();
  var datos = table.rows('.selected').data();

  $("#tituloDetalleAsignacionCarga").html('Folio: ' + datos[0].FOLIO + '<br>Personal asignado: ' + datos[0].NOMBRE + '<br>Fecha asignación: ' + datos[0].FECHA_ASIGNACION);

  var parametros = {
    "folio": datos[0].FOLIO
  }

  var largo = Math.trunc(($(window).height() - ($(window).height()/70)*50)/30);
  await $('#tablaDetalleAsignacionCarga').DataTable({
    ajax: {
        url: 'controller/datosDetalleAsignacionCargos.php',
        type: 'POST',
        data: parametros
    },
    columns: [
        { data: 'S'},
        { data: 'TIPO' },
        { data: 'SERIE' } ,
        { data: 'IMEI' },
        { data: 'LINEA' },
        { data: 'MARCA' },
        { data: 'MODELO' },
        { data: 'F_DESASIGNACION' },
        { data: 'ACCION' },
        { data: 'IDTI_CARGOS' }
    ],
    //
    buttons: [
      {
          extend: 'excel',
          exportOptions: {
            columns: [ 2,3,4,5,6,7,8,9,10 ]
          },
          title: null,
          text: '<span class="far fa-file-excel"></span>&nbsp;&nbsp;Excel'
      },
      {
        text: '<span class="fas fa-broom"></span>&nbsp;&nbsp;Deseleccionar todo',
        action: function ( e, dt, node, config ) {
          var table = $('#tablaDetalleAsignacionCarga').DataTable();
          table.rows().deselect();
        }
      }
    ],
    // fixedColumns:   {
    //   leftColumns: 3
    // },
    "columnDefs": [
      {
        "width": "5px",
        "targets": 0
      },
      {
        "orderable": false,
        "className": 'select-checkbox',
        "targets": [ 0 ]
      },
      {
        "visible": false,
        "searchable": false,
        "targets": [ 9 ]
      }
    ],
    "select": {
      style: 'multi',
      // selector: 'td:not(:nth-child(2))'
    },
    "scrollX": true,
    "paging": true,
    "ordering": true,
    "scrollCollapse": true,
    "order": [[ 7, "asc" ]],
    "info": true,
    "lengthMenu": [[largo], [largo]],
    "dom": 'Bfrtip',
    "language": {
        "zeroRecords": "No tiene personal bajo su cargo",
        "info": "Registro _START_ de _END_ de _TOTAL_",
        "infoEmpty": "No tiene personal bajo su cargo",
        "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
        },
        "search": "Buscar: ",
        "select": {
            "rows": "- %d registros seleccionados"
        },
        "infoFiltered": "(Filtrado de _MAX_ registros)",
        "loadingRecords": "&nbsp;",
        "processing": "Loading..."
    },
    "destroy": true,
    "autoWidth": false,
    "initComplete": function( settings, json){
      setTimeout(function(){
        var h = $(window).height() - 300;
        $("#bodyDetalleAsignacionCarga").css("height",h);
        $("#modalDetalleAsignacionCarga").modal("show");
        $('#modalAlertasSplash').modal('hide');
        setTimeout(function(){
          $('#tablaDetalleAsignacionCarga').DataTable().columns.adjust();
        },500);
      }, 500);
    }
  });
});

$("input#lineaMantCargos_agr").on('input', function () {
    this.value = this.value.replace(/[^0-9]/g,'');
});

$("input#lineaMantCargos_upd").on('input', function () {
    this.value = this.value.replace(/[^0-9]/g,'');
});

$("#asignarAsignarCargos").unbind("click").click(async function(){
  $('input:text').val('');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#elementosAsignarCargo").empty();

  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><select id="tipoAsignarCargo1" class="form-control"></select></div>');
  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><select disabled id="serieAsignarCargo1" class="form-control"></select></div>');
  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><input disabled id="imeiAsignarCargo1" class="form-control"></input></div>');
  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><input disabled id="lineaAsignarCargo1" class="form-control"></input></div>');
  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><input disabled id="marcaAsignarCargo1" class="form-control"></input></div>');
  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><input disabled id="modeloAsignarCargo1" class="form-control"></input></div>');

  await $.ajax({
    url:   'controller/datosPersonalAsignarCargo.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var cuerpoPersonalAsignarCargo = '<option name="0">Seleccionar</option>';
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoPersonalAsignarCargo += '<option value="' + p.aaData[i].IDPERSONAL + '" name="' + p.aaData[i].CECO + ' ¬¬ ' + p.aaData[i].SOCIEDAD + ' ¬¬ ' + p.aaData[i].SUCURSAL + ' ¬¬ ' + p.aaData[i].CARGO + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRE + '</option>';
        }
        $("#dniAsignarCargo").html(cuerpoPersonalAsignarCargo);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosCargosTITipo.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        var cuerpoTipoCargo = '<option>Seleccionar</option>';
        for(var i = 0; i < p.aaData.length; i++){
          cuerpoTipoCargo += '<option value="' + p.aaData[i].IDTI_CARGOS_TIPO + '">' + p.aaData[i].TIPO + '</option>';
        }
        $("#tipoAsignarCargo1").html(cuerpoTipoCargo);
      }
    }
  });
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoAsignarCargo1").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#serieAsignarCargo1").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#dniAsignarCargo").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyAsignarCargo").css("height",h);
    $("#modalAsignarCargo").modal("show");
    $('#modalAlertasSplash').modal('hide');
  },500);

  recargaSelect2AsignaCargo();
});

$("#agregarAsignarCargo").unbind("click").click(async function(){
  var cant = parseInt($("#ocultoCantCargo").val()) + 1;
  $("#ocultoCantCargo").val(cant);

  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><select disabled id="tipoAsignarCargo' + cant + '" class="form-control"></select></div>');
  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><select disabled id="serieAsignarCargo' + cant + '" class="form-control"></select></div>');
  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><input disabled id="imeiAsignarCargo' + cant + '" class="form-control"></input></div>');
  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><input disabled id="lineaAsignarCargo' + cant + '" class="form-control"></input></div>');
  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><input disabled id="marcaAsignarCargo' + cant + '" class="form-control"></input></div>');
  $("#elementosAsignarCargo").append('<div class="col-xl-2 col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding: 0px;"><input disabled id="modeloAsignarCargo' + cant + '" class="form-control"></input></div>');

  $("#tipoAsignarCargo" + cant).html($("#tipoAsignarCargo1").html());

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#tipoAsignarCargo" + cant).select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#serieAsignarCargo" + cant).select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  $("#tipoAsignarCargo" + cant).removeAttr("disabled","disabled");

  recargaSelect2AsignaCargo();
});

$("#dniAsignarCargo").unbind("click").change(async function(){
  var datos = $('select[id="dniAsignarCargo"] option:selected').attr("name");
  if(datos === "0"){
    $("#nombreAsignarCargo").val('');
    $("#sociedadAsignarCargo").val('');
    $("#cecoAsignarCargo").val('');
    $("#sucursalAsignarCargo").val('');
    $("#cargoAsignarCargo").val('');
  }
  else{
    var arrayDatos = datos.split(" ¬¬ ");
    for(var i = 0; i < arrayDatos.length; i++){
      if(arrayDatos[i] === "null"){
        arrayDatos[i] = '';
      }
    }
    $("#sociedadAsignarCargo").val(arrayDatos[1]);
    $("#cecoAsignarCargo").val(arrayDatos[0]);
    $("#sucursalAsignarCargo").val(arrayDatos[2]);
    $("#cargoAsignarCargo").val(arrayDatos[3]);
  }
});

function recargaSelect2AsignaCargo(){
  $("select[id*='tipoAsignarCargo']" ).on('change', async function(e){
    e.stopImmediatePropagation();
    e.preventDefault();

    var id = $(this).val();
    var ind = $(this).attr("id").split("AsignarCargo")[1];

    $("#imeiAsignarCargo" + ind).val("");
    $("#lineaAsignarCargo" + ind).val("");
    $("#marcaAsignarCargo" + ind).val("");
    $("#modeloAsignarCargo" + ind).val("");

    $("#serieAsignarCargo" + ind).attr("disabled","disabled");
    var cuerpoTipoSerieDisponible = '<option>Cargando...</option>';
    $("#serieAsignarCargo" + ind).html(cuerpoTipoSerieDisponible);

    var parametros = {
      "tipo": id
    }

    var arraySerie = [];

    $("select[id*='tipoAsignarCargo']").each(function(index){
      var indCheq = $(this).attr("id").split("tipoAsignarCargo")[1];
      if(id === $("#tipoAsignarCargo" + indCheq).val() && $("#serieAsignarCargo" + indCheq).val() !== "Cargando..."){
          arraySerie.push($("#serieAsignarCargo" + indCheq).val());
      }
    });

    await $.ajax({
      url:   'controller/datosCargosTIDisponiblesSerie.php',
      type:  'post',
      data: parametros,
      success: function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
          var flag = 0;
          var cuerpoTipoSerieDisponible = '';
          for(var i = 0; i < p.aaData.length; i++){
            if(jQuery.inArray(p.aaData[i].ID, arraySerie) === -1){
              flag++;
              if(flag === 1){
                cuerpoTipoSerieDisponible += '<option>Seleccionar</option>';
              }
              cuerpoTipoSerieDisponible += '<option value="' + p.aaData[i].ID + '">' + p.aaData[i].SERIE + '</option>';
            }
          }
          if(flag === 0){
            cuerpoTipoSerieDisponible = '<option>Sin disponibilidad</option>';
            $("#serieAsignarCargo" + ind).attr("disabled","disabled");
          }
          else{
            $("#serieAsignarCargo" + ind).removeAttr("disabled");
          }
          $("#serieAsignarCargo" + ind).html(cuerpoTipoSerieDisponible);
        }
        else{
          var cuerpoTipoSerieDisponible = '<option>Sin disponibilidad</option>';
          $("#serieAsignarCargo" + ind).html(cuerpoTipoSerieDisponible);
          $("#serieAsignarCargo" + ind).attr("disabled","disabled");
        }
      }
    });

    $("#tipoAsignarCargo" + ind).select2('destroy');
    $("#tipoAsignarCargo" + ind).select2({
      theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
      sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
    });
  });

  $("select[id*='serieAsignarCargo']" ).on('change', async function(e){
    e.stopImmediatePropagation();
    e.preventDefault();

    var id = $(this).val();
    var ind = $(this).attr("id").split("AsignarCargo")[1];

    $("#imeiAsignarCargo" + ind).val("Cargando...");
    $("#lineaAsignarCargo" + ind).val("Cargando...");
    $("#marcaAsignarCargo" + ind).val("Cargando...");
    $("#modeloAsignarCargo" + ind).val("Cargando...");

    var parametros = {
      "id": id
    }

    await $.ajax({
      url:   'controller/datosCargoTIDetalle.php',
      type:  'post',
      data: parametros,
      success: function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
          $("#imeiAsignarCargo" + ind).val(p.aaData[0].IMEI);
          $("#lineaAsignarCargo" + ind).val(p.aaData[0].LINEA);
          $("#marcaAsignarCargo" + ind).val(p.aaData[0].MARCA);
          $("#modeloAsignarCargo" + ind).val(p.aaData[0].MODELO);
        }
        else{
          $("#imeiAsignarCargo" + ind).val("");
          $("#lineaAsignarCargo" + ind).val("");
          $("#marcaAsignarCargo" + ind).val("");
          $("#modeloAsignarCargo" + ind).val("");
        }
      }
    });

    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#serieAsignarCargo" + ind).select2('destroy');
      $("#serieAsignarCargo" + ind).select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'),
        sorter: data => data.sort((a, b) => b.text.localeCompare(a.text))
      });
    }
  });
}

$("#guardarAsignarCargo").unbind("click").click(async function(){
  $("#modalAsignarCargo").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var arrayCargos = [];

  $("select[id*='serieAsignarCargo']").each(function(index){
    if($(this).val() !== "Sin disponibilidad" && $(this).val() !== "Seleccionar" && $(this).val() !== null){
      arrayCargos.push($(this).val());
    }
  });

  var parametros = {
    "idpersonal": $("#dniAsignarCargo").val(),
    "cargos": arrayCargos,
    "observacion": $("#observacionAsignarCargo").val()
  }

  await $.ajax({
    url: "controller/ingresarAsignacionCargo.php",
    type: 'POST',
    data: parametros,
    success:  async function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData.length !== 0){
        await $.ajax({
          url: "controller/generaPDF/asignacionCargoTI.php?idLoad=205",
          type: "POST",
          data:{
            "id": Number(p['lastID']),
            "url": window.location.toString().split("?")[0]
          },
          success: async function (res2){
            var p2 = res2.split(",");
            if(res2.localeCompare("Sin datos")!= 0 && res2 != ""){
              if(p2[0].localeCompare("Sin datos") != 0 && p2[0] != ""){
                window.open(window.location.toString().split("#/")[0].split('?')[0] + '/controller/repositorio/ti/asignacion/' + res2, '_blank');
                await $.ajax({
                  url: "controller/ingresarAsignacionCargoCambio.php",
                  type: 'POST',
                  data: {
                    'lastID': Number(p['lastID'])
                  },
                  success:  async function (response) {
                    var p3 = jQuery.parseJSON(response);
                    if(p3.aaData.length !== 0){
                      ingresaCambioAsignacionCargo(p3)
                      alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Asignación de cargo ingresada correctamente");
                      $("#asignarAsignarCargos").removeAttr("disabled");
                      $("#desasignarAsignarCargos").attr("disabled", "disabled");
                      $("#detalleAsignarCargos").attr("disabled", "disabled");
                      setTimeout(function(){
                        $('#modalAlertasSplash').modal('hide');
                      },500);
                    }
                  }
                });
              }
              else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error generar PDF de asignación de cargo, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
              }
            }
            else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error generar PDF de asignación de cargo, si el problema persiste favor comuniquese con soporte");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
          }
        });
      }
      else{
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar la asignacion de cargo, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

function ingresaCambioAsignacionCargo(p){
  var table2 = $('#tablaAsignarCargos').DataTable();
  for(var k = 0; k < p.aaData.length; k++){
    table2.rows.add([{
      'S': p.aaData[k].S,
      'FOLIO': p.aaData[k].FOLIO,
      'NOMBRE': p.aaData[k].NOMBRE,
      'ESTADO': p.aaData[k].ESTADO,
      'FECHA_ASIGNACION': p.aaData[k].FECHA_ASIGNACION,
      'FECHA_DESASIGNACION': p.aaData[k].FECHA_DESASIGNACION,
      'OBSERVACION': p.aaData[k].OBSERVACION,
      'USUARIO_ASIGNA': p.aaData[k].USUARIO_ASIGNA,
      'PDF': p.aaData[k].PDF
    }]).draw();
  }
}

async function pdf_AsignacionCargoTI(pdf){
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    window.open(window.location.toString().split("#/")[0].split('?')[0] + 'controller/repositorio/ti/asignacion/' + pdf, '_blank');
  }
}

//Agregar proveedor
$("#basicosAgregarMantProveedores-tab").click(function(){
  $("#clasificacionAgregarMantProveedores").removeClass("tab-pane fade show active");
  $("#clasificacionAgregarMantProveedores").addClass("tab-pane fade");
  $("#basicosAgregarMantProveedores").addClass("tab-pane fade show active");
});

$("#clasificacionAgregarMantProveedores-tab").click(function(){
  $("#basicosAgregarMantProveedores").removeClass("tab-pane fade show active");
  $("#basicosAgregarMantProveedores").addClass("tab-pane fade");
  $("#clasificacionAgregarMantProveedores").addClass("tab-pane fade show active");
});

//Edición proveedor
$("#basicosEditarMantProveedores-tab").click(function(){
  $("#clasificacionEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#clasificacionEditarMantProveedores").addClass("tab-pane fade");
  $("#evaluacionEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#evaluacionEditarMantProveedores").addClass("tab-pane fade");
  $("#criticosEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#criticosEditarMantProveedores").addClass("tab-pane fade");
  $("#ocEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#ocEditarMantProveedores").addClass("tab-pane fade");
  $("#basicosEditarMantProveedores").addClass("tab-pane fade show active");
  $("#tipoIngresoDatos").val(1);
  $("#guardarEditarMantProveedores").css("display","none");
  /* Perfiles que aplican
    Jefe de Compras
  Comprador
  Administrador Compradores
  Administrador Sistema
  */
  if($("#perfilEvaluador").val() === "Jefe de Compras" || $("#perfilEvaluador").val() === "Comprador" || $("#perfilEvaluador").val() === "Administrador Compradores"){
    $("#guardarEditarMantProveedores").css("display","inline");
  }
  else{
    $("#guardarEditarMantProveedores").css("display","none");
  }
});

$("#clasificacionEditarMantProveedores-tab").click(function(){
  $("#basicosEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#basicosEditarMantProveedores").addClass("tab-pane fade");
  $("#evaluacionEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#evaluacionEditarMantProveedores").addClass("tab-pane fade");
  $("#criticosEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#criticosEditarMantProveedores").addClass("tab-pane fade");
  $("#ocEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#ocEditarMantProveedores").addClass("tab-pane fade");
  $("#clasificacionEditarMantProveedores").addClass("tab-pane fade show active");
  $("#tipoIngresoDatos").val(1);
  $("#guardarEditarMantProveedores").css("display","none");
  /* Perfiles que aplican
    Jefe de Compras
  Comprador
  Administrador Compradores
  Administrador Sistema
  */
  if($("#perfilEvaluador").val() === "Jefe de Compras" || $("#perfilEvaluador").val() === "Comprador" || $("#perfilEvaluador").val() === "Administrador Compradores"){
    $("#guardarEditarMantProveedores").css("display","inline");
  }
  else{
    $("#guardarEditarMantProveedores").css("display","none");
  }
});

$("#evaluacionEditarMantProveedores-tab").click(function(){
  $("#basicosEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#basicosEditarMantProveedores").addClass("tab-pane fade");
  $("#clasificacionEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#clasificacionEditarMantProveedores").addClass("tab-pane fade");
  $("#criticosEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#criticosEditarMantProveedores").addClass("tab-pane fade");
  $("#ocEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#ocEditarMantProveedores").addClass("tab-pane fade");
  $("#evaluacionEditarMantProveedores").addClass("tab-pane fade show active");
  setTimeout(function(){
    $('#historialEvalMantProveedores_upd').DataTable().columns.adjust();
  },10);
  $("#tipoIngresoDatos").val(2);
  /* Perfiles que aplican
    Jefe de Compras
  Comprador
  Administrador Compradores
  Administrador Sistema
  */
  if($("#perfilEvaluador").val() === "Jefe de Compras" || $("#perfilEvaluador").val() === "Comprador" || $("#perfilEvaluador").val() === "Administrador Compradores"){
    $("#guardarEditarMantProveedores").css("display","none");
  }
  else{
    if($("#aplicaEvaluador").val() === "SI"){
      $("#guardarEditarMantProveedores").css("display","inline");
      if($("#nombreEvaluadorMantProveedores_upd").val() !== ''){
        $("#guardarEditarMantProveedores").css("display","none");
      }
      else{
        $("#guardarEditarMantProveedores").css("display","inline");
      }
    }
    else{
      $("#guardarEditarMantProveedores").css("display","none");
    }
  }
});

$("#criticosEditarMantProveedores-tab").click(function(){
  $("#basicosEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#basicosEditarMantProveedores").addClass("tab-pane fade");
  $("#clasificacionEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#clasificacionEditarMantProveedores").addClass("tab-pane fade");
  $("#evaluacionEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#evaluacionEditarMantProveedores").addClass("tab-pane fade");
  $("#ocEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#ocEditarMantProveedores").addClass("tab-pane fade");
  $("#criticosEditarMantProveedores").addClass("tab-pane fade show active");
  setTimeout(function(){
    $('#historialCriticoComprasMantProveedores_upd').DataTable().columns.adjust();
  },10);
  $("#tipoIngresoDatos").val(1);
  $("#guardarEditarMantProveedores").css("display","none");
});


$("#ocEditarMantProveedores-tab").click(function(){
  $("#basicosEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#basicosEditarMantProveedores").addClass("tab-pane fade");
  $("#clasificacionEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#clasificacionEditarMantProveedores").addClass("tab-pane fade");
  $("#evaluacionEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#evaluacionEditarMantProveedores").addClass("tab-pane fade");
  $("#criticosEditarMantProveedores").removeClass("tab-pane fade show active");
  $("#criticosEditarMantProveedores").addClass("tab-pane fade");
  $("#ocEditarMantProveedores").addClass("tab-pane fade show active");
  $("#tipoIngresoDatos").val(1);
  $("#guardarEditarMantProveedores").css("display","none");
});

$("#guardarCrear2fa").unbind('click').click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalCrear2fa").modal("hide");
  $.ajax({
    url:   'controller/validaTestGACrear.php',
    type:  'post',
    data:  {
      "codigo": $("#codigoCrear2fa").val()
    },
    success: async function (response) {
      if(response != 'Error'){
        await $.ajax({
          url:   'controller/ingresarCodeGA.php',
          type:  'post',
          data: {
            "login2fa": 1,
            "firma2fa": 0,
            "codigo": $("#codigoCrear2fa").val()
          },
          success: function (resp) {
            if(resp != 'Error'){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Contraseña 2FA creada correctamente, accediendo al sistema.");

              setTimeout(function(){
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                window.location.href = "?idLog=" + random + "#/login";
              },4000);
            }
          }
        });
      }
      else{
        var random = Math.round(Math.random() * (1000000 - 1) + 1);
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Código incorrecto");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
          $("#modalCrear2fa").modal("show");
        },500);
      }
    }
  });
});

$("#evalPlazoMantProveedores_upd").unbind("click").change(function(){
  if($("#evalPlazoMantProveedores_upd").val() < 0){
    $("#evalPlazoMantProveedores_upd").val(0);
  }
  if($("#evalPlazoMantProveedores_upd").val() > 100){
    $("#evalPlazoMantProveedores_upd").val(100);
  }
});

$("#evalCalidadMantProveedores_upd").unbind("click").change(function(){
  if($("#evalCalidadMantProveedores_upd").val() < 0){
    $("#evalCalidadMantProveedores_upd").val(0);
  }
  if($("#evalCalidadMantProveedores_upd").val() > 100){
    $("#evalCalidadMantProveedores_upd").val(100);
  }
});

async function valida2faEnter(){
  if($("#codigoLogin2fa").val().length == 6){
    $('#modalLogin2fa').modal('hide');
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    var URLactual = window.location;
    var gc = 0;
    if($("#recordarDatosLogin").prop("checked")){
      gc = 1;
    }
    var parametros = {
      "codigo": $("#codigoLogin2fa").val(),
      "secret": $("#secretLogin2fa").val(),
      "pass" : $("#loginSystem-pass").val(),
      "rut" : $("#loginSystem-rut").val().replace('.','').replace('.',''),
      "url" : URLactual.toString(),
      "gc": gc
    }

    await $.ajax({
      data:  parametros,
      url:   'controller/datosLogin.php',
      type:  'post',
      success: async function (response) {
        var p = jQuery.parseJSON(response);
        var size = Object.size(p.aaData)/2;
      }
    });
    await $.ajax({
      url:   'controller/validaTestGA.php',
      type:  'post',
      data:   parametros,
      success: async function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData.length !== 0){
          $('#contenido').show();
          $('#menu-lateral').show();
          $('#footer').parent().show();
          $('#footer').show();

          $('#modalLogin2fa').modal('hide');
          localStorage['tokenTime'] = moment(new Date());
          // console.log(localStorage['tokenTime']);

          $("#sesionActiva").val("1");
          $("#sesionActivaUso").val("0");
          $("#logoMenu").show();

          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          window.location.href = "?idLog=" + random + "#/login";
        }
        else{
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>Clave 2fa no coincidente<br>Si tiene problemas favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
  else{
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El código 2FA debe contener 6 caracteres exactos");
    $("#codigoLogin2fa").addClass("is-invalid");
  }
}

$("#editarProyecto").unbind('click').click(async function(){
  await ajaxDatosSelectEstructuraOperacionEditar()
  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    var h = $(window).height() - 200;
    $("#bodyEditarProyecto").css("height",h);
    $("#bodyEditarProyecto").css("overflow-y","scroll");
  }
});

function ajaxDatosSelectEstructuraOperacionEditar(){
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#nomenclaturaEditarProyecto").val("");
    $("#nombreEditarProyecto").val("");
    $("#idEstructuraEditarProyecto").val("");
    var table = $("#tablaListadoProyecto").DataTable();
    var datos = table.rows('.selected').data();
    $.ajax({
        url: "controller/datosSelectEstructuraOperacion.php",
        type: 'POST',
        dataType: 'json',
        success:  function (response) {
          if(response.status){
            var noAplicaHTML = "<option value='NO APLICA'>No aplica</option>";
            if(response.servicios !== null){
              var servicio = $("#servicioExistenteEditarProyecto");
              var servicioDatos = response.servicios.map(function(servicio){
                if(datos[0].IDSERVICIO == servicio.IDSERVICIO){
                  return `<option value="${servicio.IDSERVICIO}" selected>${servicio.SERVICIO}</option>`;
                  $("#servicioNuevoEditarProyecto").attr("disabled","disabled").removeClass("is-invalid");
                }
                else{
                  return `<option value="${servicio.IDSERVICIO}">${servicio.SERVICIO}</option>`;
                }
              });
              servicioDatos.unshift(noAplicaHTML);
              servicio.val(datos[0].IDSERVICIO);
            }
            else{
              var servicio = $("#servicioExistenteEditarProyecto");
              var servicioDatos = noAplicaHTML;
            }

            if(response.clientes !== null){
              var cliente = $("#clienteExistenteEditarProyecto");
              var clienteDatos = response.clientes.map(function(cliente){
                if(datos[0].IDCLIENTE == cliente.IDCLIENTE){
                  return `<option value="${cliente.IDCLIENTE}" selected>${cliente.CLIENTE}</option>`;
                  $("#clienteNuevoEditarProyecto").attr("disabled","disabled").removeClass("is-invalid");
                }
                else{
                  return `<option value="${cliente.IDCLIENTE}">${cliente.CLIENTE}</option>`;
                }
              });
              clienteDatos.unshift(noAplicaHTML);
              cliente.val(datos[0].IDCLIENTE);
            }
            else{
              var cliente = $("#clienteExistenteEditarProyecto");
              var clienteDatos = noAplicaHTML;
            }

            if(response.actividades !== null){
              var actividad = $("#actividadExistenteEditarProyecto");
              var actividadDatos = response.actividades.map(function(actividad){
                if(datos[0].IDACTIVIDAD == actividad.IDACTIVIDAD){
                  return `<option value="${actividad.IDACTIVIDAD}" selected>${actividad.ACTIVIDAD}</option>`;
                  $("#actividadNuevoEditarProyecto").attr("disabled","disabled").removeClass("is-invalid");
                }
                else{
                  return `<option value="${actividad.IDACTIVIDAD}">${actividad.ACTIVIDAD}</option>`;
                }
              });
              actividadDatos.unshift(noAplicaHTML);
              actividad.val(datos[0].IDACTIVIDAD);
            }
            else{
              var actividad = $("#actividadExistenteEditarProyecto");
              var actividadDatos = noAplicaHTML;
            }

            if(response.sociedades !== null){
              var sociedad = $("#subcontratoExistenteEditarProyecto");
              var sociedadDatos = response.sociedades.map(function(sociedad){
                if(datos[0].IDSUBCONTRATO == sociedad.IDSOCIEDAD){
                  return `<option value="${sociedad.IDSOCIEDAD}" selected>${sociedad.SOCIEDAD}</option>`;
                }
                else{
                  return `<option value="${sociedad.IDSOCIEDAD}">${sociedad.SOCIEDAD}</option>`;
                }
              });
              sociedadDatos.unshift(noAplicaHTML);
              sociedad.val(datos[0].IDSUBCONTRATO);
            }
            else{
              var sociedad = $("#subcontratoExistenteEditarProyecto");
              var sociedadDatos = noAplicaHTML;
            }

            var area = $("#areaEditarProyecto");
            var areaDatos = response.areas.map(function(area){
              if(datos[0].IDAREA == area.IDAREA){
                return `<option value="${area.IDAREA}" selected>${area.NOMBRE}</option>`;
              }
              else{
                return `<option value="${area.IDAREA}">${area.NOMBRE}</option>`;
              }
            });

            $("#nomenclaturaEditarProyecto").val(datos[0].NOMENCLATURA);
            $("#nombreEditarProyecto").val(datos[0].NOMBRE);
            $("#idEstructuraEditarProyecto").val(datos[0].IDESTRUCTURA_OPERACION);

            if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
              servicio.html(servicioDatos).select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              });
              cliente.html(clienteDatos).select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              })
              actividad.html(actividadDatos).select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              })
              area.html(areaDatos).select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              })
              sociedad.html(sociedadDatos).select2({
                theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
              })
            }
            else{
              servicio.html(servicioDatos);
              cliente.html(clienteDatos);
              actividad.html(actividadDatos);
              area.html(areaDatos);
              sociedad.html(sociedadDatos);
            }

            if(servicio.val() === "NO APLICA"){
              $("#servicioNuevoEditarProyecto").removeAttr("disabled","disabled").removeClass("is-invalid");
            }
            if(cliente.val() === "NO APLICA"){
              $("#clienteNuevoEditarProyecto").removeAttr("disabled","disabled").removeClass("is-invalid");
            }
            if(actividad.val() === "NO APLICA"){
              $("#actividadNuevoEditarProyecto").removeAttr("disabled","disabled").removeClass("is-invalid");
            }
            if(sociedad.val() === "NO APLICA"){
              $("#subcontratoExistenteEditarProyecto").removeAttr("disabled","disabled").removeClass("is-invalid");
            }
            setTimeout(function(){
              if( /AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                var h = $(window).height() - 200;
                $("#bodyEditarProyecto").css("height",h);
              }
              $('#modalAlertasSplash').modal('hide');
              $("#modalEditarProyecto").modal('show');
            },500);
          }
          else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar los datos, si el problema persiste<br/>favor comuniquese con soporte");
            $('#modalAlertasSplash').modal('hide');
          }
        }
    });
}

$("#servicioExistenteEditarProyecto").change(function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  var idServicio = $("#servicioExistenteEditarProyecto").val();
  var idCliente = $("#clienteExistenteEditarProyecto").val();
  var idActividad = $("#actividadExistenteEditarProyecto").val();
  var idSociedad = $("#subcontratoExistenteEditarProyecto").val();
  if($(this).val() === "NO APLICA"){
    $("#servicioNuevoEditarProyecto").removeAttr("disabled", "disabled").removeClass('is-invalid');
  }else{
    $("#servicioNuevoEditarProyecto").val('');
  }
  let datos = {
    idServicio: idServicio,
    idCliente: idCliente,
    idActividad: idActividad,
    idSociedad: idSociedad
  }
  ajaxDatosNomenclaturaByServicioClienteEditar(datos);
});

$("#clienteExistenteEditarProyecto").change(function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  var idServicio = $("#servicioExistenteEditarProyecto").val();
  var idCliente = $("#clienteExistenteEditarProyecto").val();
  var idActividad = $("#actividadExistenteEditarProyecto").val();
  var idSociedad = $("#subcontratoExistenteEditarProyecto").val();
  if($(this).val() === "NO APLICA"){
    $("#clienteNuevoEditarProyecto").removeAttr("disabled", "disabled").removeClass('is-invalid');
  }else{
    $("#clienteNuevoEditarProyecto").attr("disabled","disabled").removeClass('is-invalid').val('');
  }
  let datos = {
    idServicio: idServicio,
    idCliente: idCliente,
    idActividad: idActividad,
    idSociedad: idSociedad
  }
  ajaxDatosNomenclaturaByServicioClienteEditar(datos);
});

$("#actividadExistenteEditarProyecto").change(function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  var idServicio = $("#servicioExistenteEditarProyecto").val();
  var idCliente = $("#clienteExistenteEditarProyecto").val();
  var idActividad = $("#actividadExistenteEditarProyecto").val();
  var idSociedad = $("#subcontratoExistenteEditarProyecto").val();
  if($(this).val() === "NO APLICA"){
    $("#actividadNuevoEditarProyecto").removeAttr("disabled", "disabled").removeClass('is-invalid');
  }else{
    $("#actividadNuevoEditarProyecto").attr("disabled","disabled").removeClass('is-invalid').val('');
  }
  let datos = {
    idServicio: idServicio,
    idCliente: idCliente,
    idActividad: idActividad,
    idSociedad: idSociedad
  }
  ajaxDatosNomenclaturaByServicioClienteEditar(datos);
});

function ajaxDatosNomenclaturaByServicioClienteEditar(datos){
  $("#modalEditarProyecto").modal('hide');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  setTimeout(function(){
    var subcontratista = $("#subcontratoExistenteEditarProyecto");
    var servicio = $("#servicioExistenteEditarProyecto");
    var cliente = $("#clienteExistenteEditarProyecto");
    var actividad = $("#actividadExistenteEditarProyecto");
    var sociedad = $("#subcontratoExistenteEditarProyecto");
    var area = $("#areaEditarProyecto");

    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      subcontratista.select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      servicio.select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      cliente.select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      actividad.select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      area.select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      sociedad.select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }

    setTimeout(function(){
      $('#modalAlertasSplash').modal('hide');
      $("#modalEditarProyecto").modal('show');
    },1000);
  },1500);
}

function ajaxGuardarEstructuraOperacionEditar(parametros){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $('#modalEditarProyecto').modal('hide');
  $.ajax({
    url: "controller/editarEstructuraOperacion.php",
    type: 'POST',
    data: parametros,
    success:  function (response) {
        $("#modalEditarProyecto input").removeClass("is-invalid");
        var p = response.split(",");
        if(response.localeCompare("OK") == 0){
            if(p[0].localeCompare("OK") == 0){
                var table = $('#tablaListadoProyecto').DataTable();
                table.ajax.reload();
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>proyecto ingresado correctamente");
                $("#eliminarProyecto").attr("disabled", "disabled");
                $("#editarProyecto").attr("disabled", "disabled");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
            }else if(p[0].localeCompare("NO_EXISTE") == 0){
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La combinatoria ingresada no se encuentra registrada");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalEditarProyecto').modal('show');
              },500);
            }else if(p[0].localeCompare("EXISTESERVICIO") == 0){
              $("#servicioNuevoEditarProyecto").addClass("is-invalid");
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El servicio <b>"+ parametros.servicioNuevo +"</b> ya se encuentra registrado, favor ingresar un servicio diferente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalEditarProyecto').modal('show');
              },500);
            }else if(p[0].localeCompare("EXISTECLIENTE") == 0){
              $("#clienteNuevoEditarProyecto").addClass("is-invalid");
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El cliente <b>"+ parametros.clienteNuevo +"</b> ya se encuentra registrado, favor ingresar un cliente diferente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalEditarProyecto').modal('show');
              },500);
            }else if(p[0].localeCompare("EXISTEACTIVIDAD") == 0){
              $("#actividadNuevoEditarProyecto").addClass("is-invalid");
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La actividad <b>"+ parametros.actividadNuevo +"</b> ya se encuentra registrada, favor ingresar una actividad diferente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
                $('#modalEditarProyecto').modal('show');
              },500);
            }else{
                var random = Math.round(Math.random() * (1000000 - 1) + 1);
                alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el proyecto, si el problema persiste favor comuniquese con soporte");
                setTimeout(function(){
                  $('#modalAlertasSplash').modal('hide');
                },500);
            }
        }else if(response.localeCompare("NO_EXISTE") == 0){
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La combinatoria ingresada no se encuentra registrada");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalEditarProyecto').modal('show');
          },500);
        }else if(response.localeCompare("EXISTESERVICIO") == 0){
          $("#servicioNuevoEditarProyecto").addClass("is-invalid");
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El servicio <b>"+ parametros.servicioNuevo +"</b> ya se encuentra registrado, favor ingresar un servicio diferente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalEditarProyecto').modal('show');
          },500);
        }else if(response.localeCompare("EXISTECLIENTE") == 0){
          $("#clienteNuevoEditarProyecto").addClass("is-invalid");
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El cliente <b>"+ parametros.clienteNuevo +"</b> ya se encuentra registrado, favor ingresar un cliente diferente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalEditarProyecto').modal('show');
          },500);
        }else if(response.localeCompare("EXISTEACTIVIDAD") == 0){
          $("#actividadNuevoEditarProyecto").addClass("is-invalid");
          var random = Math.round(Math.random() * (1000000 - 1) + 1);
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>La actividad <b>"+ parametros.actividadNuevo +"</b> ya se encuentra registrada, favor ingresar una actividad diferente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
            $('#modalEditarProyecto').modal('show');
          },500);
        }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el proyecto, si el problema persiste favor comuniquese con soporte");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
        }
    }
  });
}

$("#estadoIngresoVehiculos").unbind("click").change(function(e){
  e.preventDefault();
  e.stopImmediatePropagation();
  if($("#estadoIngresoVehiculos").val() ==  2){
    $("#patenteOriginalVehiculos").attr("disabled","disabled");
    $("#patenteOriginalVehiculos").val(0);
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#patenteOriginalVehiculos").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#estadoIngresoVehiculos").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  }
  else{
    $("#patenteOriginalVehiculos").removeAttr("disabled");
    if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      $("#patenteOriginalVehiculos").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
      $("#estadoIngresoVehiculos").select2({
          theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
      });
    }
  }
});

$("#nombreEditarProveedores").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#rutEditarProveedores").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#pdfCargaEmisionGases" ).on('change', function(e){
  var file = e.target.files[0].name; // agarramos solo el nombre([0].name) del array que tiene tamaño, fecha y mas
  $("#inputPdfEmisionGases").val(file);
  $("#inputPdfEmisionGases").removeClass("is-invalid");
});

$("#crearEstadoProyecto").unbind("click").click(function(){
  $("#estadoEditarEstadoProyecto").val('');
  $("#descripcionEditarEstadoProyecto").val('');
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
    $("#modalCrearEstadoProyecto").modal("show");
  },2000);
});

$("#editarEstadoProyecto").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaEstadoProyecto').DataTable();
  var idEstado = $.map(table.rows('.selected').data(), function (item) {
      return item.IDESTRUCTURA_OPERACION_ESTADO;
  });
  var estado = $.map(table.rows('.selected').data(), function (item) {
      return item.ESTADO;
  });
  var description = $.map(table.rows('.selected').data(), function (item) {
      return item.DESCRIPCION;
  });

  $("#tituloEditarEstadoProyecto").html("<br>Identificador de estado: " + idEstado);
  $("#estadoEditarEstadoProyecto").val(estado);
  $("#descripcionEditarEstadoProyecto").val(description);
  $("#idEditarEstadoProyecto").val(idEstado);

  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
    $("#modalEditarEstadoProyecto").modal("show");
  },2000);
});

$("#guardarCrearEstadoProyecto").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalCrearEstadoProyecto").modal("hide");

  var estado = $("#estadoCrearEstadoProyecto").val();
  var descripcion = $("#descripcionCrearEstadoProyecto").val();

  var parametros = {
    "estado": estado,
    "descripcion": descripcion
  }

  await $.ajax({
    url:   'controller/datosEstadoProyectoNombre.php',
    type:  'post',
    data: parametros,
    success: function (response) {
      var p = jQuery.parseJSON(response);
      if(p.aaData[0].CANTIDAD === '0'){
        $.ajax({
            url: "controller/ingresarEstadoProyecto.php",
            type: 'POST',
            data: parametros,
            success:  function (response) {
                var p = response.split(",");
                if(response.localeCompare("Sin datos")!= 0 && response != ""){
                    if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                        var table = $('#tablaEstadoProyecto').DataTable();
                        table.ajax.reload();
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Estado ingresado correctamente");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                    }
                    else{
                        var random = Math.round(Math.random() * (1000000 - 1) + 1);
                        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el estado");
                        setTimeout(function(){
                          $('#modalAlertasSplash').modal('hide');
                        },500);
                    }
                }else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el estado");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
                }
            }
        });
      }
      else{
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El estado ingresado ya existe");
        setTimeout(function(){
          $("#modalCrearEstadoProyecto").modal("show");
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#guardarEditarEstadoProyecto").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalEditarEstadoProyecto").modal("hide");

  var estado = $("#estadoEditarEstadoProyecto").val();
  var descripcion = $("#descripcionEditarEstadoProyecto").val();
  var idEstado = $("#idEditarEstadoProyecto").val();

  var parametros = {
    "estado": estado,
    "descripcion": descripcion,
    "idEstado": idEstado
  }

  $.ajax({
      url: "controller/actualizarEstadoProyecto.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaEstadoProyecto').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Estado actualizado correctamente");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
              else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar el estado");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
          }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar el estado");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
      }
  });
});

$("#crearGerencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");

  $("#gerenciaCrearGerenciaControlling").val("");
  $("#subGerenciaCrearGerenciaControlling").val("");
  $("#gerenciaCrearGerenciaControlling").removeClass("is-invalid");
  $("#subGerenciaCrearGerenciaControlling").removeClass("is-invalid");

  await $.ajax({
    url:   'controller/datosPersonalParaAsignar.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoGer = '<option selected value="0">Sin seleccionar</option>';
      var cuerpoSubGer = '<option selected value="0">Sin seleccionar</option>';
      for(var i = 0; i < p.aaData.length; i++){
        cuerpoGer += '<option value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        cuerpoSubGer += '<option value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
      }
      $("#gerenteCrearGerenciaControlling").html(cuerpoGer);
      $("#subgerenteCrearGerenciaControlling").html(cuerpoSubGer);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#gerenteCrearGerenciaControlling").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#subgerenteCrearGerenciaControlling").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
    $("#modalCrearGerenciaControlling").modal("show");
  },2000);
});

$("#editarGerencia").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  var table = $('#tablaGerencia').DataTable();
  var idGerencia = $.map(table.rows('.selected').data(), function (item) {
      return item.IDGERENCIA;
  });
  var idGerente = $.map(table.rows('.selected').data(), function (item) {
      return item.IDGERENTE;
  });
  var idSubgerente = $.map(table.rows('.selected').data(), function (item) {
      return item.IDSUBGERENTE;
  });
  var gerencia = $.map(table.rows('.selected').data(), function (item) {
      return item.GERENCIA;
  });
  var subGerencia = $.map(table.rows('.selected').data(), function (item) {
      return item.SUBGERENCIA;
  });
  var estado = $.map(table.rows('.selected').data(), function (item) {
      return item.ESTADO;
  });

  $("#tituloEditarGerenciaControlling").html("<br>Identificador de gerencia: " + idGerencia);
  $("#idEditarGerenciaControlling").val(idGerencia);
  $("#gerenciaEditarGerenciaControlling").val(gerencia);
  $("#subGgerenciaEditarGerenciaControlling").val(subGerencia);

  await $.ajax({
    url:   'controller/datosPersonalParaAsignar.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoGer = '<option selected value="0">Sin seleccionar</option>';
      var cuerpoSubGer = '<option selected value="0">Sin seleccionar</option>';
      for(var i = 0; i < p.aaData.length; i++){
        if(idGerente[0] === p.aaData[i].IDPERSONAL){
          cuerpoGer += '<option selected value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        }
        else{
          cuerpoGer += '<option value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        }
        if(idSubgerente[0] === p.aaData[i].IDPERSONAL){
          cuerpoSubGer += '<option selected value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        }
        else{
          cuerpoSubGer += '<option value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        }
      }
      $("#gerenteEditarGerenciaControlling").html(cuerpoGer);
      $("#subgerenteEditarGerenciaControlling").html(cuerpoSubGer);
    }
  });

  $("#estadoEditarGerenciaControlling").val(estado);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#gerenteEditarGerenciaControlling").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#subgerenteEditarGerenciaControlling").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#estadoEditarGerenciaControlling").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
    $("#modalEditarGerenciaControlling").modal("show");
  },2000);
});

$("#guardarCrearGerenciaControlling").unbind("click").click(async function(){
  if($("#gerenciaCrearGerenciaControlling").val() === "" || $("#subGerenciaCrearGerenciaControlling").val() === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Debe ingresar la gerencia y subgerencia");
    $("#gerenciaCrearGerenciaControlling").addClass("is-invalid");
    $("#subGerenciaCrearGerenciaControlling").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalCrearGerenciaControlling").modal("hide");

    var gerencia = $("#gerenciaCrearGerenciaControlling").val();
    var subGerencia = $("#subGerenciaCrearGerenciaControlling").val();
    var idGerente = $("#gerenteCrearGerenciaControlling").val();
    var idSubgerente = $("#subgerenteCrearGerenciaControlling").val();

    var parametros = {
      "gerencia": gerencia,
      "subGerencia": subGerencia,
      "idGerente": idGerente,
      "idSubgerente": idSubgerente
    }

    await $.ajax({
      url:   'controller/datosGerenciaSubgerencia.php',
      type:  'post',
      data: parametros,
      success: function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData[0].CANTIDAD === '0'){
          $.ajax({
              url: "controller/ingresarGerenciaSubgerencia.php",
              type: 'POST',
              data: parametros,
              success:  function (response) {
                  var p = response.split(",");
                  if(response.localeCompare("Sin datos")!= 0 && response != ""){
                      if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                          var table = $('#tablaGerencia').DataTable();
                          table.ajax.reload();
                          var random = Math.round(Math.random() * (1000000 - 1) + 1);
                          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Gerencia ingresada correctamente");
                          setTimeout(function(){
                            $('#modalAlertasSplash').modal('hide');
                          },500);
                      }
                      else{
                          var random = Math.round(Math.random() * (1000000 - 1) + 1);
                          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar la gerencia");
                          setTimeout(function(){
                            $('#modalAlertasSplash').modal('hide');
                          },500);
                      }
                  }else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el estado");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
              }
          });
        }
        else{
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>La gerencia ingresada ya existe");
          setTimeout(function(){
            $("#modalCrearGerenciaControlling").modal("show");
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#guardarEditarGerenciaControlling").unbind("click").click(function(){
  if($("#gerenciaEditarGerenciaControlling").val() === "" || $("#subGgerenciaEditarGerenciaControlling").val() === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Debe ingresar la gerencia y subgerencia");
    $("#gerenciaEditarGerenciaControlling").addClass("is-invalid");
    $("#subGgerenciaEditarGerenciaControlling").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEditarGerenciaControlling").modal("hide");

    var gerencia = $("#gerenciaEditarGerenciaControlling").val();
    var subGerencia = $("#subGgerenciaEditarGerenciaControlling").val();
    var idGerente = $("#gerenteEditarGerenciaControlling").val();
    var idSubgerente = $("#subgerenteEditarGerenciaControlling").val();
    var idGerencia = $("#idEditarGerenciaControlling").val();
    var estado = $("#estadoEditarGerenciaControlling").val();

    var parametros = {
      "gerencia": gerencia,
      "subGerencia": subGerencia,
      "idGerente": idGerente,
      "idSubgerente": idSubgerente,
      "idGerencia": idGerencia,
      "estado": estado
    }

    $.ajax({
        url: "controller/actualizaGerenciaSubgerencia.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaGerencia').DataTable();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Gerencia actualizada correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
                else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar la gerencia");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
            }else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar la gerencia");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
        }
    });
  }
});

$("#asignarGerenteSub").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  var table = $('#tablaGerencia').DataTable();
  var idGerencia = $.map(table.rows('.selected').data(), function (item) {
      return item.IDGERENCIA;
  });

  var gerencias = "";
  var gerenciasBD = "";

  for(var i = 0; i < idGerencia.length; i++){
    if(i == idGerencia.length - 1){
      gerencias = gerencias + idGerencia[i];
    }
    else{
      gerencias = gerencias + idGerencia[i] + ",";
    }
  }

  for(var i = 0; i < idGerencia.length; i++){
    if(i == idGerencia.length - 1){
      gerenciasBD = gerenciasBD + "'" + idGerencia[i] + "'";
    }
    else{
      gerenciasBD = gerenciasBD + "'" + idGerencia[i] + "',";
    }
  }

  $("#idAsignarGerenteControlling").val(gerenciasBD);
  $("#tituloAsignarGerenteControlling").html("<br>Identificador de gerencias a asignar: " + gerencias);

  await $.ajax({
    url:   'controller/datosPersonalParaAsignar.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoGer = '<option selected value="0">Sin seleccionar</option>';
      var cuerpoSubGer = '<option selected value="0">Sin seleccionar</option>';
      for(var i = 0; i < p.aaData.length; i++){
        cuerpoGer += '<option value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        cuerpoSubGer += '<option value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
      }
      $("#gerenteAsignarGerenteControlling").html(cuerpoGer);
      $("#subgerenteAsignarGerenteControlling").html(cuerpoSubGer);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#gerenteAsignarGerenteControlling").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
    $("#subgerenteAsignarGerenteControlling").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
    $("#modalAsignarGerenteControlling").modal("show");
  },2000);
});

$("#guardarAsignarGerenteControlling").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalAsignarGerenteControlling").modal("hide");

  var idGerente = $("#gerenteAsignarGerenteControlling").val();
  var idSubgerente = $("#subgerenteAsignarGerenteControlling").val();
  var gerencias = $("#idAsignarGerenteControlling").val();

  var parametros = {
    "gerencias": gerencias,
    "idGerente": idGerente,
    "idSubgerente": idSubgerente
  }

  $.ajax({
      url: "controller/actualizaGerenteSubgerenteMasivo.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaGerencia').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Gerencias actualizadas correctamente");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
              else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar las gerencias");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
          }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar las gerencias");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
      }
  });
});

$("#crearClienteProyecto").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");

  $("#rutCrearClienteProyecto").val("");
  $("#clienteCrearClienteProyecto").val("");
  $("#holdingCrearClienteProyecto").val("");
  $("#rutCrearClienteProyecto").removeClass("is-invalid");
  $("#clienteCrearClienteProyecto").removeClass("is-invalid");
  $("#holdingCrearClienteProyecto").removeClass("is-invalid");

  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
    $("#modalCrearClienteProyecto").modal("show");
  },2000);
});

$("#rutCrearClienteProyecto").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutCrearClienteProyecto").val() !== ''){rutIngOrden
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutCrearClienteProyecto").val("");
    $("#rutCrearClienteProyecto").addClass("is-invalid");
  }
});

$("#gerenciaCrearGerenciaControlling").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#subGerenciaCrearGerenciaControlling").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#gerenciaEditarGerenciaControlling").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#subGgerenciaEditarGerenciaControlling").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#rutCrearClienteProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#clienteCrearClienteProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#holdingCrearClienteProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#guardarCrearClienteProyecto").unbind("click").click(async function(){
  if($("#rutCrearClienteProyecto").val() === "" || $("#clienteCrearClienteProyecto").val() === "" || $("#holdingCrearClienteProyecto").val() === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Debe ingresar rut, cliente y holding");
    $("#rutCrearClienteProyecto").addClass("is-invalid");
    $("#clienteCrearClienteProyecto").addClass("is-invalid");
    $("#holdingCrearClienteProyecto").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalCrearClienteProyecto").modal("hide");

    var rut = $("#rutCrearClienteProyecto").val().replace('.','').replace('.','');
    var cliente = $("#clienteCrearClienteProyecto").val();
    var holding = $("#holdingCrearClienteProyecto").val();

    var parametros = {
      "rut": rut,
      "cliente": cliente,
      "holding": holding
    }

    await $.ajax({
      url:   'controller/datosClienteProyectoRut.php',
      type:  'post',
      data: parametros,
      success: function (response) {
        var p = jQuery.parseJSON(response);
        if(p.aaData[0].CANTIDAD === '0'){
          $.ajax({
              url: "controller/ingresarClienteProyecto.php",
              type: 'POST',
              data: parametros,
              success:  function (response) {
                  var p = response.split(",");
                  if(response.localeCompare("Sin datos")!= 0 && response != ""){
                      if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                          var table = $('#tablaCliente').DataTable();
                          table.ajax.reload();
                          var random = Math.round(Math.random() * (1000000 - 1) + 1);
                          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Cliente ingresado correctamente");
                          setTimeout(function(){
                            $('#modalAlertasSplash').modal('hide');
                          },500);
                      }
                      else{
                          var random = Math.round(Math.random() * (1000000 - 1) + 1);
                          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el cliente");
                          setTimeout(function(){
                            $('#modalAlertasSplash').modal('hide');
                          },500);
                      }
                  }else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el cliente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                  }
              }
          });
        }
        else{
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>El cliente ingresado ya existe");
          setTimeout(function(){
            $("#modalCrearClienteProyecto").modal("show");
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
    });
  }
});

$("#editarClienteProyecto").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalAlertasSplash").modal("show");
  $("#rutEditarClienteProyecto").removeClass("is-invalid");
  $("#clienteEditarClienteProyecto").removeClass("is-invalid");
  $("#holdingEditarClienteProyecto").removeClass("is-invalid");

  var table = $('#tablaCliente').DataTable();
  var idCliente = $.map(table.rows('.selected').data(), function (item) {
      return item.IDCLIENTE;
  });
  var rut = $.map(table.rows('.selected').data(), function (item) {
      return item.RUT_CLIENTE;
  });
  var cliente = $.map(table.rows('.selected').data(), function (item) {
      return item.SUB_CLIENTE;
  });
  var holding = $.map(table.rows('.selected').data(), function (item) {
      return item.CLIENTE;
  });

  $("#rutEditarClienteProyecto").val(rut);
  $("#clienteEditarClienteProyecto").val(cliente);
  $("#holdingEditarClienteProyecto").val(holding);
  $("#tituloEditarClienteProyecto").html("Identificador de cliente: " + idCliente);
  $("#idEditarClienteProyecto").val(idCliente);

  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
    $("#modalEditarClienteProyecto").modal("show");
  },2000);
});

$("#rutEditarClienteProyecto").rut({
  formatOn: 'blur',
  minimumLength: 8,
  validateOn: 'change'
}).on('rutInvalido', function(e) {
  if($("#rutEditarClienteProyecto").val() !== ''){rutIngOrden
    alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El RUT ingresado no es válido");
    $("#rutEditarClienteProyecto").val("");
    $("#rutEditarClienteProyecto").addClass("is-invalid");
  }
});

$("#rutEditarClienteProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#clienteEditarClienteProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#holdingEditarClienteProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#guardarEditarClienteProyecto").unbind("click").click(function(){
  if($("#rutEditarClienteProyecto").val() === "" || $("#clienteEditarClienteProyecto").val() === "" || $("#holdingEditarClienteProyecto").val() === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Debe ingresar rut, cliente y holding");
    $("#rutEditarClienteProyecto").addClass("is-invalid");
    $("#clienteEditarClienteProyecto").addClass("is-invalid");
    $("#holdingEditarClienteProyecto").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEditarClienteProyecto").modal("hide");

    var rut = $("#rutEditarClienteProyecto").val();
    var cliente = $("#clienteEditarClienteProyecto").val();
    var holding = $("#holdingEditarClienteProyecto").val();
    var idCliente = $("#idEditarClienteProyecto").val();

    var parametros = {
      "rut": rut,
      "cliente": cliente,
      "holding": holding,
      "idCliente": idCliente
    }

    $.ajax({
        url: "controller/actualizarClienteProyecto.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaCliente').DataTable();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Cliente actualizado correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
                else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar el cliente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
            }else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar el cliente");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
        }
    });
  }
});

$("#litrosEditarVehiculos").focusout(function(){
  $(this).val(parseFloat($(this).val()).toFixed(2));
});

$("#litrosEditarVehiculos").on('input', function(){
  this.value = this.value.replace(/[^0-9,.]/g, '').replace(/,/g, '.');
});

$("#litrosIngresoVehiculos").focusout(function(){
  $(this).val(parseFloat($(this).val()).toFixed(2));
});

$("#litrosIngresoVehiculos").on('input', function(){
  this.value = this.value.replace(/[^0-9,.]/g, '').replace(/,/g, '.');
});


$("#litrosEditarMarcaModelo").focusout(function(){
  $(this).val(parseFloat($(this).val()).toFixed(2));
});

$("#litrosEditarMarcaModelo").on('input', function(){
  this.value = this.value.replace(/[^0-9,.]/g, '').replace(/,/g, '.');
});

$("#litrosIngresoMarcaModelo").focusout(function(){
  $(this).val(parseFloat($(this).val()).toFixed(2));
});

$("#litrosIngresoMarcaModelo").on('input', function(){
  this.value = this.value.replace(/[^0-9,.]/g, '').replace(/,/g, '.');
});

$("#equipamientoVehiculo").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalAlertasSplash").modal("show");

  var table = $('#tablaListadoVehiculo').DataTable();
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE;
  });

  $("#tituloEquipamientoVehiculos").html("<br>Patente: " + patente);
  $("#idEquipamientoVehiculos").val(patente);

  var parametros = {
    "patente": patente
  }

  await $.ajax({
    url:   'controller/datosCecoConAsignacion.php',
    type:  'post',
    data:  parametros,
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoEquip = '';
      for(var i = 0; i < p.aaData.length; i++){
        cuerpoEquip += '<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12 input-group-sm" style="margin-top: 10pt;">';
        if(p.aaData[i].ASIGNADO == 1){
          cuerpoEquip += '<label class="switch"><input id="selectEquipamiento_' + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + '" value="' + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + '" type="checkbox" title="Asignar" checked="checked"><span class="slider round"></span></label>&nbsp;&nbsp;<label id="nombreEquipamiento_' + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + '">' + p.aaData[i].NOMBRE + '</label>';
          cuerpoEquip += `<input id="ocultoEquipamiento_` + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + `" type="hidden" value="` + p.aaData[i].IDASIGNADO + `">`;
        }
        else{
          cuerpoEquip += '<label class="switch"><input id="selectEquipamiento_' + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + '" value="' + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + '" type="checkbox" title="Asignar"><span class="slider round"></span></label>&nbsp;&nbsp;<label id="nombreEquipamiento_' + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + '">' + p.aaData[i].NOMBRE + '</label>';
          cuerpoEquip += `<input id="ocultoEquipamiento_` + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + `" type="hidden" value="-1">`;
        }
        cuerpoEquip += '</div>';
        if(p.aaData[i].CERTIFICADO == 'SI'){
          cuerpoEquip += `<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">
            <div class="input-group">
              <label class="input-group-btn">
                  <span id="spanEquipamiento_` + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + `" class="form-control btn btn-default btn-file" style="text-align: left; color: grey; border: 1px solid #c8c8c8;">
                      <span class="fas fa-file-pdf"></span>&nbsp;&nbsp;PDF<input type="file" id='pdfEquipamiento_` + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + `' style="display: none;" accept="application/pdf">
                  </span>
              </label>
              <input disabled id='inputEquipamiento_` + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + `' type="text" class="form-control" readonly value="` + p.aaData[i].RUTA + `">
            </div>
          </div>`;
        }
        else{
          cuerpoEquip += `<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" style="margin-top: 10pt;">
            <div class="input-group" style="display: none;">
              <label class="input-group-btn">
                  <span id="spanEquipamiento_` + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + `" class="form-control btn btn-default btn-file" style="text-align: left; color: grey; border: 1px solid #c8c8c8;">
                      <span class="fas fa-file-pdf"></span>&nbsp;&nbsp;PDF<input type="file" id='pdfEquipamiento_` + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + `' style="display: none;" accept="application/pdf">
                  </span>
              </label>
              <input disabled id='inputEquipamiento_` + p.aaData[i].IDPATENTE_EQUIPAMIENTOS + `' type="text" class="form-control" readonly>
            </div>
          </div>`;
        }
        cuerpoEquip += `<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <hr class="hr-separador">
        </div>`;
      }
      $("#bodyEquipamientoVehiculosRow").html(cuerpoEquip);

      $("[id^=pdfEquipamiento]").on('change', function(e){
        var id = $(this).attr("id").split("_")[1];
        var file = e.target.files[0].name;

        var ext = file.split('.');
        var extFin = ext[ext.length-1];

        if(extFin != "pdf" && extFin != "PDF"){
          $(this).val("");
          $("#inputEquipamiento_" + id).val("");
          alertasToast("<img src='view/img/info.png' class='splash_load'><br/>El archivo ingresado no es válido, debe ser .pdf o .PDF");
        }
        else{
          $("#inputEquipamiento_" + id).val(file);
        }
      });
    }
  });

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyEquipamientoVehiculos").css("height",h);
    $("#modalAlertasSplash").modal("hide");
    $("#modalEquipamientoVehiculos").modal("show");
  },2000);
});

$("#guardarEquipamientoVehiculos").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalAlertasSplash").modal("show");
  $("#modalEquipamientoVehiculos").modal("hide");

  var elementos = new Array();
  var patente = $("#idEquipamientoVehiculos").val();
  var selects = (Object.values($("input[id^='selectEquipamiento_']" )));

  var formdata = new FormData();
  var tam = 0;
  formdata.append('patente', patente);

  await selects.forEach((inp) => {
    var check = 0;
    if(inp.checked == true){
      check = 1;
    }

    var arc = '';
    if(typeof $("#pdfEquipamiento_" + inp.value)[0] !== 'undefined'){
      arc = $("#pdfEquipamiento_" + inp.value)[0].files[0];
    }

    formdata.append("id_" + inp.value, inp.value);
    formdata.append("oculto_" + inp.value, $("#ocultoEquipamiento_" + inp.value).val());
    formdata.append("checked_" + inp.value, check);
    formdata.append("archivo_" + inp.value, arc);
    formdata.append("nombre_" + inp.value, $("#nombreEquipamiento_" + inp.value).html());
  });

  await $.ajax({
    url: "controller/ingresaEquipamientoFlota.php",
    type: 'POST',
    data: formdata,
    cache: false,
    contentType: false,
    processData: false,
    success: function (response) {
      var p = response.split(",");
      if(response.localeCompare("Sin datos")!= 0 && response != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Equipamiento cargado correctamente");
          setTimeout(function(){
            $("#modalAlertasSplash").modal("hide");
          },2000);
        }
        else{
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar el equipamiento, si el problema persiste comununiquese con soporte");
        }
      }
      else{
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al cargar el equipamiento, si el problema persiste comununiquese con soporte");
      }
    }
  });
});

$("#cambiarEstadoSiniestro").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalAlertasSplash").modal("show");

  var table = $('#tablaListadoSiniestros').DataTable();
  var id = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_SINIESTROS;
  });
  var estado = $.map(table.rows('.selected').data(), function (item) {
      return item.ESTADO;
  });

  $("#tituloCambiarEstadoSiniestro").html("<br>Identificador de siniestro: " + id);
  $("#idCambiarEstadoSiniestro").val(id);

  await $.ajax({
    url:   'controller/datosSiniestroEstado.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      var cuerpoEst = '';
      for(var i = 0; i < p2.aaData.length; i++){
        if(estado[0] === p2.aaData[i].ESTADO){
          cuerpoEst += '<option selected value="' + p2.aaData[i].ID + '">' + p2.aaData[i].ESTADO + '</option>';
        }
        else{
          cuerpoEst += '<option value="' + p2.aaData[i].ID + '">' + p2.aaData[i].ESTADO + '</option>';
        }
      }
      $("#estadoCambiarEstadoSiniestro").html(cuerpoEst);
    }
  });

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#estadoCambiarEstadoSiniestro").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple')
    });
  }

  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
    $("#modalCambiarEstadoSiniestro").modal("show");
  },2000);
});


$("#guardarCambiarEstadoSiniestro").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalCambiarEstadoSiniestro").modal("hide");

  var parametros = {
    "id": $("#idCambiarEstadoSiniestro").val(),
    "estado": $("#estadoCambiarEstadoSiniestro").val()
  }

  $.ajax({
      url: "controller/actualizarSiniestroEstado.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaListadoSiniestros').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Estado actualizado correctamente");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
              else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar el estado");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
          }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar el estado");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
      }
  });
});

$("#patenteEnlaceSiniestro").unbind("click").click(async function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $("#modalAlertasSplash").modal("show");

  var table = $('#tablaListadoSiniestros').DataTable();
  var id = $.map(table.rows('.selected').data(), function (item) {
      return item.IDPATENTE_SINIESTROS;
  });
  var patente = $.map(table.rows('.selected').data(), function (item) {
      return item.PATENTE_REEMPLAZO;
  });

  $("#tituloCambiarPatenteReemplazoSiniestro").html("<br>Identificador de siniestro: " + id);
  $("#idCambiarPatenteReemplazoSiniestro").val(id);
  $("#patenteCambiarPatenteReemplazoSiniestro").val(patente);

  setTimeout(function(){
    $("#modalAlertasSplash").modal("hide");
    $("#modalCambiarPatenteReemplazoSiniestro").modal("show");
  },2000);
});

$('#patenteCambiarPatenteReemplazoSiniestro').on('input', function () {
    this.value = this.value.replace(/[^a-z,A-Z,0-9]/g,'');
});

$("#guardarCambiarPatenteReemplazoSiniestro").unbind("click").click(function(){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
  $("#modalCambiarPatenteReemplazoSiniestro").modal("hide");

  var parametros = {
    "id": $("#idCambiarPatenteReemplazoSiniestro").val(),
    "patente": $("#patenteCambiarPatenteReemplazoSiniestro").val().toUpperCase()
  }

  $.ajax({
      url: "controller/actualizarSiniestroPatente.php",
      type: 'POST',
      data: parametros,
      success:  function (response) {
          var p = response.split(",");
          if(response.localeCompare("Sin datos")!= 0 && response != ""){
              if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                  var table = $('#tablaListadoSiniestros').DataTable();
                  table.ajax.reload();
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Patente actualizada correctamente");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
              else{
                  var random = Math.round(Math.random() * (1000000 - 1) + 1);
                  alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar la patente");
                  setTimeout(function(){
                    $('#modalAlertasSplash').modal('hide');
                  },500);
              }
          }else{
            var random = Math.round(Math.random() * (1000000 - 1) + 1);
            alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar la patente");
            setTimeout(function(){
              $('#modalAlertasSplash').modal('hide');
            },500);
          }
      }
  });
});

$("#guardarIngresoProyecto").unbind("click").click(function(){
  if($("#defProyectoIngresoProyecto").val() === "" || $("#pepIngresoProyecto").val() === "" || $("#proyectoIngresoProyecto").val() === "" || $("#denominacionIngresoProyecto").val() === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Debe ingresar def. Proyecto, PEP, Proyecto y Denominación");
    $("#defProyectoIngresoProyecto").addClass("is-invalid");
    $("#pepIngresoProyecto").addClass("is-invalid");
    $("#proyectoIngresoProyecto").addClass("is-invalid");
    $("#denominacionIngresoProyecto").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalIngresoProyecto").modal("hide");

    var definicion = $("#defProyectoIngresoProyecto").val();
    var pep = $("#pepIngresoProyecto").val();
    var crm = $("#crmIngresoProyecto").val();
    var proyecto = $("#proyectoIngresoProyecto").val();
    var denominacion = $("#denominacionIngresoProyecto").val();
    var sociedad = $("#sociedadIngresoProyecto").val();
    var gerencia = $("#gerSubIngresoProyecto").val();
    var controller = $("#controllerIngresoProyecto").val();
    var adminContrato = $("#adminContratoIngresoProyecto").val();
    var cliente = $("#clienteSubIngresoProyecto").val();
    var fechaIniContrato = $("#fechaIniContratoIngresoProyecto").val();
    var fechaFinContrato = $("#fechaFinContratoIngresoProyecto").val();
    var fechaIniProyecto = $("#fechaIniProyectoIngresoProyecto").val();
    var fechaFinProyecto = $("#fechaFinProyectoIngresoProyecto").val();
    var estado = $("#estadoIngresoProyecto").val();

    var parametros = {
      "definicion": definicion,
      "pep": pep,
      "crm": crm,
      "proyecto": proyecto,
      "denominacion": denominacion,
      "sociedad": sociedad,
      "gerencia": gerencia,
      "controller": controller,
      "adminContrato": adminContrato,
      "cliente": cliente,
      "fechaIniContrato": fechaIniContrato,
      "fechaFinContrato": fechaFinContrato,
      "fechaIniProyecto": fechaIniProyecto,
      "fechaFinProyecto": fechaFinProyecto,
      "estado": estado
    }

    $.ajax({
        url: "controller/ingresarProyectoControlling.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaListadoProyecto').DataTable();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Proyecto ingresado correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
                else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el proyecto");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
            }else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al ingresar el proyecto");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
        }
    });
  }
});

$("#defProyectoIngresoProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#pepIngresoProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#proyectoIngresoProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#denominacionIngresoProyecto").on('input', function(){
  $(this).removeClass("is-invalid");
});

$("#ingregoTallerMantencion").unbind("click").click(async function(){
  $("#modalVerEvento").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var parametros = {
    "idMantencion" : $("#folioMantencion").text(),
    "motivo": $("#motivoMantencion").html(),
    "patente": $("#patenteMantencion").html()
  }

  await $.ajax({
    url:   'controller/actualizarMantencionTaller.php',
    type:  'post',
    data: parametros,
    success: function (response3) {
      var p = response3.split(",");
      if(response3.localeCompare("Sin datos")!= 0 && response3 != ""){
        if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
          // var table = $('#tablaMetaPractica').DataTable();
          // table.ajax.reload();
          alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Ingreso a taller indicado correctamente");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
        else{
          alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al indicar ingreso a taller, si el problema persiste favor comuniquese con soporte");
          setTimeout(function(){
            $('#modalAlertasSplash').modal('hide');
          },500);
        }
      }
      else{
        alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al indicar ingreso a taller, si el problema persiste favor comuniquese con soporte");
        setTimeout(function(){
          $('#modalAlertasSplash').modal('hide');
        },500);
      }
    }
  });
});

$("#editarProyecto").unbind('click').click(async function(){
  $("#defProyectoIngresoProyecto").val("");
  $("#pepEditarProyecto").val("");
  $("#crmEditarProyecto").val("");
  $("#proyectoEditarProyecto").val("");
  $("#denominacionEditarProyecto").val("");
  $("#fechaIniContratoEditarProyecto").val("");
  $("#fechaFinContratoEditarProyecto").val("");
  $("#fechaIniProyectoEditarProyecto").val("");
  $("#fechaFinProyectoEditarProyecto").val("");

  $("#modalEditarPerfil").modal("hide");
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');

  var table = $('#tablaListadoProyecto').DataTable();
  var folio = $.map(table.rows('.selected').data(), function (item) {
      return item.FOLIO;
  });
  var definicion = $.map(table.rows('.selected').data(), function (item) {
      return item.PEP_PADRE;
  });
  var pep = $.map(table.rows('.selected').data(), function (item) {
      return item.PEP;
  });
  var crm = $.map(table.rows('.selected').data(), function (item) {
      return item.COD_CRM;
  });
  var proyecto = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE_PADRE;
  });
  var denominacion = $.map(table.rows('.selected').data(), function (item) {
      return item.NOMBRE;
  });
  var idSociedad = $.map(table.rows('.selected').data(), function (item) {
      return item.IDSOCIEDAD;
  });
  var idSubgerencia = $.map(table.rows('.selected').data(), function (item) {
      return item.IDSUBGERENCIA;
  });
  var idController = $.map(table.rows('.selected').data(), function (item) {
      return item.IDCONTROLLER;
  });
  var idAdmin = $.map(table.rows('.selected').data(), function (item) {
      return item.IDADMINCONTRATO;
  });
  var idCliente = $.map(table.rows('.selected').data(), function (item) {
      return item.IDCLIENTE;
  });
  var idEstado = $.map(table.rows('.selected').data(), function (item) {
      return item.IDESTADO;
  });
  var f_ini_contrato = $.map(table.rows('.selected').data(), function (item) {
      return item.FECHA_INICIO_CONTRATO;
  });
  var f_fin_contrato = $.map(table.rows('.selected').data(), function (item) {
      return item.FECHA_FIN_CONTRATO;
  });
  var f_ini_ope = $.map(table.rows('.selected').data(), function (item) {
      return item.FECHA_INICIO_OPERACION;
  });
  var f_fin_ope = $.map(table.rows('.selected').data(), function (item) {
      return item.FECHA_FIN_OPERACION;
  });

  $("#tituloEditarProyecto").html("<br>Identificador de proyecto: " + folio);
  $("#idEditarProyecto").val(folio);

  $("#defProyectoEditarProyecto").val(definicion);
  $("#pepEditarProyecto").val(pep);
  $("#crmEditarProyecto").val(crm);
  $("#proyectoEditarProyecto").val(proyecto);
  $("#denominacionEditarProyecto").val(denominacion);

  await $.ajax({
    url:   'controller/datosSubcontratistasVehiculoInterno.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoSub = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(idSociedad[0] == p2.aaData[i].IDSUBCONTRATO){
              cuerpoSub += '<option selected value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
          }
          else{
              cuerpoSub += '<option value="' + p2.aaData[i].IDSUBCONTRATO + '">' + p2.aaData[i].NOMBRE_SUBCONTRATO + '</option>';
          }
        }
        $("#sociedadEditarProyecto").html(cuerpoSub);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosGerenciaProyecto.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoGer = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(idSubgerencia[0] == p2.aaData[i].IDGERENCIA){
              cuerpoGer += '<option selected value="' + p2.aaData[i].IDGERENCIA + '">' + p2.aaData[i].GERENCIA + ' - ' + p2.aaData[i].SUBGERENCIA +  '</option>';
          }
          else{
              cuerpoGer += '<option value="' + p2.aaData[i].IDGERENCIA + '">' + p2.aaData[i].GERENCIA + ' - ' + p2.aaData[i].SUBGERENCIA +  '</option>';
          }
        }
        $("#gerSubEditarProyecto").html(cuerpoGer);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosPersonalParaAsignar.php',
    type:  'post',
    success: function (response) {
      var p = jQuery.parseJSON(response);
      var cuerpoController = '';
      var cuerpoAdmin = '';
      for(var i = 0; i < p.aaData.length; i++){
        if(idController[0] == p.aaData[i].IDPERSONAL){
            cuerpoController += '<option selected value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        }
        else{
            cuerpoController += '<option value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        }
        if(idAdmin[0] == p.aaData[i].IDPERSONAL){
            cuerpoAdmin += '<option selected value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        }
        else{
            cuerpoAdmin += '<option value="' + p.aaData[i].IDPERSONAL + '">' + p.aaData[i].DNI + ' - ' + p.aaData[i].NOMBRES + ' ' + p.aaData[i].APELLIDOS + ' - ' + p.aaData[i].CARGO + '</option>';
        }
      }
      $("#controllerEditarProyecto").html(cuerpoController);
      $("#adminContratoEditarProyecto").html(cuerpoAdmin);
    }
  });

  await $.ajax({
    url:   'controller/datosClientesProyectos.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoCl = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(idCliente[0] == p2.aaData[i].IDCLIENTE){
              cuerpoCl += '<option selected value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + ' - ' + p2.aaData[i].SUB_CLIENTE +  '</option>';
          }
          else{
              cuerpoCl += '<option value="' + p2.aaData[i].IDCLIENTE + '">' + p2.aaData[i].CLIENTE + ' - ' + p2.aaData[i].SUB_CLIENTE +  '</option>';
          }
        }
        $("#clienteSubEditarProyecto").html(cuerpoCl);
      }
    }
  });

  await $.ajax({
    url:   'controller/datosEstadosProyectos.php',
    type:  'post',
    success: function (response2) {
      var p2 = jQuery.parseJSON(response2);
      if(p2.aaData.length !== 0){
        var cuerpoEst = '';
        for(var i = 0; i < p2.aaData.length; i++){
          if(idEstado[0] == p2.aaData[i].IDESTADO){
              cuerpoEst += '<option selected value="' + p2.aaData[i].IDESTADO + '">' + p2.aaData[i].ESTADO + '</option>';
          }
          else{
              cuerpoEst += '<option value="' + p2.aaData[i].IDESTADO + '">' + p2.aaData[i].ESTADO + '</option>';
          }
        }
        $("#estadoEditarProyecto").html(cuerpoEst);
      }
    }
  });

  $("#fechaIniContratoEditarProyecto").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#fechaFinContratoEditarProyecto").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#fechaIniProyectoEditarProyecto").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#fechaFinProyectoEditarProyecto").datepicker({
    dateFormat: "yy-mm-dd",
    changeMonth: true,
    changeYear: true,
    yearRange: '1920:2040',
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá']
  });

  $("#fechaIniContratoEditarProyecto").val(f_ini_contrato);
  $("#fechaFinContratoEditarProyecto").val(f_fin_contrato);
  $("#fechaIniProyectoEditarProyecto").val(f_ini_ope);
  $("#fechaFinProyectoEditarProyecto").val(f_fin_ope);

  if( !/AppMovil|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    $("#estadoEditarProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#clienteSubEditarProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#sociedadEditarProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#gerSubEditarProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#controllerEditarProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
    $("#adminContratoEditarProyecto").select2({
        theme: 'bootstrap4', width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style', placeholder: $(this).data('placeholder'), allowClear: Boolean($(this).data('allow-clear')), closeOnSelect: !$(this).attr('multiple'), sorter: data => data.sort((a, b) => a.text.localeCompare(b.text))
    });
  }

  setTimeout(function(){
    var h = $(window).height() - 200;
    $("#bodyEditarProyecto").css("height",h);
    $("#modalEditarProyecto").modal("show");
    $('#modalAlertasSplash').modal('hide');
  },500);
});

$("#guardarEditarProyecto").unbind("click").click(function(){
  if($("#defProyectoEditarProyecto").val() === "" || $("#pepEditarProyecto").val() === "" || $("#proyectoEditarProyecto").val() === "" || $("#denominacionEditarProyecto").val() === ""){
    var random = Math.round(Math.random() * (1000000 - 1) + 1);
    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Debe ingresar def. Proyecto, PEP, Proyecto y Denominación");
    $("#defProyectoEditarProyecto").addClass("is-invalid");
    $("#pepEditarProyecto").addClass("is-invalid");
    $("#proyectoEditarProyecto").addClass("is-invalid");
    $("#denominacionEditarProyecto").addClass("is-invalid");
  }
  else{
    $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
    $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
    $('#modalAlertasSplash').modal('show');
    $("#modalEditarProyecto").modal("hide");

    var idProyecto = $("#idEditarProyecto").val();
    var definicion = $("#defProyectoEditarProyecto").val();
    var pep = $("#pepEditarProyecto").val();
    var crm = $("#crmEditarProyecto").val();
    var proyecto = $("#proyectoEditarProyecto").val();
    var denominacion = $("#denominacionEditarProyecto").val();
    var sociedad = $("#sociedadEditarProyecto").val();
    var gerencia = $("#gerSubEditarProyecto").val();
    var controller = $("#controllerEditarProyecto").val();
    var adminContrato = $("#adminContratoEditarProyecto").val();
    var cliente = $("#clienteSubEditarProyecto").val();
    var fechaIniContrato = $("#fechaIniContratoEditarProyecto").val();
    var fechaFinContrato = $("#fechaFinContratoEditarProyecto").val();
    var fechaIniProyecto = $("#fechaIniProyectoEditarProyecto").val();
    var fechaFinProyecto = $("#fechaFinProyectoEditarProyecto").val();
    var estado = $("#estadoEditarProyecto").val();

    var parametros = {
      "idProyecto": idProyecto,
      "definicion": definicion,
      "pep": pep,
      "crm": crm,
      "proyecto": proyecto,
      "denominacion": denominacion,
      "sociedad": sociedad,
      "gerencia": gerencia,
      "controller": controller,
      "adminContrato": adminContrato,
      "cliente": cliente,
      "fechaIniContrato": fechaIniContrato,
      "fechaFinContrato": fechaFinContrato,
      "fechaIniProyecto": fechaIniProyecto,
      "fechaFinProyecto": fechaFinProyecto,
      "estado": estado
    }

    $.ajax({
        url: "controller/editarProyectoControlling.php",
        type: 'POST',
        data: parametros,
        success:  function (response) {
            var p = response.split(",");
            if(response.localeCompare("Sin datos")!= 0 && response != ""){
                if(p[0].localeCompare("Sin datos") != 0 && p[0] != ""){
                    var table = $('#tablaListadoProyecto').DataTable();
                    table.ajax.reload();
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/check.gif' class='splash_load'><br/>Proyecto actualizado correctamente");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
                else{
                    var random = Math.round(Math.random() * (1000000 - 1) + 1);
                    alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar el proyecto");
                    setTimeout(function(){
                      $('#modalAlertasSplash').modal('hide');
                    },500);
                }
            }else{
              var random = Math.round(Math.random() * (1000000 - 1) + 1);
              alertasToast("<img src='view/img/error.gif' class='splash_load'><br/>Error al actualizar el proyecto");
              setTimeout(function(){
                $('#modalAlertasSplash').modal('hide');
              },500);
            }
        }
    });
  }
});

async function generaMapaSucursal(direccion, folio, sucursal){
  $("#modalAlertasSplash").modal({backdrop: 'static', keyboard: false});
  $("#textoModalSplash").html("<img src='view/img/loading.gif' class='splash_charge_logo'><font style='font-size: 12pt;'>Cargando</font>");
  $('#modalAlertasSplash').modal('show');
	u = 'https://maps.googleapis.com/maps/api/geocode/json?';
	datos = {
		address	: direccion,
		key		: 'AIzaSyCb15rFHKSkFxmZbQIo6KVes2-GR3N-LcQ'
	};

  var lat = '';
  var lng = '';
	await $.ajax({
		url: u,
		type: 'get',
		dataType: "json",
		data: datos,
		success: function(data){
      lat = data.results[0].geometry.location.lat;
			lng = data.results[0].geometry.location.lng;
		}
	});
  google.charts.load("current", {
    "packages":["map"],
    // Note: you will need to get a mapsApiKey for your project.
    // See: https://developers.google.com/chart/interactive/docs/basic_load_libs#load-settings
    "mapsApiKey": "AIzaSyCb15rFHKSkFxmZbQIo6KVes2-GR3N-LcQ"
  });

  google.charts.setOnLoadCallback(drawChart);

  function drawChart() {
    var data = google.visualization.arrayToDataTable([
      ['Lat', 'Long', 'Name'],
      [lat, lng, 'Dir: ' + direccion],
    ]);

    var options = {
      zoomLevel: 17,
      showTooltip: true,
      showInfoWindow: true,
      mapType: 'terrain',
      icons: {
        default: {
          normal: 'view/img/icon_map/Map-Marker-Ball-Pink-icon.png',
          selected: 'view/img/icon_map/Map-Marker-Ball-Right-Pink-icon.png'
        }
      }
    };

    setTimeout(function(){
      $("#tituloMapaSucursal").html('<b>Folio</b>: ' + folio + '<br><b>Sucursal</b>: ' + sucursal);
      $('#modalAlertasSplash').modal('hide');
      $("#modalMapaSucursal").modal({backdrop: 'static', keyboard: false});
      $("#modalMapaSucursal").modal('show');

      var instance = OverlayScrollbars(document.getElementById('bodyMapaSucursal'), { });

      //destroy the instance
      instance.destroy();

      setTimeout(function(){
        var h = $(window).height() - 300;
        $("#bodyMapaSucursal").css("height",h);
        $("#mapaMapaSucursal").css("height",h-30);
        var map = new google.visualization.Map(document.getElementById('mapaMapaSucursal'));
        map.draw(data, options);
      },200);
    },1000);
  }
}
